<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FDA Biomarker Enrichment Analysis Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .biomarker-tag {
            @apply inline-block px-2 py-1 text-xs font-semibold rounded-full mr-1 mb-1;
        }
        .precedent-card {
            @apply bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow;
        }
        .tab-active {
            @apply border-b-2 border-blue-500 text-blue-600 font-semibold;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">FDA Biomarker Enrichment Analysis</h1>
                    <p class="text-sm text-gray-600 mt-1">Evidence-based precedents for biomarker-driven trial design</p>
                </div>
                <button onclick="showExportModal()" class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700">
                    Export Data
                </button>
            </div>
        </div>
    </header>

    <!-- Navigation Tabs -->
    <div class="bg-white border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <nav class="flex space-x-8" aria-label="Tabs">
                <button onclick="switchTab('search')" id="tab-search" class="py-4 px-1 border-b-2 border-transparent hover:border-gray-300 tab-active">
                    Comprehensive Search
                </button>
                <button onclick="switchTab('precedents')" id="tab-precedents" class="py-4 px-1 border-b-2 border-transparent hover:border-gray-300">
                    FDA Precedents
                </button>
                <button onclick="switchTab('trials')" id="tab-trials" class="py-4 px-1 border-b-2 border-transparent hover:border-gray-300">
                    Clinical Trials
                </button>
                <button onclick="switchTab('analysis')" id="tab-analysis" class="py-4 px-1 border-b-2 border-transparent hover:border-gray-300">
                    Division Analysis
                </button>
                <button onclick="switchTab('calculator')" id="tab-calculator" class="py-4 px-1 border-b-2 border-transparent hover:border-gray-300">
                    Trial Design Tools
                </button>
            </nav>
        </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Search Tab -->
        <div id="content-search" class="tab-content">
            <!-- Search Form -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-lg font-semibold mb-4">Search Across All Sources</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">General Query</label>
                        <input type="text" id="searchQuery" placeholder="e.g., biomarker enrichment" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Biomarker</label>
                        <input type="text" id="searchBiomarker" placeholder="e.g., HLA-B*5701, CFTR" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Drug</label>
                        <input type="text" id="searchDrug" placeholder="e.g., ivacaftor, maraviroc" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                <button onclick="performComprehensiveSearch()" 
                        class="mt-4 bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700">
                    Search All Databases
                </button>
            </div>

            <!-- Search Summary -->
            <div id="searchSummary" class="hidden mb-6">
                <div class="bg-blue-50 border-l-4 border-blue-400 p-4">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-blue-400" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-sm font-medium text-blue-800">Search Summary</h3>
                            <div class="mt-2 text-sm text-blue-700" id="summaryContent"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Search Results -->
            <div id="searchResults" class="space-y-6"></div>
        </div>

        <!-- Precedents Tab -->
        <div id="content-precedents" class="tab-content hidden">
            <div class="mb-6">
                <h2 class="text-xl font-semibold mb-4">FDA Approval Precedents</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <select id="precedentDivision" onchange="filterPrecedents()" 
                            class="px-3 py-2 border border-gray-300 rounded-md">
                        <option value="">All Divisions</option>
                        <option value="Pulmonary">Pulmonary</option>
                        <option value="Neurology">Neurology</option>
                        <option value="Antiviral">Antiviral</option>
                        <option value="Cardiology">Cardiology</option>
                    </select>
                    <select id="precedentEnrichment" onchange="filterPrecedents()" 
                            class="px-3 py-2 border border-gray-300 rounded-md">
                        <option value="">All Enrichment Levels</option>
                        <option value="complete">Complete (100%)</option>
                        <option value="high">High (â‰¥80%)</option>
                        <option value="moderate">Moderate (50-79%)</option>
                        <option value="exclusion">Exclusion Strategy</option>
                    </select>
                    <select id="precedentBiomarkerType" onchange="filterPrecedents()" 
                            class="px-3 py-2 border border-gray-300 rounded-md">
                        <option value="">All Biomarker Types</option>
                        <option value="genetic">Genetic</option>
                        <option value="protein">Protein</option>
                        <option value="pharmacogenomic">Pharmacogenomic</option>
                        <option value="tropism">Tropism</option>
                    </select>
                </div>
            </div>
            <div id="precedentsList" class="grid grid-cols-1 lg:grid-cols-2 gap-6"></div>
        </div>

        <!-- Clinical Trials Tab -->
        <div id="content-trials" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-lg font-semibold mb-4">Search Clinical Trials</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="text" id="trialsQuery" placeholder="Search terms..." 
                           class="px-3 py-2 border border-gray-300 rounded-md">
                    <input type="text" id="trialsBiomarker" placeholder="Biomarker..." 
                           class="px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <button onclick="searchClinicalTrials()" 
                        class="mt-4 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                    Search ClinicalTrials.gov
                </button>
            </div>
            <div id="trialsResults" class="space-y-4"></div>
        </div>

        <!-- Division Analysis Tab -->
        <div id="content-analysis" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">FDA Division Comparison</h2>
                <canvas id="divisionChart" width="400" height="200"></canvas>
            </div>
            <div id="divisionDetails" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
        </div>

        <!-- Calculator Tab -->
        <div id="content-calculator" class="tab-content hidden">
            <!-- Power Calculator -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-lg font-semibold mb-4">Statistical Power Calculator</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Biomarker Prevalence</label>
                        <input type="number" id="prevalence" value="0.1" step="0.01" min="0" max="1"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Effect Size (Positive)</label>
                        <input type="number" id="effectPositive" value="0.8" step="0.1" min="0" max="2"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Effect Size (Negative)</label>
                        <input type="number" id="effectNegative" value="0.2" step="0.1" min="0" max="2"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Power</label>
                        <input type="number" id="power" value="0.8" step="0.05" min="0.5" max="0.99"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                </div>
                <button onclick="calculatePower()" 
                        class="mt-4 bg-green-600 text-white px-6 py-2 rounded-md hover:bg-green-700">
                    Calculate Sample Size
                </button>
            </div>
            <div id="powerResults" class="hidden"></div>

            <!-- Trial Design Recommendations -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-lg font-semibold mb-4">Trial Design Recommendations</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="text" id="designBiomarker" placeholder="Biomarker (e.g., CFTR mutation)" 
                           class="px-3 py-2 border border-gray-300 rounded-md">
                    <input type="text" id="designIndication" placeholder="Indication (e.g., cystic fibrosis)" 
                           class="px-3 py-2 border border-gray-300 rounded-md">
                    <select id="designPhase" class="px-3 py-2 border border-gray-300 rounded-md">
                        <option value="">Select Phase</option>
                        <option value="Phase 2">Phase 2</option>
                        <option value="Phase 3">Phase 3</option>
                        <option value="Phase 2/3">Phase 2/3</option>
                    </select>
                    <input type="text" id="currentApproach" placeholder="Current approach (optional)" 
                           class="px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <button onclick="getTrialRecommendations()" 
                        class="mt-4 bg-purple-600 text-white px-6 py-2 rounded-md hover:bg-purple-700">
                    Get Recommendations
                </button>
            </div>
            <div id="recommendationsResults" class="hidden mt-6"></div>
        </div>
    </main>

    <!-- Loading Modal -->
    <div id="loadingModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <div class="loading-spinner mx-auto"></div>
                <h3 class="text-lg leading-6 font-medium text-gray-900 mt-4">Loading...</h3>
                <p class="text-sm text-gray-500 mt-2" id="loadingMessage">Please wait while we fetch the data</p>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div id="exportModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Export Data</h3>
                <div class="mt-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Select data to export:</label>
                    <div class="space-y-2">
                        <label class="flex items-center">
                            <input type="checkbox" id="exportPrecedents" checked class="mr-2">
                            <span>FDA Precedents</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="exportAnalysis" checked class="mr-2">
                            <span>Division Analysis</span>
                        </label>
                    </div>
                </div>
                <div class="mt-4 flex justify-end space-x-2">
                    <button onclick="closeExportModal()" 
                            class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">
                        Cancel
                    </button>
                    <button onclick="exportData()" 
                            class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                        Export JSON
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentTab = 'search';
        let precedentsData = [];
        let divisionChart = null;

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadSummaryData();
            loadPrecedents();
        });

        // Tab switching
        function switchTab(tab) {
            // Hide all content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('[id^="tab-"]').forEach(tabEl => {
                tabEl.classList.remove('tab-active');
            });
            
            // Show selected content and mark tab as active
            document.getElementById(`content-${tab}`).classList.remove('hidden');
            document.getElementById(`tab-${tab}`).classList.add('tab-active');
            
            currentTab = tab;
            
            // Load specific data for tab if needed
            if (tab === 'analysis' && !divisionChart) {
                loadDivisionAnalysis();
            }
        }

        // Loading modal functions
        function showLoading(message = 'Please wait while we fetch the data') {
            document.getElementById('loadingMessage').textContent = message;
            document.getElementById('loadingModal').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingModal').classList.add('hidden');
        }

        // Export modal functions
        function showExportModal() {
            document.getElementById('exportModal').classList.remove('hidden');
        }

        function closeExportModal() {
            document.getElementById('exportModal').classList.add('hidden');
        }

        // API calls
        async function apiCall(url, options = {}) {
            try {
                const response = await fetch(url, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('API call failed:', error);
                alert('An error occurred. Please try again.');
                return null;
            }
        }

        // Load summary data
        async function loadSummaryData() {
            const data = await apiCall('/api/summary');
            if (data && data.success) {
                // Update any summary displays
                console.log('Summary data loaded:', data.summary);
            }
        }

        // Load precedents
        async function loadPrecedents() {
            showLoading('Loading FDA precedents...');
            const data = await apiCall('/api/precedents');
            hideLoading();
            
            if (data && data.success) {
                precedentsData = data.precedents;
                displayPrecedents(precedentsData);
            }
        }

        // Filter precedents
        function filterPrecedents() {
            const division = document.getElementById('precedentDivision').value;
            const enrichment = document.getElementById('precedentEnrichment').value;
            const biomarkerType = document.getElementById('precedentBiomarkerType').value;
            
            let filtered = precedentsData;
            
            if (division) {
                filtered = filtered.filter(p => p.division === division);
            }
            
            if (enrichment) {
                filtered = filtered.filter(p => {
                    const percent = p.enrollment?.percentPositive || 0;
                    switch(enrichment) {
                        case 'complete': return percent === 100;
                        case 'high': return percent >= 80;
                        case 'moderate': return percent >= 50 && percent < 80;
                        case 'exclusion': return percent === 0;
                        default: return true;
                    }
                });
            }
            
            if (biomarkerType) {
                // This would need backend support to determine biomarker type
                // For now, simple text matching
                filtered = filtered.filter(p => 
                    p.biomarker.toLowerCase().includes(biomarkerType.toLowerCase())
                );
            }
            
            displayPrecedents(filtered);
        }

        // Display precedents
        function displayPrecedents(precedents) {
            const container = document.getElementById('precedentsList');
            
            if (precedents.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center col-span-2">No precedents match your filters.</p>';
                return;
            }
            
            container.innerHTML = precedents.map(p => `
                <div class="precedent-card">
                    <div class="flex justify-between items-start mb-3">
                        <h3 class="text-lg font-semibold text-gray-900">${p.drug}</h3>
                        <span class="px-2 py-1 text-xs font-medium rounded-full ${
                            p.precedentStrength === 'Maximum' ? 'bg-green-100 text-green-800' :
                            p.precedentStrength === 'High' ? 'bg-blue-100 text-blue-800' :
                            'bg-gray-100 text-gray-800'
                        }">
                            ${p.precedentStrength} Strength
                        </span>
                    </div>
                    
                    <div class="space-y-2 text-sm">
                        <div>
                            <span class="font-medium text-gray-700">Biomarker:</span>
                            <span class="ml-2">${p.biomarker}</span>
                        </div>
                        <div>
                            <span class="font-medium text-gray-700">Division:</span>
                            <span class="ml-2">${p.division}</span>
                        </div>
                        <div>
                            <span class="font-medium text-gray-700">Enrichment:</span>
                            <span class="ml-2">${p.enrollment ? 
                                `${p.enrollment.percentPositive}% positive, ${p.enrollment.percentNegative}% negative` :
                                'Not specified'
                            }</span>
                        </div>
                        <div>
                            <span class="font-medium text-gray-700">Strategy:</span>
                            <span class="ml-2">${p.biomarkerStrategy}</span>
                        </div>
                        ${p.fdaApproval ? `
                        <div>
                            <span class="font-medium text-gray-700">FDA Approval:</span>
                            <span class="ml-2">${p.fdaApproval.date}</span>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div class="mt-4 pt-4 border-t border-gray-200">
                        <p class="text-sm text-gray-600">${p.results?.overallOutcome || 'No outcome data'}</p>
                    </div>
                    
                    <div class="mt-4 flex flex-wrap gap-2">
                        ${p.sources?.clinicalTrials ? 
                            `<a href="${p.sources.clinicalTrials}" target="_blank" 
                                class="text-xs text-blue-600 hover:text-blue-800">
                                ClinicalTrials.gov â†’
                            </a>` : ''
                        }
                        ${p.sources?.pubmed ? 
                            `<a href="https://pubmed.ncbi.nlm.nih.gov/${p.sources.pubmed}/" target="_blank" 
                                class="text-xs text-blue-600 hover:text-blue-800">
                                PubMed â†’
                            </a>` : ''
                        }
                        ${p.sources?.fdaLabel ? 
                            `<a href="${p.sources.fdaLabel}" target="_blank" 
                                class="text-xs text-blue-600 hover:text-blue-800">
                                FDA Label â†’
                            </a>` : ''
                        }
                    </div>
                </div>
            `).join('');
        }

        // Comprehensive search
        async function performComprehensiveSearch() {
            const query = document.getElementById('searchQuery').value;
            const biomarker = document.getElementById('searchBiomarker').value;
            const drug = document.getElementById('searchDrug').value;
            
            if (!query && !biomarker && !drug) {
                alert('Please enter at least one search term');
                return;
            }
            
            showLoading('Searching across all databases...');
            
            const data = await apiCall('/api/search/comprehensive', {
                method: 'POST',
                body: JSON.stringify({ query, biomarker, drug })
            });
            
            hideLoading();
            
            if (data && data.success) {
                displaySearchResults(data);
            }
        }

        // Display search results
        function displaySearchResults(data) {
            // Show summary
            const summaryDiv = document.getElementById('searchSummary');
            const summaryContent = document.getElementById('summaryContent');
            
            summaryDiv.classList.remove('hidden');
            summaryContent.innerHTML = `
                <p><strong>Found:</strong> 
                    ${data.results.precedents.count} FDA precedents, 
                    ${data.results.clinicalTrials.count} clinical trials, 
                    ${data.results.pubmed.count} publications
                </p>
                ${data.insights.recommendations.length > 0 ? 
                    `<p class="mt-2"><strong>Key Recommendation:</strong> ${data.insights.recommendations[0].recommendation}</p>` : 
                    ''
                }
            `;
            
            // Display results
            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = '';
            
            // FDA Precedents section
            if (data.results.precedents.count > 0) {
                resultsDiv.innerHTML += `
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h3 class="text-lg font-semibold mb-4">FDA Precedents (${data.results.precedents.count})</h3>
                        <div class="space-y-4">
                            ${data.results.precedents.data.map(p => `
                                <div class="border-l-4 border-blue-500 pl-4">
                                    <h4 class="font-medium">${p.drug}</h4>
                                    <p class="text-sm text-gray-600">${p.biomarker} - ${p.division}</p>
                                    <p class="text-sm mt-1">${p.biomarkerStrategy}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Clinical Trials section
            if (data.results.clinicalTrials.count > 0) {
                resultsDiv.innerHTML += `
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h3 class="text-lg font-semibold mb-4">Clinical Trials (${data.results.clinicalTrials.count})</h3>
                        <div class="space-y-4">
                            ${data.results.clinicalTrials.data.map(t => `
                                <div class="border-l-4 border-green-500 pl-4">
                                    <h4 class="font-medium">${t.title}</h4>
                                    <p class="text-sm text-gray-600">
                                        ${t.nctId} - ${t.status} - ${t.phase || 'Phase not specified'}
                                    </p>
                                    <p class="text-sm mt-1">
                                        Biomarkers: ${t.biomarkers?.join(', ') || 'Not specified'}
                                    </p>
                                    <a href="${t.url}" target="_blank" class="text-xs text-blue-600 hover:text-blue-800">
                                        View on ClinicalTrials.gov â†’
                                    </a>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // PubMed section
            if (data.results.pubmed.count > 0) {
                resultsDiv.innerHTML += `
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h3 class="text-lg font-semibold mb-4">Publications (${data.results.pubmed.count})</h3>
                        <div class="space-y-4">
                            ${data.results.pubmed.data.map(a => `
                                <div class="border-l-4 border-purple-500 pl-4">
                                    <h4 class="font-medium">${a.title}</h4>
                                    <p class="text-sm text-gray-600">${a.authors} - ${a.journal} (${a.year})</p>
                                    <p class="text-sm mt-1">${a.abstract}</p>
                                    ${a.biomarkers?.length > 0 ? 
                                        `<p class="text-sm mt-1">
                                            <span class="font-medium">Biomarkers:</span> ${a.biomarkers.join(', ')}
                                        </p>` : ''
                                    }
                                    <a href="${a.url}" target="_blank" class="text-xs text-blue-600 hover:text-blue-800">
                                        View on PubMed â†’
                                    </a>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
        }

        // Search clinical trials
        async function searchClinicalTrials() {
            const query = document.getElementById('trialsQuery').value;
            const biomarker = document.getElementById('trialsBiomarker').value;
            
            if (!query && !biomarker) {
                alert('Please enter search terms');
                return;
            }
            
            showLoading('Searching ClinicalTrials.gov...');
            
            const data = await apiCall('/api/search/clinicaltrials', {
                method: 'POST',
                body: JSON.stringify({ query, biomarker })
            });
            
            hideLoading();
            
            if (data && data.success) {
                displayClinicalTrials(data);
            }
        }

        // Display clinical trials
        function displayClinicalTrials(data) {
            const container = document.getElementById('trialsResults');
            
            if (data.studies.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center">No trials found.</p>';
                return;
            }
            
            // Show summary
            container.innerHTML = `
                <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-6">
                    <p class="text-sm">
                        <strong>Found ${data.totalCount} trials</strong><br>
                        ${data.biomarkerSummary.totalWithBiomarkers} trials with biomarkers detected<br>
                        Enrichment strategies: ${Object.entries(data.biomarkerSummary.enrichmentStrategies)
                            .map(([strategy, count]) => `${strategy} (${count})`)
                            .join(', ')}
                    </p>
                </div>
            `;
            
            // Show trials
            container.innerHTML += data.studies.map(trial => `
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="text-lg font-semibold flex-1">${trial.title}</h3>
                        <span class="ml-4 px-2 py-1 text-xs font-medium rounded-full ${
                            trial.status === 'RECRUITING' ? 'bg-green-100 text-green-800' :
                            trial.status === 'COMPLETED' ? 'bg-gray-100 text-gray-800' :
                            'bg-yellow-100 text-yellow-800'
                        }">
                            ${trial.status}
                        </span>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <div>
                            <p><span class="font-medium">NCT ID:</span> ${trial.nctId}</p>
                            <p><span class="font-medium">Phase:</span> ${trial.phase}</p>
                            <p><span class="font-medium">Enrollment:</span> ${trial.enrollment || 'Not specified'}</p>
                        </div>
                        <div>
                            <p><span class="font-medium">Conditions:</span> ${trial.conditions.join(', ')}</p>
                            <p><span class="font-medium">Sponsor:</span> ${trial.sponsors || 'Not specified'}</p>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <p class="text-sm font-medium mb-2">Detected Biomarkers:</p>
                        <div class="flex flex-wrap gap-1">
                            ${trial.biomarkers.map(b => 
                                `<span class="biomarker-tag bg-blue-100 text-blue-800">${b}</span>`
                            ).join('')}
                        </div>
                    </div>
                    
                    <div class="mt-4 flex justify-between items-center">
                        <span class="text-sm text-gray-600">
                            Enrichment Strategy: <strong>${trial.enrichmentStrategy}</strong>
                        </span>
                        <a href="${trial.url}" target="_blank" 
                           class="text-blue-600 hover:text-blue-800 text-sm">
                            View Details â†’
                        </a>
                    </div>
                </div>
            `).join('');
        }

        // Load division analysis
        async function loadDivisionAnalysis() {
            showLoading('Loading division analysis...');
            
            const data = await apiCall('/api/divisions/comparison');
            
            hideLoading();
            
            if (data && data.success) {
                displayDivisionAnalysis(data);
            }
        }

        // Display division analysis
        function displayDivisionAnalysis(data) {
            const divisions = Object.values(data.divisions);
            
            // Create chart
            const ctx = document.getElementById('divisionChart').getContext('2d');
            
            if (divisionChart) {
                divisionChart.destroy();
            }
            
            divisionChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: divisions.map(d => d.name),
                    datasets: [{
                        label: 'Average Biomarker Enrichment %',
                        data: divisions.map(d => d.avgEnrichment),
                        backgroundColor: divisions.map(d => 
                            d.avgEnrichment >= 90 ? 'rgba(34, 197, 94, 0.5)' :
                            d.avgEnrichment >= 70 ? 'rgba(59, 130, 246, 0.5)' :
                            d.avgEnrichment >= 50 ? 'rgba(251, 191, 36, 0.5)' :
                            'rgba(239, 68, 68, 0.5)'
                        ),
                        borderColor: divisions.map(d => 
                            d.avgEnrichment >= 90 ? 'rgb(34, 197, 94)' :
                            d.avgEnrichment >= 70 ? 'rgb(59, 130, 246)' :
                            d.avgEnrichment >= 50 ? 'rgb(251, 191, 36)' :
                            'rgb(239, 68, 68)'
                        ),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.parsed.y.toFixed(1) + '% enrichment';
                                }
                            }
                        }
                    }
                }
            });
            
            // Display division details
            const detailsContainer = document.getElementById('divisionDetails');
            detailsContainer.innerHTML = divisions.map(division => `
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold mb-2">${division.name} Division</h3>
                    <p class="text-sm text-gray-600 mb-4">${division.approachSummary}</p>
                    
                    <div class="space-y-2 text-sm">
                        <p><span class="font-medium">Average Enrichment:</span> ${division.avgEnrichment.toFixed(1)}%</p>
                        <p><span class="font-medium">Total Trials:</span> ${division.trials.length}</p>
                    </div>
                    
                    ${division.keyInsights && division.keyInsights.length > 0 ? `
                        <div class="mt-4">
                            <p class="font-medium text-sm mb-2">Key Insights:</p>
                            <ul class="list-disc list-inside text-sm text-gray-600">
                                ${division.keyInsights.map(insight => 
                                    `<li>${insight}</li>`
                                ).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    
                    <div class="mt-4">
                        <p class="font-medium text-sm mb-2">Enrichment Strategies Used:</p>
                        <div class="flex flex-wrap gap-2">
                            ${Object.entries(division.strategies).map(([strategy, count]) => 
                                `<span class="px-2 py-1 text-xs bg-gray-100 text-gray-700 rounded">
                                    ${strategy} (${count})
                                </span>`
                            ).join('')}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Calculate statistical power
        async function calculatePower() {
            const prevalence = parseFloat(document.getElementById('prevalence').value);
            const effectPositive = parseFloat(document.getElementById('effectPositive').value);
            const effectNegative = parseFloat(document.getElementById('effectNegative').value);
            const power = parseFloat(document.getElementById('power').value);
            
            showLoading('Calculating sample sizes...');
            
            const data = await apiCall('/api/calculate/power', {
                method: 'POST',
                body: JSON.stringify({
                    biomarkerPrevalence: prevalence,
                    effectSizePositive: effectPositive,
                    effectSizeNegative: effectNegative,
                    power: power
                })
            });
            
            hideLoading();
            
            if (data && data.success) {
                displayPowerResults(data);
            }
        }

        // Display power calculation results
        function displayPowerResults(data) {
            const resultsDiv = document.getElementById('powerResults');
            resultsDiv.classList.remove('hidden');
            
            resultsDiv.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-red-50 rounded-lg p-6">
                        <h3 class="text-lg font-semibold text-red-900 mb-4">Traditional Approach</h3>
                        <p class="text-sm text-gray-700 mb-4">Mixed biomarker-positive and negative population</p>
                        <div class="space-y-2">
                            <p><span class="font-medium">Sample Size:</span> ${data.traditional.sampleSize}</p>
                            <p><span class="font-medium">Effect Size:</span> ${data.traditional.effectSize}</p>
                            <p><span class="font-medium">Estimated Cost:</span> ${data.traditional.estimatedCost}</p>
                            <p><span class="font-medium">Timeline:</span> ${data.traditional.estimatedTimeline}</p>
                            <p><span class="font-medium">Success Probability:</span> ${data.traditional.successProbability}</p>
                        </div>
                    </div>
                    
                    <div class="bg-green-50 rounded-lg p-6">
                        <h3 class="text-lg font-semibold text-green-900 mb-4">Enriched Approach</h3>
                        <p class="text-sm text-gray-700 mb-4">Biomarker-positive patients only</p>
                        <div class="space-y-2">
                            <p><span class="font-medium">Sample Size:</span> ${data.enriched.sampleSize}</p>
                            <p><span class="font-medium">Effect Size:</span> ${data.enriched.effectSize}</p>
                            <p><span class="font-medium">Estimated Cost:</span> ${data.enriched.estimatedCost}</p>
                            <p><span class="font-medium">Timeline:</span> ${data.enriched.estimatedTimeline}</p>
                            <p><span class="font-medium">Success Probability:</span> ${data.enriched.successProbability}</p>
                        </div>
                    </div>
                </div>
                
                <div class="mt-6 bg-blue-50 rounded-lg p-6">
                    <h3 class="text-lg font-semibold text-blue-900 mb-4">Savings with Enrichment</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                        <div>
                            <p class="text-2xl font-bold text-blue-600">${data.savings.sampleSizeReduction}</p>
                            <p class="text-sm text-gray-600">Sample Reduction</p>
                        </div>
                        <div>
                            <p class="text-2xl font-bold text-blue-600">${data.savings.costSavings}</p>
                            <p class="text-sm text-gray-600">Cost Savings</p>
                        </div>
                        <div>
                            <p class="text-2xl font-bold text-blue-600">${data.savings.timelineSavings}</p>
                            <p class="text-sm text-gray-600">Time Savings</p>
                        </div>
                        <div>
                            <p class="text-2xl font-bold text-blue-600">â†‘</p>
                            <p class="text-sm text-gray-600">${data.savings.riskReduction}</p>
                        </div>
                    </div>
                    
                    <div class="mt-4 pt-4 border-t border-blue-200">
                        <p class="text-center font-medium ${
                            data.recommendation.includes('Strong') ? 'text-green-700' : 'text-blue-700'
                        }">
                            ${data.recommendation}
                        </p>
                    </div>
                </div>
            `;
        }

        // Get trial design recommendations
        async function getTrialRecommendations() {
            const biomarker = document.getElementById('designBiomarker').value;
            const indication = document.getElementById('designIndication').value;
            const phase = document.getElementById('designPhase').value;
            const currentApproach = document.getElementById('currentApproach').value;
            
            if (!biomarker && !indication) {
                alert('Please enter at least biomarker or indication');
                return;
            }
            
            showLoading('Generating recommendations...');
            
            const data = await apiCall('/api/recommendations/trial-design', {
                method: 'POST',
                body: JSON.stringify({
                    biomarker,
                    indication,
                    phase,
                    currentApproach
                })
            });
            
            hideLoading();
            
            if (data && data.success) {
                displayRecommendations(data);
            }
        }

        // Display trial design recommendations
        function displayRecommendations(data) {
            const resultsDiv = document.getElementById('recommendationsResults');
            resultsDiv.classList.remove('hidden');
            
            const recommendations = data.recommendations;
            
            resultsDiv.innerHTML = `
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-xl font-semibold mb-4">Trial Design Recommendations</h3>
                    
                    <!-- Primary Strategy -->
                    <div class="mb-6">
                        <h4 class="text-lg font-medium text-gray-900 mb-2">Recommended Strategy</h4>
                        <div class="bg-blue-50 border-l-4 border-blue-400 p-4">
                            <p class="text-lg font-semibold text-blue-900">${recommendations.primaryStrategy}</p>
                        </div>
                    </div>
                    
                    <!-- Enrollment Criteria -->
                    <div class="mb-6">
                        <h4 class="text-lg font-medium text-gray-900 mb-2">Enrollment Criteria</h4>
                        <ul class="list-disc list-inside space-y-1">
                            ${recommendations.enrollmentCriteria.map(criteria => 
                                `<li class="text-gray-700">${criteria}</li>`
                            ).join('')}
                        </ul>
                    </div>
                    
                    <!-- Regulatory Considerations -->
                    <div class="mb-6">
                        <h4 class="text-lg font-medium text-gray-900 mb-2">Regulatory Considerations</h4>
                        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4">
                            <ul class="list-disc list-inside space-y-1">
                                ${recommendations.regulatoryConsiderations.map(consideration => 
                                    `<li class="text-gray-700">${consideration}</li>`
                                ).join('')}
                            </ul>
                        </div>
                    </div>
                    
                    <!-- Supporting Precedents -->
                    ${recommendations.precedentSupport.length > 0 ? `
                        <div class="mb-6">
                            <h4 class="text-lg font-medium text-gray-900 mb-2">Supporting FDA Precedents</h4>
                            <div class="space-y-3">
                                ${recommendations.precedentSupport.map(precedent => `
                                    <div class="border-l-4 border-green-400 pl-4">
                                        <p class="font-medium">${precedent.drug}</p>
                                        <p class="text-sm text-gray-600">${precedent.strategy}</p>
                                        <p class="text-sm text-gray-500">${precedent.outcome}</p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Challenges and Mitigations -->
                    ${recommendations.potentialChallenges.length > 0 ? `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h4 class="text-lg font-medium text-gray-900 mb-2">Potential Challenges</h4>
                                <ul class="list-disc list-inside space-y-1">
                                    ${recommendations.potentialChallenges.map(challenge => 
                                        `<li class="text-red-700">${challenge}</li>`
                                    ).join('')}
                                </ul>
                            </div>
                            <div>
                                <h4 class="text-lg font-medium text-gray-900 mb-2">Mitigation Strategies</h4>
                                <ul class="list-disc list-inside space-y-1">
                                    ${recommendations.mitigationStrategies.map(strategy => 
                                        `<li class="text-green-700">${strategy}</li>`
                                    ).join('')}
                                </ul>
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Supporting Evidence Summary -->
                    ${data.supportingEvidence ? `
                        <div class="mt-6 pt-6 border-t border-gray-200">
                            <h4 class="text-lg font-medium text-gray-900 mb-2">Evidence Summary</h4>
                            <div class="grid grid-cols-3 gap-4 text-center">
                                <div>
                                    <p class="text-2xl font-bold text-blue-600">${data.supportingEvidence.precedentCount}</p>
                                    <p class="text-sm text-gray-600">Relevant Precedents</p>
                                </div>
                                <div>
                                    <p class="text-2xl font-bold text-green-600">${data.supportingEvidence.averageEnrichment.toFixed(0)}%</p>
                                    <p class="text-sm text-gray-600">Average Enrichment</p>
                                </div>
                                <div>
                                    <p class="text-2xl font-bold text-purple-600">${(data.supportingEvidence.successRate * 100).toFixed(0)}%</p>
                                    <p class="text-sm text-gray-600">Success Rate</p>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // Export data
        async function exportData() {
            const includePrecedents = document.getElementById('exportPrecedents').checked;
            const includeAnalysis = document.getElementById('exportAnalysis').checked;
            
            const dataTypes = [];
            if (includePrecedents) dataTypes.push('precedents');
            if (includeAnalysis) dataTypes.push('analysis');
            
            if (dataTypes.length === 0) {
                alert('Please select at least one data type to export');
                return;
            }
            
            showLoading('Preparing export...');
            
            const data = await apiCall('/api/export', {
                method: 'POST',
                body: JSON.stringify({ format: 'json', dataTypes })
            });
            
            hideLoading();
            closeExportModal();
            
            if (data && data.success) {
                // Create and download file
                const blob = new Blob([JSON.stringify(data.data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `fda-biomarker-data-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        }

        // Utility function to format percentages
        function formatPercent(value) {
            return value ? `${value}%` : 'N/A';
        }

        // Utility function to get biomarker type color
        function getBiomarkerTypeColor(type) {
            const colors = {
                genetic: 'bg-purple-100 text-purple-800',
                protein: 'bg-pink-100 text-pink-800',
                pharmacogenomic: 'bg-yellow-100 text-yellow-800',
                tropism: 'bg-green-100 text-green-800',
                default: 'bg-gray-100 text-gray-800'
            };
            return colors[type] || colors.default;
        }

        // Utility function to format date
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        }

        // Add keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + K for search focus
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                switchTab('search');
                document.getElementById('searchQuery').focus();
            }
            
            // Escape to close modals
            if (e.key === 'Escape') {
                closeExportModal();
            }
        });

        // Add search on Enter key
        ['searchQuery', 'searchBiomarker', 'searchDrug'].forEach(id => {
            document.getElementById(id).addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    performComprehensiveSearch();
                }
            });
        });

        ['trialsQuery', 'trialsBiomarker'].forEach(id => {
            document.getElementById(id).addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchClinicalTrials();
                }
            });
        });

        // Add auto-complete suggestions for common biomarkers
        const commonBiomarkers = [
            'HLA-B*5701', 'HLA-B*1502', 'CFTR', 'SMN1', 'CCR5', 'CXCR4',
            'CYP2D6', 'CYP2C19', 'CYP2C9', 'TPMT', 'DPYD', 'UGT1A1',
            'EGFR', 'ALK', 'ROS1', 'BRAF', 'KRAS', 'NRAS', 'PIK3CA',
            'HER2', 'PD-L1', 'MSI-H', 'TMB-H', 'NTRK'
        ];

        // Simple autocomplete implementation
        function setupAutocomplete(inputId, suggestions) {
            const input = document.getElementById(inputId);
            let currentFocus;
            
            input.addEventListener('input', function(e) {
                const val = this.value;
                closeAllLists();
                if (!val) return false;
                
                currentFocus = -1;
                const list = document.createElement('div');
                list.setAttribute('id', this.id + '-autocomplete-list');
                list.setAttribute('class', 'autocomplete-items absolute bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-y-auto z-10');
                this.parentNode.appendChild(list);
                
                suggestions.forEach(suggestion => {
                    if (suggestion.toUpperCase().includes(val.toUpperCase())) {
                        const item = document.createElement('div');
                        item.innerHTML = suggestion.replace(new RegExp(val, 'gi'), match => `<strong>${match}</strong>`);
                        item.innerHTML += `<input type='hidden' value='${suggestion}'>`;
                        item.classList.add('p-2', 'cursor-pointer', 'hover:bg-gray-100');
                        item.addEventListener('click', function(e) {
                            input.value = this.getElementsByTagName('input')[0].value;
                            closeAllLists();
                        });
                        list.appendChild(item);
                    }
                });
            });
            
            function closeAllLists(elmnt) {
                const items = document.getElementsByClassName('autocomplete-items');
                for (let i = 0; i < items.length; i++) {
                    if (elmnt != items[i] && elmnt != input) {
                        items[i].parentNode.removeChild(items[i]);
                    }
                }
            }
            
            document.addEventListener('click', function (e) {
                closeAllLists(e.target);
            });
        }

        // Setup autocomplete for biomarker inputs
        setupAutocomplete('searchBiomarker', commonBiomarkers);
        setupAutocomplete('trialsBiomarker', commonBiomarkers);
        setupAutocomplete('designBiomarker', commonBiomarkers);

        // Initialize tooltips
        function initTooltips() {
            const tooltips = document.querySelectorAll('[data-tooltip]');
            tooltips.forEach(element => {
                element.addEventListener('mouseenter', function(e) {
                    const tooltip = document.createElement('div');
                    tooltip.className = 'absolute bg-gray-900 text-white text-xs rounded py-1 px-2 z-50';
                    tooltip.textContent = this.getAttribute('data-tooltip');
                    document.body.appendChild(tooltip);
                    
                    const rect = this.getBoundingClientRect();
                    tooltip.style.top = rect.top - tooltip.offsetHeight - 5 + 'px';
                    tooltip.style.left = rect.left + (rect.width - tooltip.offsetWidth) / 2 + 'px';
                    
                    this.tooltip = tooltip;
                });
                
                element.addEventListener('mouseleave', function(e) {
                    if (this.tooltip) {
                        document.body.removeChild(this.tooltip);
                        this.tooltip = null;
                    }
                });
            });
        }

        // Initialize tooltips on page load
        setTimeout(initTooltips, 100);

        // Print function for reports
        function printReport() {
            window.print();
        }

        // Add print styles
        const printStyles = document.createElement('style');
        printStyles.textContent = `
            @media print {
                header, nav, button, .no-print { display: none !important; }
                .tab-content { display: block !important; }
                .shadow-md { box-shadow: none !important; }
                .bg-gray-50 { background: white !important; }
                a { color: black !important; text-decoration: underline !important; }
            }
        `;
        document.head.appendChild(printStyles);
    </script>
</body>
</html>