<!DOCTYPE html>
<html lang="en">
 <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Research Tool</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Axios for API requests -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Favicon -->
<link rel="icon" type="image/svg+xml" href="favicon.svg">
<!-- Fallback for browsers that don't support SVG favicons -->
<link rel="alternate icon" href="favicon.ico">
<!-- Apple Touch Icon for iOS devices -->
<link rel="apple-touch-icon" href="apple-touch-icon.png">
<!-- Web App Manifest -->
<!-- <link rel="manifest" href="manifest.json"> -->

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#3b82f6',
                        'secondary': '#10b981',
                        'accent': '#8b5cf6',
                        'dark': '#1e293b',
                    }
                }
            }
        }
    </script>
    <style>
      /* Timeline Visualization Styles */
.timeline-chart {
    margin-bottom: 2rem;
    position: relative;
}

.year-markers {
    height: 20px;
    position: relative;
    border-bottom: 1px solid #e5e7eb;
    margin-bottom: 1.5rem;
}

.year-markers div {
    transform: translateX(-50%);
}

.condition-track {
    transition: all 0.2s ease;
}

.condition-track:hover {
    transform: translateX(4px);
}

/* Activity indicators hover effects */
.condition-track .relative div {
    transition: all 0.2s ease;
    z-index: 10;
}

.condition-track:hover .relative div {
    transform: scale(1.5);
}

/* Make the tooltips work with pure CSS */
.condition-track .relative div::after {
    content: attr(title);
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    padding: 0.25rem 0.5rem;
    background-color: rgba(0, 0, 0, 0.8);
    color: white;
    border-radius: 0.25rem;
    font-size: 0.75rem;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s ease;
}

.condition-track .relative div:hover::after {
    opacity: 1;
}

/* Insight cards hover effects */
.insight-card {
    transition: all 0.2s ease;
}

.insight-card:hover {
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    transform: translateY(-2px);
}

/* Evolution patterns section */
.evolution-patterns {
    margin-top: 1rem;
}

/* Make the timeline responsive */
@media (max-width: 768px) {
    .year-markers div {
        font-size: 0.6rem;
    }
    
    .condition-track .absolute {
        transform: scale(0.8);
    }
    
    .condition-track:hover .absolute {
        transform: scale(1.2);
    }
}

/* Add some animation for loading and transitions */
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

#drug-usage-timeline {
    animation: fadeIn 0.5s ease;
}

.condition-track {
    animation: fadeIn 0.3s ease;
    animation-fill-mode: both;
}

/* Stagger the animations for each condition track */
.condition-track:nth-child(1) { animation-delay: 0.1s; }
.condition-track:nth-child(2) { animation-delay: 0.2s; }
.condition-track:nth-child(3) { animation-delay: 0.3s; }
.condition-track:nth-child(4) { animation-delay: 0.4s; }
.condition-track:nth-child(5) { animation-delay: 0.5s; }
.condition-track:nth-child(6) { animation-delay: 0.6s; }
.condition-track:nth-child(7) { animation-delay: 0.7s; }
.condition-track:nth-child(8) { animation-delay: 0.8s; }
.condition-track:nth-child(9) { animation-delay: 0.9s; }
.condition-track:nth-child(10) { animation-delay: 1s; }

/* Enhance the insight cards */
.insight-card {
    border-left: 4px solid #3b82f6;
    background-color: #f9fafb;
}

.insight-card:nth-child(2) {
    border-left-color: #10b981;
}

.insight-card:nth-child(3) {
    border-left-color: #f59e0b;
}

.insight-card:nth-child(4) {
    border-left-color: #ef4444;
}

.insight-card:nth-child(5) {
    border-left-color: #8b5cf6;
}
    </style>
        <style>
           /* Custom font */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Glassmorphism effect */
        .glass {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(6px);
            -webkit-backdrop-filter: blur(6px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        }
        /* Subtle gradient background */
        .gradient-bg {
            background: linear-gradient(135deg, #f7fafc, #e5e7eb);
        }
        /* Notification styling */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
            z-index: 1000;
        }
        .notification.show {
            transform: translateX(0);
        }
        /* Dark theme */
        .dark-theme {
            background: #1f2937 !important;
            color: #f9fafb !important;
        }
        .dark-theme .glass {
            background: rgba(31, 41, 55, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        /* Gradient text for accents */
        .gradient-text {
            background: linear-gradient(to right, #2563eb, #06b6d4);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        /* Fade-in animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.6s ease-out forwards;
        }
        /* Hover glow effect */
        .hover-glow {
            transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
        }
        .hover-glow:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(37, 99, 235, 0.2);
        }
        /* Loading spinner */
        .spinner {
            display: none;
            border: 3px solid #e5e7eb;
            border-top: 3px solid #2563eb;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Custom input focus */
        input:focus {
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
        }
        /* Backdrop for overlays */
        .backdrop {
            background: rgba(17, 24, 39, 0.5);
            backdrop-filter: blur(2px);
            -webkit-backdrop-filter: blur(2px);
        }
        </style>
</head>
<body class="bg-gray-50 font-sans text-gray-800" >

  <!-- <header class="bg-dark text-white shadow-md">
      <div class="container mx-auto p-4">
          <nav class="flex justify-between items-center">
              <div class="text-2xl font-bold">
                  <a href="#" class="hover:text-gray-300 transition-colors">Research Tool</a>
              </div>
              <ul class="flex space-x-6">
                  <li>
                      <a href="#" class="text-gray-300 hover:text-white transition-colors duration-200">Home</a>
                  </li>
                  <li>
                      <a href="./wl.html" class="text-gray-300 hover:text-white transition-colors duration-200">Warning Letters</a>
                  </li>
                  <li>
                      <a href="./post483.html" class="text-gray-300 hover:text-white transition-colors duration-200">483s</a>
                  </li>
              </ul>
          </nav>
         
      </div>
  </header> -->
  
  <header class="bg-gradient-to-r from-white to-gray-100 shadow-md relative dark:from-gray-900 dark:to-gray-800">
    <!-- Glassmorphism effect overlay -->
    <div class="absolute inset-0 bg-black/5 backdrop-blur-sm dark:bg-white/5"></div>
    
    <div class="container mx-auto relative z-10">
        <nav class="flex flex-wrap justify-between items-center p-4">
            <!-- Logo/Brand section - More modern and sleek -->
            <div class="flex items-center space-x-3">
                <div class="text-xl md:text-2xl font-bold bg-gradient-to-r from-blue-500 to-indigo-600 bg-clip-text text-transparent">
                    <a href="#" class="hover:opacity-80 transition-opacity flex items-center">
                        <!-- Modern and sleek logo -->
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-2" viewBox="0 0 24 24" fill="none" stroke="url(#logo-gradient)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <defs>
                                <linearGradient id="logo-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" stop-color="#3B82F6" /> <!-- blue-500 -->
                                    <stop offset="100%" stop-color="#4F46E5" /> <!-- indigo-600 -->
                                </linearGradient>
                            </defs>
                            <!-- Modern DNA/Research icon -->
                            <path d="M12 2v20M4 4c1.5 1.5 5 3 8 3s6.5-1.5 8-3M4 20c1.5-1.5 5-3 8-3s6.5 1.5 8 3M4 12c1.5-1.5 5-3 8-3s6.5 1.5 8 3M4 12c1.5 1.5 5 3 8 3s6.5-1.5 8-3" />
                        </svg>
                        Research Tool
                    </a>
                </div>
                <!-- <p class="hidden md:block text-sm text-gray-600 dark:text-gray-400">AI-powered drug and condition research</p> -->
            </div>
            
            <!-- Navigation links - center -->
            <ul class="flex justify-center items-center space-x-6 my-3 md:my-0">
                <li>
                    <a href="./wl.html" target="_blank" class="text-gray-700 hover:text-blue-600 dark:text-gray-300 dark:hover:text-white transition-colors duration-200 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                        Warning Letters
                    </a>
                </li>
                <li>
                    <a href="./post483.html"  target="_blank" class="text-gray-700 hover:text-blue-600 dark:text-gray-300 dark:hover:text-white transition-colors duration-200 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M5 4a3 3 0 00-3 3v6a3 3 0 003 3h10a3 3 0 003-3V7a3 3 0 00-3-3H5zm-1 9v-1h5v2H5a1 1 0 01-1-1zm7 1h4a1 1 0 001-1v-1h-5v2zm0-4h5V8h-5v2zM9 8H4v2h5V8z" clip-rule="evenodd" />
                        </svg>
                        483s
                    </a>
                </li>
            </ul>
            
            <!-- User section - right -->
            <div class="flex items-center space-x-4">
                <!-- Theme Toggle -->
                <button style="display: none;" id="themeToggle" class="p-1.5 rounded-full bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 transition-colors duration-200">
                    <!-- Sun icon (shows in dark mode) -->
                    <svg id="sunIcon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-yellow-500 hidden dark:block" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                    </svg>
                    <!-- Moon icon (shows in light mode) -->
                    <svg id="moonIcon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-700 block dark:hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                    </svg>
                </button>
                
                <!-- User info - Logged out state (default) -->
                <button id="loginBtn" class="hidden bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition duration-200 flex items-center text-sm font-medium">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1" />
                    </svg>
                    Login
                </button>
                
                <!-- User info - Logged in state -->
                <div id="userInfo" class="hidden">
                    <div class="flex items-center">
                        <div class="relative group">
                            <button class="flex items-center space-x-2 p-2 rounded-lg hover:bg-gradient-to-r hover:from-blue-500/10 hover:to-indigo-500/10 transition-colors duration-200">
                                <div class="flex items-center justify-center h-8 w-8 rounded-full bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-medium uppercase">
                                    <span id="userInitial">U</span>
                                </div>
                                <div class="hidden md:block">
                                    <div class="text-sm font-medium text-gray-700 dark:text-gray-200">
                                        <span id="username">Username</span>
                                    </div>
                                </div>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </nav>
    </div>
</header>

<div id="loginOverlay" class="fixed inset-0 flex items-center justify-center z-50 hidden backdrop">
    <div class="w-full max-w-5xl flex rounded-xl overflow-hidden">
        <!-- Left: Welcome message -->
        <div class="hidden lg:block w-1/2 p-12 bg-white relative">
            <h2 class="text-3xl font-bold mb-4 gradient-text animate-fade-in">Welcome to Your Regulatory AI Dashboard</h2>
            <p class="text-gray-600 mb-6 animate-fade-in" style="animation-delay: 0.2s;">
                Log in to access advanced tools for FDA compliance, clinical trial analysis, and product approval tracking.
            </p>
            <div class="flex items-center space-x-3 animate-fade-in" style="animation-delay: 0.4s;">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.5 3.5 0 005.33 0l8.135 8.136a3.5 3.5 0 010 4.95l-4.95 4.95a3.5 3.5 0 01-4.95 0l-8.135-8.136a3.5 3.5 0 010-4.95l4.95-4.95z" />
                </svg>
                <span class="text-gray-700">Trusted by clinicians and regulators</span>
            </div>
            <!-- SyneticX Logo -->
            <div class="absolute bottom-6 left-6 flex items-center space-x-2 animate-fade-in" style="animation-delay: 0.8s;">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
                <span class="text-sm font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">Powered by SyneticX</span>
            </div>
        </div>
        <!-- Right: Login form -->
        <div class="w-full lg:w-1/2 p-12 bg-white glass relative">
            <button id="switchToSignup" class="absolute top-4 right-4 text-sm font-medium text-white bg-gradient-to-r from-blue-500 to-purple-500 py-2 px-4 rounded-lg shadow-md hover:shadow-lg transition-all duration-300 hover:translate-y-px flex items-center space-x-1">
                <span>Create Account</span>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
                </svg>
            </button>
            <h2 class="text-2xl font-semibold mb-8 text-gray-800 animate-fade-in">Login</h2>
            <form id="loginForm" class="space-y-6">
                <div class="relative animate-fade-in" style="animation-delay: 0.2s;">
                    <label for="loginUsername" class="block text-sm font-medium text-gray-700">Username</label>
                    <div class="mt-1 flex items-center border border-gray-200 rounded-lg shadow-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 ml-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                        </svg>
                        <input type="text" id="loginUsername" name="username" required 
                            class="flex-1 block w-full px-3 py-2.5 bg-transparent focus:outline-none focus:ring-0 rounded-lg">
                    </div>
                </div>
                <div class="relative animate-fade-in" style="animation-delay: 0.4s;">
                    <label for="loginPassword" class="block text-sm font-medium text-gray-700">Password</label>
                    <div class="mt-1 flex items-center border border-gray-200 rounded-lg shadow-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 ml-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11c0-1.104-.896-2-2-2s-2 .896-2 2c0 .738.404 1.376 1 1.723V15h2v-2.277c.596-.347 1-.985 1-1.723zm9-6v14c0 1.104-.896 2-2 2H5c-1.104 0-2-.896-2-2V5c0-1.104.896-2 2-2h1V2h2v1h8V2h2v1h1c1.104 0 2 .896 2 2z" />
                        </svg>
                        <input type="password" id="loginPassword" name="password" required 
                            class="flex-1 block w-full px-3 py-2.5 bg-transparent focus:outline-none focus:ring-0 rounded-lg">
                    </div>
                </div>
                <div class="animate-fade-in" style="animation-delay: 0.6s;">
                    <button type="submit" 
                        class="w-full flex justify-center items-center py-3 px-4 border border-transparent rounded-lg text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 hover-glow">
                        <span id="loginButtonText">Sign In</span>
                        <div id="loginSpinner" class="spinner ml-2"></div>
                    </button>
                </div>
                <div id="loginError" class="text-red-600 text-center text-sm hidden animate-fade-in"></div>
            </form>
            
        </div>
    </div>
</div>

<!-- Signup overlay -->
<div id="signupOverlay" class="fixed inset-0 flex items-center justify-center z-50 hidden backdrop">
    <div class="w-full max-w-6xl flex rounded-xl overflow-hidden">
        <!-- Left: Promotional section with metric cards -->
        <div class="hidden lg:block w-1/2 p-12 bg-white relative">
            <h2 class="text-3xl font-bold mb-4 gradient-text animate-fade-in">Streamline FDA Approvals</h2>
            <p class="text-gray-600 mb-8 animate-fade-in" style="animation-delay: 0.2s;">
                Start your 30-day trial to access AI-powered tools for regulatory compliance and clinical trial management.
            </p>
            <!-- Metric cards -->
            <div class="grid gap-6">
                <div class="glass p-6 rounded-lg hover-glow animate-fade-in" style="animation-delay: 0.4s;">
                    <div class="flex items-start space-x-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800">Regulatory Compliance</h3>
                            <p class="text-sm text-gray-600">Track FDA submissions with AI-driven insights.</p>
                        </div>
                    </div>
                </div>
                <div class="glass p-6 rounded-lg hover-glow animate-fade-in" style="animation-delay: 0.6s;">
                    <div class="flex items-start space-x-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-teal-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8v8m-4-5v5m-4-2v2m-2 4h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800">Trial Analytics</h3>
                            <p class="text-sm text-gray-600">Real-time analysis of clinical trial data.</p>
                        </div>
                    </div>
                </div>
                <div class="glass p-6 rounded-lg hover-glow animate-fade-in" style="animation-delay: 0.8s;">
                    <div class="flex items-start space-x-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800">Secure Data</h3>
                            <p class="text-sm text-gray-600">HIPAA-compliant data storage and processing.</p>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
        <!-- Right: Signup form -->
        <div class="w-full lg:w-1/2 p-12 bg-white glass relative">
            <button id="switchToLogin" class="absolute top-4 right-4 text-sm font-medium text-white bg-gradient-to-r from-blue-500 to-purple-500 py-2 px-4 rounded-lg shadow-md hover:shadow-lg transition-all duration-300 hover:translate-y-px flex items-center space-x-1">
                <span>Sign In</span>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14" />
                </svg>
            </button>
            <h2 class="text-2xl font-semibold mb-8 text-gray-800 animate-fade-in">Create Account</h2>
            <form id="signupForm" class="space-y-6">
                <div class="relative animate-fade-in" style="animation-delay: 0.2s;">
                    <label for="signupUsername" class="block text-sm font-medium text-gray-700">Username</label>
                    <div class="mt-1 flex items-center border border-gray-200 rounded-lg shadow-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 ml-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                        </svg>
                        <input type="text" id="signupUsername" name="username" required 
                            class="flex-1 block w-full px-3 py-2.5 bg-transparent focus:outline-none focus:ring-0 rounded-lg">
                    </div>
                </div>
                <div class="relative animate-fade-in" style="animation-delay: 0.4s;">
                    <label for="signupEmail" class="block text-sm font-medium text-gray-700">Email</label>
                    <div class="mt-1 flex items-center border border-gray-200 rounded-lg shadow-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 ml-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                        </svg>
                        <input type="email" id="signupEmail" name="email" required 
                            class="flex-1 block w-full px-3 py-2.5 bg-transparent focus:outline-none focus:ring-0 rounded-lg">
                    </div>
                </div>
                <div class="relative animate-fade-in" style="animation-delay: 0.6s;">
                    <label for="signupPassword" class="block text-sm font-medium text-gray-700">Password</label>
                    <div class="mt-1 flex items-center border border-gray-200 rounded-lg shadow-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 ml-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11c0-1.104-.896-2-2-2s-2 .896-2 2c0 .738.404 1.376 1 1.723V15h2v-2.277c.596-.347 1-.985 1-1.723zm9-6v14c0 1.104-.896 2-2 2H5c-1.104 0-2-.896-2-2V5c0-1.104.896-2 2-2h1V2h2v1h8V2h2v1h1c1.104 0 2 .896 2 2z" />
                        </svg>
                        <input type="password" id="signupPassword" name="password" required 
                            class="flex-1 block w-full px-3 py-2.5 bg-transparent focus:outline-none focus:ring-0 rounded-lg">
                    </div>
                </div>
                <div class="animate-fade-in" style="animation-delay: 0.8s;">
                    <button type="submit" 
                        class="w-full flex justify-center items-center py-3 px-4 border border-transparent rounded-lg text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 hover-glow">
                        <span id="signupButtonText">Start 30-Day Trial</span>
                        <div id="signupSpinner" class="spinner ml-2"></div>
                    </button>
                </div>
                <div id="signupError" class="text-red-600 text-center text-sm hidden animate-fade-in"></div>
            </form>
            <!-- SyneticX Logo for all views -->
            <div class="absolute bottom-6 left-6 flex items-center space-x-2 animate-fade-in" style="animation-delay: 1s;">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
                <span class="text-sm font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">Powered by SyneticX</span>
            </div>
        </div>
    </div>
</div>

    <!-- Notification element -->
    <div id="notification" class="notification">
        Welcome, <span id="notificationUsername"></span>!
    </div>

    <!-- Floating user icon -->
    <div id="userProfileButton" class="hidden fixed bottom-6 right-6 flex items-center cursor-pointer bg-white rounded-full shadow-lg pl-3 pr-4 py-2 z-50 transition-all duration-300 hover-glow">
        <div class="flex items-center justify-center w-10 h-10 bg-blue-600 rounded-full text-white mr-2">
            <span id="userInitials" class="text-lg font-bold"></span>
        </div>
        <span id="welcomeText" class="font-medium text-gray-800">Welcome</span>
    </div>

    <!-- Profile popup -->
    <div id="profilePopup" class="hidden fixed bottom-20 right-6 bg-white rounded-lg shadow-xl overflow-hidden w-80 z-50 transition-transform duration-300 origin-bottom-right scale-0 glass">
        <div class="relative">
            <button id="closePopup" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <div class="bg-gradient-to-r from-blue-600 to-teal-500 p-6 text-white">
                <div class="flex items-center">
                    <div class="flex items-center justify-center w-14 h-14 bg-white rounded-full text-blue-600 mr-4">
                        <span id="popupUserInitials" class="text-xl font-bold"></span>
                    </div>
                    <div>
                        <h3 id="popupUsername" class="text-lg font-semibold"></h3>
                        <p id="popupEmail" class="text-xs opacity-90"></p>
                    </div>
                </div>
            </div>
            <div class="p-5">
                <div class="mb-3 pb-3 border-b border-gray-100">
                    <p class="text-xs text-gray-500 mb-1">Access Level</p>
                    <p id="popupRole" class="font-medium text-gray-800"></p>
                </div>
                <div class="mb-3 pb-3 border-b border-gray-100">
                    <p class="text-xs text-gray-500 mb-1">Usage</p>
                    <div class="w-full bg-gray-100 rounded-full h-2">
                        <div id="usageBar" class="bg-blue-600 h-2 rounded-full" style="width: 45%"></div>
                    </div>
                    <p class="text-xs mt-1"><span id="usagePercent">45</span>% of your quota used</p>
                </div>
                <div class="mb-3 pb-3 border-b border-gray-100">
                    <p class="text-xs text-gray-500 mb-1">Billing Period</p>
                    <p id="billingPeriod" class="font-medium text-gray-800"></p>
                </div>
                <div class="mb-3 pb-3 border-b border-gray-100">
                    <p class="text-xs text-gray-500 mb-1">Subscription Status</p>
                    <div id="subscriptionStatus" class="inline-block px-2 py-0.5 rounded text-xs font-medium"></div>
                </div>
                <div class="flex items-center justify-between mb-4">
                    <span class="text-xs font-medium text-gray-700">Dark Mode</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="darkModeToggle" class="sr-only peer">
                        <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                </div>
                <button id="popupLogoutBtn" class="w-full bg-red-600 hover:bg-red-700 text-white py-2 rounded text-sm transition-colors hover-glow">
                    Logout
                </button>
            </div>
        </div>
    </div>

    <main class="container mx-auto p-4">

                    <!-- User info area (shows after login) -->
                    <div id="userInfo" class="hidden bg-green-50 border border-green-200 p-4 rounded mb-6">
                        <div class="flex justify-between items-center">
                            <p>Logged in as: <span id="username" class="font-semibold"></span></p>
                            <button id="logoutBtn" class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600">
                                Logout
                            </button>
                        </div>
                    </div>

        <!-- Search Section -->
        <!-- <section class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Search for Clinical Trials</h2>
            <div class="flex flex-col md:flex-row gap-4">
                <div class="flex-grow">
                    <label for="drugSearch" class="block text-sm font-medium mb-1">Drug Name:</label>
                    <input type="text" id="drugSearch" placeholder="e.g., PCN-101, Ketamine, COMP360" 
                           class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                </div>
                <div class="flex-grow">
                    <label for="conditionSearch" class="block text-sm font-medium mb-1">Condition (Optional):</label>
                    <input type="text" id="conditionSearch"  placeholder="e.g Treatment Resistant Depression"
                           class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                </div>
                <div class="flex items-end">
                    <button id="searchButton" class="bg-primary hover:bg-blue-600 text-white py-2 px-6 rounded-lg transition duration-200 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                        Search
                    </button>
                </div>
            </div>
            <div class="mt-4 flex items-center gap-4" style="display: none;">
                <div>
                    <input type="checkbox" id="hasResultsOnly" class="mr-2" >
                    <label for="hasResultsOnly" class="text-sm">Show only studies with results</label>
                </div>
                <div >
                    <input type="checkbox" id="trdFocusOnly" class="mr-2" >
                    <label for="trdFocusOnly" class="text-sm">Focus on TRD-specific trials only</label>
                </div>
            </div>
        </section> -->

<!-- Search Section -->
<!-- <section class="bg-white rounded-lg shadow-md p-6 mb-6">
    <h2 class="text-xl font-semibold mb-4">Search for Clinical Trials</h2>
    <div class="flex flex-col md:flex-row gap-4">
        <div class="flex-grow">
            <label for="drugSearch" class="block text-sm font-medium mb-1">Drug Name:</label>
            <input type="text" id="drugSearch" placeholder="e.g., PCN-101, Ketamine, COMP360"
                    class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
        </div>
        <div class="flex-grow">
            <label for="conditionSearch" class="block text-sm font-medium mb-1">Condition (Optional):</label>
            <input type="text" id="conditionSearch" placeholder="e.g Treatment Resistant Depression"
                   class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
        </div>
        <div class="flex items-end">
            <button id="searchButton" class="bg-primary hover:bg-blue-600 text-white py-2 px-6 rounded-lg transition duration-200 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
                Search
            </button>
        </div>
    </div>
    
    
    <div class="mt-6">
        <div class="flex justify-between items-center mb-2">
            <label for="timelineSlider" class="text-sm font-medium">Timeline: <span id="yearValue" class="text-primary font-bold text-lg transition-all duration-300">7</span> years back</label>
            <div class="text-xs bg-gray-100 px-3 py-1 rounded-full shadow-sm">
                From <span id="startYear" class="font-medium"></span> to <span id="currentYear" class="font-medium"></span>
            </div>
        </div>
        
        <div class="relative mb-6">
            
            <div class="w-full h-4 bg-gray-200 rounded-full shadow-inner overflow-hidden">
                
                <div id="filledTrack" class="h-full bg-gradient-to-r from-blue-400 to-primary transition-all duration-300" style="width: 46.6%;"></div>
            </div>
            
            
            <div class="relative w-full h-8 mt-1">
                <div class="absolute top-0 left-0 text-xs text-gray-500">1 year</div>
                <div class="absolute top-0 left-1/4 transform -translate-x-1/2 text-xs text-gray-500">5 years</div>
                <div class="absolute top-0 left-2/4 transform -translate-x-1/2 text-xs text-gray-500">8 years</div>
                <div class="absolute top-0 left-3/4 transform -translate-x-1/2 text-xs text-gray-500">12 years</div>
                <div class="absolute top-0 right-0 transform translate-x-0 text-xs text-gray-500">15 years</div>
            </div>
            
            
            <input type="range" id="timelineSlider" min="1" max="15" value="7" 
                   class="absolute top-0 w-full h-4 opacity-0 cursor-pointer z-10">
                   
       
            <div id="sliderThumb" class="absolute top-0 h-10 w-10 bg-white rounded-full shadow-lg border-2 border-primary flex items-center justify-center transform -translate-y-3 -translate-x-1/2 transition-transform duration-200" style="left: 46.6%;">
                <span id="thumbValue" class="text-sm font-bold text-primary">7</span>
            </div>
        </div>
        
      
        <div id="yearMarkers" class="flex justify-between mb-6 px-1">
           
        </div>
    </div>
    
    <div class="mt-4 flex items-center gap-4" style="display: none;">
        <div>
            <input type="checkbox" id="hasResultsOnly" class="mr-2">
            <label for="hasResultsOnly" class="text-sm">Show only studies with results</label>
        </div>
        <div>
            <input type="checkbox" id="trdFocusOnly" class="mr-2">
            <label for="trdFocusOnly" class="text-sm">Focus on TRD-specific trials only</label>
        </div>
    </div>
</section> -->


<section class="bg-white rounded-xl shadow-lg p-6 mb-6">
    <h2 class="text-xl font-semibold mb-6 text-gray-800">Search for Clinical Trials</h2>
    
    <!-- Main Search Row -->
    <div class="flex flex-col md:flex-row gap-3">
        <div class="flex-grow">
            <div class="relative">
                <input type="text" id="drugSearch" placeholder="Drug Name" 
                       class="w-full p-3 pl-10 bg-gray-50 border-0 rounded-lg focus:ring-2 focus:ring-blue-500 shadow-sm transition-all duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 absolute left-3 top-3.5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1.323l3.954 1.582 1.599-.8a1 1 0 01.894 1.79l-1.233.616 1.738 5.42a1 1 0 01-.285 1.05A3.989 3.989 0 0115 15a3.989 3.989 0 01-2.667-1.019 1 1 0 01-.285-1.05l1.715-5.349L11 6.477V16a1 1 0 11-2 0V6.477L6.237 7.582l1.715 5.349a1 1 0 01-.285 1.05A3.989 3.989 0 013 15a3.989 3.989 0 01-2.667-1.019 1 1 0 01-.285-1.05l1.738-5.42-1.233-.617a1 1 0 01.894-1.788l1.599.799L7 4.323V3a1 1 0 011-1z" clip-rule="evenodd" />
                </svg>
            </div>
        </div>
        <div class="flex-grow">
            <div class="relative">
                <input type="text" id="conditionSearch" placeholder="Condition (Optional)" 
                       class="w-full p-3 pl-10 bg-gray-50 border-0 rounded-lg focus:ring-2 focus:ring-blue-500 shadow-sm transition-all duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 absolute left-3 top-3.5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                </svg>
            </div>
        </div>
        <div>
            <button id="searchButton" class="bg-blue-600 hover:bg-blue-700 text-white py-3 px-8 rounded-lg transition duration-200 flex items-center shadow-md">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
                Search
            </button>
        </div>
    </div>
    
    <!-- AI Search Box -->
    <!-- <div class="mt-5 relative">
        <div class="absolute left-3 top-3.5">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-indigo-500" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M13.5 3.25a.75.75 0 00-1.5 0V4h-1.5a.75.75 0 000 1.5H12v1.5a.75.75 0 001.5 0V5.5h1.5a.75.75 0 000-1.5H13.5v-1.25zm-8.25 4a.75.75 0 00-.75.75v6.5c0 .414.336.75.75.75h6.5a.75.75 0 00.75-.75v-6.5a.75.75 0 00-.75-.75h-6.5zm8.25-1.5a.75.75 0 00-.75.75v8a.75.75 0 01-.75.75h-8a.75.75 0 00-.75.75v.25c0 .414.336.75.75.75h8.75a1.5 1.5 0 001.5-1.5v-9a.75.75 0 00-.75-.75z" clip-rule="evenodd" />
            </svg>
        </div>
        <input type="text" id="aiSearch" placeholder="Describe what you're looking for in natural language..." 
               class="w-full p-3 pl-10 pr-36 bg-gradient-to-r from-indigo-50 to-purple-50 border-0 rounded-lg focus:ring-2 focus:ring-indigo-400 shadow-sm transition-all duration-200">
        <button id="aiSearchButton" class="absolute right-2 top-2 bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 text-white py-1.5 px-4 rounded-lg transition duration-200 flex items-center shadow-sm">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
            </svg>
            AI Search
        </button>
        <p class="text-xs text-gray-500 mt-1.5 ml-2">Example: "Trials for ketamine targeting TRD in adults from the last 3 years"</p>
    </div> -->
    
    <!-- Timeline Slider -->
    <div class="mt-7">
        <div class="flex justify-between items-center mb-3">
            <div class="flex items-center">
                <label for="timelineSlider" class="text-sm font-medium text-gray-700">Timeline:</label>
                <span id="yearValue" class="ml-2 text-blue-600 font-bold text-lg transition-all duration-300">7</span>
                <span class="ml-1 text-sm text-gray-700">years back</span>
            </div>
            <div class="text-xs bg-blue-50 px-3 py-1.5 rounded-full shadow-sm text-blue-700">
                From <span id="startYear" class="font-medium"></span> to <span id="currentYear" class="font-medium"></span>
            </div>
        </div>
        
        <div class="relative mb-5">
            <!-- Timeline Track -->
            <div class="w-full h-2 bg-gray-200 rounded-full shadow-inner overflow-hidden">
                <!-- Filled Track -->
                <div id="filledTrack" class="h-full bg-gradient-to-r from-blue-400 to-blue-600 transition-all duration-300" style="width: 46.6%;"></div>
            </div>
            
            <!-- Ticks and Labels -->
            <div class="relative w-full h-8 mt-1">
                <div class="absolute top-0 left-0 text-xs text-gray-500">1 year</div>
                <div class="absolute top-0 left-1/4 transform -translate-x-1/2 text-xs text-gray-500">5 years</div>
                <div class="absolute top-0 left-2/4 transform -translate-x-1/2 text-xs text-gray-500">8 years</div>
                <div class="absolute top-0 left-3/4 transform -translate-x-1/2 text-xs text-gray-500">12 years</div>
                <div class="absolute top-0 right-0 transform translate-x-0 text-xs text-gray-500">15 years</div>
            </div>
            
            <!-- Custom Slider Thumb -->
            <input type="range" id="timelineSlider" min="1" max="15" value="7" 
                   class="absolute top-0 w-full h-2 opacity-0 cursor-pointer z-10">
                   
            <!-- Visual Thumb (shows on top of track) -->
            <div id="sliderThumb" class="absolute top-0 h-6 w-6 bg-white rounded-full shadow-md border-2 border-blue-500 flex items-center justify-center transform -translate-y-2 -translate-x-1/2 transition-all duration-200" style="left: 46.6%;">
                <span id="thumbValue" class="text-xs font-bold text-blue-600">7</span>
            </div>
        </div>
        
        <!-- Year Markers -->
        <div id="yearMarkers" class="flex justify-between mb-6 px-1">
            <!-- Year markers will be inserted by JavaScript -->
        </div>
    </div>
    
    <!-- Bottom Controls -->
    <div class="flex flex-wrap items-center justify-between gap-y-3">
        <!-- Checkboxes -->
        <div class="flex flex-wrap items-center gap-x-6 gap-y-2" style="display: none;">
            <label class="inline-flex items-center cursor-pointer">
                <input type="checkbox" id="hasResultsOnly" class="form-checkbox h-4 w-4 text-blue-600 transition duration-150 ease-in-out">
                <span class="ml-2 text-sm text-gray-700">Studies with results only</span>
            </label>
            <label class="inline-flex items-center cursor-pointer">
                <input type="checkbox" id="trdFocusOnly" class="form-checkbox h-4 w-4 text-blue-600 transition duration-150 ease-in-out">
                <span class="ml-2 text-sm text-gray-700">TRD-specific trials only</span>
            </label>
        </div>
        
        <!-- Action Buttons -->
        <div class="flex items-center gap-2">
            <!-- Email Summary Button (initially hidden) -->
            <button id="emailSummaryBtn" class="bg-gray-100 hover:bg-gray-200 text-gray-700 p-2 rounded-lg transition duration-200 flex items-center hidden">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" />
                    <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" />
                </svg>
            </button>
            
            <!-- Save Search Button -->
            <button id="saveSearchBtn" class="bg-gray-100 hover:bg-gray-200 text-gray-700 p-2 rounded-lg transition duration-200">
                <svg id="starOutline" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
                </svg>
                <svg id="starFilled" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-yellow-400 hidden" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                </svg>
            </button>
            
            <!-- Saved Searches Button with Dropdown -->
            <div class="relative">
                <button id="savedSearchesBtn" class="bg-gray-100 hover:bg-gray-200 text-gray-700 p-2 rounded-lg transition duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </button>
                
                <!-- Saved Searches Dropdown -->
                <div id="savedSearchesDropdown" class="absolute right-0 mt-2 w-72 bg-white rounded-lg shadow-xl z-20 hidden overflow-hidden border border-gray-100">
                    <div class="py-2 px-4 bg-gray-50 border-b border-gray-100">
                        <h3 class="text-sm font-medium text-gray-700">Saved Searches</h3>
                    </div>
                    <div id="savedSearchesList" class="max-h-72 overflow-y-auto">
                        <div class="p-4 text-sm text-gray-500 text-center">No saved searches yet</div>
                        <!-- Saved searches will be populated here by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script>

    
    saveSearchBtn.addEventListener('click', function() {
        const drugName = document.getElementById('drugSearch').value.trim();
        const condition = document.getElementById('conditionSearch').value.trim();
        const years = timelineSlider.value;
        const hasResultsOnly = document.getElementById('hasResultsOnly').checked;
        const trdFocusOnly = document.getElementById('trdFocusOnly').checked;
        
        if (!drugName && !condition) {
            alert('Please enter at least a drug name or condition to save this search.');
            return;
        }
        
        const searchName = prompt('Enter a name for this saved search:', 
            drugName ? (condition ? `${drugName} for ${condition}` : drugName) : condition);
        
        if (searchName) {
            const newSearch = {
                id: Date.now().toString(),
                name: searchName,
                criteria: {
                    drugName,
                    condition,
                    years,
                    hasResultsOnly,
                    trdFocusOnly
                },
                timestamp: new Date().toISOString()
            };
            
            savedSearches.unshift(newSearch); // Add to beginning of array
            
            // Limit to 10 saved searches
            if (savedSearches.length > 10) {
                savedSearches = savedSearches.slice(0, 10);
            }
            
            localStorage.setItem('savedClinicalTrialSearches', JSON.stringify(savedSearches));
            updateSavedSearchesList();
            
            // Show filled star briefly
            starOutline.classList.add('hidden');
            starFilled.classList.remove('hidden');
            setTimeout(() => {
                starOutline.classList.remove('hidden');
                starFilled.classList.add('hidden');
            }, 1500);
        }
    });
    
    function updateSavedSearchesList() {
        savedSearchesList.innerHTML = '';
        
        if (savedSearches.length === 0) {
            savedSearchesList.innerHTML = '<div class="p-4 text-sm text-gray-500 text-center">No saved searches yet</div>';
            return;
        }
        
        savedSearches.forEach(search => {
            const item = document.createElement('div');
            item.className = 'px-4 py-3 hover:bg-gray-50 border-b border-gray-100 last:border-b-0 cursor-pointer transition duration-150';
            
            const nameEl = document.createElement('div');
            nameEl.className = 'text-sm font-medium text-gray-800 mb-1 flex items-center';
            
            // Add a small star icon before the name
            const starIcon = document.createElement('span');
            starIcon.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 text-yellow-400 mr-1.5" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                </svg>
            `;
            nameEl.appendChild(starIcon);
            
            const nameText = document.createElement('span');
            nameText.textContent = search.name;
            nameEl.appendChild(nameText);
            
            const detailsEl = document.createElement('div');
            detailsEl.className = 'text-xs text-gray-500 ml-5';
            
            let detailsText = [];
            if (search.criteria.drugName) detailsText.push(`<span class="font-medium">Drug:</span> ${search.criteria.drugName}`);
            if (search.criteria.condition) detailsText.push(`<span class="font-medium">Condition:</span> ${search.criteria.condition}`);
            detailsText.push(`<span class="font-medium">Timeline:</span> ${search.criteria.years} years`);
            
            detailsEl.innerHTML = detailsText.join(' • ');
            
            const actionsEl = document.createElement('div');
            actionsEl.className = 'flex justify-between items-center mt-2 ml-5';
            
            const dateEl = document.createElement('span');
            dateEl.className = 'text-xs text-gray-400 flex items-center';
            const searchDate = new Date(search.timestamp);
            
            // Add a small clock icon
            dateEl.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                ${searchDate.toLocaleDateString()}
            `;
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'text-red-500 hover:text-red-700 text-xs flex items-center transition duration-150';
            deleteBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
                Delete
            `;
            
            deleteBtn.onclick = function(e) {
                e.stopPropagation(); // Prevent triggering the parent click
                // Modern confirmation (in a real app, use a modal)
                if (confirm(`Delete saved search "${search.name}"?`)) {
                    savedSearches = savedSearches.filter(s => s.id !== search.id);
                    localStorage.setItem('savedClinicalTrialSearches', JSON.stringify(savedSearches));
                    updateSavedSearchesList();
                    showToast('Search deleted', 'info');
                }
            };
            
            actionsEl.appendChild(dateEl);
            actionsEl.appendChild(deleteBtn);
            
            item.appendChild(nameEl);
            item.appendChild(detailsEl);
            item.appendChild(actionsEl);
            
            // Load this search when clicked
            item.addEventListener('click', function() {
                document.getElementById('drugSearch').value = search.criteria.drugName || '';
                document.getElementById('conditionSearch').value = search.criteria.condition || '';
                timelineSlider.value = search.criteria.years;
                document.getElementById('hasResultsOnly').checked = search.criteria.hasResultsOnly;
                document.getElementById('trdFocusOnly').checked = search.criteria.trdFocusOnly;
                
                // Update the timeline display
                updateTimeline(search.criteria.years);
                
                // Close dropdown with animation
                savedSearchesDropdown.classList.add('hidden');
                
                // Show toast notification
                showToast(`Loaded search: ${search.name}`, 'success');
                
                // Auto-search
                document.getElementById('searchButton').click();
            });
            
            savedSearchesList.appendChild(item);
        });
    }
    
    // Toggle saved searches dropdown
    savedSearchesBtn.addEventListener('click', function() {
        savedSearchesDropdown.classList.toggle('hidden');
    });
    
    // Close dropdown when clicking outside
    document.addEventListener('click', function(event) {
        if (!savedSearchesBtn.contains(event.target) && !savedSearchesDropdown.contains(event.target)) {
            savedSearchesDropdown.classList.add('hidden');
        }
    });
    
    // // AI Search button functionality

    // Toast notification system
    function showToast(message, type = 'info') {
        // Remove any existing toasts
        const existingToasts = document.querySelectorAll('.toast-notification');
        existingToasts.forEach(toast => {
            document.body.removeChild(toast);
        });
        
        // Create toast container
        const toast = document.createElement('div');
        toast.className = 'toast-notification fixed bottom-4 right-4 px-4 py-2 rounded-lg shadow-lg text-white z-50 transform transition-all duration-300 translate-y-20 opacity-0';
        
        // Set background color based on type
        switch(type) {
            case 'success':
                toast.classList.add('bg-green-600');
                break;
            case 'warning':
                toast.classList.add('bg-amber-500');
                break;
            case 'error':
                toast.classList.add('bg-red-500');
                break;
            case 'info':
            default:
                toast.classList.add('bg-blue-600');
        }
        
        // Add message
        toast.textContent = message;
        
        // Add to DOM
        document.body.appendChild(toast);
        
        // Trigger animation
        setTimeout(() => {
            toast.classList.remove('translate-y-20', 'opacity-0');
        }, 10);
        
        // Auto-remove after 3 seconds
        setTimeout(() => {
            toast.classList.add('translate-y-20', 'opacity-0');
            setTimeout(() => {
                try {
                    document.body.removeChild(toast);
                } catch (e) {
                    // In case toast was already removed
                }
            }, 300);
        }, 3000);
    }

</script>

<style>
    /* Animations and hover effects */
    #sliderThumb {
        transition: transform 0.2s ease, box-shadow 0.2s ease, width 0.2s ease, height 0.2s ease;
    }
    
    #sliderThumb:hover {
        transform: scale(1.1) translateY(-3px) translateX(-45%);
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        border-width: 3px;
    }
    
    #timelineSlider:active ~ #sliderThumb {
        transform: scale(1.2) translateY(-3px) translateX(-42%);
        width: 12px;
        height: 12px;
    }
    
    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); }
        70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
        100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
    }
    
    .pulse {
        animation: pulse 1.5s infinite;
    }
    
    /* Year marker styling */
    .year-marker {
        position: relative;
        width: 2px;
        height: 8px;
        background-color: #ccc;
        transition: background-color 0.3s ease;
    }
    
    .year-marker.active {
        background-color: #4F46E5;
        height: 12px;
    }
    
    .year-marker::after {
        content: attr(data-year);
        position: absolute;
        bottom: -20px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 10px;
        color: #666;
        white-space: nowrap;
    }
</style>

<script>
    // Enhanced timeline slider functionality
    const timelineSlider = document.getElementById('timelineSlider');
    const yearValue = document.getElementById('yearValue');
    const thumbValue = document.getElementById('thumbValue');
    const sliderThumb = document.getElementById('sliderThumb');
    const filledTrack = document.getElementById('filledTrack');
    const yearMarkers = document.getElementById('yearMarkers');
    const startYear = document.getElementById('startYear');
    const currentYear = document.getElementById('currentYear');
    
    // Calculate and display years
    const today = new Date();
    const thisYear = today.getFullYear();
    currentYear.textContent = thisYear;
    updateStartYear(7); // Default value
    
    // Create year markers
    createYearMarkers();
    
    // Update on slider change
    timelineSlider.addEventListener('input', function() {
        const value = this.value;
        const percentage = ((value - 1) / 14) * 100;
        
        // Update displayed values
        yearValue.textContent = value;
        thumbValue.textContent = value;
        
        // Update visual elements
        sliderThumb.style.left = `${percentage}%`;
        filledTrack.style.width = `${percentage}%`;
        
        // Update start year
        updateStartYear(value);
        
        // Add pulse effect to thumb
        sliderThumb.classList.add('pulse');
        setTimeout(() => {
            sliderThumb.classList.remove('pulse');
        }, 1000);
        
        // Update active year markers
        updateActiveYearMarkers(value);
    });
    
    // Functions to create and update timeline elements
    function updateStartYear(yearsBack) {
        startYear.textContent = thisYear - yearsBack;
    }
    
    function createYearMarkers() {
        yearMarkers.innerHTML = '';
        const currentYear = new Date().getFullYear();
        
        for (let i = 1; i <= 15; i++) {
            const marker = document.createElement('div');
            marker.className = 'year-marker';
            marker.setAttribute('data-year', currentYear - i);
            marker.setAttribute('data-value', i);
            
            if (i <= 7) { // Default value is 7, so mark these as active
                marker.classList.add('active');
            }
            
            yearMarkers.appendChild(marker);
        }
    }
    
    function updateActiveYearMarkers(value) {
        const markers = document.querySelectorAll('.year-marker');
        markers.forEach(marker => {
            const markerValue = parseInt(marker.getAttribute('data-value'));
            if (markerValue <= value) {
                marker.classList.add('active');
            } else {
                marker.classList.remove('active');
            }
        });
    }
    
    // Add hover effects to the slider
    timelineSlider.addEventListener('mouseover', function() {
        sliderThumb.classList.add('hover');
    });
    
    timelineSlider.addEventListener('mouseout', function() {
        sliderThumb.classList.remove('hover');
    });
</script>

        <!-- Loading State -->
        <div id="loadingState" class="hidden">
            <div class="flex justify-center items-center p-10">
                <svg class="animate-spin h-10 w-10 text-primary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span class="ml-3 text-lg font-medium">Loading studies...</span>
            </div>
        </div>

        <!-- Placeholder Message -->
        <div id="placeholderMessage" class="bg-white rounded-lg shadow-md p-10 text-center text-gray-500">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
            </svg>
            <p class="text-lg">Enter a drug name and click "Search" to analyze clinical trials</p>
            <p class="mt-2 text-sm">Example searches: Ketamine, Psilocybin, Esketamine, PCN-101, COMP360</p>
        </div>
        <div id="trial-dashboard" class="max-w-6xl mx-auto p-4" style="display: none;">
            <!-- Content will be dynamically populated by JavaScript -->
            <div class="animate-pulse flex flex-col space-y-4">
                <div class="h-8 bg-gray-200 rounded w-3/4 mx-auto"></div>
                <div class="h-4 bg-gray-200 rounded w-1/2 mx-auto"></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="h-64 bg-gray-200 rounded"></div>
                    <div class="h-64 bg-gray-200 rounded"></div>
                    <div class="h-64 bg-gray-200 rounded"></div>
                    <div class="h-64 bg-gray-200 rounded"></div>
                </div>
                <div class="h-32 bg-gray-200 rounded"></div>
            </div>
        </div>



        <!-- PubMed Section (Initially Hidden) -->
<section id="pubmedSection" class="hidden mt-8 bg-white rounded-lg shadow-md p-6">
    <h2 class="text-2xl font-bold text-gray-800 mb-4">PubMed Articles</h2>
<!-- Loading state -->
<div id="pubmedLoading" class="flex justify-center items-center py-12 hidden">
    <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary"></div>
</div>

<!-- Error state -->
<div id="pubmedError" class="bg-red-50 p-6 rounded-lg text-center hidden">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-red-500 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
    </svg>
    <div class="text-red-800 font-medium text-lg">An error occurred</div>
    <div id="pubmedErrorMessage" class="text-red-700 mt-1"></div>
    <button onclick="window.location.reload()" class="mt-4 bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-md transition duration-150">
        Try Again
    </button>
</div>

<!-- Empty state -->
<div id="pubmedEmpty" class="bg-gray-50 p-8 rounded-lg text-center hidden">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
    </svg>
    <div class="text-gray-700 font-medium text-lg">No articles found</div>
    <div class="text-gray-600 mt-1">Try adjusting your search terms or filters</div>
</div>

<!-- Treatments section (replaces the summary) -->
<div id="pubmedTreatments" class="mb-8 hidden">
    <div id="pubmedTreatmentsLoading" class="flex justify-center items-center py-6 hidden">
        <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-primary"></div>
    </div>
    
    <div id="pubmedTreatmentsContent" class="hidden"></div>
</div>

<!-- Drug information section -->
<div id="pubmedDrugInfo" class="mb-8 hidden">
    <div id="pubmedDrugInfoLoading" class="flex justify-center items-center py-6 hidden">
        <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-primary"></div>
    </div>
    
    <div id="pubmedDrugInfoContent" class="hidden"></div>
</div>

<!-- Articles section -->
<div id="pubmedArticles" class="hidden">
    <div class="flex justify-between items-center mb-4 bg-white p-3 rounded-lg shadow-sm border border-gray-200">
        <div id="pubmedResultCount" class="text-gray-600 font-medium"></div>
        
        <div class="flex items-center space-x-2">
            <!-- We're keeping sorting/filtering in the advanced options now -->
        </div>
    </div>
    
    <div id="pubmedArticlesList" class="space-y-4 optimize-render"></div>
    
    <div id="pubmedPagination" class="mt-6 flex justify-center hidden">
        <button id="pubmedLoadMore" class="bg-primary text-white px-6 py-2 rounded-md hover:bg-primary-dark transition-colors duration-200 flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
            Load More Results
        </button>
    </div>
</div>
</div>
     <!-- Filter bar that appears when conditions are detected
     <div id="pubmedFilterBar" class="flex flex-wrap gap-2 mb-4 hidden">
        <span class="text-sm font-medium text-gray-700">Filter by condition:</span>
      
      </div>
      
    
      <div id="pubmedLoading" class="flex justify-center items-center py-12 hidden">
        <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary"></div>
      </div>
      
   
      <div id="pubmedError" class="bg-red-50 p-4 rounded-lg text-center hidden">
        <div class="text-red-600 font-medium">An error occurred</div>
        <div id="pubmedErrorMessage" class="text-red-500 text-sm mt-1"></div>
      </div>

      <div id="pubmedEmpty" class="bg-gray-50 p-8 rounded-lg text-center hidden">
        <div class="text-gray-600 font-medium">No articles found</div>
        <div class="text-gray-500 text-sm mt-1">Try adjusting your search terms or filters</div>
      </div>
     
      <div class="flex justify-end mb-4">
        <button id="pubmedToggleSummary" class="px-3 py-1 bg-gray-100 hover:bg-gray-200 text-gray-700 text-sm rounded transition">
          Hide Summary
        </button>
      </div>
      
   
      <div id="pubmedSummary" class="mb-8 hidden">
        <div id="pubmedSummaryLoading" class="flex justify-center items-center py-6 hidden">
          <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-primary"></div>
        </div>
        
        <div id="pubmedSummaryContent" class="grid grid-cols-1 md:grid-cols-2 gap-6 hidden">
          <div class="bg-white rounded-lg p-4 shadow-sm">
            <h3 class="text-md font-semibold text-gray-800 mb-3">Publication Timeline</h3>
            <div id="pubmedTimeline" class="h-64"></div>
          </div>
          
          <div class="bg-white rounded-lg p-4 shadow-sm">
            <h3 class="text-md font-semibold text-gray-800 mb-3">Top Journals</h3>
            <div id="pubmedJournals"></div>
          </div>
          
          <div class="bg-white rounded-lg p-4 shadow-sm">
            <h3 class="text-md font-semibold text-gray-800 mb-3">Research Focus Areas</h3>
            <div id="pubmedKeyAreas"></div>
          </div>
          
          <div class="bg-white rounded-lg p-4 shadow-sm">
            <h3 class="text-md font-semibold text-gray-800 mb-3">Common Topics</h3>
            <div id="pubmedTopics">
              <div id="pubmedTopicsCloud" class="mt-2"></div>
            </div>
          </div>
        </div>
      </div>
      
     
      <div id="pubmedTreatments" class="mb-8 hidden">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">Treatments by Condition</h2>
        
        <div id="pubmedTreatmentsLoading" class="flex justify-center items-center py-6 hidden">
          <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-primary"></div>
        </div>
        
        <div id="pubmedTreatmentsContent" class="hidden"></div>
      </div>
      
      <div id="pubmedArticles" class="hidden">
        <div class="flex justify-between items-center mb-4">
          <div id="pubmedResultCount" class="text-gray-600 font-medium"></div>
          
          <div class="flex items-center space-x-4">
            <div class="flex items-center">
              <input type="checkbox" id="pubmedFullTextOnly" class="mr-2">
              <label for="pubmedFullTextOnly" class="text-sm text-gray-600">Full text only</label>
            </div>
            
            <select id="pubmedSort" class="border border-gray-300 rounded px-2 py-1 text-sm">
              <option value="relevance">Relevance</option>
              <option value="date">Most Recent</option>
              <option value="citations">Most Cited</option>
            </select>
          </div>
        </div>
        
        <div id="pubmedArticlesList" class="space-y-4"></div>
        
        <div id="pubmedPagination" class="mt-6 flex justify-center hidden">
          <button id="pubmedLoadMore" class="px-4 py-2 bg-primary text-white rounded hover:bg-primary-dark transition">
            Load More
          </button>
        </div>
      </div> -->

    <!-- <div class="flex items-center justify-between mb-4">
      <h2 class="text-xl font-bold text-gray-800">PubMed Articles</h2>
      <div class="text-sm text-gray-500" id="pubmedResultCount" ></div>
    </div>
    
 
    <div id="pubmedLoading" class="hidden">
      <div class="flex justify-center items-center py-12">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
      </div>
      <p class="text-center text-gray-500">Searching PubMed database...</p>
    </div>

    <div id="pubmedError" class="hidden">
      <div class="text-center py-8">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-red-500 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <p class="text-lg">Error fetching PubMed articles</p>
        <p class="mt-2 text-sm" id="pubmedErrorMessage">Please try again later.</p>
      </div>
    </div>

    <div id="pubmedEmpty" class="hidden">
      <div class="text-center py-8">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
        <p class="text-lg">No PubMed articles found</p>
        <p class="mt-2 text-sm">Try a different search term or broaden your search criteria.</p>
      </div>
    </div>
    
   
<div id="pubmedSummary" class="hidden mb-6 bg-white rounded-lg shadow-md p-4">
    <h3 class="text-lg font-semibold text-gray-800 mb-2">Research Summary</h3>
    
   
    <div id="pubmedSummaryLoading" class="py-3">
      <div class="flex items-center space-x-2">
        <div class="animate-pulse rounded-full h-4 w-4 bg-primary"></div>
        <p class="text-sm text-gray-500">Analyzing research trends...</p>
      </div>
    </div>
    

    <div id="pubmedSummaryContent" class="hidden">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    
        <div class="bg-gray-50 p-3 rounded-md">
          <h4 class="font-medium text-gray-700 mb-2">Key Research Areas</h4>
          <div id="pubmedKeyAreas" class="text-sm"></div>
        </div>
        
       
        <div class="bg-gray-50 p-3 rounded-md">
            <h4 class="font-medium text-gray-700 mb-2">Publication Timeline</h4>
            <div id="pubmedTimeline" class="text-sm">
              <table class="w-full text-xs">
                <tbody id="pubmedTimelineTable"></tbody>
              </table>
            </div>
          </div>

        
        <div class="bg-gray-50 p-3 rounded-md">
          <h4 class="font-medium text-gray-700 mb-2">Common Topics</h4>
          <div id="pubmedTopics" class="text-sm">
            <div id="pubmedTopicsCloud" class="flex flex-wrap gap-1 mt-1"></div>
          </div>
        </div>
        
       
        <div class="bg-gray-50 p-3 rounded-md">
          <h4 class="font-medium text-gray-700 mb-2">Notable Journals</h4>
          <div id="pubmedJournals" class="text-sm"></div>
        </div>
      </div>
    </div>
  </div>

    <div id="pubmedArticles" class="hidden">
      <div class="mb-4 flex justify-between items-center">
        <div>
          <select id="pubmedSort" class="rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 text-sm">
            <option value="relevance">Sort by Relevance</option>
            <option value="date">Sort by Date (Newest)</option>
            <option value="citationCount">Sort by Citation Count</option>
          </select>
        </div>
        <div>
          <label class="inline-flex items-center text-sm">
            <input type="checkbox" id="pubmedFullTextOnly" class="rounded border-gray-300 text-primary focus:ring-primary">
            <span class="ml-2">Full text only</span>
          </label>
        </div>
      </div>
      
      <div id="pubmedArticlesList" class="space-y-4">
     
      </div>
      
      <div class="mt-6 text-center" id="pubmedPagination">
        <button id="pubmedLoadMore" class="bg-gray-100 hover:bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-md transition duration-150 ease-in-out">
          Load More Articles
        </button>
      </div>
    </div> -->
  </section>

  <div id="clinical-trials-dashboard" class="mb-8 hidden">
<div>
    <p></p>
</div>
  </div>

<!-- EMA Data Section -->
<section id="emaDataSection" class=" hidden mb-6">
  <div class="bg-white rounded-lg shadow-md p-6">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-semibold">European Medicines Agency (EMA) Data</h2>
      <div class="flex items-center" style="display: none;">
        <span id="emaDataLastUpdated" class="text-xs text-gray-500 mr-2" >Last updated: Loading...</span>
        <button id="refreshEmaDataBtn" class="text-xs bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded" style="display: none;">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
          </svg>
          Refresh
        </button>
      </div>
    </div>
    
    <!-- EMA Data Tabs -->
    <div class="mb-6 border-b border-gray-200">
      <ul class="flex flex-wrap -mb-px text-sm font-medium text-center" role="tablist">
        <li class="mr-2" role="presentation">
          <button class="ema-tab-button inline-block p-4 border-b-2 border-blue-500 rounded-t-lg active text-blue-600" 
                  id="ema-approval-tab" 
                  data-tab="ema-approval-content"
                  aria-selected="true">
            EMA Approvals
          </button>
        </li>
        <li class="mr-2" role="presentation">
          <button class="ema-tab-button inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300" 
                  id="ema-orphan-tab" 
                  data-tab="ema-orphan-content"
                  aria-selected="false">
            Orphan Designations
          </button>
        </li>
        <li class="mr-2" role="presentation">
          <button class="ema-tab-button inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300" 
                  id="ema-safety-tab" 
                  data-tab="ema-safety-content"
                  aria-selected="false">
            Safety Communications
          </button>
        </li>
        <li class="mr-2" role="presentation">
          <button class="ema-tab-button inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300" 
                  id="ema-psusa-tab" 
                  data-tab="ema-psusa-content"
                  aria-selected="false">
            PSUSA
          </button>
        </li>
        <li class="mr-2" role="presentation">
          <button class="ema-tab-button inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300" 
                  id="ema-referrals-tab" 
                  data-tab="ema-referrals-content"
                  aria-selected="false">
            Referrals
          </button>
        </li>
        <li role="presentation">
          <button class="ema-tab-button inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300" 
                  id="ema-shortages-tab" 
                  data-tab="ema-shortages-content"
                  aria-selected="false">
            Shortages
          </button>
        </li>
      </ul>
    </div>
    
    <!-- EMA Tab Content -->
    <div class="ema-tab-content">
      <!-- EMA Approvals Tab Content -->
      <div id="ema-approval-content" class="ema-tab-pane active">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-medium">Marketing Authorizations</h3>
          <span class="text-xs px-2 py-1 bg-blue-100 text-blue-800 rounded-full" id="emaApprovalCount" style="display: none;">0 approvals</span>
        </div>
        <div class="ema-data-container" id="emaApprovalData">
          <div class="flex justify-center items-center py-8 text-gray-500">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span>EMA approval data will be available here once you search for a drug</span>
          </div>
        </div>
      </div>
      
      <!-- Orphan Designations Tab Content -->
      <div id="ema-orphan-content" class="ema-tab-pane hidden">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-medium">Orphan Drug Designations</h3>
          <span class="text-xs px-2 py-1 bg-purple-100 text-purple-800 rounded-full" id="emaOrphanCount" style="display: none;">0 designations</span>
        </div>
        <div class="ema-data-container" id="emaOrphanData">
          <div class="flex justify-center items-center py-8 text-gray-500">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
            </svg>
            <span>Orphan designation data will be available here once you search for a drug</span>
          </div>
        </div>
      </div>
      
      <!-- Safety Communications Tab Content -->
      <div id="ema-safety-content" class="ema-tab-pane hidden">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-medium">Safety Communications (DHPCs)</h3>
          <span class="text-xs px-2 py-1 bg-red-100 text-red-800 rounded-full" id="emaSafetyCount" style="display: none;">0 communications</span>
        </div>
        <div class="ema-data-container" id="emaSafetyData">
          <div class="flex justify-center items-center py-8 text-gray-500">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
            <span>Safety communication data will be available here once you search for a drug</span>
          </div>
        </div>
      </div>
      
      <!-- PSUSA Tab Content -->
      <div id="ema-psusa-content" class="ema-tab-pane hidden">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-medium">Periodic Safety Update Reports</h3>
          <span class="text-xs px-2 py-1 bg-green-100 text-green-800 rounded-full" id="emaPsusaCount" style="display: none;">0 reports</span>
        </div>
        <div class="ema-data-container" id="emaPsusaData">
          <div class="flex justify-center items-center py-8 text-gray-500">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            <span>PSUSA data will be available here once you search for a drug</span>
          </div>
        </div>
      </div>
      
      <!-- Referrals Tab Content -->
      <div id="ema-referrals-content" class="ema-tab-pane hidden">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-medium">Referral Procedures</h3>
          <span class="text-xs px-2 py-1 bg-indigo-100 text-indigo-800 rounded-full" id="emaReferralsCount" style="display: none;">0 referrals</span>
        </div>
        <div class="ema-data-container" id="emaReferralsData">
          <div class="flex justify-center items-center py-8 text-gray-500">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 19a2 2 0 01-2-2V7a2 2 0 012-2h4l2 2h4a2 2 0 012 2v1M5 19h14a2 2 0 002-2v-5a2 2 0 00-2-2H9a2 2 0 00-2 2v5a2 2 0 01-2 2z" />
            </svg>
            <span>Referral procedure data will be available here once you search for a drug</span>
          </div>
        </div>
      </div>
      
      <!-- Shortages Tab Content -->
      <div id="ema-shortages-content" class="ema-tab-pane hidden">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-medium">Medicine Shortages</h3>
          <span class="text-xs px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full" id="emaShortagesCount" style="display: none;">0 shortages</span>
        </div>
        <div class="ema-data-container" id="emaShortagesData">
          <div class="flex justify-center items-center py-8 text-gray-500">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
            </svg>
            <span>Shortage information will be available here once you search for a drug</span>
          </div>
        </div>
      </div>
    </div>
    
    <!-- File Upload Section for Admin -->
    <div class="mt-8 pt-6 border-t border-gray-200" id="emaDataAdmin">
      <h3 class="text-lg font-medium mb-4">Data Management</h3>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="bg-gray-50 p-4 rounded-lg">
          <h4 class="text-sm font-medium text-gray-700 mb-2">Upload DHPC Data</h4>
          <form id="dhpcUploadForm" class="flex flex-col space-y-2">
            <input type="file" id="dhpcFileInput" accept=".csv" class="text-sm">
            <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white text-sm py-1 px-3 rounded">
              Upload DHPC File
            </button>
          </form>
        </div>
        <div class="bg-gray-50 p-4 rounded-lg">
          <h4 class="text-sm font-medium text-gray-700 mb-2">Upload PSUSA Data</h4>
          <form id="psusaUploadForm" class="flex flex-col space-y-2">
            <input type="file" id="psusaFileInput" accept=".csv" class="text-sm">
            <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white text-sm py-1 px-3 rounded">
              Upload PSUSA File
            </button>
          </form>
        </div>
        <div class="bg-gray-50 p-4 rounded-lg">
          <h4 class="text-sm font-medium text-gray-700 mb-2">Upload Shortages Data</h4>
          <form id="shortagesUploadForm" class="flex flex-col space-y-2">
            <input type="file" id="shortagesFileInput" accept=".csv" class="text-sm">
            <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white text-sm py-1 px-3 rounded">
              Upload Shortages File
            </button>
          </form>
        </div>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
        <div class="bg-gray-50 p-4 rounded-lg">
          <h4 class="text-sm font-medium text-gray-700 mb-2">Upload Medicines Data</h4>
          <form id="medicinesUploadForm" class="flex flex-col space-y-2">
            <input type="file" id="medicinesFileInput" accept=".csv" class="text-sm">
            <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white text-sm py-1 px-3 rounded">
              Upload Medicines File
            </button>
          </form>
        </div>
        <div class="bg-gray-50 p-4 rounded-lg">
          <h4 class="text-sm font-medium text-gray-700 mb-2">Upload Referrals Data</h4>
          <form id="referralsUploadForm" class="flex flex-col space-y-2">
            <input type="file" id="referralsFileInput" accept=".csv" class="text-sm">
            <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white text-sm py-1 px-3 rounded">
              Upload Referrals File
            </button>
          </form>
        </div>
      </div>
      <div id="uploadStatus" class="mt-4 hidden"></div>
    </div>
    
    <div class="text-center mt-4">
      <p class="text-xs text-gray-500">
        Data sourced from the European Medicines Agency (EMA) public database.
      </p>
    </div>
  </div>
</section>

        <section id="fdaDataSection" class="hidden mb-6">
            <style>
                /* FDA Data Section Styles */
.fda-tab-button {
  transition: all 0.2s ease-in-out;
}

.fda-tab-button:focus {
  outline: none;
  box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
}

.fda-tab-pane {
  display: none;
}

.fda-tab-pane.active {
  display: block;
  animation: fadeIn 0.3s ease-in-out;
}

/* FDA Card Styles */
.product-card {
  transition: all 0.2s ease-in-out;
}

.product-card:hover {
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
}

/* Timeline Styling */
.timeline-dot {
  position: absolute;
  left: -6px;
  width: 12px;
  height: 12px;
  border-radius: 50%;
}

.timeline-line {
  position: absolute;
  left: 0;
  top: 0;
  bottom: 0;
  width: 2px;
  background-color: #e5e7eb;
}

/* Animation effects */
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes slideIn {
  from { transform: translateY(10px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

.fade-in {
  animation: fadeIn 0.3s ease-out;
}

.slide-in {
  animation: slideIn 0.3s ease-out;
}

/* Card hover effects */
.hover-card {
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.hover-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
}

/* Badge styles */
.badge {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  border-radius: 9999px;
  font-size: 0.75rem;
  font-weight: 500;
}

.badge-blue {
  background-color: #e0f2fe;
  color: #0369a1;
}

.badge-green {
  background-color: #dcfce7;
  color: #166534;
}

.badge-yellow {
  background-color: #fef9c3;
  color: #854d0e;
}

.badge-red {
  background-color: #fee2e2;
  color: #b91c1c;
}

.badge-purple {
  background-color: #f3e8ff;
  color: #7e22ce;
}

/* Custom scrollbar for overflow content */
.custom-scrollbar::-webkit-scrollbar {
  width: 6px;
  height: 6px;
}

.custom-scrollbar::-webkit-scrollbar-track {
  background-color: #f3f4f6;
  border-radius: 8px;
}

.custom-scrollbar::-webkit-scrollbar-thumb {
  background-color: #d1d5db;
  border-radius: 8px;
}

.custom-scrollbar::-webkit-scrollbar-thumb:hover {
  background-color: #9ca3af;
}

/* Table styling */
.table-compact th,
.table-compact td {
  padding: 0.5rem 0.75rem;
}

.table-hover tr:hover {
  background-color: #f9fafb;
}

.table-striped tbody tr:nth-child(odd) {
  background-color: #f9fafb;
}

/* Responsive adjustments */
@media (max-width: 768px) {
  .responsive-table {
    display: block;
    width: 100%;
    overflow-x: auto;
  }
  
  .mobile-card {
    display: flex;
    flex-direction: column;
    margin-bottom: 1rem;
    border: 1px solid #e5e7eb;
    border-radius: 0.375rem;
    padding: 1rem;
  }
  
  .mobile-card-label {
    font-weight: 500;
    color: #6b7280;
    font-size: 0.75rem;
    text-transform: uppercase;
    margin-bottom: 0.25rem;
  }
  
  .mobile-card-value {
    margin-bottom: 0.75rem;
  }
}

/* Chart container styles */
#adverse-events-chart {
  height: 300px; /* Fixed height to ensure chart is visible */
  position: relative;
  width: 100%;
  min-height: 300px;
  background-color: white;
  padding: 16px;
  border-radius: 8px;
}

/* Bar chart specific styles */
.chart-bar {
  transition: all 0.3s ease;
  background-color: #3b82f6;
  border-top-left-radius: 4px;
  border-top-right-radius: 4px;
  width: 100%;
  max-width: 30px;
  margin: 0 auto;
}

.chart-bar:hover {
  background-color: #2563eb;
  transform: scaleY(1.05);
  transform-origin: bottom;
}

.chart-bar-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  height: 100%;
  position: relative;
}

.chart-bar-value {
  font-size: 0.75rem;
  color: #4b5563;
  position: absolute;
  top: -20px;
  opacity: 0;
  transition: opacity 0.2s ease;
}

.chart-bar-container:hover .chart-bar-value {
  opacity: 1;
}

.chart-bar-label {
  font-size: 0.75rem;
  color: #4b5563;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 80px;
  text-align: center;
  transform: rotate(-45deg);
  transform-origin: right top;
  position: absolute;
  bottom: -24px;
  right: 50%;
}

/* Grid lines */
.chart-grid-line {
  position: absolute;
  left: 0;
  right: 0;
  height: 1px;
  background-color: #e5e7eb;
}

.chart-y-axis {
  position: absolute;
  left: 0;
  top: 0;
  bottom: 0;
  width: 40px;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  padding: 8px 0;
}

.chart-y-label {
  font-size: 0.75rem;
  color: #6b7280;
  text-align: right;
  padding-right: 8px;
}

/* Make sure chart is responsive */
@media (max-width: 640px) {
  #adverse-events-chart {
    height: 240px;
    min-height: 240px;
    padding: 12px;
  }
  
  .chart-bar-label {
    max-width: 60px;
    font-size: 0.7rem;
  }
}

/* Animation for chart loading */
@keyframes barGrow {
  from { height: 0; }
  to { height: var(--bar-height); }
}

.animate-bar {
  animation: barGrow 1s ease-out forwards;
  height: 0;
}
            </style>
            <div class="bg-white rounded-lg shadow-md p-6">
              <h2 class="text-xl font-semibold mb-4">FDA Regulatory Information</h2>
              <button style="display: none;" id="generate-summary-btn" class="mt-2 sm:mt-0 bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded transition-colors" type="button" onclick="showFdaSummary()">
                Generate Summary <span class="text-xs bg-white text-blue-800 ml-1 px-1.5 py-0.5 rounded-full">AI</span>
              </button>
           
            
            <!-- Summary Container - Will be populated by JS -->
            <div id="fda-summary-container" class="mb-6 hidden"></div>


              <div class="mb-6">
                <div class="flex items-center justify-between">
                  <h3 class="text-lg font-medium">FDA Documents</h3>
                  <span class="text-xs px-2 py-1 bg-blue-100 text-blue-800 rounded-full" id="fdaDocCount" style="display: none;">0 documents</span>
                </div>
                <div class="mt-3 p-4 bg-gray-50 rounded-lg" id="fdaDocuments">
                  <div class="flex justify-center items-center py-8 text-gray-500">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <span>FDA document data will be available here</span>
                  </div>
                </div>
              </div>
              
              <div class="mb-6">
                <div class="flex items-center justify-between">
                  <h3 class="text-lg font-medium">Orange Book Information</h3>
                  <span class="text-xs px-2 py-1 bg-orange-100 text-orange-800 rounded-full" id="orangeBookCount" style="display: none;">0 entries</span>
                </div>
                <div class="mt-3 p-4 bg-gray-50 rounded-lg" id="orangeBookData">
                  <div class="flex justify-center items-center py-8 text-gray-500">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                    </svg>
                    <span>Orange Book listings will be available here</span>
                  </div>
                </div>
              </div>
              
              <div class="mb-6">
                <div class="flex items-center justify-between">
                  <h3 class="text-lg font-medium">DailyMed Information</h3>
                  <span class="text-xs px-2 py-1 bg-green-100 text-green-800 rounded-full" id="dailyMedCount" style="display: none;">0 entries</span>
                </div>
                <div class="mt-3 p-4 bg-gray-50 rounded-lg" id="dailyMedData">
                  <div class="flex justify-center items-center py-8 text-gray-500">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8v8m-4-5v5m-4-2v2m-2 4h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    <span>DailyMed information will be available here</span>

                  </div>
                </div>
                <div id="dailyMedPagination" class="mt-4"></div>
              </div>
<!--               
              <div class="mb-3">
                <div class="flex items-center justify-between">
                  <h3 class="text-lg font-medium">FDA Warning Letters</h3>
                  <span class="text-xs px-2 py-1 bg-red-100 text-red-800 rounded-full" id="warningLettersCount" style="display: none;">0 letters</span>
                </div>
                <div class="mt-3 p-4 bg-gray-50 rounded-lg" id="warningLettersData">
                  <div class="flex justify-center items-center py-8 text-gray-500">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                    <span>Warning letters will be available here</span>
                  </div>
                </div>
              </div> -->

              <!-- <div class="fda-data-section"> -->
                <!-- Warning Letters Section -->
                <!-- <div class="mb-6">
                  <div class="flex items-center justify-between">
                    <h3 class="text-lg font-medium">FDA Warning Letters</h3>
                    <span class="text-xs px-2 py-1 bg-red-100 text-red-800 rounded-full" id="warningLettersCount" style="display: none;">0 letters</span>
                  </div>
                  <div class="mt-3 p-4 bg-gray-50 rounded-lg" id="warningLettersData">
                    <div class="flex justify-center items-center py-8 text-gray-500">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                      </svg>
                      <span>Warning letters will be available here</span>
                    </div>
                  </div>
                </div> -->
                <div class="mb-6">
                    <div class="flex items-center justify-between mb-3">
                      <h3 class="text-xl font-semibold text-gray-800">FDA Warning Letters</h3>
                      <span class="text-xs px-2 py-1 bg-red-100 text-red-800 rounded-full" id="warningLettersCount" style="display: none;">0 letters</span>
                    </div>
                    <div class="p-4 bg-white rounded-lg shadow-md" id="warningLettersData">
                      <div class="flex justify-center items-center py-8 text-gray-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                        </svg>
                        <span>Warning letters will be displayed here after search</span>
                      </div>
                    </div>
                  </div>
                
                <!-- Inspection Data Section (will be populated dynamically) -->
                <!-- <div id="inspection-data"></div> -->
              </div>
            </div>
          </div>
              
              <div class="text-center mt-6">
                <p class="text-sm text-gray-500">
                  Data sourced from FDA.gov, DailyMed, and FDA Orange Book. Last updated: March 2025
                </p>
              </div>
            </div>
          <!-- </section> -->
          <div id="company-summary-section"></div>
        <!-- Inspection Data Section -->
        <div id="inspection-data" class="p-4 bg-white rounded-lg shadow-md mb-8">
            <div class="flex justify-center items-center py-8 text-gray-500">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <span>Inspection data will be displayed here after search</span>
            </div>
          </div>
        </section>
        
        <!-- No Results Message -->
        <div id="no-results" class="hidden text-center p-8 bg-white rounded-lg shadow-md">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-blue-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16l2.879-2.879m0 0a3 3 0 104.243-4.242 3 3 0 00-4.243 4.242zM21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <h3 class="text-lg font-medium text-gray-900 mb-2">No Results Found</h3>
          <p class="text-gray-600">We couldn't find any FDA data for these companies. Try different company names or check your spelling.</p>
        </div>
    

<!-- Custom CSS for Warning Letters Section -->
<style>
  /* Timeline Styling */
.timeline-dot {
  position: absolute;
  left: -6px;
  width: 12px;
  height: 12px;
  border-radius: 50%;
}

.timeline-line {
  position: absolute;
  left: 0;
  top: 0;
  bottom: 0;
  width: 2px;
  background-color: #e5e7eb;
}

/* Company Summary Section */
#company-summary-section .prose p {
  margin-bottom: 1rem;
}

#company-summary-section .prose h6 {
  font-weight: 600;
}
  /* Custom scrollbar for warning letters content */
  .custom-scrollbar::-webkit-scrollbar {
    width: 8px;
    height: 8px;
  }
  
  .custom-scrollbar::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
  }
  
  .custom-scrollbar::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 4px;
  }
  
  .custom-scrollbar::-webkit-scrollbar-thumb:hover {
    background: #a1a1a1;
  }
  
  /* Line clamp utility for truncating text */
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  /* Highlighted text in search results */
  .highlight {
    background-color: #FEFCBF;
    padding: 0 2px;
    border-radius: 2px;
  }
  
  /* Card hover effect */
  .hover-card {
    transition: all 0.2s;
  }
  
  .hover-card:hover {
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    transform: translateY(-2px);
  }
  
  /* Animations */
  .animate-pulse {
    animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
  }
  
  @keyframes pulse {
    0%, 100% {
      opacity: 1;
    }
    50% {
      opacity: 0.5;
    }
  }
</style>

        <div class="bg-white p-4 rounded-lg shadow mb-6 hidden">
            <div class="flex flex-col md:flex-row gap-4">
              <div class="flex-1">
                <label for="trial-selection" class="block text-sm font-medium text-gray-700 mb-1">Select a trial</label>
                <select id="trial-selection" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                  <option value="">-- Select a trial --</option>
                </select>
              </div>
              <div class="flex items-end">
                <button id="visualize-btn" class="w-full md:w-auto px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                  Visualize Trial
                </button>
              </div>
            </div>
            <div class="mt-4" id="loading-indicator" style="display: none;">
              <div class="flex items-center justify-center">
                <svg class="animate-spin h-5 w-5 text-indigo-600 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span>Generating visualization...</span>
              </div>
            </div>
         
          
          <!-- Empty div that will be populated with visualization -->
          <div id="visualization-container" class="bg-white p-4 rounded-lg shadow min-h-[500px]"></div>
        </div>
      

<!-- Overall Drug Success Rate Section -->
<section id="drugSuccessSection" style="border: 1px solid blue;" class="hidden mb-6" style="display: none;">
    <div class="bg-white rounded-lg shadow-md p-6">
      <h2 class="text-xl font-semibold mb-4">Overall Drug Success Rates</h2>
      
      <div class="mb-6">
        <h3 class="text-lg font-medium mb-3">Treatment Efficacy Comparison Across Trials</h3>
        <p class="text-sm text-gray-600 mb-4">This visualization combines data from all trials to show overall effectiveness of treatments. Higher values indicate better outcomes relative to placebo.</p>
        <div class="h-72">
          <canvas id="overallDrugSuccessChart"></canvas>
        </div>
      </div>
  
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <div>
          <h3 class="text-lg font-medium mb-3">Response Rate Distribution</h3>
          <p class="text-sm text-gray-600 mb-2">Percentage of patients who responded to treatment</p>
          <div class="h-64">
            <canvas id="responseRateChart"></canvas>
          </div>
        </div>
        <div>
          <h3 class="text-lg font-medium mb-3">Remission Rate Distribution</h3>
          <p class="text-sm text-gray-600 mb-2">Percentage of patients who achieved remission</p>
          <div class="h-64">
            <canvas id="remissionRateChart"></canvas>
          </div>
        </div>
      </div>
      
      <div class="mb-6">
        <h3 class="text-lg font-medium mb-3">Statistical Summary by Drug</h3>
        <div class="overflow-x-auto">
          <table class="min-w-full bg-white border border-gray-200">
            <thead>
              <tr>
                <th class="py-2 px-4 border-b text-left">Drug</th>
                <th class="py-2 px-4 border-b text-left">Trials</th>
                <th class="py-2 px-4 border-b text-left">Total Patients</th>
                <th class="py-2 px-4 border-b text-left">Avg. Effect Size</th>
                <th class="py-2 px-4 border-b text-left">Response Rate</th>
                <th class="py-2 px-4 border-b text-left">Remission Rate</th>
              </tr>
            </thead>
            <tbody id="drugSuccessSummaryTable">
              <!-- Will be populated dynamically -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </section>
        <!-- Results Overview -->
        <section id="resultsOverview" class="hidden mb-6">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4">Results Overview</h2>
                <div id="resultsSummary" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                    <!-- Will be populated dynamically -->
                </div>
                <div class="flex flex-wrap gap-2 mb-4" id="phaseFilter">
                    <button class="phase-filter bg-primary text-white px-3 py-1 rounded-full text-sm" data-phase="all">All Phases</button>
                    <button class="phase-filter bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded-full text-sm" data-phase="PRE_PHASE">Pre-Phase</button>
                    <button class="phase-filter bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded-full text-sm" data-phase="PHASE1">Phase 1</button>
                    <button class="phase-filter bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded-full text-sm" data-phase="PHASE2">Phase 2</button>
                    <button class="phase-filter bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded-full text-sm" data-phase="PHASE3">Phase 3</button>
                    <button class="phase-filter bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded-full text-sm" data-phase="PHASE4">Phase 4</button>
                    <button class="phase-filter bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded-full text-sm" data-phase="PHASE1_PHASE2">Phase 1/2</button>
                </div>
            </div>
        </section>

        <!-- Collated Outcomes Section -->
<!-- Enhanced Collated Outcomes Section -->
<section id="collatedOutcomesSection" style="border: 1px solid red;" class="hidden mb-6" style="display: none;">
    <div class="bg-white rounded-lg shadow-md p-6">
      <h2 class="text-xl font-semibold mb-4">Collated Trial Outcomes</h2>
      
      <div class="mb-6">
        <h3 class="text-lg font-medium mb-3">Overall Treatment Effect Distribution</h3>
        <div class="flex justify-between mb-4">
          <div>
            <select id="outcomeMetricSelector" class="p-2 border border-gray-300 rounded-lg">
              <!-- Will be populated dynamically -->
            </select>
          </div>
          <div>
            <select id="outcomeTypeSelector" class="p-2 border border-gray-300 rounded-lg">
              <option value="all">All Outcomes</option>
              <option value="primary" selected>Primary Outcomes</option>
              <option value="secondary">Secondary Outcomes</option>
            </select>
          </div>
        </div>
        <div class="h-72">
          <canvas id="overallTreatmentEffectChart"></canvas>
        </div>
      </div>
      
      <div class="mb-6">
        <h3 class="text-lg font-medium mb-3">Phase Comparison</h3>
        <p class="text-sm text-gray-600 mb-4">Compare effect sizes across different clinical trial phases. Higher values indicate better outcomes.</p>
        <div class="h-72">
          <canvas id="phaseComparisonChart"></canvas>
        </div>
      </div>
      
      <div class="mb-6">
        <h3 class="text-lg font-medium mb-3">Comparative Phase Performance</h3>
        <p class="text-sm text-gray-600 mb-4">Direct comparison of phase-specific effect sizes with confidence intervals.</p>
        <div class="h-72">
          <canvas id="phasePerformanceChart"></canvas>
        </div>
      </div>
      
      <div class="mt-8">
        <h3 class="text-lg font-medium mb-3">Statistical Summary</h3>
        <div class="overflow-x-auto">
          <table class="min-w-full bg-white border border-gray-200">
            <thead>
              <tr>
                <th class="py-2 px-4 border-b text-left">Phase</th>
                <th class="py-2 px-4 border-b text-left">Trials</th>
                <th class="py-2 px-4 border-b text-left">Mean Effect</th>
                <th class="py-2 px-4 border-b text-left">Standard Deviation</th>
                <th class="py-2 px-4 border-b text-left">95% CI</th>
                <th class="py-2 px-4 border-b text-left">p-value</th>
              </tr>
            </thead>
            <tbody id="statisticalSummaryTable">
              <!-- Will be populated dynamically -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </section>
  
  <!-- New FDA Data Section -->


        <!-- Studies List -->
        <section id="studiesSection" class="hidden mb-6">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4">Studies (<span id="studyCount">0</span>)</h2>
                <div id="studiesList" class="space-y-4">
                    <!-- Will be populated dynamically -->
                </div>
            </div>
        </section>

        <!-- Aggregate Outcomes Section -->
        <section id="aggregateOutcomesSection" class="hidden mb-6">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4">Aggregate Outcomes by Phase</h2>
                
                <div class="mb-6">
                    <h3 class="text-lg font-medium mb-3">Overall Effectiveness Distribution</h3>
                    <canvas id="overallDistributionChart" height="300"></canvas>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-lg font-medium mb-3">Phase 1-2 Outcomes</h3>
                        <canvas id="earlyPhasesChart" height="250"></canvas>
                    </div>
                    <div>
                        <h3 class="text-lg font-medium mb-3">Phase 3-4 Outcomes</h3>
                        <canvas id="latePhasesChart" height="250"></canvas>
                    </div>
                </div>
                
                <div class="mt-6">
                    <h3 class="text-lg font-medium mb-3">Primary Outcome Measures Across Phases</h3>
                    <div id="outcomeMeasuresList" class="space-y-4">
                        <!-- Will be populated dynamically -->
                    </div>
                </div>
            </div>
        </section>

        <!-- Study Detail Section -->
        <section id="studyDetailSection" class="hidden mb-6">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">Study Details</h2>
                    <button id="closeStudyDetail" class="text-gray-500 hover:text-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div id="studyDetailContent">
                    <!-- Will be populated dynamically -->
                </div>
            </div>
        </section>

    </main>

    <script>
        // API Base URL - Use our local backend
        // const API_BASE_URL = "https://sunday-fsfq.onrender.com/api";
        //  const API_BASE_URL = 'http://localhost:3000/api';

let API_BASE_URL = null;

// Fetch config on page load
window.onload = async () => {
  try {
    const response = await fetch('/config');
    const data = await response.json();
    API_BASE_URL = data.apiUrl;
    // document.getElementById('api-url').textContent = API_BASE_URL;
    console.log(API_BASE_URL)
  } catch (err) {
    console.error('Error fetching config:', err);
    API_BASE_URL = 'https://sunday-fsfq.onrender.com/api'; // Fallback
    // document.getElementById('api-url').textContent = API_BASE_URL;
  }
};
// Module pattern to manage global searchTerm
const SearchTermManager = (function () {
  // Private global variable
  let searchTerm = '';

  // Public API
  return {
    // Function to read searchTerm
    getSearchTerm: function () {
      return searchTerm;
    },
    // Function to update searchTerm
    setSearchTerm: function (term) {
      searchTerm = term;
      console.log('searchTerm updated:', searchTerm); // For debugging
    }
  };
})();




        // State management
        const appState = {
            studies: [],
            currentStudyId: null,
            currentPhaseFilter: 'all',
            allOutcomeMeasures: [],
            collatedOutcomes: [],
            hasResultsOnly: true,
            trdFocusOnly: true,
            studyDetails: {},
            outcomeMetrics: [],
            currentOutcomeMetric: '',
            currentOutcomeType: 'primary',
            failedStudyIds: new Set() // Track failed study ID requests to avoid repeated failures
        };
        appState.fdaData = {
    documents: [],
    orangeBook: [],
    dailyMed: [],
    warningLetters: []
};
appState.allTrialOutcomes = [];
        // DOM elements
        const elements = {
            companySummarySection: null,
            ema: document.getElementById('emaDataSection'),
            ctSummary : document.getElementById('clinical-trials-dashboard'),
            drugSearch: document.getElementById('drugSearch'),
            pubmedSection: document.getElementById('pubmedSection'),
            conditionSearch: document.getElementById('conditionSearch'),
            hasResultsOnly: document.getElementById('hasResultsOnly'),
            trdFocusOnly: document.getElementById('trdFocusOnly'),
            searchButton: document.getElementById('searchButton'),
            loadingState: document.getElementById('loadingState'),
            placeholderMessage: document.getElementById('placeholderMessage'),
            resultsOverview: document.getElementById('resultsOverview'),
            resultsSummary: document.getElementById('resultsSummary'),
            studiesSection: document.getElementById('studiesSection'),
            studyCount: document.getElementById('studyCount'),
            studiesList: document.getElementById('studiesList'),
            aggregateOutcomesSection: document.getElementById('aggregateOutcomesSection'),
            collatedOutcomesSection: document.getElementById('collatedOutcomesSection'),
            studyDetailSection: document.getElementById('studyDetailSection'),
            closeStudyDetail: document.getElementById('closeStudyDetail'),
            studyDetailContent: document.getElementById('studyDetailContent'),
            phaseFilter: document.getElementById('phaseFilter'),
            outcomeMetricSelector: document.getElementById('outcomeMetricSelector'),
            outcomeTypeSelector: document.getElementById('outcomeTypeSelector'),
            statisticalSummaryTable: document.getElementById('statisticalSummaryTable'),
         // Inspection data section
         // Add to your existing elements definition
            companySummarySection : document.getElementById('company-summary-section'),
            inspectionDataSection: document.getElementById('inspection-data') || createInspectionDataSection()
        };
        elements.fdaDataSection = document.getElementById('fdaDataSection');
elements.fdaDocuments = document.getElementById('fdaDocuments');
elements.orangeBookData = document.getElementById('orangeBookData');
elements.dailyMedData = document.getElementById('dailyMedData');
elements.warningLettersData = document.getElementById('warningLettersData');
elements.fdaDocCount = document.getElementById('fdaDocCount');
elements.orangeBookCount = document.getElementById('orangeBookCount');
elements.dailyMedCount = document.getElementById('dailyMedCount');
elements.warningLettersCount = document.getElementById('warningLettersCount');
elements.phasePerformanceChart = document.getElementById('phasePerformanceChart');

        // Chart instances
        let charts = {
            overallDistribution: null,
            earlyPhases: null,
            latePhases: null,
            overallTreatmentEffect: null,
            phaseComparison: null,
            phasePerformance : null,
            studySpecific: {}
        };
// Add new elements to the DOM references
elements.drugSuccessSection = document.getElementById('drugSuccessSection');
elements.drugSuccessSummaryTable = document.getElementById('drugSuccessSummaryTable');

// Add new chart references
charts.overallDrugSuccess = null;
charts.responseRate = null;
charts.remissionRate = null;


const NLPProcessor = {
  // Extract drug name from user query with improved pattern recognition
  extractDrugName: function(query) {
    query = query.toLowerCase();
    
    // 1. Common drug classes and examples for exact matching
    const drugKeywords = [
      'ketamine', 'esketamine', 'spravato', 'pcn-101', 'comp360', 
      'psilocybin', 'mdma', 'lsd', 'dmt', '5-meo-dmt', 'ayahuasca',
      'ssri', 'snri', 'maoi', 'tca', 'antidepressant', 'antipsychotic',
      'lithium', 'lamotrigine', 'valproate', 'carbamazepine'
    ];
    
    // Check for exact drug names in the query first
    for (const drug of drugKeywords) {
      // Use word boundary checks to prevent matching substrings
      const drugRegex = new RegExp(`\\b${drug}\\b`, 'i');
      if (drugRegex.test(query)) {
        return drug;
      }
    }
    
    // 2. Common drug signal phrases and patterns
    const drugPatterns = [
      // Look for "drug X" or "medication X" patterns
      /\b(?:drug|medication|compound|molecule|therapeutic|treatment)s?\s+(?:called|named|known as)?\s+["']?([a-z0-9\-]+(?:\s+[a-z0-9\-]+)?)["']?/i,
      
      // Look for patterns like "X drug/medication" 
      /["']?([a-z0-9\-]+(?:\s+[a-z0-9\-]+)?)["']?\s+(?:drug|medication|compound|therapy)/i,
      
      // Look for patterns like "trials for X" or "studies of X"
      /(?:trials|studies)\s+(?:for|of|using|with)\s+["']?([a-z0-9\-]+(?:\s+[a-z0-9\-]+)?)["']?/i,
      
      // Look for patterns like "trials testing X" or "studies evaluating X"
      /(?:trials|studies)\s+(?:testing|evaluating|assessing|examining)\s+["']?([a-z0-9\-]+(?:\s+[a-z0-9\-]+)?)["']?/i,
      
      // Look for "X for depression" or "X in treatment" patterns
      /["']?([a-z0-9\-]+(?:\s+[a-z0-9\-]+)?)["']?\s+(?:for|in|as)\s+(?:the)?\s*(?:treatment|therapy)/i,
  
      // Look for "treated with X" patterns
      /treated\s+(?:with|using)\s+["']?([a-z0-9\-]+(?:\s+[a-z0-9\-]+)?)["']?/i,
      
      // Patterns for drug codes/identifiers (typically alphanumeric with hyphens)
      /\b([a-z]{1,3}[-]?[0-9]{1,4}(?:[-][0-9]{1,3})?)\b/i
    ];
    
    // Try each pattern and return the first match
    for (const pattern of drugPatterns) {
      const match = query.match(pattern);
      if (match && match[1]) {
        // Check that the matched string looks like a drug name (not common words)
        const candidate = match[1].trim();
        
        // Skip very common words that might be false positives
        const commonWords = ['the', 'a', 'an', 'this', 'that', 'some', 'such', 'other', 'more', 'most', 
                           'all', 'any', 'each', 'every', 'which', 'what', 'who', 'when', 'where', 'why',
                           'these', 'those', 'trials', 'studies', 'drug', 'drugs', 'treatment', 'condition',
                           'show', 'find', 'search', 'looking', 'trials', 'medicine', 'medication'];
        
        if (candidate.length > 2 && !commonWords.includes(candidate)) {
          return candidate;
        }
      }
    }
    
    // 3. Fallback to analyzing capitalized words which often indicate drug names
    // This would work well if the original query has correct capitalization
    const originalQuery = query; // Assuming the original query is passed with capitalization
    const words = originalQuery.split(/\s+/);
    
    // Look for capitalized words that might be drug names
    for (const word of words) {
      // Check if word starts with a capital letter and isn't at the beginning of a sentence
      if (word.length > 2 && /^[A-Z][a-z0-9]+$/.test(word)) {
        return word.toLowerCase();
      }
    }
    
    // 4. Look for words that appear after "using" or "with" that might be drug names
    const usingPatterns = [
      /using\s+(?:the\s+)?(?:drug|medication|compound|treatment)?\s*["']?([a-z0-9\-]+(?:\s+[a-z0-9\-]+)?)["']?/i,
      /with\s+(?:the\s+)?(?:drug|medication|compound|treatment)?\s*["']?([a-z0-9\-]+(?:\s+[a-z0-9\-]+)?)["']?/i,
    ];
    
    for (const pattern of usingPatterns) {
      const match = query.match(pattern);
      if (match && match[1]) {
        const candidate = match[1].trim();
        // Skip common words
        const commonWords = ['the', 'a', 'an', 'this', 'that', 'some', 'these', 'those'];
        if (candidate.length > 2 && !commonWords.includes(candidate)) {
          return candidate;
        }
      }
    }
    
    return '';
  },
  
  // Extract condition from user query with advanced pattern recognition
  extractCondition: function(query) {
    query = query.toLowerCase();
    
    // 1. Map of condition keywords to standardized condition names
    const conditionMap = {
      'trd': 'Treatment Resistant Depression',
      'treatment resistant depression': 'Treatment Resistant Depression',
      'treatment-resistant depression': 'Treatment Resistant Depression',
      'treatment resistant depressive disorder': 'Treatment Resistant Depression',
      'depression': 'Depression',
      'mdd': 'Major Depressive Disorder',
      'major depressive disorder': 'Major Depressive Disorder',
      'depressive disorder': 'Depression',
      'anxiety': 'Anxiety Disorder',
      'anxiety disorder': 'Anxiety Disorder', 
      'gad': 'Generalized Anxiety Disorder',
      'generalized anxiety disorder': 'Generalized Anxiety Disorder',
      'panic': 'Panic Disorder',
      'panic disorder': 'Panic Disorder',
      'ptsd': 'Post-Traumatic Stress Disorder',
      'post-traumatic stress disorder': 'Post-Traumatic Stress Disorder',
      'post traumatic stress disorder': 'Post-Traumatic Stress Disorder',
      'ocd': 'Obsessive-Compulsive Disorder',
      'obsessive compulsive disorder': 'Obsessive-Compulsive Disorder',
      'obsessive-compulsive disorder': 'Obsessive-Compulsive Disorder',
      'bipolar': 'Bipolar Disorder',
      'bipolar disorder': 'Bipolar Disorder',
      'schizophrenia': 'Schizophrenia',
      'psychosis': 'Psychosis',
      'adhd': 'Attention Deficit Hyperactivity Disorder',
      'attention deficit': 'Attention Deficit Hyperactivity Disorder',
      'attention-deficit': 'Attention Deficit Hyperactivity Disorder',
      'eating disorder': 'Eating Disorder',
      'anorexia': 'Anorexia Nervosa',
      'bulimia': 'Bulimia Nervosa',
      'insomnia': 'Insomnia',
      'sleep disorder': 'Sleep Disorder',
      'addiction': 'Addiction',
      'substance use disorder': 'Substance Use Disorder',
      'alcohol': 'Alcohol Use Disorder',
      'alcohol use': 'Alcohol Use Disorder',
      'alzheimer': 'Alzheimer\'s Disease',
      'alzheimer\'s': 'Alzheimer\'s Disease',
      'dementia': 'Dementia',
      'cognitive impairment': 'Cognitive Impairment',
      'autism': 'Autism Spectrum Disorder',
      'asd': 'Autism Spectrum Disorder',
      'migraine': 'Migraine',
      'headache': 'Headache',
      'pain': 'Chronic Pain',
      'chronic pain': 'Chronic Pain',
      'neuropathic pain': 'Neuropathic Pain',
      'cancer': 'Cancer',
      'multiple sclerosis': 'Multiple Sclerosis',
      'ms': 'Multiple Sclerosis',
      'parkinson': 'Parkinson\'s Disease',
      'parkinson\'s': 'Parkinson\'s Disease',
      'epilepsy': 'Epilepsy',
      'seizure': 'Seizure Disorder',
      'stroke': 'Stroke',
      'traumatic brain injury': 'Traumatic Brain Injury',
      'tbi': 'Traumatic Brain Injury',
    };
    
    // Check for exact condition mentions first
    for (const [keyword, condition] of Object.entries(conditionMap)) {
      // Use word boundary to prevent matching inside other words
      const keywordRegex = new RegExp(`\\b${keyword}\\b`, 'i');
      if (keywordRegex.test(query)) {
        return condition;
      }
    }
    
    // 2. Look for condition patterns
    const conditionPatterns = [
      // Look for "treating X" or "treatment of X" patterns
      /(?:treating|treatment\s+(?:of|for))\s+(?:the\s+)?(?:condition\s+)?["']?([a-z\-\s']+?)["']?(?:\s+(?:in|with|using|patients?|subjects?|participants?)|$)/i,
      
      // Look for "X treatment" or "X therapy" patterns
      /["']?([a-z\-\s']+?)["']?\s+(?:treatment|therapy|management|patients?|subjects?)/i,
      
      // Look for "patients with X" patterns
      /patients?\s+(?:with|suffering\s+from|diagnosed\s+with)\s+["']?([a-z\-\s']+?)["']?(?:\s+(?:who|treated|receiving|undergoing)|$)/i,
      
      // Look for "studies in X" patterns
      /studies\s+(?:in|of|for)\s+(?:patients?\s+with\s+)?["']?([a-z\-\s']+?)["']?(?:\s+(?:patients?|subjects?|using|treated|receiving)|$)/i,
      
      // Look for "trials for patients with X" patterns
      /trials\s+for\s+(?:patients?\s+with\s+)?["']?([a-z\-\s']+?)["']?(?:\s+(?:patients?|subjects?|using|treated|receiving)|$)/i,
      
      // Look for "indicated for X" or "used for X" patterns
      /(?:indicated|used|prescribed|approved)\s+for\s+(?:the\s+treatment\s+of\s+)?["']?([a-z\-\s']+?)["']?(?:\s+(?:in|with|using|patients?|subjects?)|$)/i,
    ];
    
    // Try each pattern and return the first match
    for (const pattern of conditionPatterns) {
      const match = query.match(pattern);
      if (match && match[1]) {
        const candidate = match[1].trim().toLowerCase();
        
        // Skip very common words that might be false positives
        const commonWords = ['the', 'a', 'an', 'this', 'that', 'some', 'such', 'other', 'more', 'most', 
                           'all', 'any', 'each', 'every', 'which', 'what', 'who', 'when', 'where', 'why',
                           'drug', 'medication', 'trial', 'study', 'research', 'clinical', 'medical', 'health'];
        
        if (candidate.length > 3 && !commonWords.includes(candidate)) {
          // Check against our map for partial matches
          for (const [keyword, condition] of Object.entries(conditionMap)) {
            if (candidate.includes(keyword)) {
              return condition;
            }
          }
          
          // If no match in our map, return the extracted phrase as is
          // Capitalize first letter of each word for better display
          return candidate.split(' ')
            .map(word => word.charAt(0).toUpperCase() + word.slice(1))
            .join(' ');
        }
      }
    }
    
    // 3. Additional fallback patterns
    const fallbackPatterns = [
      // Simple "for X" pattern
      /\b(?:for|in)\s+(?:patients?\s+with\s+)?["']?([a-z\-\s']{4,}?)["']?(?:\b|$)/i,
      
      // Diagnosis patterns
      /diagnosis\s+of\s+["']?([a-z\-\s']{4,}?)["']?(?:\b|$)/i,
      
      // Suffering from patterns
      /suffering\s+from\s+["']?([a-z\-\s']{4,}?)["']?(?:\b|$)/i,
    ];
    
    for (const pattern of fallbackPatterns) {
      const match = query.match(pattern);
      if (match && match[1]) {
        const candidate = match[1].trim().toLowerCase();
        
        // Skip common words and phrases
        const commonWords = ['the study', 'this drug', 'these trials', 'their condition', 'that medication',
                           'phase', 'year', 'month', 'week', 'time', 'use', 'people'];
        
        if (candidate.length > 3 && !commonWords.some(word => candidate.includes(word))) {
          // Check against our map for partial matches
          for (const [keyword, condition] of Object.entries(conditionMap)) {
            if (candidate.includes(keyword)) {
              return condition;
            }
          }
          
          // If no match in our map, return the extracted phrase as is
          return candidate.split(' ')
            .map(word => word.charAt(0).toUpperCase() + word.slice(1))
            .join(' ');
        }
      }
    }
    
    // 4. Medical term detection (looking for terms that end with medical suffixes)
    const medicalSuffixes = ['itis', 'osis', 'emia', 'pathy', 'oma', 'algia', 'ism', 'ase', 'lysis', 'iasis', 'trophy', 'ectomy'];
    const words = query.split(/\s+/);
    
    for (const word of words) {
      if (word.length > 5) { // Minimum length to avoid false positives
        for (const suffix of medicalSuffixes) {
          if (word.endsWith(suffix)) {
            // Found potential medical term
            return word.charAt(0).toUpperCase() + word.slice(1);
          }
        }
      }
    }
    
    return '';
  },
  
  // Extract timeline (years back) from user query
  extractYearsBack: function(query) {
    query = query.toLowerCase();
    
    // Check for explicit year mentions with numbers
    const yearMatches = query.match(/(\d+)\s*years?(\s*back|\s*ago)?/i);
    if (yearMatches && yearMatches[1]) {
      // Ensure value is between 1-15
      return Math.min(15, Math.max(1, parseInt(yearMatches[1])));
    }
    
    // Check for textual time references
    if (query.includes('last year') || query.includes('past year') || 
        query.includes('recent year') || query.includes('one year')) {
      return 1;
    } else if (query.includes('last two years') || query.includes('past two years') || 
              query.includes('recent two years') || query.includes('two years')) {
      return 2;
    } else if (query.includes('three years') || query.includes('past three years')) {
      return 3;
    } else if (query.includes('five years') || query.includes('past five years')) {
      return 5;
    } else if (query.includes('decade') || query.includes('ten years')) {
      return 10;
    }
    
    // Default to 7 years if no time frame is specified
    return 7;
  },
  
  // Detect if the query is specifically requesting results with results only
  detectResultsOnly: function(query) {
    query = query.toLowerCase();
    
    // Check for phrases indicating desire for results
    return query.includes('with results') || 
           query.includes('has results') || 
           query.includes('show results') ||
           query.includes('that have results') ||
           query.includes('completed with results') ||
           query.includes('studies with findings');
  },
  
  // Detect if query is requesting TRD specific focus
  detectTRDFocus: function(query) {
    query = query.toLowerCase();
    
    // Check for TRD specific mentions
    return query.includes('trd') || 
           query.includes('treatment resistant') || 
           query.includes('treatment-resistant') ||
           query.includes('resistant depression') ||
           query.includes('refractory depression');
  },
  
 
  detectContentTypes: function(query) {
    query = query.toLowerCase();
    console.log("hiashfiads")
    // Initialize all content types as "not explicitly requested" (all false)
    const contentTypes = {
      trials: false,
      fda: false,
      ema: false,
      publications: false,
      pubmed: false
    };
    
    // Check for trials
    if (query.includes('trial') || 
        query.includes('studies') || 
        query.includes('study') || 
        query.includes('clinical')) {
      contentTypes.trials = true;
    }
    
    // Check for FDA
    if (query.includes('fda') || 
        query.includes('food and drug') || 
        query.includes('regulatory')) {
      contentTypes.fda = true;
    }
    
    // Check for EMA
    if (query.includes('ema') || 
        query.includes('european medicines') || 
        query.includes('europe regulatory')) {
      contentTypes.ema = true;
    }
    
    // Check for publications or PubMed
    if (query.includes('publication') || 
        query.includes('literature') || 
        query.includes('papers') || 
        query.includes('pubmed') || 
        query.includes('articles') ||
        query.includes('journal')) {
      contentTypes.publications = true;
      contentTypes.pubmed = true; 
    }
    
    // Check for exclusivity modifiers
    const onlyTrials = query.includes('only trials') || 
                      query.includes('just trials') ||
                      query.includes('trials only') ||
                      query.includes('just show trials') ||
                      (query.includes('only') && contentTypes.trials && 
                      !contentTypes.fda && !contentTypes.ema && !contentTypes.publications);
    
    const onlyFDA = query.includes('only fda') || 
                   query.includes('just fda') ||
                   query.includes('fda only') ||
                   query.includes('just show fda') ||
                   query.includes('fda data only') ||
                   (query.includes('only') && contentTypes.fda && 
                   !contentTypes.trials && !contentTypes.ema && !contentTypes.publications);
    
    const onlyEMA = query.includes('only ema') || 
                  query.includes('just ema') ||
                  query.includes('ema only') ||
                  query.includes('just show ema') ||
                  (query.includes('only') && contentTypes.ema && 
                  !contentTypes.trials && !contentTypes.fda && !contentTypes.publications);
    
    const onlyPublications = query.includes('only publications') || 
                            query.includes('just publications') ||
                            query.includes('publications only') ||
                            query.includes('only pubmed') ||
                            query.includes('pubmed only') ||
                            query.includes('just show publications') ||
                            (query.includes('only') && contentTypes.publications && 
                            !contentTypes.trials && !contentTypes.fda && !contentTypes.ema);
    
    // Now determine which content should be shown
    // If any "only X" pattern is found, use strict filtering
    if (onlyTrials || onlyFDA || onlyEMA || onlyPublications) {
      // Reset all to false first (already false by default)
      
      // Then set only the requested type to true
      if (onlyTrials) contentTypes.trials = true;
      if (onlyFDA) contentTypes.fda = true;
      if (onlyEMA) contentTypes.ema = true;
      if (onlyPublications) {
        contentTypes.publications = true;
        contentTypes.pubmed = true;
      }
      
      // Log what we're showing
      console.log(`Exclusive display mode detected: ${onlyTrials ? 'Trials' : ''}${onlyFDA ? 'FDA' : ''}${onlyEMA ? 'EMA' : ''}${onlyPublications ? 'Publications' : ''}`);
      return contentTypes;
    } 
    
    // If we see an "AND" pattern, show only those specific types
    else if (
      (query.includes(' and ') || query.includes(' & ')) && 
      (contentTypes.trials || contentTypes.fda || contentTypes.ema || contentTypes.publications)
    ) {
      // Check for combined requests like "FDA and EMA" or "trials and publications"
      // Current values should represent what was mentioned
      console.log(`Combined display mode detected: ${contentTypes.trials ? 'Trials ' : ''}${contentTypes.fda ? 'FDA ' : ''}${contentTypes.ema ? 'EMA ' : ''}${contentTypes.publications ? 'Publications ' : ''}`);
      return contentTypes;
    } 
    
    // If specific content was mentioned but no exclusivity words, show those
    else if (contentTypes.trials || contentTypes.fda || contentTypes.ema || contentTypes.publications) {
      console.log(`Mentioned content types: ${contentTypes.trials ? 'Trials ' : ''}${contentTypes.fda ? 'FDA ' : ''}${contentTypes.ema ? 'EMA ' : ''}${contentTypes.publications ? 'Publications ' : ''}`);
      return contentTypes;
    }
    
    // If no content types are explicitly mentioned, default to showing everything
    else {
      Object.keys(contentTypes).forEach(key => contentTypes[key] = true);
      console.log("No specific content types detected, showing all content");
      return contentTypes;
    }
  },
 
 
  processQuery: function(query) {
    // Get all the standard information
    const result = {
      drug: this.extractDrugName(query),
      condition: this.extractCondition(query),
      yearsBack: this.extractYearsBack(query),
      hasResultsOnly: this.detectResultsOnly(query),
      trdFocusOnly: this.detectTRDFocus(query),
      phaseFilter: this.extractPhaseFilter(query)
    };
    
    // Get content type preferences
    const contentTypes = this.detectContentTypes(query);
    
    // Add content type preferences to result
    result.trials = contentTypes.trials;
    result.fda = contentTypes.fda;
    result.ema = contentTypes.ema;
    result.pubmed = contentTypes.pubmed;
    result.publications = contentTypes.publications;
    
    console.log("PROCESSED QUERY:", {
      drug: result.drug,
      condition: result.condition,
      contentTypes: {
        trials: result.trials,
        fda: result.fda,
        ema: result.ema,
        pubmed: result.pubmed
      }
    });
    
    return result;
  },

  // Detect study phase filters
  extractPhaseFilter: function(query) {
    query = query.toLowerCase();
    
    // Check for phase mentions
    if (query.includes('phase 1') || query.includes('phase i') || 
        query.includes('phase one')) {
      return 'phase1';
    } else if (query.includes('phase 2') || query.includes('phase ii') || 
             query.includes('phase two')) {
      return 'phase2';
    } else if (query.includes('phase 3') || query.includes('phase iii') || 
             query.includes('phase three')) {
      return 'phase3';
    } else if (query.includes('phase 4') || query.includes('phase iv') || 
             query.includes('phase four')) {
      return 'phase4';
    }
    
    // Default to all phases
    return 'all';
  },
  
  // Detect if query is asking for only clinical trials
  wantsOnlyTrials: function(query) {
    query = query.toLowerCase();
    
    // Check for phrases indicating only trials
    return (query.includes('only trials') || 
            query.includes('just trials') ||
            query.includes('clinical trials only') ||
            query.includes('just show trials') ||
            query.includes('just the trials')) &&
           (!query.includes('pubmed') && !query.includes('fda') && 
            !query.includes('publication') && !query.includes('literature'));
  },
  
  // Detect if query is asking for only publications
  wantsOnlyPublications: function(query) {
    query = query.toLowerCase();
    
    // Check for phrases indicating only publications
    return (query.includes('only publications') || 
            query.includes('just publications') ||
            query.includes('pubmed only') ||
            query.includes('only literature') ||
            query.includes('just show publications') ||
            query.includes('only show literature')) &&
           (!query.includes('clinical trials') && !query.includes('studies'));
  },
  
  // Detect if query is asking for only FDA data
  wantsOnlyFDAData: function(query) {
    query = query.toLowerCase();
    
    // Check for phrases indicating only FDA data
    return (query.includes('only fda') || 
            query.includes('just fda') ||
            query.includes('fda data only') ||
            query.includes('regulatory only') ||
            query.includes('just show fda') ||
            query.includes('only show regulatory'));
  },
  
 
};

window.NLPProcessor = NLPProcessor;
// Example usage:
/*
// The following examples show how the system would handle various search queries:

// Example 1: Known drug for known condition
const query1 = "Find ketamine trials for treatment-resistant depression from the last 5 years";
const results1 = NLPProcessor.processQuery(query1);
// Should extract: drug: "ketamine", condition: "Treatment Resistant Depression", yearsBack: 5, trdFocusOnly: true

// Example 2: Unknown drug (not in predefined list)
const query2 = "Show me studies testing LCX-19 for major depressive disorder";
const results2 = NLPProcessor.processQuery(query2);
// Should extract: drug: "lcx-19", condition: "Major Depressive Disorder"

// Example 3: Unknown condition (not in predefined list)
const query3 = "Find trials treating narcolepsy using modafinil";
const results3 = NLPProcessor.processQuery(query3);
// Should extract: drug: "modafinil", condition: "Narcolepsy"

// Example 4: Complex query with specific requirements
const query4 = "Show only phase 3 studies with results for any drug treating fibromyalgia from the last 3 years";
const results4 = NLPProcessor.processQuery(query4);
// Should extract: condition: "Fibromyalgia", yearsBack: 3, hasResultsOnly: true, phaseFilter: "phase3"

// Example 5: Very specific data request
const query5 = "I only want to see FDA data for the drug escitalopram";
const results5 = NLPProcessor.processQuery(query5);
// Should extract: drug: "escitalopram", onlyFDAData: true
*/


// Function to handle URL parameters on page load
function handleUrlParams() {
    // Parse URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const drugParam = urlParams.get('drug');
    const conditionParam = urlParams.get('condition');
    const hasResultsParam = urlParams.get('hasResults');
    const trdFocusParam = urlParams.get('trdFocus');
    
    // Check if we have any search parameters to process
    if (drugParam || conditionParam) {
        console.log('URL parameters detected:', { 
            drug: drugParam, 
            condition: conditionParam,
            hasResults: hasResultsParam,
            trdFocus: trdFocusParam
        });
        
        // Set form values based on URL parameters
        if (drugParam) {
            elements.drugSearch.value = drugParam;
        }
        
        if (conditionParam) {
            elements.conditionSearch.value = conditionParam;
        }
        // Trigger the search
        handleSearch();
    }
}

// Add event listener for DOMContentLoaded to handle URL parameters
document.addEventListener('DOMContentLoaded', () => {
    handleUrlParams();
});


// Function to analyze and display overall drug success rates
// Improved display function with error handling
function displayDrugSuccessRates() {
    console.log("Analyzing overall drug success rates...");
    
    try {
        // Only show if we have data
        if (appState.allTrialOutcomes.length === 0) {
            console.warn("No trial outcome data available for drug success visualization");
            return;
        }
        
        // Make sure the section is visible
        showSection(elements.drugSuccessSection, true);
        
        // Ensure chart canvases exist
        ensureDrugSuccessChartCanvasesExist();
        
        // Compute drug-specific data
        const drugData = analyzeDrugSuccessData();
        
        if (drugData.length === 0) {
            console.warn("No processed drug data available for visualization");
            elements.drugSuccessSection.querySelector('.bg-white').innerHTML = `
                <div class="text-center py-8">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                    </svg>
                    <p class="text-lg text-gray-600">Insufficient outcome data for drug success visualization</p>
                    <p class="mt-2 text-sm text-gray-500">Try searching for more studies or including studies without TRD focus</p>
                </div>
            `;
            return;
        }
        
        // Create visualizations
        createOverallDrugSuccessChart(drugData);
        createResponseRateChart(drugData);
        createRemissionRateChart(drugData);
        createDrugSuccessSummaryTable(drugData);
        
        // Create additional visualizations
        createCombinedMeasuresChart();
        createTreatmentOutcomeCurve();
        
    } catch (error) {
        console.error("Error in displayDrugSuccessRates:", error);
        
        // Add error message to drug success section
        if (elements.drugSuccessSection) {
            elements.drugSuccessSection.querySelector('.bg-white').innerHTML += `
                <div class="bg-red-50 text-red-700 p-4 rounded-lg mt-4">
                    <p>Error analyzing drug success rates: ${error.message}</p>
                    <p class="text-sm mt-2">This is likely due to an issue with the outcome data format.</p>
                </div>
            `;
        }
    }
}

// Function to ensure drug success chart canvases exist
function ensureDrugSuccessChartCanvasesExist() {
    // Get the drug success section
    const section = document.getElementById('drugSuccessSection');
    if (!section) {
        console.error("Drug success section not found");
        return;
    }
    
    // Define the chart canvases we need to check/create
    const chartCanvases = [
        { id: 'overallDrugSuccessChart', containerSelector: '.h-72' },
        { id: 'responseRateChart', containerSelector: '.h-64:nth-of-type(1)' },
        { id: 'remissionRateChart', containerSelector: '.h-64:nth-of-type(2)' }
    ];
    
    // Check each canvas
    chartCanvases.forEach(({ id, containerSelector }) => {
        // First check if the canvas already exists
        if (!document.getElementById(id)) {
            console.log(`Canvas ${id} not found, attempting to create`);
            
            // Find the container using the selector within the drug success section
            const containers = section.querySelectorAll(containerSelector);
            let container = null;
            
            if (containers && containers.length > 0) {
                // Use the first matching container
                container = containers[0];
            }
            
            // If we found a container, create the canvas inside it
            if (container) {
                container.innerHTML = `<canvas id="${id}"></canvas>`;
                console.log(`Created canvas: ${id}`);
            } else {
                console.error(`Container not found for ${id} using selector ${containerSelector}`);
                
                // Alternative approach: find container based on nearby heading text
                const headings = section.querySelectorAll('h3');
                for (let i = 0; i < headings.length; i++) {
                    const heading = headings[i];
                    
                    // Determine which heading might correspond to which chart
                    let targetId = null;
                    if (heading.textContent.includes("Treatment Effect") || 
                        heading.textContent.includes("Efficacy")) {
                        targetId = 'overallDrugSuccessChart';
                    } else if (heading.textContent.includes("Response Rate")) {
                        targetId = 'responseRateChart';
                    } else if (heading.textContent.includes("Remission Rate")) {
                        targetId = 'remissionRateChart';
                    }
                    
                    // If this heading matches our target and it's followed by a container
                    if (targetId === id && heading.nextElementSibling) {
                        const possibleContainer = heading.nextElementSibling;
                        possibleContainer.innerHTML = `<canvas id="${id}"></canvas>`;
                        console.log(`Created canvas ${id} in container after heading: ${heading.textContent}`);
                        break;
                    }
                }
            }
        }
    });
}

function updateNavigationBar() {
    const navbar = document.querySelector('.fixed.bottom-4');
    if (!navbar) return;
    
    // Check if we already have the drug success button
    if (!document.getElementById('nav-drug-success')) {
        const newButton = document.createElement('button');
        newButton.id = 'nav-drug-success';
        newButton.className = 'text-primary hover:text-blue-700 text-sm font-medium';
        newButton.textContent = 'Success Rates';

        const emaButton = document.createElement('button');
    emaButton.id = 'nav-ema';
    emaButton.className = 'text-primary hover:text-blue-700 text-sm font-medium';
    emaButton.textContent = 'EMA Data';

    if (fdaButton) {
        navDiv.insertBefore(emaButton, fdaButton);
    } else {
        navDiv.appendChild(emaButton);
    }
        
        // Insert before the FDA data button
        const fdaButton = document.getElementById('nav-fda');
        if (fdaButton) {
            navbar.querySelector('div').insertBefore(newButton, fdaButton);
        } else {
            navbar.querySelector('div').appendChild(newButton);
        }
        
        // Add event listener
        newButton.addEventListener('click', () => {
            elements.drugSuccessSection.scrollIntoView({ behavior: 'smooth' });
        });

        emaButton.addEventListener('click', () => {
        elements.emaDataSection.scrollIntoView({ behavior: 'smooth' });
    });
    }
}

// Function to extract drug names from intervention data
function extractDrugName(studyTitle, measurements) {
    // Try to identify the drug from group titles first
    const experimentalGroups = measurements.filter(m => !m.isControlGroup);
    if (experimentalGroups.length > 0) {
        // Extract drug name from experimental group title
        const groupTitle = experimentalGroups[0].groupTitle.toLowerCase();
        
        // Look for common drug names
        const drugPatterns = [
            { pattern: /ketamine/i, name: "Ketamine" },
            { pattern: /esketamine/i, name: "Esketamine" },
            { pattern: /pcn-101/i, name: "PCN-101" },
            { pattern: /mij821/i, name: "MIJ821" },
            { pattern: /comp360/i, name: "COMP360" },
            { pattern: /psilocybin/i, name: "Psilocybin" },
            { pattern: /brexpiprazole/i, name: "Brexpiprazole" },
            { pattern: /quetiapine/i, name: "Quetiapine" }
        ];
        
        for (const { pattern, name } of drugPatterns) {
            if (pattern.test(groupTitle)) {
                return name;
            }
        }
    }
    
    // If not found in group titles, try to extract from study title
    const studyTitleLower = studyTitle.toLowerCase();
    for (const drugName of ["Ketamine", "Esketamine", "PCN-101", "MIJ821", "COMP360", "Psilocybin", "Brexpiprazole", "Quetiapine"]) {
        if (studyTitleLower.includes(drugName.toLowerCase())) {
            return drugName;
        }
    }
    
    // Default fallback
    return "Unknown";
}

// Function to analyze outcome data and calculate success metrics
function analyzeDrugSuccessData() {
    const drugData = {};
    
    // First group data by drug
    appState.allTrialOutcomes.forEach(study => {
        // Skip studies without outcomes
        if (!study.outcomes || study.outcomes.length === 0) return;
        
        // Process each outcome
        study.outcomes.forEach(outcome => {
            // Skip outcomes without measurement data
            if (!outcome.measurements || outcome.measurements.length === 0) return;
            
            // Extract drug name
            const drugName = extractDrugName(study.title, outcome.measurements);
            
            // Initialize drug data if needed
            if (!drugData[drugName]) {
                drugData[drugName] = {
                    name: drugName,
                    trials: new Set(),
                    totalPatients: 0,
                    effectSizes: [],
                    experimentalValues: [],
                    controlValues: [],
                    responseRates: [],
                    remissionRates: [],
                    outcomeMeasures: new Set()
                };
            }
            
            // Add this trial to the set
            drugData[drugName].trials.add(study.nctId);
            
            // Track outcome measure
            drugData[drugName].outcomeMeasures.add(outcome.title);
            
            // Add effect size if available
            if (outcome.effectSize !== null) {
                drugData[drugName].effectSizes.push(outcome.effectSize);
            }
            
            // Add experimental and control values
            if (outcome.experimentalValue !== null) {
                drugData[drugName].experimentalValues.push(outcome.experimentalValue);
                drugData[drugName].totalPatients += outcome.experimentalSampleSize || 0;
            }
            
            if (outcome.controlValue !== null) {
                drugData[drugName].controlValues.push(outcome.controlValue);
            }
            
            // Check for response and remission rates
            const titleLower = outcome.title.toLowerCase();
            const isResponseOutcome = titleLower.includes(">= 50% improvement") || 
                                     titleLower.includes("responders") || 
                                     titleLower.includes("response rate");
                                     
            const isRemissionOutcome = titleLower.includes("<= 10") || 
                                      titleLower.includes("remission") ||
                                      (titleLower.includes("madrs") && titleLower.includes("<=") && titleLower.includes("7"));
            
            // Extract the rates from measurements
            if (isResponseOutcome || isRemissionOutcome) {
                const experimentalMeasurements = outcome.measurements.filter(m => !m.isControlGroup);
                const controlMeasurements = outcome.measurements.filter(m => m.isControlGroup);
                
                if (experimentalMeasurements.length > 0) {
                    // For response/remission, measurements are usually percentages
                    const experimentalRate = experimentalMeasurements.reduce((sum, m) => sum + m.value, 0) / experimentalMeasurements.length;
                    
                    if (isResponseOutcome) {
                        drugData[drugName].responseRates.push(experimentalRate);
                    }
                    
                    if (isRemissionOutcome) {
                        drugData[drugName].remissionRates.push(experimentalRate);
                    }
                }
            }
        });
    });
    
    // Convert to array and calculate averages
    const result = Object.values(drugData).map(drug => {
        return {
            name: drug.name,
            trialCount: drug.trials.size,
            totalPatients: drug.totalPatients,
            avgEffectSize: drug.effectSizes.length > 0 ? calculateMean(drug.effectSizes) : null,
            stdDevEffectSize: drug.effectSizes.length > 0 ? calculateStandardDeviation(drug.effectSizes) : null,
            avgResponseRate: drug.responseRates.length > 0 ? calculateMean(drug.responseRates) : null,
            avgRemissionRate: drug.remissionRates.length > 0 ? calculateMean(drug.remissionRates) : null,
            outcomeMeasures: Array.from(drug.outcomeMeasures)
        };
    }).filter(drug => drug.trialCount > 0 && (drug.avgEffectSize !== null || drug.avgResponseRate !== null));
    
    // Sort by number of trials (descending)
    result.sort((a, b) => b.trialCount - a.trialCount);
    
    console.log("Analyzed drug success data:", result);
    
    return result;
}

// Function to create the overall drug success chart
function createOverallDrugSuccessChart(drugData) {
    const canvasId = 'overallDrugSuccessChart';
    const canvas = document.getElementById(canvasId);
    
    if (!canvas) {
        console.error(`Canvas not found: ${canvasId}`);
        return;
    }
    
    // Clear previous chart
    if (charts.overallDrugSuccess) {
        charts.overallDrugSuccess.destroy();
    }
    
    // Filter data to drugs with effect sizes
    const drugsWithEffectSizes = drugData.filter(drug => drug.avgEffectSize !== null);
    
    if (drugsWithEffectSizes.length === 0) {
        canvas.parentElement.innerHTML = '<p class="text-center text-gray-500 py-8">No effect size data available for comparison.</p>';
        return;
    }
    
    const ctx = canvas.getContext('2d');
    
    // Create bar chart for drug comparison
    charts.overallDrugSuccess = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: drugsWithEffectSizes.map(drug => drug.name),
            datasets: [{
                label: 'Average Effect Size',
                data: drugsWithEffectSizes.map(drug => drug.avgEffectSize),
                backgroundColor: drugsWithEffectSizes.map((_, i) => getColorByIndex(i, 0.7)),
                borderColor: drugsWithEffectSizes.map((_, i) => getColorByIndex(i)),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y', // Horizontal bar chart
            scales: {
                x: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Effect Size (standardized)'
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Drug'
                    },
                    grid: {
                        display: false
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            return context[0].label;
                        },
                        label: function(context) {
                            const index = context.dataIndex;
                            const drug = drugsWithEffectSizes[index];
                            return [
                                `Effect Size: ${drug.avgEffectSize.toFixed(2)}`,
                                `Trials: ${drug.trialCount}`,
                                `Patients: ${drug.totalPatients}`
                            ];
                        }
                    }
                }
            }
        }
    });
}

// Function to create the response rate chart
function createResponseRateChart(drugData) {
    const canvasId = 'responseRateChart';
    const canvas = document.getElementById(canvasId);
    
    if (!canvas) {
        console.error(`Canvas not found: ${canvasId}`);
        return;
    }
    
    // Clear previous chart
    if (charts.responseRate) {
        charts.responseRate.destroy();
    }
    
    // Filter data to drugs with response rates
    const drugsWithResponseRates = drugData.filter(drug => drug.avgResponseRate !== null);
    
    if (drugsWithResponseRates.length === 0) {
        canvas.parentElement.innerHTML = '<p class="text-center text-gray-500 py-8">No response rate data available.</p>';
        return;
    }
    
    const ctx = canvas.getContext('2d');
    
    // Create pie chart for response rates
    charts.responseRate = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: drugsWithResponseRates.map(drug => drug.name),
            datasets: [{
                data: drugsWithResponseRates.map(drug => drug.avgResponseRate),
                backgroundColor: drugsWithResponseRates.map((_, i) => getColorByIndex(i, 0.7)),
                borderColor: drugsWithResponseRates.map((_, i) => getColorByIndex(i)),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        boxWidth: 12
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const index = context.dataIndex;
                            const drug = drugsWithResponseRates[index];
                            return [
                                `${drug.name}: ${drug.avgResponseRate.toFixed(1)}%`,
                                `Trials: ${drug.trialCount}`
                            ];
                        }
                    }
                }
            }
        }
    });
}

// Function to create the remission rate chart
function createRemissionRateChart(drugData) {
    const canvasId = 'remissionRateChart';
    const canvas = document.getElementById(canvasId);
    
    if (!canvas) {
        console.error(`Canvas not found: ${canvasId}`);
        return;
    }
    
    // Clear previous chart
    if (charts.remissionRate) {
        charts.remissionRate.destroy();
    }
    
    // Filter data to drugs with remission rates
    const drugsWithRemissionRates = drugData.filter(drug => drug.avgRemissionRate !== null);
    
    if (drugsWithRemissionRates.length === 0) {
        canvas.parentElement.innerHTML = '<p class="text-center text-gray-500 py-8">No remission rate data available.</p>';
        return;
    }
    
    const ctx = canvas.getContext('2d');
    
    // Create pie chart for remission rates
    charts.remissionRate = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: drugsWithRemissionRates.map(drug => drug.name),
            datasets: [{
                data: drugsWithRemissionRates.map(drug => drug.avgRemissionRate),
                backgroundColor: drugsWithRemissionRates.map((_, i) => getColorByIndex(i, 0.7)),
                borderColor: drugsWithRemissionRates.map((_, i) => getColorByIndex(i)),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        boxWidth: 12
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const index = context.dataIndex;
                            const drug = drugsWithRemissionRates[index];
                            return [
                                `${drug.name}: ${drug.avgRemissionRate.toFixed(1)}%`,
                                `Trials: ${drug.trialCount}`
                            ];
                        }
                    }
                }
            }
        }
    });
}

// Function to create the drug success summary table
function createDrugSuccessSummaryTable(drugData) {
    const table = elements.drugSuccessSummaryTable;
    if (!table) {
        console.error("Drug success summary table element not found");
        return;
    }
    
    table.innerHTML = '';
    
    if (drugData.length === 0) {
        table.innerHTML = '<tr><td colspan="6" class="py-4 text-center text-gray-500">No drug data available for summary.</td></tr>';
        return;
    }
    
    // Create a row for each drug
    drugData.forEach(drug => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td class="py-2 px-4 border-b">${drug.name}</td>
            <td class="py-2 px-4 border-b">${drug.trialCount}</td>
            <td class="py-2 px-4 border-b">${drug.totalPatients}</td>
            <td class="py-2 px-4 border-b">${drug.avgEffectSize !== null ? drug.avgEffectSize.toFixed(2) : 'N/A'}</td>
            <td class="py-2 px-4 border-b">${drug.avgResponseRate !== null ? drug.avgResponseRate.toFixed(1) + '%' : 'N/A'}</td>
            <td class="py-2 px-4 border-b">${drug.avgRemissionRate !== null ? drug.avgRemissionRate.toFixed(1) + '%' : 'N/A'}</td>
        `;
        table.appendChild(row);
    });
}

// Helper function to get a color by index
function getColorByIndex(index, alpha = 1) {
    const colors = [
        `rgba(59, 130, 246, ${alpha})`,   // blue
        `rgba(16, 185, 129, ${alpha})`,   // emerald
        `rgba(139, 92, 246, ${alpha})`,   // violet
        `rgba(249, 115, 22, ${alpha})`,   // orange
        `rgba(236, 72, 153, ${alpha})`,   // pink
        `rgba(14, 165, 233, ${alpha})`,   // sky
        `rgba(168, 85, 247, ${alpha})`,   // purple
        `rgba(234, 88, 12, ${alpha})`,    // amber
        `rgba(22, 163, 74, ${alpha})`,    // green
        `rgba(79, 70, 229, ${alpha})`     // indigo
    ];
    
    return colors[index % colors.length];
}
        // Helper functions
        function displayLoading(show) {
            elements.loadingState.classList.toggle('hidden', !show);
            elements.placeholderMessage.classList.toggle('hidden', show);
        }

        function showSection(section, show = true) {
            section.classList.toggle('hidden', !show);
        }

        function formatPhase(phase) {
            if (!phase) return 'N/A';
            return phase
                .replace('PHASE', 'Phase ')
                .replace('PRE_', 'Pre-')
                .replace('_', '/');
        }

        function getPhaseColor(phase) {
            const colors = {
                'PRE_PHASE': '#9ca3af', // gray-400
                'PHASE1': '#60a5fa', // blue-400
                'PHASE2': '#34d399', // emerald-400
                'PHASE3': '#a78bfa', // violet-400
                'PHASE4': '#f97316', // orange-500
                'PHASE1_PHASE2': '#38bdf8' // sky-400
            };
            return colors[phase] || '#9ca3af';
        }

        function getStatusBadge(status) {
            const statusClasses = {
                'COMPLETED': 'bg-green-100 text-green-800',
                'RECRUITING': 'bg-blue-100 text-blue-800',
                'NOT_YET_RECRUITING': 'bg-yellow-100 text-yellow-800',
                'ACTIVE_NOT_RECRUITING': 'bg-indigo-100 text-indigo-800',
                'TERMINATED': 'bg-red-100 text-red-800',
                'WITHDRAWN': 'bg-gray-100 text-gray-800',
                'SUSPENDED': 'bg-orange-100 text-orange-800',
                'ENROLLING_BY_INVITATION': 'bg-purple-100 text-purple-800',
                'AVAILABLE': 'bg-teal-100 text-teal-800',
                'NO_LONGER_AVAILABLE': 'bg-gray-100 text-gray-800',
                'APPROVED_FOR_MARKETING': 'bg-green-100 text-green-800',
                'WITHHELD': 'bg-gray-100 text-gray-800',
                'UNKNOWN': 'bg-gray-100 text-gray-800'
            };

            const className = statusClasses[status] || 'bg-gray-100 text-gray-800';
            const label = status.replace(/_/g, ' ').toLowerCase();
            
            return `<span class="px-2 py-1 text-xs font-medium rounded-full ${className} capitalize">${label}</span>`;
        }

        // API functions
        //  async function fetchStudies(drug, condition, hasResults) {
        //     try {
        //         condition = condition || "Treatment Resistant Depression";
                
        //         // Using our backend endpoint
        //         const params = {
        //             condition: condition,
        //             intervention: drug,
        //             hasResults: hasResults,
        //             fields: "protocolSection,resultsSection,hasResults",
        //             pageSize: 100
        //         };
                
        //         console.log("Fetching studies with params:", params);
        //         const response = await axios.get(`${API_BASE_URL}/studies/search`, { 
        //             params,
        //             headers: {
        //                 'Accept': 'application/json',
        //                 'Cache-Control': 'no-cache',
        //                 'Pragma': 'no-cache'
        //             }
        //         });
                
        //         console.log("Studies search response status:", response.status);
        //         let studies = response.data.data.studies || [];
                
        //         return studies;
        //     } catch (error) {
        //         console.error("Error fetching studies:", error);
        //         return [];
        //     }
        // }

        // async function fetchStudyDetails(nctId) {
        //     // Skip if we've already failed to fetch this study
        //     if (appState.failedStudyIds.has(nctId)) {
        //         console.log(`Skipping already failed study ID: ${nctId}`);
        //         return null;
        //     }
            
        //     try {
        //         console.log(`Fetching details for study: ${nctId}`);
        //         const response = await axios.get(`${API_BASE_URL}/studies/${nctId}`, {
        //             params: {
        //                 timestamp: new Date().getTime() // Add timestamp to prevent caching
        //             },
        //             headers: {
        //                 'Accept': 'application/json',
        //                 'Cache-Control': 'no-cache',
        //                 'Pragma': 'no-cache'
        //             }
        //         });
                
        //         console.log(`Study details response status for ${nctId}:`, response.status);
        //         return response.data.data;
        //     } catch (error) {
        //         console.error(`Error fetching details for ${nctId}:`, error);
        //         appState.failedStudyIds.add(nctId); // Track failed requests
        //         return null;
        //     }
        // }





// async function fetchStudies(drug, condition, hasResults, yearsBack = 5) {
//   try {
//     condition = condition || "";
//     const allStudies = [];
//     let pageToken = null;
//     let hasNextPage = true;
    
//     // Calculate the date from yearsBack
//     const today = new Date();
//     const startDate = new Date();
//     startDate.setFullYear(today.getFullYear() - yearsBack);
    
//     // Format date as YYYY-MM-DD for the API (using hyphens, not slashes)
//     const formattedStartDate = `${startDate.getFullYear()}-${String(startDate.getMonth() + 1).padStart(2, '0')}-${String(startDate.getDate()).padStart(2, '0')}`;
    
//     console.log(`Fetching studies from ${formattedStartDate} to present`);
    
//     // Continue fetching until there are no more pages
//     while (hasNextPage) {
//       const params = {
//         condition: condition,
//         intervention: drug,
//         hasResults: hasResults,
//         fields: "protocolSection,resultsSection,hasResults",
//         pageSize: 100, // Keep page size at 100 for efficiency
//         advanced: `AREA[StartDate]RANGE[${formattedStartDate},MAX]` // Filter by start date with correct syntax
//       };
      
//       // Add page token for pagination if we're not on the first page
//       if (pageToken) {
//         params.pageToken = pageToken;
//       }
      
//       console.log(`Fetching studies page with params:`, params);
      
//       const response = await axios.get(`${API_BASE_URL}/studies/search`, {
//         params,
//         headers: {
//           'Accept': 'application/json',
//           'Cache-Control': 'no-cache',
//           'Pragma': 'no-cache'
//         }
//       });
      
//       console.log(`Studies search response status: ${response.status}, page size: ${response.data.data.studies?.length || 0}`);
      
//       const studies = response.data.data.studies || [];
//       allStudies.push(...studies);
      
//       // Get next page token
//       pageToken = response.data.pagination?.nextPageToken;
//       hasNextPage = !!pageToken;
      
//       // Optional: Add delay to avoid rate limiting
//       if (hasNextPage) {
//         await new Promise(resolve => setTimeout(resolve, 300));
//       }
//     }
    
//     console.log(`Total studies fetched: ${allStudies.length}`);
//     return allStudies;
//   } catch (error) {
//     console.error("Error fetching all studies:", error);
//     return [];
//   }
// }



async function fetchStudyDetails(nctId) {
// Skip if we've already failed to fetch this study
if (appState.failedStudyIds.has(nctId)) {
    console.log(`Skipping already failed study ID: ${nctId}`);
    return null;
}

try {
    console.log(`Fetching details for study: ${nctId}`);
    const response = await axios.get(`${API_BASE_URL}/studies/${nctId}`, {
        params: {
            timestamp: new Date().getTime() // Add timestamp to prevent caching
        },
        headers: {
            'Accept': 'application/json',
            'Cache-Control': 'no-cache',
            'Pragma': 'no-cache'
        }
    });
    
    console.log(`Study details response status for ${nctId}:`, response.status);
    return response.data.data;
} catch (error) {
    console.error(`Error fetching details for ${nctId}:`, error);
    appState.failedStudyIds.add(nctId); // Track failed requests
    return null;
}
}


        // Function to filter studies specific to TRD treatment
        function filterTRDSpecificStudies(studies) {
            if (!appState.trdFocusOnly) return studies;
            
            return studies.filter(study => {
                // Check if the study is specifically about TRD
                const title = study.protocolSection?.identificationModule?.briefTitle?.toLowerCase() || '';
                const officialTitle = study.protocolSection?.identificationModule?.officialTitle?.toLowerCase() || '';
                const briefSummary = study.protocolSection?.descriptionModule?.briefSummary?.toLowerCase() || '';
                const detailedDescription = study.protocolSection?.descriptionModule?.detailedDescription?.toLowerCase() || '';
                
                // Check for TRD-specific terms
                const trdTerms = [
                    'treatment-resistant depression', 
                    'treatment resistant depression',
                    'trd',
                    'refractory depression',
                    'treatment-refractory depression'
                ];
                
                // Check if any TRD terms are in the study's text
                return trdTerms.some(term => 
                    title.includes(term) || 
                    officialTitle.includes(term) || 
                    briefSummary.includes(term) || 
                    detailedDescription.includes(term)
                );
            });
        }

        // // Function to generate bell curve data
        // function generateNormalDistribution(mean, stdDev, points = 100) {
        //     if (isNaN(mean) || isNaN(stdDev) || stdDev <= 0) {
        //         console.warn("Invalid parameters for normal distribution:", { mean, stdDev });
        //         return [];
        //     }
            
        //     const data = [];
        //     const min = mean - 3 * stdDev;
        //     const max = mean + 3 * stdDev;
        //     const step = (max - min) / points;
            
        //     for (let x = min; x <= max; x += step) {
        //         const y = (1 / (stdDev * Math.sqrt(2 * Math.PI))) * 
        //                   Math.exp(-Math.pow(x - mean, 2) / (2 * Math.pow(stdDev, 2)));
        //         data.push({ x, y });
        //     }
            
        //     return data;
        // }

// Helper function to generate normal distribution data points
function generateNormalDistribution(mean, stdDev, points = 100) {
    if (isNaN(mean) || isNaN(stdDev) || stdDev <= 0) {
        console.warn("Invalid parameters for normal distribution:", { mean, stdDev });
        return Array(points).fill({x: 0, y: 0});
    }
    
    const data = [];
    const min = mean - 3 * stdDev;
    const max = mean + 3 * stdDev;
    const step = (max - min) / points;
    
    for (let x = min; x <= max; x += step) {
        const y = (1 / (stdDev * Math.sqrt(2 * Math.PI))) * 
                  Math.exp(-Math.pow(x - mean, 2) / (2 * Math.pow(stdDev, 2)));
        data.push({x, y});
    }
    
    return data;
}

// Helper function to update interpretation for distribution chart
function updateInterpretation(container, outcome, distributionData, pValueInfo) {
    // Determine if lower or higher values are better based on outcome title
    const lowerIsBetter = isLowerValueBetter(outcome.title);
    
    // Prepare interpretation message
    let interpretation = `<p class="font-semibold">Distribution Analysis:</p>
                         <p>${outcome.title}</p>
                         <p class="text-xs text-gray-500 mt-1">${outcome.description || ''}</p>`;
    
    // Add group summaries
    interpretation += `<p class="font-semibold mt-2">Group Comparisons:</p>
                      <ul class="list-disc ml-4">`;
    
    distributionData.forEach(data => {
        interpretation += `<li>${data.group}: Mean = ${data.mean.toFixed(2)}, SD = ${data.stdDev.toFixed(2)}</li>`;
    });
    
    interpretation += `</ul>`;
    
    // Add statistical significance if available
    if (pValueInfo) {
        interpretation += pValueInfo;
    }
    
// Find experimental and control groups
if (distributionData.length > 1) {
    // Find experimental and control groups
    let experimentalGroup, controlGroup;
    
    // Try to identify control/placebo group
    for (let i = 0; i < distributionData.length; i++) {
        const groupName = distributionData[i].group.toLowerCase();
        if (groupName.includes('placebo') || groupName.includes('control')) {
            controlGroup = distributionData[i];
        } else if (groupName.includes('experimental') || 
                 groupName.includes('treatment') || 
                 groupName.includes('intervention')) {
            experimentalGroup = distributionData[i];
        }
    }
    
    // If we couldn't clearly identify, assume first is control, second is experimental
    if (!controlGroup && distributionData.length >= 2) {
        controlGroup = distributionData[0];
        experimentalGroup = distributionData[1];
    }
    
    // If we have both groups, add comparison
    if (controlGroup && experimentalGroup) {
        const diff = experimentalGroup.mean - controlGroup.mean;
        const diffPercent = (diff / Math.abs(controlGroup.mean)) * 100;
        
        const betterWorse = lowerIsBetter ? 
            (diff < 0 ? 'better' : 'worse') : 
            (diff > 0 ? 'better' : 'worse');
        
        interpretation += `<p class="font-semibold mt-2">Clinical Interpretation:</p>
                         <p>The experimental group showed a ${Math.abs(diffPercent).toFixed(1)}% ${betterWorse} outcome compared to control.</p>`;
    }
}

container.innerHTML = interpretation;
}

// Helper function to update interpretation for categorical chart
function updateCategoricalInterpretation(container, outcome, groups, categories, groupValues) {
// Prepare interpretation message
let interpretation = `<p class="font-semibold">Categorical Analysis:</p>
                     <p>${outcome.title}</p>
                     <p class="text-xs text-gray-500 mt-1">${outcome.description || ''}</p>`;

// Add group comparisons
interpretation += `<p class="font-semibold mt-2">Category Values:</p>
                  <table class="border-collapse w-full text-sm">
                    <thead>
                      <tr>
                        <th class="border px-2 py-1">Category</th>
                        ${groups.map(g => `<th class="border px-2 py-1">${g.title}</th>`).join('')}
                      </tr>
                    </thead>
                    <tbody>`;

categories.forEach(cat => {
    interpretation += `<tr>
                       <td class="border px-2 py-1">${cat}</td>
                       ${groups.map(g => `<td class="border px-2 py-1">${groupValues[g.id][cat]?.toFixed(2) || 'N/A'}</td>`).join('')}
                     </tr>`;
});

interpretation += `</tbody></table>`;

// Add statistical significance if available
if (outcome.analyses && outcome.analyses.length > 0) {
    const analysis = outcome.analyses[0];
    if (analysis.pValue) {
        interpretation += `<p class="font-semibold mt-2">Statistical Analysis:</p>
                       <p>p-value: ${analysis.pValue}</p>`;
        
        if (analysis.statisticalMethod) {
            interpretation += `<p>Method: ${analysis.statisticalMethod}</p>`;
        }
        
        if (analysis.ciLowerLimit && analysis.ciUpperLimit) {
            interpretation += `<p>${analysis.ciPctValue || 95}% CI: [${analysis.ciLowerLimit}, ${analysis.ciUpperLimit}]</p>`;
        }
    }
}

container.innerHTML = interpretation;
}

// Helper function to update interpretation for time series chart
function updateTimeSeriesInterpretation(container, outcome, groups, timePoints, groupValues) {
// Determine if lower or higher values are better based on outcome title
const lowerIsBetter = isLowerValueBetter(outcome.title);

// Prepare interpretation message
let interpretation = `<p class="font-semibold">Time Series Analysis:</p>
                     <p>${outcome.title}</p>
                     <p class="text-xs text-gray-500 mt-1">${outcome.description || ''}</p>`;

// Try to identify baseline and final time points
const baselineIndex = timePoints.findIndex(t => 
    t.toLowerCase().includes('baseline') || 
    t.toLowerCase().includes('screening') || 
    t === timePoints[0]
);

const finalIndex = timePoints.length - 1;

// Add change over time analysis if we have baseline and final
if (baselineIndex !== -1 && finalIndex > baselineIndex) {
    const baselineTime = timePoints[baselineIndex];
    const finalTime = timePoints[finalIndex];
    
    interpretation += `<p class="font-semibold mt-2">Change from ${baselineTime} to ${finalTime}:</p>
                      <ul class="list-disc ml-4">`;
    
    groups.forEach(group => {
        const baseline = groupValues[group.id][baselineTime];
        const final = groupValues[group.id][finalTime];
        
        if (baseline !== undefined && final !== undefined) {
            const change = final - baseline;
            const percentChange = (change / Math.abs(baseline)) * 100;
            
            const direction = change > 0 ? 'increase' : (change < 0 ? 'decrease' : 'no change');
            const betterWorse = lowerIsBetter ?
                (change < 0 ? 'improvement' : (change > 0 ? 'worsening' : 'no change')) :
                (change > 0 ? 'improvement' : (change < 0 ? 'worsening' : 'no change'));
            
            interpretation += `<li>${group.title}: ${Math.abs(percentChange).toFixed(1)}% ${direction} (${betterWorse})</li>`;
        }
    });
    
    interpretation += `</ul>`;
}

// Add statistical significance if available
if (outcome.analyses && outcome.analyses.length > 0) {
    const analysis = outcome.analyses[0];
    if (analysis.pValue) {
        interpretation += `<p class="font-semibold mt-2">Statistical Analysis:</p>
                       <p>p-value: ${analysis.pValue}</p>`;
        
        if (analysis.statisticalMethod) {
            interpretation += `<p>Method: ${analysis.statisticalMethod}</p>`;
        }
    }
}

container.innerHTML = interpretation;
}

// Helper function to determine if lower values are better for outcomes like depression scales
function isLowerValueBetter(title) {
if (!title) return false;

const lowerIsBetterTerms = [
    'depression', 'anxiety', 'stress', 'pain', 'fatigue', 'symptom', 
    'adverse', 'negative', 'score', 'ham-d', 'hamd', 'madrs', 'phq',
    'hamilton', 'montgomery', 'qids', 'beck', 'bdi', 'gad', 'panss'
];

const titleLower = title.toLowerCase();
return lowerIsBetterTerms.some(term => titleLower.includes(term));
}

// Helper function to sanitize long titles for chart display
function sanitizeTitle(title) {
if (!title) return 'Outcome Measure';

// If title is too long, truncate and add ellipsis
return title.length > 60 ? title.substring(0, 57) + '...' : title;
}



        // Statistical utility functions
        function calculateMean(values) {
            if (!values || values.length === 0) return 0;
            return values.reduce((sum, val) => sum + val, 0) / values.length;
        }

        function calculateStandardDeviation(values, mean) {
            if (!values || values.length <= 1) return 0;
            mean = mean || calculateMean(values);
            const variance = values.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / values.length;
            return Math.sqrt(variance);
        }

        function calculateConfidenceInterval(mean, stdDev, n, confidenceLevel = 0.95) {
            if (n <= 1 || stdDev <= 0) return { lower: mean, upper: mean };
            
            // For small sample sizes, use t-distribution
            // Approximate t-value for 95% confidence and various degrees of freedom
            const tValue = n < 30 ? 2.045 : 1.96; // t-value for n-1 degrees of freedom at 95% confidence
            
            const marginOfError = tValue * (stdDev / Math.sqrt(n));
            return {
                lower: mean - marginOfError,
                upper: mean + marginOfError
            };
        }

        function calculatePValue(treatmentMean, controlMean, treatmentStdDev, controlStdDev, treatmentN, controlN) {
            // This is a simplified p-value calculation for demonstration
            // Would need proper t-test or other statistical test implementation for real applications
            if (treatmentN < 2 || controlN < 2) return "N/A";
            
            // Calculate pooled standard deviation
            const pooledVariance = ((treatmentN - 1) * Math.pow(treatmentStdDev, 2) + (controlN - 1) * Math.pow(controlStdDev, 2)) / 
                                (treatmentN + controlN - 2);
            const pooledStdDev = Math.sqrt(pooledVariance);
            
            // Calculate standard error of difference between means
            const standardError = pooledStdDev * Math.sqrt(1/treatmentN + 1/controlN);
            
            // Calculate t-statistic
            const tStat = Math.abs(treatmentMean - controlMean) / standardError;
            
            // Approximate p-value from t-statistic (simplified)
            // In a real implementation, would use t-distribution function
            if (tStat > 2.58) return "< 0.01";
            if (tStat > 1.96) return "< 0.05";
            return "> 0.05";
        }

        // Function to standardize outcome values for comparison
        function standardizeOutcomeValue(value, metric) {
            // For metrics where lower is better (e.g., depression scales), 
            // we invert the value for consistent interpretation
            const lowerIsBetterMetrics = [
                'hamilton depression rating scale',
                'madrs',
                'montgomery-asberg depression rating scale',
                'phq-9',
                'qids',
                'depression'
            ];
            
            if (lowerIsBetterMetrics.some(term => metric.toLowerCase().includes(term))) {
                // For these metrics, lower scores are better, so we invert the direction
                return -value;
            }
            
            return value;
        }

        // Function to extract and collate outcome measures
        function extractOutcomeMeasures(studies) {
            const allOutcomes = [];
            const outcomeMetrics = new Set();
            
            studies.forEach(study => {
                const nctId = study.protocolSection?.identificationModule?.nctId;
                if (!study.hasResults || !appState.studyDetails[nctId]) return;
                
                const studyDetail = appState.studyDetails[nctId];
                const phase = study.protocolSection?.designModule?.phases?.[0] || 'N/A';
                
                // Get outcome measures from the study results
                const outcomes = studyDetail.resultsSection?.outcomeMeasuresModule?.outcomeMeasures || [];
                
                // Process each outcome measure
                outcomes.forEach(outcome => {
                    // Skip outcomes without data
                    if (!outcome.classes || !outcome.classes[0]?.categories) return;
                    
                    // Add to unique metrics
                    outcomeMetrics.add(outcome.title);
                    
                    // Determine if this is a primary or secondary outcome
                    const outcomeType = outcome.type?.toLowerCase() || 'other';
                    
                    // Process each measurement class and category
                    outcome.classes.forEach(cls => {
                        cls.categories.forEach(cat => {
                            // Find experimental and control groups
                            const experimentalMeasurements = [];
                            const controlMeasurements = [];
                            
                            cat.measurements.forEach(measurement => {
                                const value = parseFloat(measurement.value);
                                
                                // Skip invalid measurements
                                if (isNaN(value)) return;
                                
                                // Determine if this is experimental or control group
                                const group = outcome.groups.find(g => g.id === measurement.groupId);
                                if (!group) return;
                                
                                const groupTitle = group.title.toLowerCase();
                                const isControlGroup = 
                                    groupTitle.includes('placebo') || 
                                    groupTitle.includes('control') ||
                                    groupTitle.includes('sham');
                                
                                // Calculate standard error if available
                                let standardError = null;
                                
                                if (measurement.dispersion && measurement.dispersion !== 'null') {
                                    const dispersionValue = parseFloat(measurement.dispersion);
                                    const dispersionType = measurement.dispersionType?.toLowerCase() || '';
                                    
                                    if (!isNaN(dispersionValue)) {
                                        if (dispersionType === 'standard_error') {
                                            standardError = dispersionValue;
                                        } else if (dispersionType === 'standard_deviation') {
                                            // Convert SD to SE if sample size is available
                                            const sampleSize = group.participantsAnalyzedList?.[0]?.count;
                                            if (sampleSize && !isNaN(sampleSize) && sampleSize > 0) {
                                                standardError = dispersionValue / Math.sqrt(sampleSize);
                                            }
                                        }
                                    }
                                }
                                
                                // Prepare measurement data
                                const measurementData = {
                                    value: value,
                                    standardError: standardError,
                                    sampleSize: group.participantsAnalyzedList?.[0]?.count || 0
                                };
                                
                                // Add to appropriate group
                                if (isControlGroup) {
                                    controlMeasurements.push(measurementData);
                                } else {
                                    experimentalMeasurements.push(measurementData);
                                }
                            });
                            
                            // Calculate aggregated measurements
                            if (experimentalMeasurements.length > 0) {
                                // Calculate weighted average for experimental group
                                const expTotal = experimentalMeasurements.reduce((sum, m) => sum + (m.value * m.sampleSize), 0);
                                const expSampleSize = experimentalMeasurements.reduce((sum, m) => sum + m.sampleSize, 0);
                                
                                let controlValue = null;
                                let controlSampleSize = 0;
                                
                                // Calculate weighted average for control group if available
                                if (controlMeasurements.length > 0) {
                                    const ctrlTotal = controlMeasurements.reduce((sum, m) => sum + (m.value * m.sampleSize), 0);
                                    controlSampleSize = controlMeasurements.reduce((sum, m) => sum + m.sampleSize, 0);
                                    
                                    if (controlSampleSize > 0) {
                                        controlValue = ctrlTotal / controlSampleSize;
                                    }
                                }
                                
                                // Calculate standardized outcome value
                                const experimentalValue = expSampleSize > 0 ? expTotal / expSampleSize : null;
                                
                                // Calculate effect size if both experimental and control values exist
                                let effectSize = null;
                                if (experimentalValue !== null && controlValue !== null) {
                                    // Standardize the effect based on outcome metric
                                    effectSize = standardizeOutcomeValue(experimentalValue - controlValue, outcome.title);
                                }
                                
                                // Store the outcome data
                                allOutcomes.push({
                                    nctId: nctId,
                                    title: study.protocolSection?.identificationModule?.briefTitle || 'Untitled Study',
                                    phase: phase,
                                    outcomeType: outcomeType,
                                    outcomeTitle: outcome.title,
                                    category: cat.title,
                                    experimentalValue: experimentalValue,
                                    controlValue: controlValue,
                                    effectSize: effectSize,
                                    experimentalSampleSize: expSampleSize,
                                    controlSampleSize: controlSampleSize,
                                    timeFrame: outcome.timeFrame || 'Not specified'
                                });
                            }
                        });
                    });
                });
            });
            
            // Set the outcome metrics and measures
            appState.collatedOutcomes = allOutcomes;
            appState.outcomeMetrics = Array.from(outcomeMetrics);
            
            // If we have any outcomes, set the default metric
            if (appState.outcomeMetrics.length > 0) {
                appState.currentOutcomeMetric = appState.outcomeMetrics[0];
            }
            
            // Populate the outcome metric selector
            populateOutcomeMetricSelector();
            
            // Display aggregate outcome visualizations
            displayAggregateVisualizations();
            
            // Display collated outcomes visualizations
            displayCollatedOutcomes();
        }
        
        function populateOutcomeMetricSelector() {
    if (!elements.outcomeMetricSelector) {
        elements.outcomeMetricSelector = document.getElementById('outcomeMetricSelector');
        if (!elements.outcomeMetricSelector) {
            console.error('Outcome metric selector not found, cannot populate');
            return;
        }
        
        // Re-add event listener
        elements.outcomeMetricSelector.addEventListener('change', () => {
            appState.currentOutcomeMetric = elements.outcomeMetricSelector.value;
            displayCollatedOutcomes();
        });
    }
    
    elements.outcomeMetricSelector.innerHTML = '';
    
    appState.outcomeMetrics.forEach(metric => {
        const option = document.createElement('option');
        option.value = metric;
        option.textContent = metric;
        elements.outcomeMetricSelector.appendChild(option);
    });
    
    // Set the current metric
    if (appState.currentOutcomeMetric) {
        elements.outcomeMetricSelector.value = appState.currentOutcomeMetric;
    }
}


        function displayResultsSummary(studies) {
            elements.resultsSummary.innerHTML = '';
            
            // Count studies by phase
            const phaseCount = studies.reduce((acc, study) => {
                const phase = study.protocolSection?.designModule?.phases?.[0] || 'N/A';
                acc[phase] = (acc[phase] || 0) + 1;
                return acc;
            }, {});
            
            // Count studies by status
            const statusCount = studies.reduce((acc, study) => {
                const status = study.protocolSection?.statusModule?.overallStatus || 'UNKNOWN';
                acc[status] = (acc[status] || 0) + 1;
                return acc;
            }, {});
            
            // Count studies with results
            const withResults = studies.filter(study => study.hasResults).length;
            
            // Calculate success rate for completed studies with results
            let successRate = "N/A";
            const completedWithResults = studies.filter(study => 
                study.hasResults && 
                study.protocolSection?.statusModule?.overallStatus === "COMPLETED"
            ).length;
            
            if (completedWithResults > 0) {
                // For now, just estimate based on positive outcomes in collated data
                const positiveOutcomes = appState.collatedOutcomes.filter(outcome => outcome.effectSize > 0).length;
                const totalOutcomes = appState.collatedOutcomes.length;
                
                if (totalOutcomes > 0) {
                    successRate = `${Math.round(positiveOutcomes * 100 / totalOutcomes)}%`;
                }
            }
            
            // Create summary cards
            const summaryItems = [
                {
                    title: 'Total Studies',
                    value: studies.length,
                    icon: '<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" /></svg>'
                },
                {
                    title: 'With Results',
                    value: withResults,
                    icon: '<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-secondary" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>'
                },
                {
                    title: 'Study Phases',
                    value: Object.keys(phaseCount).length,
                    icon: '<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-accent" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>'
                }
                // ,
                // {
                //     title: 'Success Rate',
                //     value: successRate,
                //     icon: '<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>'
                // }
            ];
            
            summaryItems.forEach(item => {
                const card = document.createElement('div');
                card.className = 'bg-gray-50 rounded-lg p-4 flex items-center';
                card.innerHTML = `
                    <div class="p-3 rounded-full bg-white shadow-sm mr-4">
                        ${item.icon}
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">${item.title}</p>
                        <p class="text-2xl font-semibold">${item.value}</p>
                    </div>
                `;
                elements.resultsSummary.appendChild(card);
            });
        }

        // function displayStudies(studies) {
        //     elements.studiesList.innerHTML = '';
        //     elements.studyCount.textContent = studies.length;
            
        //     if (studies.length === 0) {
        //         elements.studiesList.innerHTML = `
        //             <div class="text-center p-4 text-gray-500">
        //                 <p>No studies found matching the current filters.</p>
        //             </div>
        //         `;
        //         return;
        //     }
            
        //     // Sort studies by phase
        //     const phaseOrder = { 
        //         "PRE_PHASE": 0, 
        //         "PHASE1": 1, 
        //         "PHASE1_PHASE2": 1.5,
        //         "PHASE2": 2, 
        //         "PHASE3": 3, 
        //         "PHASE4": 4 
        //     };
            
        //     studies.sort((a, b) => {
        //         const phaseA = a.protocolSection?.designModule?.phases?.[0] || "PRE_PHASE";
        //         const phaseB = b.protocolSection?.designModule?.phases?.[0] || "PRE_PHASE";
        //         return (phaseOrder[phaseA] || 0) - (phaseOrder[phaseB] || 0);
        //     });
            
        //     studies.forEach(study => {
        //         const nctId = study.protocolSection?.identificationModule?.nctId;
        //         const title = study.protocolSection?.identificationModule?.briefTitle;
        //         const phase = study.protocolSection?.designModule?.phases?.[0] || "N/A";
        //         const status = study.protocolSection?.statusModule?.overallStatus;
        //         const sponsor = study.protocolSection?.identificationModule?.organization?.fullName;
        //         const hasResults = study.hasResults;
                
        //         // Determine if this is a TRD-specific study
        //         const briefTitle = study.protocolSection?.identificationModule?.briefTitle?.toLowerCase() || '';
        //         const officialTitle = study.protocolSection?.identificationModule?.officialTitle?.toLowerCase() || '';
        //         const briefSummary = study.protocolSection?.descriptionModule?.briefSummary?.toLowerCase() || '';
                
        //         const trdTerms = [
        //             'treatment-resistant depression', 
        //             'treatment resistant depression',
        //             'trd',
        //             'refractory depression'
        //         ];
                
        //         const isTRDSpecific = trdTerms.some(term => 
        //             briefTitle.includes(term) || 
        //             officialTitle.includes(term) || 
        //             briefSummary.includes(term)
        //         );
                
        //         const card = document.createElement('div');
        //         card.className = 'bg-white p-4 rounded-lg border border-gray-200 hover:shadow-md transition duration-200';
        //         card.innerHTML = `
        //             <div class="flex flex-col md:flex-row gap-2 md:items-center md:justify-between mb-3">
        //                 <div class="flex gap-2 items-center flex-wrap">
        //                     <span class="inline-block w-3 h-3 rounded-full" style="background-color: ${getPhaseColor(phase)}"></span>
        //                     <span class="text-sm font-medium">${formatPhase(phase)}</span>
        //                     ${getStatusBadge(status)}
        //                     ${isTRDSpecific ? '<span class="text-xs bg-purple-100 text-purple-800 px-2 py-0.5 rounded-full">TRD-Specific</span>' : ''}
        //                 </div>
        //                 <div>
        //                     <span class="text-xs text-gray-500">${nctId}</span>
        //                     ${hasResults ? '<span class="ml-2 text-xs bg-green-100 text-green-800 px-2 py-0.5 rounded-full">Has Results</span>' : ''}
        //                 </div>
        //             </div>
        //             <h3 class="text-lg font-medium mb-2">${title}</h3>
        //             <p class="text-sm text-gray-600 mb-3">Sponsor: ${sponsor || 'Unknown'}</p>
        //             <button data-nctid="${nctId}" class="view-study-btn text-primary hover:text-blue-700 text-sm font-medium flex items-center">
        //                 <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        //                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
        //                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
        //                 </svg>
        //                 View Study Details
        //             </button>
        //         `;
        //         elements.studiesList.appendChild(card);
                
        //         // Add event listener to the view button
        //         card.querySelector('.view-study-btn').addEventListener('click', () => {
        //             viewStudyDetails(nctId);
        //         });
        //     });
        // }
        function generateDrugUsageTimeline(studies, drugName) {
    // Create container for the timeline
    const timelineContainer = document.createElement('div');
    timelineContainer.className = 'mb-8 p-4 bg-white rounded-lg border border-gray-200 shadow-sm';
    timelineContainer.innerHTML = `
        <h2 class="text-xl font-bold mb-4">Historical Usage Timeline: ${drugName}</h2>
        <div id="usage-timeline" class="relative">
            <div class="timeline-loading text-center p-4">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-gray-200 border-t-blue-500"></div>
                <p class="mt-2 text-gray-600">Analyzing usage patterns...</p>
            </div>
        </div>
    `;

    // Process the data after rendering the initial container
    setTimeout(() => {
        // Extract and organize timeline data
        const usageData = extractUsageData(studies);
        
        if (Object.keys(usageData.byCondition).length === 0) {
            // No meaningful data found
            document.getElementById('usage-timeline').innerHTML = `
                <div class="text-center p-4 text-gray-500">
                    <p>Insufficient data to generate a timeline for ${drugName}.</p>
                </div>
            `;
            return;
        }
        
        // Render the timeline visualization
        renderTimelineVisualization(usageData, drugName);
    }, 100);
    
    return timelineContainer;
}

// function extractUsageData(studies) {
//     // Initialize data structure
//     const result = {
//         earliestStudyYear: null,
//         latestStudyYear: null,
//         byCondition: {},
//         byPhase: {
//             "PRE_PHASE": [],
//             "PHASE1": [],
//             "PHASE1_PHASE2": [],
//             "PHASE2": [],
//             "PHASE3": [],
//             "PHASE4": []
//         },
//         totalStudies: studies.length
//     };
    
//     // Current year for comparison
//     const currentYear = new Date().getFullYear();
    
//     studies.forEach(study => {
//         // Extract key information
//         const startYear = extractYearFromDate(
//             study.protocolSection?.statusModule?.startDateStruct?.date
//         );
        
//         const completionYear = extractYearFromDate(
//             study.protocolSection?.statusModule?.completionDateStruct?.date
//         );
        
//         const primaryCompletionYear = extractYearFromDate(
//             study.protocolSection?.statusModule?.primaryCompletionDateStruct?.date
//         );
        
//         // Use the most appropriate year available
//         const studyYear = startYear || 
//                          (primaryCompletionYear && primaryCompletionYear <= currentYear ? primaryCompletionYear : null) || 
//                          (completionYear && completionYear <= currentYear ? completionYear : null) || 
//                          null;
        
//         if (!studyYear) return; // Skip if no valid year
        
//         // Update earliest/latest years
//         if (result.earliestStudyYear === null || studyYear < result.earliestStudyYear) {
//             result.earliestStudyYear = studyYear;
//         }
        
//         if (result.latestStudyYear === null || studyYear > result.latestStudyYear) {
//             result.latestStudyYear = studyYear;
//         }
        
//         // Extract conditions
//         const conditions = study.protocolSection?.conditionsModule?.conditions || [];
        
//         // If no specific conditions listed, use a placeholder
//         if (conditions.length === 0) {
//             const category = "Unspecified Condition";
            
//             if (!result.byCondition[category]) {
//                 result.byCondition[category] = {
//                     count: 0,
//                     years: {},
//                     earliestYear: null,
//                     latestYear: null
//                 };
//             }
            
//             result.byCondition[category].count++;
//             result.byCondition[category].years[studyYear] = (result.byCondition[category].years[studyYear] || 0) + 1;
            
//             // Update condition-specific earliest/latest years
//             if (result.byCondition[category].earliestYear === null || 
//                 studyYear < result.byCondition[category].earliestYear) {
//                 result.byCondition[category].earliestYear = studyYear;
//             }
            
//             if (result.byCondition[category].latestYear === null || 
//                 studyYear > result.byCondition[category].latestYear) {
//                 result.byCondition[category].latestYear = studyYear;
//             }
//         } else {
//             // Process each condition
//             conditions.forEach(condition => {
//                 // Normalize the condition name - capitalize first letter of each word
//                 const normalizedCondition = condition
//                     .split(' ')
//                     .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
//                     .join(' ');
                
//                 // Initialize condition data if it doesn't exist
//                 if (!result.byCondition[normalizedCondition]) {
//                     result.byCondition[normalizedCondition] = {
//                         count: 0,
//                         years: {},
//                         earliestYear: null,
//                         latestYear: null
//                     };
//                 }
                
//                 // Increment counts
//                 result.byCondition[normalizedCondition].count++;
//                 result.byCondition[normalizedCondition].years[studyYear] = 
//                     (result.byCondition[normalizedCondition].years[studyYear] || 0) + 1;
                
//                 // Update condition-specific earliest/latest years
//                 if (result.byCondition[normalizedCondition].earliestYear === null || 
//                     studyYear < result.byCondition[normalizedCondition].earliestYear) {
//                     result.byCondition[normalizedCondition].earliestYear = studyYear;
//                 }
                
//                 if (result.byCondition[normalizedCondition].latestYear === null || 
//                     studyYear > result.byCondition[normalizedCondition].latestYear) {
//                     result.byCondition[normalizedCondition].latestYear = studyYear;
//                 }
//             });
//         }
        
//         // Track phases
//         const phase = study.protocolSection?.designModule?.phases?.[0] || "PRE_PHASE";
//         if (result.byPhase[phase]) {
//             result.byPhase[phase].push({
//                 nctId: study.protocolSection?.identificationModule?.nctId,
//                 year: studyYear,
//                 conditions: conditions.length > 0 ? conditions : ["Unspecified"]
//             });
//         }
//     });
    
//     // Filter out conditions with very few studies (< 2% of total)
//     const minStudiesThreshold = Math.max(1, Math.ceil(result.totalStudies * 0.02));
    
//     Object.keys(result.byCondition).forEach(condition => {
//         if (result.byCondition[condition].count < minStudiesThreshold) {
//             delete result.byCondition[condition];
//         }
//     });
    
//     // Group similar conditions
//     const groupedConditions = groupSimilarConditions(result.byCondition);
//     if (Object.keys(groupedConditions).length > 0) {
//         result.byCondition = groupedConditions;
//     }
    
//     return result;
// }
// function extractUsageData(studies) {
//     // Initialize data structure
//     const result = {
//         earliestStudyYear: null,
//         latestStudyYear: null,
//         byCondition: {},
//         byPhase: {
//             "PRE_PHASE": [],
//             "PHASE1": [],
//             "PHASE1_PHASE2": [],
//             "PHASE2": [],
//             "PHASE3": [],
//             "PHASE4": []
//         },
//         totalStudies: studies.length
//     };
    
//     // Current year for comparison
//     const currentYear = new Date().getFullYear();
    
//     studies.forEach(study => {
//         // Extract key information
//         const startYear = extractYearFromDate(
//             study.protocolSection?.statusModule?.startDateStruct?.date
//         );
        
//         const completionYear = extractYearFromDate(
//             study.protocolSection?.statusModule?.completionDateStruct?.date
//         );
        
//         const primaryCompletionYear = extractYearFromDate(
//             study.protocolSection?.statusModule?.primaryCompletionDateStruct?.date
//         );
        
//         // Use the most appropriate year available
//         const studyYear = startYear || 
//                          (primaryCompletionYear && primaryCompletionYear <= currentYear ? primaryCompletionYear : null) || 
//                          (completionYear && completionYear <= currentYear ? completionYear : null) || 
//                          null;
        
//         if (!studyYear) return; // Skip if no valid year
        
//         // Update earliest/latest years
//         if (result.earliestStudyYear === null || studyYear < result.earliestStudyYear) {
//             result.earliestStudyYear = studyYear;
//         }
        
//         if (result.latestStudyYear === null || studyYear > result.latestStudyYear) {
//             result.latestStudyYear = studyYear;
//         }
        
//         // Extract conditions
//         const conditions = study.protocolSection?.conditionsModule?.conditions || [];
        
//         // If no specific conditions listed, use a placeholder
//         if (conditions.length === 0) {
//             const category = "Unspecified Condition";
            
//             if (!result.byCondition[category]) {
//                 result.byCondition[category] = {
//                     count: 0,
//                     years: {},
//                     earliestYear: null,
//                     latestYear: null
//                 };
//             }
            
//             result.byCondition[category].count++;
//             result.byCondition[category].years[studyYear] = (result.byCondition[category].years[studyYear] || 0) + 1;
            
//             // Update condition-specific earliest/latest years
//             if (result.byCondition[category].earliestYear === null || 
//                 studyYear < result.byCondition[category].earliestYear) {
//                 result.byCondition[category].earliestYear = studyYear;
//             }
            
//             if (result.byCondition[category].latestYear === null || 
//                 studyYear > result.byCondition[category].latestYear) {
//                 result.byCondition[category].latestYear = studyYear;
//             }
//         } else {
//             // Process each condition
//             conditions.forEach(condition => {
//                 // Keep the exact condition name as provided, only first letter capitalized for consistency
//                 const normalizedCondition = condition.charAt(0).toUpperCase() + condition.slice(1);
                
//                 // Initialize condition data if it doesn't exist
//                 if (!result.byCondition[normalizedCondition]) {
//                     result.byCondition[normalizedCondition] = {
//                         count: 0,
//                         years: {},
//                         earliestYear: null,
//                         latestYear: null
//                     };
//                 }
                
//                 // Increment counts
//                 result.byCondition[normalizedCondition].count++;
//                 result.byCondition[normalizedCondition].years[studyYear] = 
//                     (result.byCondition[normalizedCondition].years[studyYear] || 0) + 1;
                
//                 // Update condition-specific earliest/latest years
//                 if (result.byCondition[normalizedCondition].earliestYear === null || 
//                     studyYear < result.byCondition[normalizedCondition].earliestYear) {
//                     result.byCondition[normalizedCondition].earliestYear = studyYear;
//                 }
                
//                 if (result.byCondition[normalizedCondition].latestYear === null || 
//                     studyYear > result.byCondition[normalizedCondition].latestYear) {
//                     result.byCondition[normalizedCondition].latestYear = studyYear;
//                 }
//             });
//         }
        
//         // Track phases
//         const phase = study.protocolSection?.designModule?.phases?.[0] || "PRE_PHASE";
//         if (result.byPhase[phase]) {
//             result.byPhase[phase].push({
//                 nctId: study.protocolSection?.identificationModule?.nctId,
//                 year: studyYear,
//                 conditions: conditions.length > 0 ? conditions : ["Unspecified"]
//             });
//         }
//     });
    
//     // We'll keep all conditions regardless of frequency to show complete data
//     // But we can sort by count to display the most studied conditions prominently
    
//     return result;
// }

function extractUsageData(studies, drugName) {
    const result = {
        earliestStudyYear: null,
        latestStudyYear: null,
        byCondition: {},
        byPhase: {
            "PRE_PHASE": [],
            "PHASE1": [],
            "PHASE1_PHASE2": [],
            "PHASE2": [],
            "PHASE3": [],
            "PHASE4": []
        },
        totalStudies: studies.length,
        entityType: 'drug',
        entityName: drugName,
        outcomes: { // New field to track trial outcomes
            completed: [],
            terminated: [],
            withdrawn: [],
            unknown: []
        }
    };

    const currentYear = new Date().getFullYear();

    studies.forEach(study => {
        const startYear = extractYearFromDate(study.protocolSection?.statusModule?.startDateStruct?.date);
        const completionYear = extractYearFromDate(study.protocolSection?.statusModule?.completionDateStruct?.date);
        const primaryCompletionYear = extractYearFromDate(study.protocolSection?.statusModule?.primaryCompletionDateStruct?.date);
        const studyYear = startYear || 
                         (primaryCompletionYear && primaryCompletionYear <= currentYear ? primaryCompletionYear : null) || 
                         (completionYear && completionYear <= currentYear ? completionYear : null) || 
                         null;

        if (!studyYear) return;

        // Update earliest/latest years
        if (result.earliestStudyYear === null || studyYear < result.earliestStudyYear) {
            result.earliestStudyYear = studyYear;
        }
        if (result.latestStudyYear === null || studyYear > result.latestStudyYear) {
            result.latestStudyYear = studyYear;
        }

        // Extract status
        const status = study.protocolSection?.statusModule?.overallStatus?.toLowerCase() || "unknown";
        const phase = study.protocolSection?.designModule?.phases?.[0] || "PRE_PHASE";
        const nctId = study.protocolSection?.identificationModule?.nctId;
        const conditions = study.protocolSection?.conditionsModule?.conditions || ["Unspecified Condition"];

        // Track outcomes
        if (status.includes("completed")) {
            result.outcomes.completed.push({ nctId, phase, year: studyYear, conditions });
        } else if (status.includes("terminated")) {
            result.outcomes.terminated.push({ nctId, phase, year: studyYear, conditions });
        } else if (status.includes("withdrawn")) {
            result.outcomes.withdrawn.push({ nctId, phase, year: studyYear, conditions });
        } else {
            result.outcomes.unknown.push({ nctId, phase, year: studyYear, conditions });
        }

        // Existing condition and phase tracking (unchanged for brevity)
        conditions.forEach(condition => {
            const normalizedCondition = condition.charAt(0).toUpperCase() + condition.slice(1);
            if (!result.byCondition[normalizedCondition]) {
                result.byCondition[normalizedCondition] = {
                    count: 0,
                    years: {},
                    earliestYear: null,
                    latestYear: null,
                    studies: [],
                    status: {} // New field to track status per condition
                };
            }
            result.byCondition[normalizedCondition].count++;
            result.byCondition[normalizedCondition].years[studyYear] = 
                (result.byCondition[normalizedCondition].years[studyYear] || 0) + 1;
            result.byCondition[normalizedCondition].studies.push({
                id: nctId,
                year: studyYear,
                title: study.protocolSection?.identificationModule?.briefTitle || 'Untitled Study',
                phase,
                status
            });
            result.byCondition[normalizedCondition].status[status] = 
                (result.byCondition[normalizedCondition].status[status] || 0) + 1;

            if (result.byCondition[normalizedCondition].earliestYear === null || 
                studyYear < result.byCondition[normalizedCondition].earliestYear) {
                result.byCondition[normalizedCondition].earliestYear = studyYear;
            }
            if (result.byCondition[normalizedCondition].latestYear === null || 
                studyYear > result.byCondition[normalizedCondition].latestYear) {
                result.byCondition[normalizedCondition].latestYear = studyYear;
            }
        });

        if (result.byPhase[phase]) {
            result.byPhase[phase].push({
                nctId,
                year: studyYear,
                conditions,
                title: study.protocolSection?.identificationModule?.briefTitle || 'Untitled Study',
                status
            });
        }
    });

    return result;
}



function groupSimilarConditions(conditionsData) {
    // // Define condition categories and their keywords
    // const categories = {
    //     "Depression": ["depression", "depressive", "mood disorder"],
    //     "Pain": ["pain", "analgesia", "analgesic"],
    //     "Anesthesia": ["anesthesia", "anaesthesia", "sedation"],
    //     "Anxiety": ["anxiety", "anxious", "panic"],
    //     "Addiction": ["addiction", "substance abuse", "dependence", "substance use disorder"],
    //     "Neurological": ["dementia", "alzheimer", "parkinson", "multiple sclerosis", "epilepsy", "seizure"],
    //     "Psychiatric": ["schizophrenia", "bipolar", "ptsd", "trauma", "ocd"]
    // };
    
    // const result = {};
    // const assignedConditions = new Set();
    
    // // First pass: assign conditions to predefined categories
    // Object.keys(categories).forEach(category => {
    //     const keywords = categories[category];
    //     let totalCount = 0;
    //     let earliestYear = null;
    //     let latestYear = null;
    //     const yearCounts = {};
        
    //     Object.keys(conditionsData).forEach(condition => {
    //         const conditionLower = condition.toLowerCase();
            
    //         if (keywords.some(keyword => conditionLower.includes(keyword))) {
    //             assignedConditions.add(condition);
    //             totalCount += conditionsData[condition].count;
                
    //             // Update years
    //             if (earliestYear === null || conditionsData[condition].earliestYear < earliestYear) {
    //                 earliestYear = conditionsData[condition].earliestYear;
    //             }
                
    //             if (latestYear === null || conditionsData[condition].latestYear > latestYear) {
    //                 latestYear = conditionsData[condition].latestYear;
    //             }
                
    //             // Merge year counts
    //             Object.keys(conditionsData[condition].years).forEach(year => {
    //                 yearCounts[year] = (yearCounts[year] || 0) + conditionsData[condition].years[year];
    //             });
    //         }
    //     });
        
    //     if (totalCount > 0) {
    //         result[category] = {
    //             count: totalCount,
    //             years: yearCounts,
    //             earliestYear: earliestYear,
    //             latestYear: latestYear
    //         };
    //     }
    // });
    
    // // Second pass: add remaining conditions
    // Object.keys(conditionsData).forEach(condition => {
    //     if (!assignedConditions.has(condition)) {
    //         result[condition] = conditionsData[condition];
    //     }
    // });
    // console.log(result)
    
    return conditionsData;
}

// function renderTimelineVisualization(data, drugName) {
//     const timelineElement = document.getElementById('usage-timeline');
    
//     // Create array of conditions sorted by earliest use
//     const sortedConditions = Object.keys(data.byCondition)
//         .map(condition => ({
//             name: condition,
//             ...data.byCondition[condition]
//         }))
//         .sort((a, b) => a.earliestYear - b.earliestYear);
    
//     // Calculate timeline dimensions
//     const startYear = data.earliestStudyYear;
//     const endYear = data.latestStudyYear;
//     const yearSpan = endYear - startYear + 1;
    
//     // Generate the timeline HTML
//     let timelineHTML = `
//         <div class="mb-6">
//             <p class="text-sm text-gray-600">Based on analysis of ${data.totalStudies} clinical trials from ${startYear} to ${endYear}</p>
//         </div>
//         <div class="timeline-chart relative">
//             <!-- Year markers -->
//             <div class="year-markers flex justify-between text-xs text-gray-500 mb-2">
//     `;
    
//     // Add year markers (show at most 10 years to avoid overcrowding)
//     const yearStep = Math.max(1, Math.ceil(yearSpan / 10));
//     for (let year = startYear; year <= endYear; year += yearStep) {
//         const position = ((year - startYear) / yearSpan) * 100;
//         timelineHTML += `<div class="absolute" style="left: ${position}%">${year}</div>`;
//     }
    
//     timelineHTML += `
//             </div>
            
//             <!-- Timeline tracks -->
//             <div class="timeline-tracks space-y-6">
//     `;
    
//     // Generate a track for each condition
//     sortedConditions.forEach((condition, index) => {
//         const startPosition = ((condition.earliestYear - startYear) / yearSpan) * 100;
//         const endPosition = 100 - ((endYear - condition.latestYear) / yearSpan) * 100;
//         const width = endPosition - startPosition;
        
//         // Generate a color based on the condition index
//         const hue = (index * 137.5) % 360; // Golden ratio to distribute colors
//         const color = `hsl(${hue}, 70%, 60%)`;
//         const darkColor = `hsl(${hue}, 70%, 40%)`;
        
//         timelineHTML += `
//             <div class="condition-track">
//                 <div class="flex justify-between items-center mb-1">
//                     <span class="font-medium text-sm">${condition.name}</span>
//                     <span class="text-xs text-gray-500">${condition.count} studies</span>
//                 </div>
//                 <div class="relative h-8 bg-gray-100 rounded-full overflow-hidden">
//                     <div class="absolute h-full rounded-full" style="left: ${startPosition}%; width: ${width}%; background-color: ${color};">
//                         <div class="h-full flex items-center justify-center text-xs font-bold text-white">
//                             ${condition.earliestYear} - ${condition.latestYear}
//                         </div>
//                     </div>
//                 </div>
                
//                 <!-- Activity indicators -->
//                 <div class="relative h-1 mt-1">
//         `;
        
//         // Add activity indicators (small circles indicating study frequency)
//         Object.keys(condition.years).forEach(year => {
//             const yearPosition = ((year - startYear) / yearSpan) * 100;
//             const size = Math.min(12, Math.max(4, condition.years[year] * 2)); // Scale based on study count
            
//             timelineHTML += `
//                 <div class="absolute rounded-full" 
//                      style="left: ${yearPosition}%; top: -${size/4}px; width: ${size}px; height: ${size}px; background-color: ${darkColor};"
//                      title="${year}: ${condition.years[year]} studies">
//                 </div>
//             `;
//         });
        
//         timelineHTML += `
//                 </div>
//             </div>
//         `;
//     });
    
//     timelineHTML += `
//             </div>
//         </div>
        
//         <!-- Evolution of usage patterns -->
//         <div class="mt-8">
//             <h3 class="text-lg font-medium mb-3">Key Evolution Patterns</h3>
//             <div class="evolution-patterns grid grid-cols-1 md:grid-cols-2 gap-4">
//     `;
    
//     // Generate insights based on the data
//     const insights = generateInsights(data, drugName, sortedConditions);
    
//     insights.forEach(insight => {
//         timelineHTML += `
//             <div class="insight-card p-3 bg-gray-50 rounded-lg border border-gray-200">
//                 <div class="flex items-start">
//                     <div class="insight-icon mr-3 text-blue-500">
//                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
//                             <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
//                         </svg>
//                     </div>
//                     <p class="text-sm">${insight}</p>
//                 </div>
//             </div>
//         `;
//     });
    
//     timelineHTML += `
//             </div>
//         </div>
//     `;
    
//     // Update the timeline element
//     timelineElement.innerHTML = timelineHTML;
// }

// function generateInsights(data, drugName, sortedConditions) {
//     const insights = [];
//     const currentYear = new Date().getFullYear();
    
//     // Insight 1: First studied indication
//     if (sortedConditions.length > 0) {
//         const firstCondition = sortedConditions[0];
//         insights.push(
//             `${drugName} was first studied for <strong>${firstCondition.name}</strong> in ${firstCondition.earliestYear}, ${currentYear - firstCondition.earliestYear} years ago.`
//         );
//     }
    
//     // Insight 2: Most studied indication
//     const mostStudiedCondition = sortedConditions.sort((a, b) => b.count - a.count)[0];
//     insights.push(
//         `The most researched application has been <strong>${mostStudiedCondition.name}</strong> with ${mostStudiedCondition.count} studies.`
//     );
    
//     // Insight 3: Recent expansion
//     const recentConditions = sortedConditions
//         .filter(c => c.earliestYear >= currentYear - 10)
//         .sort((a, b) => b.earliestYear - a.earliestYear);
    
//     if (recentConditions.length > 0) {
//         insights.push(
//             `In the past decade, research has expanded to include <strong>${recentConditions.map(c => c.name).join(', ')}</strong>.`
//         );
//     }
    
//     // Insight 4: Phase progression
//     const phaseData = data.byPhase;
//     const latePhaseCount = (phaseData.PHASE3 || []).length + (phaseData.PHASE4 || []).length;
//     const totalPhaseCount = Object.values(phaseData).flat().length;
    
//     if (totalPhaseCount > 0) {
//         const latePhasePercentage = Math.round((latePhaseCount / totalPhaseCount) * 100);
//         insights.push(
//             `${latePhasePercentage}% of studies have reached late-stage (Phase 3-4) clinical trials, indicating ${latePhasePercentage > 30 ? 'significant' : 'ongoing'} progress toward regulatory approval across various conditions.`
//         );
//     }
    
//     // Insight 5: Recent activity
//     const recentYears = currentYear - 5;
//     let recentActivityCount = 0;
    
//     sortedConditions.forEach(condition => {
//         Object.keys(condition.years).forEach(year => {
//             if (parseInt(year) >= recentYears) {
//                 recentActivityCount += condition.years[year];
//             }
//         });
//     });
    
//     if (data.totalStudies > 0) {
//         const recentPercentage = Math.round((recentActivityCount / data.totalStudies) * 100);
//         insights.push(
//             `${recentPercentage}% of all ${drugName} studies have been conducted in the last 5 years, showing ${recentPercentage > 50 ? 'accelerating' : 'continued'} research interest.`
//         );
//     }
    
//     return insights;
// }
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


// function renderTimelineVisualization(data, drugName) {
//     const timelineElement = document.getElementById('usage-timeline');
    
//     // Create array of conditions sorted by number of studies (most studied first)
//     const sortedConditions = Object.keys(data.byCondition)
//         .map(condition => ({
//             name: condition,
//             ...data.byCondition[condition]
//         }))
//         .sort((a, b) => b.count - a.count)
//         // Limit to top 20 conditions to avoid overcrowding
//         .slice(0, 20);
    
//     // Calculate timeline dimensions
//     const startYear = data.earliestStudyYear;
//     const endYear = data.latestStudyYear;
//     const yearSpan = endYear - startYear + 1;
    
//     // Generate the timeline HTML
//     let timelineHTML = `
//         <div class="mb-6">
//             <p class="text-sm text-gray-600">Based on analysis of ${data.totalStudies} clinical trials from ${startYear} to ${endYear}</p>
//             <p class="text-sm text-gray-500 mt-1">Showing top ${sortedConditions.length} conditions out of ${Object.keys(data.byCondition).length} total</p>
//         </div>
//         <div class="timeline-chart relative">
//             <!-- Year markers -->
//             <div class="year-markers flex justify-between text-xs text-gray-500 mb-2">
//     `;
    
//     // Add year markers (show at most 10 years to avoid overcrowding)
//     const yearStep = Math.max(1, Math.ceil(yearSpan / 10));
//     for (let year = startYear; year <= endYear; year += yearStep) {
//         const position = ((year - startYear) / yearSpan) * 100;
//         timelineHTML += `<div class="absolute" style="left: ${position}%">${year}</div>`;
//     }
    
//     timelineHTML += `
//             </div>
            
//             <!-- Timeline tracks -->
//             <div class="timeline-tracks space-y-6">
//     `;
    
//     // Generate a track for each condition
//     sortedConditions.forEach((condition, index) => {
//         const startPosition = ((condition.earliestYear - startYear) / yearSpan) * 100;
//         const endPosition = 100 - ((endYear - condition.latestYear) / yearSpan) * 100;
//         const width = endPosition - startPosition;
        
//         // Generate a color based on the condition index
//         const hue = (index * 137.5) % 360; // Golden ratio to distribute colors
//         const color = `hsl(${hue}, 70%, 60%)`;
//         const darkColor = `hsl(${hue}, 70%, 40%)`;
        
//         timelineHTML += `
//             <div class="condition-track">
//                 <div class="flex flex-col md:flex-row md:justify-between md:items-baseline mb-1">
//                     <span class="font-medium text-sm break-words">${condition.name}</span>
//                     <span class="text-xs text-gray-500">${condition.count} ${condition.count === 1 ? 'study' : 'studies'}</span>
//                 </div>
//                 <div class="relative h-8 bg-gray-100 rounded-full overflow-hidden">
//                     <div class="absolute h-full rounded-full" style="left: ${startPosition}%; width: ${width}%; background-color: ${color};">
//                         <div class="h-full flex items-center justify-center text-xs font-bold text-white whitespace-nowrap px-2 overflow-hidden">
//                             ${condition.earliestYear} - ${condition.latestYear}
//                         </div>
//                     </div>
//                 </div>
                
//                 <!-- Activity indicators -->
//                 <div class="relative h-1 mt-1">
//         `;
        
//         // Add activity indicators (small circles indicating study frequency)
//         Object.keys(condition.years).forEach(year => {
//             const yearPosition = ((year - startYear) / yearSpan) * 100;
//             const size = Math.min(12, Math.max(4, condition.years[year] * 2)); // Scale based on study count
            
//             timelineHTML += `
//                 <div class="absolute rounded-full" 
//                      style="left: ${yearPosition}%; top: -${size/4}px; width: ${size}px; height: ${size}px; background-color: ${darkColor};"
//                      title="${year}: ${condition.years[year]} ${condition.years[year] === 1 ? 'study' : 'studies'}">
//                 </div>
//             `;
//         });
        
//         timelineHTML += `
//                 </div>
//             </div>
//         `;
//     });
    
//     timelineHTML += `
//             </div>
//         </div>
        
//         <!-- View all conditions button for when there are more than 20 -->
//         ${Object.keys(data.byCondition).length > 20 ? `
//         <div class="mt-4 text-center">
//             <button id="view-all-conditions" class="px-4 py-2 bg-blue-50 text-blue-600 rounded hover:bg-blue-100 transition-colors text-sm">
//                 View All ${Object.keys(data.byCondition).length} Conditions
//             </button>
//         </div>
//         ` : ''}
        
//         <!-- Evolution of usage patterns -->
//         <div class="mt-8">
//             <h3 class="text-lg font-medium mb-3">Key Clinical Insights</h3>
//             <div class="evolution-patterns grid grid-cols-1 md:grid-cols-2 gap-4">
//     `;
    
//     // Generate insights based on the data
//     const insights = generateInsights(data, drugName, sortedConditions);
    
//     insights.forEach(insight => {
//         timelineHTML += `
//             <div class="insight-card p-3 bg-gray-50 rounded-lg border border-gray-200">
//                 <div class="flex items-start">
//                     <div class="insight-icon mr-3 text-blue-500">
//                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
//                             <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
//                         </svg>
//                     </div>
//                     <p class="text-sm">${insight}</p>
//                 </div>
//             </div>
//         `;
//     });
    
//     timelineHTML += `
//             </div>
//         </div>
//     `;
    
//     // Update the timeline element
//     timelineElement.innerHTML = timelineHTML;
    
//     // Add event listener for the "View All Conditions" button
//     const viewAllButton = document.getElementById('view-all-conditions');
//     if (viewAllButton) {
//         viewAllButton.addEventListener('click', () => {
//             // Show modal with all conditions
//             showAllConditionsModal(data, drugName);
//         });
//     }
// }

// function showAllConditionsModal(data, drugName) {
//     // Create a modal to display all conditions
//     const modal = document.createElement('div');
//     modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
    
//     // Sort all conditions by count
//     const allConditions = Object.keys(data.byCondition)
//         .map(condition => ({
//             name: condition,
//             count: data.byCondition[condition].count,
//             earliestYear: data.byCondition[condition].earliestYear,
//             latestYear: data.byCondition[condition].latestYear
//         }))
//         .sort((a, b) => b.count - a.count);
    
//     // Create the modal content
//     let modalContent = `
//         <div class="bg-white rounded-lg w-full max-w-4xl max-h-[80vh] overflow-hidden flex flex-col">
//             <div class="p-4 border-b">
//                 <div class="flex justify-between items-center">
//                     <h3 class="text-xl font-bold">All Clinical Conditions for ${drugName}</h3>
//                     <button id="close-conditions-modal" class="text-gray-500 hover:text-gray-700">
//                         <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
//                         </svg>
//                     </button>
//                 </div>
//                 <p class="text-sm text-gray-500">${allConditions.length} total conditions found in clinical trials</p>
//             </div>
//             <div class="overflow-y-auto p-4">
//                 <table class="w-full">
//                     <thead class="bg-gray-50">
//                         <tr>
//                             <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Condition</th>
//                             <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Studies</th>
//                             <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Year Range</th>
//                         </tr>
//                     </thead>
//                     <tbody class="divide-y divide-gray-200">
//     `;
    
//     allConditions.forEach((condition, index) => {
//         modalContent += `
//             <tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
//                 <td class="px-4 py-2 text-sm">${condition.name}</td>
//                 <td class="px-4 py-2 text-sm text-center">${condition.count}</td>
//                 <td class="px-4 py-2 text-sm text-center">${condition.earliestYear} - ${condition.latestYear}</td>
//             </tr>
//         `;
//     });
    
//     modalContent += `
//                     </tbody>
//                 </table>
//             </div>
//         </div>
//     `;
    
//     modal.innerHTML = modalContent;
//     document.body.appendChild(modal);
    
//     // Add event listener to close the modal
//     document.getElementById('close-conditions-modal').addEventListener('click', () => {
//         document.body.removeChild(modal);
//     });
    
//     // Also close when clicking outside the modal content
//     modal.addEventListener('click', (e) => {
//         if (e.target === modal) {
//             document.body.removeChild(modal);
//         }
//     });
// }

// function generateInsights(data, drugName, sortedConditions) {
//     const insights = [];
//     const currentYear = new Date().getFullYear();
    
//     // Insight 1: First studied indication
//     if (sortedConditions.length > 0) {
//         const firstCondition = sortedConditions.sort((a, b) => a.earliestYear - b.earliestYear)[0];
//         insights.push(
//             `${drugName} was first studied for <strong>${firstCondition.name}</strong> in ${firstCondition.earliestYear}, ${currentYear - firstCondition.earliestYear} years ago.`
//         );
//     }
    
//     // Insight 2: Most studied indication
//     const mostStudiedCondition = sortedConditions.sort((a, b) => b.count - a.count)[0];
//     insights.push(
//         `The most researched application has been <strong>${mostStudiedCondition.name}</strong> with ${mostStudiedCondition.count} studies.`
//     );
    
//     // Insight 3: Count unique conditions
//     const uniqueConditionCount = Object.keys(data.byCondition).length;
//     insights.push(
//         `${drugName} has been investigated for ${uniqueConditionCount} distinct clinical conditions, showing its potential versatility across multiple medical applications.`
//     );
    
//     // Insight 4: Phase progression
//     const phaseData = data.byPhase;
//     const latePhaseCount = (phaseData.PHASE3 || []).length + (phaseData.PHASE4 || []).length;
//     const totalPhaseCount = Object.values(phaseData).flat().length;
    
//     if (totalPhaseCount > 0) {
//         const latePhasePercentage = Math.round((latePhaseCount / totalPhaseCount) * 100);
//         insights.push(
//             `${latePhasePercentage}% of studies have reached late-stage (Phase 3-4) clinical trials, indicating ${latePhasePercentage > 30 ? 'significant' : 'ongoing'} progress toward regulatory approval across various conditions.`
//         );
//     }
    
//     // Insight 5: Recent activity and trend
//     const recentYears = currentYear - 5;
//     let recentActivityCount = 0;
//     const recentConditions = new Set();
    
//     sortedConditions.forEach(condition => {
//         Object.keys(condition.years).forEach(year => {
//             if (parseInt(year) >= recentYears) {
//                 recentActivityCount += condition.years[year];
//                 recentConditions.add(condition.name);
//             }
//         });
//     });
    
//     if (recentConditions.size > 0) {
//         const topRecentConditions = Array.from(recentConditions).slice(0, 3);
//         if (topRecentConditions.length > 0) {
//             insights.push(
//                 `In the last 5 years, research has focused on ${recentConditions.size} conditions, with notable interest in <strong>${topRecentConditions.join('</strong>, <strong>')}</strong>.`
//             );
//         }
//     }
    
//     return insights;
// }


// function extractYearFromDate(dateString) {
//     if (!dateString) return null;
    
//     // Extract year from YYYY-MM-DD format
//     const match = dateString.match(/^(\d{4})-/);
//     if (match) {
//         return parseInt(match[1]);
//     }
    
//     // Try to extract any 4-digit year
//     const yearMatch = dateString.match(/\b(\d{4})\b/);
//     if (yearMatch) {
//         const year = parseInt(yearMatch[1]);
//         // Validate year is reasonable (between 1950 and current year + 5)
//         const currentYear = new Date().getFullYear();
//         if (year >= 1950 && year <= currentYear + 5) {
//             return year;
//         }
//     }
    
//     return null;
// }

// // Update the displayStudies function to include the timeline
// function displayStudiesWithTimeline(studies, drugName) {
//     // First, create and append the timeline
//     const timelineElement = generateDrugUsageTimeline(studies, drugName);
    
//     // Check if there's already a timeline
//     const existingTimeline = document.getElementById('drug-usage-timeline');
//     if (existingTimeline) {
//         existingTimeline.replaceWith(timelineElement);
//     } else {
//         // Insert the timeline before the studies list
//         const studiesContainer = elements.studiesList.parentElement;
//         timelineElement.id = 'drug-usage-timeline';
//         studiesContainer.insertBefore(timelineElement, elements.studiesList);
//     }
    
//     // Now continue with the original display logic
//     elements.studiesList.innerHTML = '';
//     elements.studyCount.textContent = studies.length;

//     if (studies.length === 0) {
//         elements.studiesList.innerHTML = `
//             <div class="text-center p-4 text-gray-500">
//                 <p>No studies found matching the current filters.</p>
//             </div>
//         `;
//         return;
//     }

//     // Sort studies by phase
//     const phaseOrder = { 
//         "PRE_PHASE": 0, 
//         "PHASE1": 1, 
//         "PHASE1_PHASE2": 1.5,
//         "PHASE2": 2, 
//         "PHASE3": 3, 
//         "PHASE4": 4 
//     };

//     studies.sort((a, b) => {
//         const phaseA = a.protocolSection?.designModule?.phases?.[0] || "PRE_PHASE";
//         const phaseB = b.protocolSection?.designModule?.phases?.[0] || "PRE_PHASE";
//         return (phaseOrder[phaseA] || 0) - (phaseOrder[phaseB] || 0);
//     });

//     studies.forEach(study => {
//         const nctId = study.protocolSection?.identificationModule?.nctId;
//         const title = study.protocolSection?.identificationModule?.briefTitle;
//         const phase = study.protocolSection?.designModule?.phases?.[0] || "N/A";
//         const status = study.protocolSection?.statusModule?.overallStatus;
//         const sponsor = study.protocolSection?.identificationModule?.organization?.fullName;
//         const hasResults = study.hasResults;
        
//         // Determine if this is a TRD-specific study
//         const briefTitle = study.protocolSection?.identificationModule?.briefTitle?.toLowerCase() || '';
//         const officialTitle = study.protocolSection?.identificationModule?.officialTitle?.toLowerCase() || '';
//         const briefSummary = study.protocolSection?.descriptionModule?.briefSummary?.toLowerCase() || '';
        
//         const trdTerms = [
//             'treatment-resistant depression', 
//             'treatment resistant depression',
//             'trd',
//             'refractory depression'
//         ];
        
//         const isTRDSpecific = trdTerms.some(term => 
//             briefTitle.includes(term) || 
//             officialTitle.includes(term) || 
//             briefSummary.includes(term)
//         );
        
//         const card = document.createElement('div');
//         card.className = 'bg-white p-4 rounded-lg border border-gray-200 hover:shadow-md transition duration-200';
//         card.innerHTML = `
//             <div class="flex flex-col md:flex-row gap-2 md:items-center md:justify-between mb-3">
//                 <div class="flex gap-2 items-center flex-wrap">
//                     <span class="inline-block w-3 h-3 rounded-full" style="background-color: ${getPhaseColor(phase)}"></span>
//                     <span class="text-sm font-medium">${formatPhase(phase)}</span>
//                     ${getStatusBadge(status)}
//                     ${isTRDSpecific ? '<span class="text-xs bg-purple-100 text-purple-800 px-2 py-0.5 rounded-full">TRD-Specific</span>' : ''}
//                 </div>
//                 <div>
//                     <span class="text-xs text-gray-500">${nctId}</span>
//                     ${hasResults ? '<span class="ml-2 text-xs bg-green-100 text-green-800 px-2 py-0.5 rounded-full">Has Results</span>' : ''}
//                 </div>
//             </div>
//             <h3 class="text-lg font-medium mb-2">${title}</h3>
//             <p class="text-sm text-gray-600 mb-3">Sponsor: ${sponsor || 'Unknown'}</p>
//             <button data-nctid="${nctId}" class="view-study-btn text-primary hover:text-blue-700 text-sm font-medium flex items-center">
//                 <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
//                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
//                 </svg>
//                 View Study Details
//             </button>
//         `;
//         elements.studiesList.appendChild(card);
        
//         // Add event listener to the view button
//         card.querySelector('.view-study-btn').addEventListener('click', () => {
//             viewStudyDetails(nctId);
//         });
//     });
// }


////////////////////////////////////////////////////////////////////////////////////////////////////////////////////



/**
 * Extracts usage data for drug-centric timeline
 * @param {Array} studies - Array of study objects
 * @param {string} drugName - Name of the drug
 * @returns {Object} - Structured usage data
 */
function extractUsageData(studies, drugName) {
    // Initialize data structure
    const result = {
        earliestStudyYear: null,
        latestStudyYear: null,
        byCondition: {},
        byPhase: {
            "PRE_PHASE": [],
            "PHASE1": [],
            "PHASE1_PHASE2": [],
            "PHASE2": [],
            "PHASE3": [],
            "PHASE4": []
        },
        totalStudies: studies.length,
        entityType: 'drug',
        entityName: drugName
    };
    
    // Current year for comparison
    const currentYear = new Date().getFullYear();
    
    studies.forEach(study => {
        // Extract key information
        const startYear = extractYearFromDate(
            study.protocolSection?.statusModule?.startDateStruct?.date
        );
        
        const completionYear = extractYearFromDate(
            study.protocolSection?.statusModule?.completionDateStruct?.date
        );
        
        const primaryCompletionYear = extractYearFromDate(
            study.protocolSection?.statusModule?.primaryCompletionDateStruct?.date
        );
        
        // Use the most appropriate year available
        const studyYear = startYear || 
                         (primaryCompletionYear && primaryCompletionYear <= currentYear ? primaryCompletionYear : null) || 
                         (completionYear && completionYear <= currentYear ? completionYear : null) || 
                         null;
        
        if (!studyYear) return; // Skip if no valid year
        
        // Update earliest/latest years
        if (result.earliestStudyYear === null || studyYear < result.earliestStudyYear) {
            result.earliestStudyYear = studyYear;
        }
        
        if (result.latestStudyYear === null || studyYear > result.latestStudyYear) {
            result.latestStudyYear = studyYear;
        }
        
        // Extract conditions
        const conditions = study.protocolSection?.conditionsModule?.conditions || [];
        
        // If no specific conditions listed, use a placeholder
        if (conditions.length === 0) {
            const category = "Unspecified Condition";
            
            if (!result.byCondition[category]) {
                result.byCondition[category] = {
                    count: 0,
                    years: {},
                    earliestYear: null,
                    latestYear: null,
                    studies: [] // Store study IDs for linking
                };
            }
            
            result.byCondition[category].count++;
            result.byCondition[category].years[studyYear] = (result.byCondition[category].years[studyYear] || 0) + 1;
            
            // Store study ID for linking
            result.byCondition[category].studies.push({
                id: study.protocolSection?.identificationModule?.nctId,
                year: studyYear,
                title: study.protocolSection?.identificationModule?.briefTitle || 'Untitled Study'
            });
            
            // Update condition-specific earliest/latest years
            if (result.byCondition[category].earliestYear === null || 
                studyYear < result.byCondition[category].earliestYear) {
                result.byCondition[category].earliestYear = studyYear;
            }
            
            if (result.byCondition[category].latestYear === null || 
                studyYear > result.byCondition[category].latestYear) {
                result.byCondition[category].latestYear = studyYear;
            }
        } else {
            // Process each condition
            conditions.forEach(condition => {
                // Keep the exact condition name as provided, only first letter capitalized for consistency
                const normalizedCondition = condition.charAt(0).toUpperCase() + condition.slice(1);
                
                // Initialize condition data if it doesn't exist
                if (!result.byCondition[normalizedCondition]) {
                    result.byCondition[normalizedCondition] = {
                        count: 0,
                        years: {},
                        earliestYear: null,
                        latestYear: null,
                        studies: [] // Store study IDs for linking
                    };
                }
                
                // Increment counts
                result.byCondition[normalizedCondition].count++;
                result.byCondition[normalizedCondition].years[studyYear] = 
                    (result.byCondition[normalizedCondition].years[studyYear] || 0) + 1;
                
                // Store study ID for linking
                result.byCondition[normalizedCondition].studies.push({
                    id: study.protocolSection?.identificationModule?.nctId,
                    year: studyYear,
                    title: study.protocolSection?.identificationModule?.briefTitle || 'Untitled Study',
                    phase: study.protocolSection?.designModule?.phases?.[0] || "PRE_PHASE"
                });
                
                // Update condition-specific earliest/latest years
                if (result.byCondition[normalizedCondition].earliestYear === null || 
                    studyYear < result.byCondition[normalizedCondition].earliestYear) {
                    result.byCondition[normalizedCondition].earliestYear = studyYear;
                }
                
                if (result.byCondition[normalizedCondition].latestYear === null || 
                    studyYear > result.byCondition[normalizedCondition].latestYear) {
                    result.byCondition[normalizedCondition].latestYear = studyYear;
                }
            });
        }
        
        // Track phases
        const phase = study.protocolSection?.designModule?.phases?.[0] || "PRE_PHASE";
        if (result.byPhase[phase]) {
            result.byPhase[phase].push({
                nctId: study.protocolSection?.identificationModule?.nctId,
                year: studyYear,
                conditions: conditions.length > 0 ? conditions : ["Unspecified"],
                title: study.protocolSection?.identificationModule?.briefTitle || 'Untitled Study'
            });
        }
    });
    
    return result;
}

/**
 * Extracts data for condition-centric timeline
 * @param {Array} studies - Array of study objects
 * @param {string} conditionName - Name of the condition
 * @returns {Object} - Structured usage data
 */
// function extractConditionData(studies, conditionName) {
//     // Initialize data structure
//     const result = {
//         earliestStudyYear: null,
//         latestStudyYear: null,
//         byDrug: {}, // Instead of byCondition, we track by drug
//         byPhase: {
//             "PRE_PHASE": [],
//             "PHASE1": [],
//             "PHASE1_PHASE2": [],
//             "PHASE2": [],
//             "PHASE3": [],
//             "PHASE4": []
//         },
//         totalStudies: studies.length,
//         entityType: 'condition',
//         entityName: conditionName
//     };
    
//     // Current year for comparison
//     const currentYear = new Date().getFullYear();
    
//     studies.forEach(study => {
//         // Extract key information
//         const startYear = extractYearFromDate(
//             study.protocolSection?.statusModule?.startDateStruct?.date
//         );
        
//         const completionYear = extractYearFromDate(
//             study.protocolSection?.statusModule?.completionDateStruct?.date
//         );
        
//         const primaryCompletionYear = extractYearFromDate(
//             study.protocolSection?.statusModule?.primaryCompletionDateStruct?.date
//         );
        
//         // Use the most appropriate year available
//         const studyYear = startYear || 
//                          (primaryCompletionYear && primaryCompletionYear <= currentYear ? primaryCompletionYear : null) || 
//                          (completionYear && completionYear <= currentYear ? completionYear : null) || 
//                          null;
        
//         if (!studyYear) return; // Skip if no valid year
        
//         // Update earliest/latest years
//         if (result.earliestStudyYear === null || studyYear < result.earliestStudyYear) {
//             result.earliestStudyYear = studyYear;
//         }
        
//         if (result.latestStudyYear === null || studyYear > result.latestStudyYear) {
//             result.latestStudyYear = studyYear;
//         }
        
//         // Extract interventions (drugs or treatments)
//         const interventions = study.protocolSection?.armsInterventionsModule?.interventions || [];
        
//         // If no specific interventions listed, use a placeholder
//         if (interventions.length === 0) {
//             const category = "Unspecified Treatment";
            
//             if (!result.byDrug[category]) {
//                 result.byDrug[category] = {
//                     count: 0,
//                     years: {},
//                     earliestYear: null,
//                     latestYear: null,
//                     studies: [] // Store study IDs for linking
//                 };
//             }
            
//             result.byDrug[category].count++;
//             result.byDrug[category].years[studyYear] = (result.byDrug[category].years[studyYear] || 0) + 1;
            
//             // Store study ID for linking
//             result.byDrug[category].studies.push({
//                 id: study.protocolSection?.identificationModule?.nctId,
//                 year: studyYear,
//                 title: study.protocolSection?.identificationModule?.briefTitle || 'Untitled Study',
//                 phase: study.protocolSection?.designModule?.phases?.[0] || "PRE_PHASE"
//             });
            
//             // Update drug-specific earliest/latest years
//             if (result.byDrug[category].earliestYear === null || 
//                 studyYear < result.byDrug[category].earliestYear) {
//                 result.byDrug[category].earliestYear = studyYear;
//             }
            
//             if (result.byDrug[category].latestYear === null || 
//                 studyYear > result.byDrug[category].latestYear) {
//                 result.byDrug[category].latestYear = studyYear;
//             }
//         } else {
//             // Process each intervention
//             interventions.forEach(intervention => {
//                 // Only capture drug interventions
//                 if (intervention.type?.toLowerCase() !== 'drug' && 
//                     intervention.type?.toLowerCase() !== 'biological' &&
//                     intervention.type?.toLowerCase() !== 'combination product') {
//                     return;
//                 }
                
//                 // Normalize drug name
//                 const drugName = intervention.name.charAt(0).toUpperCase() + intervention.name.slice(1);
                
//                 // Initialize drug data if it doesn't exist
//                 if (!result.byDrug[drugName]) {
//                     result.byDrug[drugName] = {
//                         count: 0,
//                         years: {},
//                         earliestYear: null,
//                         latestYear: null,
//                         studies: [] // Store study IDs for linking
//                     };
//                 }
                
//                 // Increment counts
//                 result.byDrug[drugName].count++;
//                 result.byDrug[drugName].years[studyYear] = 
//                     (result.byDrug[drugName].years[studyYear] || 0) + 1;
                
//                 // Store study ID for linking
//                 result.byDrug[drugName].studies.push({
//                     id: study.protocolSection?.identificationModule?.nctId,
//                     year: studyYear,
//                     title: study.protocolSection?.identificationModule?.briefTitle || 'Untitled Study',
//                     phase: study.protocolSection?.designModule?.phases?.[0] || "PRE_PHASE"
//                 });
                
//                 // Update drug-specific earliest/latest years
//                 if (result.byDrug[drugName].earliestYear === null || 
//                     studyYear < result.byDrug[drugName].earliestYear) {
//                     result.byDrug[drugName].earliestYear = studyYear;
//                 }
                
//                 if (result.byDrug[drugName].latestYear === null || 
//                     studyYear > result.byDrug[drugName].latestYear) {
//                     result.byDrug[drugName].latestYear = studyYear;
//                 }
//             });
//         }
        
//         // Track phases
//         const phase = study.protocolSection?.designModule?.phases?.[0] || "PRE_PHASE";
//         if (result.byPhase[phase]) {
//             result.byPhase[phase].push({
//                 nctId: study.protocolSection?.identificationModule?.nctId,
//                 year: studyYear,
//                 title: study.protocolSection?.identificationModule?.briefTitle || 'Untitled Study'
//             });
//         }
//     });
    
//     return result;
// }

// function cleanAndSplitDrugName(rawName) {
//     // Convert to lowercase for consistent processing
//     const lowerName = rawName.toLowerCase().trim();

//     // Skip known non-drug terms
//     const nonDrugTerms = [
//         'placebo',
//         'sugar pill',
//         'saline',
//         'control',
//         'sham',
//         'vehicle',
//         'inactive',
//         'no intervention'
//     ];
//     if (nonDrugTerms.some(term => lowerName.includes(term))) {
//         return [];
//     }

//     // Remove dosages, percentages, and other qualifiers
//     let cleanedName = lowerName
//         .replace(/\b\d+(\.\d+)?\s*(mg|g|%|ml|mcg|iu|units)\b/gi, '') // Remove dosages (e.g., "56 mg")
//         .replace(/\b(xr|er|sr|cr)\b/gi, '') // Remove extended-release qualifiers
//         .replace(/\(\s*new antidepressant\s*\)/gi, '') // Remove parenthetical qualifiers
//         .replace(/\b(nitrous oxide|oxygen|midazolam)\b/gi, '') // Remove specific non-relevant drugs
//         .replace(/\s*\d+%\s*/gi, '') // Remove percentages
//         .replace(/[^\w\s\+&,-]/g, '') // Remove special characters except +, &, -, and commas
//         .trim();

//     // Handle combination therapies
//     const separators = [',', ' plus ', ' and ', ' & ', ' + '];
//     let drugNames = [cleanedName];
    
//     for (const sep of separators) {
//         if (cleanedName.includes(sep)) {
//             drugNames = cleanedName.split(sep).map(name => name.trim());
//             break;
//         }
//     }

//     // Final cleanup and normalization
//     return drugNames
//         .map(name => {
//             // Skip empty or short names
//             if (!name || name.length < 2) return null;
            
//             // Capitalize first letter of each word
//             return name
//                 .split(' ')
//                 .map(word => word.charAt(0).toUpperCase() + word.slice(1))
//                 .join(' ');
//         })
//         .filter(name => name && !nonDrugTerms.some(term => name.toLowerCase().includes(term)));
// }

function cleanAndSplitDrugName(rawName) {
    // Skip processing if empty or null
    if (!rawName) return [];
    
    // Convert to lowercase for consistent processing
    const lowerName = rawName.toLowerCase().trim();

    // Skip known non-drug terms
    const nonDrugTerms = [
        'placebo', 'sugar pill', 'saline', 'control', 'sham', 'vehicle', 
        'inactive', 'no intervention', 'any fda approved', '99'
    ];
    
    if (nonDrugTerms.some(term => lowerName.includes(term))) {
        return [];
    }

    // Extract drug names from special formats
    // For patterns like "Sublingual Film Containing Dexmedetomidine Bxcl501"
    const containingMatch = lowerName.match(/containing\s+(\w+)/i);
    if (containingMatch) {
        return [capitalizeWords(containingMatch[1])];
    }
    
    // Remove study identifiers and codes
    let cleanedName = lowerName
        .replace(/\b[a-z]+\d+\b/gi, '') // Remove alphanumeric codes like "bxcl501"
        .replace(/\bphase\s+[1-4]\b/gi, '') // Remove phase mentions
        .replace(/\btrial\b/gi, '') // Remove trial mentions
        .replace(/\b\d+(\.\d+)?\s*(mg|g|%|ml|mcg|iu|units)\b/gi, '') // Remove dosages
        .replace(/\b(xr|er|sr|cr)\b/gi, '') // Remove extended-release qualifiers
        .replace(/\(\s*new.*?\s*\)/gi, '') // Remove parenthetical qualifiers
        .replace(/\b(nitrous oxide|oxygen|midazolam)\b/gi, '') // Remove specific non-relevant drugs
        .replace(/\s*\d+%\s*/gi, '') // Remove percentages
        .replace(/\blow dose\b/gi, '') // Remove "low dose" qualifier
        .replace(/\bhigh dose\b/gi, '') // Remove "high dose" qualifier
        .replace(/\bonce (daily|monthly|weekly)\b/gi, '') // Remove "once daily" etc.
        .replace(/\bim\b/gi, '') // Remove "IM" (intramuscular)
        .replace(/\**folate with b12\**/gi, '') // Remove specific problematic entries
        .replace(/[^\w\s\+&,-]/g, '') // Remove special characters except +, &, -, and commas
        .replace(/\bwith\b/gi, '+') // Convert "with" to "+" for combination drugs
        .trim();

    // Handle combination therapies
    const separators = ['+', ',', ' plus ', ' and ', ' & '];
    let drugNames = [cleanedName];
    
    for (const sep of separators) {
        if (cleanedName.includes(sep)) {
            drugNames = cleanedName.split(sep).map(name => name.trim());
            break;
        }
    }

    // Final cleanup and filtering
    return drugNames
        .map(name => {
            // Skip empty, short names, or just numbers
            if (!name || name.length < 2 || /^\d+$/.test(name)) return null;
            
            // Further clean up each drug name
            let cleanedDrugName = name
                .replace(/^\s*[a-z]+\s+/, '') // Remove leading modifiers (like "sublingual")
                .replace(/\s+film$/, '') // Remove trailing "film"
                .trim();
                
            // Skip if empty after cleaning
            if (!cleanedDrugName) return null;
            
            // Capitalize first letter of each word
            return capitalizeWords(cleanedDrugName);
        })
        .filter(name => name && !nonDrugTerms.some(term => name.toLowerCase().includes(term)));
}

// Helper function to capitalize words
function capitalizeWords(text) {
    return text
        .split(' ')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
        .join(' ');
}


function extractConditionData(studies, conditionName) {
    // Initialize data structure
    const result = {
        earliestStudyYear: null,
        latestStudyYear: null,
        byDrug: {},
        byPhase: {
            "PRE_PHASE": [],
            "PHASE1": [],
            "PHASE1_PHASE2": [],
            "PHASE2": [],
            "PHASE3": [],
            "PHASE4": []
        },
        successfulDrugs: [],
        failedDrugs: [],
        totalStudies: studies.length,
        entityType: 'condition',
        entityName: conditionName
    };
    
    // Current year for comparison
    const currentYear = new Date().getFullYear();
    
    studies.forEach(study => {
        // Extract key information
        const startYear = extractYearFromDate(
            study.protocolSection?.statusModule?.startDateStruct?.date
        );
        
        const completionYear = extractYearFromDate(
            study.protocolSection?.statusModule?.completionDateStruct?.date
        );
        
        const primaryCompletionYear = extractYearFromDate(
            study.protocolSection?.statusModule?.primaryCompletionDateStruct?.date
        );
        
        // Use the most appropriate year available
        const studyYear = startYear || 
                         (primaryCompletionYear && primaryCompletionYear <= currentYear ? primaryCompletionYear : null) || 
                         (completionYear && completionYear <= currentYear ? completionYear : null) || 
                         null;
        
        if (!studyYear) return; // Skip if no valid year
        
        // Get study status
        const overallStatus = study.protocolSection?.statusModule?.overallStatus || '';
        const phase = study.protocolSection?.designModule?.phases?.[0] || "PRE_PHASE";
        const isLatePhase = phase === "PHASE3" || phase === "PHASE4";
        
        // Check study outcome
        const isCompleted = overallStatus.toLowerCase() === 'completed';
        const isTerminated = overallStatus.toLowerCase() === 'terminated' || 
                             overallStatus.toLowerCase() === 'withdrawn' ||
                             overallStatus.toLowerCase() === 'suspended';
        
        // Update earliest/latest years
        if (result.earliestStudyYear === null || studyYear < result.earliestStudyYear) {
            result.earliestStudyYear = studyYear;
        }
        
        if (result.latestStudyYear === null || studyYear > result.latestStudyYear) {
            result.latestStudyYear = studyYear;
        }
        
        // Extract interventions (drugs or treatments)
        const interventions = study.protocolSection?.armsInterventionsModule?.interventions || [];
        
        // If no specific interventions listed, use a placeholder
        if (interventions.length === 0) {
            const category = "Unspecified Treatment";
            
            if (!result.byDrug[category]) {
                result.byDrug[category] = {
                    count: 0,
                    years: {},
                    earliestYear: null,
                    latestYear: null,
                    studies: [],
                    completedLatePhaseStudies: [],
                    terminatedStudies: []
                };
            }
            
            result.byDrug[category].count++;
            result.byDrug[category].years[studyYear] = (result.byDrug[category].years[studyYear] || 0) + 1;
            
            // Store study ID for linking
            const studyInfo = {
                id: study.protocolSection?.identificationModule?.nctId,
                year: studyYear,
                title: study.protocolSection?.identificationModule?.briefTitle || 'Untitled Study',
                phase: phase,
                status: overallStatus
            };
            
            result.byDrug[category].studies.push(studyInfo);
            
            // Track successful/failed studies
            if (isLatePhase && isCompleted) {
                result.byDrug[category].completedLatePhaseStudies.push(studyInfo);
            }
            
            if (isTerminated) {
                result.byDrug[category].terminatedStudies.push(studyInfo);
            }
            
            // Update drug-specific earliest/latest years
            if (result.byDrug[category].earliestYear === null || 
                studyYear < result.byDrug[category].earliestYear) {
                result.byDrug[category].earliestYear = studyYear;
            }
            
            if (result.byDrug[category].latestYear === null || 
                studyYear > result.byDrug[category].latestYear) {
                result.byDrug[category].latestYear = studyYear;
            }
        } else {
            // Process each intervention
            interventions.forEach(intervention => {
                // Only capture drug interventions
                if (intervention.type?.toLowerCase() !== 'drug' && 
                    intervention.type?.toLowerCase() !== 'biological' &&
                    intervention.type?.toLowerCase() !== 'combination product') {
                    return;
                }
                
                // Clean and split drug names
                const drugNames = cleanAndSplitDrugName(intervention.name);

                // Skip if no valid drug names
                if (drugNames.length === 0) return;

                // Process each cleaned drug name
                drugNames.forEach(drugName => {
                    // Initialize drug data if it doesn't exist
                    if (!result.byDrug[drugName]) {
                        result.byDrug[drugName] = {
                            count: 0,
                            years: {},
                            earliestYear: null,
                            latestYear: null,
                            studies: [],
                            completedLatePhaseStudies: [],
                            terminatedStudies: []
                        };
                    }
                    
                    // Increment counts
                    result.byDrug[drugName].count++;
                    result.byDrug[drugName].years[studyYear] = 
                        (result.byDrug[drugName].years[studyYear] || 0) + 1;
                    
                    // Store study ID for linking
                    const studyInfo = {
                        id: study.protocolSection?.identificationModule?.nctId,
                        year: studyYear,
                        title: study.protocolSection?.identificationModule?.briefTitle || 'Untitled Study',
                        phase: phase,
                        status: overallStatus
                    };
                    
                    result.byDrug[drugName].studies.push(studyInfo);
                    
                    // Track successful/failed studies
                    if (isLatePhase && isCompleted) {
                        result.byDrug[drugName].completedLatePhaseStudies.push(studyInfo);
                    }
                    
                    if (isTerminated) {
                        result.byDrug[drugName].terminatedStudies.push(studyInfo);
                    }
                    
                    // Update drug-specific earliest/latest years
                    if (result.byDrug[drugName].earliestYear === null || 
                        studyYear < result.byDrug[drugName].earliestYear) {
                        result.byDrug[drugName].earliestYear = studyYear;
                    }
                    
                    if (result.byDrug[drugName].latestYear === null || 
                        studyYear > result.byDrug[drugName].latestYear) {
                        result.byDrug[drugName].latestYear = studyYear;
                    }
                });
            });
        }
        
        // Track phases
        if (result.byPhase[phase]) {
            result.byPhase[phase].push({
                nctId: study.protocolSection?.identificationModule?.nctId,
                year: studyYear,
                title: study.protocolSection?.identificationModule?.briefTitle || 'Untitled Study',
                status: overallStatus
            });
        }
    });
    
    // Identify successful and failed drugs based on their studies
    for (const drugName in result.byDrug) {
        // A drug is considered successful if it has at least one completed Phase 3 or 4 study
        if (result.byDrug[drugName].completedLatePhaseStudies.length > 0) {
            result.successfulDrugs.push({
                name: drugName,
                completedLatePhaseStudies: result.byDrug[drugName].completedLatePhaseStudies,
                totalStudies: result.byDrug[drugName].count
            });
        }
        
        // A drug is considered failed if it has terminated studies but no completed late phase studies
        if (result.byDrug[drugName].terminatedStudies.length > 0 && 
            result.byDrug[drugName].completedLatePhaseStudies.length === 0) {
            result.failedDrugs.push({
                name: drugName,
                terminatedStudies: result.byDrug[drugName].terminatedStudies,
                totalStudies: result.byDrug[drugName].count
            });
        }
    }
    
    return result;
}


// Helper function to detect successful and failed drugs from the API data
// function analyzeTrialResults(conditionData) {
//     // Create more user-friendly summary
//     const summary = {
//         condition: conditionData.entityName,
//         totalStudies: conditionData.totalStudies,
//         timeRange: `${conditionData.earliestStudyYear || 'Unknown'} - ${conditionData.latestStudyYear || 'Present'}`,
//         successfulDrugs: [],
//         failedDrugs: [],
//         drugsInProgress: []
//     };
    
//     // Process successful drugs (completed Phase 3/4)
//     conditionData.successfulDrugs.forEach(drug => {
//         summary.successfulDrugs.push({
//             name: drug.name,
//             completedLatePhaseTrials: drug.completedLatePhaseStudies.length,
//             latestCompletedYear: Math.max(...drug.completedLatePhaseStudies.map(study => study.year)),
//             trialIds: drug.completedLatePhaseStudies.map(study => study.id)
//         });
//     });
    
//     // Process failed drugs
//     conditionData.failedDrugs.forEach(drug => {
//         summary.failedDrugs.push({
//             name: drug.name,
//             terminatedTrials: drug.terminatedStudies.length,
//             latestTerminatedYear: Math.max(...drug.terminatedStudies.map(study => study.year)),
//             trialIds: drug.terminatedStudies.map(study => study.id)
//         });
//     });
    
//     // Find drugs still in progress (having studies but not in successful or failed lists)
//     for (const drugName in conditionData.byDrug) {
//         const isSuccessful = conditionData.successfulDrugs.some(d => d.name === drugName);
//         const isFailed = conditionData.failedDrugs.some(d => d.name === drugName);
        
//         if (!isSuccessful && !isFailed) {
//             const drugData = conditionData.byDrug[drugName];
//             const ongoingStudies = drugData.studies.filter(study => 
//                 study.status.toLowerCase() === 'recruiting' || 
//                 study.status.toLowerCase() === 'active, not recruiting' ||
//                 study.status.toLowerCase() === 'enrolling by invitation' ||
//                 study.status.toLowerCase() === 'not yet recruiting'
//             );
            
//             if (ongoingStudies.length > 0) {
//                 summary.drugsInProgress.push({
//                     name: drugName,
//                     ongoingTrials: ongoingStudies.length,
//                     phases: [...new Set(ongoingStudies.map(study => study.phase))],
//                     trialIds: ongoingStudies.map(study => study.id)
//                 });
//             }
//         }
//     }
    
//     return summary;
// }


// Enhanced analyzeTrialResults function that also generates UI
// and checks FDA/EMA approvals

/**
 * Analyzes clinical trial data and generates a Tailwind UI
 * @param {Object} conditionData - Data from extractConditionData function
 * @param {String} targetElementId - ID of element to inject UI into
 * @returns {Promise<Object>} - Analysis results
 */
 async function analyzeTrialResults(conditionData, targetElementId = 'clinical-trials-dashboard') {
  // Create more user-friendly summary
  const summary = {
    condition: conditionData.entityName,
    totalStudies: conditionData.totalStudies,
    timeRange: `${conditionData.earliestStudyYear || 'Unknown'} - ${conditionData.latestStudyYear || 'Present'}`,
    successfulDrugs: [],
    failedDrugs: [],
    drugsInProgress: []
  };
  
  // Process successful drugs (completed Phase 3/4)
  conditionData.successfulDrugs.forEach(drug => {
    summary.successfulDrugs.push({
      name: drug.name,
      completedLatePhaseTrials: drug.completedLatePhaseStudies.length,
      latestCompletedYear: Math.max(...drug.completedLatePhaseStudies.map(study => study.year)),
      trialIds: drug.completedLatePhaseStudies.map(study => study.id),
      fdaApproved: null, // Will be populated later
      emaApproved: null  // Will be populated later
    });
  });
  
  // Process failed drugs
  conditionData.failedDrugs.forEach(drug => {
    summary.failedDrugs.push({
      name: drug.name,
      terminatedTrials: drug.terminatedStudies.length,
      latestTerminatedYear: Math.max(...drug.terminatedStudies.map(study => study.year)),
      trialIds: drug.terminatedStudies.map(study => study.id)
    });
  });
  
  // Find drugs still in progress (having studies but not in successful or failed lists)
  for (const drugName in conditionData.byDrug) {
    const isSuccessful = conditionData.successfulDrugs.some(d => d.name === drugName);
    const isFailed = conditionData.failedDrugs.some(d => d.name === drugName);
    
    if (!isSuccessful && !isFailed) {
      const drugData = conditionData.byDrug[drugName];
      const ongoingStudies = drugData.studies.filter(study => 
        study.status.toLowerCase() === 'recruiting' || 
        study.status.toLowerCase() === 'active, not recruiting' ||
        study.status.toLowerCase() === 'enrolling by invitation' ||
        study.status.toLowerCase() === 'not yet recruiting'
      );
      
      if (ongoingStudies.length > 0) {
        summary.drugsInProgress.push({
          name: drugName,
          ongoingTrials: ongoingStudies.length,
          phases: [...new Set(ongoingStudies.map(study => study.phase))],
          trialIds: ongoingStudies.map(study => study.id),
          fdaApproved: null, // Will be populated later
          emaApproved: null  // Will be populated later
        });
      }
    }
  }
  
  // Check FDA and EMA approvals for successful drugs and drugs in progress
  // We'll check them in parallel for better performance
  const drugApprovalPromises = [];
  
  // Successful drugs
  for (const drug of summary.successfulDrugs) {
    drugApprovalPromises.push(
      checkDrugApprovals(drug.name).then(approvals => {
        drug.fdaApproved = approvals.fda;
        drug.emaApproved = approvals.ema;
        return drug;
      })
    );
  }
  
  // Drugs in progress
  for (const drug of summary.drugsInProgress) {
    drugApprovalPromises.push(
      checkDrugApprovals(drug.name).then(approvals => {
        drug.fdaApproved = approvals.fda;
        drug.emaApproved = approvals.ema;
        return drug;
      })
    );
  }
  
  // Wait for all approval checks to complete
  await Promise.all(drugApprovalPromises);
  
  // Generate and inject UI
  generateAndInjectUI(summary, targetElementId);
  
  return summary;
}

/**
 * Checks FDA and EMA approvals for a drug
 * @param {String} drugName - Name of the drug to check
 * @returns {Promise<Object>} - FDA and EMA approval info
 */
async function checkDrugApprovals(drugName) {
  try {
    // URL should point to your backend API endpoint
    const apiUrl = `/api/drug-approval/${encodeURIComponent(drugName)}`;
    const response = await fetch(apiUrl);
    
    if (!response.ok) {
      console.warn(`Failed to get approval data for ${drugName}: ${response.status}`);
      return { fda: { approved: false }, ema: { approved: false } };
    }
    
    const data = await response.json();
    return {
      fda: data.fda,
      ema: data.ema
    };
  } catch (error) {
    console.error(`Error checking approvals for ${drugName}:`, error);
    return { fda: { approved: false }, ema: { approved: false } };
  }
}

/**
 * Generates UI and injects it into the specified element
 * @param {Object} summary - Analysis results
 * @param {String} targetElementId - ID of element to inject UI into
 */
function generateAndInjectUI(summary, targetElementId) {
  // Get the target element
  const targetElement = document.getElementById(targetElementId);
  if (!targetElement) {
    console.error(`Target element with ID '${targetElementId}' not found`);
    return;
  }
  
  // Create tabs state - we'll use a simple data attribute approach
  let activeTab = 'successful';
  
  // Generate HTML
  const html = `
    <div class="min-h-screen  p-4">
      <div class=" mx-auto">
        <!-- Header -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
          <h1 class="text-2xl font-bold text-gray-800">Clinical Trials Dashboard: ${summary.condition}</h1>
          <div class="mt-2 text-gray-600">
            <p>Analyzing ${summary.totalStudies} studies from ${summary.timeRange}</p>
          </div>
        </div>

        <!-- Tabs -->
        <div class="bg-white rounded-lg shadow-md overflow-hidden mb-6">
          <div class="flex border-b">
            <button 
              class="tab-button px-4 py-3 flex-1 font-medium text-center bg-blue-50 text-blue-600 border-b-2 border-blue-500"
              data-tab="successful"
            >
              Successful Drugs (${summary.successfulDrugs.length})
            </button>
            <button 
              class="tab-button px-4 py-3 flex-1 font-medium text-center text-gray-600 hover:bg-gray-50"
              data-tab="failed"
            >
              Failed Drugs (${summary.failedDrugs.length})
            </button>
            <button 
              class="tab-button px-4 py-3 flex-1 font-medium text-center text-gray-600 hover:bg-gray-50"
              data-tab="progress"
            >
              In Progress (${summary.drugsInProgress.length})
            </button>
          </div>

          <!-- Tab Content -->
          <div class="tab-content p-6">
            <div id="tab-successful" class="tab-pane active">
              <div>
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Successful Drugs (Completed Phase 3/4 Trials)</h2>
                <div class="mb-4 p-3 bg-blue-50 rounded-lg">
                  <p class="text-sm text-blue-800">
                    <strong>Selection criteria:</strong> Drugs that have at least one completed Phase 3 or Phase 4 clinical trial.
                  </p>
                </div>
                ${
                  summary.successfulDrugs.length > 0 ? 
                  `<div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                      <thead class="bg-gray-50">
                        <tr>
                          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Drug Name</th>
                          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Trials (Phase 3/4)</th>
                          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Latest Completion</th>
                          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">FDA Status</th>
                          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">EMA Status</th>
                          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Trial IDs</th>
                        </tr>
                      </thead>
                      <tbody class="bg-white divide-y divide-gray-200">
                        ${summary.successfulDrugs.map((drug, idx) => `
                          <tr class="hover:bg-gray-50">
                          <!--  <td  class="px-6 py-4 whitespace-nowrap font-medium text-gray-900">${drug.name}</td> -->
                            <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900">
  <a href="https://sunday-fsfq.onrender.com?drug=${encodeURIComponent(drug.name)}" class="text-blue-600 hover:text-blue-800 hover:underline">
    ${drug.name}
  </a>
</td>

                            <td class="px-6 py-4 whitespace-nowrap text-gray-700">${drug.completedLatePhaseTrials}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-gray-700">${drug.latestCompletedYear}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                              ${drug.fdaApproved && drug.fdaApproved.approved ? 
                                `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                  <svg class="mr-1.5 h-2 w-2 text-green-500" fill="currentColor" viewBox="0 0 8 8">
                                    <circle cx="4" cy="4" r="3" />
                                  </svg>
                                  Approved ${drug.fdaApproved.approvalDate ? `(${new Date(drug.fdaApproved.approvalDate).getFullYear()})` : ''}
                                </span>` : 
                                `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                  <svg class="mr-1.5 h-2 w-2 text-gray-400" fill="currentColor" viewBox="0 0 8 8">
                                    <circle cx="4" cy="4" r="3" />
                                  </svg>
                                  Not Approved
                                </span>`
                              }
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                              ${drug.emaApproved && drug.emaApproved.approved ? 
                                `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                  <svg class="mr-1.5 h-2 w-2 text-green-500" fill="currentColor" viewBox="0 0 8 8">
                                    <circle cx="4" cy="4" r="3" />
                                  </svg>
                                  Approved ${drug.emaApproved.approvalDate ? `(${new Date(drug.emaApproved.approvalDate).getFullYear()})` : ''}
                                </span>` : 
                                `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                  <svg class="mr-1.5 h-2 w-2 text-gray-400" fill="currentColor" viewBox="0 0 8 8">
                                    <circle cx="4" cy="4" r="3" />
                                  </svg>
                                  Not Approved
                                </span>`
                              }
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-gray-700">
                              ${drug.trialIds.map(id => 
                                `<span class="inline-block bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded mr-1 mb-1">${id}</span>`
                              ).join('')}
                            </td>
                          </tr>
                        `).join('')}
                      </tbody>
                    </table>
                  </div>` : 
                  `<p class="text-gray-600 italic">No drugs with successful late-phase trials found.</p>`
                }
              </div>
            </div>

            <div id="tab-failed" class="tab-pane hidden">
              <div>
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Failed Drugs (Terminated Trials)</h2>
                <div class="mb-4 p-3 bg-red-50 rounded-lg">
                  <p class="text-sm text-red-800">
                    <strong>Selection criteria:</strong> Drugs with terminated, suspended, or withdrawn trials that have no successful Phase 3 or 4 trials.
                  </p>
                </div>
                ${
                  summary.failedDrugs.length > 0 ? 
                  `<div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                      <thead class="bg-gray-50">
                        <tr>
                          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Drug Name</th>
                          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Terminated Trials</th>
                          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Latest Termination</th>
                          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Trial IDs</th>
                        </tr>
                      </thead>
                      <tbody class="bg-white divide-y divide-gray-200">
                        ${summary.failedDrugs.map((drug, idx) => `
                          <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900">
                                                       
  <a href="https://sunday-fsfq.onrender.com?drug=${encodeURIComponent(drug.name)}" class="text-blue-600 hover:text-blue-800 hover:underline">
    ${drug.name}
  </a>
</td>
                            <td class="px-6 py-4 whitespace-nowrap text-gray-700">${drug.terminatedTrials}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-gray-700">${drug.latestTerminatedYear}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-gray-700">
                              ${drug.trialIds.map(id => 
                                `<span class="inline-block bg-red-100 text-red-800 text-xs px-2 py-1 rounded mr-1 mb-1">${id}</span>`
                              ).join('')}
                            </td>
                          </tr>
                        `).join('')}
                      </tbody>
                    </table>
                  </div>` : 
                  `<p class="text-gray-600 italic">No drugs with terminated trials found.</p>`
                }
              </div>
            </div>

            <div id="tab-progress" class="tab-pane hidden">
              <div>
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Drugs In Progress (Active Trials)</h2>
                <div class="mb-4 p-3 bg-yellow-50 rounded-lg">
                  <p class="text-sm text-yellow-800">
                    <strong>Selection criteria:</strong> Drugs with ongoing trials (recruiting, active but not recruiting, etc.) that are neither in the successful nor failed categories.
                  </p>
                </div>
                ${
                  summary.drugsInProgress.length > 0 ? 
                  `<div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                      <thead class="bg-gray-50">
                        <tr>
                          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Drug Name</th>
                          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ongoing Trials</th>
                          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Phases</th>
                          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">FDA Status</th>
                          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">EMA Status</th>
                          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Trial IDs</th>
                        </tr>
                      </thead>
                      <tbody class="bg-white divide-y divide-gray-200">
                        ${summary.drugsInProgress.map((drug, idx) => `
                          <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900">
                                                            
  <a href="https://sunday-fsfq.onrender.com?drug=${encodeURIComponent(drug.name)}" class="text-blue-600 hover:text-blue-800 hover:underline">
    ${drug.name}
  </a>
</td>
                            <td class="px-6 py-4 whitespace-nowrap text-gray-700">${drug.ongoingTrials}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-gray-700">
                              ${drug.phases.map(phase => 
                                `<span class="inline-block bg-green-100 text-green-800 text-xs px-2 py-1 rounded mr-1">${phase.replace('PHASE', 'Phase ')}</span>`
                              ).join('')}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                              ${drug.fdaApproved && drug.fdaApproved.approved ? 
                               `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                  <svg class="mr-1.5 h-2 w-2 text-green-500" fill="currentColor" viewBox="0 0 8 8">
                                    <circle cx="4" cy="4" r="3" />
                                  </svg>
                                  Approved ${drug.fdaApproved.approvalDate ? `(${new Date(drug.fdaApproved.approvalDate).getFullYear()})` : ''}
                                </span>` : 
                                `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                  <svg class="mr-1.5 h-2 w-2 text-gray-400" fill="currentColor" viewBox="0 0 8 8">
                                    <circle cx="4" cy="4" r="3" />
                                  </svg>
                                  Not Approved
                                </span>`
                              }
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                              ${drug.emaApproved && drug.emaApproved.approved ? 
                                `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                  <svg class="mr-1.5 h-2 w-2 text-green-500" fill="currentColor" viewBox="0 0 8 8">
                                    <circle cx="4" cy="4" r="3" />
                                  </svg>
                                  Approved ${drug.emaApproved.approvalDate ? `(${new Date(drug.emaApproved.approvalDate).getFullYear()})` : ''}
                                </span>` : 
                                `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                  <svg class="mr-1.5 h-2 w-2 text-gray-400" fill="currentColor" viewBox="0 0 8 8">
                                    <circle cx="4" cy="4" r="3" />
                                  </svg>
                                  Not Approved
                                </span>`
                              }
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-gray-700">
                              ${drug.trialIds.map(id => 
                                `<span class="inline-block bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded mr-1 mb-1">${id}</span>`
                              ).join('')}
                            </td>
                          </tr>
                        `).join('')}
                      </tbody>
                    </table>
                  </div>` : 
                  `<p class="text-gray-600 italic">No drugs with ongoing trials found.</p>`
                }
              </div>
            </div>
          </div>
        </div>

        <!-- Summary -->
        <div class="bg-white p-6 rounded-lg shadow-md">
          <h2 class="text-xl font-semibold text-gray-800 mb-4">Summary</h2>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="bg-green-50 p-4 rounded-lg border border-green-200">
              <h3 class="font-semibold text-green-700 mb-2">Successful Drugs</h3>
              <p class="text-3xl font-bold text-green-800">${summary.successfulDrugs.length}</p>
              <p class="text-sm text-green-600 mt-2">Drugs with completed Phase 3/4 trials</p>
              ${
                summary.successfulDrugs.filter(d => d.fdaApproved && d.fdaApproved.approved).length > 0 || 
                summary.successfulDrugs.filter(d => d.emaApproved && d.emaApproved.approved).length > 0 ?
                `<div class="mt-3 pt-3 border-t border-green-200">
                  <p class="text-sm text-green-700">
                    <strong>FDA Approved:</strong> ${summary.successfulDrugs.filter(d => d.fdaApproved && d.fdaApproved.approved).length}
                  </p>
                  <p class="text-sm text-green-700">
                    <strong>EMA Approved:</strong> ${summary.successfulDrugs.filter(d => d.emaApproved && d.emaApproved.approved).length}
                  </p>
                </div>` : ''
              }
            </div>
            <div class="bg-red-50 p-4 rounded-lg border border-red-200">
              <h3 class="font-semibold text-red-700 mb-2">Failed Drugs</h3>
              <p class="text-3xl font-bold text-red-800">${summary.failedDrugs.length}</p>
              <p class="text-sm text-red-600 mt-2">Drugs with terminated trials</p>
            </div>
            <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
              <h3 class="font-semibold text-yellow-700 mb-2">In Progress</h3>
              <p class="text-3xl font-bold text-yellow-800">${summary.drugsInProgress.length}</p>
              <p class="text-sm text-yellow-600 mt-2">Drugs with active trials</p>
              ${
                summary.drugsInProgress.filter(d => d.fdaApproved && d.fdaApproved.approved).length > 0 || 
                summary.drugsInProgress.filter(d => d.emaApproved && d.emaApproved.approved).length > 0 ?
                `<div class="mt-3 pt-3 border-t border-yellow-200">
                  <p class="text-sm text-yellow-700">
                    <strong>FDA Approved:</strong> ${summary.drugsInProgress.filter(d => d.fdaApproved && d.fdaApproved.approved).length}
                  </p>
                  <p class="text-sm text-yellow-700">
                    <strong>EMA Approved:</strong> ${summary.drugsInProgress.filter(d => d.emaApproved && d.emaApproved.approved).length}
                  </p>
                </div>` : ''
              }
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
  
  // Set HTML content
  targetElement.innerHTML = html;
  
  // Add event listeners to tabs
  document.querySelectorAll('.tab-button').forEach(button => {
    button.addEventListener('click', (e) => {
      const tabName = e.target.dataset.tab;
      
      // Update active tab
      document.querySelectorAll('.tab-button').forEach(btn => {
        if (btn.dataset.tab === tabName) {
          btn.classList.add('bg-blue-50', 'text-blue-600', 'border-b-2', 'border-blue-500');
          btn.classList.remove('text-gray-600');
        } else {
          btn.classList.remove('bg-blue-50', 'text-blue-600', 'border-b-2', 'border-blue-500');
          btn.classList.add('text-gray-600');
        }
      });
      
      // Show/hide tab content
      document.querySelectorAll('.tab-pane').forEach(pane => {
        if (pane.id === `tab-${tabName}`) {
          pane.classList.remove('hidden');
          pane.classList.add('active');
        } else {
          pane.classList.add('hidden');
          pane.classList.remove('active');
        }
      });
    });
  });
}

/**
 * Helper function to show loading indicator
 * @param {String} targetElementId - ID of element to show loading in
 */
function showLoadingIndicator(targetElementId) {
  const targetElement = document.getElementById(targetElementId);
  if (!targetElement) return;
  
  targetElement.innerHTML = `
    <div class="flex items-center justify-center min-h-screen bg-gray-100">
      <div class="text-center p-6 bg-white rounded-lg shadow-lg">
        <div class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
        <p class="text-xl font-semibold text-gray-700">Loading trial data...</p>
      </div>
    </div>
  `;
}

/**
 * Main function to initialize the dashboard
 * @param {Object} conditionData - Data from extractConditionData function
 * @param {String} targetElementId - ID of element to inject UI into
 */
 async function initializeDrugDashboard(conditionData, targetElementId = 'clinical-trials-dashboard') {
  // Show loading indicator
  showLoadingIndicator(targetElementId);
  
  try {
    // Analyze data and create UI
    const summary = await analyzeTrialResults(conditionData, targetElementId);
    console.log('Dashboard initialized with data:', summary);
    return summary;
  } catch (error) {
    console.error('Error initializing dashboard:', error);
    const targetElement = document.getElementById(targetElementId);
    if (targetElement) {
      targetElement.innerHTML = `
        <div class="p-6 bg-red-50 rounded-lg text-center">
          <p class="text-red-700 font-semibold">Error loading clinical trials data</p>
          <p class="text-red-600 mt-2">${error.message}</p>
        </div>
      `;
    }
    throw error;
  }
}
// Example usage:
// 1. First extract the condition data using your existing function
// const conditionData = extractConditionData(studiesFromAPI, "Alzheimer's Disease");
// 
// 2. Then analyze the results to get successful and failed drugs
// const trialResults = analyzeTrialResults(conditionData);
// 
// 3. Access the results
// console.log("Successful drugs:", trialResults.successfulDrugs);
// console.log("Failed drugs:", trialResults.failedDrugs);
// console.log("Drugs still in trials:", trialResults.drugsInProgress);



/**
 * Renders the timeline visualization
 * @param {Object} data - Processed timeline data
 * @param {string} entityName - Name of drug or condition
 * @param {string} entityType - Either 'drug' or 'condition'
 */


// function renderTimelineVisualization(data, entityName, entityType = 'drug') {
//     const timelineElement = document.getElementById('usage-timeline');
    
//     // Determine which data field to use based on entity type
//     const dataField = entityType === 'drug' ? 'byCondition' : 'byDrug';
//     const itemType = entityType === 'drug' ? 'conditions' : 'treatments';
    
//     // Create array of items sorted by number of studies (most studied first)
//     const sortedItems = Object.keys(data[dataField])
//         .map(item => ({
//             name: item,
//             ...data[dataField][item]
//         }))
//         .sort((a, b) => b.count - a.count)
//         // Limit to top 15 items to avoid overcrowding
//         .slice(0, 15);
    
//     // Calculate timeline dimensions
//     const startYear = data.earliestStudyYear;
//     const endYear = data.latestStudyYear;
//     const yearSpan = endYear - startYear + 1;
    
//     // Generate the timeline HTML
//     let timelineHTML = `
//         <div class="mb-6">
//             <p class="text-sm text-gray-600">Based on analysis of ${data.totalStudies} clinical trials from ${startYear} to ${endYear}</p>
//             <p class="text-sm text-gray-500 mt-1">Showing top ${sortedItems.length} ${itemType} out of ${Object.keys(data[dataField]).length} total</p>
//         </div>
        
//         <div class="mb-4">
//             <input type="text" id="timeline-search" placeholder="Search ${itemType}..." 
//                    class="w-full p-2 border border-gray-300 rounded shadow-sm text-sm">
//         </div>
        
//         <div class="timeline-chart relative">
//             <!-- Year markers -->
//             <div class="year-markers flex justify-between text-xs text-gray-500 mb-2">
//     `;
    
//     // Add year markers (show at most 10 years to avoid overcrowding)
//     const yearStep = Math.max(1, Math.ceil(yearSpan / 10));
//     for (let year = startYear; year <= endYear; year += yearStep) {
//         const position = ((year - startYear) / yearSpan) * 100;
//         timelineHTML += `<div class="absolute" style="left: ${position}%">${year}</div>`;
//     }
    
//     timelineHTML += `
//             </div>
            
//             <!-- Timeline tracks -->
//             <div class="timeline-tracks space-y-6">
//     `;
    
//     // Generate a track for each item
//     sortedItems.forEach((item, index) => {
//         const startPosition = ((item.earliestYear - startYear) / yearSpan) * 100;
//         const endPosition = 100 - ((endYear - item.latestYear) / yearSpan) * 100;
//         const width = endPosition - startPosition;
        
//         // Generate a color based on the item index
//         const hue = (index * 137.5) % 360; // Golden ratio to distribute colors
//         const color = `hsl(${hue}, 70%, 60%)`;
//         const darkColor = `hsl(${hue}, 70%, 40%)`;
        
//         timelineHTML += `
//             <div class="item-track" data-item="${item.name.toLowerCase()}">
//                 <div class="flex flex-col md:flex-row md:justify-between md:items-baseline mb-1">
//                     <a href="#" class="item-link font-medium text-sm break-words text-blue-600 hover:text-blue-800 hover:underline" 
//                        data-item="${item.name}" data-type="${entityType === 'drug' ? 'condition' : 'drug'}">
//                         ${item.name}
//                     </a>
//                     <span class="text-xs text-gray-500">${item.count} ${item.count === 1 ? 'study' : 'studies'}</span>
//                 </div>
//                 <div class="relative h-8 bg-gray-100 rounded-full overflow-hidden">
//                     <div class="absolute h-full rounded-full" style="left: ${startPosition}%; width: ${width}%; background-color: ${color};">
//                         <div class="h-full flex items-center justify-center text-xs font-bold text-white whitespace-nowrap px-2 overflow-hidden">
//                             ${item.earliestYear} - ${item.latestYear}
//                         </div>
//                     </div>
//                 </div>
                
//                 <!-- Activity indicators -->
//                 <div class="relative h-1 mt-1">
//         `;
        
//         // Add activity indicators (small circles indicating study frequency)
//         Object.keys(item.years).forEach(year => {
//             const yearPosition = ((year - startYear) / yearSpan) * 100;
//             const studyCount = item.years[year];
//             const size = Math.min(12, Math.max(4, studyCount * 2)); // Scale based on study count
            
//             timelineHTML += `
//                 <div class="absolute rounded-full study-indicator cursor-pointer" 
//                      style="left: ${yearPosition}%; top: -${size/4}px; width: ${size}px; height: ${size}px; background-color: ${darkColor};"
//                      data-year="${year}" 
//                      data-count="${studyCount}"
//                      data-item="${item.name}"
//                      title="${year}: ${studyCount} ${studyCount === 1 ? 'study' : 'studies'} for ${item.name}">
//                 </div>
//             `;
//         });
        
//         timelineHTML += `
//                 </div>
//             </div>
//         `;
//     });
    
//     timelineHTML += `
//             </div>
//         </div>
        
//         <!-- View all button for when there are more than shown -->
//         ${Object.keys(data[dataField]).length > sortedItems.length ? `
//         <div class="mt-4 text-center">
//             <button id="view-all-items" class="px-4 py-2 bg-blue-50 text-blue-600 rounded hover:bg-blue-100 transition-colors text-sm">
//                 View All ${Object.keys(data[dataField]).length} ${itemType.charAt(0).toUpperCase() + itemType.slice(1)}
//             </button>
//         </div>
//         ` : ''}
        
//         <!-- Usage detail modal (will be created dynamically) -->
//         <div id="usage-detail-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4"></div>
        
//         <!-- Evolution insights -->
//         <div class="mt-8">
//             <h3 class="text-lg font-medium mb-3">Key Clinical Insights</h3>
//             <div class="evolution-patterns grid grid-cols-1 md:grid-cols-2 gap-4">
//     `;
    
//     // Generate insights based on the data
//     const insights = generateInsights(data, entityName, sortedItems, entityType);
    
//     insights.forEach(insight => {
//         timelineHTML += `
//             <div class="insight-card p-3 bg-gray-50 rounded-lg border border-gray-200">
//                 <div class="flex items-start">
//                     <div class="insight-icon mr-3 text-blue-500">
//                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
//                             <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
//                         </svg>
//                     </div>
//                     <p class="text-sm">${insight}</p>
//                 </div>
//             </div>
//         `;
//     });
    
//     timelineHTML += `
//             </div>
//         </div>
//     `;
    
//     // Update the timeline element
//     timelineElement.innerHTML = timelineHTML;
    
//     // Add event listeners
    
//     // 1. Search functionality
//     const searchInput = document.getElementById('timeline-search');
//     if (searchInput) {
//         searchInput.addEventListener('input', (e) => {
//             const searchTerm = e.target.value.toLowerCase();
//             const tracks = document.querySelectorAll('.item-track');
            
//             tracks.forEach(track => {
//                 const itemName = track.dataset.item;
//                 if (!searchTerm || itemName.includes(searchTerm)) {
//                     track.style.display = '';
//                 } else {
//                     track.style.display = 'none';
//                 }
//             });
//         });
//     }
    
//     // 2. View all button
//     const viewAllButton = document.getElementById('view-all-items');
//     if (viewAllButton) {
//         viewAllButton.addEventListener('click', () => {
//             // Show modal with all items
//             showAllItemsModal(data, entityName, entityType);
//         });
//     }
    
//     // 3. Item links (condition/drug names)
//     const itemLinks = document.querySelectorAll('.item-link');
//     itemLinks.forEach(link => {
//         link.addEventListener('click', (e) => {
//             e.preventDefault();
//             const itemName = e.target.dataset.item;
//             const itemType = e.target.dataset.type;
            
//             // Get the data for this item
//             const itemData = data[dataField][itemName];
            
//             if (itemData) {
//                 // Show detailed modal
//                 showUsageDetailModal(itemData, itemName, entityType);
//             } else {
//                 // Fallback to search
//                 if (typeof searchForEntity === 'function') {
//                     searchForEntity(itemName, itemType);
//                 } else {
//                     alert(`Search for ${itemType}: ${itemName}`);
//                     console.log(`Search for ${itemType}: ${itemName}`);
//                 }
//             }
//         });
//     });
    
//     // 4. Study indicators (dots)
//     const studyIndicators = document.querySelectorAll('.study-indicator');
//     studyIndicators.forEach(indicator => {
//         indicator.addEventListener('click', (e) => {
//             const item = e.target.dataset.item;
            
//             // Get the data for this item
//             const itemData = data[dataField][item];
            
//             if (itemData) {
//                 // Show detailed modal
//                 showUsageDetailModal(itemData, item, entityType);
//             }
//         });
//     });
// }
/**
 * Renders the timeline visualization with improved condition handling
 * @param {Object} data - Processed timeline data
 * @param {string} entityName - Name of drug or condition
 * @param {string} entityType - Either 'drug' or 'condition'
 */
 function renderTimelineVisualization(data, entityName, entityType = 'drug') {
    const timelineElement = document.getElementById('usage-timeline');
    
    // Determine which data field to use based on entity type
    const dataField = entityType === 'drug' ? 'byCondition' : 'byDrug';
    const itemType = entityType === 'drug' ? 'conditions' : 'treatments';
    
    // Create array of items sorted by number of studies (most studied first)
    const sortedItems = Object.keys(data[dataField])
        .map(item => ({
            name: item,
            ...data[dataField][item]
        }))
        .sort((a, b) => b.count - a.count)
        // Limit to top 15 items to avoid overcrowding
        .slice(0, 15);
    
    // Calculate timeline dimensions based ONLY on the displayed items
    // rather than using the global earliest/latest from all data
    let displayedEarliestYear = Infinity;
    let displayedLatestYear = -Infinity;
    
    sortedItems.forEach(item => {
        displayedEarliestYear = Math.min(displayedEarliestYear, item.earliestYear);
        displayedLatestYear = Math.max(displayedLatestYear, item.latestYear);
    });
    
    // Safety check in case there are no items
    if (displayedEarliestYear === Infinity) {
        displayedEarliestYear = data.earliestStudyYear;
    }
    if (displayedLatestYear === -Infinity) {
        displayedLatestYear = data.latestStudyYear;
    }
    
    // Add a small buffer on both sides for visual appeal (1-2 years)
    const bufferYears = Math.min(2, Math.floor((displayedLatestYear - displayedEarliestYear) * 0.05));
    displayedEarliestYear = Math.max(data.earliestStudyYear, displayedEarliestYear - bufferYears);
    displayedLatestYear = Math.min(data.latestStudyYear, displayedLatestYear + bufferYears);
    
    const yearSpan = displayedLatestYear - displayedEarliestYear + 1;
    
    // Generate the timeline HTML
    let timelineHTML = `
        <div class="mb-6">
            <p class="text-sm text-gray-600">Based on analysis of ${data.totalStudies} clinical trials from ${data.earliestStudyYear} to ${data.latestStudyYear}</p>
            <p class="text-sm text-gray-500 mt-1">Showing top ${sortedItems.length} ${itemType} out of ${Object.keys(data[dataField]).length} total</p>
            <p class="text-sm text-gray-500 mt-1">Timeline range: ${displayedEarliestYear} to ${displayedLatestYear}</p>
        </div>
        
        <div class="mb-4">
            <input type="text" id="timeline-search" placeholder="Search ${itemType}..." 
                   class="w-full p-2 border border-gray-300 rounded shadow-sm text-sm">
        </div>
        
        <div class="timeline-chart relative">
            <!-- Year markers -->
            <div class="year-markers flex justify-between text-xs text-gray-500 mb-2">
    `;
    
    // Add year markers (show at most 10 years to avoid overcrowding)
    const yearStep = Math.max(1, Math.ceil(yearSpan / 10));
    for (let year = displayedEarliestYear; year <= displayedLatestYear; year += yearStep) {
        const position = ((year - displayedEarliestYear) / yearSpan) * 100;
        timelineHTML += `<div class="absolute" style="left: ${position}%">${year}</div>`;
    }
    
    timelineHTML += `
            </div>
            
            <!-- Timeline tracks -->
            <div class="timeline-tracks space-y-6">
    `;
    
    // Generate a track for each item
    sortedItems.forEach((item, index) => {
        // Calculate positions based on the displayed year range, not the global range
        const startPosition = Math.max(0, ((item.earliestYear - displayedEarliestYear) / yearSpan) * 100);
        const endPosition = Math.min(100, 100 - ((displayedLatestYear - item.latestYear) / yearSpan) * 100);
        const width = endPosition - startPosition;
        
        // Generate a color based on the item index
        const hue = (index * 137.5) % 360; // Golden ratio to distribute colors
        const color = `hsl(${hue}, 70%, 60%)`;
        const darkColor = `hsl(${hue}, 70%, 40%)`;
        
        // Add success marker for successful treatments (only when viewing conditions)
        const successBadge = (entityType === 'condition' && item.isSuccessful) ? 
            `<span class="ml-2 text-xs bg-green-100 text-green-800 px-2 py-0.5 rounded-full">Successful</span>` : '';
        
        timelineHTML += `
            <div class="item-track" data-item="${item.name.toLowerCase()}">
                <div class="flex flex-col md:flex-row md:justify-between md:items-baseline mb-1">
                    <a href="#" class="item-link font-medium text-sm break-words text-blue-600 hover:text-blue-800 hover:underline" 
                       data-item="${item.name}" data-type="${entityType === 'drug' ? 'condition' : 'drug'}">
                        ${item.name} ${successBadge}
                    </a>
                    <span class="text-xs text-gray-500">${item.count} ${item.count === 1 ? 'study' : 'studies'}</span>
                </div>
                <div class="relative h-8 bg-gray-100 rounded-full overflow-hidden">
                    <div class="absolute h-full rounded-full" style="left: ${startPosition}%; width: ${width}%; background-color: ${item.isSuccessful ? '#10B981' : color};">
                        <div class="h-full flex items-center justify-center text-xs font-bold text-white whitespace-nowrap px-2 overflow-hidden">
                            ${item.earliestYear} - ${item.latestYear}
                        </div>
                    </div>
                </div>
                
                <!-- Activity indicators -->
                <div class="relative h-1 mt-1">
        `;
        
        // Add activity indicators (small circles indicating study frequency)
        Object.keys(item.years).forEach(year => {
            // Only show indicators for years within our displayed range
            if (year >= displayedEarliestYear && year <= displayedLatestYear) {
                const yearPosition = ((year - displayedEarliestYear) / yearSpan) * 100;
                const studyCount = item.years[year];
                const size = Math.min(12, Math.max(4, studyCount * 2)); // Scale based on study count
                
                timelineHTML += `
                    <div class="absolute rounded-full study-indicator cursor-pointer" 
                         style="left: ${yearPosition}%; top: -${size/4}px; width: ${size}px; height: ${size}px; background-color: ${item.isSuccessful ? '#047857' : darkColor};"
                         data-year="${year}" 
                         data-count="${studyCount}"
                         data-item="${item.name}"
                         title="${year}: ${studyCount} ${studyCount === 1 ? 'study' : 'studies'} for ${item.name}">
                    </div>
                `;
            }
        });
        
        timelineHTML += `
                </div>
            </div>
        `;
    });
    
    timelineHTML += `
            </div>
        </div>
        
        <!-- View all button for when there are more than shown -->
        ${Object.keys(data[dataField]).length > sortedItems.length ? `
        <div class="mt-4 text-center">
            <button id="view-all-items" class="px-4 py-2 bg-blue-50 text-blue-600 rounded hover:bg-blue-100 transition-colors text-sm">
                View All ${Object.keys(data[dataField]).length} ${itemType.charAt(0).toUpperCase() + itemType.slice(1)}
            </button>
        </div>
        ` : ''}
        
        <!-- Usage detail modal (will be created dynamically) -->
        <div id="usage-detail-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4"></div>
        
        <!-- Evolution insights -->
        <div class="mt-8">
            <h3 class="text-lg font-medium mb-3">Key Clinical Insights</h3>
            <div class="evolution-patterns grid grid-cols-1 md:grid-cols-2 gap-4">
    `;
    
    // Generate insights based on the data
    const insights = generateInsights(data, entityName, sortedItems, entityType);
    
    insights.forEach(insight => {
        timelineHTML += `
            <div class="insight-card p-3 bg-gray-50 rounded-lg border border-gray-200">
                <div class="flex items-start">
                    <div class="insight-icon mr-3 text-blue-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <p class="text-sm">${insight}</p>
                </div>
            </div>
        `;
    });
    
    timelineHTML += `
            </div>
        </div>
    `;
    
    // Update the timeline element
    timelineElement.innerHTML = timelineHTML;
    
    // Add event listeners
    
    // 1. Search functionality
    const searchInput = document.getElementById('timeline-search');
    if (searchInput) {
        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const tracks = document.querySelectorAll('.item-track');
            
            tracks.forEach(track => {
                const itemName = track.dataset.item;
                if (!searchTerm || itemName.includes(searchTerm)) {
                    track.style.display = '';
                } else {
                    track.style.display = 'none';
                }
            });
            
            // If this changes which items are displayed, we should update the timeline
            if (searchTerm) {
                const visibleTracks = Array.from(tracks).filter(track => track.style.display !== 'none');
                if (visibleTracks.length > 0 && visibleTracks.length < sortedItems.length) {
                    // Calculate new year range based on visible items
                    const visibleItemNames = visibleTracks.map(track => track.dataset.item);
                    const visibleItems = sortedItems.filter(item => 
                        visibleItemNames.includes(item.name.toLowerCase()));
                    
                    // Recalculate timeline with only visible items
                    if (visibleItems.length > 0) {
                        updateTimelineRange(visibleItems, displayedEarliestYear, displayedLatestYear, yearSpan);
                    }
                }
            } else {
                // Reset to original timeline display
                const yearMarkers = document.querySelectorAll('.year-markers .absolute');
                yearMarkers.forEach((marker, index) => {
                    const year = displayedEarliestYear + (index * yearStep);
                    const position = ((year - displayedEarliestYear) / yearSpan) * 100;
                    marker.style.left = `${position}%`;
                    marker.textContent = year;
                });
            }
        });
    }
    
    // 2. View all button
    const viewAllButton = document.getElementById('view-all-items');
    if (viewAllButton) {
        viewAllButton.addEventListener('click', () => {
            // Show modal with all items
            showAllItemsModal(data, entityName, entityType);
        });
    }
    
    // 3. Item links (condition/drug names)
    const itemLinks = document.querySelectorAll('.item-link');
    itemLinks.forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const itemName = e.target.dataset.item;
            const itemType = e.target.dataset.type;
            
            // Get the data for this item
            const itemData = data[dataField][itemName];
            
            if (itemData) {
                // Show detailed modal
                showUsageDetailModal(itemData, itemName, entityType);
            } else {
                // Fallback to search
                if (typeof searchForEntity === 'function') {
                    searchForEntity(itemName, itemType);
                } else {
                    alert(`Search for ${itemType}: ${itemName}`);
                    console.log(`Search for ${itemType}: ${itemName}`);
                }
            }
        });
    });
    
    // 4. Study indicators (dots)
    const studyIndicators = document.querySelectorAll('.study-indicator');
    studyIndicators.forEach(indicator => {
        indicator.addEventListener('click', (e) => {
            const item = e.target.dataset.item;
            
            // Get the data for this item
            const itemData = data[dataField][item];
            
            if (itemData) {
                // Show detailed modal
                showUsageDetailModal(itemData, item, entityType);
            }
        });
    });
}

/**
 * Updates the timeline year markers when the visible items change
 * @param {Array} visibleItems - Currently visible items
 * @param {number} originalEarliestYear - Original earliest year in display
 * @param {number} originalLatestYear - Original latest year in display
 * @param {number} originalYearSpan - Original year span
 */
function updateTimelineRange(visibleItems, originalEarliestYear, originalLatestYear, originalYearSpan) {
    // Calculate new year range based on visible items
    let newEarliestYear = Infinity;
    let newLatestYear = -Infinity;
    
    visibleItems.forEach(item => {
        newEarliestYear = Math.min(newEarliestYear, item.earliestYear);
        newLatestYear = Math.max(newLatestYear, item.latestYear);
    });
    
    // Safety check
    if (newEarliestYear === Infinity || newLatestYear === -Infinity) {
        return; // No visible items or error
    }
    
    // Add a small buffer
    const bufferYears = Math.min(2, Math.floor((newLatestYear - newEarliestYear) * 0.05));
    newEarliestYear = Math.max(newEarliestYear - bufferYears, originalEarliestYear);
    newLatestYear = Math.min(newLatestYear + bufferYears, originalLatestYear);
    
    const newYearSpan = newLatestYear - newEarliestYear + 1;
    
    // Update year markers
    const yearMarkers = document.querySelectorAll('.year-markers .absolute');
    const yearStep = Math.max(1, Math.ceil(newYearSpan / yearMarkers.length));
    
    yearMarkers.forEach((marker, index) => {
        const year = newEarliestYear + (index * yearStep);
        if (year <= newLatestYear) {
            const position = ((year - newEarliestYear) / newYearSpan) * 100;
            marker.style.left = `${position}%`;
            marker.textContent = year;
        }
    });
    
    // Update position of timeline bars and indicators for each visible item
    visibleItems.forEach(item => {
        const itemTrack = document.querySelector(`.item-track[data-item="${item.name.toLowerCase()}"]`);
        if (itemTrack) {
            // Update bar position
            const bar = itemTrack.querySelector('.relative > .absolute');
            if (bar) {
                const startPosition = Math.max(0, ((item.earliestYear - newEarliestYear) / newYearSpan) * 100);
                const endPosition = Math.min(100, 100 - ((newLatestYear - item.latestYear) / newYearSpan) * 100);
                const width = endPosition - startPosition;
                
                bar.style.left = `${startPosition}%`;
                bar.style.width = `${width}%`;
            }
            
            // Update indicators
            const indicators = itemTrack.querySelectorAll('.study-indicator');
            indicators.forEach(indicator => {
                const year = parseInt(indicator.dataset.year);
                if (year >= newEarliestYear && year <= newLatestYear) {
                    const yearPosition = ((year - newEarliestYear) / newYearSpan) * 100;
                    indicator.style.left = `${yearPosition}%`;
                    indicator.style.display = '';
                } else {
                    indicator.style.display = 'none';
                }
            });
        }
    });
}

// /**
//  * Renders the timeline visualization with improved condition handling
//  * @param {Object} data - Processed timeline data
//  * @param {string} entityName - Name of drug or condition
//  * @param {string} entityType - Either 'drug' or 'condition'
//  */
//  function renderTimelineVisualization(data, entityName, entityType = 'drug') {
//     const timelineElement = document.getElementById('usage-timeline');
    
//     // Determine which data field to use based on entity type
//     const dataField = entityType === 'drug' ? 'byCondition' : 'byDrug';
//     const itemType = entityType === 'drug' ? 'conditions' : 'treatments';
    
//     // Create array of items sorted by number of studies (most studied first)
//     const sortedItems = Object.keys(data[dataField])
//         .map(item => ({
//             name: item,
//             ...data[dataField][item]
//         }))
//         .sort((a, b) => b.count - a.count)
//         // Limit to top 15 items to avoid overcrowding
//         .slice(0, 15);
    
//     // Calculate timeline dimensions
//     const startYear = data.earliestStudyYear;
//     const endYear = data.latestStudyYear;
//     const yearSpan = endYear - startYear + 1;
    
//     // Generate the timeline HTML
//     let timelineHTML = `
//         <div class="mb-6">
//             <p class="text-sm text-gray-600">Based on analysis of ${data.totalStudies} clinical trials from ${startYear} to ${endYear}</p>
//             <p class="text-sm text-gray-500 mt-1">Showing top ${sortedItems.length} ${itemType} out of ${Object.keys(data[dataField]).length} total</p>
//         </div>
        
//         <div class="mb-4">
//             <input type="text" id="timeline-search" placeholder="Search ${itemType}..." 
//                    class="w-full p-2 border border-gray-300 rounded shadow-sm text-sm">
//         </div>
        
//         <div class="timeline-chart relative">
//             <!-- Year markers -->
//             <div class="year-markers flex justify-between text-xs text-gray-500 mb-2">
//     `;
    
//     // Add year markers (show at most 10 years to avoid overcrowding)
//     const yearStep = Math.max(1, Math.ceil(yearSpan / 10));
//     for (let year = startYear; year <= endYear; year += yearStep) {
//         const position = ((year - startYear) / yearSpan) * 100;
//         timelineHTML += `<div class="absolute" style="left: ${position}%">${year}</div>`;
//     }
    
//     timelineHTML += `
//             </div>
            
//             <!-- Timeline tracks -->
//             <div class="timeline-tracks space-y-6">
//     `;
    
//     // Generate a track for each item
//     sortedItems.forEach((item, index) => {
//         const startPosition = ((item.earliestYear - startYear) / yearSpan) * 100;
//         const endPosition = 100 - ((endYear - item.latestYear) / yearSpan) * 100;
//         const width = endPosition - startPosition;
        
//         // Generate a color based on the item index
//         const hue = (index * 137.5) % 360; // Golden ratio to distribute colors
//         const color = `hsl(${hue}, 70%, 60%)`;
//         const darkColor = `hsl(${hue}, 70%, 40%)`;
        
//         // Add success marker for successful treatments (only when viewing conditions)
//         const successBadge = (entityType === 'condition' && item.isSuccessful) ? 
//             `<span class="ml-2 text-xs bg-green-100 text-green-800 px-2 py-0.5 rounded-full">Successful</span>` : '';
        
//         timelineHTML += `
//             <div class="item-track" data-item="${item.name.toLowerCase()}">
//                 <div class="flex flex-col md:flex-row md:justify-between md:items-baseline mb-1">
//                     <a href="#" class="item-link font-medium text-sm break-words text-blue-600 hover:text-blue-800 hover:underline" 
//                        data-item="${item.name}" data-type="${entityType === 'drug' ? 'condition' : 'drug'}">
//                         ${item.name} ${successBadge}
//                     </a>
//                     <span class="text-xs text-gray-500">${item.count} ${item.count === 1 ? 'study' : 'studies'}</span>
//                 </div>
//                 <div class="relative h-8 bg-gray-100 rounded-full overflow-hidden">
//                     <div class="absolute h-full rounded-full" style="left: ${startPosition}%; width: ${width}%; background-color: ${item.isSuccessful ? '#10B981' : color};">
//                         <div class="h-full flex items-center justify-center text-xs font-bold text-white whitespace-nowrap px-2 overflow-hidden">
//                             ${item.earliestYear} - ${item.latestYear}
//                         </div>
//                     </div>
//                 </div>
                
//                 <!-- Activity indicators -->
//                 <div class="relative h-1 mt-1">
//         `;
        
//         // Add activity indicators (small circles indicating study frequency)
//         Object.keys(item.years).forEach(year => {
//             const yearPosition = ((year - startYear) / yearSpan) * 100;
//             const studyCount = item.years[year];
//             const size = Math.min(12, Math.max(4, studyCount * 2)); // Scale based on study count
            
//             timelineHTML += `
//                 <div class="absolute rounded-full study-indicator cursor-pointer" 
//                      style="left: ${yearPosition}%; top: -${size/4}px; width: ${size}px; height: ${size}px; background-color: ${item.isSuccessful ? '#047857' : darkColor};"
//                      data-year="${year}" 
//                      data-count="${studyCount}"
//                      data-item="${item.name}"
//                      title="${year}: ${studyCount} ${studyCount === 1 ? 'study' : 'studies'} for ${item.name}">
//                 </div>
//             `;
//         });
        
//         timelineHTML += `
//                 </div>
//             </div>
//         `;
//     });
    
//     timelineHTML += `
//             </div>
//         </div>
        
//         <!-- View all button for when there are more than shown -->
//         ${Object.keys(data[dataField]).length > sortedItems.length ? `
//         <div class="mt-4 text-center">
//             <button id="view-all-items" class="px-4 py-2 bg-blue-50 text-blue-600 rounded hover:bg-blue-100 transition-colors text-sm">
//                 View All ${Object.keys(data[dataField]).length} ${itemType.charAt(0).toUpperCase() + itemType.slice(1)}
//             </button>
//         </div>
//         ` : ''}
        
//         <!-- Usage detail modal (will be created dynamically) -->
//         <div id="usage-detail-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4"></div>
        
//         <!-- Evolution insights -->
//         <div class="mt-8">
//             <h3 class="text-lg font-medium mb-3">Key Clinical Insights</h3>
//             <div class="evolution-patterns grid grid-cols-1 md:grid-cols-2 gap-4">
//     `;
    
//     // Generate insights based on the data
//     const insights = generateInsights(data, entityName, sortedItems, entityType);
    
//     insights.forEach(insight => {
//         timelineHTML += `
//             <div class="insight-card p-3 bg-gray-50 rounded-lg border border-gray-200">
//                 <div class="flex items-start">
//                     <div class="insight-icon mr-3 text-blue-500">
//                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
//                             <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
//                         </svg>
//                     </div>
//                     <p class="text-sm">${insight}</p>
//                 </div>
//             </div>
//         `;
//     });
    
//     timelineHTML += `
//             </div>
//         </div>
//     `;
    
//     // Update the timeline element
//     timelineElement.innerHTML = timelineHTML;
    
//     // Add event listeners
    
//     // 1. Search functionality
//     const searchInput = document.getElementById('timeline-search');
//     if (searchInput) {
//         searchInput.addEventListener('input', (e) => {
//             const searchTerm = e.target.value.toLowerCase();
//             const tracks = document.querySelectorAll('.item-track');
            
//             tracks.forEach(track => {
//                 const itemName = track.dataset.item;
//                 if (!searchTerm || itemName.includes(searchTerm)) {
//                     track.style.display = '';
//                 } else {
//                     track.style.display = 'none';
//                 }
//             });
//         });
//     }
    
//     // 2. View all button
//     const viewAllButton = document.getElementById('view-all-items');
//     if (viewAllButton) {
//         viewAllButton.addEventListener('click', () => {
//             // Show modal with all items
//             showAllItemsModal(data, entityName, entityType);
//         });
//     }
    
//     // 3. Item links (condition/drug names)
//     const itemLinks = document.querySelectorAll('.item-link');
//     itemLinks.forEach(link => {
//         link.addEventListener('click', (e) => {
//             e.preventDefault();
//             const itemName = e.target.dataset.item;
//             const itemType = e.target.dataset.type;
            
//             // Get the data for this item
//             const itemData = data[dataField][itemName];
            
//             if (itemData) {
//                 // Show detailed modal
//                 showUsageDetailModal(itemData, itemName, entityType);
//             } else {
//                 // Fallback to search
//                 if (typeof searchForEntity === 'function') {
//                     searchForEntity(itemName, itemType);
//                 } else {
//                     alert(`Search for ${itemType}: ${itemName}`);
//                     console.log(`Search for ${itemType}: ${itemName}`);
//                 }
//             }
//         });
//     });
    
//     // 4. Study indicators (dots)
//     const studyIndicators = document.querySelectorAll('.study-indicator');
//     studyIndicators.forEach(indicator => {
//         indicator.addEventListener('click', (e) => {
//             const item = e.target.dataset.item;
            
//             // Get the data for this item
//             const itemData = data[dataField][item];
            
//             if (itemData) {
//                 // Show detailed modal
//                 showUsageDetailModal(itemData, item, entityType);
//             }
//         });
//     });
// }



/**
 * Shows a detailed modal for a specific usage (condition or drug)
 * @param {Object} itemData - Data for the specific item
 * @param {string} itemName - Name of the item (condition or drug)
 * @param {string} entityType - Type of the parent entity ('drug' or 'condition')
 */
// function showUsageDetailModal(itemData, itemName, entityType) {
//     // Get or create modal container
//     let modal = document.getElementById('usage-detail-modal');
//     if (!modal) {
//         modal = document.createElement('div');
//         modal.id = 'usage-detail-modal';
//         modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
//         document.body.appendChild(modal);
//     }
    
//     // Make sure modal is visible
//     modal.classList.remove('hidden');
    
//     // Determine relation type based on entity type
//     const relationType = entityType === 'drug' ? 'condition' : 'drug';
//     const relationTypeName = entityType === 'drug' ? 'Condition' : 'Treatment';
    
//     // Sort studies by year (newest first)
//     const sortedStudies = [...(itemData.studies || [])].sort((a, b) => b.year - a.year);
    
//     // Group studies by phase
//     const studiesByPhase = {};
//     sortedStudies.forEach(study => {
//         const phase = study.phase || 'Unknown';
//         if (!studiesByPhase[phase]) {
//             studiesByPhase[phase] = [];
//         }
//         studiesByPhase[phase].push(study);
//     });
    
//     // Get phase order for sorting
//     const phaseOrder = {
//         "PHASE4": 1,
//         "PHASE3": 2,
//         "PHASE2": 3,
//         "PHASE1_PHASE2": 4,
//         "PHASE1": 5,
//         "PRE_PHASE": 6,
//         "Unknown": 7
//     };
    
//     // Sort phases
//     const sortedPhases = Object.keys(studiesByPhase).sort((a, b) => 
//         (phaseOrder[a] || 999) - (phaseOrder[b] || 999)
//     );
    
//     // Create a heatmap data for years
//     const yearData = [];
//     const years = Object.keys(itemData.years || {}).map(Number).sort((a, b) => a - b);
    
//     // Find max studies in a year for scaling
//     const maxYearCount = Math.max(...Object.values(itemData.years || {}).map(count => Number(count)));
    
//     years.forEach(year => {
//         const count = itemData.years[year] || 0;
//         // Calculate color intensity based on count relative to max
//         const intensity = Math.floor((count / maxYearCount) * 100);
//         yearData.push({
//             year,
//             count,
//             intensity
//         });
//     });
    
//     // Create modal content
//     let modalContent = `
//         <div class="bg-white rounded-lg w-full max-w-5xl max-h-[90vh] overflow-hidden flex flex-col">
//             <div class="p-4 border-b bg-gray-50">
//                 <div class="flex justify-between items-center">
//                     <h3 class="text-xl font-bold">${itemName}</h3>
//                     <button id="close-usage-detail-modal" class="text-gray-500 hover:text-gray-700">
//                         <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
//                         </svg>
//                     </button>
//                 </div>
//                 <p class="text-sm text-gray-600">
//                     ${relationTypeName} studied from ${itemData.earliestYear} to ${itemData.latestYear} 
//                     (${itemData.count} total studies)
//                 </p>
//             </div>
            
//             <div class="overflow-y-auto">
//                 <!-- Quick stats -->
//                 <div class="grid grid-cols-1 md:grid-cols-3 gap-4 p-4 border-b">
//                     <div class="bg-blue-50 p-3 rounded-lg">
//                         <div class="text-sm text-blue-600 font-medium">First Studied</div>
//                         <div class="text-2xl font-bold">${itemData.earliestYear}</div>
//                         <div class="text-xs text-gray-500">${new Date().getFullYear() - itemData.earliestYear} years ago</div>
//                     </div>
                    
//                     <div class="bg-green-50 p-3 rounded-lg">
//                         <div class="text-sm text-green-600 font-medium">Total Studies</div>
//                         <div class="text-2xl font-bold">${itemData.count}</div>
//                         <div class="text-xs text-gray-500">Across ${years.length} years</div>
//                     </div>
                    
//                     <div class="bg-purple-50 p-3 rounded-lg">
//                         <div class="text-sm text-purple-600 font-medium">Latest Activity</div>
//                         <div class="text-2xl font-bold">${itemData.latestYear}</div>
//                         <div class="text-xs text-gray-500">${itemData.years[itemData.latestYear] || 0} studies in that year</div>
//                     </div>
//                 </div>
                
//                 <!-- Year activity heatmap -->
//                 <div class="p-4 border-b">
//                     <h4 class="text-lg font-medium mb-3">Research Activity by Year</h4>
//                     <div class="flex flex-wrap gap-1 justify-center">
//     `;
    
//     // Generate year blocks for heatmap
//     yearData.forEach(data => {
//         const blueIntensity = Math.min(255, Math.max(100, 220 - data.intensity * 1.5));
//         modalContent += `
//             <div class="relative group">
//                 <div class="w-10 h-10 flex items-center justify-center text-xs font-medium 
//                            ${data.intensity > 50 ? 'text-white' : 'text-gray-800'}" 
//                      style="background-color: rgb(0, 0, ${blueIntensity})">
//                     ${data.year}
//                 </div>
//                 <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-2 py-1 bg-gray-800 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition pointer-events-none whitespace-nowrap">
//                     ${data.count} studies in ${data.year}
//                 </div>
//             </div>
//         `;
//     });
    
//     modalContent += `
//                     </div>
//                 </div>
                
//                 <!-- Studies breakdown -->
//                 <div class="p-4">
//                     <h4 class="text-lg font-medium mb-3">Studies by Phase</h4>
//                     <div class="space-y-4">
//     `;
    
//     // Create phase sections
//     sortedPhases.forEach(phase => {
//         const phaseStudies = studiesByPhase[phase];
//         const formattedPhase = formatPhase(phase);
        
//         modalContent += `
//             <div class="border rounded-lg overflow-hidden">
//                 <div class="bg-gray-50 p-3 flex justify-between items-center">
//                     <div class="flex items-center">
//                         <span class="inline-block w-3 h-3 rounded-full mr-2" style="background-color: ${getPhaseColor(phase)}"></span>
//                         <h5 class="font-medium">${formattedPhase}</h5>
//                     </div>
//                     <span class="text-sm text-gray-500">${phaseStudies.length} studies</span>
//                 </div>
                
//                 <div class="divide-y divide-gray-100">
//         `;
        
//         // List studies in this phase
//         phaseStudies.forEach(study => {
//             modalContent += `
//                 <div class="p-3 hover:bg-gray-50">
//                     <div class="flex justify-between items-start mb-1">
//                         <a href="#" class="text-blue-600 hover:text-blue-800 font-medium study-link" data-nctid="${study.id}">
//                             ${study.title || 'Untitled Study'}
//                         </a>
//                         <span class="text-xs text-gray-500">${study.year}</span>
//                     </div>
//                     <div class="flex space-x-2 mt-2">
//                         <a href="#" class="text-sm text-blue-600 hover:text-blue-800 study-link" data-nctid="${study.id}">
//                             View Details
//                         </a>
//                         <span class="text-gray-300">|</span>
//                         <a href="https://clinicaltrials.gov/study/${study.id}" target="_blank" class="text-sm text-gray-600 hover:text-gray-800 flex items-center">
//                             <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
//                             </svg>
//                             ClinicalTrials.gov
//                         </a>
//                     </div>
//                 </div>
//             `;
//         });
        
//         modalContent += `
//                 </div>
//             </div>
//         `;
//     });
    
//     modalContent += `
//                     </div>
//                 </div>
//             </div>
            
//             <!-- Footer with export options -->
//             <div class="p-4 border-t bg-gray-50 flex justify-between items-center">
//                 <button id="export-usage-data" class="px-3 py-1.5 bg-blue-50 text-blue-600 rounded hover:bg-blue-100 transition-colors text-sm flex items-center">
//                     <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
//                     </svg>
//                     Export Data
//                 </button>
                
//                 <a href="#" class="px-3 py-1.5 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 transition-colors text-sm flex items-center" id="search-all-studies-link" data-item="${itemName}" data-type="${relationType}">
//                     <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
//                     </svg>
//                     View All Studies
//                 </a>
//             </div>
//         </div>
//     `;
    
//     // Insert modal content
//     modal.innerHTML = modalContent;
    
//     // Add event listeners
    
//     // 1. Close modal button
//     document.getElementById('close-usage-detail-modal').addEventListener('click', () => {
//         modal.classList.add('hidden');
//     });
    
//     // 2. Close when clicking outside
//     modal.addEventListener('click', (e) => {
//         if (e.target === modal) {
//             modal.classList.add('hidden');
//         }
//     });
    
//     // 3. Study links
//     const studyLinks = modal.querySelectorAll('.study-link');
//     studyLinks.forEach(link => {
//         link.addEventListener('click', (e) => {
//             e.preventDefault();
//             const nctId = e.target.dataset.nctid;
//             if (nctId) {
//                 // Close the modal
//                 modal.classList.add('hidden');
//                 // View study details
//                 viewStudyDetails(nctId);
//             }
//         });
//     });
    
//     // 4. Export data button
//     document.getElementById('export-usage-data').addEventListener('click', () => {
//         exportUsageData(itemData, itemName);
//     });
    
//     // 5. Search all studies link
//     document.getElementById('search-all-studies-link').addEventListener('click', (e) => {
//         e.preventDefault();
//         const searchItem = e.target.dataset.item;
//         const searchType = e.target.dataset.type;
        
//         // Close the modal
//         modal.classList.add('hidden');
        
//         // Trigger search for all studies
//         if (typeof searchForEntity === 'function') {
//             searchForEntity(searchItem, searchType);
//         } else {
//             alert(`Search for all studies with ${searchType}: ${searchItem}`);
//             console.log(`Search for all studies with ${searchType}: ${searchItem}`);
//         }
//     });
// }

/**
 * Shows a detailed modal for a specific usage (condition or drug)
 * @param {Object} itemData - Data for the specific item
 * @param {string} itemName - Name of the item (condition or drug)
 * @param {string} entityType - Type of the parent entity ('drug' or 'condition')
 */

 
// Add some CSS styles for enhanced UI
const style = document.createElement('style');
style.textContent = `
    #usage-detail-modal {
        backdrop-filter: blur(2px);
        transition: opacity 0.2s ease;
    }
    
    #usage-detail-modal .timeline-container {
        position: relative;
        overflow: hidden;
        box-shadow: inset 0 0 10px rgba(0,0,0,0.05);
        border-radius: 0.5rem;
        background: linear-gradient(to right, rgba(243,244,246,0.5) 0%, rgba(249,250,251,0.5) 100%);
        padding: 1.5rem;
        border: 1px solid #e5e7eb;
    }
    
    #usage-detail-modal .study-link {
        text-decoration: none;
        transition: all 0.2s ease;
    }
    
    #usage-detail-modal .study-link:hover {
        text-decoration: underline;
    }
    
    /* Pulse animation for timeline dots on hover */
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.2); }
        100% { transform: scale(1); }
    }
    
    #usage-detail-modal circle:hover {
        animation: pulse 1s infinite;
    }
    
    /* Smooth transitions for all elements */
    #usage-detail-modal * {
        transition: all 0.2s ease;
    }
    
    /* Enhanced scrollbar for the modal */
    #usage-detail-modal .overflow-y-auto::-webkit-scrollbar {
        width: 8px;
    }
    
    #usage-detail-modal .overflow-y-auto::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }
    
    #usage-detail-modal .overflow-y-auto::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 4px;
    }
    
    #usage-detail-modal .overflow-y-auto::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
    }
         #usage-detail-modal .timeline-container {
        position: relative;
        overflow: hidden;
        box-shadow: inset 0 0 10px rgba(0,0,0,0.05);
        border-radius: 0.5rem;
        background: linear-gradient(to bottom, rgba(255,255,255,0.5) 0%, rgba(249,250,251,0.8) 100%);
        padding: 1.5rem;
        border: 1px solid #e5e7eb;
    }
    
    /* Ensure year labels don't overlap */
    #timeline-years div {
        font-size: 10px;
        white-space: nowrap;
        transform: rotate(-45deg);
        transform-origin: top left;
        margin-bottom: 20px;
    }
    
    /* Improve tooltip visibility */
    #usage-detail-modal .absolute.z-10 {
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        border: 1px solid rgba(0,0,0,0.1);
    }
    
    /* Animation for zero-data years on hover */
    #usage-detail-modal .bar-group[data-count="0"]:hover rect:first-child {
        fill: #e5e7eb;
    }
`;

document.head.appendChild(style);

//  function showUsageDetailModal(itemData, itemName, entityType) {
//     // Get or create modal container
//     let modal = document.getElementById('usage-detail-modal');
//     if (!modal) {
//         modal = document.createElement('div');
//         modal.id = 'usage-detail-modal';
//         modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
//         document.body.appendChild(modal);
//     }
    
//     // Make sure modal is visible
//     modal.classList.remove('hidden');
    
//     // Determine relation type based on entity type
//     const relationType = entityType === 'drug' ? 'condition' : 'drug';
//     const relationTypeName = entityType === 'drug' ? 'Condition' : 'Treatment';
    
//     // Sort studies by year (newest first)
//     const sortedStudies = [...(itemData.studies || [])].sort((a, b) => b.year - a.year);
    
//     // Group studies by phase
//     const studiesByPhase = {};
//     sortedStudies.forEach(study => {
//         const phase = study.phase || 'Unknown';
//         if (!studiesByPhase[phase]) {
//             studiesByPhase[phase] = [];
//         }
//         studiesByPhase[phase].push(study);
//     });
    
//     // Get phase order for sorting
//     const phaseOrder = {
//         "PHASE4": 1,
//         "PHASE3": 2,
//         "PHASE2": 3,
//         "PHASE1_PHASE2": 4,
//         "PHASE1": 5,
//         "PRE_PHASE": 6,
//         "Unknown": 7
//     };
    
//     // Sort phases
//     const sortedPhases = Object.keys(studiesByPhase).sort((a, b) => 
//         (phaseOrder[a] || 999) - (phaseOrder[b] || 999)
//     );
    
//     // Create a heatmap data for years
//     const yearData = [];
//     const years = Object.keys(itemData.years || {}).map(Number).sort((a, b) => a - b);
    
//     // Find max studies in a year for scaling
//     const maxYearCount = Math.max(...Object.values(itemData.years || {}).map(count => Number(count)));
    
//     years.forEach(year => {
//         const count = itemData.years[year] || 0;
//         // Calculate color intensity based on count relative to max
//         const intensity = Math.floor((count / maxYearCount) * 100);
//         yearData.push({
//             year,
//             count,
//             intensity
//         });
//     });
    
//     // Check if this item is marked as successful (for condition-drug view)
//     const successBadge = itemData.isSuccessful ? 
//         `<span class="ml-2 text-xs bg-green-100 text-green-800 px-2 py-0.5 rounded-full">Successful Treatment</span>` : '';
    
//     // Create modal content
//     let modalContent = `
//         <div class="bg-white rounded-lg w-full max-w-5xl max-h-[90vh] overflow-hidden flex flex-col">
//             <div class="p-4 border-b bg-gray-50">
//                 <div class="flex justify-between items-center">
//                     <h3 class="text-xl font-bold">${itemName} ${successBadge}</h3>
//                     <button id="close-usage-detail-modal" class="text-gray-500 hover:text-gray-700">
//                         <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
//                         </svg>
//                     </button>
//                 </div>
//                 <p class="text-sm text-gray-600">
//                     ${relationTypeName} studied from ${itemData.earliestYear} to ${itemData.latestYear} 
//                     (${itemData.count} total studies)
//                 </p>
//             </div>
            
//             <div class="overflow-y-auto">
//                 <!-- Quick stats -->
//                 <div class="grid grid-cols-1 md:grid-cols-3 gap-4 p-4 border-b">
//                     <div class="bg-blue-50 p-3 rounded-lg">
//                         <div class="text-sm text-blue-600 font-medium">First Studied</div>
//                         <div class="text-2xl font-bold">${itemData.earliestYear}</div>
//                         <div class="text-xs text-gray-500">${new Date().getFullYear() - itemData.earliestYear} years ago</div>
//                     </div>
                    
//                     <div class="bg-green-50 p-3 rounded-lg">
//                         <div class="text-sm text-green-600 font-medium">Total Studies</div>
//                         <div class="text-2xl font-bold">${itemData.count}</div>
//                         <div class="text-xs text-gray-500">Across ${years.length} years</div>
//                     </div>
                    
//                     <div class="bg-purple-50 p-3 rounded-lg">
//                         <div class="text-sm text-purple-600 font-medium">Latest Activity</div>
//                         <div class="text-2xl font-bold">${itemData.latestYear}</div>
//                         <div class="text-xs text-gray-500">${itemData.years[itemData.latestYear] || 0} studies in that year</div>
//                     </div>
//                 </div>
                
//                 <!-- Year activity heatmap -->
//                 <div class="p-4 border-b">
//                     <h4 class="text-lg font-medium mb-3">Research Activity by Year</h4>
//                     <div class="flex flex-wrap gap-1 justify-center">
//     `;
    
//     // Generate year blocks for heatmap
//     yearData.forEach(data => {
//         const blueIntensity = Math.min(255, Math.max(100, 220 - data.intensity * 1.5));
//         modalContent += `
//             <div class="relative group">
//                 <div class="w-10 h-10 flex items-center justify-center text-xs font-medium 
//                            ${data.intensity > 50 ? 'text-white' : 'text-gray-800'}" 
//                      style="background-color: rgb(0, 0, ${blueIntensity})">
//                     ${data.year}
//                 </div>
//                 <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-2 py-1 bg-gray-800 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition pointer-events-none whitespace-nowrap">
//                     ${data.count} studies in ${data.year}
//                 </div>
//             </div>
//         `;
//     });
    
//     modalContent += `
//                     </div>
//                 </div>
                
//                 <!-- Studies breakdown -->
//                 <div class="p-4">
//                     <h4 class="text-lg font-medium mb-3">Studies by Phase</h4>
//                     <div class="space-y-4">
//     `;
    
//     // Create phase sections
//     sortedPhases.forEach(phase => {
//         const phaseStudies = studiesByPhase[phase];
//         const formattedPhase = formatPhase(phase);
        
//         modalContent += `
//             <div class="border rounded-lg overflow-hidden">
//                 <div class="bg-gray-50 p-3 flex justify-between items-center">
//                     <div class="flex items-center">
//                         <span class="inline-block w-3 h-3 rounded-full mr-2" style="background-color: ${getPhaseColor(phase)}"></span>
//                         <h5 class="font-medium">${formattedPhase}</h5>
//                     </div>
//                     <span class="text-sm text-gray-500">${phaseStudies.length} studies</span>
//                 </div>
                
//                 <div class="divide-y divide-gray-100">
//         `;
        
//         // List studies in this phase
//         phaseStudies.forEach(study => {
//             modalContent += `
//                 <div class="p-3 hover:bg-gray-50">
//                     <div class="flex justify-between items-start mb-1">
//                         <a href="#" class="text-blue-600 hover:text-blue-800 font-medium study-link" data-nctid="${study.id}">
//                             ${study.title || 'Untitled Study'}
//                         </a>
//                         <span class="text-xs text-gray-500">${study.year}</span>
//                     </div>
//                     <div class="flex space-x-2 mt-2">
//                         <a href="#" class="text-sm text-blue-600 hover:text-blue-800 study-link" data-nctid="${study.id}">
//                             View Details
//                         </a>
//                         <span class="text-gray-300">|</span>
//                         <a href="https://clinicaltrials.gov/study/${study.id}" target="_blank" class="text-sm text-gray-600 hover:text-gray-800 flex items-center">
//                             <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
//                             </svg>
//                             ClinicalTrials.gov
//                         </a>
//                     </div>
//                 </div>
//             `;
//         });
        
//         modalContent += `
//                 </div>
//             </div>
//         `;
//     });
    
//     modalContent += `
//                     </div>
//                 </div>
//             </div>
            
//             <!-- Footer with export options -->
//             <div class="p-4 border-t bg-gray-50 flex justify-between items-center">
//                 <button id="export-usage-data" class="px-3 py-1.5 bg-blue-50 text-blue-600 rounded hover:bg-blue-100 transition-colors text-sm flex items-center">
//                     <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
//                     </svg>
//                     Export Data
//                 </button>
                
//                 <a href="#" class="px-3 py-1.5 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 transition-colors text-sm flex items-center" id="search-all-studies-link" data-item="${itemName}" data-type="${relationType}">
//                     <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
//                     </svg>
//                     View All Studies
//                 </a>
//             </div>
//         </div>
//     `;
    
//     // Insert modal content
//     modal.innerHTML = modalContent;
    
//     // Add event listeners
    
//     // 1. Close modal button
//     document.getElementById('close-usage-detail-modal').addEventListener('click', () => {
//         modal.classList.add('hidden');
//     });
    
//     // 2. Close when clicking outside
//     modal.addEventListener('click', (e) => {
//         if (e.target === modal) {
//             modal.classList.add('hidden');
//         }
//     });
    
//     // 3. Study links
//     const studyLinks = modal.querySelectorAll('.study-link');
//     studyLinks.forEach(link => {
//         link.addEventListener('click', (e) => {
//             e.preventDefault();
//             const nctId = e.target.dataset.nctid;
//             if (nctId) {
//                 // Close the modal
//                 modal.classList.add('hidden');
//                 // View study details
//                 viewStudyDetails(nctId);
//             }
//         });
//     });
    
//     // 4. Export data button
//     document.getElementById('export-usage-data').addEventListener('click', () => {
//         exportUsageData(itemData, itemName);
//     });
    
//     // 5. Search all studies link
//     document.getElementById('search-all-studies-link').addEventListener('click', (e) => {
//         e.preventDefault();
//         const searchItem = e.target.dataset.item;
//         const searchType = e.target.dataset.type;
        
//         // Close the modal
//         modal.classList.add('hidden');
        
//         // Trigger search for all studies
//         if (typeof searchForEntity === 'function') {
//             searchForEntity(searchItem, searchType);
//         } else {
//             alert(`Search for all studies with ${searchType}: ${searchItem}`);
//             console.log(`Search for all studies with ${searchType}: ${searchItem}`);
//         }
//     });
// }

////////////////////////////////////////////////////////////////////////////////// clinical trial summary of approval //////////////////////////////////
// Function to fetch clinical trial details from backend
async function fetchClinicalTrialDetails(nctId) {
    try {
        // Replace with your actual backend endpoint
        const response = await fetch(`/api/clinical-trials/${nctId}`);
        if (!response.ok) {
            throw new Error(`Failed to fetch clinical trial details: ${response.status}`);
        }
        return await response.json();
    } catch (error) {
        console.error('Error fetching clinical trial details:', error);
        return null;
    }
}
async function createComprehensiveClinicalSummary(studies, drugName) {
    if (!studies || studies.length === 0) {
        return `
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
                <p class="text-yellow-700">No clinical trial data available to generate summary.</p>
            </div>
        `;
    }
    
    let fdaData = null;
    
    // Attempt to fetch FDA data for the drug
    try {
        const fdaResponse = await fetch(`/api/fda/drug/${encodeURIComponent(drugName)}`);
        if (fdaResponse.ok) {
            fdaData = await fdaResponse.json();
            console.log("Successfully fetched FDA data:", fdaData);
        } else {
            console.warn(`Failed to fetch FDA data for ${drugName}: ${fdaResponse.status}`);
        }
    } catch (error) {
        console.error(`Error fetching FDA data for ${drugName}:`, error);
    }
    
    // Process study details as before
    const studyDetails = [];
    for (const study of studies) {
        try {
            const response = await fetch(`${API_BASE_URL}/studies/${study.id}`);
            if (response.ok) {
                const responseData = await response.json();
                
                // Map the API response data structure as before
                if (responseData.success && responseData.data) {
                    const protocolSection = responseData.data.protocolSection || {};
                    const derivedSection = responseData.data.derivedSection || {};
                    
                    const details = {
                        // Basic information (same as before)
                        title: protocolSection.identificationModule?.officialTitle || protocolSection.identificationModule?.briefTitle,
                        status: protocolSection.statusModule?.overallStatus,
                        phase: protocolSection.designModule?.phases?.[0],
                        
                        // Study design and enrollment
                        enrollmentCount: protocolSection.designModule?.enrollmentInfo?.count || 0,
                        designInfo: protocolSection.designModel?.designInfo,
                        startDate: protocolSection.statusModule?.startDateStruct?.date,
                        completionDate: protocolSection.statusModule?.completionDateStruct?.date,
                        
                        // Conditions and interventions
                        conditions: protocolSection.conditionsModule?.conditions || [],
                        interventions: protocolSection.armsInterventionsModule?.interventions?.map(intervention => ({
                            type: intervention.type,
                            name: intervention.name,
                            description: intervention.description
                        })) || [],
                        
                        // Outcomes
                        primaryOutcomes: protocolSection.outcomesModule?.primaryOutcomes?.map(outcome => ({
                            measure: outcome.measure,
                            description: outcome.description,
                            timeFrame: outcome.timeFrame
                        })) || [],
                        secondaryOutcomes: protocolSection.outcomesModule?.secondaryOutcomes?.map(outcome => ({
                            measure: outcome.measure,
                            description: outcome.description,
                            timeFrame: outcome.timeFrame
                        })) || [],
                        
                        // Adverse events - using the extract function
                        adverseEvents: extractAdverseEvents(responseData.data),
                        
                        // Sponsor information
                        sponsor: protocolSection.sponsorCollaboratorsModule?.leadSponsor?.name
                    };
                    
                    studyDetails.push({
                        ...study,
                        details
                    });
                }
            } else {
                console.error(`Error fetching study ${study.id}: Response not OK`);
            }
        } catch (error) {
            console.error(`Error fetching details for study ${study.id}:`, error);
        }
    }
    
    // Extract and aggregate key information (same as before)
    const totalEnrollment = studyDetails.reduce((total, study) => {
        return total + (study.details?.enrollmentCount || 0);
    }, 0);
    
    const interventionTypes = new Set();
    studyDetails.forEach(study => {
        if (study.details?.interventions) {
            study.details.interventions.forEach(intervention => {
                if (intervention.type) interventionTypes.add(intervention.type);
            });
        }
    });
    
    const conditions = new Set();
    studyDetails.forEach(study => {
        if (study.details?.conditions) {
            study.details.conditions.forEach(condition => {
                conditions.add(condition);
            });
        }
    });
    
    // Process adverse events from FDA if available
    const fdaAdverseEvents = [];
    if (fdaData && fdaData.raw && fdaData.raw.endpoints && fdaData.raw.endpoints.event && fdaData.raw.endpoints.event.status === "success") {
        const eventData = fdaData.raw.endpoints.event.data;
        
        // Create a frequency map for adverse events
        const eventFrequency = {};
        
        eventData.forEach(report => {
            if (report.patient && report.patient.reaction) {
                report.patient.reaction.forEach(reaction => {
                    const term = reaction.reactionmeddrapt || 'Unspecified Reaction';
                    
                    if (!eventFrequency[term]) {
                        eventFrequency[term] = {
                            count: 0,
                            serious: 0,
                            reports: new Set()
                        };
                    }
                    
                    eventFrequency[term].count++;
                    eventFrequency[term].reports.add(report.safetyreportid || 'unknown');
                    
                    // Check if the report is marked as serious
                    if (report.serious === '1' || report.seriousnessdeath === '1' || 
                        report.seriousnesshospitalization === '1' || report.seriousnesslifethreatening === '1') {
                        eventFrequency[term].serious++;
                    }
                });
            }
        });
        
        // Convert to array and sort by frequency
        for (const [term, data] of Object.entries(eventFrequency)) {
            fdaAdverseEvents.push({
                term,
                count: data.count,
                serious: data.serious,
                reportCount: data.reports.size
            });
        }
        
        // Sort by count (most frequent first)
        fdaAdverseEvents.sort((a, b) => b.count - a.count);
    }
    
    // Extract FDA approval information
    let fdaApprovalInfo = null;
    if (fdaData && fdaData.categorized && Object.keys(fdaData.categorized).length > 0) {
        const categorizedDrugs = fdaData.categorized;
        const drugKey = Object.keys(categorizedDrugs)[0]; // Get the first drug entry
        
        if (drugKey && categorizedDrugs[drugKey]) {
            const strengthKey = Object.keys(categorizedDrugs[drugKey])[0]; // Get the first strength
            
            if (strengthKey && categorizedDrugs[drugKey][strengthKey] && categorizedDrugs[drugKey][strengthKey].length > 0) {
                const drugInfo = categorizedDrugs[drugKey][strengthKey][0];
                
                fdaApprovalInfo = {
                    brandName: drugInfo.brandName,
                    genericName: drugInfo.activeIngredients?.map(ing => ing.name).join(', ') || 'Not specified',
                    approvalDate: drugInfo.approvalDate,
                    applicationNumber: drugInfo.applicationNumber,
                    sponsorName: drugInfo.sponsorName,
                    fdaPage: drugInfo.fdaPage,
                    dosageForm: drugInfo.dosageForm,
                    route: drugInfo.route,
                    marketingStatus: drugInfo.marketingStatus
                };
            }
        }
    }
    
    // Process FDA label information for indications, warnings, etc.
    let fdaLabelInfo = null;
    if (fdaData && fdaData.raw && fdaData.raw.endpoints && fdaData.raw.endpoints.label && fdaData.raw.endpoints.label.status === "success") {
        const labelData = fdaData.raw.endpoints.label.data[0]; // Get the first label
        
        if (labelData) {
            fdaLabelInfo = {
                indications: labelData.indications_and_usage || [],
                contraindications: labelData.contraindications || [],
                warnings: labelData.boxed_warning || labelData.warnings || labelData.warnings_and_precautions || [],
                adverseReactions: labelData.adverse_reactions || [],
                drugInteractions: labelData.drug_interactions || []
            };
        }
    }
    
    // Process study adverse events as before
    const adverseEvents = [];
    studyDetails.forEach(study => {
        if (study.details?.adverseEvents) {
            study.details.adverseEvents.forEach(event => {
                adverseEvents.push({
                    term: event.term,
                    count: event.count,
                    serious: event.serious,
                    studyId: study.id
                });
            });
        }
    });
    
    // Organize adverse events by frequency
    const eventCounts = {};
    adverseEvents.forEach(event => {
        if (!eventCounts[event.term]) {
            eventCounts[event.term] = {
                total: 0,
                serious: 0,
                studies: new Set()
            };
        }
        eventCounts[event.term].total += event.count || 1;
        if (event.serious) eventCounts[event.term].serious += event.count || 1;
        eventCounts[event.term].studies.add(event.studyId);
    });
    
    // Sort adverse events by frequency
    const sortedEvents = Object.entries(eventCounts)
        .sort((a, b) => b[1].total - a[1].total)
        .slice(0, 10); // Top 10 most common events
    
    // Analyze primary outcomes
    const primaryOutcomes = [];
    studyDetails.forEach(study => {
        if (study.details?.primaryOutcomes) {
            study.details.primaryOutcomes.forEach(outcome => {
                primaryOutcomes.push({
                    measure: outcome.measure,
                    description: outcome.description,
                    timeFrame: outcome.timeFrame,
                    studyId: study.id,
                    year: study.year
                });
            });
        }
    });
    
    // Categorize studies by phase
    const phaseEnrollment = {};
    studyDetails.forEach(study => {
        const phase = study.phase || study.details?.phase || 'Unknown';
        if (!phaseEnrollment[phase]) {
            phaseEnrollment[phase] = 0;
        }
        phaseEnrollment[phase] += (study.details?.enrollmentCount || 0);
    });
    
    // Study status summary
    const statusCounts = {};
    studyDetails.forEach(study => {
        const status = study.details?.status || 'Unknown';
        if (!statusCounts[status]) {
            statusCounts[status] = 0;
        }
        statusCounts[status]++;
    });
    
    // Create the clinical summary section with FDA data
    return `
        <div class="bg-white border rounded-lg shadow-sm overflow-hidden mb-6">
            <div class="bg-gradient-to-r from-blue-50 to-white p-4 border-b">
                <h4 class="text-lg font-medium flex items-center text-gray-800">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                    </svg>
                    Comprehensive Clinical & Regulatory Summary: ${drugName}
                </h4>
            </div>
            
            <div class="p-4 bg-white">
                <!-- FDA Approval Information (if available) -->
                ${fdaApprovalInfo ? `
                <div class="mb-6">
                    <h5 class="font-medium text-gray-700 mb-3 border-b pb-2 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        FDA Approval Status
                    </h5>
                    <div class="bg-green-50 rounded-lg p-4 border border-green-100">
                        <div class="flex items-start">
                            <div class="bg-green-100 rounded-full p-2 mr-3">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </div>
                            <div>
                                <h6 class="font-medium text-gray-800 mb-1">${fdaApprovalInfo.brandName} (${fdaApprovalInfo.genericName})</h6>
                                <p class="text-sm text-gray-600">${fdaApprovalInfo.dosageForm} | ${fdaApprovalInfo.route} | ${fdaApprovalInfo.marketingStatus}</p>
                                <div class="mt-2 grid grid-cols-1 md:grid-cols-2 gap-2">
                                    <div>
                                        <span class="text-xs text-gray-500">Approval Date:</span>
                                        <span class="text-sm font-medium text-gray-700 ml-1">${formatDate(fdaApprovalInfo.approvalDate)}</span>
                                    </div>
                                    <div>
                                        <span class="text-xs text-gray-500">Application Number:</span>
                                        <span class="text-sm font-medium text-gray-700 ml-1">${fdaApprovalInfo.applicationNumber}</span>
                                    </div>
                                    <div>
                                        <span class="text-xs text-gray-500">Sponsor:</span>
                                        <span class="text-sm font-medium text-gray-700 ml-1">${fdaApprovalInfo.sponsorName}</span>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <a href="${fdaApprovalInfo.fdaPage}" target="_blank" class="text-sm text-blue-600 hover:text-blue-800 flex items-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                                        </svg>
                                        View FDA Drug Details
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                ` : ''}
                
                <!-- Enrollment & Study Scope -->
                <div class="mb-6">
                    <h5 class="font-medium text-gray-700 mb-3 border-b pb-2">Study Population & Scope</h5>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div class="bg-blue-50 rounded-lg p-4">
                            <div class="text-sm text-blue-600 mb-1 font-medium">Total Enrollment</div>
                            <div class="text-xl font-bold text-gray-800">${totalEnrollment} participants</div>
                            <div class="mt-1 text-xs text-gray-500">Across ${studies.length} clinical trials</div>
                        </div>
                        
                        <div class="bg-indigo-50 rounded-lg p-4">
                            <div class="text-sm text-indigo-600 mb-1 font-medium">Research Timespan</div>
                            <div class="text-xl font-bold text-gray-800">${Math.min(...studies.map(s => s.year))} - ${Math.max(...studies.map(s => s.year))}</div>
                            <div class="mt-1 text-xs text-gray-500">${Math.max(...studies.map(s => s.year)) - Math.min(...studies.map(s => s.year)) + 1} years of clinical research</div>
                        </div>
                        
                        <div class="bg-purple-50 rounded-lg p-4">
                            <div class="text-sm text-purple-600 mb-1 font-medium">Study Status</div>
                            <div class="flex flex-wrap gap-1 mt-1">
                                ${Object.entries(statusCounts).map(([status, count]) => 
                                    `<span class="px-2 py-1 rounded-full text-xs ${getStatusBadgeColor(status)}">
                                        ${status}: ${count}
                                    </span>`
                                ).join('')}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Conditions & Interventions -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-gray-50 rounded-lg p-4 border">
                        <h5 class="font-medium text-gray-700 mb-3">Conditions Studied</h5>
                        ${conditions.size > 0 ? 
                            `<ul class="space-y-2">
                                ${Array.from(conditions).map(condition => 
                                    `<li class="flex items-center">
                                        <span class="w-2 h-2 bg-blue-500 rounded-full mr-2"></span>
                                        <span class="text-gray-600">${condition}</span>
                                    </li>`
                                ).join('')}
                            </ul>` : 
                            `<p class="text-gray-500 italic">No condition information available</p>`
                        }
                    </div>
                    
                    <div class="bg-gray-50 rounded-lg p-4 border">
                        <h5 class="font-medium text-gray-700 mb-3">Intervention Types</h5>
                        ${interventionTypes.size > 0 ? 
                            `<ul class="space-y-2">
                                ${Array.from(interventionTypes).map(type => 
                                    `<li class="flex items-center">
                                        <span class="w-2 h-2 bg-green-500 rounded-full mr-2"></span>
                                        <span class="text-gray-600">${type}</span>
                                    </li>`
                                ).join('')}
                            </ul>` : 
                            `<p class="text-gray-500 italic">No intervention type information available</p>`
                        }
                    </div>
                </div>
                
                <!-- FDA Label Information (if available) -->
                ${fdaLabelInfo ? `
                <div class="mb-6">
                    <h5 class="font-medium text-gray-700 mb-3 border-b pb-2 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        FDA Label Information
                    </h5>
                    
                    <div class="space-y-4">
                        <!-- Indications -->
                        ${fdaLabelInfo.indications && fdaLabelInfo.indications.length > 0 ? `
                        <div class="bg-white border rounded-lg p-4">
                            <h6 class="font-medium text-gray-700 mb-2">Indications and Usage</h6>
                            <div class="text-sm text-gray-600 prose max-w-none">
                                ${formatFdaText(fdaLabelInfo.indications[0])}
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- Warnings -->
                        ${fdaLabelInfo.warnings && fdaLabelInfo.warnings.length > 0 ? `
                        <div class="bg-red-50 border border-red-100 rounded-lg p-4">
                            <h6 class="font-medium text-red-700 mb-2 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                </svg>
                                Warnings and Precautions
                            </h6>
                            <div class="text-sm text-red-600 prose max-w-none">
                                ${formatFdaText(fdaLabelInfo.warnings[0])}
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- Contraindications -->
                        ${fdaLabelInfo.contraindications && fdaLabelInfo.contraindications.length > 0 ? `
                        <div class="bg-orange-50 border border-orange-100 rounded-lg p-4">
                            <h6 class="font-medium text-orange-700 mb-2">Contraindications</h6>
                            <div class="text-sm text-orange-600 prose max-w-none">
                                ${formatFdaText(fdaLabelInfo.contraindications[0])}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                </div>
                ` : ''}
                
                <!-- Phase Distribution & Enrollment -->
                <div class="mb-6">
                    <h5 class="font-medium text-gray-700 mb-3 border-b pb-2">Clinical Trial Phases</h5>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-gray-50 p-4 rounded-lg border">
                            <h6 class="text-sm font-medium text-gray-700 mb-2">Trials by Phase</h6>
                            <div class="space-y-2">
                                ${Object.entries(phaseEnrollment).sort((a, b) => getPhaseOrder(a[0]) - getPhaseOrder(b[0])).map(([phase, count]) => 
                                    `<div class="flex items-center">
                                        <div class="w-24 text-sm font-medium text-gray-600">${formatPhase(phase)}</div>
                                        <div class="flex-1 bg-gray-200 rounded-full h-3 ml-2">
                                            <div class="bg-blue-500 h-3 rounded-full" style="width: ${Math.min(100, (count / totalEnrollment) * 100)}%"></div>
                                        </div>
                                        <div class="ml-2 text-sm text-gray-600 w-20 text-right">${count} patients</div>
                                    </div>`
                                ).join('')}
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 p-4 rounded-lg border">
                            <h6 class="text-sm font-medium text-gray-700 mb-2">Trial Progression</h6>
                            <p class="text-sm text-gray-600 mb-3">
                                ${getPhaseProgressionDescription(Object.keys(phaseEnrollment))}
                            </p>
                            <div class="flex justify-between items-center mt-4">
                                ${Object.keys(phaseEnrollment).sort((a, b) => getPhaseOrder(a) - getPhaseOrder(b)).map((phase, index, arr) => 
                                    `<div class="flex flex-col items-center">
                                        <div class="w-8 h-8 rounded-full ${index < arr.length - 1 ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-600'} flex items-center justify-center text-sm font-medium">
                                            ${getPhaseNumber(phase)}
                                        </div>
                                        <div class="text-xs text-gray-500 mt-1">${formatPhase(phase)}</div>
                                    </div>
                                    ${index < arr.length - 1 ? 
                                        `<div class="w-12 h-0.5 bg-gray-300"></div>` : 
                                        ''
                                    }`
                                ).join('')}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Primary Outcomes -->
                <div class="mb-6">
                    <h5 class="font-medium text-gray-700 mb-3 border-b pb-2">Key Primary Outcomes</h5>
                    ${primaryOutcomes.length > 0 ? 
                        `<div class="space-y-3">
                            ${primaryOutcomes.slice(0, 5).map(outcome => 
                                `<div class="bg-gray-50 rounded p-3 border-l-4 border-blue-400">
                                    <div class="font-medium text-gray-800">${outcome.measure || 'Unnamed outcome'}</div>
                                    ${outcome.description ? 
                                        `<p class="text-sm text-gray-600 mt-1">${outcome.description}</p>` : 
                                        ''}
                                    <div class="flex items-center mt-2 text-xs text-gray-500">
                                        ${outcome.timeFrame ? 
                                            `<span class="mr-3">Timeframe: ${outcome.timeFrame}</span>` : 
                                            ''}
                                        <span>Study year: ${outcome.year}</span>
                                    </div>
                                </div>`
                            ).join('')}
                            ${primaryOutcomes.length > 5 ? 
                                `<div class="text-sm text-gray-600 italic">
                                    +${primaryOutcomes.length - 5} more outcomes across all studies
                                </div>` : 
                                ''}
                        </div>` : 
                        `<p class="text-gray-500 italic p-3 bg-gray-50 rounded">No primary outcome information available</p>`
                    }
                </div>
                
                <!-- FDA Adverse Events (if available) -->
                ${fdaAdverseEvents.length > 0 ? `
                <div class="mb-6">
                    <h5 class="font-medium text-gray-700 mb-3 border-b pb-2 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                        </svg>
                        FDA Reported Adverse Events
                    </h5>
                    <p class="text-sm text-gray-600 mb-3">
                        The following adverse events have been reported to the FDA through its adverse event reporting system. 
                        These reports do not establish causality and represent post-marketing surveillance data.
                    </p>
                    <div class="bg-white p-0">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                       <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Adverse Event
                                        </th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Frequency
                                        </th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Serious Events
                                        </th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Reports
                                        </th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${fdaAdverseEvents.slice(0, 10).map(event => 
                                        `<tr class="hover:bg-gray-50">
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                                ${event.term}
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                ${event.count} occurrences
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                ${event.serious > 0 ? 
                                                    `<span class="text-red-600 font-medium">${event.serious} serious events</span>` : 
                                                    'None reported'}
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                ${event.reportCount} reports
                                            </td>
                                        </tr>`
                                    ).join('')}
                                </tbody>
                            </table>
                        </div>
                        <div class="p-3 text-sm text-gray-500 italic">
                            Showing top 10 of ${fdaAdverseEvents.length} reported adverse events. FDA adverse event reports are voluntarily submitted and may not reflect the total incidence.
                        </div>
                    </div>
                </div>
                ` : ''}
                
                <!-- Study Adverse Events (if available) -->
                <div class="mb-6">
                    <h5 class="font-medium text-gray-700 mb-3 border-b pb-2">Clinical Trial Safety Profile</h5>
                    ${sortedEvents.length > 0 ? 
                        `<div class="bg-white p-0">
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Adverse Event
                                            </th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Frequency
                                            </th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Serious Events
                                            </th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Studies Reported
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        ${sortedEvents.map(([term, data]) => 
                                            `<tr class="hover:bg-gray-50">
                                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                                    ${term}
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                    ${data.total} occurrences
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                    ${data.serious > 0 ? 
                                                        `<span class="text-red-600 font-medium">${data.serious} serious events</span>` : 
                                                        'None reported'}
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                    ${data.studies.size} ${data.studies.size === 1 ? 'study' : 'studies'}
                                                </td>
                                            </tr>`
                                        ).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>` : 
                        `<div class="bg-gray-50 rounded-lg p-4">
                            <div class="flex items-start">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-500 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <div>
                                    <p class="text-gray-800 font-medium">No Clinical Trial Adverse Event Data Available</p>
                                    <p class="text-sm text-gray-600 mt-1">
                                        Detailed safety information from clinical trials is not available in the current data set. This may be because:
                                        <ul class="list-disc ml-5 mt-2 space-y-1">
                                            <li>The studies are in early phases where adverse events aren't yet reported</li>
                                            <li>The complete safety data hasn't been published</li>
                                            <li>Safety data is available in the full clinical study reports but not in this summary</li>
                                        </ul>
                                        ${fdaAdverseEvents.length > 0 ? 
                                            `<p class="mt-2 text-sm font-medium">See the FDA Reported Adverse Events section above for post-marketing surveillance data.</p>` : 
                                            ''}
                                    </p>
                                </div>
                            </div>
                        </div>`
                    }
                </div>
                
                <!-- Key Findings -->
                <div class="mb-6">
                    <h5 class="font-medium text-gray-700 mb-3 border-b pb-2">Summary of Key Findings</h5>
                    <div class="bg-blue-50 border border-blue-100 rounded-lg p-4">
                        <p class="text-sm text-blue-800">
                            ${getKeyFindingsSummary(studies, phaseEnrollment, sortedEvents, primaryOutcomes, fdaApprovalInfo, fdaAdverseEvents)}
                        </p>
                        
                        <div class="mt-4 flex flex-col gap-2">
                            <div class="flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <span class="text-sm text-blue-800 font-medium">
                                    Development Status: ${fdaApprovalInfo ? 'FDA Approved' : getDevelopmentStatus(Object.keys(phaseEnrollment))}
                                </span>
                            </div>
                            
                            <div class="flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <span class="text-sm text-blue-800 font-medium">
                                    Research Duration: ${Math.max(...studies.map(s => s.year)) - Math.min(...studies.map(s => s.year)) + 1} years (${Math.min(...studies.map(s => s.year))} - ${Math.max(...studies.map(s => s.year))})
                                </span>
                            </div>
                            
                            <div class="flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <span class="text-sm text-blue-800 font-medium">
                                    Safety Overview: ${getSafetyOverview(sortedEvents, fdaAdverseEvents)}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="text-xs text-gray-500 italic mt-4">
                    Note: This comprehensive summary combines data from clinical trials and FDA regulatory information. 
                    The information synthesizes findings from ${studies.length} clinical trials spanning from ${Math.min(...studies.map(s => s.year))} to ${Math.max(...studies.map(s => s.year))}.
                    ${fdaData ? 'FDA data has been incorporated to provide regulatory context.' : ''}
                    For definitive approval information, please consult official regulatory sources.
                </div>
            </div>
        </div>
    `;
}

// Helper function to format FDA text content (handles list formatting, etc.)
function formatFdaText(text) {
    if (!text) return '';
    
    // Replace bullet points with HTML list items
    let formattedText = text;
    
    // Check if text has bullet points (common in FDA labels)
    if (text.includes('•') || text.includes('* ') || text.includes('- ')) {
        const lines = text.split(/\r?\n/);
        const bulletPattern = /^[\s]*(•|-|\*)\s+(.+)$/;
        
        let inList = false;
        let processedLines = [];
        
        for (const line of lines) {
            const bulletMatch = line.match(bulletPattern);
            
            if (bulletMatch) {
                if (!inList) {
                    processedLines.push('<ul class="list-disc pl-5 my-2">');
                    inList = true;
                }
                processedLines.push(`<li>${bulletMatch[2]}</li>`);
            } else {
                if (inList) {
                    processedLines.push('</ul>');
                    inList = false;
                }
                
                if (line.trim()) {
                    processedLines.push(`<p>${line}</p>`);
                }
            }
        }
        
        if (inList) {
            processedLines.push('</ul>');
        }
        
        formattedText = processedLines.join('');
    } else {
        // Just handle basic paragraphs
        formattedText = text.split(/\r?\n\r?\n/).map(p => `<p>${p}</p>`).join('');
    }
    
    return formattedText;
}

// Format date (if available)
function formatDate(dateString) {
    if (!dateString || dateString === 'Unknown') return 'Unknown';
    
    try {
        const date = new Date(dateString);
        
        // Check if date is valid
        if (isNaN(date.getTime())) {
            // If not a valid Date object, return original string
            return dateString;
        }
        
        // Format as Month DD, YYYY
        return date.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
    } catch (e) {
        return dateString; // Return original on error
    }
}

// Extract adverse events function
function extractAdverseEvents(studyData) {
    const events = [];
    
    // Try multiple possible locations where adverse events might be stored
    
    // Option 1: Check in reportedEvents section if it exists
    if (studyData.resultsSection && studyData.resultsSection.reportedEvents) {
        const reportedEvents = studyData.resultsSection.reportedEvents;
        
        // Process serious events
        if (reportedEvents.seriousEvents) {
            reportedEvents.seriousEvents.forEach(event => {
                events.push({
                    term: event.term || event.title || 'Unnamed serious event',
                    count: event.count || event.participants || 0,
                    serious: true,
                    category: event.category || 'Uncategorized'
                });
            });
        }
        
        // Process other events
        if (reportedEvents.otherEvents) {
            reportedEvents.otherEvents.forEach(event => {
                events.push({
                    term: event.term || event.title || 'Unnamed non-serious event',
                    count: event.count || event.participants || 0,
                    serious: false,
                    category: event.category || 'Uncategorized'
                });
            });
        }
    }
    
    // Option 2: Check in adverseEvents section if it exists
    if (studyData.adverseEvents || studyData.safetyData?.adverseEvents) {
        const adverseEvents = studyData.adverseEvents || studyData.safetyData?.adverseEvents || [];
        
        adverseEvents.forEach(event => {
            events.push({
                term: event.term || event.description || 'Unnamed event',
                count: event.count || event.frequency || event.occurrences || 0,
                serious: event.serious || event.isSeriousEvent || false,
                category: event.category || event.type || 'Uncategorized'
            });
        });
    }
    
    // Option 3: Check in safety results if it exists
    if (studyData.resultsSection && studyData.resultsSection.safetyResults) {
        const safetyResults = studyData.resultsSection.safetyResults;
        
        safetyResults.forEach(result => {
            if (result.events) {
                result.events.forEach(event => {
                    events.push({
                        term: event.term || event.title || 'Unnamed safety event',
                        count: event.count || event.participants || 0,
                        serious: event.serious || (event.severity === 'Serious') || false,
                        category: event.category || result.title || 'Safety'
                    });
                });
            }
        });
    }
    
    return events;
}

// Updated getSafetyOverview to incorporate FDA data
function getSafetyOverview(clinicalEvents, fdaEvents) {
    const hasClinicalEvents = clinicalEvents && clinicalEvents.length > 0;
    const hasFdaEvents = fdaEvents && fdaEvents.length > 0;
    
    if (!hasClinicalEvents && !hasFdaEvents) {
        return 'No adverse event data available';
    }
    
    let totalSeriousEvents = 0;
    
    if (hasClinicalEvents) {
        totalSeriousEvents += clinicalEvents.reduce((count, [_, data]) => count + data.serious, 0);
    }
    
    let fdaSeriousCount = 0;
    if (hasFdaEvents) {
        fdaSeriousCount = fdaEvents.reduce((count, event) => count + (event.serious || 0), 0);
    }
    
    // Combine both sources
    if (hasClinicalEvents && hasFdaEvents) {
        return `${totalSeriousEvents} serious events in clinical trials and ${fdaSeriousCount} in FDA reports`;
    } else if (hasClinicalEvents) {
        if (totalSeriousEvents === 0) {
            return 'No serious adverse events reported in clinical trials';
        } else if (totalSeriousEvents <= 3) {
            return `Limited serious adverse events (${totalSeriousEvents}) in clinical trials`;
        } else {
            return `Multiple serious adverse events (${totalSeriousEvents}) in clinical trials`;
        }
    } else {
        if (fdaSeriousCount === 0) {
            return 'No serious adverse events in FDA reports';
        } else if (fdaSeriousCount <= 3) {
            return `Limited serious adverse events (${fdaSeriousCount}) in FDA reports`;
        } else {
            return `Multiple serious adverse events (${fdaSeriousCount}) in FDA reports`;
        }
    }
}

//asasas Updated key findings summary to incorporate FDA data
function getKeyFindingsSummary(studies, phaseEnrollment, adverseEvents, primaryOutcomes, fdaApprovalInfo, fdaAdverseEvents) {
    const phases = Object.keys(phaseEnrollment);
    const hasLatePhase = phases.some(phase => phase === 'PHASE3' || phase === 'PHASE4');
    const hasMidPhase = phases.some(phase => phase === 'PHASE2' || phase === 'PHASE2_PHASE3');
    const totalEnrollment = Object.values(phaseEnrollment).reduce((sum, count) => sum + count, 0);
    
    let summary = `Based on the analysis of ${studies.length} clinical trials with a total enrollment of ${totalEnrollment} participants`;
    
    // If FDA approval data is available, mention it
    if (fdaApprovalInfo) {
        summary += `, this treatment received FDA approval on ${formatDate(fdaApprovalInfo.approvalDate)} (Application ${fdaApprovalInfo.applicationNumber}). `;
    } else {
        summary += `, `;
        
        if (hasLatePhase) {
            summary += `this treatment has advanced to late-stage clinical development. `;
            summary += `The trials include pivotal Phase 3 studies necessary for regulatory approval consideration. `;
        } else if (hasMidPhase) {
            summary += `this treatment has progressed to mid-stage clinical development. `;
            summary += `Phase 2 trials have been conducted to evaluate preliminary efficacy. `;
        } else {
            summary += `this treatment is in early-stage clinical development. `;
            summary += `Current research focuses primarily on safety assessment and dosing. `;
        }
    }
    
    if (primaryOutcomes.length > 0) {
        summary += `Key outcome measures include ${primaryOutcomes.slice(0, 3).map(o => o.measure).join(', ')}${primaryOutcomes.length > 3 ? ', and others' : ''}. `;
    }
    
    // Add combined safety information from both clinical trials and FDA data
    const hasClinicalSafety = adverseEvents && adverseEvents.length > 0;
    const hasFdaSafety = fdaAdverseEvents && fdaAdverseEvents.length > 0;
    
    if (hasClinicalSafety || hasFdaSafety) {
        summary += `Safety monitoring has identified adverse events `;
        
        if (hasClinicalSafety && hasFdaSafety) {
            const clinicalSeriousEvents = adverseEvents.reduce((count, [_, data]) => count + data.serious, 0);
            const fdaSeriousEvents = fdaAdverseEvents.reduce((count, event) => count + (event.serious || 0), 0);
            
            summary += `both in clinical trials (${clinicalSeriousEvents} serious events) and post-marketing surveillance (${fdaSeriousEvents} serious events in FDA reports). `;
        } else if (hasClinicalSafety) {
            const totalSeriousEvents = adverseEvents.reduce((count, [_, data]) => count + data.serious, 0);
            
            if (totalSeriousEvents > 0) {
                summary += `including ${totalSeriousEvents} serious events in clinical trials. `;
            } else {
                summary += `with no serious events reported in clinical trials. `;
            }
        } else {
            const fdaSeriousEvents = fdaAdverseEvents.reduce((count, event) => count + (event.serious || 0), 0);
            
            if (fdaSeriousEvents > 0) {
                summary += `including ${fdaSeriousEvents} serious events in FDA post-marketing reports. `;
            } else {
                summary += `with no serious events in FDA reports. `;
            }
        }
    }
    
    // If FDA label information is available, add a brief sentence
    if (fdaApprovalInfo) {
        summary += `The drug is currently marketed as ${fdaApprovalInfo.brandName} (${fdaApprovalInfo.genericName}) by ${fdaApprovalInfo.sponsorName}. `;
    }
    
    return summary;
}
// Function to create clinical summary from trial data
async function createClinicalSummary(studies) {
    // Container for all trial details
    const trialsData = [];
    
    // Fetch details for each trial
    for (const study of studies) {
        const trialDetails = await fetchClinicalTrialDetails(study.id);
        if (trialDetails) {
            trialsData.push({
                ...study,
                details: trialDetails
            });
        }
    }
    
    // Create the summary content
    let summaryHTML = `
        <div class="p-6 border-b">
            <h4 class="text-lg font-medium mb-4 flex items-center text-gray-800">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                </svg>
                Clinical Summary (Basis of Approval)
            </h4>
            <div class="space-y-5">`;
    
    if (trialsData.length === 0) {
        summaryHTML += `
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                    <p class="text-yellow-700">No detailed clinical information available for these studies.</p>
                </div>`;
    } else {
        // Create a card for each trial with detailed information
        trialsData.forEach(trial => {
            const details = trial.details;
            
            // Extract relevant information from trial details
            const status = details?.status || 'Unknown';
            const briefSummary = details?.briefSummary || 'No summary available';
            const interventions = details?.interventions || [];
            const outcomes = details?.primaryOutcomes || [];
            const eligibility = details?.eligibilityCriteria || 'Not specified';
            
            // Format the information in a clean, organized card
            summaryHTML += `
                <div class="border rounded-lg overflow-hidden shadow-sm hover:shadow transition-shadow">
                    <div class="bg-gradient-to-r from-blue-50 to-white p-3">
                        <h5 class="font-medium text-gray-800">${trial.title}</h5>
                        <div class="flex space-x-3 mt-2">
                            <span class="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full">${formatPhase(trial.phase)}</span>
                            <span class="text-xs bg-gray-100 text-gray-700 px-2 py-0.5 rounded-full">${trial.year}</span>
                            <span class="text-xs bg-${getStatusColor(status)} px-2 py-0.5 rounded-full">${status}</span>
                        </div>
                    </div>
                    
                    <div class="divide-y divide-gray-100">
                        <!-- Brief Summary Section -->
                        <div class="p-4">
                            <h6 class="text-sm font-medium text-gray-700 mb-2">Brief Summary</h6>
                            <p class="text-sm text-gray-600">${briefSummary}</p>
                        </div>
                        
                        <!-- Interventions Section -->
                        <div class="p-4">
                            <h6 class="text-sm font-medium text-gray-700 mb-2">Interventions</h6>
                            ${interventions.length > 0 ? 
                                `<ul class="text-sm text-gray-600 space-y-1 list-disc pl-5">
                                    ${interventions.map(intervention => 
                                        `<li>${intervention.name || 'Unnamed'} (${intervention.type || 'Not specified'})</li>`
                                    ).join('')}
                                </ul>` : 
                                `<p class="text-sm text-gray-500 italic">No intervention data available</p>`
                            }
                        </div>
                        
                        <!-- Outcomes Section -->
                        <div class="p-4">
                            <h6 class="text-sm font-medium text-gray-700 mb-2">Primary Outcomes</h6>
                            ${outcomes.length > 0 ? 
                                `<ul class="text-sm text-gray-600 space-y-2 list-disc pl-5">
                                    ${outcomes.map(outcome => 
                                        `<li>
                                            <div class="font-medium">${outcome.measure || 'Unnamed outcome'}</div>
                                            ${outcome.description ? `<div class="text-xs text-gray-500 mt-1">${outcome.description}</div>` : ''}
                                        </li>`
                                    ).join('')}
                                </ul>` : 
                                `<p class="text-sm text-gray-500 italic">No outcome data available</p>`
                            }
                        </div>
                        
                        <!-- Additional Details Link -->
                        <div class="p-3 bg-gray-50 flex justify-between items-center">
                            <a href="https://clinicaltrials.gov/study/${trial.id}" target="_blank" 
                               class="text-sm text-blue-600 hover:text-blue-800 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                                </svg>
                                Full Details on ClinicalTrials.gov
                            </a>
                            
                            <button data-nctid="${trial.id}" class="download-trial-pdf px-2 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 transition-colors text-xs flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                </svg>
                                PDF
                            </button>
                        </div>
                    </div>
                </div>`;
        });
    }
    
    summaryHTML += `
            </div>
        </div>
    `;
    
    return summaryHTML;
}

// Helper function to get color class based on trial status
function getStatusColor(status) {
    const statusLower = status.toLowerCase();
    if (statusLower.includes('completed')) return 'green-100 text-green-700';
    if (statusLower.includes('recruiting')) return 'blue-100 text-blue-700';
    if (statusLower.includes('active') || statusLower.includes('enrolling')) return 'purple-100 text-purple-700';
    if (statusLower.includes('terminated') || statusLower.includes('withdrawn')) return 'red-100 text-red-700';
    return 'gray-100 text-gray-700';
}

// Updated showUsageDetailModal function to include clinical summary
// async function showUsageDetailModal(itemData, itemName, entityType) {
//     // Get or create modal container
//     let modal = document.getElementById('usage-detail-modal');
//     if (!modal) {
//         modal = document.createElement('div');
//         modal.id = 'usage-detail-modal';
//         modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
//         document.body.appendChild(modal);
//     }
    
//     // Show loading state
//     modal.innerHTML = `
//         <div class="bg-white rounded-lg w-full max-w-5xl max-h-[90vh] overflow-hidden flex flex-col shadow-xl">
//             <div class="p-10 flex items-center justify-center">
//                 <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-500"></div>
//                 <span class="ml-3 text-gray-600">Loading clinical data...</span>
//             </div>
//         </div>
//     `;
    
//     // Make sure modal is visible
//     modal.classList.remove('hidden');
    
//     // Determine relation type based on entity type
//     const relationType = entityType === 'drug' ? 'condition' : 'drug';
//     const relationTypeName = entityType === 'drug' ? 'Condition' : 'Treatment';
    
//     // Sort studies by year (newest first)
//     const sortedStudies = [...(itemData.studies || [])].sort((a, b) => b.year - a.year);
    
//     // Group studies by phase
//     const studiesByPhase = {};
//     sortedStudies.forEach(study => {
//         const phase = study.phase || 'Unknown';
//         if (!studiesByPhase[phase]) {
//             studiesByPhase[phase] = [];
//         }
//         studiesByPhase[phase].push(study);
//     });
    
//     // Get phase order for sorting
//     const phaseOrder = {
//         "PHASE4": 1,
//         "PHASE3": 2,
//         "PHASE2": 3,
//         "PHASE1_PHASE2": 4,
//         "PHASE1": 5,
//         "PRE_PHASE": 6,
//         "Unknown": 7
//     };
    
//     // Sort phases
//     const sortedPhases = Object.keys(studiesByPhase).sort((a, b) => 
//         (phaseOrder[a] || 999) - (phaseOrder[b] || 999)
//     );
    
//     // Create timeline data for years
//     const yearData = [];
//     const years = Object.keys(itemData.years || {}).map(Number).sort((a, b) => a - b);
    
//     // Find max studies in a year for scaling
//     const maxYearCount = Math.max(...Object.values(itemData.years || {}).map(count => Number(count)));
    
//     years.forEach(year => {
//         const count = itemData.years[year] || 0;
//         yearData.push({
//             year,
//             count
//         });
//     });
    
//     // Check if this item is marked as successful (for condition-drug view)
//     const successBadge = itemData.isSuccessful ? 
//         `<span class="ml-2 text-xs bg-green-100 text-green-800 px-2 py-0.5 rounded-full">Successful Treatment</span>` : '';
    
//     // Create clinical summary section (async)
//     const clinicalSummaryHTML = await createClinicalSummary(sortedStudies);
    
//     // Create modal content
//     let modalContent = `
//         <div class="bg-white rounded-lg w-full max-w-5xl max-h-[90vh] overflow-hidden flex flex-col shadow-xl">
//             <div class="p-4 border-b bg-gradient-to-r from-blue-50 to-white">
//                 <div class="flex justify-between items-center">
//                     <h3 class="text-xl font-bold text-gray-800">${itemName} ${successBadge}</h3>
//                     <button id="close-usage-detail-modal" class="text-gray-500 hover:text-gray-700 transition-colors">
//                         <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
//                         </svg>
//                     </button>
//                 </div>
//                 <div class="flex items-center mt-1">
//                     <span class="text-sm text-gray-600 flex items-center">
//                         <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
//                         </svg>
//                         ${relationTypeName} studied from ${itemData.earliestYear} to ${itemData.latestYear} 
//                     </span>
//                     <div class="ml-3 px-2 py-0.5 bg-blue-100 text-blue-700 rounded-full text-xs font-medium">
//                         ${itemData.count} total studies
//                     </div>
//                 </div>
//             </div>
            
//             <div class="overflow-y-auto">
//                 <!-- Quick stats -->
//                 <div class="grid grid-cols-1 md:grid-cols-3 gap-4 p-4 border-b">
//                     <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-lg shadow-sm hover:shadow transition-shadow">
//                         <div class="text-sm text-blue-600 font-medium flex items-center">
//                             <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
//                             </svg>
//                             First Studied
//                         </div>
//                         <div class="text-2xl font-bold text-gray-800 mt-1">${itemData.earliestYear}</div>
//                         <div class="text-xs text-gray-500 mt-1">${new Date().getFullYear() - itemData.earliestYear} years ago</div>
//                     </div>
                    
//                     <div class="bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-lg shadow-sm hover:shadow transition-shadow">
//                         <div class="text-sm text-green-600 font-medium flex items-center">
//                             <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
//                             </svg>
//                             Total Studies
//                         </div>
//                         <div class="text-2xl font-bold text-gray-800 mt-1">${itemData.count}</div>
//                         <div class="text-xs text-gray-500 mt-1">Across ${years.length} years</div>
//                     </div>
                    
//                     <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-4 rounded-lg shadow-sm hover:shadow transition-shadow">
//                         <div class="text-sm text-purple-600 font-medium flex items-center">
//                             <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
//                             </svg>
//                             Latest Activity
//                         </div>
//                         <div class="text-2xl font-bold text-gray-800 mt-1">${itemData.latestYear}</div>
//                         <div class="text-xs text-gray-500 mt-1">${itemData.years[itemData.latestYear] || 0} studies in that year</div>
//                     </div>
//                 </div>
                
//                 <!-- Clinical Summary (Basis of Approval) -->
//                 ${clinicalSummaryHTML}
                
//                 <!-- Improved Timeline -->
//                 <div class="p-6 border-b">
//                     <h4 class="text-lg font-medium mb-2 flex items-center text-gray-800">
//                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
//                         </svg>
//                         Research Activity Timeline
//                     </h4>
//                     <p class="text-sm text-gray-600 mb-4">
//                         Showing all years from ${itemData.earliestYear} to ${itemData.latestYear} 
//                     </p>
                    
//                     <div class="timeline-container h-64 relative px-4">
//                         <!-- Will be populated by JavaScript -->
//                         <div id="research-timeline" class="h-full"></div>
                        
//                         <!-- Year labels will be dynamically added -->
//                         <div id="timeline-years" class="absolute bottom-0 left-0 right-0 flex justify-between text-xs text-gray-500"></div>
//                     </div>
//                 </div>
                
//                 <!-- Studies breakdown -->
//                 <div class="p-6">
//                     <h4 class="text-lg font-medium mb-4 flex items-center text-gray-800">
//                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
//                         </svg>
//                         Studies by Phase
//                     </h4>
                    
//                     <div class="space-y-5">
//     `;
    
//     // Create phase sections with improved styling
//     sortedPhases.forEach(phase => {
//         const phaseStudies = studiesByPhase[phase];
//         const formattedPhase = formatPhase(phase);
//         const phaseColor = getPhaseColor(phase);
        
//         modalContent += `
//             <div class="border rounded-lg overflow-hidden shadow-sm hover:shadow transition-shadow">
//                 <div class="bg-gray-50 p-3 flex justify-between items-center" style="border-left: 4px solid ${phaseColor}">
//                     <div class="flex items-center">
//                         <span class="inline-block w-3 h-3 rounded-full mr-2" style="background-color: ${phaseColor}"></span>
//                         <h5 class="font-medium text-gray-800">${formattedPhase}</h5>
//                     </div>
//                     <span class="text-sm bg-gray-200 text-gray-700 px-2 py-0.5 rounded-full">${phaseStudies.length} studies</span>
//                 </div>
                
//                 <div class="divide-y divide-gray-100">
//         `;
        
//         // List studies in this phase with improved styling
//         phaseStudies.forEach(study => {
//             modalContent += `
//                 <div class="p-4 hover:bg-blue-50 transition-colors">
//                     <div class="flex justify-between items-start mb-2">
//                         <a href="#" class="text-blue-600 hover:text-blue-800 font-medium study-link group" data-nctid="${study.id}">
//                             ${study.title || 'Untitled Study'}
//                             <span class="inline-block transition-transform group-hover:translate-x-1">→</span>
//                         </a>
//                         <div class="flex flex-col items-end">
//                             <span class="text-xs font-medium px-2 py-0.5 rounded bg-gray-100 text-gray-700">${study.year}</span>
//                         </div>
//                     </div>
//                     <div class="flex space-x-3 mt-2">
//                         <a href="#" class="text-sm text-blue-600 hover:text-blue-800 study-link flex items-center" data-nctid="${study.id}">
//                             <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
//                                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
//                             </svg>
//                             View Details
//                         </a>
//                         <a href="https://clinicaltrials.gov/study/${study.id}" target="_blank" class="text-sm text-gray-600 hover:text-gray-800 flex items-center">
//                             <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
//                             </svg>
//                             ClinicalTrials.gov
//                         </a>
//                     </div>
//                 </div>
//             `;
//         });
        
//         modalContent += `
//                 </div>
//             </div>
//         `;
//     });
    
//     modalContent += `
//                     </div>
//                 </div>
//             </div>
            
//             <!-- Footer with export options -->
//             <div class="p-4 border-t bg-gray-50 flex justify-between items-center">
//                 <button id="export-usage-data" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors text-sm flex items-center shadow-sm">
//                     <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
//                     </svg>
//                     Export Data
//                 </button>
                
//                 <a href="#" class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 transition-colors text-sm flex items-center shadow-sm" id="search-all-studies-link" data-item="${itemName}" data-type="${relationType}">
//                     <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
//                     </svg>
//                     View All Studies
//                 </a>
//             </div>
//         </div>
//     `;
    
//     // Insert modal content
//     modal.innerHTML = modalContent;
    
//     // Create the timeline visualization
//     createTimelineVisualization(yearData, maxYearCount);
    
//     // Add event listeners
    
//     // 1. Close modal button
//     document.getElementById('close-usage-detail-modal').addEventListener('click', () => {
//         modal.classList.add('hidden');
//     });
    
//     // 2. Close when clicking outside
//     modal.addEventListener('click', (e) => {
//         if (e.target === modal) {
//             modal.classList.add('hidden');
//         }
//     });
    
//     // 3. Study links
//     const studyLinks = modal.querySelectorAll('.study-link');
//     studyLinks.forEach(link => {
//         link.addEventListener('click', (e) => {
//             e.preventDefault();
//             const nctId = e.currentTarget.dataset.nctid;
//             if (nctId) {
//                 // Close the modal
//                 modal.classList.add('hidden');
//                 // View study details
//                 viewStudyDetails(nctId);
//             }
//         });
//     });
    
//     // 4. Export data button
//     document.getElementById('export-usage-data').addEventListener('click', () => {
//         exportUsageData(itemData, itemName);
//     });
    
//     // 5. Search all studies link
//     document.getElementById('search-all-studies-link').addEventListener('click', (e) => {
//         e.preventDefault();
//         const searchItem = e.currentTarget.dataset.item;
//         const searchType = e.currentTarget.dataset.type;
        
//         // Close the modal
//         modal.classList.add('hidden');
        
//         // Trigger search for all studies
//         if (typeof searchForEntity === 'function') {
//             searchForEntity(searchItem, searchType);
//         } else {
//             alert(`Search for all studies with ${searchType}: ${searchItem}`);
//             console.log(`Search for all studies with ${searchType}: ${searchItem}`);
//         }
//     });
    
//     // 6. PDF download buttons
//     const pdfButtons = modal.querySelectorAll('.download-trial-pdf');
//     pdfButtons.forEach(button => {
//         button.addEventListener('click', (e) => {
//             e.preventDefault();
//             const nctId = e.currentTarget.dataset.nctid;
//             if (nctId) {
//                 downloadTrialPDF(nctId);
//             }
//         });
//     });
// }

// Function to download trial PDF summary
function downloadTrialPDF(nctId) {
    // Replace with your actual endpoint to generate and download PDF
    window.open(`/api/clinical-trials/${nctId}/pdf`, '_blank');
}

// Continuation of formatPhase function
function formatPhase(phase) {
    switch(phase) {
        case 'PHASE1': return 'Phase 1';
        case 'PHASE2': return 'Phase 2';
        case 'PHASE3': return 'Phase 3';
        case 'PHASE4': return 'Phase 4';
        case 'PHASE1_PHASE2': return 'Phase 1/2';
        case 'PHASE2_PHASE3': return 'Phase 2/3';
        case 'PRE_PHASE': return 'Pre-Clinical';
        default: return phase;
    }
}

// Helper function to get color for phase
function getPhaseColor(phase) {
    switch(phase) {
        case 'PHASE4': return '#4CAF50'; // Green
        case 'PHASE3': return '#2196F3'; // Blue
        case 'PHASE2': return '#FF9800'; // Orange
        case 'PHASE1_PHASE2': return '#9C27B0'; // Purple
        case 'PHASE2_PHASE3': return '#3F51B5'; // Indigo
        case 'PHASE1': return '#F44336'; // Red
        case 'PRE_PHASE': return '#795548'; // Brown
        default: return '#9E9E9E'; // Gray
    }
}

// Timeline visualization function
function createTimelineVisualization(yearData, maxYearCount) {
    const timelineContainer = document.getElementById('research-timeline');
    const timelineYears = document.getElementById('timeline-years');
    
    if (!timelineContainer || !timelineYears) return;
    
    // Clear previous content
    timelineContainer.innerHTML = '';
    timelineYears.innerHTML = '';
    
    // If no data, show a message
    if (yearData.length === 0) {
        timelineContainer.innerHTML = `
            <div class="flex items-center justify-center h-full text-gray-500">
                No timeline data available
            </div>
        `;
        return;
    }
    
    // Get min and max years to create a full range
    const minYear = Math.min(...yearData.map(d => d.year));
    const maxYear = Math.max(...yearData.map(d => d.year));
    
    // Create a complete range of years
    const fullYearRange = [];
    for (let year = minYear; year <= maxYear; year++) {
        const existingData = yearData.find(d => d.year === year);
        fullYearRange.push({
            year,
            count: existingData ? existingData.count : 0
        });
    }
    
    // Create the bars
    const barWidth = `calc(${100 / fullYearRange.length}% - 4px)`;
    
    fullYearRange.forEach((yearItem, index) => {
        // Create bar element
        const barHeight = yearItem.count ? `${(yearItem.count / maxYearCount) * 100}%` : '2px';
        const bar = document.createElement('div');
        bar.className = 'inline-block bg-blue-500 rounded-t hover:bg-blue-600 transition-all relative';
        bar.style.width = barWidth;
        bar.style.height = barHeight;
        bar.style.marginRight = '4px';
        
        // Add tooltip
        bar.title = `${yearItem.year}: ${yearItem.count} studies`;
        
        // Add hover effect with count
        if (yearItem.count > 0) {
            bar.innerHTML = `
                <div class="opacity-0 hover:opacity-100 absolute bottom-full mb-1 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white text-xs rounded px-2 py-1 pointer-events-none transition-opacity whitespace-nowrap">
                    ${yearItem.year}: ${yearItem.count} studies
                </div>
            `;
        }
        
        timelineContainer.appendChild(bar);
        
        // Add year label (for every 3rd year to avoid crowding, or all if few years)
        if (fullYearRange.length <= 10 || index % 3 === 0 || index === fullYearRange.length - 1) {
            const yearLabel = document.createElement('div');
            yearLabel.className = 'text-xs text-gray-500';
            yearLabel.style.width = barWidth;
            yearLabel.style.marginRight = '4px';
            yearLabel.textContent = yearItem.year;
            timelineYears.appendChild(yearLabel);
        } else {
            // Add empty space to maintain alignment
            const spacer = document.createElement('div');
            spacer.style.width = barWidth;
            spacer.style.marginRight = '4px';
            timelineYears.appendChild(spacer);
        }
    });
    
    // Add a final empty div to the timeline to push everything left (flexbox)
    const finalSpacer = document.createElement('div');
    finalSpacer.className = 'flex-grow';
    timelineContainer.appendChild(finalSpacer);
}

// Function to generate basis of approval summary
async function generateBasisOfApproval(studies) {
    if (!studies || studies.length === 0) {
        return { 
            html: '<p class="text-gray-500 italic">No studies available for approval basis analysis.</p>',
            status: 'unknown'
        };
    }
    
    // Check for Phase 3 or 4 studies which generally indicate approval
    const laterPhaseStudies = studies.filter(study => 
        study.phase === 'PHASE3' || study.phase === 'PHASE4'
    );
    
    // Sort studies by year (most recent first)
    const sortedStudies = [...studies].sort((a, b) => b.year - a.year);
    const latestStudy = sortedStudies[0];
    const earliestStudy = sortedStudies[sortedStudies.length - 1];
    
    // Attempt to determine approval status
    let approvalStatus = 'pending';
    let approvalYear = null;
    let approvalRationale = '';
    
    if (laterPhaseStudies.length > 0) {
        approvalStatus = 'likely_approved';
        const latestApprovalStudy = laterPhaseStudies.sort((a, b) => b.year - a.year)[0];
        approvalYear = latestApprovalStudy.year;
        approvalRationale = `Based on completed ${formatPhase(latestApprovalStudy.phase)} study in ${approvalYear}`;
    } else if (studies.some(s => s.phase === 'PHASE2')) {
        approvalStatus = 'in_development';
        approvalRationale = 'Clinical trials ongoing, Phase 2 studies present';
    } else {
        approvalStatus = 'early_stage';
        approvalRationale = 'Only early phase studies detected';
    }
    
    // Generate HTML for the summary
    let summaryHTML = `
        <div class="bg-white border rounded-lg shadow-sm p-4 mb-4">
            <h5 class="font-medium text-gray-800 mb-3 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                Approval Summary
            </h5>
            
            <div class="flex items-center mb-3">
                <div class="text-sm font-medium mr-2">Status:</div>
                <span class="px-2 py-1 rounded-full text-xs ${getApprovalStatusColor(approvalStatus)}">
                    ${formatApprovalStatus(approvalStatus)}
                </span>
            </div>
            
            ${approvalYear ? `
                <div class="flex items-center mb-3">
                    <div class="text-sm font-medium mr-2">Likely Approval Year:</div>
                    <span class="text-sm">${approvalYear}</span>
                </div>
            ` : ''}
            
            <div class="mb-3">
                <div class="text-sm font-medium mb-1">Rationale:</div>
                <p class="text-sm text-gray-600">${approvalRationale}</p>
            </div>
            
            <div class="mb-3">
                <div class="text-sm font-medium mb-1">Study Timeline:</div>
                <p class="text-sm text-gray-600">First studied in ${earliestStudy.year}, latest study in ${latestStudy.year}</p>
            </div>
            
            <div class="text-xs text-gray-500 mt-3 italic">
                This is an automated assessment based on available clinical trial data and may not reflect actual regulatory status.
            </div>
        </div>
    `;
    
    return {
        html: summaryHTML,
        status: approvalStatus
    };
}

// Helper function to format approval status
function formatApprovalStatus(status) {
    switch(status) {
        case 'likely_approved': return 'Likely Approved';
        case 'in_development': return 'In Development';
        case 'early_stage': return 'Early Stage Research';
        case 'pending': return 'Status Pending';
        default: return 'Unknown Status';
    }
}

// Helper function to get color classes for approval status
function getApprovalStatusColor(status) {
    switch(status) {
        case 'likely_approved': return 'bg-green-100 text-green-800';
        case 'in_development': return 'bg-blue-100 text-blue-800';
        case 'early_stage': return 'bg-yellow-100 text-yellow-800';
        case 'pending': return 'bg-gray-100 text-gray-800';
        default: return 'bg-gray-100 text-gray-800';
    }
}

// Function to export usage data to CSV
function exportUsageData(itemData, itemName) {
    // Create CSV content
    let csvContent = "data:text/csv;charset=utf-8,";
    
    // Add header row
    csvContent += "Study ID,Title,Phase,Year\n";
    
    // Add study data
    itemData.studies.forEach(study => {
        csvContent += `${study.id},"${study.title.replace(/"/g, '""')}",${study.phase},${study.year}\n`;
    });
    
    // Create download link
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", `${itemName.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_studies.csv`);
    document.body.appendChild(link);
    
    // Trigger download
    link.click();
    
    // Clean up
    document.body.removeChild(link);
}

// Function to extract key information from a clinical trial
function extractTrialHighlights(trialDetails) {
    if (!trialDetails) return null;
    
    // Extract important data points
    const highlights = {
        designFeatures: [],
        keyOutcomes: [],
        safetyInfo: []
    };
    
    // Study design features
    if (trialDetails.studyType) {
        highlights.designFeatures.push(`Study Type: ${trialDetails.studyType}`);
    }
    
    if (trialDetails.allocation) {
        highlights.designFeatures.push(`Allocation: ${trialDetails.allocation}`);
    }
    
    if (trialDetails.interventionModel) {
        highlights.designFeatures.push(`Model: ${trialDetails.interventionModel}`);
    }
    
    if (trialDetails.masking) {
        highlights.designFeatures.push(`Masking: ${trialDetails.masking}`);
    }
    
    if (trialDetails.enrollmentCount) {
        highlights.designFeatures.push(`Enrollment: ${trialDetails.enrollmentCount} participants`);
    }
    
    // Key outcomes from primary outcomes
    if (trialDetails.primaryOutcomes && trialDetails.primaryOutcomes.length) {
        trialDetails.primaryOutcomes.forEach(outcome => {
            if (outcome.measure) {
                highlights.keyOutcomes.push(outcome.measure);
            }
        });
    }
    
    // Safety information
    if (trialDetails.adverseEvents && trialDetails.adverseEvents.length) {
        trialDetails.adverseEvents.slice(0, 3).forEach(event => {
            highlights.safetyInfo.push(`${event.term} (${event.count} occurrences)`);
        });
    }
    
    return highlights;
}

// Function to view detailed study information
async function viewStudyDetails(nctId) {
    try {
        // Show loading state
        const loadingModal = document.createElement('div');
        loadingModal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
        loadingModal.innerHTML = `
            <div class="bg-white rounded-lg p-6 max-w-md">
                <div class="flex items-center justify-center mb-4">
                    <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-500"></div>
                </div>
                <p class="text-center text-gray-700">Loading study details...</p>
            </div>
        `;
        document.body.appendChild(loadingModal);
        
        // Fetch study details
        const response = await fetch(`/api/clinical-trials/${nctId}`);
        if (!response.ok) {
            throw new Error(`Failed to fetch study details: ${response.status}`);
        }
        
        const studyData = await response.json();
        
        // Remove loading modal
        document.body.removeChild(loadingModal);
        
        // Create detailed study view
        showStudyDetailModal(studyData);
        
    } catch (error) {
        console.error('Error loading study details:', error);
        alert('Failed to load study details. Please try again later.');
    }
}

// Continuation of showStudyDetailModal function
function showStudyDetailModal(studyData) {
    // Previous code...
    
    // Complete the back-to-list button SVG path that was cut off
    let modalContent = `
        <div class="bg-white rounded-lg w-full max-w-6xl max-h-[90vh] overflow-hidden flex flex-col shadow-xl">
            <!-- Previous content... -->
            
            <!-- Footer -->
            <div class="p-4 border-t bg-gray-50 flex justify-end">
                <button id="back-to-list" class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 transition-colors text-sm flex items-center shadow-sm mr-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                    Back to List
                </button>
                
                <a href="https://clinicaltrials.gov/study/${studyData.nctId}" target="_blank" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors text-sm flex items-center shadow-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                    </svg>
                    View on ClinicalTrials.gov
                </a>
            </div>
        </div>
    `;
    
    // Insert modal content
    modal.innerHTML = modalContent;
    
    // Add event listeners
    document.getElementById('close-study-detail-modal').addEventListener('click', () => {
        modal.classList.add('hidden');
    });
    
    document.getElementById('back-to-list').addEventListener('click', () => {
        modal.classList.add('hidden');
    });
    
    document.getElementById('download-study-pdf').addEventListener('click', (e) => {
        const nctId = e.currentTarget.dataset.nctid;
        if (nctId) {
            window.open(`/api/clinical-trials/${nctId}/pdf`, '_blank');
        }
    });
    
    // Close when clicking outside
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.classList.add('hidden');
        }
    });
}

// Function to create a summary of clinical information based on clinical trials

// Additional improved function to create an approval summary based on clinical trials
async function createApprovalSummary(studies) {
    if (!studies || studies.length === 0) {
        return `
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                <p class="text-yellow-700">No clinical trial data available to generate approval summary.</p>
            </div>
        `;
    }
    
    // Group studies by phase - updated to handle the API response format
    const studiesByPhase = {};
    studies.forEach(study => {
        let phase = 'Unknown';
        
        // Try to extract phase from study data
        if (study.phase) {
            phase = study.phase;
        } else if (study.details && study.details.phase) {
            phase = study.details.phase;
        }
        
        if (!studiesByPhase[phase]) {
            studiesByPhase[phase] = [];
        }
        studiesByPhase[phase].push(study);
    });
    
    // Calculate statistics
    const totalStudies = studies.length;
    const hasLatePhaseStudies = studiesByPhase['PHASE3']?.length > 0 || studiesByPhase['PHASE4']?.length > 0;
    const latestStudyYear = Math.max(...studies.map(s => s.year));
    const earliestStudyYear = Math.min(...studies.map(s => s.year));
    const studyDuration = latestStudyYear - earliestStudyYear + 1;
    
    // Determine approval likelihood based on available data
    let approvalStatus = 'Unknown';
    let approvalDescription = '';
    let statusClass = 'bg-gray-100 text-gray-700';
    
    if (hasLatePhaseStudies) {
        approvalStatus = 'Likely Approved';
        approvalDescription = 'Based on completed late-phase clinical trials';
        statusClass = 'bg-green-100 text-green-700';
    } else if (studiesByPhase['PHASE2']?.length > 0) {
        approvalStatus = 'In Development';
        approvalDescription = 'Phase 2 studies completed or ongoing';
        statusClass = 'bg-blue-100 text-blue-700';
    } else {
        approvalStatus = 'Early Research';
        approvalDescription = 'Only early phase studies detected';
        statusClass = 'bg-yellow-100 text-yellow-700';
    }
    
    // Create the approval summary section
    return `
        <div class="bg-white border rounded-lg shadow-sm overflow-hidden mb-6">
            <div class="bg-gradient-to-r from-blue-50 to-white p-4 border-b">
                <h4 class="text-lg font-medium flex items-center text-gray-800">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    Clinical Summary (Basis of Approval)
                </h4>
            </div>
            
            <div class="p-4 bg-white">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div class="border rounded-lg p-4 bg-gray-50">
                        <div class="text-sm text-gray-600 mb-1">Approval Status</div>
                        <div class="flex items-center">
                            <span class="px-2 py-1 rounded-full text-xs ${statusClass} mr-2">
                                ${approvalStatus}
                            </span>
                            <span class="text-xs text-gray-500">${approvalDescription}</span>
                        </div>
                    </div>
                    
                    <div class="border rounded-lg p-4 bg-gray-50">
                        <div class="text-sm text-gray-600 mb-1">Research Timeline</div>
                        <div class="flex items-center">
                            <span class="text-gray-800 font-medium">${earliestStudyYear} - ${latestStudyYear}</span>
                            <span class="text-xs text-gray-500 ml-2">(${studyDuration} ${studyDuration === 1 ? 'year' : 'years'} of research)</span>
                        </div>
                    </div>
                    
                    <div class="border rounded-lg p-4 bg-gray-50">
                        <div class="text-sm text-gray-600 mb-1">Study Phases</div>
                        <div class="flex flex-wrap gap-1">
                            ${Object.keys(studiesByPhase).map(phase => 
                                `<span class="px-2 py-1 rounded-full text-xs bg-blue-100 text-blue-700">
                                    ${formatPhase(phase)}: ${studiesByPhase[phase].length}
                                </span>`
                            ).join('')}
                        </div>
                    </div>
                </div>
                
                <div class="border-t pt-4 mt-2">
                    <h5 class="font-medium text-gray-700 mb-3">Key Findings from Clinical Trials</h5>
                    
                    ${hasLatePhaseStudies ? `
                        <div class="bg-green-50 border border-green-100 rounded-lg p-4 mb-4">
                            <div class="flex items-start">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-green-500 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <div>
                                    <p class="text-green-800 font-medium">Late Phase Studies Available</p>
                                    <p class="text-sm text-green-700 mt-1">
                                        This treatment has completed Phase ${studiesByPhase['PHASE4']?.length > 0 ? '4' : '3'} clinical trials, 
                                        suggesting it has likely received regulatory approval or is in the final stages of the approval process.
                                    </p>
                                </div>
                            </div>
                        </div>
                    ` : studiesByPhase['PHASE2']?.length > 0 ? `
                        <div class="bg-blue-50 border border-blue-100 rounded-lg p-4 mb-4">
                            <div class="flex items-start">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-500 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <div>
                                    <p class="text-blue-800 font-medium">Mid-Stage Development</p>
                                    <p class="text-sm text-blue-700 mt-1">
                                        This treatment has Phase 2 clinical trials completed or ongoing, indicating it is in the middle stages 
                                        of development with preliminary efficacy data available.
                                    </p>
                                </div>
                            </div>
                        </div>
                    ` : `
                        <div class="bg-yellow-50 border border-yellow-100 rounded-lg p-4 mb-4">
                            <div class="flex items-start">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-yellow-500 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                </svg>
                                <div>
                                    <p class="text-yellow-800 font-medium">Early Research Stage</p>
                                    <p class="text-sm text-yellow-700 mt-1">
                                        This treatment appears to be in early research phases with only Phase 1 or pre-clinical studies.
                                        Efficacy data may be limited, and approval would likely be several years away if development continues.
                                    </p>
                                </div>
                            </div>
                        </div>
                    `}
                    
                    <div class="text-sm text-gray-600 mb-4">
                        <p>Based on the analysis of ${totalStudies} clinical ${totalStudies === 1 ? 'trial' : 'trials'} from ${earliestStudyYear} to ${latestStudyYear}, this treatment has been studied for ${studyDuration} ${studyDuration === 1 ? 'year' : 'years'}.</p>
                    </div>
                    
                    ${hasLatePhaseStudies ? `
                        <h5 class="font-medium text-gray-700 mb-2">Approval Pathway</h5>
                        <div class="space-y-2 mb-4">
                            <div class="flex">
                                <div class="flex-shrink-0 w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center mr-3">
                                    <span class="text-blue-800 font-medium">1</span>
                                </div>
                                <div>
                                    <p class="text-gray-800">Phase 1 Safety Trials</p>
                                    <p class="text-sm text-gray-600">Completed with acceptable safety profile</p>
                                </div>
                            </div>
                            <div class="flex">
                                <div class="flex-shrink-0 w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center mr-3">
                                    <span class="text-blue-800 font-medium">2</span>
                                </div>
                                <div>
                                    <p class="text-gray-800">Phase 2 Efficacy Trials</p>
                                    <p class="text-sm text-gray-600">Demonstrated preliminary efficacy</p>
                                </div>
                            </div>
                            <div class="flex">
                                <div class="flex-shrink-0 w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center mr-3">
                                    <span class="text-blue-800 font-medium">3</span>
                                </div>
                                <div>
                                    <p class="text-gray-800">Phase 3 Confirmatory Trials</p>
                                    <p class="text-sm text-gray-600">Pivotal evidence for efficacy and safety</p>
                                </div>
                            </div>
                            ${studiesByPhase['PHASE4']?.length > 0 ? `
                                <div class="flex">
                                    <div class="flex-shrink-0 w-8 h-8 rounded-full bg-green-100 flex items-center justify-center mr-3">
                                        <span class="text-green-800 font-medium">4</span>
                                    </div>
                                    <div>
                                        <p class="text-gray-800">Phase 4 Post-Market Studies</p>
                                        <p class="text-sm text-gray-600">Ongoing monitoring in broader population</p>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}
                    
                    <div class="text-xs text-gray-500 italic mt-4">
                        Note: This automated summary is generated based on available clinical trial data and does not guarantee
                        regulatory approval status. Consult official sources for definitive approval information.
                    </div>
                </div>
            </div>
        </div>
    `;
}


// Function to create a comprehensive clinical summary from trial data
async function OLDcreateComprehensiveClinicalSummary(studies) {
    if (!studies || studies.length === 0) {
        return `
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
                <p class="text-yellow-700">No clinical trial data available to generate summary.</p>
            </div>
        `;
    }
    
    // Get detailed information for each study
    const studyDetails = [];
    for (const study of studies) {
        try {
            // Replace with your actual backend endpoint
            const response = await fetch(`${API_BASE_URL}/studies/${study.id}`);
            if (response.ok) {
                const responseData = await response.json();
                
                // Map the API response data structure to our expected structure
                // Based on the sample data in paste-2.txt
                if (responseData.success && responseData.data) {
                    const protocolSection = responseData.data.protocolSection || {};
                    const derivedSection = responseData.data.derivedSection || {};
                    
                    // Extract relevant information from the response
                    const details = {
                        // Basic information
                        title: protocolSection.identificationModule?.officialTitle || protocolSection.identificationModule?.briefTitle,
                        status: protocolSection.statusModule?.overallStatus,
                        phase: protocolSection.designModule?.phases?.[0],
                        
                        // Study design and enrollment
                        enrollmentCount: protocolSection.designModule?.enrollmentInfo?.count || 0,
                        designInfo: protocolSection.designModule?.designInfo,
                        startDate: protocolSection.statusModule?.startDateStruct?.date,
                        completionDate: protocolSection.statusModule?.completionDateStruct?.date,
                        
                        // Conditions and interventions
                        conditions: protocolSection.conditionsModule?.conditions || [],
                        interventions: protocolSection.armsInterventionsModule?.interventions?.map(intervention => ({
                            type: intervention.type,
                            name: intervention.name,
                            description: intervention.description
                        })) || [],
                        
                        // Outcomes
                        primaryOutcomes: protocolSection.outcomesModule?.primaryOutcomes?.map(outcome => ({
                            measure: outcome.measure,
                            description: outcome.description,
                            timeFrame: outcome.timeFrame
                        })) || [],
                        secondaryOutcomes: protocolSection.outcomesModule?.secondaryOutcomes?.map(outcome => ({
                            measure: outcome.measure,
                            description: outcome.description,
                            timeFrame: outcome.timeFrame
                        })) || [],
                        
                        // Safety data - this may need modification based on the actual data structure
                        adverseEvents: [], // Default to empty if not provided in this API response format
                        
                        // Sponsor information
                        sponsor: protocolSection.sponsorCollaboratorsModule?.leadSponsor?.name
                    };
                    
                    studyDetails.push({
                        ...study,
                        details
                    });
                    
                    console.log("Successfully processed study details:", study.id);
                }
            } else {
                console.error(`Error fetching study ${study.id}: Response not OK`);
            }
        } catch (error) {
            console.error(`Error fetching details for study ${study.id}:`, error);
        }
    }
    
    // Extract and aggregate key information
    const totalEnrollment = studyDetails.reduce((total, study) => {
        return total + (study.details?.enrollmentCount || 0);
    }, 0);
    
    // Aggregate intervention types
    const interventionTypes = new Set();
    studyDetails.forEach(study => {
        if (study.details?.interventions) {
            study.details.interventions.forEach(intervention => {
                if (intervention.type) interventionTypes.add(intervention.type);
            });
        }
    });
    
    // Aggregate conditions studied
    const conditions = new Set();
    studyDetails.forEach(study => {
        if (study.details?.conditions) {
            study.details.conditions.forEach(condition => {
                conditions.add(condition);
            });
        }
    });
    
    // Aggregate adverse events
    const adverseEvents = [];
    studyDetails.forEach(study => {
        if (study.details?.adverseEvents) {
            study.details.adverseEvents.forEach(event => {
                adverseEvents.push({
                    term: event.term,
                    count: event.count,
                    serious: event.serious,
                    studyId: study.id
                });
            });
        }
    });
    
    // Organize adverse events by frequency
    const eventCounts = {};
    adverseEvents.forEach(event => {
        if (!eventCounts[event.term]) {
            eventCounts[event.term] = {
                total: 0,
                serious: 0,
                studies: new Set()
            };
        }
        eventCounts[event.term].total += event.count || 1;
        if (event.serious) eventCounts[event.term].serious += event.count || 1;
        eventCounts[event.term].studies.add(event.studyId);
    });
    
    // Sort adverse events by frequency
    const sortedEvents = Object.entries(eventCounts)
        .sort((a, b) => b[1].total - a[1].total)
        .slice(0, 10); // Top 10 most common events
    
    // Analyze primary outcomes
    const primaryOutcomes = [];
    studyDetails.forEach(study => {
        if (study.details?.primaryOutcomes) {
            study.details.primaryOutcomes.forEach(outcome => {
                primaryOutcomes.push({
                    measure: outcome.measure,
                    description: outcome.description,
                    timeFrame: outcome.timeFrame,
                    studyId: study.id,
                    year: study.year
                });
            });
        }
    });
    
    // Categorize studies by phase
    const phaseEnrollment = {};
    studyDetails.forEach(study => {
        const phase = study.phase || study.details?.phase || 'Unknown';
        if (!phaseEnrollment[phase]) {
            phaseEnrollment[phase] = 0;
        }
        phaseEnrollment[phase] += (study.details?.enrollmentCount || 0);
    });
    
    // Study status summary
    const statusCounts = {};
    studyDetails.forEach(study => {
        const status = study.details?.status || 'Unknown';
        if (!statusCounts[status]) {
            statusCounts[status] = 0;
        }
        statusCounts[status]++;
    });
    
    // Create the clinical summary section
    return `
        <div class="bg-white border rounded-lg shadow-sm overflow-hidden mb-6">
            <div class="bg-gradient-to-r from-blue-50 to-white p-4 border-b">
                <h4 class="text-lg font-medium flex items-center text-gray-800">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                    </svg>
                    Clinical Summary (Basis of Approval)
                </h4>
            </div>
            
            <div class="p-4 bg-white">
                <!-- Enrollment & Study Scope -->
                <div class="mb-6">
                    <h5 class="font-medium text-gray-700 mb-3 border-b pb-2">Study Population & Scope</h5>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div class="bg-blue-50 rounded-lg p-4">
                            <div class="text-sm text-blue-600 mb-1 font-medium">Total Enrollment</div>
                            <div class="text-xl font-bold text-gray-800">${totalEnrollment} participants</div>
                            <div class="mt-1 text-xs text-gray-500">Across ${studies.length} clinical trials</div>
                        </div>
                        
                        <div class="bg-indigo-50 rounded-lg p-4">
                            <div class="text-sm text-indigo-600 mb-1 font-medium">Research Timespan</div>
                            <div class="text-xl font-bold text-gray-800">${Math.min(...studies.map(s => s.year))} - ${Math.max(...studies.map(s => s.year))}</div>
                            <div class="mt-1 text-xs text-gray-500">${Math.max(...studies.map(s => s.year)) - Math.min(...studies.map(s => s.year)) + 1} years of clinical research</div>
                        </div>
                        
                        <div class="bg-purple-50 rounded-lg p-4">
                            <div class="text-sm text-purple-600 mb-1 font-medium">Study Status</div>
                            <div class="flex flex-wrap gap-1 mt-1">
                                ${Object.entries(statusCounts).map(([status, count]) => 
                                    `<span class="px-2 py-1 rounded-full text-xs ${getStatusBadgeColor(status)}">
                                        ${status}: ${count}
                                    </span>`
                                ).join('')}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Conditions & Interventions -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-gray-50 rounded-lg p-4 border">
                        <h5 class="font-medium text-gray-700 mb-3">Conditions Studied</h5>
                        ${conditions.size > 0 ? 
                            `<ul class="space-y-2">
                                ${Array.from(conditions).map(condition => 
                                    `<li class="flex items-center">
                                        <span class="w-2 h-2 bg-blue-500 rounded-full mr-2"></span>
                                        <span class="text-gray-600">${condition}</span>
                                    </li>`
                                ).join('')}
                            </ul>` : 
                            `<p class="text-gray-500 italic">No condition information available</p>`
                        }
                    </div>
                    
                    <div class="bg-gray-50 rounded-lg p-4 border">
                        <h5 class="font-medium text-gray-700 mb-3">Intervention Types</h5>
                        ${interventionTypes.size > 0 ? 
                            `<ul class="space-y-2">
                                ${Array.from(interventionTypes).map(type => 
                                    `<li class="flex items-center">
                                        <span class="w-2 h-2 bg-green-500 rounded-full mr-2"></span>
                                        <span class="text-gray-600">${type}</span>
                                    </li>`
                                ).join('')}
                            </ul>` : 
                            `<p class="text-gray-500 italic">No intervention type information available</p>`
                        }
                    </div>
                </div>
                
                <!-- Phase Distribution & Enrollment -->
                <div class="mb-6">
                    <h5 class="font-medium text-gray-700 mb-3 border-b pb-2">Clinical Trial Phases</h5>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-gray-50 p-4 rounded-lg border">
                            <h6 class="text-sm font-medium text-gray-700 mb-2">Trials by Phase</h6>
                            <div class="space-y-2">
                                ${Object.entries(phaseEnrollment).sort((a, b) => getPhaseOrder(a[0]) - getPhaseOrder(b[0])).map(([phase, count]) => 
                                    `<div class="flex items-center">
                                        <div class="w-24 text-sm font-medium text-gray-600">${formatPhase(phase)}</div>
                                        <div class="flex-1 bg-gray-200 rounded-full h-3 ml-2">
                                            <div class="bg-blue-500 h-3 rounded-full" style="width: ${Math.min(100, (count / totalEnrollment) * 100)}%"></div>
                                        </div>
                                        <div class="ml-2 text-sm text-gray-600 w-20 text-right">${count} patients</div>
                                    </div>`
                                ).join('')}
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 p-4 rounded-lg border">
                            <h6 class="text-sm font-medium text-gray-700 mb-2">Trial Progression</h6>
                            <p class="text-sm text-gray-600 mb-3">
                                ${getPhaseProgressionDescription(Object.keys(phaseEnrollment))}
                            </p>
                            <div class="flex justify-between items-center mt-4">
                                ${Object.keys(phaseEnrollment).sort((a, b) => getPhaseOrder(a) - getPhaseOrder(b)).map((phase, index, arr) => 
                                    `<div class="flex flex-col items-center">
                                        <div class="w-8 h-8 rounded-full ${index < arr.length - 1 ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-600'} flex items-center justify-center text-sm font-medium">
                                            ${getPhaseNumber(phase)}
                                        </div>
                                        <div class="text-xs text-gray-500 mt-1">${formatPhase(phase)}</div>
                                    </div>
                                    ${index < arr.length - 1 ? 
                                        `<div class="w-12 h-0.5 bg-gray-300"></div>` : 
                                        ''
                                    }`
                                ).join('')}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Primary Outcomes -->
                <div class="mb-6">
                    <h5 class="font-medium text-gray-700 mb-3 border-b pb-2">Key Primary Outcomes</h5>
                    ${primaryOutcomes.length > 0 ? 
                        `<div class="space-y-3">
                            ${primaryOutcomes.slice(0, 5).map(outcome => 
                                `<div class="bg-gray-50 rounded p-3 border-l-4 border-blue-400">
                                    <div class="font-medium text-gray-800">${outcome.measure || 'Unnamed outcome'}</div>
                                    ${outcome.description ? 
                                        `<p class="text-sm text-gray-600 mt-1">${outcome.description}</p>` : 
                                        ''}
                                    <div class="flex items-center mt-2 text-xs text-gray-500">
                                        ${outcome.timeFrame ? 
                                            `<span class="mr-3">Timeframe: ${outcome.timeFrame}</span>` : 
                                            ''}
                                        <span>Study year: ${outcome.year}</span>
                                    </div>
                                </div>`
                            ).join('')}
                            ${primaryOutcomes.length > 5 ? 
                                `<div class="text-sm text-gray-600 italic">
                                    +${primaryOutcomes.length - 5} more outcomes across all studies
                                </div>` : 
                                ''}
                        </div>` : 
                        `<p class="text-gray-500 italic p-3 bg-gray-50 rounded">No primary outcome information available</p>`
                    }
                </div>
                
                <!-- Safety Profile -->
                <div class="mb-6">
                    <h5 class="font-medium text-gray-700 mb-3 border-b pb-2">Safety Profile</h5>
                    ${sortedEvents.length > 0 ? 
                        `<div class="bg-white p-0">
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Adverse Event
                                            </th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Frequency
                                            </th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Serious Events
                                            </th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Studies Reported
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        ${sortedEvents.map(([term, data]) => 
                                            `<tr class="hover:bg-gray-50">
                                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                                    ${term}
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                    ${data.total} occurrences
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                    ${data.serious > 0 ? 
                                                        `<span class="text-red-600 font-medium">${data.serious} serious events</span>` : 
                                                        'None reported'}
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                    ${data.studies.size} ${data.studies.size === 1 ? 'study' : 'studies'}
                                                </td>
                                            </tr>`
                                        ).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>` : 
                        `<p class="text-gray-500 italic p-3 bg-gray-50 rounded">No adverse event information available</p>`
                    }
                </div>
                
                <!-- Key Findings -->
                <div class="mb-6">
                    <h5 class="font-medium text-gray-700 mb-3 border-b pb-2">Summary of Key Findings</h5>
                    <div class="bg-blue-50 border border-blue-100 rounded-lg p-4">
                        <p class="text-sm text-blue-800">
                            ${getKeyFindingsSummary(studies, phaseEnrollment, sortedEvents, primaryOutcomes)}
                        </p>
                        
                        <div class="mt-4 flex flex-col gap-2">
                            <div class="flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <span class="text-sm text-blue-800 font-medium">
                                    Development Status: ${getDevelopmentStatus(Object.keys(phaseEnrollment))}
                                </span>
                            </div>
                            
                            <div class="flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <span class="text-sm text-blue-800 font-medium">
                                    Research Duration: ${Math.max(...studies.map(s => s.year)) - Math.min(...studies.map(s => s.year)) + 1} years (${Math.min(...studies.map(s => s.year))} - ${Math.max(...studies.map(s => s.year))})
                                </span>
                            </div>
                            
                            <div class="flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <span class="text-sm text-blue-800 font-medium">
                                    Safety Overview: ${getSafetyOverview(sortedEvents)}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="text-xs text-gray-500 italic mt-4">
                    Note: This clinical summary is generated based on available clinical trial data. The information presented 
                    synthesizes findings from ${studies.length} clinical trials spanning from ${Math.min(...studies.map(s => s.year))} to ${Math.max(...studies.map(s => s.year))}.
                    For definitive approval information, please consult official regulatory sources.
                </div>
            </div>
        </div>
    `;
}


// Helper functions remain the same
// Helper function to get badge color based on study status
function getStatusBadgeColor(status) {
    const statusLower = (status || '').toLowerCase();
    if (statusLower.includes('completed')) return 'bg-green-100 text-green-700';
    if (statusLower.includes('recruiting')) return 'bg-blue-100 text-blue-700';
    if (statusLower.includes('active') || statusLower.includes('enrolling')) return 'bg-purple-100 text-purple-700';
    if (statusLower.includes('terminated') || statusLower.includes('withdrawn')) return 'bg-red-100 text-red-700';
    return 'bg-gray-100 text-gray-700';
}

// Helper function for phase ordering
function getPhaseOrder(phase) {
    const phaseOrder = {
        "PHASE4": 1,
        "PHASE3": 2,
        "PHASE2_PHASE3": 3,
        "PHASE2": 4,
        "PHASE1_PHASE2": 5,
        "PHASE1": 6,
        "PRE_PHASE": 7,
        "Unknown": 8
    };
    return phaseOrder[phase] || 999;
}

// Helper function to get phase number for visualization
function getPhaseNumber(phase) {
    if (phase === 'PHASE4') return '4';
    if (phase === 'PHASE3') return '3';
    if (phase === 'PHASE2_PHASE3') return '2/3';
    if (phase === 'PHASE2') return '2';
    if (phase === 'PHASE1_PHASE2') return '1/2';
    if (phase === 'PHASE1') return '1';
    if (phase === 'PRE_PHASE') return 'P';
    return '?';
}

// Helper function to format phase names
function formatPhase(phase) {
    switch(phase) {
        case 'PHASE1': return 'Phase 1';
        case 'PHASE2': return 'Phase 2';
        case 'PHASE3': return 'Phase 3';
        case 'PHASE4': return 'Phase 4';
        case 'PHASE1_PHASE2': return 'Phase 1/2';
        case 'PHASE2_PHASE3': return 'Phase 2/3';
        case 'PRE_PHASE': return 'Pre-Clinical';
        default: return phase || 'Unknown';
    }
}

// Helper function to get color for phase
function getPhaseColor(phase) {
    switch(phase) {
        case 'PHASE4': return '#4CAF50'; // Green
        case 'PHASE3': return '#2196F3'; // Blue
        case 'PHASE2': return '#FF9800'; // Orange
        case 'PHASE1_PHASE2': return '#9C27B0'; // Purple
        case 'PHASE2_PHASE3': return '#3F51B5'; // Indigo
        case 'PHASE1': return '#F44336'; // Red
        case 'PRE_PHASE': return '#795548'; // Brown
        default: return '#9E9E9E'; // Gray
    }
}

// Helper function to get phase progression description
function getPhaseProgressionDescription(phases) {
    const phaseSet = new Set(phases);
    
    if (phaseSet.has('PHASE4')) {
        return 'Treatment has progressed through all clinical phases including post-approval studies.';
    } else if (phaseSet.has('PHASE3')) {
        return 'Treatment has reached pivotal late-stage trials necessary for regulatory approval.';
    } else if (phaseSet.has('PHASE2') || phaseSet.has('PHASE2_PHASE3')) {
        return 'Treatment has demonstrated preliminary efficacy in mid-stage development.';
    } else if (phaseSet.has('PHASE1') || phaseSet.has('PHASE1_PHASE2')) {
        return 'Treatment is in early-stage development, primarily focused on safety assessment.';
    } else {
        return 'Treatment is in pre-clinical or very early research phase.';
    }
}

// Helper function to summarize safety profile
function getSafetyOverview(adverseEvents) {
    if (!adverseEvents || adverseEvents.length === 0) {
        return 'No adverse event data available';
    }
    
    const totalSeriousEvents = adverseEvents.reduce((count, [_, data]) => count + data.serious, 0);
    
    if (totalSeriousEvents === 0) {
        return 'No serious adverse events reported';
    } else if (totalSeriousEvents <= 3) {
        return `Limited serious adverse events (${totalSeriousEvents}) reported`;
    } else {
        return `Multiple serious adverse events (${totalSeriousEvents}) reported`;
    }
}

// Helper function to get development status based on phases
function getDevelopmentStatus(phases) {
    const phaseSet = new Set(phases);
    
    if (phaseSet.has('PHASE4')) {
        return 'Post-Market (FDA Approved)';
    } else if (phaseSet.has('PHASE3')) {
        return 'Late-Stage Development';
    } else if (phaseSet.has('PHASE2') || phaseSet.has('PHASE2_PHASE3')) {
        return 'Mid-Stage Development';
    } else if (phaseSet.has('PHASE1') || phaseSet.has('PHASE1_PHASE2')) {
        return 'Early-Stage Development';
    } else {
        return 'Pre-Clinical/Early Research';
    }
}



// Helper function to generate key findings summary (continuing from previous artifact)
// function getKeyFindingsSummary(studies, phaseEnrollment, adverseEvents, primaryOutcomes) {
//     const phases = Object.keys(phaseEnrollment);
//     const hasLatePhase = phases.some(phase => phase === 'PHASE3' || phase === 'PHASE4');
//     const hasMidPhase = phases.some(phase => phase === 'PHASE2' || phase === 'PHASE2_PHASE3');
//     const totalEnrollment = Object.values(phaseEnrollment).reduce((sum, count) => sum + count, 0);
    
//     let summary = `Based on the analysis of ${studies.length} clinical trials with a total enrollment of ${totalEnrollment} participants, `;
    
//     if (hasLatePhase) {
//         summary += `this treatment has advanced to late-stage clinical development. `;
//         summary += `The trials include pivotal Phase 3 studies necessary for regulatory approval consideration. `;
//     } else if (hasMidPhase) {
//         summary += `this treatment has progressed to mid-stage clinical development. `;
//         summary += `Phase 2 trials have been conducted to evaluate preliminary efficacy. `;
//     } else {
//         summary += `this treatment is in early-stage clinical development. `;
//         summary += `Current research focuses primarily on safety assessment and dosing. `;
//     }
    
//     if (primaryOutcomes.length > 0) {
//         summary += `Key outcome measures include ${primaryOutcomes.slice(0, 3).map(o => o.measure).join(', ')}${primaryOutcomes.length > 3 ? ', and others' : ''}. `;
//     }
    
//     const totalSeriousEvents = adverseEvents.reduce((count, [_, data]) => count + data.serious, 0);
//     if (totalSeriousEvents > 0) {
//         summary += `Safety monitoring has identified ${totalSeriousEvents} serious adverse events across all studies. `;
//     } else if (adverseEvents.length > 0) {
//         summary += `No serious adverse events have been reported, though non-serious events have been documented. `;
//     }
    
//     return summary;
// }

// Continuing the showUsageDetailModal function that was cut off
async function showUsageDetailModal(itemData, itemName, entityType) {
    // Get or create modal container
    let modal = document.getElementById('usage-detail-modal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'usage-detail-modal';
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
        document.body.appendChild(modal);
    }
    
    // Show loading state
    modal.innerHTML = `
        <div class="bg-white rounded-lg w-full max-w-5xl max-h-[90vh] overflow-hidden flex flex-col shadow-xl">
            <div class="p-10 flex items-center justify-center">
                <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-500"></div>
                <span class="ml-3 text-gray-600">Loading clinical data...</span>
            </div>
        </div>
    `;
    
    // Make sure modal is visible
    modal.classList.remove('hidden');
    
    // Determine relation type based on entity type
    const relationType = entityType === 'drug' ? 'condition' : 'drug';
    const relationTypeName = entityType === 'drug' ? 'Condition' : 'Treatment';
    
    // Sort studies by year (newest first)
    const sortedStudies = [...(itemData.studies || [])].sort((a, b) => b.year - a.year);
    
    // Group studies by phase
    const studiesByPhase = {};
    sortedStudies.forEach(study => {
        const phase = study.phase || 'Unknown';
        if (!studiesByPhase[phase]) {
            studiesByPhase[phase] = [];
        }
        studiesByPhase[phase].push(study);
    });
    
    // Get phase order for sorting
    const phaseOrder = {
        "PHASE4": 1,
        "PHASE3": 2,
        "PHASE2": 3,
        "PHASE1_PHASE2": 4,
        "PHASE1": 5,
        "PRE_PHASE": 6,
        "Unknown": 7
    };
    
    // Sort phases
    const sortedPhases = Object.keys(studiesByPhase).sort((a, b) => 
        (phaseOrder[a] || 999) - (phaseOrder[b] || 999)
    );
    
    // Create timeline data for years
    const yearData = [];
    const years = Object.keys(itemData.years || {}).map(Number).sort((a, b) => a - b);
    
    // Find max studies in a year for scaling
    const maxYearCount = Math.max(...Object.values(itemData.years || {}).map(count => Number(count)));
    
    years.forEach(year => {
        const count = itemData.years[year] || 0;
        yearData.push({
            year,
            count
        });
    });
    
    // Check if this item is marked as successful (for condition-drug view)
    const successBadge = itemData.isSuccessful ? 
        `<span class="ml-2 text-xs bg-green-100 text-green-800 px-2 py-0.5 rounded-full">Successful Treatment</span>` : '';
    
    console.log(itemName, entityType);
    
    // Generate comprehensive clinical summary
    let clinicalSummaryHTML = '';
    try {
        // For drug entities, use the search term if available
        const drugName = entityType === 'drug' && typeof SearchTermManager !== 'undefined' ? 
            SearchTermManager.getSearchTerm() : 
            itemName;
            
        clinicalSummaryHTML = await createComprehensiveClinicalSummary(sortedStudies, drugName);
    } catch (error) {
        console.error('Error generating clinical summary:', error);
        clinicalSummaryHTML = `
            <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                <p class="text-red-700">Error generating clinical summary. Please try again later.</p>
            </div>
        `;
    }
    
    // Create modal content
    let modalContent = `
        <div class="bg-white rounded-lg w-full max-w-5xl max-h-[90vh] overflow-hidden flex flex-col shadow-xl">
            <div class="p-4 border-b bg-gradient-to-r from-blue-50 to-white">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold text-gray-800">${itemName} ${successBadge}</h3>
                    <button id="close-usage-detail-modal" class="text-gray-500 hover:text-gray-700 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="flex items-center mt-1">
                    <span class="text-sm text-gray-600 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                        </svg>
                        ${relationTypeName} studied from ${itemData.earliestYear} to ${itemData.latestYear} 
                    </span>
                    <div class="ml-3 px-2 py-0.5 bg-blue-100 text-blue-700 rounded-full text-xs font-medium">
                        ${itemData.count} total studies
                    </div>
                </div>
            </div>
            
            <div class="overflow-y-auto">
                <!-- Quick stats -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 p-4 border-b">
                    <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-lg shadow-sm hover:shadow transition-shadow">
                        <div class="text-sm text-blue-600 font-medium flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                            First Studied
                        </div>
                        <div class="text-2xl font-bold text-gray-800 mt-1">${itemData.earliestYear}</div>
                        <div class="text-xs text-gray-500 mt-1">${new Date().getFullYear() - itemData.earliestYear} years ago</div>
                    </div>
                    
                    <div class="bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-lg shadow-sm hover:shadow transition-shadow">
                        <div class="text-sm text-green-600 font-medium flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                            </svg>
                            Total Studies
                        </div>
                        <div class="text-2xl font-bold text-gray-800 mt-1">${itemData.count}</div>
                        <div class="text-xs text-gray-500 mt-1">Across ${years.length} years</div>
                    </div>
                    
                    <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-4 rounded-lg shadow-sm hover:shadow transition-shadow">
                        <div class="text-sm text-purple-600 font-medium flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            Latest Activity
                        </div>
                        <div class="text-2xl font-bold text-gray-800 mt-1">${itemData.latestYear}</div>
                        <div class="text-xs text-gray-500 mt-1">${itemData.years[itemData.latestYear] || 0} studies in that year</div>
                    </div>
                </div>
                
                <!-- Comprehensive Clinical Summary -->
                ${clinicalSummaryHTML}
                
                <!-- Improved Timeline -->
                <div class="p-6 border-b">
                    <h4 class="text-lg font-medium mb-2 flex items-center text-gray-800">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                        </svg>
                        Research Activity Timeline
                    </h4>
                    <p class="text-sm text-gray-600 mb-4">
                        Showing all years from ${itemData.earliestYear} to ${itemData.latestYear} 
                    </p>
                    
                    <div class="timeline-container h-64 relative px-4">
                        <!-- Will be populated by JavaScript -->
                        <div id="research-timeline" class="h-full"></div>
                        
                        <!-- Year labels will be dynamically added -->
                        <div id="timeline-years" class="absolute bottom-0 left-0 right-0 flex justify-between text-xs text-gray-500"></div>
                    </div>
                </div>
                
                <!-- Studies breakdown -->
                <div class="p-6">
                    <h4 class="text-lg font-medium mb-4 flex items-center text-gray-800">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                        </svg>
                        Studies by Phase
                    </h4>
                    
                    <div class="space-y-5">
    `;
    
    // Create phase sections with improved styling
    sortedPhases.forEach(phase => {
        const phaseStudies = studiesByPhase[phase];
        const formattedPhase = formatPhase(phase);
        const phaseColor = getPhaseColor(phase);
        
        modalContent += `
            <div class="border rounded-lg overflow-hidden shadow-sm hover:shadow transition-shadow">
                <div class="bg-gray-50 p-3 flex justify-between items-center" style="border-left: 4px solid ${phaseColor}">
                    <div class="flex items-center">
                        <span class="inline-block w-3 h-3 rounded-full mr-2" style="background-color: ${phaseColor}"></span>
                        <h5 class="font-medium text-gray-800">${formattedPhase}</h5>
                    </div>
                    <span class="text-sm bg-gray-200 text-gray-700 px-2 py-0.5 rounded-full">${phaseStudies.length} studies</span>
                </div>
                
                <div class="divide-y divide-gray-100">
        `;
        
        // List studies in this phase with improved styling
        phaseStudies.forEach(study => {
            modalContent += `
                <div class="p-4 hover:bg-blue-50 transition-colors">
                    <div class="flex justify-between items-start mb-2">
                        <a href="#" class="text-blue-600 hover:text-blue-800 font-medium study-link group" data-nctid="${study.id}">
                            ${study.title || 'Untitled Study'}
                            <span class="inline-block transition-transform group-hover:translate-x-1">→</span>
                        </a>
                        <div class="flex flex-col items-end">
                            <span class="text-xs font-medium px-2 py-0.5 rounded bg-gray-100 text-gray-700">${study.year}</span>
                        </div>
                    </div>
                    <div class="flex space-x-3 mt-2">
                        <a href="#" class="text-sm text-blue-600 hover:text-blue-800 study-link flex items-center" data-nctid="${study.id}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                            </svg>
                            View Details
                        </a>
                        <a href="https://clinicaltrials.gov/study/${study.id}" target="_blank" class="text-sm text-gray-600 hover:text-gray-800 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                            </svg>
                            ClinicalTrials.gov
                        </a>
                    </div>
                </div>
            `;
        });
        
        modalContent += `
                </div>
            </div>
        `;
    });
    
    modalContent += `
                    </div>
                </div>
            </div>
            
            <!-- Footer with export options -->
            <div class="p-4 border-t bg-gray-50 flex justify-between items-center">
                <button id="export-usage-data" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors text-sm flex items-center shadow-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    Export Data
                </button>
                
                <a href="#" class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 transition-colors text-sm flex items-center shadow-sm" id="search-all-studies-link" data-item="${itemName}" data-type="${relationType}">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                    View All Studies
                </a>
            </div>
        </div>
    `;
    
    // Insert modal content
    modal.innerHTML = modalContent;
    
    // Create the timeline visualization
    CONDITIONcreateTimelineVisualization(yearData, maxYearCount);
    
    // Add event listeners
    
    // 1. Close modal button
    document.getElementById('close-usage-detail-modal').addEventListener('click', () => {
        modal.classList.add('hidden');
    });
    
    // 2. Close when clicking outside
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.classList.add('hidden');
        }
    });
    
    // 3. Study links
    const studyLinks = modal.querySelectorAll('.study-link');
    studyLinks.forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const nctId = e.currentTarget.dataset.nctid;
            if (nctId) {
                // Close the modal
                modal.classList.add('hidden');
                // View study details
                viewStudyDetails(nctId);
            }
        });
    });
    
    // 4. Export data button
    document.getElementById('export-usage-data').addEventListener('click', () => {
        exportUsageData(itemData, itemName);
    });
    
    // 5. Search all studies link
    document.getElementById('search-all-studies-link').addEventListener('click', (e) => {
        e.preventDefault();
        const searchItem = e.currentTarget.dataset.item;
        const searchType = e.currentTarget.dataset.type;
        
        // Close the modal
        modal.classList.add('hidden');
        
        // Trigger search for all studies
        if (typeof searchForEntity === 'function') {
            searchForEntity(searchItem, searchType);
        } else {
            alert(`Search for all studies with ${searchType}: ${searchItem}`);
            console.log(`Search for all studies with ${searchType}: ${searchItem}`);
        }
    });
}

// async function showUsageDetailModal(itemData, itemName, entityType) {
//     // Get or create modal container
//     let modal = document.getElementById('usage-detail-modal');
//     if (!modal) {
//         modal = document.createElement('div');
//         modal.id = 'usage-detail-modal';
//         modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
//         document.body.appendChild(modal);
//     }
    
//     // Show loading state
//     modal.innerHTML = `
//         <div class="bg-white rounded-lg w-full max-w-5xl max-h-[90vh] overflow-hidden flex flex-col shadow-xl">
//             <div class="p-10 flex items-center justify-center">
//                 <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-500"></div>
//                 <span class="ml-3 text-gray-600">Loading clinical data...</span>
//             </div>
//         </div>
//     `;
    
//     // Make sure modal is visible
//     modal.classList.remove('hidden');
    
//     // Determine relation type based on entity type
//     const relationType = entityType === 'drug' ? 'condition' : 'drug';
//     const relationTypeName = entityType === 'drug' ? 'Condition' : 'Treatment';
    
//     // Sort studies by year (newest first)
//     const sortedStudies = [...(itemData.studies || [])].sort((a, b) => b.year - a.year);
    
//     // Group studies by phase
//     const studiesByPhase = {};
//     sortedStudies.forEach(study => {
//         const phase = study.phase || 'Unknown';
//         if (!studiesByPhase[phase]) {
//             studiesByPhase[phase] = [];
//         }
//         studiesByPhase[phase].push(study);
//     });
    
//     // Get phase order for sorting
//     const phaseOrder = {
//         "PHASE4": 1,
//         "PHASE3": 2,
//         "PHASE2": 3,
//         "PHASE1_PHASE2": 4,
//         "PHASE1": 5,
//         "PRE_PHASE": 6,
//         "Unknown": 7
//     };
    
//     // Sort phases
//     const sortedPhases = Object.keys(studiesByPhase).sort((a, b) => 
//         (phaseOrder[a] || 999) - (phaseOrder[b] || 999)
//     );
    
//     // Create timeline data for years
//     const yearData = [];
//     const years = Object.keys(itemData.years || {}).map(Number).sort((a, b) => a - b);
    
//     // Find max studies in a year for scaling
//     const maxYearCount = Math.max(...Object.values(itemData.years || {}).map(count => Number(count)));
    
//     years.forEach(year => {
//         const count = itemData.years[year] || 0;
//         yearData.push({
//             year,
//             count
//         });
//     });
    
//     // Check if this item is marked as successful (for condition-drug view)
//     const successBadge = itemData.isSuccessful ? 
//         `<span class="ml-2 text-xs bg-green-100 text-green-800 px-2 py-0.5 rounded-full">Successful Treatment</span>` : '';

//     // Get clinical details for each study
//     const studyDetails = [];
//     for (const study of sortedStudies) {
//         try {
//             // Replace with your actual backend endpoint
//             const response = await fetch(`/api/clinical-trials/${study.id}`);
//             if (response.ok) {
//                 const details = await response.json();
//                 studyDetails.push({
//                     ...study,
//                     details
//                 });
//             }
//         } catch (error) {
//             console.error(`Error fetching details for study ${study.id}:`, error);
//         }
//     }
    
//     // Generate clinical summary based on studies
//     const clinicalSummaryHTML = await createApprovalSummary(sortedStudies);
    
//     // Create modal content
//     let modalContent = `
//         <div class="bg-white rounded-lg w-full max-w-5xl max-h-[90vh] overflow-hidden flex flex-col shadow-xl">
//             <div class="p-4 border-b bg-gradient-to-r from-blue-50 to-white">
//                 <div class="flex justify-between items-center">
//                     <h3 class="text-xl font-bold text-gray-800">${itemName} ${successBadge}</h3>
//                     <button id="close-usage-detail-modal" class="text-gray-500 hover:text-gray-700 transition-colors">
//                         <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
//                         </svg>
//                     </button>
//                 </div>
//                 <div class="flex items-center mt-1">
//                     <span class="text-sm text-gray-600 flex items-center">
//                         <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
//                         </svg>
//                         ${relationTypeName} studied from ${itemData.earliestYear} to ${itemData.latestYear} 
//                     </span>
//                     <div class="ml-3 px-2 py-0.5 bg-blue-100 text-blue-700 rounded-full text-xs font-medium">
//                         ${itemData.count} total studies
//                     </div>
//                 </div>
//             </div>
            
//             <div class="overflow-y-auto">
//                 <!-- Quick stats -->
//                 <div class="grid grid-cols-1 md:grid-cols-3 gap-4 p-4 border-b">
//                     <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-lg shadow-sm hover:shadow transition-shadow">
//                         <div class="text-sm text-blue-600 font-medium flex items-center">
//                             <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
//                             </svg>
//                             First Studied
//                         </div>
//                         <div class="text-2xl font-bold text-gray-800 mt-1">${itemData.earliestYear}</div>
//                         <div class="text-xs text-gray-500 mt-1">${new Date().getFullYear() - itemData.earliestYear} years ago</div>
//                     </div>
                    
//                     <div class="bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-lg shadow-sm hover:shadow transition-shadow">
//                         <div class="text-sm text-green-600 font-medium flex items-center">
//                             <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
//                             </svg>
//                             Total Studies
//                         </div>
//                         <div class="text-2xl font-bold text-gray-800 mt-1">${itemData.count}</div>
//                         <div class="text-xs text-gray-500 mt-1">Across ${years.length} years</div>
//                     </div>
                    
//                     <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-4 rounded-lg shadow-sm hover:shadow transition-shadow">
//                         <div class="text-sm text-purple-600 font-medium flex items-center">
//                             <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
//                             </svg>
//                             Latest Activity
//                         </div>
//                         <div class="text-2xl font-bold text-gray-800 mt-1">${itemData.latestYear}</div>
//                         <div class="text-xs text-gray-500 mt-1">${itemData.years[itemData.latestYear] || 0} studies in that year</div>
//                     </div>
//                 </div>
                
//                 <!-- Clinical Summary (Basis of Approval) -->
//                 ${clinicalSummaryHTML}
                
//                 <!-- Improved Timeline -->
//                 <div class="p-6 border-b">
//                     <h4 class="text-lg font-medium mb-2 flex items-center text-gray-800">
//                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
//                         </svg>
//                         Research Activity Timeline
//                     </h4>
//                     <p class="text-sm text-gray-600 mb-4">
//                         Showing all years from ${itemData.earliestYear} to ${itemData.latestYear} 
//                     </p>
                    
//                     <div class="timeline-container h-64 relative px-4">
//                         <!-- Will be populated by JavaScript -->
//                         <div id="research-timeline" class="h-full"></div>
                        
//                         <!-- Year labels will be dynamically added -->
//                         <div id="timeline-years" class="absolute bottom-0 left-0 right-0 flex justify-between text-xs text-gray-500"></div>
//                     </div>
//                 </div>
                
//                 <!-- Clinical Trials Details -->
//                 <div class="p-6 border-b">
//                     <h4 class="text-lg font-medium mb-4 flex items-center text-gray-800">
//                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
//                         </svg>
//                         Clinical Trial Details
//                     </h4>
                    
//                     <div class="space-y-5">
//                         ${studyDetails.length > 0 ? studyDetails.map(study => {
//                             const details = study.details || {};
//                             const status = details.status || 'Unknown';
//                             const briefSummary = details.briefSummary || 'No summary available';
//                             const objectives = details.detailedDescription || '';
                            
//                             return `
//                                 <div class="border rounded-lg overflow-hidden shadow-sm hover:shadow transition-shadow">
//                                     <div class="bg-gradient-to-r from-blue-50 to-white p-3 flex justify-between items-start">
//                                         <div>
//                                             <h5 class="font-medium text-gray-800">${study.title}</h5>
//                                             <div class="flex flex-wrap gap-2 mt-2">
//                                                 <span class="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full">NCT ID: ${study.id}</span>
//                                                 <span class="text-xs bg-purple-100 text-purple-700 px-2 py-0.5 rounded-full">${formatPhase(study.phase)}</span>
//                                                 <span class="text-xs ${getStatusColor(status)} px-2 py-0.5 rounded-full">${status}</span>
//                                                 <span class="text-xs bg-gray-100 text-gray-700 px-2 py-0.5 rounded-full">${study.year}</span>
//                                             </div>
//                                         </div>
//                                         <a href="https://clinicaltrials.gov/study/${study.id}" target="_blank" 
//                                            class="text-sm text-blue-600 hover:text-blue-800 flex items-center ml-2">
//                                             <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                                                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
//                                             </svg>
//                                             View on ClinicalTrials.gov
//                                         </a>
//                                     </div>
                                    
//                                     <div class="divide-y divide-gray-100">
//                                         <!-- Brief Summary Section -->
//                                         <div class="p-4">
//                                             <h6 class="text-sm font-medium text-gray-700 mb-2">Brief Summary</h6>
//                                             <p class="text-sm text-gray-600">${briefSummary}</p>
//                                         </div>
                                        
//                                         ${objectives ? `
//                                             <div class="p-4">
//                                                 <h6 class="text-sm font-medium text-gray-700 mb-2">Study Objectives</h6>
//                                                 <p class="text-sm text-gray-600">${objectives}</p>
//                                             </div>
//                                         ` : ''}
                                        
//                                         <!-- Outcomes Section -->
//                                         ${details.primaryOutcomes && details.primaryOutcomes.length > 0 ? `
//                                             <div class="p-4">
//                                                 <h6 class="text-sm font-medium text-gray-700 mb-2">Primary Outcomes</h6>
//                                                 <ul class="text-sm text-gray-600 space-y-2">
//                                                     ${details.primaryOutcomes.map(outcome => 
//                                                         `<li class="border-l-2 border-blue-400 pl-3 py-1">
//                                                             <div class="font-medium">${outcome.measure || 'Unnamed outcome'}</div>
//                                                             ${outcome.description ? `<div class="text-xs text-gray-500 mt-1">${outcome.description}</div>` : ''}
//                                                         </li>`
//                                                     ).join('')}
//                                                 </ul>
//                                             </div>
//                                         ` : ''}
                                        
//                                         <!-- Approval Relevance -->
//                                         <div class="p-3 bg-blue-50 flex justify-between items-center">
//                                             <div class="flex items-center">
//                                                 <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                                                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
//                                                 </svg>
//                                                 <span class="text-sm text-blue-700">
//                                                     ${study.phase === 'PHASE3' || study.phase === 'PHASE4' ? 
//                                                         'Pivotal trial relevant to approval' : 
//                                                         study.phase === 'PHASE2' ? 
//                                                             'Supportive evidence for efficacy' : 
//                                                             'Early research data (primarily safety)'}
//                                                 </span>
//                                             </div>
//                                             <button data-study-id="${study.id}" class="toggle-study-details px-2 py-1 text-xs bg-white border border-blue-200 rounded text-blue-600 hover:bg-blue-50">
//                                                 View More Details
//                                             </button>
//                                         </div>
//                                     </div>
//                                 </div>
//                             `;
//                         }).join('') : `
//                             <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
//                                 <p class="text-yellow-700">No detailed clinical trial information available.</p>
//                             </div>
//                         `}
//                     </div>
//                 </div>
                
//                 <!-- Studies breakdown by phase -->
//                 <div class="p-6">
//                     <h4 class="text-lg font-medium mb-4 flex items-center text-gray-800">
//                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
//                         </svg>
//                         Studies by Phase
//                     </h4>
                    
//                     <div class="space-y-5">
//     `;
    
//     // Create phase sections with improved styling
//     sortedPhases.forEach(phase => {
//         const phaseStudies = studiesByPhase[phase];
//         const formattedPhase = formatPhase(phase);
//         const phaseColor = getPhaseColor(phase);
        
//         modalContent += `
//             <div class="border rounded-lg overflow-hidden shadow-sm hover:shadow transition-shadow">
//                 <div class="bg-gray-50 p-3 flex justify-between items-center" style="border-left: 4px solid ${phaseColor}">
//                     <div class="flex items-center">
//                         <span class="inline-block w-3 h-3 rounded-full mr-2" style="background-color: ${phaseColor}"></span>
//                         <h5 class="font-medium text-gray-800">${formattedPhase}</h5>
//                     </div>
//                     <span class="text-sm bg-gray-200 text-gray-700 px-2 py-0.5 rounded-full">${phaseStudies.length} studies</span>
//                 </div>
                
//                 <div class="divide-y divide-gray-100">
//         `;
        
//         // List studies in this phase with improved styling
//         phaseStudies.forEach(study => {
//             modalContent += `
//                 <div class="p-4 hover:bg-blue-50 transition-colors">
//                     <div class="flex justify-between items-start mb-2">
//                         <a href="#" class="text-blue-600 hover:text-blue-800 font-medium study-link group" data-nctid="${study.id}">
//                             ${study.title || 'Untitled Study'}
//                             <span class="inline-block transition-transform group-hover:translate-x-1">→</span>
//                         </a>
//                         <div class="flex flex-col items-end">
//                             <span class="text-xs font-medium px-2 py-0.5 rounded bg-gray-100 text-gray-700">${study.year}</span>
//                         </div>
//                     </div>
//                     <div class="flex space-x-3 mt-2">
//                         <a href="#" class="text-sm text-blue-600 hover:text-blue-800 study-link flex items-center" data-nctid="${study.id}">
//                             <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
//                                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
//                             </svg>
//                             View Details
//                         </a>
//                         <a href="https://clinicaltrials.gov/study/${study.id}" target="_blank" class="text-sm text-gray-600 hover:text-gray-800 flex items-center">
//                             <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
//                             </svg>
//                             ClinicalTrials.gov
//                         </a>
//                     </div>
//                 </div>
//             `;
//         });
        
//         modalContent += `
//                 </div>
//             </div>
//         `;
//     });
    
//     modalContent += `
//                     </div>
//                 </div>
//             </div>
            
//             <!-- Footer with export options -->
//             <div class="p-4 border-t bg-gray-50 flex justify-between items-center">
//                 <button id="export-usage-data" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors text-sm flex items-center shadow-sm">
//                     <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
//                     </svg>
//                     Export Data
//                 </button>
                
//                 <a href="#" class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 transition-colors text-sm flex items-center shadow-sm" id="search-all-studies-link" data-item="${itemName}" data-type="${relationType}">
//                     <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
//                     </svg>
//                     View All Studies
//                 </a>
//             </div>
//         </div>
//     `;
    
//     // Insert modal content
//     modal.innerHTML = modalContent;
    
//     // Create the timeline visualization
//     CONDITIONcreateTimelineVisualization(yearData, maxYearCount);
    
//     // Add event listeners
    
//     // 1. Close modal button
//     document.getElementById('close-usage-detail-modal').addEventListener('click', () => {
//         modal.classList.add('hidden');
//     });
    
//     // 2. Close when clicking outside
//     modal.addEventListener('click', (e) => {
//         if (e.target === modal) {
//             modal.classList.add('hidden');
//         }
//     });
    
//     // 3. Study links
//     const studyLinks = modal.querySelectorAll('.study-link');
//     studyLinks.forEach(link => {
//         link.addEventListener('click', (e) => {
//             e.preventDefault();
//             const nctId = e.currentTarget.dataset.nctid;
//             if (nctId) {
//                 // Close the modal
//                 modal.classList.add('hidden');
//                 // View study details
//                 viewStudyDetails(nctId);
//             }
//         });
//     });
    
//     // 4. Export data button
//     document.getElementById('export-usage-data').addEventListener('click', () => {
//         exportUsageData(itemData, itemName);
//     });
    
//     // 5. Search all studies link
//     document.getElementById('search-all-studies-link').addEventListener('click', (e) => {
//         e.preventDefault();
//         const searchItem = e.currentTarget.dataset.item;
//         const searchType = e.currentTarget.dataset.type;
        
//         // Close the modal
//         modal.classList.add('hidden');
        
//         // Trigger search for all studies
//         if (typeof searchForEntity === 'function') {
//             searchForEntity(searchItem, searchType);
//         } else {
//             alert(`Search for all studies with ${searchType}: ${searchItem}`);
//             console.log(`Search for all studies with ${searchType}: ${searchItem}`);
//         }
//     });
    
//     // 6. Toggle study details buttons
//     const toggleButtons = modal.querySelectorAll('.toggle-study-details');
//     toggleButtons.forEach(button => {
//         button.addEventListener('click', (e) => {
//             const studyId = e.currentTarget.dataset.studyId;
//             if (studyId) {
//                 // Close the modal
//                 modal.classList.add('hidden');
//                 // View detailed study information
//                 viewStudyDetails(studyId);
//             }
//         });
//     });
// }

// function showUsageDetailModal(itemData, itemName, entityType) {
//     // Get or create modal container
//     console.log(itemData)
//     let modal = document.getElementById('usage-detail-modal');
//     if (!modal) {
//         modal = document.createElement('div');
//         modal.id = 'usage-detail-modal';
//         modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
//         document.body.appendChild(modal);
//     }
    
//     // Make sure modal is visible
//     modal.classList.remove('hidden');
    
//     // Determine relation type based on entity type
//     const relationType = entityType === 'drug' ? 'condition' : 'drug';
//     const relationTypeName = entityType === 'drug' ? 'Condition' : 'Treatment';
    
//     // Sort studies by year (newest first)
//     const sortedStudies = [...(itemData.studies || [])].sort((a, b) => b.year - a.year);
    
//     // Group studies by phase
//     const studiesByPhase = {};
//     sortedStudies.forEach(study => {
//         const phase = study.phase || 'Unknown';
//         if (!studiesByPhase[phase]) {
//             studiesByPhase[phase] = [];
//         }
//         studiesByPhase[phase].push(study);
//     });
    
//     // Get phase order for sorting
//     const phaseOrder = {
//         "PHASE4": 1,
//         "PHASE3": 2,
//         "PHASE2": 3,
//         "PHASE1_PHASE2": 4,
//         "PHASE1": 5,
//         "PRE_PHASE": 6,
//         "Unknown": 7
//     };
    
//     // Sort phases
//     const sortedPhases = Object.keys(studiesByPhase).sort((a, b) => 
//         (phaseOrder[a] || 999) - (phaseOrder[b] || 999)
//     );
    
//     // Create timeline data for years
//     const yearData = [];
//     const years = Object.keys(itemData.years || {}).map(Number).sort((a, b) => a - b);
    
//     // Find max studies in a year for scaling
//     const maxYearCount = Math.max(...Object.values(itemData.years || {}).map(count => Number(count)));
    
//     years.forEach(year => {
//         const count = itemData.years[year] || 0;
//         yearData.push({
//             year,
//             count
//         });
//     });
    
//     // Check if this item is marked as successful (for condition-drug view)
//     const successBadge = itemData.isSuccessful ? 
//         `<span class="ml-2 text-xs bg-green-100 text-green-800 px-2 py-0.5 rounded-full">Successful Treatment</span>` : '';
    
//     // Create modal content
//     let modalContent = `
//         <div class="bg-white rounded-lg w-full max-w-5xl max-h-[90vh] overflow-hidden flex flex-col shadow-xl">
//             <div class="p-4 border-b bg-gradient-to-r from-blue-50 to-white">
//                 <div class="flex justify-between items-center">
//                     <h3 class="text-xl font-bold text-gray-800">${itemName} ${successBadge}</h3>
//                     <button id="close-usage-detail-modal" class="text-gray-500 hover:text-gray-700 transition-colors">
//                         <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
//                         </svg>
//                     </button>
//                 </div>
//                 <div class="flex items-center mt-1">
//                     <span class="text-sm text-gray-600 flex items-center">
//                         <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
//                         </svg>
//                         ${relationTypeName} studied from ${itemData.earliestYear} to ${itemData.latestYear} 
//                     </span>
//                     <div class="ml-3 px-2 py-0.5 bg-blue-100 text-blue-700 rounded-full text-xs font-medium">
//                         ${itemData.count} total studies
//                     </div>
//                 </div>
//             </div>
            
//             <div class="overflow-y-auto">
//                 <!-- Quick stats -->
//                 <div class="grid grid-cols-1 md:grid-cols-3 gap-4 p-4 border-b">
//                     <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-lg shadow-sm hover:shadow transition-shadow">
//                         <div class="text-sm text-blue-600 font-medium flex items-center">
//                             <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
//                             </svg>
//                             First Studied
//                         </div>
//                         <div class="text-2xl font-bold text-gray-800 mt-1">${itemData.earliestYear}</div>
//                         <div class="text-xs text-gray-500 mt-1">${new Date().getFullYear() - itemData.earliestYear} years ago</div>
//                     </div>
                    
//                     <div class="bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-lg shadow-sm hover:shadow transition-shadow">
//                         <div class="text-sm text-green-600 font-medium flex items-center">
//                             <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
//                             </svg>
//                             Total Studies
//                         </div>
//                         <div class="text-2xl font-bold text-gray-800 mt-1">${itemData.count}</div>
//                         <div class="text-xs text-gray-500 mt-1">Across ${years.length} years</div>
//                     </div>
                    
//                     <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-4 rounded-lg shadow-sm hover:shadow transition-shadow">
//                         <div class="text-sm text-purple-600 font-medium flex items-center">
//                             <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
//                             </svg>
//                             Latest Activity
//                         </div>
//                         <div class="text-2xl font-bold text-gray-800 mt-1">${itemData.latestYear}</div>
//                         <div class="text-xs text-gray-500 mt-1">${itemData.years[itemData.latestYear] || 0} studies in that year</div>
//                     </div>
//                 </div>
                
//                 <!-- Improved Timeline -->
//     <div class="p-6 border-b">
//         <h4 class="text-lg font-medium mb-2 flex items-center text-gray-800">
//             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
//             </svg>
//             Research Activity Timeline
//         </h4>
//         <p class="text-sm text-gray-600 mb-4">
//             Showing all years from ${itemData.earliestYear} to ${itemData.latestYear} 
//         </p>
        
//         <div class="timeline-container h-64 relative px-4">
//             <!-- Will be populated by JavaScript -->
//             <div id="research-timeline" class="h-full"></div>
            
//             <!-- Year labels will be dynamically added -->
//             <div id="timeline-years" class="absolute bottom-0 left-0 right-0 flex justify-between text-xs text-gray-500"></div>
//         </div>
//     </div>
                
//                 <!-- Studies breakdown -->
//                 <div class="p-6">
//                     <h4 class="text-lg font-medium mb-4 flex items-center text-gray-800">
//                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
//                         </svg>
//                         Studies by Phase
//                     </h4>
                    
//                     <div class="space-y-5">
//     `;
    
//     // Create phase sections with improved styling
//     sortedPhases.forEach(phase => {
//         const phaseStudies = studiesByPhase[phase];
//         const formattedPhase = formatPhase(phase);
//         const phaseColor = getPhaseColor(phase);
        
//         modalContent += `
//             <div class="border rounded-lg overflow-hidden shadow-sm hover:shadow transition-shadow">
//                 <div class="bg-gray-50 p-3 flex justify-between items-center" style="border-left: 4px solid ${phaseColor}">
//                     <div class="flex items-center">
//                         <span class="inline-block w-3 h-3 rounded-full mr-2" style="background-color: ${phaseColor}"></span>
//                         <h5 class="font-medium text-gray-800">${formattedPhase}</h5>
//                     </div>
//                     <span class="text-sm bg-gray-200 text-gray-700 px-2 py-0.5 rounded-full">${phaseStudies.length} studies</span>
//                 </div>
                
//                 <div class="divide-y divide-gray-100">
//         `;
        
//         // List studies in this phase with improved styling
//         phaseStudies.forEach(study => {
//             modalContent += `
//                 <div class="p-4 hover:bg-blue-50 transition-colors">
//                     <div class="flex justify-between items-start mb-2">
//                         <a href="#" class="text-blue-600 hover:text-blue-800 font-medium study-link group" data-nctid="${study.id}">
//                             ${study.title || 'Untitled Study'}
//                             <span class="inline-block transition-transform group-hover:translate-x-1">→</span>
//                         </a>
//                         <div class="flex flex-col items-end">
//                             <span class="text-xs font-medium px-2 py-0.5 rounded bg-gray-100 text-gray-700">${study.year}</span>
//                         </div>
//                     </div>
//                     <div class="flex space-x-3 mt-2">
//                         <a href="#" class="text-sm text-blue-600 hover:text-blue-800 study-link flex items-center" data-nctid="${study.id}">
//                             <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
//                                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
//                             </svg>
//                             View Details
//                         </a>
//                         <a href="https://clinicaltrials.gov/study/${study.id}" target="_blank" class="text-sm text-gray-600 hover:text-gray-800 flex items-center">
//                             <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
//                             </svg>
//                             ClinicalTrials.gov
//                         </a>
//                     </div>
//                 </div>
//             `;
//         });
        
//         modalContent += `
//                 </div>
//             </div>
//         `;
//     });
    
//     modalContent += `
//                     </div>
//                 </div>
//             </div>
            
//             <!-- Footer with export options -->
//             <div class="p-4 border-t bg-gray-50 flex justify-between items-center">
//                 <button id="export-usage-data" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors text-sm flex items-center shadow-sm">
//                     <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
//                     </svg>
//                     Export Data
//                 </button>
                
//                 <a href="#" class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 transition-colors text-sm flex items-center shadow-sm" id="search-all-studies-link" data-item="${itemName}" data-type="${relationType}">
//                     <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
//                     </svg>
//                     View All Studies
//                 </a>
//             </div>
//         </div>
//     `;
    
//     // Insert modal content
//     modal.innerHTML = modalContent;
    
//     // Create the timeline visualization
//     CONDITIONcreateTimelineVisualization(yearData, maxYearCount);
    
//     // Add event listeners
    
//     // 1. Close modal button
//     document.getElementById('close-usage-detail-modal').addEventListener('click', () => {
//         modal.classList.add('hidden');
//     });
    
//     // 2. Close when clicking outside
//     modal.addEventListener('click', (e) => {
//         if (e.target === modal) {
//             modal.classList.add('hidden');
//         }
//     });
    
//     // 3. Study links
//     const studyLinks = modal.querySelectorAll('.study-link');
//     studyLinks.forEach(link => {
//         link.addEventListener('click', (e) => {
//             e.preventDefault();
//             const nctId = e.currentTarget.dataset.nctid;
//             if (nctId) {
//                 // Close the modal
//                 modal.classList.add('hidden');
//                 // View study details
//                 viewStudyDetails(nctId);
//             }
//         });
//     });
    
//     // 4. Export data button
//     document.getElementById('export-usage-data').addEventListener('click', () => {
//         exportUsageData(itemData, itemName);
//     });
    
//     // 5. Search all studies link
//     document.getElementById('search-all-studies-link').addEventListener('click', (e) => {
//         e.preventDefault();
//         const searchItem = e.currentTarget.dataset.item;
//         const searchType = e.currentTarget.dataset.type;
        
//         // Close the modal
//         modal.classList.add('hidden');
        
//         // Trigger search for all studies
//         if (typeof searchForEntity === 'function') {
//             searchForEntity(searchItem, searchType);
//         } else {
//             alert(`Search for all studies with ${searchType}: ${searchItem}`);
//             console.log(`Search for all studies with ${searchType}: ${searchItem}`);
//         }
//     });
// }


/**
 * Creates an interactive timeline visualization
 * @param {Array} yearData - Array of year data objects with year and count
 * @param {Number} maxCount - Maximum count for scaling
 */
//  function CONDITIONcreateTimelineVisualization(yearData, maxCount) {
//     const container = document.getElementById('research-timeline');
//     const yearsContainer = document.getElementById('timeline-years');
    
//     if (!container || !yearsContainer || !yearData.length) return;
    
//     // Clear any existing content
//     container.innerHTML = '';
//     yearsContainer.innerHTML = '';
    
//     // Set up dimensions
//     const width = container.clientWidth;
//     const height = 150; // Fixed height for consistency
    
//     // Create SVG element
//     const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
//     svg.setAttribute('width', '100%');
//     svg.setAttribute('height', height);
//     svg.setAttribute('class', 'overflow-visible');
    
//     // Ensure we have the complete year range
//     let minYear = Math.min(...yearData.map(data => data.year));
//     let maxYear = Math.max(...yearData.map(data => data.year));
    
//     // Fill in missing years with zero counts to ensure continuous timeline
//     let completeYearData = [];
//     for (let year = minYear; year <= maxYear; year++) {
//         const existingData = yearData.find(data => data.year === year);
//         completeYearData.push(existingData || { year, count: 0 });
//     }
    
//     // Left and right margins
//     const marginLeft = 50; // Space for y-axis
//     const marginRight = 20; // Space on the right
    
//     // Calculate available width for the chart
//     const chartWidth = width - marginLeft - marginRight;
    
//     // Calculate bar width and gap
//     const totalYears = completeYearData.length;
//     const maxBarWidth = 60; // Maximum width for each bar
//     const minBarWidth = 30; // Minimum width for each bar
//     const minGap = 10; // Minimum gap between bars
    
//     // Calculate ideal bar width based on available space
//     let barWidth, barGap;
    
//     if (totalYears === 1) {
//         // Special case for single year
//         barWidth = Math.min(80, chartWidth * 0.3); // 30% of chart width, max 80px
//         barGap = 0;
//     } else {
//         // Multiple years - calculate width that fits
//         const availableWidthPerYear = chartWidth / totalYears;
//         barWidth = Math.min(maxBarWidth, Math.max(minBarWidth, availableWidthPerYear * 0.7)); // 70% of available width per year
//         barGap = Math.max(minGap, (chartWidth - (barWidth * totalYears)) / (totalYears - 1));
        
//         // Adjust if too tight
//         if (barWidth + barGap > availableWidthPerYear) {
//             barWidth = Math.max(minBarWidth, availableWidthPerYear * 0.7);
//             barGap = Math.max(5, (chartWidth - (barWidth * totalYears)) / (totalYears - 1));
//         }
//     }
    
//     // Draw horizontal grid lines
//     const gridLines = 5;
//     for (let i = 0; i <= gridLines; i++) {
//         const y = height - 30 - (height - 40) * i / gridLines; // Leave room for year labels
//         const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
//         line.setAttribute('x1', marginLeft);
//         line.setAttribute('y1', y);
//         line.setAttribute('x2', width - marginRight);
//         line.setAttribute('y2', y);
//         line.setAttribute('stroke', '#e5e7eb');
//         line.setAttribute('stroke-width', i === 0 ? '2' : '1');
//         svg.appendChild(line);
        
//         // Add count label for grid line
//         if (i > 0) {
//             const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
//             const count = Math.round((maxCount * i / gridLines) * 10) / 10;
//             text.textContent = count;
//             text.setAttribute('x', marginLeft - 8);
//             text.setAttribute('y', y + 4);
//             text.setAttribute('text-anchor', 'end');
//             text.setAttribute('font-size', '10');
//             text.setAttribute('fill', '#6b7280');
//             svg.appendChild(text);
//         }
//     }
    
//     // Add a title for the y-axis
//     const yAxisTitle = document.createElementNS('http://www.w3.org/2000/svg', 'text');
//     yAxisTitle.textContent = 'Number of Studies';
//     yAxisTitle.setAttribute('transform', 'rotate(-90)');
//     yAxisTitle.setAttribute('x', -(height / 2));
//     yAxisTitle.setAttribute('y', 15); // Position from left edge
//     yAxisTitle.setAttribute('text-anchor', 'middle');
//     yAxisTitle.setAttribute('font-size', '10');
//     yAxisTitle.setAttribute('fill', '#4b5563');
//     svg.appendChild(yAxisTitle);
    
//     // Create a group for the bars
//     const barsGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
    
//     // Calculate x positions for each year
//     const totalBarsWidth = totalYears * barWidth + (totalYears - 1) * barGap;
//     let startX;
    
//     if (totalYears === 1) {
//         // Center single bar
//         startX = marginLeft + (chartWidth - barWidth) / 2;
//     } else {
//         // Distribute multiple bars evenly
//         startX = marginLeft + (chartWidth - totalBarsWidth) / 2;
        
//         // Ensure we don't start too far right
//         startX = Math.max(marginLeft, startX);
//     }
    
//     // Draw bars for each year and add year labels
//     completeYearData.forEach((data, index) => {
//         const x = startX + (barWidth + barGap) * index;
//         const barHeight = data.count > 0 ? (data.count / maxCount) * (height - 40) : 0;
//         const y = height - 30 - barHeight; // Leave room for year labels
        
//         // Create bar group
//         const barGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
//         barGroup.setAttribute('class', 'bar-group');
//         barGroup.setAttribute('data-year', data.year);
//         barGroup.setAttribute('data-count', data.count);
        
//         // Create background bar (lighter color)
//         const bgBar = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
//         bgBar.setAttribute('x', x);
//         bgBar.setAttribute('y', height - 30 - (height - 40));
//         bgBar.setAttribute('width', barWidth);
//         bgBar.setAttribute('height', height - 40);
//         bgBar.setAttribute('fill', '#f3f4f6');
//         bgBar.setAttribute('rx', '2');
//         barGroup.appendChild(bgBar);
        
//         // Create the actual bar (skip if count is 0)
//         if (data.count > 0) {
//             const bar = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
//             bar.setAttribute('x', x);
//             bar.setAttribute('y', y);
//             bar.setAttribute('width', barWidth);
//             bar.setAttribute('height', barHeight);
//             bar.setAttribute('fill', `rgba(59, 130, 246, ${0.4 + (data.count / maxCount) * 0.6})`);
//             bar.setAttribute('rx', '2');
//             bar.setAttribute('stroke', '#3b82f6');
//             bar.setAttribute('stroke-width', '1');
//             barGroup.appendChild(bar);
//         }
        
//         // Add year label
//         const yearLabel = document.createElement('div');
//         yearLabel.className = 'absolute text-xs text-gray-600 font-medium';
//         yearLabel.style.left = `${x + barWidth/2}px`;
//         yearLabel.style.bottom = '0';
//         yearLabel.style.transform = 'translateX(-50%)';
//         yearLabel.textContent = data.year;
//         yearsContainer.appendChild(yearLabel);
        
//         // Add tooltip functionality
//         barGroup.addEventListener('mouseenter', (e) => {
//             const tooltip = document.createElement('div');
//             tooltip.className = 'absolute z-10 bg-gray-800 text-white text-xs rounded px-2 py-1 pointer-events-none shadow-lg';
//             tooltip.style.left = `${x + barWidth/2}px`;
//             tooltip.style.bottom = `${height + 10}px`;
//             tooltip.style.transform = 'translateX(-50%)';
//             tooltip.innerHTML = `
//                 <div class="font-bold">${data.year}</div>
//                 <div>${data.count} studies</div>
//             `;
            
//             // Add arrow
//             const arrow = document.createElement('div');
//             arrow.className = 'absolute w-2 h-2 bg-gray-800 transform rotate-45';
//             arrow.style.left = '50%';
//             arrow.style.bottom = '-4px';
//             arrow.style.marginLeft = '-4px';
//             tooltip.appendChild(arrow);
            
//             container.appendChild(tooltip);
//         });
        
//         barGroup.addEventListener('mouseleave', () => {
//             const tooltip = container.querySelector('.absolute.z-10');
//             if (tooltip) tooltip.remove();
//         });
        
//         barsGroup.appendChild(barGroup);
//     });
    
//     // Add the bars group to the SVG
//     svg.appendChild(barsGroup);
    
//     // Append the SVG to the container
//     container.appendChild(svg);
    
//     // Create points array only for years with actual data (count > 0)
//     const dataPoints = completeYearData.filter(data => data.count > 0);
    
//     // Add a line to connect points (trend line)
//     if (dataPoints.length > 1) {
//         const pathPoints = dataPoints.map((data, i) => {
//             // Find the index in the complete year data array
//             const index = completeYearData.findIndex(d => d.year === data.year);
//             const x = startX + (barWidth + barGap) * index + barWidth/2;
//             const y = height - 30 - (data.count / maxCount) * (height - 40);
//             return `${i === 0 ? 'M' : 'L'} ${x} ${y}`;
//         }).join(' ');
        
//         const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
//         path.setAttribute('d', pathPoints);
//         path.setAttribute('stroke', '#2563eb');
//         path.setAttribute('stroke-width', '2');
//         path.setAttribute('fill', 'none');
//         path.setAttribute('stroke-linecap', 'round');
//         path.setAttribute('stroke-linejoin', 'round');
//         svg.appendChild(path);
        
//         // Add dots at each data point (only for years with data)
//         dataPoints.forEach(data => {
//             const index = completeYearData.findIndex(d => d.year === data.year);
//             const x = startX + (barWidth + barGap) * index + barWidth/2;
//             const y = height - 30 - (data.count / maxCount) * (height - 40);
            
//             const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
//             circle.setAttribute('cx', x);
//             circle.setAttribute('cy', y);
//             circle.setAttribute('r', '4');
//             circle.setAttribute('fill', 'white');
//             circle.setAttribute('stroke', '#2563eb');
//             circle.setAttribute('stroke-width', '2');
            
//             // Highlight effect on hover
//             circle.addEventListener('mouseenter', () => {
//                 circle.setAttribute('r', '6');
//                 circle.setAttribute('fill', '#3b82f6');
                
//                 // Show tooltip
//                 const tooltip = document.createElement('div');
//                 tooltip.className = 'absolute z-10 bg-gray-800 text-white text-xs rounded px-2 py-1 pointer-events-none shadow-lg';
//                 tooltip.style.left = `${x}px`;
//                 tooltip.style.bottom = `${height + 10}px`;
//                 tooltip.style.transform = 'translateX(-50%)';
//                 tooltip.innerHTML = `
//                     <div class="font-bold">${data.year}</div>
//                     <div>${data.count} studies</div>
//                 `;
                
//                 // Add arrow
//                 const arrow = document.createElement('div');
//                 arrow.className = 'absolute w-2 h-2 bg-gray-800 transform rotate-45';
//                 arrow.style.left = '50%';
//                 arrow.style.bottom = '-4px';
//                 arrow.style.marginLeft = '-4px';
//                 tooltip.appendChild(arrow);
                
//                 container.appendChild(tooltip);
//             });
            
//             circle.addEventListener('mouseleave', () => {
//                 circle.setAttribute('r', '4');
//                 circle.setAttribute('fill', 'white');
                
//                 const tooltip = container.querySelector('.absolute.z-10');
//                 if (tooltip) tooltip.remove();
//             });
            
//             svg.appendChild(circle);
//         });
//     }
// }


function CONDITIONcreateTimelineVisualization(yearData, maxCount) {
    const container = document.getElementById('research-timeline');
    const yearsContainer = document.getElementById('timeline-years');
    
    if (!container || !yearsContainer || !yearData.length) return;
    
    // Clear any existing content
    container.innerHTML = '';
    yearsContainer.innerHTML = '';
    
    // Check for single-year special case
    const isSingleYear = yearData.length === 1 || 
                        (Math.min(...yearData.map(data => data.year)) === 
                         Math.max(...yearData.map(data => data.year)));
    
    if (isSingleYear) {
        // Create special visualization for a single year
        createSingleYearVisualization(container, yearsContainer, yearData[0], 150);
        return;
    }
    
    // For multiple years, create a scrollable container if needed
    const outerContainer = document.createElement('div');
    outerContainer.className = 'w-full relative';
    container.appendChild(outerContainer);
    
    // Create a scrollable container for the timeline
    const scrollContainer = document.createElement('div');
    scrollContainer.className = 'w-full overflow-x-auto';
    scrollContainer.style.scrollbarWidth = 'thin'; // For Firefox
    scrollContainer.style.scrollbarColor = '#cbd5e1 #f1f5f9'; // For Firefox
    outerContainer.appendChild(scrollContainer);
    
    // Set up dimensions
    const height = 150; // Fixed height for consistency
    
    // Ensure we have the complete year range
    let minYear = Math.min(...yearData.map(data => data.year));
    let maxYear = Math.max(...yearData.map(data => data.year));
    
    // Fill in missing years with zero counts to ensure continuous timeline
    let completeYearData = [];
    for (let year = minYear; year <= maxYear; year++) {
        const existingData = yearData.find(data => data.year === year);
        completeYearData.push(existingData || { year, count: 0 });
    }
    
    // Left and right margins
    const marginLeft = 50; // Space for y-axis
    const marginRight = 20; // Space on the right
    
    // Calculate minimum required width based on number of years
    const totalYears = completeYearData.length;
    const minBarWidth = 50; // Minimum width for each bar
    const minGap = 10; // Minimum gap between bars
    
    // Calculate minimum width needed for the chart
    const minChartWidth = (minBarWidth * totalYears) + (minGap * (totalYears - 1)) + marginLeft + marginRight;
    
    // Create an inner container with minimum width
    const chartContainer = document.createElement('div');
    chartContainer.style.minWidth = `${minChartWidth}px`;
    chartContainer.style.height = `${height + 30}px`; // Add space for year labels
    chartContainer.className = 'relative';
    scrollContainer.appendChild(chartContainer);
    
    // Create SVG element
    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    svg.setAttribute('width', '100%');
    svg.setAttribute('height', height);
    svg.setAttribute('class', 'overflow-visible');
    chartContainer.appendChild(svg);
    
    // Get actual width after rendering
    const width = chartContainer.clientWidth;
    
    // Calculate available width for the chart
    const chartWidth = width - marginLeft - marginRight;
    
    // Calculate bar width and gap
    const maxBarWidth = 80; // Maximum width for each bar
    const barWidth = Math.min(maxBarWidth, Math.max(minBarWidth, (chartWidth - (minGap * (totalYears - 1))) / totalYears));
    const barGap = Math.max(minGap, (chartWidth - (barWidth * totalYears)) / (totalYears - 1));
    
    // Draw horizontal grid lines
    const gridLines = 5;
    for (let i = 0; i <= gridLines; i++) {
        const y = height - 30 - (height - 40) * i / gridLines; // Leave room for year labels
        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.setAttribute('x1', marginLeft);
        line.setAttribute('y1', y);
        line.setAttribute('x2', width - marginRight);
        line.setAttribute('y2', y);
        line.setAttribute('stroke', '#e5e7eb');
        line.setAttribute('stroke-width', i === 0 ? '2' : '1');
        svg.appendChild(line);
        
        // Add count label for grid line
        if (i > 0) {
            const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            const count = Math.round((maxCount * i / gridLines) * 10) / 10;
            text.textContent = count;
            text.setAttribute('x', marginLeft - 8);
            text.setAttribute('y', y + 4);
            text.setAttribute('text-anchor', 'end');
            text.setAttribute('font-size', '10');
            text.setAttribute('fill', '#6b7280');
            svg.appendChild(text);
        }
    }
    
    // Add a title for the y-axis
    const yAxisTitle = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    yAxisTitle.textContent = 'Number of Studies';
    yAxisTitle.setAttribute('transform', 'rotate(-90)');
    yAxisTitle.setAttribute('x', -(height / 2));
    yAxisTitle.setAttribute('y', 15); // Position from left edge
    yAxisTitle.setAttribute('text-anchor', 'middle');
    yAxisTitle.setAttribute('font-size', '10');
    yAxisTitle.setAttribute('fill', '#4b5563');
    svg.appendChild(yAxisTitle);
    
    // Create a group for the bars
    const barsGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
    
    // Calculate starting position for bars
    const startX = marginLeft;
    
    // Create a separate container for year labels to ensure they scroll with the chart
    const scrollableYearsContainer = document.createElement('div');
    scrollableYearsContainer.className = 'relative w-full';
    scrollableYearsContainer.style.height = '20px';
    chartContainer.appendChild(scrollableYearsContainer);
    
    // Draw bars for each year and add year labels
    completeYearData.forEach((data, index) => {
        const x = startX + (barWidth + barGap) * index;
        const barHeight = data.count > 0 ? (data.count / maxCount) * (height - 40) : 0;
        const y = height - 30 - barHeight; // Leave room for year labels
        
        // Create bar group
        const barGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
        barGroup.setAttribute('class', 'bar-group');
        barGroup.setAttribute('data-year', data.year);
        barGroup.setAttribute('data-count', data.count);
        
        // Create background bar (lighter color)
        const bgBar = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
        bgBar.setAttribute('x', x);
        bgBar.setAttribute('y', height - 30 - (height - 40));
        bgBar.setAttribute('width', barWidth);
        bgBar.setAttribute('height', height - 40);
        bgBar.setAttribute('fill', '#f3f4f6');
        bgBar.setAttribute('rx', '2');
        barGroup.appendChild(bgBar);
        
        // Create the actual bar (skip if count is 0)
        if (data.count > 0) {
            const bar = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            bar.setAttribute('x', x);
            bar.setAttribute('y', y);
            bar.setAttribute('width', barWidth);
            bar.setAttribute('height', barHeight);
            bar.setAttribute('fill', `rgba(59, 130, 246, ${0.4 + (data.count / maxCount) * 0.6})`);
            bar.setAttribute('rx', '2');
            bar.setAttribute('stroke', '#3b82f6');
            bar.setAttribute('stroke-width', '1');
            barGroup.appendChild(bar);
        }
        
        // Add year label that scrolls with the chart
        const yearLabel = document.createElement('div');
        yearLabel.className = 'absolute text-xs text-gray-600 font-medium';
        yearLabel.style.left = `${x + barWidth/2}px`;
        yearLabel.style.top = '0';
        yearLabel.style.transform = 'translateX(-50%)';
        yearLabel.textContent = data.year;
        scrollableYearsContainer.appendChild(yearLabel);
        
        // Add tooltip functionality
        barGroup.addEventListener('mouseenter', (e) => {
            const tooltip = document.createElement('div');
            tooltip.className = 'absolute z-10 bg-gray-800 text-white text-xs rounded px-2 py-1 pointer-events-none shadow-lg';
            tooltip.style.left = `${x + barWidth/2}px`;
            tooltip.style.bottom = `${height + 10}px`;
            tooltip.style.transform = 'translateX(-50%)';
            tooltip.innerHTML = `
                <div class="font-bold">${data.year}</div>
                <div>${data.count} studies</div>
            `;
            
            // Add arrow
            const arrow = document.createElement('div');
            arrow.className = 'absolute w-2 h-2 bg-gray-800 transform rotate-45';
            arrow.style.left = '50%';
            arrow.style.bottom = '-4px';
            arrow.style.marginLeft = '-4px';
            tooltip.appendChild(arrow);
            
            chartContainer.appendChild(tooltip);
        });
        
        barGroup.addEventListener('mouseleave', () => {
            const tooltip = chartContainer.querySelector('.absolute.z-10');
            if (tooltip) tooltip.remove();
        });
        
        barsGroup.appendChild(barGroup);
    });
    
    // Add the bars group to the SVG
    svg.appendChild(barsGroup);
    
    // Create points array only for years with actual data (count > 0)
    const dataPoints = completeYearData.filter(data => data.count > 0);
    
    // Add a line to connect points (trend line)
    if (dataPoints.length > 1) {
        const pathPoints = dataPoints.map((data, i) => {
            // Find the index in the complete year data array
            const index = completeYearData.findIndex(d => d.year === data.year);
            const x = startX + (barWidth + barGap) * index + barWidth/2;
            const y = height - 30 - (data.count / maxCount) * (height - 40);
            return `${i === 0 ? 'M' : 'L'} ${x} ${y}`;
        }).join(' ');
        
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute('d', pathPoints);
        path.setAttribute('stroke', '#2563eb');
        path.setAttribute('stroke-width', '2');
        path.setAttribute('fill', 'none');
        path.setAttribute('stroke-linecap', 'round');
        path.setAttribute('stroke-linejoin', 'round');
        svg.appendChild(path);
        
        // Add dots at each data point (only for years with data)
        dataPoints.forEach(data => {
            const index = completeYearData.findIndex(d => d.year === data.year);
            const x = startX + (barWidth + barGap) * index + barWidth/2;
            const y = height - 30 - (data.count / maxCount) * (height - 40);
            
            const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            circle.setAttribute('cx', x);
            circle.setAttribute('cy', y);
            circle.setAttribute('r', '4');
            circle.setAttribute('fill', 'white');
            circle.setAttribute('stroke', '#2563eb');
            circle.setAttribute('stroke-width', '2');
            
            // Highlight effect on hover
            circle.addEventListener('mouseenter', () => {
                circle.setAttribute('r', '6');
                circle.setAttribute('fill', '#3b82f6');
                
                // Show tooltip
                const tooltip = document.createElement('div');
                tooltip.className = 'absolute z-10 bg-gray-800 text-white text-xs rounded px-2 py-1 pointer-events-none shadow-lg';
                tooltip.style.left = `${x}px`;
                tooltip.style.bottom = `${height + 10}px`;
                tooltip.style.transform = 'translateX(-50%)';
                tooltip.innerHTML = `
                    <div class="font-bold">${data.year}</div>
                    <div>${data.count} studies</div>
                `;
                
                // Add arrow
                const arrow = document.createElement('div');
                arrow.className = 'absolute w-2 h-2 bg-gray-800 transform rotate-45';
                arrow.style.left = '50%';
                arrow.style.bottom = '-4px';
                arrow.style.marginLeft = '-4px';
                tooltip.appendChild(arrow);
                
                chartContainer.appendChild(tooltip);
            });
            
            circle.addEventListener('mouseleave', () => {
                circle.setAttribute('r', '4');
                circle.setAttribute('fill', 'white');
                
                const tooltip = chartContainer.querySelector('.absolute.z-10');
                if (tooltip) tooltip.remove();
            });
            
            svg.appendChild(circle);
        });
    }
    
    // Add scroll indicators if content is scrollable
    setTimeout(() => {
        if (scrollContainer.scrollWidth > scrollContainer.clientWidth) {
            // Add scroll indicators
            const leftIndicator = document.createElement('div');
            leftIndicator.className = 'absolute left-0 top-1/2 transform -translate-y-1/2 z-10 opacity-0';
            leftIndicator.innerHTML = `
                <div class="w-8 h-8 flex items-center justify-center rounded-full bg-white shadow-md cursor-pointer">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-600" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                    </svg>
                </div>
            `;
            
            const rightIndicator = document.createElement('div');
            rightIndicator.className = 'absolute right-0 top-1/2 transform -translate-y-1/2 z-10';
            rightIndicator.innerHTML = `
                <div class="w-8 h-8 flex items-center justify-center rounded-full bg-white shadow-md cursor-pointer">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-600" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                    </svg>
                </div>
            `;
            
            // Add click handlers for indicators
            leftIndicator.addEventListener('click', () => {
                scrollContainer.scrollBy({ left: -200, behavior: 'smooth' });
            });
            
            rightIndicator.addEventListener('click', () => {
                scrollContainer.scrollBy({ left: 200, behavior: 'smooth' });
            });
            
            outerContainer.appendChild(leftIndicator);
            outerContainer.appendChild(rightIndicator);
            
            // Show/hide indicators based on scroll position
            const updateIndicators = () => {
                if (scrollContainer.scrollLeft > 10) {
                    leftIndicator.style.opacity = '1';
                    leftIndicator.style.transition = 'opacity 0.2s';
                } else {
                    leftIndicator.style.opacity = '0';
                    leftIndicator.style.transition = 'opacity 0.2s';
                }
                
                if (scrollContainer.scrollLeft + scrollContainer.clientWidth < scrollContainer.scrollWidth - 10) {
                    rightIndicator.style.opacity = '1';
                    rightIndicator.style.transition = 'opacity 0.2s';
                } else {
                    rightIndicator.style.opacity = '0';
                    rightIndicator.style.transition = 'opacity 0.2s';
                }
            };
            
            // Initial update
            updateIndicators();
            
            // Update on scroll
            scrollContainer.addEventListener('scroll', updateIndicators);
            
            // Add a visual hint that the chart is scrollable
            if (totalYears > 6) {
                // Create a subtle gradient overlay on the right edge
                const scrollHint = document.createElement('div');
                scrollHint.className = 'absolute right-0 top-0 h-full pointer-events-none';
                scrollHint.style.width = '50px';
                scrollHint.style.background = 'linear-gradient(to right, rgba(255,255,255,0), rgba(255,255,255,0.8))';
                scrollHint.style.zIndex = '5';
                outerContainer.appendChild(scrollHint);
                
                // Add a subtle animation to draw attention to the scrolling capability
                setTimeout(() => {
                    // Small scroll animation to indicate scrollability
                    if (scrollContainer.scrollLeft === 0) {
                        scrollContainer.scrollBy({ left: 40, behavior: 'smooth' });
                        setTimeout(() => {
                            scrollContainer.scrollBy({ left: -40, behavior: 'smooth' });
                        }, 800);
                    }
                }, 1500);
            }
        }
    }, 100); // Small delay to ensure DOM is fully rendered
}


function createSingleYearVisualization(container, yearsContainer, yearData, height) {
    // Create a cleaner, more focused visualization for single year
    const width = container.clientWidth;
    
    // Create a simple, elegant display using HTML/CSS instead of SVG
    const singleYearContainer = document.createElement('div');
    singleYearContainer.className = 'flex flex-col items-center justify-center w-full h-full';
    
    // Create year label
    const yearLabel = document.createElement('div');
    yearLabel.className = 'text-xl font-bold text-gray-700 mb-2';
    yearLabel.textContent = yearData.year;
    singleYearContainer.appendChild(yearLabel);
    
    // Create a circular indicator
    const circleContainer = document.createElement('div');
    circleContainer.className = 'relative flex items-center justify-center';
    
    // Create outer circle
    const outerCircle = document.createElement('div');
    outerCircle.className = 'w-32 h-32 rounded-full flex items-center justify-center';
    outerCircle.style.background = 'linear-gradient(135deg, #60a5fa, #3b82f6)';
    outerCircle.style.boxShadow = '0 4px 6px rgba(59, 130, 246, 0.5)';
    
    // Create inner circle with count
    const innerCircle = document.createElement('div');
    innerCircle.className = 'w-24 h-24 bg-white rounded-full flex items-center justify-center';
    
    // Count display
    const countDisplay = document.createElement('div');
    countDisplay.className = 'text-center';
    
    const countNumber = document.createElement('div');
    countNumber.className = 'text-3xl font-bold text-gray-800';
    countNumber.textContent = yearData.count;
    
    const countLabel = document.createElement('div');
    countLabel.className = 'text-sm text-gray-600';
    countLabel.textContent = yearData.count === 1 ? 'study' : 'studies';
    
    countDisplay.appendChild(countNumber);
    countDisplay.appendChild(countLabel);
    innerCircle.appendChild(countDisplay);
    outerCircle.appendChild(innerCircle);
    circleContainer.appendChild(outerCircle);
    
    // Add a subtle animation effect on hover
    circleContainer.addEventListener('mouseenter', () => {
        outerCircle.style.transform = 'scale(1.05)';
        outerCircle.style.transition = 'transform 0.3s ease-in-out';
    });
    
    circleContainer.addEventListener('mouseleave', () => {
        outerCircle.style.transform = 'scale(1)';
    });
    
    // Add tooltip on hover
    circleContainer.addEventListener('mouseenter', () => {
        const tooltip = document.createElement('div');
        tooltip.className = 'absolute z-10 bg-gray-800 text-white text-xs rounded px-3 py-2 pointer-events-none shadow-lg';
        tooltip.style.top = '-40px';
        tooltip.style.transform = 'translateX(-50%)';
        tooltip.innerHTML = `<div class="font-bold">${yearData.year}: ${yearData.count} ${yearData.count === 1 ? 'study' : 'studies'}</div>`;
        
        // Add arrow
        const arrow = document.createElement('div');
        arrow.className = 'absolute w-2 h-2 bg-gray-800 transform rotate-45';
        arrow.style.left = '50%';
        arrow.style.bottom = '-4px';
        arrow.style.marginLeft = '-4px';
        tooltip.appendChild(arrow);
        
        circleContainer.appendChild(tooltip);
    });
    
    circleContainer.addEventListener('mouseleave', () => {
        const tooltip = circleContainer.querySelector('.absolute.z-10');
        if (tooltip) tooltip.remove();
    });
    
    singleYearContainer.appendChild(circleContainer);
    
    // Add a small note
    const note = document.createElement('div');
    note.className = 'mt-4 text-sm text-gray-500 italic';
    note.textContent = `All research for this condition was conducted in ${yearData.year}`;
    singleYearContainer.appendChild(note);
    
    
    // Add pulsing effect to highlight that this is the only data point
    const pulseEffect = document.createElement('div');
    pulseEffect.className = 'absolute';
    pulseEffect.style.top = '50%';
    pulseEffect.style.left = '50%';
    pulseEffect.style.width = '48px';
    pulseEffect.style.height = '48px';
    pulseEffect.style.borderRadius = '50%';
    pulseEffect.style.transform = 'translate(-50%, -50%)';
    pulseEffect.style.background = 'rgba(59, 130, 246, 0.3)';
    pulseEffect.style.animation = 'pulse 2s infinite';
    
    // Add the pulse animation
    const styleSheet = document.createElement('style');
    styleSheet.textContent = `
        @keyframes pulse {
            0% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
            70% {
                transform: translate(-50%, -50%) scale(2);
                opacity: 0;
            }
            100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 0;
            }
        }
    `;
    document.head.appendChild(styleSheet);
    
    circleContainer.appendChild(pulseEffect);
    
    // Add the single year container to the main container
    container.appendChild(singleYearContainer);
}

// Example usage:
// const yearData = [{year: 2022, count: 1}];
// const maxCount = 1;
// createTimelineVisualization(yearData, maxCount);

/**
 * Exports data for a specific usage (condition or drug)
 * @param {Object} itemData - Data for the specific item
 * @param {string} itemName - Name of the item
 */
function exportUsageData(itemData, itemName) {
    // Prepare data for CSV export
    const csvRows = [];
    
    // Header row
    csvRows.push(['Study ID', 'Title', 'Year', 'Phase']);
    
    // Data rows
    (itemData.studies || []).forEach(study => {
        csvRows.push([
            study.id,
            study.title || 'Untitled Study',
            study.year,
            study.phase || 'Unknown'
        ]);
    });
    
    // Convert to CSV string
    let csvContent = csvRows.map(row => 
        row.map(cell => 
            typeof cell === 'string' && cell.includes(',') 
                ? `"${cell.replace(/"/g, '""')}"` 
                : String(cell)
        ).join(',')
    ).join('\n');
    
    // Create download link
    const encodedUri = encodeURI('data:text/csv;charset=utf-8,' + csvContent);
    const link = document.createElement('a');
    link.setAttribute('href', encodedUri);
    link.setAttribute('download', `${itemName.replace(/\s+/g, '_')}_studies.csv`);
    document.body.appendChild(link);
    
    // Trigger download
    link.click();
    
    // Clean up
    document.body.removeChild(link);
}

/**
 * Helper function to format phase for display
 * @param {string} phase - Raw phase value
 * @returns {string} - Formatted phase string
 */
function formatPhase(phase) {
    switch(phase) {
        case "PRE_PHASE":
            return "Pre-Clinical";
        case "PHASE1":
            return "Phase 1";
        case "PHASE1_PHASE2":
            return "Phase 1/2";
        case "PHASE2":
            return "Phase 2";
        case "PHASE3":
            return "Phase 3";
        case "PHASE4":
            return "Phase 4";
        default:
            return phase || "Unknown";
    }
}

/**
 * Helper function to get color for phase
 * @param {string} phase - Raw phase value
 * @returns {string} - Color hex code
 */
function getPhaseColor(phase) {
    switch(phase) {
        case "PRE_PHASE":
            return "#9CA3AF"; // gray-400
        case "PHASE1":
            return "#60A5FA"; // blue-400
        case "PHASE1_PHASE2":
            return "#34D399"; // green-400
        case "PHASE2":
            return "#10B981"; // green-500
        case "PHASE3":
            return "#047857"; // green-700
        case "PHASE4":
            return "#064E3B"; // green-900
        default:
            return "#D1D5DB"; // gray-300
    }
}
/**
 * Renders the timeline data as a list
 * @param {Object} data - Processed timeline data
 * @param {string} entityName - Name of drug or condition
 * @param {string} entityType - Either 'drug' or 'condition'
 */
// function renderTimelineList(data, entityName, entityType = 'drug') {
//     const timelineElement = document.getElementById('usage-timeline');
    
//     // Determine which data field to use based on entity type
//     const dataField = entityType === 'drug' ? 'byCondition' : 'byDrug';
//     const itemType = entityType === 'drug' ? 'conditions' : 'treatments';
    
//     // Create sorted array of all items
//     const allItems = Object.keys(data[dataField])
//         .map(item => ({
//             name: item,
//             ...data[dataField][item]
//         }))
//         .sort((a, b) => b.count - a.count);
    
//     // Generate the list HTML
//     let listHTML = `
//         <div class="mb-6">
//             <p class="text-sm text-gray-600">Based on analysis of ${data.totalStudies} clinical trials from ${data.earliestStudyYear} to ${data.latestStudyYear}</p>
//         </div>
        
//         <div class="mb-4">
//             <input type="text" id="timeline-list-search" placeholder="Search ${itemType}..." 
//                    class="w-full p-2 border border-gray-300 rounded shadow-sm text-sm">
//         </div>
        
//         <div class="overflow-x-auto">
//             <table class="w-full border-collapse">
//                 <thead class="bg-gray-50">
//                     <tr>
//                         <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${entityType === 'drug' ? 'Condition' : 'Treatment'}</th>
//                         <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Studies</th>
//                         <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Year Range</th>
//                         <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Peak Activity</th>
//                     </tr>
//                 </thead>
//                 <tbody class="divide-y divide-gray-200" id="timeline-list-body">
//     `;
    
//     allItems.forEach((item, index) => {
//         // Find peak year (year with most studies)
//         let peakYear = null;
//         let peakCount = 0;
        
//         Object.keys(item.years).forEach(year => {
//             if (item.years[year] > peakCount) {
//                 peakCount = item.years[year];
//                 peakYear = year;
//             }
//         });
        
//         listHTML += `
//             <tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}" data-item="${item.name.toLowerCase()}">
//                 <td class="px-4 py-2 text-sm font-medium">
//                     <a href="#" class="item-link text-blue-600 hover:text-blue-800 hover:underline" 
//                        data-item="${item.name}" data-type="${entityType === 'drug' ? 'condition' : 'drug'}">
//                         ${item.name}
//                     </a>
//                 </td>
//                 <td class="px-4 py-2 text-sm text-center">${item.count}</td>
//                 <td class="px-4 py-2 text-sm text-center">${item.earliestYear} - ${item.latestYear}</td>
//                 <td class="px-4 py-2 text-sm text-center">
//                     <span class="inline-flex items-center">
//                         ${peakYear ? `${peakYear} (${peakCount} studies)` : 'N/A'}
//                         <button class="ml-2 text-blue-500 hover:text-blue-700 view-year-studies"
//                                 data-year="${peakYear}" 
//                                 data-item="${item.name}"
//                                 data-count="${peakCount}">
//                             <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
//                                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
//                             </svg>
//                         </button>
//                     </span>
//                 </td>
//             </tr>
//         `;
//     });
    
//     listHTML += `
//                 </tbody>
//             </table>
//         </div>
        
//         <!-- Study details popup -->
//         <div id="list-study-popup" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
//             <div class="bg-white rounded-lg w-full max-w-2xl max-h-[80vh] overflow-hidden flex flex-col">
//                 <div class="p-4 border-b flex justify-between items-center">
//                     <h3 class="text-lg font-bold" id="list-popup-title">Studies</h3>
//                     <button id="close-list-popup" class="text-gray-500 hover:text-gray-700">
//                         <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
//                         </svg>
//                     </button>
//                 </div>
//                 <div class="overflow-y-auto p-4" id="list-popup-content">
//                     <!-- Content will be dynamically inserted here -->
//                 </div>
//             </div>
//         </div>
//     `;
    
//     // Update the timeline element
//     timelineElement.innerHTML = listHTML;
    
//     // Add event listeners
    
//     // 1. Search functionality
//     const searchInput = document.getElementById('timeline-list-search');
//     if (searchInput) {
//         searchInput.addEventListener('input', (e) => {
//             const searchTerm = e.target.value.toLowerCase();
//             const rows = document.querySelectorAll('#timeline-list-body tr');
            
//             rows.forEach(row => {
//                 const itemName = row.dataset.item;
//                 if (!searchTerm || itemName.includes(searchTerm)) {
//                     row.style.display = '';
//                 } else {
//                     row.style.display = 'none';
//                 }
//             });
//         });
//     }
    
//     // 2. Item links
//     const itemLinks = document.querySelectorAll('.item-link');
//     itemLinks.forEach(link => {
//         link.addEventListener('click', (e) => {
//             e.preventDefault();
//             const itemName = e.target.dataset.item;
//             const itemType = e.target.dataset.type;
            
//             // Trigger search for this item
//             if (typeof searchForEntity === 'function') {
//                 searchForEntity(itemName, itemType);
//             } else {
//                 alert(`Search for ${itemType}: ${itemName} would be triggered here`);
//                 console.log(`Search for ${itemType}: ${itemName}`);
//             }
//         });
//     });
    
//     // 3. View year studies buttons
//     const viewYearButtons = document.querySelectorAll('.view-year-studies');
//     viewYearButtons.forEach(button => {
//         button.addEventListener('click', () => {
//             const year = button.dataset.year;
//             const item = button.dataset.item;
//             const count = button.dataset.count;
            
//             // Find studies for this year and item
//             const itemData = data[dataField][item];
//             if (!itemData || !itemData.studies) return;
            
//             const yearStudies = itemData.studies.filter(study => study.year == year);
            
//             // Show popup with links to studies
//             const popup = document.getElementById('list-study-popup');
//             const popupTitle = document.getElementById('list-popup-title');
//             const popupContent = document.getElementById('list-popup-content');
            
//             popupTitle.textContent = `${count} Studies for ${item} (${year})`;
            
//             let studyListHTML = `<ul class="space-y-2">`;
            
//             yearStudies.forEach((study, i) => {
//                 studyListHTML += `
//                     <li class="border-b border-gray-100 pb-2">
//                         <a href="#" class="text-blue-600 hover:text-blue-800 font-medium study-link" data-nctid="${study.id}">
//                             ${study.title || `Study ${i+1}`}
//                         </a>
//                     </li>
//                 `;
//             });
            
//             studyListHTML += `</ul>`;
//             popupContent.innerHTML = studyListHTML;
            
//             // Add event listeners to study links
//             const studyLinks = popupContent.querySelectorAll('.study-link');
//             studyLinks.forEach(link => {
//                 link.addEventListener('click', (e) => {
//                     e.preventDefault();
//                     const nctId = e.target.dataset.nctid;
//                     if (nctId) {
//                         // Close the popup
//                         popup.classList.add('hidden');
//                         // View study details
//                         viewStudyDetails(nctId);
//                     }
//                 });
//             });
            
//             // Show the popup
//             popup.classList.remove('hidden');
//         });
//     });
    
//     // 4. Close popup button
//     const closePopupButton = document.getElementById('close-list-popup');
//     if (closePopupButton) {
//         closePopupButton.addEventListener('click', () => {
//             document.getElementById('list-study-popup').classList.add('hidden');
//         });
//     }
    
//     // 5. Close popup when clicking outside
//     const popup = document.getElementById('list-study-popup');
//     if (popup) {
//         popup.addEventListener('click', (e) => {
//             if (e.target === popup) {
//                 popup.classList.add('hidden');
//             }
//         });
//     }
// }

function renderTimelineList(data, entityName, entityType = 'drug') {
    const timelineElement = document.getElementById('usage-timeline');
    
    // Determine which data field to use based on entity type
    const dataField = entityType === 'drug' ? 'byCondition' : 'byDrug';
    const itemType = entityType === 'drug' ? 'conditions' : 'treatments';
    
    // Create sorted array of all items
    const allItems = Object.keys(data[dataField])
        .map(item => ({
            name: item,
            ...data[dataField][item]
        }))
        .sort((a, b) => b.count - a.count);
    
    // Generate the list HTML
    let listHTML = `
        <div class="mb-6">
            <p class="text-sm text-gray-600">Based on analysis of ${data.totalStudies} clinical trials from ${data.earliestStudyYear} to ${data.latestStudyYear}</p>
        </div>
        
        <div class="mb-4">
            <input type="text" id="timeline-list-search" placeholder="Search ${itemType}..." 
                   class="w-full p-2 border border-gray-300 rounded shadow-sm text-sm">
        </div>
        
        <div class="overflow-x-auto">
            <table class="w-full border-collapse">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${entityType === 'drug' ? 'Condition' : 'Treatment'}</th>
                        <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Studies</th>
                        <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Year Range</th>
                        <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Peak Activity</th>
                        ${entityType === 'condition' ? '<th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>' : ''}
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200" id="timeline-list-body">
    `;
    
    allItems.forEach((item, index) => {
        // Find peak year (year with most studies)
        let peakYear = null;
        let peakCount = 0;
        
        Object.keys(item.years).forEach(year => {
            if (item.years[year] > peakCount) {
                peakCount = item.years[year];
                peakYear = year;
            }
        });
        
        // Add success badge for condition view
        const successStatus = (entityType === 'condition' && item.isSuccessful) ? 
            '<span class="inline-block px-2 py-0.5 bg-green-100 text-green-800 text-xs rounded-full">Successful</span>' : 
            '';
        
        listHTML += `
            <tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}" data-item="${item.name.toLowerCase()}">
                <td class="px-4 py-2 text-sm font-medium">
                    <a href="#" class="item-link text-blue-600 hover:text-blue-800 hover:underline" 
                       data-item="${item.name}" data-type="${entityType === 'drug' ? 'condition' : 'drug'}">
                        ${item.name}
                    </a>
                </td>
                <td class="px-4 py-2 text-sm text-center">${item.count}</td>
                <td class="px-4 py-2 text-sm text-center">${item.earliestYear} - ${item.latestYear}</td>
                <td class="px-4 py-2 text-sm text-center">
                    <span class="inline-flex items-center">
                        ${peakYear ? `${peakYear} (${peakCount} studies)` : 'N/A'}
                        <button class="ml-2 text-blue-500 hover:text-blue-700 view-year-studies"
                                data-year="${peakYear}" 
                                data-item="${item.name}"
                                data-count="${peakCount}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                            </svg>
                        </button>
                    </span>
                </td>
                ${entityType === 'condition' ? `<td class="px-4 py-2 text-sm text-center">${successStatus}</td>` : ''}
            </tr>
        `;
    });
    
    listHTML += `
                </tbody>
            </table>
        </div>
        
        <!-- Study details popup -->
        <div id="list-study-popup" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-lg w-full max-w-2xl max-h-[80vh] overflow-hidden flex flex-col">
                <div class="p-4 border-b flex justify-between items-center">
                    <h3 class="text-lg font-bold" id="list-popup-title">Studies</h3>
                    <button id="close-list-popup" class="text-gray-500 hover:text-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="overflow-y-auto p-4" id="list-popup-content">
                    <!-- Content will be dynamically inserted here -->
                </div>
            </div>
        </div>
    `;
    
    // Update the timeline element
    timelineElement.innerHTML = listHTML;
    
    // Add event listeners
    
    // 1. Search functionality
    const searchInput = document.getElementById('timeline-list-search');
    if (searchInput) {
        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('#timeline-list-body tr');
            
            rows.forEach(row => {
                const itemName = row.dataset.item;
                if (!searchTerm || itemName.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });
    }
    
    // 2. Item links
    const itemLinks = document.querySelectorAll('.item-link');
    itemLinks.forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const itemName = e.target.dataset.item;
            const itemType = e.target.dataset.type;
            
            // Get the data for this item
            const itemData = data[dataField][itemName];
            
            if (itemData) {
                // Show detailed modal
                showUsageDetailModal(itemData, itemName, entityType);
            } else {
                // Fallback to search
                if (typeof searchForEntity === 'function') {
                    searchForEntity(itemName, itemType);
                } else {
                    alert(`Search for ${itemType}: ${itemName}`);
                    console.log(`Search for ${itemType}: ${itemName}`);
                }
            }
        });
    });
    
    // 3. View year studies buttons
    const viewYearButtons = document.querySelectorAll('.view-year-studies');
    viewYearButtons.forEach(button => {
        button.addEventListener('click', () => {
            const year = button.dataset.year;
            const item = button.dataset.item;
            const count = button.dataset.count;
            
            // Find studies for this year and item
            const itemData = data[dataField][item];
            if (!itemData || !itemData.studies) return;
            
            const yearStudies = itemData.studies.filter(study => study.year == year);
            
            // Show popup with links to studies
            const popup = document.getElementById('list-study-popup');
            const popupTitle = document.getElementById('list-popup-title');
            const popupContent = document.getElementById('list-popup-content');
            
            popupTitle.textContent = `${count} Studies for ${item} (${year})`;
            
            let studyListHTML = `<ul class="space-y-2">`;
            
            yearStudies.forEach((study, i) => {
                studyListHTML += `
                    <li class="border-b border-gray-100 pb-2">
                        <a href="#" class="text-blue-600 hover:text-blue-800 font-medium study-link" data-nctid="${study.id}">
                            ${study.title || `Study ${i+1}`}
                        </a>
                    </li>
                `;
            });
            
            studyListHTML += `</ul>`;
            popupContent.innerHTML = studyListHTML;
            
            // Add event listeners to study links
            const studyLinks = popupContent.querySelectorAll('.study-link');
            studyLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const nctId = e.target.dataset.nctid;
                    if (nctId) {
                        // Close the popup
                        popup.classList.add('hidden');
                        // View study details
                        viewStudyDetails(nctId);
                    }
                });
            });
            
            // Show the popup
            popup.classList.remove('hidden');
        });
    });
    
    // 4. Close popup button
    const closePopupButton = document.getElementById('close-list-popup');
    if (closePopupButton) {
        closePopupButton.addEventListener('click', () => {
            document.getElementById('list-study-popup').classList.add('hidden');
        });
    }
    
    // 5. Close popup when clicking outside
    const popup = document.getElementById('list-study-popup');
    if (popup) {
        popup.addEventListener('click', (e) => {
            if (e.target === popup) {
                popup.classList.add('hidden');
            }
        });
    }
}



/**
 * Shows a modal with all items in the timeline
 * @param {Object} data - Processed timeline data
 * @param {string} entityName - Name of drug or condition
 * @param {string} entityType - Either 'drug' or 'condition'
 */
// function showAllItemsModal(data, entityName, entityType = 'drug') {
//     // Create a modal to display all items
//     const modal = document.createElement('div');
//     modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
    
//     // Determine which data field to use based on entity type
//     const dataField = entityType === 'drug' ? 'byCondition' : 'byDrug';
//     const itemType = entityType === 'drug' ? 'Conditions' : 'Treatments';
    
//     // Sort all items by count
//     const allItems = Object.keys(data[dataField])
//         .map(item => ({
//             name: item,
//             count: data[dataField][item].count,
//             earliestYear: data[dataField][item].earliestYear,
//             latestYear: data[dataField][item].latestYear
//         }))
//         .sort((a, b) => b.count - a.count);
    
//     // Create the modal content
//     let modalContent = `
//         <div class="bg-white rounded-lg w-full max-w-4xl max-h-[80vh] overflow-hidden flex flex-col">
//             <div class="p-4 border-b">
//                 <div class="flex justify-between items-center">
//                     <h3 class="text-xl font-bold">All ${itemType} for ${entityName}</h3>
//                     <button id="close-items-modal" class="text-gray-500 hover:text-gray-700">
//                         <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
//                         </svg>
//                     </button>
//                 </div>
//                 <p class="text-sm text-gray-500">${allItems.length} total ${itemType.toLowerCase()} found in clinical trials</p>
                
//                 <div class="mt-2">
//                     <input type="text" id="modal-search" placeholder="Search ${itemType.toLowerCase()}..." 
//                            class="w-full p-2 border border-gray-300 rounded shadow-sm text-sm">
//                 </div>
//             </div>
//             <div class="overflow-y-auto p-4">
//                 <table class="w-full">
//                     <thead class="bg-gray-50">
//                         <tr>
//                             <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${entityType === 'drug' ? 'Condition' : 'Treatment'}</th>
//                             <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Studies</th>
//                             <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Year Range</th>
//                             <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
//                         </tr>
//                     </thead>
//                     <tbody class="divide-y divide-gray-200" id="modal-items-list">
//     `;
    
//     allItems.forEach((item, index) => {
//         modalContent += `
//             <tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}" data-item="${item.name.toLowerCase()}">
//                 <td class="px-4 py-2 text-sm">${item.name}</td>
//                 <td class="px-4 py-2 text-sm text-center">${item.count}</td>
//                 <td class="px-4 py-2 text-sm text-center">${item.earliestYear} - ${item.latestYear}</td>
//                 <td class="px-4 py-2 text-sm text-center">
//                     <button class="text-blue-600 hover:text-blue-800 view-item-studies"
//                             data-item="${item.name}" data-type="${entityType === 'drug' ? 'condition' : 'drug'}">
//                         View Studies
//                     </button>
//                 </td>
//             </tr>
//         `;
//     });
    
//     modalContent += `
//                     </tbody>
//                 </table>
//             </div>
//         </div>
//     `;
    
//     modal.innerHTML = modalContent;
//     document.body.appendChild(modal);
    
//     // Add event listeners
    
//     // 1. Close modal button
//     document.getElementById('close-items-modal').addEventListener('click', () => {
//         document.body.removeChild(modal);
//     });
    
//     // 2. Close when clicking outside
//     modal.addEventListener('click', (e) => {
//         if (e.target === modal) {
//             document.body.removeChild(modal);
//         }
//     });
    
//     // 3. Search functionality
//     const searchInput = document.getElementById('modal-search');
//     if (searchInput) {
//         searchInput.addEventListener('input', (e) => {
//             const searchTerm = e.target.value.toLowerCase();
//             const rows = document.querySelectorAll('#modal-items-list tr');
            
//             rows.forEach(row => {
//                 const itemName = row.dataset.item;
//                 if (!searchTerm || itemName.includes(searchTerm)) {
//                     row.style.display = '';
//                 } else {
//                     row.style.display = 'none';
//                 }
//             });
//         });
//     }
    
//     // 4. View item studies buttons
//     const viewItemButtons = document.querySelectorAll('.view-item-studies');
//     viewItemButtons.forEach(button => {
//         button.addEventListener('click', () => {
//             const itemName = button.dataset.item;
//             const itemType = button.dataset.type;
            
//             // Close the modal
//             document.body.removeChild(modal);
            
//             // Redirect to item-specific page or trigger search
//             if (typeof searchForEntity === 'function') {
//                 searchForEntity(itemName, itemType);
//             } else {
//                 alert(`Search for ${itemType}: ${itemName} would be triggered here`);
//                 console.log(`Search for ${itemType}: ${itemName}`);
//             }
//         });
//     });
// }

function showAllItemsModal(data, entityName, entityType = 'drug') {
    // Create a modal to display all items
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
    
    // Determine which data field to use based on entity type
    const dataField = entityType === 'drug' ? 'byCondition' : 'byDrug';
    const itemType = entityType === 'drug' ? 'Conditions' : 'Treatments';
    
    // Sort all items by count
    const allItems = Object.keys(data[dataField])
        .map(item => ({
            name: item,
            count: data[dataField][item].count,
            earliestYear: data[dataField][item].earliestYear,
            latestYear: data[dataField][item].latestYear,
            isSuccessful: data[dataField][item].isSuccessful || false
        }))
        .sort((a, b) => b.count - a.count);
    
    // Check if we're showing condition data (to add success column)
    const showSuccessColumn = entityType === 'condition';
    
    // Create the modal content
    let modalContent = `
        <div class="bg-white rounded-lg w-full max-w-4xl max-h-[80vh] overflow-hidden flex flex-col">
            <div class="p-4 border-b">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold">All ${itemType} for ${entityName}</h3>
                    <button id="close-items-modal" class="text-gray-500 hover:text-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <p class="text-sm text-gray-500">${allItems.length} total ${itemType.toLowerCase()} found in clinical trials</p>
                
                <div class="mt-2">
                    <input type="text" id="modal-search" placeholder="Search ${itemType.toLowerCase()}..." 
                           class="w-full p-2 border border-gray-300 rounded shadow-sm text-sm">
                </div>
            </div>
            <div class="overflow-y-auto p-4">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${entityType === 'drug' ? 'Condition' : 'Treatment'}</th>
                            <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Studies</th>
                            <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Year Range</th>
                            ${showSuccessColumn ? '<th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>' : ''}
                            <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200" id="modal-items-list">
    `;
    
    allItems.forEach((item, index) => {
        // Add success status badge for conditions
        const successBadge = (showSuccessColumn && item.isSuccessful) ? 
            '<span class="inline-block px-2 py-0.5 bg-green-100 text-green-800 text-xs rounded-full">Successful</span>' : 
            '';
            
        modalContent += `
            <tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}" data-item="${item.name.toLowerCase()}">
                <td class="px-4 py-2 text-sm">${item.name}</td>
                <td class="px-4 py-2 text-sm text-center">${item.count}</td>
                <td class="px-4 py-2 text-sm text-center">${item.earliestYear} - ${item.latestYear}</td>
                ${showSuccessColumn ? `<td class="px-4 py-2 text-sm text-center">${successBadge}</td>` : ''}
                <td class="px-4 py-2 text-sm text-center">
                    <button class="text-blue-600 hover:text-blue-800 view-item-studies"
                            data-item="${item.name}" data-type="${entityType === 'drug' ? 'condition' : 'drug'}">
                        View Studies
                    </button>
                </td>
            </tr>
        `;
    });
    
    modalContent += `
                    </tbody>
                </table>
            </div>
        </div>
    `;
    
    modal.innerHTML = modalContent;
    document.body.appendChild(modal);
    
    // Add event listeners
    
    // 1. Close modal button
    document.getElementById('close-items-modal').addEventListener('click', () => {
        document.body.removeChild(modal);
    });
    
    // 2. Close when clicking outside
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            document.body.removeChild(modal);
        }
    });
    
    // 3. Search functionality
    const searchInput = document.getElementById('modal-search');
    if (searchInput) {
        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('#modal-items-list tr');
            
            rows.forEach(row => {
                const itemName = row.dataset.item;
                if (!searchTerm || itemName.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });
    }
    
    // 4. View item studies buttons
    const viewItemButtons = document.querySelectorAll('.view-item-studies');
    viewItemButtons.forEach(button => {
        button.addEventListener('click', () => {
            const itemName = button.dataset.item;
            const itemType = button.dataset.type;
            
            // Close the modal
            document.body.removeChild(modal);
            
            // Get detailed data for this item
            const itemData = data[dataField][itemName];
            
            if (itemData) {
                // Show detailed modal with studies
                showUsageDetailModal(itemData, itemName, entityType);
            } else {
                // Fallback to search
                if (typeof searchForEntity === 'function') {
                    searchForEntity(itemName, itemType);
                } else {
                    alert(`Search for ${itemType}: ${itemName} would be triggered here`);
                    console.log(`Search for ${itemType}: ${itemName}`);
                }
            }
        });
    });
}

/**
 * Add filter buttons to the timeline to help with navigation and analysis
 * @param {HTMLElement} timelineContainer - The timeline container element
 * @param {Object} data - Processed timeline data
 * @param {string} entityType - Either 'drug' or 'condition'
 */
 function addTimelineFilters(timelineContainer, data, entityType) {
    const filterContainer = document.createElement('div');
    filterContainer.className = 'mb-4 flex flex-wrap gap-2';
    
    let filterHTML = `
        <div class="text-sm text-gray-600 mr-2 pt-1">Filter by:</div>
    `;
    
    // Add "All" button
    filterHTML += `
        <button class="px-3 py-1 bg-blue-500 text-white rounded text-sm timeline-filter active" data-filter="all">
            All
        </button>
    `;
    
    // Add condition-specific filters
    if (entityType === 'condition') {
        filterHTML += `
            <button class="px-3 py-1 bg-gray-200 text-gray-700 rounded text-sm timeline-filter" data-filter="successful">
                Successful Treatments
            </button>
            <button class="px-3 py-1 bg-gray-200 text-gray-700 rounded text-sm timeline-filter" data-filter="late-phase">
                Late Phase Studies
            </button>
        `;
    }
    
    // Add drug-specific filters
    if (entityType === 'drug') {
        filterHTML += `
            <button class="px-3 py-1 bg-gray-200 text-gray-700 rounded text-sm timeline-filter" data-filter="late-phase">
                Late Phase Trials
            </button>
        `;
    }
    
    // Add common filters
    filterHTML += `
        <button class="px-3 py-1 bg-gray-200 text-gray-700 rounded text-sm timeline-filter" data-filter="recent">
            Recent (5 years)
        </button>
        <div class="ml-auto">
            <select id="sort-timeline" class="px-3 py-1 border border-gray-300 rounded text-sm">
                <option value="count">Sort by Study Count</option>
                <option value="recent">Sort by Recent Activity</option>
                <option value="earliest">Sort by First Studied</option>
            </select>
        </div>
    `;
    
    filterContainer.innerHTML = filterHTML;
    
    // Insert after the timeline title
    const titleElement = timelineContainer.querySelector('h2');
    if (titleElement && titleElement.parentNode) {
        titleElement.parentNode.parentNode.insertBefore(filterContainer, titleElement.parentNode.nextSibling);
    }
    
    // Add event listeners for filters
    const filterButtons = timelineContainer.querySelectorAll('.timeline-filter');
    filterButtons.forEach(button => {
        button.addEventListener('click', () => {
            // Update active state
            filterButtons.forEach(btn => btn.classList.replace('bg-blue-500', 'bg-gray-200'));
            filterButtons.forEach(btn => btn.classList.replace('text-white', 'text-gray-700'));
            button.classList.replace('bg-gray-200', 'bg-blue-500');
            button.classList.replace('text-gray-700', 'text-white');
            
            // Apply the filter
            const filterType = button.dataset.filter;
            applyTimelineFilter(data, filterType, entityType);
        });
    });
    
    // Add event listener for sorting
    const sortSelect = timelineContainer.querySelector('#sort-timeline');
    if (sortSelect) {
        sortSelect.addEventListener('change', () => {
            const sortType = sortSelect.value;
            applyTimelineSort(data, sortType, entityType);
        });
    }
}

/**
 * Apply a filter to the timeline visualization
 * @param {Object} data - Processed timeline data
 * @param {string} filterType - Type of filter to apply
 * @param {string} entityType - Either 'drug' or 'condition'
 */
function applyTimelineFilter(data, filterType, entityType) {
    const dataField = entityType === 'drug' ? 'byCondition' : 'byDrug';
    const currentYear = new Date().getFullYear();
    
    // Get all tracks
    const tracks = document.querySelectorAll('.item-track');
    
    tracks.forEach(track => {
        const itemName = track.dataset.item;
        const itemData = data[dataField][itemName] || {};
        
        // Default visibility
        let isVisible = true;
        
        // Apply filters
        switch (filterType) {
            case 'all':
                // Show everything
                isVisible = true;
                break;
                
            case 'successful':
                // Only successful treatments (for condition view)
                isVisible = itemData.isSuccessful === true;
                break;
                
            case 'late-phase':
                // Only items with late phase studies
                isVisible = itemData.studies && itemData.studies.some(study => 
                    study.phase === 'PHASE3' || study.phase === 'PHASE4'
                );
                break;
                
            case 'recent':
                // Items with studies in the last 5 years
                isVisible = itemData.latestYear && (currentYear - itemData.latestYear <= 5);
                break;
        }
        
        // Update track visibility
        track.style.display = isVisible ? '' : 'none';
    });
}

/**
 * Apply sorting to the timeline visualization
 * @param {Object} data - Processed timeline data
 * @param {string} sortType - Type of sorting to apply
 * @param {string} entityType - Either 'drug' or 'condition'
 */
function applyTimelineSort(data, sortType, entityType) {
    const dataField = entityType === 'drug' ? 'byCondition' : 'byDrug';
    const tracksContainer = document.querySelector('.timeline-tracks');
    const tracks = Array.from(document.querySelectorAll('.item-track'));
    
    // Remove existing tracks
    tracks.forEach(track => track.remove());
    
    // Sort tracks
    tracks.sort((a, b) => {
        const itemNameA = a.querySelector('.item-link').dataset.item;
        const itemNameB = b.querySelector('.item-link').dataset.item;
        
        const itemDataA = data[dataField][itemNameA] || {};
        const itemDataB = data[dataField][itemNameB] || {};
        
        switch (sortType) {
            case 'count':
                return (itemDataB.count || 0) - (itemDataA.count || 0);
                
            case 'recent':
                return (itemDataB.latestYear || 0) - (itemDataA.latestYear || 0);
                
            case 'earliest':
                return (itemDataA.earliestYear || Infinity) - (itemDataB.earliestYear || Infinity);
                
            default:
                return (itemDataB.count || 0) - (itemDataA.count || 0);
        }
    });
    
    // Add sorted tracks back to container
    tracks.forEach(track => {
        tracksContainer.appendChild(track);
    });
}

/**
 * Generates insights based on timeline data
 * @param {Object} data - Processed timeline data
 * @param {string} entityName - Name of the drug or condition
 * @param {Array} sortedItems - Array of sorted items (conditions or drugs)
 * @param {string} entityType - Either 'drug' or 'condition'
 * @returns {Array} - Array of insight strings
 */
// function generateInsights(data, entityName, sortedItems, entityType = 'drug') {
//     const insights = [];
//     const currentYear = new Date().getFullYear();
    
//     // Determine field and terminology based on entity type
//     const dataField = entityType === 'drug' ? 'byCondition' : 'byDrug';
//     const itemType = entityType === 'drug' ? 'condition' : 'treatment';
    
//     // Insight 1: First studied indication/treatment
//     if (sortedItems.length > 0) {
//         const firstItem = [...sortedItems].sort((a, b) => a.earliestYear - b.earliestYear)[0];
//         if (entityType === 'drug') {
//             insights.push(
//                 `${entityName} was first studied for <strong>${firstItem.name}</strong> in ${firstItem.earliestYear}, ${currentYear - firstItem.earliestYear} years ago.`
//             );
//         } else {
//             insights.push(
//                 `${entityName} was first treated with <strong>${firstItem.name}</strong> in clinical trials starting in ${firstItem.earliestYear}, ${currentYear - firstItem.earliestYear} years ago.`
//             );
//         }
//     }
    
//     // Insight 2: Most studied indication/treatment
//     const mostStudiedItem = sortedItems.length > 0 ? sortedItems[0] : null;
//     if (mostStudiedItem) {
//         if (entityType === 'drug') {
//             insights.push(
//                 `The most researched application has been <strong>${mostStudiedItem.name}</strong> with ${mostStudiedItem.count} studies.`
//             );
//         } else {
//             insights.push(
//                 `The most commonly investigated treatment has been <strong>${mostStudiedItem.name}</strong> with ${mostStudiedItem.count} studies.`
//             );
//         }
//     }
    
//     // Insight 3: Count unique conditions/treatments
//     const uniqueItemCount = Object.keys(data[dataField]).length;
//     if (entityType === 'drug') {
//         insights.push(
//             `${entityName} has been investigated for ${uniqueItemCount} distinct clinical conditions, showing its potential versatility across multiple medical applications.`
//         );
//     } else {
//         insights.push(
//             `${entityName} has been studied with ${uniqueItemCount} different treatments in clinical trials, reflecting the diverse therapeutic approaches being explored.`
//         );
//     }
    
//     // Insight 4: Phase progression
//     const phaseData = data.byPhase;
//     const latePhaseCount = (phaseData.PHASE3 || []).length + (phaseData.PHASE4 || []).length;
//     const totalPhaseCount = Object.values(phaseData).flat().length;
    
//     if (totalPhaseCount > 0) {
//         const latePhasePercentage = Math.round((latePhaseCount / totalPhaseCount) * 100);
//         insights.push(
//             `${latePhasePercentage}% of studies have reached late-stage (Phase 3-4) clinical trials, indicating ${latePhasePercentage > 30 ? 'significant' : 'ongoing'} progress toward regulatory approval.`
//         );
//     }
    
//     // Insight 5: Recent activity and trend
//     const recentYears = currentYear - 5;
//     let recentActivityCount = 0;
//     const recentItems = new Set();
    
//     sortedItems.forEach(item => {
//         Object.keys(item.years).forEach(year => {
//             if (parseInt(year) >= recentYears) {
//                 recentActivityCount += item.years[year];
//                 recentItems.add(item.name);
//             }
//         });
//     });
    
//     if (recentItems.size > 0) {
//         const topRecentItems = Array.from(recentItems).slice(0, 3);
//         if (topRecentItems.length > 0) {
//             if (entityType === 'drug') {
//                 insights.push(
//                     `In the last 5 years, research has focused on ${recentItems.size} conditions, with notable interest in <strong>${topRecentItems.join('</strong>, <strong>')}</strong>.`
//                 );
//             } else {
//                 insights.push(
//                     `In the last 5 years, clinical research has explored ${recentItems.size} treatments, with significant focus on <strong>${topRecentItems.join('</strong>, <strong>')}</strong>.`
//                 );
//             }
//         }
//     }
    
//     // Insight 6: Historical perspective
//     const yearSpan = data.latestStudyYear - data.earliestStudyYear;
//     if (yearSpan >= 10) {
//         insights.push(
//             `Clinical investigation of ${entityName} spans ${yearSpan} years, demonstrating sustained scientific interest and evolving research approaches over time.`
//         );
//     }
    
//     return insights;
// }

function generateInsights(data, entityName, sortedItems, entityType = 'drug') {
    const insights = [];
    const currentYear = new Date().getFullYear();
    
    // Determine field and terminology based on entity type
    const dataField = entityType === 'drug' ? 'byCondition' : 'byDrug';
    const itemType = entityType === 'drug' ? 'condition' : 'treatment';
    
    // Insight 1: First studied indication/treatment
    if (sortedItems.length > 0) {
        const firstItem = [...sortedItems].sort((a, b) => a.earliestYear - b.earliestYear)[0];
        if (entityType === 'drug') {
            insights.push(
                `${entityName} was first studied for <strong>${firstItem.name}</strong> in ${firstItem.earliestYear}, ${currentYear - firstItem.earliestYear} years ago.`
            );
        } else {
            insights.push(
                `${entityName} was first treated with <strong>${firstItem.name}</strong> in clinical trials starting in ${firstItem.earliestYear}, ${currentYear - firstItem.earliestYear} years ago.`
            );
        }
    }
    
    // Insight 2: Most studied indication/treatment
    const mostStudiedItem = sortedItems.length > 0 ? sortedItems[0] : null;
    if (mostStudiedItem) {
        if (entityType === 'drug') {
            insights.push(
                `The most researched application has been <strong>${mostStudiedItem.name}</strong> with ${mostStudiedItem.count} studies.`
            );
        } else {
            insights.push(
                `The most commonly investigated treatment has been <strong>${mostStudiedItem.name}</strong> with ${mostStudiedItem.count} studies.`
            );
        }
    }
    
    // Insight 3: Count unique conditions/treatments
    const uniqueItemCount = Object.keys(data[dataField]).length;
    if (entityType === 'drug') {
        insights.push(
            `${entityName} has been investigated for ${uniqueItemCount} distinct clinical conditions, showing its potential versatility across multiple medical applications.`
        );
    } else {
        insights.push(
            `${entityName} has been studied with ${uniqueItemCount} different treatments in clinical trials, reflecting the diverse therapeutic approaches being explored.`
        );
    }
    
    // Insight 4: Phase progression
    const phaseData = data.byPhase;
    const latePhaseCount = (phaseData.PHASE3 || []).length + (phaseData.PHASE4 || []).length;
    const totalPhaseCount = Object.values(phaseData).flat().length;
    
    if (totalPhaseCount > 0) {
        const latePhasePercentage = Math.round((latePhaseCount / totalPhaseCount) * 100);
        insights.push(
            `${latePhasePercentage}% of studies have reached late-stage (Phase 3-4) clinical trials, indicating ${latePhasePercentage > 30 ? 'significant' : 'ongoing'} progress toward regulatory approval.`
        );
    }
    
    // Insight 5: Recent activity and trend
    const recentYears = currentYear - 5;
    let recentActivityCount = 0;
    const recentItems = new Set();
    
    sortedItems.forEach(item => {
        Object.keys(item.years).forEach(year => {
            if (parseInt(year) >= recentYears) {
                recentActivityCount += item.years[year];
                recentItems.add(item.name);
            }
        });
    });
    
    if (recentItems.size > 0) {
        const topRecentItems = Array.from(recentItems).slice(0, 3);
        if (topRecentItems.length > 0) {
            if (entityType === 'drug') {
                insights.push(
                    `In the last 5 years, research has focused on ${recentItems.size} conditions, with notable interest in <strong>${topRecentItems.join('</strong>, <strong>')}</strong>.`
                );
            } else {
                insights.push(`In the last 5 years, clinical research has explored ${recentItems.size} treatments, with significant focus on <strong>${topRecentItems.join('</strong>, <strong>')}</strong>.`
                );
            }
        }
    }
    
    // Insight 6: Historical perspective
    const yearSpan = data.latestStudyYear - data.earliestStudyYear;
    if (yearSpan >= 10) {
        insights.push(
            `Clinical investigation of ${entityName} spans ${yearSpan} years, demonstrating sustained scientific interest and evolving research approaches over time.`
        );
    }
    
    // Condition-specific insight - Successful treatments
    if (entityType === 'condition') {
        // Count successful treatments
        const successfulTreatments = sortedItems.filter(item => item.isSuccessful);
        
        if (successfulTreatments.length > 0) {
            const treatmentNames = successfulTreatments.slice(0, 3).map(t => t.name);
            
            insights.push(
                `${successfulTreatments.length} treatments have shown successful results in late-stage clinical trials for ${entityName}, including <strong>${treatmentNames.join('</strong>, <strong>')}</strong>.`
            );
        } else {
            insights.push(
                `While multiple treatments have been studied, no treatments have yet demonstrated conclusive success in late-stage clinical trials for ${entityName}.`
            );
        }
    }
    
    // Drug-specific insight - Most advanced conditions
    if (entityType === 'drug') {
        // Find conditions with late-phase studies
        const latePhaseConditions = sortedItems.filter(item => {
            return item.studies && item.studies.some(study => 
                study.phase === 'PHASE3' || study.phase === 'PHASE4'
            );
        });
        
        if (latePhaseConditions.length > 0) {
            const conditionNames = latePhaseConditions.slice(0, 3).map(c => c.name);
            
            insights.push(
                `${entityName} has reached late-stage clinical development (Phase 3/4) for ${latePhaseConditions.length} conditions, notably <strong>${conditionNames.join('</strong>, <strong>')}</strong>.`
            );
        }
    }
    
    return insights;
}



/**
 * Extracts year from date string
 * @param {string} dateString - Date string in various formats
 * @returns {number|null} - Extracted year or null if not found
 */
function extractYearFromDate(dateString) {
    if (!dateString) return null;
    
    // Extract year from YYYY-MM-DD format
    const match = dateString.match(/^(\d{4})-/);
    if (match) {
        return parseInt(match[1]);
    }
    
    // Try to extract any 4-digit year
    const yearMatch = dateString.match(/\b(\d{4})\b/);
    if (yearMatch) {
        const year = parseInt(yearMatch[1]);
        // Validate year is reasonable (between 1950 and current year + 5)
        const currentYear = new Date().getFullYear();
        if (year >= 1950 && year <= currentYear + 5) {
            return year;
        }
    }
    
    return null;
}

/**
 * Displays studies with timeline visualization
 * @param {Array} studies - Array of study objects
 * @param {string} entityName - Name of drug or condition
 * @param {string} entityType - Either 'drug' or 'condition'
 */
// function displayStudiesWithTimeline(studies, entityName, entityType) {

//     // Create and append the timeline
//     const timelineElement = generateUsageTimeline(studies, entityName, entityType);
    
//     // Check if there's already a timeline
//     const existingTimeline = document.getElementById('entity-usage-timeline');
//     if (existingTimeline) {
//         existingTimeline.replaceWith(timelineElement);
//     } else {
//         // Insert the timeline before the studies list
//         const studiesContainer = elements.studiesList.parentElement;
//         timelineElement.id = 'entity-usage-timeline';
//         studiesContainer.insertBefore(timelineElement, elements.studiesList);
//     }
    
//     // Now continue with the original display logic
//     elements.studiesList.innerHTML = '';
//     elements.studyCount.textContent = studies.length;

//     if (studies.length === 0) {
//         elements.studiesList.innerHTML = `
//             <div class="text-center p-4 text-gray-500">
//                 <p>No studies found matching the current filters.</p>
//             </div>
//         `;
//         return;
//     }

//     // Sort studies by phase
//     const phaseOrder = { 
//         "PRE_PHASE": 0, 
//         "PHASE1": 1, 
//         "PHASE1_PHASE2": 1.5,
//         "PHASE2": 2, 
//         "PHASE3": 3, 
//         "PHASE4": 4 
//     };

//     studies.sort((a, b) => {
//         const phaseA = a.protocolSection?.designModule?.phases?.[0] || "PRE_PHASE";
//         const phaseB = b.protocolSection?.designModule?.phases?.[0] || "PRE_PHASE";
//         return (phaseOrder[phaseB] || 0) - (phaseOrder[phaseA] || 0);  // Reversed order - latest phases first
//     });

//     studies.forEach(study => {
//         const nctId = study.protocolSection?.identificationModule?.nctId;
//         const title = study.protocolSection?.identificationModule?.briefTitle;
//         const phase = study.protocolSection?.designModule?.phases?.[0] || "N/A";
//         const status = study.protocolSection?.statusModule?.overallStatus;
//         const sponsor = study.protocolSection?.identificationModule?.organization?.fullName;
//         const hasResults = study.hasResults;
        
//         // Determine if this is a TRD-specific study
//         const briefTitle = study.protocolSection?.identificationModule?.briefTitle?.toLowerCase() || '';
//         const officialTitle = study.protocolSection?.identificationModule?.officialTitle?.toLowerCase() || '';
//         const briefSummary = study.protocolSection?.descriptionModule?.briefSummary?.toLowerCase() || '';
        
//         const trdTerms = [
//             'treatment-resistant depression', 
//             'treatment resistant depression',
//             'trd',
//             'refractory depression'
//         ];
        
//         const isTRDSpecific = trdTerms.some(term => 
//             briefTitle.includes(term) || 
//             officialTitle.includes(term) || 
//             briefSummary.includes(term)
//         );
        
//         const card = document.createElement('div');
//         card.className = 'bg-white p-4 rounded-lg border border-gray-200 hover:shadow-md transition duration-200 mb-4';
//         card.innerHTML = `
//             <div class="flex flex-col md:flex-row gap-2 md:items-center md:justify-between mb-3">
//                 <div class="flex gap-2 items-center flex-wrap">
//                     <span class="inline-block w-3 h-3 rounded-full" style="background-color: ${getPhaseColor(phase)}"></span>
//                     <span class="text-sm font-medium">${formatPhase(phase)}</span>
//                     ${getStatusBadge(status)}
//                     ${isTRDSpecific ? '<span class="text-xs bg-purple-100 text-purple-800 px-2 py-0.5 rounded-full">TRD-Specific</span>' : ''}
//                 </div>
//                 <div>
//                     <span class="text-xs text-gray-500">${nctId}</span>
//                     ${hasResults ? '<span class="ml-2 text-xs bg-green-100 text-green-800 px-2 py-0.5 rounded-full">Has Results</span>' : ''}
//                 </div>
//             </div>
//             <h3 class="text-lg font-medium mb-2">${title}</h3>
//             <p class="text-sm text-gray-600 mb-3">Sponsor: ${sponsor || 'Unknown'}</p>
//             <div class="flex flex-wrap gap-2">
//                 <button data-nctid="${nctId}" class="view-study-btn text-blue-600 hover:text-blue-800 text-sm font-medium flex items-center">
//                     <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
//                         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
//                     </svg>
//                     View Details
//                 </button>
//                 <a href="https://clinicaltrials.gov/study/${nctId}" target="_blank" class="text-gray-600 hover:text-gray-800 text-sm font-medium flex items-center">
//                     <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
//                     </svg>
//                     ClinicalTrials.gov
//                 </a>
//             </div>
//         `;
//         elements.studiesList.appendChild(card);
        
//         // Add event listener to the view button
//         card.querySelector('.view-study-btn').addEventListener('click', () => {
//             viewStudyDetails(nctId);
//         });
//     });
// }

/**
 * Displays studies with timeline visualization
 * @param {Array} studies - Array of study objects
 * @param {string} entityName - Name of drug or condition
 * @param {string} entityType - Either 'drug' or 'condition'
 */
 function displayStudiesWithTimeline(studies, entityName, entityType) {
    // Validate inputs to prevent undefined errors
    if (!studies || !entityName) {
        console.error("Missing required parameters in displayStudiesWithTimeline");
        return;
    }

    // Log which entity we're displaying, helps with debugging
    console.log(`Displaying timeline for ${entityType}: ${entityName}`);

    // Create and append the timeline
    const timelineElement = generateUsageTimeline(studies, entityName, entityType);
    
    // Check if there's already a timeline
    const existingTimeline = document.getElementById('entity-usage-timeline');
    if (existingTimeline) {
        existingTimeline.replaceWith(timelineElement);
    } else {
        // Insert the timeline before the studies list
        const studiesContainer = elements.studiesList.parentElement;
        timelineElement.id = 'entity-usage-timeline';
        studiesContainer.insertBefore(timelineElement, elements.studiesList);
    }
    
    // Now continue with the original display logic
    elements.studiesList.innerHTML = '';
    elements.studyCount.textContent = studies.length;

    if (studies.length === 0) {
        elements.studiesList.innerHTML = `
            <div class="text-center p-4 text-gray-500">
                <p>No studies found matching the current filters.</p>
            </div>
        `;
        return;
    }

    // Sort studies by phase
    const phaseOrder = { 
        "PRE_PHASE": 0, 
        "PHASE1": 1, 
        "PHASE1_PHASE2": 1.5,
        "PHASE2": 2, 
        "PHASE3": 3, 
        "PHASE4": 4 
    };

    studies.sort((a, b) => {
        const phaseA = a.protocolSection?.designModule?.phases?.[0] || "PRE_PHASE";
        const phaseB = b.protocolSection?.designModule?.phases?.[0] || "PRE_PHASE";
        return (phaseOrder[phaseB] || 0) - (phaseOrder[phaseA] || 0);  // Reversed order - latest phases first
    });

    // If we're viewing a condition, identify successful treatments
    const successfulTreatments = new Set();
    console.log('ENTITY TYPE ', entityType, ' AND ', (entityType==='condition'))
    if (entityType === 'condition') {
        studies.forEach(study => {
            // Check if study has successful results
            const hasResults = study.hasResults;
            const status = study.protocolSection?.statusModule?.overallStatus;
            const isCompleted = status === 'Completed';
            
            // Check if this is a late-phase study (Phase 3 or 4)
            const phase = study.protocolSection?.designModule?.phases?.[0];
            const isLatePhase = phase === 'PHASE3' || phase === 'PHASE4';
            
            // Extract drug information from interventions
            const interventions = study.protocolSection?.armsInterventionsModule?.interventions || [];
            
            // If the study is completed with results and in late phase, consider drugs as successful
            if (hasResults && isCompleted && isLatePhase) {
                interventions.forEach(intervention => {
                    if (intervention.type?.toLowerCase() === 'drug' || 
                        intervention.type?.toLowerCase() === 'biological' ||
                        intervention.type?.toLowerCase() === 'combination product') {
                        
                        successfulTreatments.add(intervention.name);
                    }
                });
            }
        });
        
        console.log("Successful treatments identified:", Array.from(successfulTreatments));
    }

    studies.forEach(study => {
        const nctId = study.protocolSection?.identificationModule?.nctId;
        const title = study.protocolSection?.identificationModule?.briefTitle;
        const phase = study.protocolSection?.designModule?.phases?.[0] || "N/A";
        const status = study.protocolSection?.statusModule?.overallStatus;
        const sponsor = study.protocolSection?.identificationModule?.organization?.fullName;
        const hasResults = study.hasResults;
        
        // Determine if this is a TRD-specific study
        const briefTitle = study.protocolSection?.identificationModule?.briefTitle?.toLowerCase() || '';
        const officialTitle = study.protocolSection?.identificationModule?.officialTitle?.toLowerCase() || '';
        const briefSummary = study.protocolSection?.descriptionModule?.briefSummary?.toLowerCase() || '';
        
        const trdTerms = [
            'treatment-resistant depression', 
            'treatment resistant depression',
            'trd',
            'refractory depression'
        ];
        
        const isTRDSpecific = trdTerms.some(term => 
            briefTitle.includes(term) || 
            officialTitle.includes(term) || 
            briefSummary.includes(term)
        );
        
        // Check if this study has a successful treatment (for condition view)
        let hasSuccessfulTreatment = false;
        if (entityType === 'condition' && successfulTreatments.size > 0) {
            const interventions = study.protocolSection?.armsInterventionsModule?.interventions || [];
            hasSuccessfulTreatment = interventions.some(intervention => 
                successfulTreatments.has(intervention.name)
            );
        }
        
        const card = document.createElement('div');
        card.className = 'bg-white p-4 rounded-lg border border-gray-200 hover:shadow-md transition duration-200 mb-4';
        card.innerHTML = `
            <div class="flex flex-col md:flex-row gap-2 md:items-center md:justify-between mb-3">
                <div class="flex gap-2 items-center flex-wrap">
                    <span class="inline-block w-3 h-3 rounded-full" style="background-color: ${getPhaseColor(phase)}"></span>
                    <span class="text-sm font-medium">${formatPhase(phase)}</span>
                    ${getStatusBadge(status)}
                    ${isTRDSpecific ? '<span class="text-xs bg-purple-100 text-purple-800 px-2 py-0.5 rounded-full">TRD-Specific</span>' : ''}
                    ${hasSuccessfulTreatment ? '<span class="text-xs bg-green-100 text-green-800 px-2 py-0.5 rounded-full">Successful Treatment</span>' : ''}
                </div>
                <div>
                    <span class="text-xs text-gray-500">${nctId}</span>
                    ${hasResults ? '<span class="ml-2 text-xs bg-green-100 text-green-800 px-2 py-0.5 rounded-full">Has Results</span>' : ''}
                </div>
            </div>
            <h3 class="text-lg font-medium mb-2">${title}</h3>
            <p class="text-sm text-gray-600 mb-3">Sponsor: ${sponsor || 'Unknown'}</p>
            <div class="flex flex-wrap gap-2">
                <button data-nctid="${nctId}" class="view-study-btn text-blue-600 hover:text-blue-800 text-sm font-medium flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                    </svg>
                    View Details
                </button>
                <a href="https://clinicaltrials.gov/study/${nctId}" target="_blank" class="text-gray-600 hover:text-gray-800 text-sm font-medium flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                    </svg>
                    ClinicalTrials.gov
                </a>
            </div>
        `;
        elements.studiesList.appendChild(card);
        
        // Add event listener to the view button
        card.querySelector('.view-study-btn').addEventListener('click', () => {
            viewStudyDetails(nctId);
        });
    });
}

function markSuccessfulTreatments(usageData, studies) {
    if (!usageData || !usageData.byDrug || !studies || !studies.length) {
        return;
    }
    
    // Find successful treatment studies
    const successfulStudies = studies.filter(study => {
        const hasResults = study.hasResults;
        const status = study.protocolSection?.statusModule?.overallStatus;
        const isCompleted = status === 'Completed';
        
        // Check if this is a late-phase study (Phase 3 or 4)
        const phase = study.protocolSection?.designModule?.phases?.[0];
        const isLatePhase = phase === 'PHASE3' || phase === 'PHASE4';
        
        return hasResults && isCompleted && isLatePhase;
    });
    
    // Mark drugs from successful studies
    successfulStudies.forEach(study => {
        const interventions = study.protocolSection?.armsInterventionsModule?.interventions || [];
        
        interventions.forEach(intervention => {
            if (intervention.type?.toLowerCase() === 'drug' || 
                intervention.type?.toLowerCase() === 'biological' ||
                intervention.type?.toLowerCase() === 'combination product') {
                
                const drugName = intervention.name.charAt(0).toUpperCase() + intervention.name.slice(1);
                
                if (usageData.byDrug[drugName]) {
                    // Add a success flag to this drug
                    usageData.byDrug[drugName].isSuccessful = true;
                }
            }
        });
    });
}
/**
 * Generates a timeline visualization for either drug usage or condition treatments
 * @param {Array} studies - Array of study objects
 * @param {string} entityName - Name of the drug or condition
 * @param {string} entityType - Either 'drug' or 'condition'
 * @returns {HTMLElement} - The timeline container element
 */
//  function generateUsageTimeline(studies, entityName, entityType) {
//     // Create container for the timeline
//     const timelineContainer = document.createElement('div');
//     timelineContainer.className = 'mb-8 p-4 bg-white rounded-lg border border-gray-200 shadow-sm';
    
//     const titleText = entityType === 'drug' 
//         ? `Historical Usage Timeline: ${entityName}`
//         : `Treatment Timeline: ${entityName}`;
    
//     timelineContainer.innerHTML = `
//         <div class="flex flex-col md:flex-row md:items-center justify-between mb-4">
//             <h2 class="text-xl font-bold">${titleText}</h2>
            
//             <div class="flex items-center mt-2 md:mt-0">
//                 <div class="text-xs text-gray-500 mr-4">
//                     <span class="inline-block w-3 h-3 rounded-full bg-blue-500 mr-1"></span> Clinical trials
//                 </div>
//                 <select id="timeline-view-toggle" class="text-sm border border-gray-300 rounded p-1">
//                     <option value="chart" selected>Chart View</option>
//                     <option value="list">List View</option>
//                 </select>
//             </div>
//         </div>
//         <div id="usage-timeline" class="relative">
//             <div class="timeline-loading text-center p-4">
//                 <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-gray-200 border-t-blue-500"></div>
//                 <p class="mt-2 text-gray-600">Analyzing ${entityType === 'drug' ? 'usage patterns' : 'treatment approaches'}...</p>
//             </div>
//         </div>
//     `;

//     // Process the data after rendering the initial container
//     setTimeout(() => {
//         // Extract and organize timeline data
//         const usageData = entityType === 'drug' 
//             ? extractUsageData(studies, entityName) 
//             : extractConditionData(studies, entityName);
        
//         if ((!usageData.byCondition || Object.keys(usageData.byCondition).length === 0) && 
//             (!usageData.byDrug || Object.keys(usageData.byDrug).length === 0)) {
//             // No meaningful data found
//             document.getElementById('usage-timeline').innerHTML = `
//                 <div class="text-center p-4 text-gray-500">
//                     <p>Insufficient data to generate a timeline for ${entityName}.</p>
//                 </div>
//             `;
//             return;
//         }
        
//         // Render the timeline visualization
//         renderTimelineVisualization(usageData, entityName, entityType);
        
//         // Add event listener for the view toggle
//         const viewToggle = timelineContainer.querySelector('#timeline-view-toggle');
//         if (viewToggle) {
//             viewToggle.addEventListener('change', (e) => {
//                 const view = e.target.value;
//                 if (view === 'chart') {
//                     renderTimelineVisualization(usageData, entityName, entityType);
//                 } else if (view === 'list') {
//                     renderTimelineList(usageData, entityName, entityType);
//                 }
//             });
//         }
//     }, 100);
    
//     return timelineContainer;
// }

/**
 * Generates a timeline visualization for either drug usage or condition treatments
 * @param {Array} studies - Array of study objects
 * @param {string} entityName - Name of the drug or condition
 * @param {string} entityType - Either 'drug' or 'condition'
 * @returns {HTMLElement} - The timeline container element
 */
 function generateUsageTimeline(studies, entityName, entityType) {
    // Create container for the timeline
    const timelineContainer = document.createElement('div');
    timelineContainer.className = 'mb-8 p-4 bg-white rounded-lg border border-gray-200 shadow-sm';
    
    // Use the correct title based on entity type
    const titleText = entityType === 'drug' 
        ? `Historical Usage Timeline: ${entityName}`
        : `Treatment Timeline: ${entityName}`;
    
    timelineContainer.innerHTML = `
        <div class="flex flex-col md:flex-row md:items-center justify-between mb-4">
            <h2 class="text-xl font-bold">${titleText}</h2>
            
            <div class="flex items-center mt-2 md:mt-0">
                <div class="text-xs text-gray-500 mr-4">
                    <span class="inline-block w-3 h-3 rounded-full bg-blue-500 mr-1"></span> 
                    ${entityType === 'drug' ? 'Conditions studied' : 'Treatments used'}
                </div>
                <select id="timeline-view-toggle" class="text-sm border border-gray-300 rounded p-1">
                    <option value="chart" selected>Chart View</option>
                    <option value="list">List View</option>
                </select>
            </div>
        </div>
        <div id="usage-timeline" class="relative">
            <div class="timeline-loading text-center p-4">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-gray-200 border-t-blue-500"></div>
                <p class="mt-2 text-gray-600">Analyzing ${entityType === 'drug' ? 'usage patterns' : 'treatment approaches'}...</p>
            </div>
        </div>
    `;

    // Process the data after rendering the initial container
    setTimeout(async () => {
        // Extract and organize timeline data based on entity type
        const usageData = entityType === 'drug' 
            ? extractUsageData(studies, entityName) 
            : extractConditionData(studies, entityName);
               // If we're processing condition data, make sure to mark successful treatments

         if (entityType === 'condition') { 
            console.log(` USAGE USAGE USAGE usage data for ${entityType}`, usageData)

//             const trialResults = analyzeTrialResults(usageData);


// console.log("Successful drugs:", trialResults.successfulDrugs);
// console.log("Failed drugs:", trialResults.failedDrugs);
// console.log("Drugs still in trials:", trialResults.drugsInProgress);

 await initializeDrugDashboard(usageData, 'clinical-trials-dashboard');

            markSuccessfulTreatments(usageData, studies);
        }
        
        if ((!usageData.byCondition || Object.keys(usageData.byCondition).length === 0) && 
            (!usageData.byDrug || Object.keys(usageData.byDrug).length === 0)) {
            // No meaningful data found
            document.getElementById('usage-timeline').innerHTML = `
                <div class="text-center p-4 text-gray-500">
                    <p>Insufficient data to generate a timeline for ${entityName}.</p>
                </div>
            `;
            return;
        }
        
        // Render the timeline visualization
        renderTimelineVisualization(usageData, entityName, entityType);
        
        // Add event listener for the view toggle
        const viewToggle = timelineContainer.querySelector('#timeline-view-toggle');
        if (viewToggle) {
            viewToggle.addEventListener('change', (e) => {
                const view = e.target.value;
                if (view === 'chart') {
                    renderTimelineVisualization(usageData, entityName, entityType);
                } else if (view === 'list') {
                    renderTimelineList(usageData, entityName, entityType);
                }
            });
        }
        
        // Add export button
        addExportButton(timelineContainer, usageData, entityName, entityType);
        
        // Add compare button for advanced comparison
        addCompareButton(timelineContainer, entityName, entityType);
        
    }, 100);
    
    return timelineContainer;
}


/**
 * Wrapper function to maintain backward compatibility
 */
function generateDrugUsageTimeline(studies, drugName) {
    return generateUsageTimeline(studies, drugName, 'drug');
}

/**
 * Wrapper function for condition-based timeline
 */
function generateConditionTimeline(studies, conditionName) {
    return generateUsageTimeline(studies, conditionName, 'condition');
}
/**
 * Helper function to format phase for display
 * @param {string} phase - Raw phase value
 * @returns {string} - Formatted phase string
 */
function formatPhase(phase) {
    switch(phase) {
        case "PRE_PHASE":
            return "Pre-Clinical";
        case "PHASE1":
            return "Phase 1";
        case "PHASE1_PHASE2":
            return "Phase 1/2";
        case "PHASE2":
            return "Phase 2";
        case "PHASE3":
            return "Phase 3";
        case "PHASE4":
            return "Phase 4";
        default:
            return phase || "Unknown";
    }
}

/**
 * Helper function to get color for phase
 * @param {string} phase - Raw phase value
 * @returns {string} - Color hex code
 */
function getPhaseColor(phase) {
    switch(phase) {
        case "PRE_PHASE":
            return "#9CA3AF"; // gray-400
        case "PHASE1":
            return "#60A5FA"; // blue-400
        case "PHASE1_PHASE2":
            return "#34D399"; // green-400
        case "PHASE2":
            return "#10B981"; // green-500
        case "PHASE3":
            return "#047857"; // green-700
        case "PHASE4":
            return "#064E3B"; // green-900
        default:
            return "#D1D5DB"; // gray-300
    }
}

/**
 * Helper function to generate status badge HTML
 * @param {string} status - Study status
 * @returns {string} - Badge HTML
 */
function getStatusBadge(status) {
    if (!status) return '';
    
    const statusMap = {
        'Completed': { color: 'bg-green-100 text-green-800', priority: 3 },
        'Active': { color: 'bg-blue-100 text-blue-800', priority: 1 },
        'Recruiting': { color: 'bg-blue-100 text-blue-800', priority: 1 },
        'Not yet recruiting': { color: 'bg-yellow-100 text-yellow-800', priority: 2 },
        'Enrolling by invitation': { color: 'bg-blue-100 text-blue-800', priority: 1 },
        'Suspended': { color: 'bg-red-100 text-red-800', priority: 0 },
        'Terminated': { color: 'bg-red-100 text-red-800', priority: 0 },
        'Withdrawn': { color: 'bg-red-100 text-red-800', priority: 0 },
        'Unknown status': { color: 'bg-gray-100 text-gray-800', priority: 4 }
    };
    
    const statusInfo = statusMap[status] || { color: 'bg-gray-100 text-gray-800', priority: 4 };
    
    return `<span class="text-xs ${statusInfo.color} px-2 py-0.5 rounded-full">${status}</span>`;
}

/**
 * Search for a specific entity (drug or condition)
 * This is a placeholder function that should be implemented based on your application
 * @param {string} entityName - Name of the entity to search for
 * @param {string} entityType - Type of entity ('drug' or 'condition')
 */
function searchForEntity(entityName, entityType) {
    console.log(`Searching for ${entityType}: ${entityName}`);
    
    // This function should be implemented by the application
    // For example, it might:
    // 1. Set the search input field value
    // 2. Trigger the search
    // 3. Update the UI state
    
    // Example implementation:
    if (typeof elements !== 'undefined' && elements.searchInput) {
        elements.searchInput.value = entityName;
        
        // Trigger search
        if (typeof searchStudies === 'function') {
            // Set the entity type in your search parameters
            const searchParams = {
                term: entityName,
                type: entityType
            };
            
            searchStudies(searchParams);
        }
    } else {
        // Fallback if elements object is not available
        alert(`Search for ${entityType}: ${entityName}`);
    }
}

/**
 * Helper function to handle downloading timeline data
 * @param {Object} data - Timeline data
 * @param {string} entityName - Name of entity
 * @param {string} entityType - Type of entity ('drug' or 'condition')
 */
function downloadTimelineData(data, entityName, entityType) {
    // Prepare data for download
    const dataField = entityType === 'drug' ? 'byCondition' : 'byDrug';
    const itemType = entityType === 'drug' ? 'Condition' : 'Treatment';
    
    // Create CSV content
    let csvContent = `${itemType},Studies,First Year,Last Year,Peak Year\n`;
    
    Object.keys(data[dataField]).forEach(item => {
        const itemData = data[dataField][item];
        
        // Find peak year
        let peakYear = null;
        let peakCount = 0;
        
        Object.keys(itemData.years).forEach(year => {
            if (itemData.years[year] > peakCount) {
                peakCount = itemData.years[year];
                peakYear = year;
            }
        });
        
        // Add row to CSV
        csvContent += `"${item}",${itemData.count},${itemData.earliestYear},${itemData.latestYear},${peakYear || 'N/A'}\n`;
    });
    
    // Create download link
    const encodedUri = encodeURI('data:text/csv;charset=utf-8,' + csvContent);
    const link = document.createElement('a');
    link.setAttribute('href', encodedUri);
    link.setAttribute('download', `${entityName.replace(/\s+/g, '_')}_timeline_data.csv`);
    document.body.appendChild(link);
    
    // Trigger download
    link.click();
    
    // Clean up
    document.body.removeChild(link);
}

// Add an "Export Data" button to the timeline header
function addExportButton(timelineElement, data, entityName, entityType) {
    const headerDiv = timelineElement.querySelector('div.flex.flex-col.md\\:flex-row');
    
    if (headerDiv) {
        const exportButton = document.createElement('button');
        exportButton.className = 'mt-2 md:mt-0 ml-0 md:ml-2 px-3 py-1 bg-blue-50 text-blue-600 rounded hover:bg-blue-100 transition-colors text-sm flex items-center';
        exportButton.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
            </svg>
            Export Data
        `;
        
        exportButton.addEventListener('click', () => {
            downloadTimelineData(data, entityName, entityType);
        });
        
        headerDiv.appendChild(exportButton);
    }
}

// Add a "Compare" button for drug vs condition comparison
function addCompareButton(timelineElement, entityName, entityType) {
    const headerDiv = timelineElement.querySelector('div.flex.flex-col.md\\:flex-row');
    
    if (headerDiv) {
        const compareButton = document.createElement('button');
        compareButton.className = 'mt-2 md:mt-0 ml-0 md:ml-2 px-3 py-1 bg-purple-50 text-purple-600 rounded hover:bg-purple-100 transition-colors text-sm flex items-center';
        compareButton.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
            </svg>
            Compare
        `;
        compareButton.style.display = 'none'
        
        compareButton.addEventListener('click', () => {
            // Show a modal with comparison options
            showComparisonModal(entityName, entityType);
        });
        
        headerDiv.appendChild(compareButton);
    }
}

/**
 * Shows a modal for choosing comparison options
 * @param {string} entityName - Current entity name
 * @param {string} entityType - Current entity type
 */
function showComparisonModal(entityName, entityType) {
    // Create a modal
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
    
    // Opposite entity type
    const oppositeType = entityType === 'drug' ? 'condition' : 'drug';
    const oppositeTypeName = entityType === 'drug' ? 'Condition' : 'Drug';
    
    // Create modal content
    modal.innerHTML = `
        <div class="bg-white rounded-lg w-full max-w-md overflow-hidden flex flex-col">
            <div class="p-4 border-b">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-bold">Compare ${entityName}</h3>
                    <button id="close-compare-modal" class="text-gray-500 hover:text-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            </div>
            <div class="p-4">
                <p class="mb-4">Compare this ${entityType} with another ${entityType} or a specific ${oppositeType}:</p>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Compare with another ${entityType}:</label>
                    <div class="flex">
                        <input type="text" id="compare-entity" placeholder="Enter ${entityType} name..." 
                               class="flex-grow p-2 border border-gray-300 rounded-l shadow-sm text-sm">
                        <button id="compare-same-type" class="px-4 py-2 bg-blue-500 text-white rounded-r hover:bg-blue-600 transition-colors">
                            Compare
                        </button>
                    </div>
                </div>
                
                <div class="mb-4" >
                    <label class="block text-sm font-medium text-gray-700 mb-1">Compare with a ${oppositeType}:</label>
                    <div class="flex">
                        <input type="text" id="compare-opposite" placeholder="Enter ${oppositeTypeName} name..." 
                               class="flex-grow p-2 border border-gray-300 rounded-l shadow-sm text-sm">
                        <button id="compare-opposite-type" class="px-4 py-2 bg-purple-500 text-white rounded-r hover:bg-purple-600 transition-colors">
                            Compare
                        </button>
                    </div>
                </div>
                
                <div class="mt-6">
                    <p class="text-sm text-gray-500">
                        Comparing will show both timelines side-by-side to help identify patterns and relationships.
                    </p>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Add event listeners
    
    // 1. Close modal button
    document.getElementById('close-compare-modal').addEventListener('click', () => {
        document.body.removeChild(modal);
    });
    
    // 2. Close when clicking outside
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            document.body.removeChild(modal);
        }
    });
    
    // 3. Compare with same entity type
    document.getElementById('compare-same-type').addEventListener('click', () => {
        const compareEntity = document.getElementById('compare-entity').value.trim();
        if (compareEntity) {
            // Close modal
            document.body.removeChild(modal);
            
            // Initialize comparison
            if (typeof compareEntities === 'function') {
                compareEntities(entityName, compareEntity, entityType, entityType);
            } else {
                alert(`Compare ${entityName} (${entityType}) with ${compareEntity} (${entityType})`);
                console.log(`Compare ${entityName} (${entityType}) with ${compareEntity} (${entityType})`);
            }
        }
    });
    
    // 4. Compare with opposite entity type
    document.getElementById('compare-opposite-type').addEventListener('click', () => {
        const compareEntity = document.getElementById('compare-opposite').value.trim();
        if (compareEntity) {
            // Close modal
            document.body.removeChild(modal);
            
            // Initialize comparison
            if (typeof compareEntities === 'function') {
                compareEntities(entityName, compareEntity, entityType, oppositeType);
            } else {
                alert(`Compare ${entityName} (${entityType}) with ${compareEntity} (${oppositeType})`);
                console.log(`Compare ${entityName} (${entityType}) with ${compareEntity} (${oppositeType})`);
            }
        }
    });
}

/**
 * Compares two entities by showing their timelines side by side
 * This is a placeholder that should be implemented based on your application
 * @param {string} entity1 - First entity name
 * @param {string} entity2 - Second entity name
 * @param {string} type1 - First entity type
 * @param {string} type2 - Second entity type
 */
function compareEntities(entity1, entity2, type1, type2) {
    console.log(`Comparing ${entity1} (${type1}) with ${entity2} (${type2})`);
    
    // This function should be implemented based on your application logic
    // It would typically:
    // 1. Fetch data for both entities
    // 2. Create a comparison view
    // 3. Display the comparison
    
    alert(`Comparison feature would be implemented here for ${entity1} vs ${entity2}`);
}

// Add these functions to maintain backward compatibility with existing code
function groupSimilarConditions(conditionsData) {
    // This function is kept for backward compatibility
    return conditionsData;
}

/**
 * Main rendering function for display studies with timeline
 * @param {Array} studies - Array of study objects 
 * @param {string} entityName - Name of drug or condition
 * @param {string} entityType - Type of entity ('drug' or 'condition')
 */
function displayStudiesWithEntityTimeline(studies, entityName, entityType) {
    // Create a wrapper for both drug and condition views
    displayStudiesWithTimeline(studies, entityName, entityType);
}
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// // Add these to your state management
// const ITEMS_PER_PAGE = 20; // Adjust as needed

// // Modify your displayStudies function to handle pagination
// function displayStudies(studies, drug, condition) {
//     // Store all studies in an app state variable for pagination
//     appState.allStudies = studies;
//     appState.currentPage = 1;
    
//     elements.studyCount.textContent = studies.length;

//     if (studies.length === 0) {
//         elements.studiesList.innerHTML = `
//             <div class="text-center p-4 text-gray-500">
//                 <p>No studies found matching the current filters.</p>
//             </div>
//         `;
//         // Hide pagination controls when no results
//         if (elements.paginationControls) {
//             elements.paginationControls.classList.add('hidden');
//         }
//         return;
//     }

//     // Sort studies by phase (keep your existing sorting logic)
//     const phaseOrder = { 
//         "PRE_PHASE": 0, 
//         "PHASE1": 1, 
//         "PHASE1_PHASE2": 1.5,
//         "PHASE2": 2, 
//         "PHASE3": 3, 
//         "PHASE4": 4 
//     };

//     studies.sort((a, b) => {
//         const phaseA = a.protocolSection?.designModule?.phases?.[0] || "PRE_PHASE";
//         const phaseB = b.protocolSection?.designModule?.phases?.[0] || "PRE_PHASE";
//         return (phaseOrder[phaseA] || 0) - (phaseOrder[phaseB] || 0);
//     });

//     // Timeline visualization logic remains the same
//     const existingTimeline = document.getElementById('drug-usage-timeline');
//     if (existingTimeline) {
//         existingTimeline.remove();
//     }
    
//     // if (!drug){
//     //     displayStudiesWithTimeline(studies, condition, 'condition');
//     // }
//     // displayStudiesWithTimeline(studies, drug, 'drug');


//     // This should be:
//     if (condition && !drug) {
//         // If we have a condition but no drug, display the condition timeline
//         console.log("Displaying condition timeline for:", condition);
//         displayStudiesWithTimeline(studies, condition, 'condition');
//     } else if (drug && !condition) {
//         // If we have a drug  without condition display the drug timeline
//         console.log("Displaying drug timeline for:", drug);
//         displayStudiesWithTimeline(studies, drug, 'drug');
//     } else if (drug && (drug.toLowerCase() == condition.toLowerCase())){
//         console.log("Displaying drug timeline for:", drug);
//         displayStudiesWithTimeline(studies, drug, 'drug');
//     } else if (drug && condition){
//         const existingTimeline = document.getElementById('entity-usage-timeline');
//     if (existingTimeline) {
//         existingTimeline.innerHTML = ``;
//     } 
//     }

//     // Display the first page of studies
//     displayStudiesPage(1);
    
//     // Set up pagination controls
//     setupPaginationControls(studies.length);
// }

// // New function to display a specific page of studies
// function displayStudiesPage(page) {
//     const studies = appState.allStudies;
//     elements.studiesList.innerHTML = '';
    
//     // Calculate start and end index for current page
//     const startIndex = (page - 1) * ITEMS_PER_PAGE;
//     const endIndex = Math.min(startIndex + ITEMS_PER_PAGE, studies.length);
    
//     // Display only the current page of studies
//     for (let i = startIndex; i < endIndex; i++) {
//         const study = studies[i];
        
//         const nctId = study.protocolSection?.identificationModule?.nctId;
//         const title = study.protocolSection?.identificationModule?.briefTitle;
//         const phase = study.protocolSection?.designModule?.phases?.[0] || "N/A";
//         const status = study.protocolSection?.statusModule?.overallStatus;
//         const sponsor = study.protocolSection?.identificationModule?.organization?.fullName;
//         const hasResults = study.hasResults;
        
//         // Determine if this is a TRD-specific study
//         const briefTitle = study.protocolSection?.identificationModule?.briefTitle?.toLowerCase() || '';
//         const officialTitle = study.protocolSection?.identificationModule?.officialTitle?.toLowerCase() || '';
//         const briefSummary = study.protocolSection?.descriptionModule?.briefSummary?.toLowerCase() || '';
        
//         const trdTerms = [
//             'treatment-resistant depression', 
//             'treatment resistant depression',
//             'trd',
//             'refractory depression'
//         ];
        
//         const isTRDSpecific = trdTerms.some(term => 
//             briefTitle.includes(term) || 
//             officialTitle.includes(term) || 
//             briefSummary.includes(term)
//         );
        
//         const card = document.createElement('div');
//         card.className = 'bg-white p-4 rounded-lg border border-gray-200 hover:shadow-md transition duration-200';
//         card.innerHTML = `
//             <div class="flex flex-col md:flex-row gap-2 md:items-center md:justify-between mb-3">
//                 <div class="flex gap-2 items-center flex-wrap">
//                     <span class="inline-block w-3 h-3 rounded-full" style="background-color: ${getPhaseColor(phase)}"></span>
//                     <span class="text-sm font-medium">${formatPhase(phase)}</span>
//                     ${getStatusBadge(status)}
//                     ${isTRDSpecific ? '<span class="text-xs bg-purple-100 text-purple-800 px-2 py-0.5 rounded-full">TRD-Specific</span>' : ''}
//                 </div>
//                 <div>
//                     <span class="text-xs text-gray-500">${nctId}</span>
//                     ${hasResults ? '<span class="ml-2 text-xs bg-green-100 text-green-800 px-2 py-0.5 rounded-full">Has Results</span>' : ''}
//                 </div>
//             </div>
//             <h3 class="text-lg font-medium mb-2">${title}</h3>
//             <p class="text-sm text-gray-600 mb-3">Sponsor: ${sponsor || 'Unknown'}</p>
//             <button data-nctid="${nctId}" class="view-study-btn text-primary hover:text-blue-700 text-sm font-medium flex items-center">
//                 <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
//                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
//                 </svg>
//                 View Study Details
//             </button>
//         `;
//         elements.studiesList.appendChild(card);
        
//         // Add event listener to the view button
//         card.querySelector('.view-study-btn').addEventListener('click', () => {
//             viewStudyDetails(nctId);
//         });
//     }
    
//     // Update current page in app state
//     appState.currentPage = page;
    
//     // Update active pagination button
//     updateActivePaginationButton(page);
// }

// // Function to set up pagination controls
// function setupPaginationControls(totalItems) {
//     // First ensure we have a container for pagination controls
//     if (!elements.paginationControls) {
//         elements.paginationControls = document.createElement('div');
//         elements.paginationControls.className = 'flex justify-center items-center mt-6 space-x-2';
//         elements.studiesList.parentNode.appendChild(elements.paginationControls);
//     } else {
//         elements.paginationControls.innerHTML = '';
//         elements.paginationControls.classList.remove('hidden');
//     }
    
//     const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
    
//     // Don't show pagination for a single page
//     if (totalPages <= 1) {
//         elements.paginationControls.classList.add('hidden');
//         return;
//     }
    
//     // Previous button
//     const prevButton = document.createElement('button');
//     prevButton.className = 'px-3 py-1 rounded border border-gray-300 hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed';
//     prevButton.innerHTML = '&laquo; Prev';
//     prevButton.disabled = true; // Disabled initially on page 1
//     prevButton.addEventListener('click', () => {
//         if (appState.currentPage > 1) {
//             displayStudiesPage(appState.currentPage - 1);
//         }
//     });
//     elements.paginationControls.appendChild(prevButton);
    
//     // Page number buttons
//     // For simplicity, show max 7 page buttons with ellipsis for large number of pages
//     const maxVisibleButtons = 7;
//     const pages = [];
    
//     if (totalPages <= maxVisibleButtons) {
//         // Show all pages
//         for (let i = 1; i <= totalPages; i++) {
//             pages.push(i);
//         }
//     } else {
//         // Complex pagination with ellipsis
//         if (appState.currentPage <= 3) {
//             // Near start
//             for (let i = 1; i <= 5; i++) {
//                 pages.push(i);
//             }
//             pages.push('...');
//             pages.push(totalPages);
//         } else if (appState.currentPage >= totalPages - 2) {
//             // Near end
//             pages.push(1);
//             pages.push('...');
//             for (let i = totalPages - 4; i <= totalPages; i++) {
//                 pages.push(i);
//             }
//         } else {
//             // Middle
//             pages.push(1);
//             pages.push('...');
//             for (let i = appState.currentPage - 1; i <= appState.currentPage + 1; i++) {
//                 pages.push(i);
//             }
//             pages.push('...');
//             pages.push(totalPages);
//         }
//     }
    
//     // Add page buttons to DOM
//     pages.forEach(page => {
//         if (page === '...') {
//             const ellipsis = document.createElement('span');
//             ellipsis.className = 'px-3 py-1';
//             ellipsis.textContent = '...';
//             elements.paginationControls.appendChild(ellipsis);
//         } else {
//             const pageBtn = document.createElement('button');
//             pageBtn.className = 'px-3 py-1 rounded border border-gray-300 hover:bg-gray-100';
//             pageBtn.textContent = page;
//             if (page === 1) {
//                 pageBtn.classList.add('bg-blue-100', 'border-blue-300');
//             }
//             pageBtn.addEventListener('click', () => {
//                 displayStudiesPage(page);
//             });
//             elements.paginationControls.appendChild(pageBtn);
//         }
//     });
    
//     // Next button
//     const nextButton = document.createElement('button');
//     nextButton.className = 'px-3 py-1 rounded border border-gray-300 hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed';
//     nextButton.innerHTML = 'Next &raquo;';
//     nextButton.addEventListener('click', () => {
//         if (appState.currentPage < totalPages) {
//             displayStudiesPage(appState.currentPage + 1);
//         }
//     });
//     elements.paginationControls.appendChild(nextButton);
    
//     // Store references to prev/next buttons in app state for easier access
//     appState.prevButton = prevButton;
//     appState.nextButton = nextButton;
// }

// // Function to update active pagination button
// function updateActivePaginationButton(currentPage) {
//     if (!elements.paginationControls) return;
    
//     // Update prev/next button disabled states
//     const totalPages = Math.ceil(appState.allStudies.length / ITEMS_PER_PAGE);
//     appState.prevButton.disabled = currentPage === 1;
//     appState.nextButton.disabled = currentPage === totalPages;
    
//     // Update active page button
//     const pageButtons = elements.paginationControls.querySelectorAll('button:not(:first-child):not(:last-child)');
//     pageButtons.forEach(button => {
//         if (button.textContent === currentPage.toString()) {
//             button.classList.add('bg-blue-100', 'border-blue-300');
//         } else {
//             button.classList.remove('bg-blue-100', 'border-blue-300');
//         }
//     });
// }

// // Add search functionality to search within results
// function addStudySearch() {
//     // Create search input if it doesn't exist
//     if (!elements.studySearch) {
//         const searchContainer = document.createElement('div');
//         searchContainer.className = 'mb-4';
//         searchContainer.innerHTML = `
//             <label class="block text-sm font-medium text-gray-700 mb-1">Search within results</label>
//             <div class="relative">
//                 <input id="study-search" type="text" placeholder="Search by title, NCT ID, or sponsor..." 
//                        class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
//                 <button id="clear-search" class="absolute right-2 top-2 text-gray-400 hover:text-gray-600 hidden">
//                     <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
//                         <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
//                     </svg>
//                 </button>
//             </div>
//         `;
        
//         // Insert search before the studies list
//         elements.studiesList.parentNode.insertBefore(searchContainer, elements.studiesList);
        
//         // Store reference to the search input
//         elements.studySearch = document.getElementById('study-search');
//         elements.clearSearch = document.getElementById('clear-search');
        
//         // Add event listeners
//         elements.studySearch.addEventListener('input', debounce(handleStudySearch, 300));
//         elements.clearSearch.addEventListener('click', clearStudySearch);
//     }
// }

// // Debounce function to prevent too many search operations
// function debounce(func, wait) {
//     let timeout;
//     return function(...args) {
//         clearTimeout(timeout);
//         timeout = setTimeout(() => func.apply(this, args), wait);
//     };
// }

// // Handle study search
// function handleStudySearch() {
//     const searchTerm = elements.studySearch.value.toLowerCase().trim();
    
//     // Show/hide clear button
//     elements.clearSearch.classList.toggle('hidden', !searchTerm);
    
//     // If search term is empty, show all studies (paginated)
//     if (!searchTerm) {
//         appState.filteredStudies = null;
//         displayStudiesPage(1);
//         setupPaginationControls(appState.allStudies.length);
//         return;
//     }
    
//     // Filter studies based on search term
//     const filteredStudies = appState.allStudies.filter(study => {
//         const nctId = study.protocolSection?.identificationModule?.nctId?.toLowerCase() || '';
//         const title = study.protocolSection?.identificationModule?.briefTitle?.toLowerCase() || '';
//         const sponsor = study.protocolSection?.identificationModule?.organization?.fullName?.toLowerCase() || '';
        
//         return nctId.includes(searchTerm) || 
//                title.includes(searchTerm) || 
//                sponsor.includes(searchTerm);
//     });
    
//     // Store filtered studies in app state
//     appState.filteredStudies = filteredStudies;
    
//     // Update display with filtered studies
//     elements.studyCount.textContent = `${filteredStudies.length} (filtered from ${appState.allStudies.length})`;
    
//     // If no results after filtering
//     if (filteredStudies.length === 0) {
//         elements.studiesList.innerHTML = `
//             <div class="text-center p-4 text-gray-500">
//                 <p>No studies found matching "${searchTerm}".</p>
//                 <button id="reset-search" class="mt-2 text-blue-600 hover:underline">Reset search</button>
//             </div>
//         `;
//         elements.paginationControls.classList.add('hidden');
        
//         // Add event listener to reset button
//         document.getElementById('reset-search').addEventListener('click', clearStudySearch);
//         return;
//     }
    
//     // Display first page of filtered results
//     displayFilteredStudiesPage(1);
//     setupPaginationControls(filteredStudies.length);
// }

// // Clear study search
// function clearStudySearch() {
//     elements.studySearch.value = '';
//     elements.clearSearch.classList.add('hidden');
//     appState.filteredStudies = null;
    
//     // Reset to show all studies
//     elements.studyCount.textContent = appState.allStudies.length;
//     displayStudiesPage(1);
//     setupPaginationControls(appState.allStudies.length);
// }

// // Display page of filtered studies
// // Function to display a specific page of filtered studies
// function displayFilteredStudiesPage(page) {
//     const studies = appState.filteredStudies || appState.allStudies;
//     elements.studiesList.innerHTML = '';
    
//     // Calculate start and end index for current page
//     const startIndex = (page - 1) * ITEMS_PER_PAGE;
//     const endIndex = Math.min(startIndex + ITEMS_PER_PAGE, studies.length);
    
//     // Display the studies for this page
//     for (let i = startIndex; i < endIndex; i++) {
//         const study = studies[i];
        
//         const nctId = study.protocolSection?.identificationModule?.nctId;
//         const title = study.protocolSection?.identificationModule?.briefTitle;
//         const phase = study.protocolSection?.designModule?.phases?.[0] || "N/A";
//         const status = study.protocolSection?.statusModule?.overallStatus;
//         const sponsor = study.protocolSection?.identificationModule?.organization?.fullName;
//         const hasResults = study.hasResults;
        
//         // Determine if this is a TRD-specific study
//         const briefTitle = study.protocolSection?.identificationModule?.briefTitle?.toLowerCase() || '';
//         const officialTitle = study.protocolSection?.identificationModule?.officialTitle?.toLowerCase() || '';
//         const briefSummary = study.protocolSection?.descriptionModule?.briefSummary?.toLowerCase() || '';
        
//         const trdTerms = [
//             'treatment-resistant depression', 
//             'treatment resistant depression',
//             'trd',
//             'refractory depression'
//         ];
        
//         const isTRDSpecific = trdTerms.some(term => 
//             briefTitle.includes(term) || 
//             officialTitle.includes(term) || 
//             briefSummary.includes(term)
//         );
        
//         const card = document.createElement('div');
//         card.className = 'bg-white p-4 rounded-lg border border-gray-200 hover:shadow-md transition duration-200';
//         card.innerHTML = `
//             <div class="flex flex-col md:flex-row gap-2 md:items-center md:justify-between mb-3">
//                 <div class="flex gap-2 items-center flex-wrap">
//                     <span class="inline-block w-3 h-3 rounded-full" style="background-color: ${getPhaseColor(phase)}"></span>
//                     <span class="text-sm font-medium">${formatPhase(phase)}</span>
//                     ${getStatusBadge(status)}
//                     ${isTRDSpecific ? '<span class="text-xs bg-purple-100 text-purple-800 px-2 py-0.5 rounded-full">TRD-Specific</span>' : ''}
//                 </div>
//                 <div>
//                     <span class="text-xs text-gray-500">${nctId}</span>
//                     ${hasResults ? '<span class="ml-2 text-xs bg-green-100 text-green-800 px-2 py-0.5 rounded-full">Has Results</span>' : ''}
//                 </div>
//             </div>
//             <h3 class="text-lg font-medium mb-2">${title}</h3>
//             <p class="text-sm text-gray-600 mb-3">Sponsor: ${sponsor || 'Unknown'}</p>
//             <button data-nctid="${nctId}" class="view-study-btn text-primary hover:text-blue-700 text-sm font-medium flex items-center">
//                 <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
//                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
//                 </svg>
//                 View Study Details
//             </button>
//         `;
//         elements.studiesList.appendChild(card);
        
//         // Add event listener to the view button
//         card.querySelector('.view-study-btn').addEventListener('click', () => {
//             viewStudyDetails(nctId);
//         });
//     }
    
//     // Update current page in app state
//     appState.currentPage = page;
    
//     // Update active pagination button
//     updateActivePaginationButton(page);
    
//     // Update the results info message
//     const resultsInfo = document.createElement('div');
//     resultsInfo.className = 'text-sm text-gray-600 mt-2';
    
//     if (studies.length > 0) {
//         resultsInfo.textContent = `Showing ${startIndex + 1}-${endIndex} of ${studies.length} results`;
//     } else {
//         resultsInfo.textContent = 'No results found';
//     }
    
//     // Replace any existing results info
//     const existingInfo = document.querySelector('.results-info');
//     if (existingInfo) {
//         existingInfo.replaceWith(resultsInfo);
//     } else {
//         // Insert before the studies list
//         elements.studiesList.parentNode.insertBefore(resultsInfo, elements.studiesList);
//     }
//     resultsInfo.classList.add('results-info');
    
//     // Check if there's any data to show page controls
//     if (studies.length <= ITEMS_PER_PAGE) {
//         // If we have 1 page or less, hide pagination controls
//         if (elements.paginationControls) {
//             elements.paginationControls.classList.add('hidden');
//         }
//     } else {
//         // Make sure pagination controls are visible
//         if (elements.paginationControls) {
//             elements.paginationControls.classList.remove('hidden');
//         }
//     }
// }

// // Initialize new features when page loads
// function initPaginationAndSearch() {
//     // Add these to your init function or document ready callback
//     addStudySearch();
    
//     // Make sure appState has required properties
//     if (!appState) {
//         appState = {};
//     }
    
//     appState.allStudies = [];
//     appState.currentPage = 1;
//     appState.filteredStudies = null;
// }
// Add these to your state management
const ITEMS_PER_PAGE = 20; // Adjust as needed

// Extend the app state to include filter options
if (!appState) {
    appState = {};
}

appState.filters = {
    hasResults: false,
    isCompleted: false,
    phaseFilters: {
        PHASE1: true,
        PHASE1_PHASE2: true,
        PHASE2: true,
        PHASE3: true, 
        PHASE4: true,
        PRE_PHASE: true
    }
};

// Modify your displayStudies function to handle pagination
function displayStudies(studies, drug, condition) {
    // Store all studies in an app state variable for pagination
    appState.allStudies = studies;
    appState.currentPage = 1;
    
    elements.studyCount.textContent = studies.length;

    if (studies.length === 0) {
        elements.studiesList.innerHTML = `
            <div class="text-center p-4 text-gray-500">
                <p>No studies found matching the current filters.</p>
            </div>
        `;
        // Hide pagination controls when no results
        if (elements.paginationControls) {
            elements.paginationControls.classList.add('hidden');
        }
        return;
    }

    // Sort studies by phase (keep your existing sorting logic)
    const phaseOrder = { 
        "PRE_PHASE": 0, 
        "PHASE1": 1, 
        "PHASE1_PHASE2": 1.5,
        "PHASE2": 2, 
        "PHASE3": 3, 
        "PHASE4": 4 
    };

    studies.sort((a, b) => {
        const phaseA = a.protocolSection?.designModule?.phases?.[0] || "PRE_PHASE";
        const phaseB = b.protocolSection?.designModule?.phases?.[0] || "PRE_PHASE";
        return (phaseOrder[phaseA] || 0) - (phaseOrder[phaseB] || 0);
    });

    // Timeline visualization logic remains the same
    const existingTimeline = document.getElementById('drug-usage-timeline');
    if (existingTimeline) {
        existingTimeline.remove();
    }
    
    if (condition && !drug) {
        // If we have a condition but no drug, display the condition timeline
        console.log("Displaying condition timeline for:", condition);
        displayStudiesWithTimeline(studies, condition, 'condition');
    } else if (drug && !condition) {
        // If we have a drug without condition display the drug timeline
        console.log("Displaying drug timeline for:", drug);
        displayStudiesWithTimeline(studies, drug, 'drug');
    } else if (drug && (drug.toLowerCase() == condition.toLowerCase())){
        console.log("Displaying drug timeline for:", drug);
        displayStudiesWithTimeline(studies, drug, 'drug');
    } else if (drug && condition){
        const existingTimeline = document.getElementById('entity-usage-timeline');
        if (existingTimeline) {
            existingTimeline.innerHTML = ``;
        } 
    }

    // Add enhanced filtering UI
    addEnhancedFilters();
    
    // Apply filters before pagination and display
    applyFilters();
}

// Add enhanced, modern filtering UI with animations
function addEnhancedFilters() {
    // Create filter section if it doesn't exist
    if (!elements.filterSection) {
        // Add necessary CSS for animations
        if (!document.getElementById('filter-styles')) {
            const styleEl = document.createElement('style');
            styleEl.id = 'filter-styles';
            styleEl.textContent = `
                /* Toggle switch styles */
                .toggle-switch {
                    position: relative;
                    display: inline-block;
                    width: 48px;
                    height: 24px;
                }
                .toggle-switch input {
                    opacity: 0;
                    width: 0;
                    height: 0;
                }
                .toggle-slider {
                    position: absolute;
                    cursor: pointer;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background-color: #e2e8f0;
                    transition: .4s;
                    border-radius: 24px;
                }
                .toggle-slider:before {
                    position: absolute;
                    content: "";
                    height: 18px;
                    width: 18px;
                    left: 3px;
                    bottom: 3px;
                    background-color: white;
                    transition: .3s;
                    border-radius: 50%;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                }
                input:checked + .toggle-slider {
                    background-color: #3b82f6;
                }
                input:checked + .toggle-slider.green {
                    background-color: #10b981;
                }
                input:checked + .toggle-slider.purple {
                    background-color: #8b5cf6;
                }
                input:checked + .toggle-slider:before {
                    transform: translateX(24px);
                }
                
                /* Phase filter buttons */
                .phase-btn {
                    transition: all 0.2s ease;
                    transform-origin: center;
                    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
                    cursor: pointer;
                }
                .phase-btn:hover {
                    transform: translateY(-2px);
                    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                }
                .phase-btn.active {
                    transform: scale(1.05);
                }
                
                /* Filter section animations */
                .filter-section {
                    transition: all 0.3s ease;
                }
                .filter-section:hover {
                    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
                }
                
                /* Action buttons hover effects */
                .action-btn {
                    transition: all 0.2s ease;
                    position: relative;
                    overflow: hidden;
                }
                .action-btn:hover {
                    transform: translateY(-2px);
                }
                .action-btn::after {
                    content: '';
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    width: 5px;
                    height: 5px;
                    background: rgba(255, 255, 255, 0.5);
                    opacity: 0;
                    border-radius: 100%;
                    transform: scale(1, 1) translate(-50%);
                    transform-origin: 50% 50%;
                }
                .action-btn:focus:not(:active)::after {
                    animation: ripple 0.6s ease-out;
                }
                @keyframes ripple {
                    0% {
                        transform: scale(0, 0);
                        opacity: 0.5;
                    }
                    100% {
                        transform: scale(30, 30);
                        opacity: 0;
                    }
                }
                
                @keyframes fadeIn {
                    from {
                        opacity: 0;
                        transform: translateY(10px);
                    }
                    to {
                        opacity: 1;
                        transform: translateY(0);
                    }
                }
                   /* Phase button active/inactive states */
    .phase-btn {
      transition: all 0.2s ease;
      transform-origin: center;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }
    
    .phase-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    /* Very distinct active state */
    .phase-btn.active {
      transform: scale(1.05);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
      border-width: 2px;
    }
    
    /* Inactive state - visually muted */
    .phase-btn:not(.active) {
      opacity: 0.6;
      background-color: #f9fafb !important;
      border-color: #e5e7eb !important;
    }
    
    /* Checkmark badge for active phases */
    .phase-btn .active-indicator {
      position: absolute;
      top: 4px;
      right: 4px;
      background-color: #10b981;
      color: white;
      border-radius: 50%;
      width: 16px;
      height: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      opacity: 0;
      transform: scale(0);
      transition: all 0.2s ease;
    }
    
    .phase-btn.active .active-indicator {
      opacity: 1;
      transform: scale(1);
    }
    
    /* Make the phase dot larger and more prominent */
    .phase-btn .phase-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
      transition: all 0.2s ease;
    }
    
    .phase-btn.active .phase-dot {
      transform: scale(1.5);
    }
      
            `;
            document.head.appendChild(styleEl);
        }
        
        // Create filter container with modern UI
        const filterContainer = document.createElement('div');
        filterContainer.className = 'filter-section mb-6 bg-white p-5 rounded-lg border border-gray-200 transition-all duration-300';
        filterContainer.innerHTML = `
            <div class="mb-5">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">Filter Options</h3>
                    <button id="toggle-filters" class="text-sm text-blue-600 hover:text-blue-800 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                        Hide Filters
                    </button>
                </div>
                
                <div id="filter-options" class="space-y-6">
                    <div class="flex flex-wrap items-center gap-6 p-3 bg-gray-50 rounded-lg">
                        <div class="flex items-center">
                            <div class="mr-3 text-blue-600">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-700 block mb-1">Study Has Results</label>
                                <label class="toggle-switch">
                                    <input id="has-results-checkbox" type="checkbox">
                                    <span class="toggle-slider green"></span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="flex items-center">
                            <div class="mr-3 text-indigo-600">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                </svg>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-700 block mb-1">Completed Studies Only</label>
                                <label class="toggle-switch">
                                    <input id="completed-checkbox" type="checkbox">
                                    <span class="toggle-slider purple"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <h4 class="text-sm font-semibold mb-3 text-gray-700 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                            </svg>
                            Study Phase
                        </h4>
                        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-6 gap-2">
                            <div id="phase-pre_phase" class="phase-btn active px-3 py-2 rounded-lg bg-blue-50 border border-blue-100 hover:bg-blue-100 text-center">
                                <span class="text-xs font-medium block mb-1 text-blue-800">Pre-Clinical</span>
                                <span class="inline-block w-2 h-2 rounded-full bg-blue-500"></span>
                            </div>
                            <div id="phase-phase1" class="phase-btn active px-3 py-2 rounded-lg bg-green-50 border border-green-100 hover:bg-green-100 text-center">
                                <span class="text-xs font-medium block mb-1 text-green-800">Phase 1</span>
                                <span class="inline-block w-2 h-2 rounded-full bg-green-500"></span>
                            </div>
                            <div id="phase-phase1_phase2" class="phase-btn active px-3 py-2 rounded-lg bg-teal-50 border border-teal-100 hover:bg-teal-100 text-center">
                                <span class="text-xs font-medium block mb-1 text-teal-800">Phase 1/2</span>
                                <span class="inline-block w-2 h-2 rounded-full bg-teal-500"></span>
                            </div>
                            <div id="phase-phase2" class="phase-btn active px-3 py-2 rounded-lg bg-cyan-50 border border-cyan-100 hover:bg-cyan-100 text-center">
                                <span class="text-xs font-medium block mb-1 text-cyan-800">Phase 2</span>
                                <span class="inline-block w-2 h-2 rounded-full bg-cyan-500"></span>
                            </div>
                            <div id="phase-phase3" class="phase-btn active px-3 py-2 rounded-lg bg-purple-50 border border-purple-100 hover:bg-purple-100 text-center">
                                <span class="text-xs font-medium block mb-1 text-purple-800">Phase 3</span>
                                <span class="inline-block w-2 h-2 rounded-full bg-purple-500"></span>
                            </div>
                            <div id="phase-phase4" class="phase-btn active px-3 py-2 rounded-lg bg-indigo-50 border border-indigo-100 hover:bg-indigo-100 text-center">
                                <span class="text-xs font-medium block mb-1 text-indigo-800">Phase 4</span>
                                <span class="inline-block w-2 h-2 rounded-full bg-indigo-500"></span>
                            </div>
                        </div>
                        <div id="phase-warning" class="mt-2 text-red-600 text-xs hidden">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                            </svg>
                            At least one phase must be selected
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-end gap-3">
                <button id="apply-filters" class="action-btn text-sm bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 shadow-sm flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
                    </svg>
                    Apply Filters
                </button>
                <button id="reset-all-filters" class="action-btn text-sm bg-gray-100 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 shadow-sm flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                    Reset
                </button>
            </div>
        `;
        
        // Insert the filter section before the studies list or search
        const targetElement = elements.studySearch 
            ? elements.studySearch.closest('div').parentNode
            : elements.studiesList.parentNode;
        
        targetElement.insertBefore(filterContainer, targetElement.firstChild);
        
        // Store references to UI elements
        elements.filterSection = filterContainer;
        elements.hasResultsCheckbox = document.getElementById('has-results-checkbox');
        elements.completedCheckbox = document.getElementById('completed-checkbox');
        elements.applyFiltersBtn = document.getElementById('apply-filters');
        elements.resetFiltersBtn = document.getElementById('reset-all-filters');
        elements.phaseWarning = document.getElementById('phase-warning');
        elements.toggleFiltersBtn = document.getElementById('toggle-filters');
        elements.filterOptions = document.getElementById('filter-options');
        
        // Store references to phase buttons
        elements.phaseButtons = {};
        const phaseIds = ['PRE_PHASE', 'PHASE1', 'PHASE1_PHASE2', 'PHASE2', 'PHASE3', 'PHASE4'];
        phaseIds.forEach(phase => {
            elements.phaseButtons[phase] = document.getElementById(`phase-${phase.toLowerCase()}`);
            if (!elements.phaseButtons[phase]) {
                console.error(`Could not find phase button for ${phase}`);
            }
        });
        
        // Add event listeners to filter controls
        elements.hasResultsCheckbox.addEventListener('change', function() {
            appState.filters.hasResults = this.checked;
        });
        
        elements.completedCheckbox.addEventListener('change', function() {
            appState.filters.isCompleted = this.checked;
        });
        
        // Add event listeners to phase filter buttons with toggle functionality
        phaseIds.forEach(phase => {
            const button = elements.phaseButtons[phase];
            if (button) {
                // Initialize active state
                button.classList.add('active');
                appState.filters.phaseFilters[phase] = true;
                
                button.addEventListener('click', function() {
                    // Toggle active visual state
                    this.classList.toggle('active');
                    
                    // Update filter state
                    appState.filters.phaseFilters[phase] = this.classList.contains('active');
                    
                    // Check if at least one phase is selected
                    const anyPhaseSelected = Object.values(appState.filters.phaseFilters).some(value => value);
                    
                    // Show warning if no phases selected
                    if (!anyPhaseSelected) {
                        elements.phaseWarning.classList.remove('hidden');
                        elements.applyFiltersBtn.disabled = true;
                    } else {
                        elements.phaseWarning.classList.add('hidden');
                        elements.applyFiltersBtn.disabled = false;
                    }
                });
            }
        });
        
        // Toggle filters visibility
        elements.toggleFiltersBtn.addEventListener('click', function() {
            const isVisible = elements.filterOptions.style.display !== 'none';
            
            if (isVisible) {
                elements.filterOptions.style.display = 'none';
                this.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                    Show Filters
                `;
            } else {
                elements.filterOptions.style.display = 'block';
                this.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
                    </svg>
                    Hide Filters
                `;
            }
        });
        
        // Add event listeners to apply/reset buttons
        elements.applyFiltersBtn.addEventListener('click', applyFilters);
        elements.resetFiltersBtn.addEventListener('click', resetAllFilters);
    }
}

// Function to apply all filters and update the display with validation
function applyFilters() {
    // Validate: ensure at least one phase is selected
    const anyPhaseSelected = Object.values(appState.filters.phaseFilters).some(value => value);
    
    if (!anyPhaseSelected) {
        // Show error message
        elements.phaseWarning.classList.remove('hidden');
        
        // Visual feedback on the phase section
        const phaseSection = elements.phaseWarning.parentNode;
        phaseSection.classList.add('border-red-300');
        phaseSection.classList.add('bg-red-50');
        
        setTimeout(() => {
            phaseSection.classList.remove('border-red-300');
            phaseSection.classList.remove('bg-red-50');
        }, 1000);
        
        return; // Don't proceed with filtering
    }
    
    // Hide error message if it was shown
    elements.phaseWarning.classList.add('hidden');
    
    // Visual feedback for filter application
    elements.applyFiltersBtn.innerHTML = `
        <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Applying Filters...
    `;
    
    setTimeout(() => {
        // Start with all studies
        let filteredStudies = [...appState.allStudies];
        
        // Apply search term filter if it exists
        const searchTerm = elements.studySearch ? elements.studySearch.value.toLowerCase().trim() : '';
        if (searchTerm) {
            filteredStudies = filteredStudies.filter(study => {
                const nctId = study.protocolSection?.identificationModule?.nctId?.toLowerCase() || '';
                const title = study.protocolSection?.identificationModule?.briefTitle?.toLowerCase() || '';
                const sponsor = study.protocolSection?.identificationModule?.organization?.fullName?.toLowerCase() || '';
                
                return nctId.includes(searchTerm) || 
                       title.includes(searchTerm) || 
                       sponsor.includes(searchTerm);
            });
        }
        
        // Apply "has results" filter
        if (appState.filters.hasResults) {
            filteredStudies = filteredStudies.filter(study => study.hasResults === true);
        }
        
        // Apply "completed studies" filter
        if (appState.filters.isCompleted) {
            filteredStudies = filteredStudies.filter(study => 
                study.protocolSection?.statusModule?.overallStatus === "COMPLETED"
            );
        }
        
        // Apply phase filters
        filteredStudies = filteredStudies.filter(study => {
            const phase = study.protocolSection?.designModule?.phases?.[0] || "PRE_PHASE";
            return appState.filters.phaseFilters[phase] === true;
        });
        
        // Store filtered studies in app state
        appState.filteredStudies = filteredStudies;
        
        // Update the study count display with animation
        const oldCount = elements.studyCount.textContent;
        elements.studyCount.classList.add('transition-all', 'duration-500');
        
        if (filteredStudies.length === appState.allStudies.length) {
            elements.studyCount.textContent = filteredStudies.length;
        } else {
            elements.studyCount.textContent = `${filteredStudies.length} (filtered from ${appState.allStudies.length})`;
        }
        
        // If count changed, add animation
        if (oldCount !== elements.studyCount.textContent) {
            elements.studyCount.classList.add('text-blue-600', 'font-bold');
            setTimeout(() => {
                elements.studyCount.classList.remove('text-blue-600', 'font-bold');
            }, 1000);
        }
        
        // Display the first page of filtered studies
        displayFilteredStudiesPage(1);
        
        // Update pagination controls for filtered results
        setupPaginationControls(filteredStudies.length);
        
        // Show "no results" message if needed
        if (filteredStudies.length === 0) {
            elements.studiesList.innerHTML = `
                <div class="text-center p-6 bg-gray-50 rounded-lg border border-gray-200 mt-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <p class="text-gray-600 mb-4">No studies found matching the current filters.</p>
                    <button id="reset-filters" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors shadow-sm">
                        Reset all filters
                    </button>
                </div>
            `;
            
            // Add event listener to reset button
            document.getElementById('reset-filters').addEventListener('click', resetAllFilters);
            
            // Hide pagination when no results
            if (elements.paginationControls) {
                elements.paginationControls.classList.add('hidden');
            }
        }
        
        // Reset apply button text
        elements.applyFiltersBtn.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
            </svg>
            Apply Filters
        `;
        
        // Success feedback
        elements.filterSection.classList.add('bg-green-50');
        setTimeout(() => {
            elements.filterSection.classList.remove('bg-green-50');
        }, 500);
    }, 400); // Small delay for visual feedback
}

// Function to reset all filters
function resetAllFilters() {
    // Reset search
    if (elements.studySearch) {
        elements.studySearch.value = '';
        if (elements.clearSearch) {
            elements.clearSearch.classList.add('hidden');
        }
    }
    
    // Reset filter checkboxes with visual feedback
    if (elements.hasResultsCheckbox) {
        elements.hasResultsCheckbox.checked = false;
    }
    if (elements.completedCheckbox) {
        elements.completedCheckbox.checked = false;
    }
    
    // Reset phase filter buttons and state
    Object.keys(appState.filters.phaseFilters).forEach(phase => {
        const button = elements.phaseButtons[phase];
        if (button) {
            button.classList.add('active');
            // Add a brief highlight animation
            button.classList.add('bg-yellow-50');
            setTimeout(() => {
                button.classList.remove('bg-yellow-50');
            }, 300);
        }
        appState.filters.phaseFilters[phase] = true;
    });
    
    // Hide phase warning if visible
    if (elements.phaseWarning) {
        elements.phaseWarning.classList.add('hidden');
    }
    
    // Enable apply button
    if (elements.applyFiltersBtn) {
        elements.applyFiltersBtn.disabled = false 
      }
    
    // Reset app state filters
    appState.filters.hasResults = false;
    appState.filters.isCompleted = false;
    appState.filteredStudies = null;
    
    // Visual feedback for reset
    elements.filterSection.classList.add('bg-blue-50');
    setTimeout(() => {
        elements.filterSection.classList.remove('bg-blue-50');
    }, 300);
    
    // Reset to show all studies
    elements.studyCount.textContent = appState.allStudies.length;
    displayStudiesPage(1);
    setupPaginationControls(appState.allStudies.length);
}

// Function to set up modern pagination controls
function setupPaginationControls(totalItems) {
    // First add necessary CSS for pagination animations
    if (!document.getElementById('pagination-styles')) {
        const paginationStyles = document.createElement('style');
        paginationStyles.id = 'pagination-styles';
        paginationStyles.textContent = `
            .pagination-controls {
                display: flex;
                justify-content: center;
                align-items: center;
                margin-top: 1.5rem;
                gap: 0.25rem;
            }
            
            .page-btn {
                min-width: 2.5rem;
                height: 2.5rem;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 0.5rem;
                border: 1px solid #e5e7eb;
                background-color: white;
                font-size: 0.875rem;
                font-weight: 500;
                color: #4b5563;
                transition: all 0.2s ease;
                position: relative;
                overflow: hidden;
            }
            
            .page-btn:not(:disabled):hover {
                border-color: #93c5fd;
                color: #2563eb;
                transform: translateY(-1px);
                box-shadow: 0 2px 4px rgba(0,0,0,0.05);
                z-index: 1;
            }
            
            .page-btn:not(:disabled):active {
                transform: translateY(0);
                box-shadow: none;
            }
            
            .page-btn.active {
                background-color: #3b82f6;
                border-color: #2563eb;
                color: white;
                font-weight: 600;
                transform: scale(1.05);
                box-shadow: 0 4px 6px rgba(37, 99, 235, 0.1);
                z-index: 2;
            }
            
            .page-btn:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }
            
            .page-info {
                display: flex;
                align-items: center;
                justify-content: center;
                height: 2.5rem;
                margin: 0 0.5rem;
                font-size: 0.875rem;
                color: #6b7280;
                background-color: #f9fafb;
                border-radius: 0.5rem;
                padding: 0 1rem;
                border: 1px solid #e5e7eb;
            }
            
            .page-ellipsis {
                display: flex;
                align-items: center;
                justify-content: center;
                height: 2.5rem;
                width: 2.5rem;
                color: #6b7280;
            }
            
            @keyframes pulse {
                0%, 100% { opacity: 1; }
                50% { opacity: 0.5; }
            }
            
            .page-btn.active::after {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: rgba(255, 255, 255, 0.1);
                opacity: 0;
                animation: pulse 2s ease-in-out infinite;
            }
        `;
        document.head.appendChild(paginationStyles);
    }

    // Ensure we have a container for pagination controls
    if (!elements.paginationControls) {
        elements.paginationControls = document.createElement('div');
        elements.paginationControls.className = 'pagination-controls';
        elements.studiesList.parentNode.appendChild(elements.paginationControls);
    } else {
        elements.paginationControls.innerHTML = '';
        elements.paginationControls.classList.remove('hidden');
        elements.paginationControls.className = 'pagination-controls';
    }
    
    const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
    
    // Don't show pagination for a single page
    if (totalPages <= 1) {
        elements.paginationControls.classList.add('hidden');
        return;
    }
    
    // Previous button
    const prevButton = document.createElement('button');
    prevButton.className = 'page-btn';
    prevButton.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
    `;
    prevButton.title = "Previous Page";
    prevButton.disabled = true; // Disabled initially on page 1
    prevButton.addEventListener('click', () => {
        if (appState.currentPage > 1) {
            displayFilteredStudiesPage(appState.currentPage - 1);
        }
    });
    elements.paginationControls.appendChild(prevButton);
    
    // Current page indicator
    const pageInfo = document.createElement('div');
    pageInfo.className = 'page-info';
    pageInfo.innerHTML = `Page <span class="font-semibold mx-1">1</span> of ${totalPages}`;
    elements.paginationControls.appendChild(pageInfo);
    
    // Page number buttons
    const maxVisibleButtons = 5; // Reduced for a more compact display
    const pages = [];
    const currentPage = appState.currentPage || 1;
    
    if (totalPages <= maxVisibleButtons) {
        // Show all pages if total is small
        for (let i = 1; i <= totalPages; i++) {
            pages.push(i);
        }
    } else {
        // Complex pagination with ellipsis
        if (currentPage <= 2) {
            // Near start
            for (let i = 1; i <= 3; i++) {
                pages.push(i);
            }
            pages.push('...');
            pages.push(totalPages);
        } else if (currentPage >= totalPages - 1) {
            // Near end
            pages.push(1);
            pages.push('...');
            for (let i = totalPages - 2; i <= totalPages; i++) {
                pages.push(i);
            }
        } else {
            // Middle - always show current page with neighbors
            pages.push(1);
            if (currentPage > 3) pages.push('...');
            pages.push(currentPage - 1);
            pages.push(currentPage);
            pages.push(currentPage + 1);
            if (currentPage < totalPages - 2) pages.push('...');
            pages.push(totalPages);
        }
    }
    
    // Add page buttons to DOM
    pages.forEach(page => {
        if (page === '...') {
            const ellipsis = document.createElement('span');
            ellipsis.className = 'page-ellipsis';
            ellipsis.textContent = '...';
            elements.paginationControls.appendChild(ellipsis);
        } else {
            const pageBtn = document.createElement('button');
            pageBtn.className = 'page-btn';
            pageBtn.textContent = page;
            if (page === currentPage) {
                pageBtn.classList.add('active');
            }
            pageBtn.addEventListener('click', () => {
                displayFilteredStudiesPage(page);
            });
            elements.paginationControls.appendChild(pageBtn);
        }
    });
    
    // Next button
    const nextButton = document.createElement('button');
    nextButton.className = 'page-btn';
    nextButton.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
    `;
    nextButton.title = "Next Page";
    nextButton.disabled = currentPage === totalPages;
    nextButton.addEventListener('click', () => {
        if (currentPage < totalPages) {
            displayFilteredStudiesPage(currentPage + 1);
        }
    });
    elements.paginationControls.appendChild(nextButton);
    
    // Store references to prev/next buttons in app state for easier access
    appState.prevButton = prevButton;
    appState.nextButton = nextButton;
    
    // Add page jumper for large collections
    if (totalPages > 10) {
        const jumpContainer = document.createElement('div');
        jumpContainer.className = 'flex items-center ml-4 px-2 py-1 bg-white border border-gray-200 rounded-lg';
        
        const jumpLabel = document.createElement('span');
        jumpLabel.className = 'text-xs text-gray-500 mr-2';
        jumpLabel.textContent = 'Go to:';
        
        const jumpInput = document.createElement('input');
        jumpInput.type = 'number';
        jumpInput.min = 1;
        jumpInput.max = totalPages;
        jumpInput.value = currentPage;
        jumpInput.className = 'w-12 h-6 text-center text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500';
        
        const jumpButton = document.createElement('button');
        jumpButton.className = 'ml-1 px-2 py-1 text-xs text-white bg-blue-500 rounded hover:bg-blue-600 transition-colors';
        jumpButton.textContent = 'Go';
        jumpButton.addEventListener('click', () => {
            const pageNum = parseInt(jumpInput.value);
            if (pageNum && pageNum >= 1 && pageNum <= totalPages) {
                displayFilteredStudiesPage(pageNum);
            } else {
                // Visual feedback for invalid page
                jumpInput.classList.add('border-red-500');
                setTimeout(() => {
                    jumpInput.classList.remove('border-red-500');
                }, 500);
            }
        });
        
        // Handle Enter key press in the input field
        jumpInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                jumpButton.click();
            }
        });
        
        jumpContainer.appendChild(jumpLabel);
        jumpContainer.appendChild(jumpInput);
        jumpContainer.appendChild(jumpButton);
        
        elements.paginationControls.appendChild(jumpContainer);
    }
}

// Function to update active pagination button and page info
function updateActivePaginationButton(currentPage) {
    if (!elements.paginationControls) return;
    
    // Update prev/next button disabled states
    const totalPages = Math.ceil((appState.filteredStudies || appState.allStudies).length / ITEMS_PER_PAGE);
    
    if (appState.prevButton) {
        appState.prevButton.disabled = currentPage === 1;
    }
    
    if (appState.nextButton) {
        appState.nextButton.disabled = currentPage === totalPages;
    }
    
    // Update page info display
    const pageInfo = elements.paginationControls.querySelector('.page-info');
    if (pageInfo) {
        pageInfo.innerHTML = `Page <span class="font-semibold mx-1">${currentPage}</span> of ${totalPages}`;
    }
    
    // Update active page button
    const pageButtons = elements.paginationControls.querySelectorAll('.page-btn');
    pageButtons.forEach(button => {
        if (button.textContent === currentPage.toString()) {
            button.classList.add('active');
        } else {
            button.classList.remove('active');
        }
    });
    
    // Update any page jump input
    const jumpInput = elements.paginationControls.querySelector('input[type="number"]');
    if (jumpInput) {
        jumpInput.value = currentPage;
    }
}

// Display page of filtered studies with modern card design
function displayFilteredStudiesPage(page) {
    const studies = appState.filteredStudies || appState.allStudies;
    elements.studiesList.innerHTML = '';
    
    // Calculate start and end index for current page
    const startIndex = (page - 1) * ITEMS_PER_PAGE;
    const endIndex = Math.min(startIndex + ITEMS_PER_PAGE, studies.length);
    
    // Create a container for the grid layout
    const gridContainer = document.createElement('div');
    gridContainer.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4';
    elements.studiesList.appendChild(gridContainer);
    
    // Display the studies for this page
    for (let i = startIndex; i < endIndex; i++) {
        const study = studies[i];
        const delay = (i - startIndex) * 50; // Stagger the animations
        
        const nctId = study.protocolSection?.identificationModule?.nctId;
        const title = study.protocolSection?.identificationModule?.briefTitle;
        const phase = study.protocolSection?.designModule?.phases?.[0] || "N/A";
        const status = study.protocolSection?.statusModule?.overallStatus;
        const sponsor = study.protocolSection?.identificationModule?.organization?.fullName;
        const hasResults = study.hasResults;
        
        // Determine if this is a TRD-specific study
        const briefTitle = study.protocolSection?.identificationModule?.briefTitle?.toLowerCase() || '';
        const officialTitle = study.protocolSection?.identificationModule?.officialTitle?.toLowerCase() || '';
        const briefSummary = study.protocolSection?.descriptionModule?.briefSummary?.toLowerCase() || '';
        
        const trdTerms = [
            'treatment-resistant depression', 
            'treatment resistant depression',
            'trd',
            'refractory depression'
        ];
        
        const isTRDSpecific = trdTerms.some(term => 
            briefTitle.includes(term) || 
            officialTitle.includes(term) || 
            briefSummary.includes(term)
        );
        
        // Create a more modern card with hover effects
        const card = document.createElement('div');
        card.className = 'bg-white rounded-xl border border-gray-200 overflow-hidden hover:shadow-lg transition-all duration-300';
        card.style.animation = `fadeIn 0.3s ease-out ${delay}ms forwards`;
        
        card.innerHTML = `
            <div class="p-4">
                <div class="flex flex-wrap items-center gap-2 mb-3">
                    <div class="flex items-center">
                        <span class="inline-block w-3 h-3 rounded-full mr-1" style="background-color: ${getPhaseColor(phase)}"></span>
                        <span class="text-sm font-medium">${formatPhase(phase)}</span>
                    </div>
                    ${getStatusBadge(status)}
                    ${isTRDSpecific ? '<span class="text-xs bg-purple-100 text-purple-800 px-2 py-0.5 rounded-full">TRD-Specific</span>' : ''}
                    ${hasResults ? '<span class="text-xs bg-green-100 text-green-800 px-2 py-0.5 rounded-full flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>Has Results</span>' : ''}
                </div>
                
                <h3 class="text-lg font-semibold mb-2 line-clamp-2">${title}</h3>
                
                <p class="text-sm text-gray-600 mb-3">
                    <span class="font-medium">Sponsor:</span> ${sponsor || 'Unknown'}
                </p>
                
                <div class="flex items-center justify-between">
                    <span class="text-xs text-gray-500">${nctId}</span>
                    <button data-nctid="${nctId}" class="view-study-btn text-blue-600 hover:text-blue-800 text-sm font-medium flex items-center group transition-all">
                        <span class="mr-1">View Details</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 transform group-hover:translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" />
                        </svg>
                    </button>
                </div>
            </div>
        `;
        
        gridContainer.appendChild(card);
        
        // Add event listener to the view button
        card.querySelector('.view-study-btn').addEventListener('click', () => {
            viewStudyDetails(nctId);
        });
    }
    
    // Update current page in app state
    appState.currentPage = page;
    
    // Update active pagination button
    updateActivePaginationButton(page);
    
    // Update the results info message
    const resultsInfo = document.createElement('div');
    resultsInfo.className = 'text-sm text-gray-600 mt-4 mb-2 flex items-center';
    
    if (studies.length > 0) {
        resultsInfo.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-blue-500 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            Showing <span class="font-semibold mx-1">${startIndex + 1}</span> to <span class="font-semibold mx-1">${endIndex}</span> of <span class="font-semibold mx-1">${studies.length}</span> results
        `;
    } else {
        resultsInfo.textContent = 'No results found';
    }
    
    // Replace any existing results info
    const existingInfo = document.querySelector('.results-info');
    if (existingInfo) {
        existingInfo.replaceWith(resultsInfo);
    } else {
        // Insert before the studies list
        elements.studiesList.parentNode.insertBefore(resultsInfo, elements.studiesList);
    }
    resultsInfo.classList.add('results-info');
    
    // Check if there's any data to show page controls
    if (studies.length <= ITEMS_PER_PAGE) {
        // If we have 1 page or less, hide pagination controls
        if (elements.paginationControls) {
            elements.paginationControls.classList.add('hidden');
        }
    } else {
        // Make sure pagination controls are visible
        if (elements.paginationControls) {
            elements.paginationControls.classList.remove('hidden');
        }
    }
}

// Add search functionality to search within results
function addStudySearch() {
    // Create search input if it doesn't exist
    if (!elements.studySearch) {
        const searchContainer = document.createElement('div');
        searchContainer.className = 'mb-4';
        searchContainer.innerHTML = `
            <label class="block text-sm font-medium text-gray-700 mb-1">Search within results</label>
            <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </div>
                <input id="study-search" type="text" placeholder="Search by title, NCT ID, or sponsor..." 
                       class="w-full pl-10 pr-10 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                <button id="clear-search" class="absolute right-2 top-2 text-gray-400 hover:text-gray-600 hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
        `;
        
        // Insert search before the studies list
        elements.studiesList.parentNode.insertBefore(searchContainer, elements.studiesList);
        
        // Store reference to the search input
        elements.studySearch = document.getElementById('study-search');
        elements.clearSearch = document.getElementById('clear-search');
        
        // Add event listeners
        elements.studySearch.addEventListener('input', debounce(handleStudySearch, 300));
        elements.clearSearch.addEventListener('click', clearStudySearch);
        
        // Add Enter key support
        elements.studySearch.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                handleStudySearch();
            }
        });
    }
}

// Debounce function to prevent too many search operations
function debounce(func, wait) {
    let timeout;
    return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
    };
}

// Handle study search
function handleStudySearch() {
    const searchTerm = elements.studySearch.value.toLowerCase().trim();
    
    // Show/hide clear button
    elements.clearSearch.classList.toggle('hidden', !searchTerm);
    
    // Apply all filters with the current search term
    applyFilters();
}

// Clear study search
function clearStudySearch() {
    elements.studySearch.value = '';
    elements.clearSearch.classList.add('hidden');
    
    // Apply filters without the search term
    applyFilters();
}

// Initialize new features when page loads
function initPaginationAndSearch() {
    // Add these to your init function or document ready callback
    addStudySearch();
    addEnhancedFilters();
    
    // Make sure appState has required properties
    if (!appState) {
        appState = {};
    }
    
    appState.allStudies = [];
    appState.currentPage = 1;
    appState.filteredStudies = null;
    
    // Initialize filters
    appState.filters = {
        hasResults: false,
        isCompleted: false,
        phaseFilters: {
            PHASE1: true,
            PHASE1_PHASE2: true,
            PHASE2: true,
            PHASE3: true, 
            PHASE4: true,
            PRE_PHASE: true
        }
    };
}

// Call this when your app initializes
document.addEventListener('DOMContentLoaded', initPaginationAndSearch);
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


// // Function to display studies in the UI
// function displayStudies(studies, drug, condition) {
// elements.studiesList.innerHTML = '';
// elements.studyCount.textContent = studies.length;

// if (studies.length === 0) {
//     elements.studiesList.innerHTML = `
//         <div class="text-center p-4 text-gray-500">
//             <p>No studies found matching the current filters.</p>
//         </div>
//     `;
//     return;
// }


// const existingTimeline = document.getElementById('drug-usage-timeline');
//     if (existingTimeline) {
//         existingTimeline.remove();
//     }
    
// if (!drug){
//   displayStudiesWithTimeline(studies, condition , 'condition');
// }
//     displayStudiesWithTimeline(studies, drug, 'drug' );
        
//         // Update browser history and URL parameters
//         // updateUrlParameters(drug, condition, hasResultsOnly, trdFocusOnly);

// // Sort studies by phase
// const phaseOrder = { 
//     "PRE_PHASE": 0, 
//     "PHASE1": 1, 
//     "PHASE1_PHASE2": 1.5,
//     "PHASE2": 2, 
//     "PHASE3": 3, 
//     "PHASE4": 4 
// };

// studies.sort((a, b) => {
//     const phaseA = a.protocolSection?.designModule?.phases?.[0] || "PRE_PHASE";
//     const phaseB = b.protocolSection?.designModule?.phases?.[0] || "PRE_PHASE";
//     return (phaseOrder[phaseA] || 0) - (phaseOrder[phaseB] || 0);
// });

// studies.forEach(study => {
//     const nctId = study.protocolSection?.identificationModule?.nctId;
//     const title = study.protocolSection?.identificationModule?.briefTitle;
//     const phase = study.protocolSection?.designModule?.phases?.[0] || "N/A";
//     const status = study.protocolSection?.statusModule?.overallStatus;
//     const sponsor = study.protocolSection?.identificationModule?.organization?.fullName;
//     const hasResults = study.hasResults;
    
//     // Determine if this is a TRD-specific study
//     const briefTitle = study.protocolSection?.identificationModule?.briefTitle?.toLowerCase() || '';
//     const officialTitle = study.protocolSection?.identificationModule?.officialTitle?.toLowerCase() || '';
//     const briefSummary = study.protocolSection?.descriptionModule?.briefSummary?.toLowerCase() || '';
    
//     const trdTerms = [
//         'treatment-resistant depression', 
//         'treatment resistant depression',
//         'trd',
//         'refractory depression'
//     ];
    
//     const isTRDSpecific = trdTerms.some(term => 
//         briefTitle.includes(term) || 
//         officialTitle.includes(term) || 
//         briefSummary.includes(term)
//     );
    
//     const card = document.createElement('div');
//     card.className = 'bg-white p-4 rounded-lg border border-gray-200 hover:shadow-md transition duration-200';
//     card.innerHTML = `
//         <div class="flex flex-col md:flex-row gap-2 md:items-center md:justify-between mb-3">
//             <div class="flex gap-2 items-center flex-wrap">
//                 <span class="inline-block w-3 h-3 rounded-full" style="background-color: ${getPhaseColor(phase)}"></span>
//                 <span class="text-sm font-medium">${formatPhase(phase)}</span>
//                 ${getStatusBadge(status)}
//                 ${isTRDSpecific ? '<span class="text-xs bg-purple-100 text-purple-800 px-2 py-0.5 rounded-full">TRD-Specific</span>' : ''}
//             </div>
//             <div>
//                 <span class="text-xs text-gray-500">${nctId}</span>
//                 ${hasResults ? '<span class="ml-2 text-xs bg-green-100 text-green-800 px-2 py-0.5 rounded-full">Has Results</span>' : ''}
//             </div>
//         </div>
//         <h3 class="text-lg font-medium mb-2">${title}</h3>
//         <p class="text-sm text-gray-600 mb-3">Sponsor: ${sponsor || 'Unknown'}</p>
//         <button data-nctid="${nctId}" class="view-study-btn text-primary hover:text-blue-700 text-sm font-medium flex items-center">
//             <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
//                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
//             </svg>
//             View Study Details
//         </button>
//     `;
//     elements.studiesList.appendChild(card);
    
//     // Add event listener to the view button
//     card.querySelector('.view-study-btn').addEventListener('click', () => {
//         viewStudyDetails(nctId);
//     });
// });
// }

        

async function viewStudyDetails(nctId) {
            appState.currentStudyId = nctId;
            displayLoading(true);
            
            // Check if we already have the study details cached
            let studyDetails = appState.studyDetails[nctId];
            
            // If not cached, fetch from API
            if (!studyDetails) {
                studyDetails = await fetchStudyDetails(nctId);
                
                if (studyDetails) {
                    // Cache the study details
                    appState.studyDetails[nctId] = studyDetails;
                }
            }
            
            if (!studyDetails) {
                displayLoading(false);
                alert('Error loading study details. Please try again.');
                return;
            }
            
            // Display study details
            displayStudyDetail(studyDetails);
            
            // Show the detail section
            showSection(elements.studyDetailSection, true);
            elements.studyDetailSection.scrollIntoView({ behavior: 'smooth' });
            displayLoading(false);
        }

//         function displayStudyDetail(study) {
// console.log(study);
// const identification = study.protocolSection?.identificationModule || {};
// const design = study.protocolSection?.designModule || {};
// const description = study.protocolSection?.descriptionModule || {};
// const arms = study.protocolSection?.armsInterventionsModule?.armGroups || [];
// const eligibility = study.protocolSection?.eligibilityModule || {};
// const outcomes = study.resultsSection?.outcomeMeasuresModule?.outcomeMeasures || [];

// const primaryOutcomes = outcomes.filter(outcome => outcome.type === "PRIMARY");
// const secondaryOutcomes = outcomes.filter(outcome => outcome.type === "SECONDARY");

// // Determine if this is a TRD-specific study
// const title = identification.briefTitle?.toLowerCase() || '';
// const officialTitle = identification.officialTitle?.toLowerCase() || '';
// const briefSummary = description.briefSummary?.toLowerCase() || '';
// const detailedDescription = description.detailedDescription?.toLowerCase() || '';

// const trdTerms = [
//     'treatment-resistant depression', 
//     'treatment resistant depression',
//     'trd',
//     'refractory depression',
//     'treatment-refractory depression'
// ];

// const isTRDSpecific = trdTerms.some(term => 
//     title.includes(term) || 
//     officialTitle.includes(term) || 
//     briefSummary.includes(term) || 
//     detailedDescription.includes(term)
// );

// elements.studyDetailContent.innerHTML = `
//     <div class="border-b pb-4 mb-4">
//         <div class="flex justify-between items-start">
//             <h2 class="text-2xl font-semibold mb-2">${identification.briefTitle || 'Untitled Study'}</h2>
//             <button id="copyStudyData" class="text-primary hover:text-blue-700 flex items-center text-sm">
//                 <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-4M16 5h2a2 2 0 012 2v4M21 14H11" />
//                 </svg>
//                 Copy Data
//             </button>
//         </div>
//         <div class="flex flex-wrap gap-2 mb-2">
//             <span class="bg-gray-100 text-sm px-3 py-1 rounded-full">NCT ID: ${identification.nctId || 'N/A'}</span>
//             <span class="bg-gray-100 text-sm px-3 py-1 rounded-full">Phase: ${formatPhase(design.phases?.[0] || 'N/A')}</span>
//             <span class="bg-gray-100 text-sm px-3 py-1 rounded-full">Status: ${study.protocolSection?.statusModule?.overallStatus || 'N/A'}</span>
//             ${isTRDSpecific ? '<span class="bg-purple-100 text-purple-800 text-sm px-3 py-1 rounded-full">TRD-Specific</span>' : ''}
//         </div>
//         <p class="text-sm text-gray-600">Sponsor: ${identification.organization?.fullName || 'N/A'}</p>
//     </div>
            
//     <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
//         <div>
//             <h3 class="text-lg font-medium mb-2">Study Design</h3>
//             <div class="bg-gray-50 p-3 rounded-lg">
//                 <p><strong>Study Type:</strong> ${design.studyType || 'N/A'}</p>
//                 <p><strong>Allocation:</strong> ${design.designInfo?.allocation || 'N/A'}</p>
//                 <p><strong>Intervention Model:</strong> ${design.designInfo?.interventionModel || 'N/A'}</p>
//                 <p><strong>Masking:</strong> ${design.designInfo?.maskingInfo?.masking || 'N/A'}</p>
//                 <p><strong>Primary Purpose:</strong> ${design.designInfo?.primaryPurpose || 'N/A'}</p>
//             </div>
//         </div>
        
//         <div>
//             <h3 class="text-lg font-medium mb-2">Enrollment</h3>
//             <div class="bg-gray-50 p-3 rounded-lg">
//                 <p><strong>Enrollment:</strong> ${design.enrollmentInfo?.count || 'N/A'}</p>
//                 <p><strong>Sex:</strong> ${eligibility.sex || 'N/A'}</p>
//                 <p><strong>Minimum Age:</strong> ${eligibility.minimumAge || 'N/A'}</p>
//                 <p><strong>Maximum Age:</strong> ${eligibility.maximumAge || 'N/A'}</p>
//                 <p><strong>Healthy Volunteers:</strong> ${eligibility.healthyVolunteers || 'N/A'}</p>
//             </div>
//         </div>
//     </div>
            
//     <div class="mb-6">
//         <h3 class="text-lg font-medium mb-2">Brief Summary</h3>
//         <div class="bg-gray-50 p-3 rounded-lg">
//             <p>${description.briefSummary || 'No summary available.'}</p>
//         </div>
//     </div>
            
//     <div class="mb-6">
//         <h3 class="text-lg font-medium mb-2">Arms and Interventions</h3>
//         <div class="bg-gray-50 p-3 rounded-lg">
//             ${arms.length > 0 ? 
//                 `<div class="grid grid-cols-1 gap-3">
//                     ${arms.map(arm => `
//                         <div class="border-b border-gray-200 pb-3 last:border-b-0 last:pb-0">
//                             <p class="font-medium">${arm.label} (${arm.type})</p>
//                             <p class="text-sm">${arm.description || 'No description available.'}</p>
//                         </div>
//                     `).join('')}
//                 </div>` : 
//                 '<p class="italic text-gray-500">No arms or interventions information available.</p>'
//             }
//         </div>
//     </div>
            
//     <div id="outcomeVisuals" class="mb-6">
//         <h3 class="text-lg font-medium mb-2">Outcome Measurements</h3>
//         ${outcomes.length > 0 ? 
//             `<div class="space-y-6">
//                 ${primaryOutcomes.length > 0 ? 
//                     `<div>
//                         <h4 class="text-md font-medium mb-2">Primary Outcomes</h4>
//                         <div class="space-y-4">
//                             ${primaryOutcomes.map((outcome, idx) => `
//                                 <div class="bg-gray-50 p-3 rounded-lg">
//                                     <p class="font-medium">${outcome.title}</p>
//                                     <p class="text-sm mb-2">${outcome.description || 'No description available.'}</p>
//                                     <p class="text-sm text-gray-600">Time Frame: ${outcome.timeFrame || 'Not specified'}</p>
//                                     <div class="relative h-64 mt-3">
//                                         <canvas id="outcome_${identification.nctId}_${idx}"></canvas>
//                                     </div>
//                                 </div>
//                             `).join('')}
//                         </div>
//                     </div>` : 
//                     ''}
                
//                 ${secondaryOutcomes.length > 0 ? 
//                     `<div>
//                         <h4 class="text-md font-medium mb-2">Secondary Outcomes</h4>
//                         <div class="space-y-4">
//                             ${secondaryOutcomes.map((outcome, idx) => `
//                                 <div class="bg-gray-50 p-3 rounded-lg">
//                                     <p class="font-medium">${outcome.title}</p>
//                                     <p class="text-sm mb-2">${outcome.description || 'No description available.'}</p>
//                                     <p class="text-sm text-gray-600">Time Frame: ${outcome.timeFrame || 'Not specified'}</p>
//                                     <div class="relative h-64 mt-3">
//                                         <canvas id="outcome_secondary_${identification.nctId}_${idx}"></canvas>
//                                     </div>
//                                 </div>
//                             `).join('')}
//                         </div>
//                     </div>` : 
//                     ''}
//             </div>` : 
//             '<p class="italic text-gray-500">No outcome measurements available.</p>'
//         }
//     </div>
            
//     <div class="mt-6 text-center">
//         <a href="https://clinicaltrials.gov/study/${identification.nctId}" target="_blank" class="inline-flex items-center text-primary hover:text-blue-700">
//             <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
//             </svg>
//             View full study on ClinicalTrials.gov
//         </a>
//     </div>
// `;

// // Create outcome charts after content is added to DOM
// setTimeout(() => {
//     createOutcomeCharts(study);
    
//     // Add event listener for copy button
//     const copyButton = document.getElementById('copyStudyData');
//     if (copyButton) {
//         copyButton.addEventListener('click', () => {
//             copyTrialDataToClipboard(identification.nctId);
//         });
//     }
// }, 100);
// }




//         function displayStudyDetail(study) {
//             console.log(study)
//             const identification = study.protocolSection?.identificationModule || {};
//             const design = study.protocolSection?.designModule || {};
//             const description = study.protocolSection?.descriptionModule || {};
//             const arms = study.protocolSection?.armsInterventionsModule?.armGroups || [];
//             const eligibility = study.protocolSection?.eligibilityModule || {};
//             const outcomes = study.resultsSection?.outcomeMeasuresModule?.outcomeMeasures || [];
            
//             const primaryOutcomes = outcomes.filter(outcome => outcome.type === "PRIMARY");
//             const secondaryOutcomes = outcomes.filter(outcome => outcome.type === "SECONDARY");
            
//             // Determine if this is a TRD-specific study
//             const title = identification.briefTitle?.toLowerCase() || '';
//             const officialTitle = identification.officialTitle?.toLowerCase() || '';
//             const briefSummary = description.briefSummary?.toLowerCase() || '';
//             const detailedDescription = description.detailedDescription?.toLowerCase() || '';
            
//             const trdTerms = [
//                 'treatment-resistant depression', 
//                 'treatment resistant depression',
//                 'trd',
//                 'refractory depression',
//                 'treatment-refractory depression'
//             ];
            
//             const isTRDSpecific = trdTerms.some(term => 
//                 title.includes(term) || 
//                 officialTitle.includes(term) || 
//                 briefSummary.includes(term) || 
//                 detailedDescription.includes(term)
//             );
            
//             elements.studyDetailContent.innerHTML = `
//         <div class="border-b pb-4 mb-4">
//             <div class="flex justify-between items-start">
//                 <h2 class="text-2xl font-semibold mb-2">${identification.briefTitle || 'Untitled Study'}</h2>
//                 <button id="copyStudyData" class="text-primary hover:text-blue-700 flex items-center text-sm">
//                     <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-4M16 5h2a2 2 0 012 2v4M21 14H11" />
//                     </svg>
//                     Copy Data
//                 </button>
//             </div>
//             <div class="flex flex-wrap gap-2 mb-2">
//                 <span class="bg-gray-100 text-sm px-3 py-1 rounded-full">NCT ID: ${identification.nctId || 'N/A'}</span>
//                 <span class="bg-gray-100 text-sm px-3 py-1 rounded-full">Phase: ${formatPhase(design.phases?.[0] || 'N/A')}</span>
//                 <span class="bg-gray-100 text-sm px-3 py-1 rounded-full">Status: ${study.protocolSection?.statusModule?.overallStatus || 'N/A'}</span>
//                 ${isTRDSpecific ? '<span class="bg-purple-100 text-purple-800 text-sm px-3 py-1 rounded-full">TRD-Specific</span>' : ''}
//             </div>
//             <p class="text-sm text-gray-600">Sponsor: ${identification.organization?.fullName || 'N/A'}</p>
//         </div>
                
//                 <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
//                     <div>
//                         <h3 class="text-lg font-medium mb-2">Study Design</h3>
//                         <div class="bg-gray-50 p-3 rounded-lg">
//                             <p><strong>Study Type:</strong> ${design.studyType || 'N/A'}</p>
//                             <p><strong>Allocation:</strong> ${design.designInfo?.allocation || 'N/A'}</p>
//                             <p><strong>Intervention Model:</strong> ${design.designInfo?.interventionModel || 'N/A'}</p>
//                             <p><strong>Masking:</strong> ${design.designInfo?.maskingInfo?.masking || 'N/A'}</p>
//                             <p><strong>Primary Purpose:</strong> ${design.designInfo?.primaryPurpose || 'N/A'}</p>
//                         </div>
//                     </div>
                    
//                     <div>
//                         <h3 class="text-lg font-medium mb-2">Enrollment</h3>
//                         <div class="bg-gray-50 p-3 rounded-lg">
//                             <p><strong>Enrollment:</strong> ${design.enrollmentInfo.count || 'N/A'}</p>
//                             <p><strong>Sex:</strong> ${eligibility.sex || 'N/A'}</p>
//                             <p><strong>Minimum Age:</strong> ${eligibility.minimumAge || 'N/A'}</p>
//                             <p><strong>Maximum Age:</strong> ${eligibility.maximumAge || 'N/A'}</p>
//                             <p><strong>Healthy Volunteers:</strong> ${eligibility.healthyVolunteers || 'N/A'}</p>
//                         </div>
//                     </div>
//                 </div>
                
//                 <div class="mb-6">
//                     <h3 class="text-lg font-medium mb-2">Brief Summary</h3>
//                     <div class="bg-gray-50 p-3 rounded-lg">
//                         <p>${description.briefSummary || 'No summary available.'}</p>
//                     </div>
//                 </div>
                
//                 <div class="mb-6">
//                     <h3 class="text-lg font-medium mb-2">Arms and Interventions</h3>
//                     <div class="bg-gray-50 p-3 rounded-lg">
//                         ${arms.length > 0 ? 
//                             `<div class="grid grid-cols-1 gap-3">
//                                 ${arms.map(arm => `
//                                     <div class="border-b border-gray-200 pb-3 last:border-b-0 last:pb-0">
//                                         <p class="font-medium">${arm.label} (${arm.type})</p>
//                                         <p class="text-sm">${arm.description || 'No description available.'}</p>
//                                     </div>
//                                 `).join('')}
//                             </div>` : 
//                             '<p class="italic text-gray-500">No arms or interventions information available.</p>'
//                         }
//                     </div>
//                 </div>
                
//                 <div id="outcomeVisuals" class="mb-6">
//                     <h3 class="text-lg font-medium mb-2">Outcome Measurements</h3>
//                     ${outcomes.length > 0 ? 
//                         `<div class="space-y-6">
//                             ${primaryOutcomes.length > 0 ? 
//                                 `<div>
//                                     <h4 class="text-md font-medium mb-2">Primary Outcomes</h4>
//                                     <div class="space-y-4">
//                                         ${primaryOutcomes.map((outcome, idx) => `
//                                             <div class="bg-gray-50 p-3 rounded-lg">
//                                                 <p class="font-medium">${outcome.title}</p>
//                                                 <p class="text-sm mb-2">${outcome.description || 'No description available.'}</p>
//                                                 <p class="text-sm text-gray-600">Time Frame: ${outcome.timeFrame || 'Not specified'}</p>
//                                                 <div class="h-48 mt-3">
//                                                     <canvas id="outcome_${identification.nctId}_${idx}"></canvas>
//                                                 </div>
//                                             </div>
//                                         `).join('')}
//                                     </div>
//                                 </div>` : 
//                                 ''}
                            
//                             ${secondaryOutcomes.length > 0 ? 
//                                 `<div>
//                                     <h4 class="text-md font-medium mb-2">Secondary Outcomes</h4>
//                                     <div class="space-y-4">
//                                         ${secondaryOutcomes.map((outcome, idx) => `
//                                             <div class="bg-gray-50 p-3 rounded-lg">
//                                                 <p class="font-medium">${outcome.title}</p>
//                                                 <p class="text-sm mb-2">${outcome.description || 'No description available.'}</p>
//                                                 <p class="text-sm text-gray-600">Time Frame: ${outcome.timeFrame || 'Not specified'}</p>
//                                                 <div class="h-48 mt-3">
//                                                     <canvas id="outcome_secondary_${identification.nctId}_${idx}"></canvas>
//                                                 </div>
//                                             </div>
//                                         `).join('')}
//                                     </div>
//                                 </div>` : 
//                                 ''}
//                         </div>` : 
//                         '<p class="italic text-gray-500">No outcome measurements available.</p>'
//                     }
//                 </div>
                
//                 <div class="mt-6 text-center">
//                     <a href="https://clinicaltrials.gov/study/${identification.nctId}" target="_blank" class="inline-flex items-center text-primary hover:text-blue-700">
//                         <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
//                         </svg>
//                         View full study on ClinicalTrials.gov
//                     </a>
//                             <button id="viewFdaData" class="text-primary hover:text-blue-700 flex items-center">
//                 <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
//                 </svg>
//                 View FDA Data
//             </button>
//         </div>
//             `;
            
//             // Create outcome charts after content is added to DOM
//             setTimeout(() => {
//         createOutcomeCharts(study);
        
//         // Add event listener for copy button
//         const copyButton = document.getElementById('copyStudyData');
//         if (copyButton) {
//             copyButton.addEventListener('click', () => {
//                 copyTrialDataToClipboard(identification.nctId);
//             });
//         }
        
//         // Add event listener for view FDA data button
//         const viewFdaButton = document.getElementById('viewFdaData');
//         if (viewFdaButton) {
//             viewFdaButton.addEventListener('click', () => {
//                 // Scroll to FDA data section
//                 elements.fdaDataSection.scrollIntoView({ behavior: 'smooth' });
//             });
//         }
//     }, 100);
// }


/**
 * Enhanced function to display study details with improved UI and data extraction
 */
 function displayStudyDetail(study) {
    if (!study) {
        console.error("No study data provided to displayStudyDetail");
        return;
    }
    
    console.log("Displaying study detail:", study);
    
    // Safely extract study data with fallbacks
    const identification = study.protocolSection?.identificationModule || {};
    const design = study.protocolSection?.designModule || {};
    const status = study.protocolSection?.statusModule || {};
    const description = study.protocolSection?.descriptionModule || {};
    const arms = study.protocolSection?.armsInterventionsModule?.armGroups || [];
    const eligibility = study.protocolSection?.eligibilityModule || {};
    const outcomes = study.resultsSection?.outcomeMeasuresModule?.outcomeMeasures || [];
    const sponsor = study.protocolSection?.sponsorCollaboratorsModule?.leadSponsor || {};
    
    // Categorize outcomes
    const primaryOutcomes = outcomes.filter(outcome => outcome.type === "PRIMARY");
    const secondaryOutcomes = outcomes.filter(outcome => outcome.type === "SECONDARY");
    
    // Format dates
    const formatDate = (dateStruct) => {
        if (!dateStruct || !dateStruct.date) return 'Not specified';
        return new Date(dateStruct.date).toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
    };
    
    // Get enrollment count
    const enrollmentCount = design.enrollmentInfo?.count || 'Not specified';
    
    // Determine study phase display
    const phaseDisplay = formatPhase(design.phases?.[0] || 'N/A');
    
    // Get study duration
    const startDate = formatDate(status.startDateStruct);
    const completionDate = formatDate(status.completionDateStruct);
    
    // Study duration calculation
    let durationDisplay = 'Not available';
    if (status.startDateStruct?.date && status.completionDateStruct?.date) {
        const start = new Date(status.startDateStruct.date);
        const end = new Date(status.completionDateStruct.date);
        const durationMs = end - start;
        const durationDays = Math.floor(durationMs / (1000 * 60 * 60 * 24));
        const durationMonths = Math.floor(durationDays / 30);
        const durationYears = Math.floor(durationMonths / 12);
        
        if (durationYears > 0) {
            durationDisplay = `${durationYears} year${durationYears !== 1 ? 's' : ''}`;
            if (durationMonths % 12 > 0) {
                durationDisplay += `, ${durationMonths % 12} month${durationMonths % 12 !== 1 ? 's' : ''}`;
            }
        } else if (durationMonths > 0) {
            durationDisplay = `${durationMonths} month${durationMonths !== 1 ? 's' : ''}`;
        } else {
            durationDisplay = `${durationDays} day${durationDays !== 1 ? 's' : ''}`;
        }
    }
    
    // Determine if this is a TRD-specific study
    const title = identification.briefTitle?.toLowerCase() || '';
    const officialTitle = identification.officialTitle?.toLowerCase() || '';
    const briefSummary = description.briefSummary?.toLowerCase() || '';
    const detailedDescription = description.detailedDescription?.toLowerCase() || '';
    
    const trdTerms = [
        'treatment-resistant depression', 
        'treatment resistant depression',
        'trd',
        'refractory depression',
        'treatment-refractory depression'
    ];
    
    const isTRDSpecific = trdTerms.some(term => 
        title.includes(term) || 
        officialTitle.includes(term) || 
        briefSummary.includes(term) || 
        detailedDescription.includes(term)
    );
    
    // Get masking information
    const maskingInfo = design.designInfo?.maskingInfo || {};
    const masking = maskingInfo.masking || 'Not specified';
    const maskingDesc = maskingInfo.maskingDescription || '';
    const whoMasked = maskingInfo.whoMasked || [];
    
    // Format masked parties
    let maskingParties = '';
    if (whoMasked && whoMasked.length > 0) {
        maskingParties = whoMasked.map(party => {
            return party
                .replace('_', ' ')
                .toLowerCase()
                .replace(/\b\w/g, c => c.toUpperCase());
        }).join(', ');
    }
    
    // Build HTML for study detail
    elements.studyDetailContent.innerHTML = `
        <!-- Study Header with Key Info -->
        <div class="border-b pb-6 mb-6">
            <div class="flex justify-between items-start mb-4">
                <h2 class="text-2xl font-bold text-gray-900">${identification.briefTitle || 'Untitled Study'}</h2>
                <div class="flex gap-2">
                    <button id="copyStudyData" class="text-blue-600 hover:text-blue-800 flex items-center text-sm font-medium">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-4M16 5h2a2 2 0 012 2v4M21 14H11" />
                        </svg>
                        Copy Data
                    </button>
                    <a href="https://clinicaltrials.gov/study/${identification.nctId}" target="_blank" class="text-blue-600 hover:text-blue-800 flex items-center text-sm font-medium">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                        </svg>
                        View on ClinicalTrials.gov
                    </a>
                </div>
            </div>
            
            <!-- Key Identifiers Row -->
            <div class="flex flex-wrap gap-2 mb-4">
                <span class="bg-gray-100 text-sm px-3 py-1 rounded-full font-medium">NCT ID: ${identification.nctId || 'N/A'}</span>
                <span class="bg-gray-100 text-sm px-3 py-1 rounded-full font-medium">Phase: ${phaseDisplay}</span>
                <span class="bg-${getStatusColor(status.overallStatus)} text-white text-sm px-3 py-1 rounded-full font-medium">${formatStatus(status.overallStatus)}</span>
                ${isTRDSpecific ? '<span class="bg-purple-100 text-purple-800 text-sm px-3 py-1 rounded-full font-medium">TRD-Specific</span>' : ''}
                ${study.hasResults ? '<span class="bg-green-100 text-green-800 text-sm px-3 py-1 rounded-full font-medium">Has Results</span>' : ''}
            </div>
            
            <!-- Study Metadata -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mt-4">
                <div>
                    <p class="text-sm text-gray-500">Sponsor</p>
                    <p class="font-medium">${sponsor.name || 'Unknown'}</p>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Study Start</p>
                    <p class="font-medium">${startDate}</p>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Completion</p>
                    <p class="font-medium">${completionDate}</p>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Duration</p>
                    <p class="font-medium">${durationDisplay}</p>
                </div>
            </div>
        </div>
        
        <!-- Two-Column Layout for Details -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <!-- Left Column: Study Design & Enrollment -->
            <div class="lg:col-span-1">
                <!-- Study Design Card -->
                <div class="bg-white rounded-lg border border-gray-200 p-4 mb-6 shadow-sm">
                    <h3 class="text-lg font-semibold mb-3 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                        </svg>
                        Study Design
                    </h3>
                    <div class="space-y-2">
                        <div>
                            <p class="text-sm text-gray-500">Study Type</p>
                            <p class="font-medium">${design.studyType || 'N/A'}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Allocation</p>
                            <p class="font-medium">${formatDesignInfo(design.designInfo?.allocation)}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Intervention Model</p>
                            <p class="font-medium">${formatDesignInfo(design.designInfo?.interventionModel)}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Primary Purpose</p>
                            <p class="font-medium">${formatDesignInfo(design.designInfo?.primaryPurpose)}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Masking</p>
                            <p class="font-medium">${formatDesignInfo(masking)}</p>
                            ${maskingParties ? `<p class="text-sm text-gray-600">Who masked: ${maskingParties}</p>` : ''}
                            ${maskingDesc ? `<p class="text-sm italic text-gray-600 mt-1">${maskingDesc}</p>` : ''}
                        </div>
                    </div>
                </div>
                
                <!-- Enrollment Card -->
                <div class="bg-white rounded-lg border border-gray-200 p-4 mb-6 shadow-sm">
                    <h3 class="text-lg font-semibold mb-3 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                        </svg>
                        Enrollment
                    </h3>
                    <div class="space-y-2">
                        <div>
                            <p class="text-sm text-gray-500">Total Enrollment</p>
                            <p class="font-medium">${enrollmentCount}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Sex/Gender</p>
                            <p class="font-medium">${formatGender(eligibility.sex)}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Age Range</p>
                            <p class="font-medium">${eligibility.minimumAge || 'N/A'} to ${eligibility.maximumAge || 'N/A'}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Healthy Volunteers</p>
                            <p class="font-medium">${eligibility.healthyVolunteers === true ? 'Accepted' : eligibility.healthyVolunteers === false ? 'Not Accepted' : 'Not Specified'}</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Right Column: Summary & Arms -->
            <div class="lg:col-span-2">
                <!-- Brief Summary -->
                <div class="bg-white rounded-lg border border-gray-200 p-4 mb-6 shadow-sm">
                    <h3 class="text-lg font-semibold mb-3 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        Study Summary
                    </h3>
                    <div class="prose prose-sm max-w-none">
                        <p>${description.briefSummary || 'No summary available.'}</p>
                        ${description.detailedDescription ? `
                            <div class="mt-4 pt-4 border-t border-gray-100">
                                <p class="font-medium mb-2">Detailed Description:</p>
                                <p>${description.detailedDescription}</p>
                            </div>
                        ` : ''}
                    </div>
                </div>
                
                <!-- Arms and Interventions -->
                <div class="bg-white rounded-lg border border-gray-200 p-4 mb-6 shadow-sm">
                    <h3 class="text-lg font-semibold mb-3 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                        </svg>
                        Arms and Interventions
                    </h3>
                    ${arms.length > 0 ? 
                        `<div class="space-y-4">
                            ${arms.map(arm => {
                                // Determine arm color based on type
                                let typeColor = 'bg-gray-100 text-gray-800';
                                if (arm.type === 'EXPERIMENTAL') typeColor = 'bg-blue-100 text-blue-800';
                                if (arm.type === 'ACTIVE_COMPARATOR') typeColor = 'bg-green-100 text-green-800';
                                if (arm.type === 'PLACEBO_COMPARATOR') typeColor = 'bg-purple-100 text-purple-800';
                                if (arm.type === 'SHAM_COMPARATOR') typeColor = 'bg-yellow-100 text-yellow-800';
                                if (arm.type === 'NO_INTERVENTION') typeColor = 'bg-gray-100 text-gray-800';
                                
                                return `
                                <div class="border-b border-gray-100 pb-4 last:border-b-0 last:pb-0">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <h4 class="font-medium text-gray-900">${arm.label || 'Unnamed Arm'}</h4>
                                            <span class="inline-block ${typeColor} text-xs px-2 py-1 rounded-full mt-1">
                                                ${formatArmType(arm.type)}
                                            </span>
                                        </div>
                                    </div>
                                    <p class="text-sm mt-2">${arm.description || 'No description available.'}</p>
                                    ${arm.interventionNames && arm.interventionNames.length > 0 ? 
                                        `<div class="mt-2">
                                            <p class="text-xs text-gray-500">Interventions:</p>
                                            <div class="flex flex-wrap gap-1 mt-1">
                                                ${arm.interventionNames.map(intervention => 
                                                    `<span class="bg-gray-100 text-xs px-2 py-1 rounded-full">${intervention}</span>`
                                                ).join('')}
                                            </div>
                                        </div>` : ''
                                    }
                                </div>`;
                            }).join('')}
                        </div>` : 
                        '<p class="italic text-gray-500">No arms or interventions information available.</p>'
                    }
                </div>
            </div>
        </div>
        
        <!-- Outcome Measurements -->
        <div id="outcomeVisuals" class="mb-8">
            <h3 class="text-xl font-semibold mb-4 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                </svg>
                Outcome Measurements
            </h3>
            ${outcomes.length > 0 ? 
                `<div class="space-y-8">
                    ${primaryOutcomes.length > 0 ? 
                        `<div>
                            <h4 class="text-lg font-medium mb-3 flex items-center">
                                <span class="inline-block w-2 h-2 rounded-full bg-blue-500 mr-2"></span>
                                Primary Outcomes
                            </h4>
                            <div class="space-y-6">
                                ${primaryOutcomes.map((outcome, idx) => `
                                    <div class="bg-white rounded-lg border border-gray-200 overflow-hidden shadow-sm">
                                        <div class="p-4 border-b border-gray-100">
                                            <h5 class="font-medium text-lg text-gray-900">${outcome.title}</h5>
                                            <p class="text-sm mt-1">${outcome.description || 'No description available.'}</p>
                                            <div class="flex flex-wrap gap-2 mt-2">
                                                <span class="text-xs bg-gray-100 px-2 py-1 rounded-full">Time Frame: ${outcome.timeFrame || 'Not specified'}</span>
                                                ${outcome.unitOfMeasure ? `<span class="text-xs bg-gray-100 px-2 py-1 rounded-full">Unit: ${outcome.unitOfMeasure}</span>` : ''}
                                                ${outcome.paramType ? `<span class="text-xs bg-gray-100 px-2 py-1 rounded-full">Type: ${formatParamType(outcome.paramType)}</span>` : ''}
                                            </div>
                                        </div>
                                        <div class="relative h-80 p-4">
                                            <canvas id="outcome_${identification.nctId}_${idx}"></canvas>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>` : 
                        ''}
                    
                    ${secondaryOutcomes.length > 0 ? 
                        `<div>
                            <h4 class="text-lg font-medium mb-3 flex items-center">
                                <span class="inline-block w-2 h-2 rounded-full bg-green-500 mr-2"></span>
                                Secondary Outcomes
                            </h4>
                            <div class="space-y-6">
                                ${secondaryOutcomes.map((outcome, idx) => `
                                    <div class="bg-white rounded-lg border border-gray-200 overflow-hidden shadow-sm">
                                        <div class="p-4 border-b border-gray-100">
                                            <h5 class="font-medium text-lg text-gray-900">${outcome.title}</h5>
                                            <p class="text-sm mt-1">${outcome.description || 'No description available.'}</p>
                                            <div class="flex flex-wrap gap-2 mt-2">
                                                <span class="text-xs bg-gray-100 px-2 py-1 rounded-full">Time Frame: ${outcome.timeFrame || 'Not specified'}</span>
                                                ${outcome.unitOfMeasure ? `<span class="text-xs bg-gray-100 px-2 py-1 rounded-full">Unit: ${outcome.unitOfMeasure}</span>` : ''}
                                                ${outcome.paramType ? `<span class="text-xs bg-gray-100 px-2 py-1 rounded-full">Type: ${formatParamType(outcome.paramType)}</span>` : ''}
                                            </div>
                                        </div>
                                        <div class="relative h-80 p-4">
                                            <canvas id="outcome_secondary_${identification.nctId}_${idx}"></canvas>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>` : 
                        ''}
                </div>` : 
                '<div class="bg-gray-50 rounded-lg p-6 text-center"><p class="italic text-gray-500">No outcome measurements available for this study.</p></div>'
            }
        </div>
    `;
    
    // Create outcome charts after content is added to DOM
    setTimeout(() => {
        createOutcomeCharts(study);
        
        // Add event listener for copy button
        const copyButton = document.getElementById('copyStudyData');
        if (copyButton) {
            copyButton.addEventListener('click', () => {
                copyTrialDataToClipboard(identification.nctId);
            });
        }
    }, 100);
}

/**
 * Helper functions for formatting study data
 */

// Format phase text
function formatPhase(phase) {
    if (!phase) return 'N/A';
    return phase
        .replace('PHASE', 'Phase ')
        .replace('PRE_', 'Pre-')
        .replace('_', '/');
}

// Format study status
function formatStatus(status) {
    if (!status) return 'Unknown';
    return status
        .replace(/_/g, ' ')
        .toLowerCase()
        .replace(/\b\w/g, c => c.toUpperCase());
}

// Get color for status
function getStatusColor(status) {
    if (!status) return 'gray-500';
    
    const statusColors = {
        'COMPLETED': 'green-500',
        'RECRUITING': 'blue-500',
        'NOT_YET_RECRUITING': 'yellow-500',
        'ACTIVE_NOT_RECRUITING': 'indigo-500',
        'TERMINATED': 'red-500',
        'WITHDRAWN': 'gray-500',
        'SUSPENDED': 'orange-500',
        'ENROLLING_BY_INVITATION': 'purple-500',
        'AVAILABLE': 'teal-500',
        'NO_LONGER_AVAILABLE': 'gray-500',
        'APPROVED_FOR_MARKETING': 'green-500',
        'WITHHELD': 'gray-500',
        'UNKNOWN': 'gray-500'
    };
    
    return statusColors[status] || 'gray-500';
}

// Format design info fields
function formatDesignInfo(value) {
    if (!value) return 'Not specified';
    return value
        .replace(/_/g, ' ')
        .toLowerCase()
        .replace(/\b\w/g, c => c.toUpperCase());
}

// Format gender display
function formatGender(sex) {
    if (!sex) return 'Not specified';
    
    if (sex === 'ALL') return 'All Genders';
    if (sex === 'FEMALE') return 'Female';
    if (sex === 'MALE') return 'Male';
    
    return sex
        .replace(/_/g, ' ')
        .toLowerCase()
        .replace(/\b\w/g, c => c.toUpperCase());
}

// Format arm type for display
function formatArmType(type) {
    if (!type) return 'Unknown';
    
    const typeNames = {
        'EXPERIMENTAL': 'Experimental',
        'ACTIVE_COMPARATOR': 'Active Comparator',
        'PLACEBO_COMPARATOR': 'Placebo',
        'SHAM_COMPARATOR': 'Sham',
        'NO_INTERVENTION': 'No Intervention',
        'OTHER': 'Other'
    };
    
    return typeNames[type] || type
        .replace(/_/g, ' ')
        .toLowerCase()
        .replace(/\b\w/g, c => c.toUpperCase());
}

// Format parameter type
function formatParamType(paramType) {
    if (!paramType) return 'Not specified';
    
    const paramTypeNames = {
        'MEAN': 'Mean',
        'MEDIAN': 'Median',
        'LEAST_SQUARES_MEAN': 'Least Squares Mean',
        'GEOMETRIC_MEAN': 'Geometric Mean',
        'NUMBER': 'Number',
        'COUNT_OF_PARTICIPANTS': 'Count of Participants',
        'COUNT_OF_UNITS': 'Count of Units'
    };
    
    return paramTypeNames[paramType] || paramType
        .replace(/_/g, ' ')
        .toLowerCase()
        .replace(/\b\w/g, c => c.toUpperCase());
}



// function collectAllTrialOutcomes() {
//     console.log("Collecting all trial outcomes data...");
//     appState.allTrialOutcomes = [];
    
//     // Get all studies with results
//     const studiesWithResults = appState.studies.filter(study => study.hasResults);
//     console.log(`Found ${studiesWithResults.length} studies with results`);
    
//     // For each study, collect the outcome measures
//     studiesWithResults.forEach(study => {
//         const nctId = study.protocolSection?.identificationModule?.nctId;
//         const studyDetails = appState.studyDetails[nctId];
        
//         if (!studyDetails || !studyDetails.resultsSection?.outcomeMeasuresModule?.outcomeMeasures) {
//             console.warn(`No outcome measures found for study ${nctId}`);
//             return;
//         }
        
//         const phase = study.protocolSection?.designModule?.phases?.[0] || 'N/A';
//         const studyTitle = study.protocolSection?.identificationModule?.briefTitle || 'Untitled Study';
//         const outcomes = studyDetails.resultsSection.outcomeMeasuresModule.outcomeMeasures;
        
//         console.log(`Processing ${outcomes.length} outcomes for study ${nctId} (${studyTitle})`);
        
//         // Store basic study info
//         const studyInfo = {
//             nctId,
//             title: studyTitle,
//             phase,
//             sponsor: study.protocolSection?.identificationModule?.organization?.fullName || 'Unknown',
//             status: study.protocolSection?.statusModule?.overallStatus || 'Unknown',
//             outcomes: []
//         };
        
//         // Process each outcome measure
//         outcomes.forEach(outcome => {
//             if (!outcome.classes || !outcome.classes[0]?.categories) {
//                 console.warn(`Skipping outcome with no categories: ${outcome.title}`);
//                 return;
//             }
            
//             const outcomeType = outcome.type?.toLowerCase() || 'other';
//             const outcomeTitle = outcome.title || 'Unknown Outcome';
//             const timeFrame = outcome.timeFrame || 'Not specified';
            
//             // Process each measurement class and category
//             outcome.classes.forEach(cls => {
//                 cls.categories.forEach(cat => {
//                     const categoryData = {
//                         title: cat.title || '',
//                         measurements: []
//                     };
                    
//                     // Extract all measurements
//                     cat.measurements.forEach(measurement => {
//                         const value = parseFloat(measurement.value);
//                         if (isNaN(value)) return;
                        
//                         const group = outcome.groups.find(g => g.id === measurement.groupId);
//                         if (!group) return;
                        
//                         const groupTitle = group.title || 'Unknown Group';
//                         const isControlGroup = 
//                             groupTitle.toLowerCase().includes('placebo') || 
//                             groupTitle.toLowerCase().includes('control') ||
//                             groupTitle.toLowerCase().includes('sham');
                        
//                         // Calculate standard error or other statistics if available
//                         let standardError = null;
//                         let dispersion = null;
//                         let dispersionType = null;
                        
//                         if (measurement.dispersion && measurement.dispersion !== 'null') {
//                             dispersion = parseFloat(measurement.dispersion);
//                             dispersionType = measurement.dispersionType?.toLowerCase() || '';
                            
//                             if (!isNaN(dispersion)) {
//                                 if (dispersionType === 'standard_error') {
//                                     standardError = dispersion;
//                                 } else if (dispersionType === 'standard_deviation') {
//                                     // Convert SD to SE if sample size is available
//                                     const sampleSize = group.participantsAnalyzedList?.[0]?.count;
//                                     if (sampleSize && !isNaN(sampleSize) && sampleSize > 0) {
//                                         standardError = dispersion / Math.sqrt(sampleSize);
//                                     }
//                                 }
//                             }
//                         }
                        
//                         // Add measurement data
//                         categoryData.measurements.push({
//                             value,
//                             groupId: measurement.groupId,
//                             groupTitle,
//                             isControlGroup,
//                             sampleSize: group.participantsAnalyzedList?.[0]?.count || 0,
//                             standardError,
//                             dispersion,
//                             dispersionType
//                         });
//                     });
                    
//                     // Only add categories with measurements
//                     if (categoryData.measurements.length > 0) {
//                         // Calculate effect size if we have both experimental and control groups
//                         const experimentalMeasurements = categoryData.measurements.filter(m => !m.isControlGroup);
//                         const controlMeasurements = categoryData.measurements.filter(m => m.isControlGroup);
                        
//                         let effectSize = null;
//                         let experimentalValue = null;
//                         let controlValue = null;
//                         let experimentalSampleSize = 0;
//                         let controlSampleSize = 0;
                        
//                         if (experimentalMeasurements.length > 0) {
//                             // Calculate weighted average for experimental group
//                             const expTotal = experimentalMeasurements.reduce((sum, m) => sum + (m.value * m.sampleSize), 0);
//                             experimentalSampleSize = experimentalMeasurements.reduce((sum, m) => sum + m.sampleSize, 0);
//                             experimentalValue = experimentalSampleSize > 0 ? expTotal / experimentalSampleSize : null;
//                         }
                        
//                         if (controlMeasurements.length > 0) {
//                             // Calculate weighted average for control group
//                             const ctrlTotal = controlMeasurements.reduce((sum, m) => sum + (m.value * m.sampleSize), 0);
//                             controlSampleSize = controlMeasurements.reduce((sum, m) => sum + m.sampleSize, 0);
//                             controlValue = controlSampleSize > 0 ? ctrlTotal / controlSampleSize : null;
//                         }
                        
//                         // Calculate effect size if both values exist
//                         if (experimentalValue !== null && controlValue !== null) {
//                             // Standardize the effect based on outcome metric
//                             effectSize = standardizeOutcomeValue(experimentalValue - controlValue, outcomeTitle);
//                         }
                        
//                         // Add the processed outcome data
//                         studyInfo.outcomes.push({
//                             title: outcomeTitle,
//                             type: outcomeType,
//                             timeFrame,
//                             category: categoryData.title,
//                             measurements: categoryData.measurements,
//                             experimentalValue,
//                             controlValue,
//                             effectSize,
//                             experimentalSampleSize,
//                             controlSampleSize
//                         });
//                     }
//                 });
//             });
//         });
        
//         // Add this study's info to the collection if it has outcomes
//         if (studyInfo.outcomes.length > 0) {
//             appState.allTrialOutcomes.push(studyInfo);
//         }
//     });
    
//     console.log(`Collected outcome data from ${appState.allTrialOutcomes.length} studies`);
//     console.log("All outcomes data:", appState.allTrialOutcomes);
//     TrialDashboard.loadData(appState.allTrialOutcomes);

//     console.log( "td" , appState.allTrialOutcomes)
//     a =  appState.allTrialOutcomes
//     TrialDashboard.loadData(a);
    
//     // Now that we have all the data, create the visualizations
//     // createAggregateVisualizations();
// }



// Function to create all visualizations from the collected data

// function collectAllTrialOutcomes() {
//     console.log("Collecting all trial outcomes data...");
//     appState.allTrialOutcomes = [];
    
//     // Ensure studies property exists and has valid data
//     if (!appState.studies || !Array.isArray(appState.studies) || appState.studies.length === 0) {
//         console.log("No studies to collect outcomes from");
//         return;
//     }
    
//     // Get all studies with results
//     const studiesWithResults = appState.studies.filter(study => study && study.hasResults);
//     console.log(`Found ${studiesWithResults.length} studies with results`);
    
//     // For each study, collect the outcome measures
//     studiesWithResults.forEach(study => {
//         // First make sure the basic study properties exist
//         if (!study || !study.protocolSection || !study.protocolSection.identificationModule) {
//             console.warn("Study missing required properties - skipping");
//             return;
//         }
        
//         const nctId = study.protocolSection.identificationModule.nctId;
//         if (!nctId) {
//             console.warn("Study missing NCT ID - skipping");
//             return;
//         }
        
//         // Check if we have study details with outcome data
//         if (!appState.studyDetails || !appState.studyDetails[nctId]) {
//             console.warn(`No study details found for ${nctId} - skipping`);
//             return;
//         }
        
//         const studyDetails = appState.studyDetails[nctId];
        
//         // Make sure we have valid outcome measures data
//         if (!studyDetails.resultsSection || 
//             !studyDetails.resultsSection.outcomeMeasuresModule || 
//             !studyDetails.resultsSection.outcomeMeasuresModule.outcomeMeasures) {
//             console.warn(`No outcome measures found for study ${nctId}`);
//             return;
//         }
        
//         const phase = study.protocolSection?.designModule?.phases?.[0] || 'N/A';
//         const studyTitle = study.protocolSection?.identificationModule?.briefTitle || 'Untitled Study';
//         const outcomes = studyDetails.resultsSection.outcomeMeasuresModule.outcomeMeasures;
        
//         console.log(`Processing ${outcomes.length} outcomes for study ${nctId} (${studyTitle})`);
        
//         // Store basic study info
//         const studyInfo = {
//             nctId,
//             title: studyTitle,
//             phase,
//             sponsor: study.protocolSection?.identificationModule?.organization?.fullName || 'Unknown',
//             status: study.protocolSection?.statusModule?.overallStatus || 'Unknown',
//             outcomes: []
//         };
        
//         // Process each outcome measure
//         outcomes.forEach(outcome => {
//             // Make sure outcome has classes with categories
//             if (!outcome.classes || !outcome.classes[0] || !outcome.classes[0].categories) {
//                 console.warn(`Skipping outcome with no categories: ${outcome.title || 'unknown'}`);
//                 return;
//             }
            
//             const outcomeType = outcome.type?.toLowerCase() || 'other';
//             const outcomeTitle = outcome.title || 'Unknown Outcome';
//             const timeFrame = outcome.timeFrame || 'Not specified';
            
//             // Process each measurement class and category
//             outcome.classes.forEach(cls => {
//                 if (!cls.categories || !Array.isArray(cls.categories)) {
//                     console.warn(`Invalid categories in outcome class for ${nctId} - skipping`);
//                     return;
//                 }
                
//                 cls.categories.forEach(cat => {
//                     if (!cat.measurements || !Array.isArray(cat.measurements)) {
//                         console.warn(`Invalid measurements in category for ${nctId} - skipping`);
//                         return;
//                     }
                    
//                     const categoryData = {
//                         title: cat.title || '',
//                         measurements: []
//                     };
                    
//                     // Extract all measurements
//                     cat.measurements.forEach(measurement => {
//                         // Validate measurement data
//                         if (!measurement || !measurement.value || !measurement.groupId) {
//                             return;
//                         }
                        
//                         // Try to parse the value
//                         const value = parseFloat(measurement.value);
//                         if (isNaN(value)) return;
                        
//                         // Validate that the group exists
//                         if (!outcome.groups || !Array.isArray(outcome.groups)) {
//                             return;
//                         }
                        
//                         const group = outcome.groups.find(g => g.id === measurement.groupId);
//                         if (!group) return;
                        
//                         const groupTitle = group.title || 'Unknown Group';
//                         const isControlGroup = 
//                             groupTitle.toLowerCase().includes('placebo') || 
//                             groupTitle.toLowerCase().includes('control') ||
//                             groupTitle.toLowerCase().includes('sham');
                        
//                         // Calculate standard error or other statistics if available
//                         let standardError = null;
//                         let dispersion = null;
//                         let dispersionType = null;
                        
//                         if (measurement.dispersion && measurement.dispersion !== 'null') {
//                             dispersion = parseFloat(measurement.dispersion);
//                             dispersionType = measurement.dispersionType?.toLowerCase() || '';
                            
//                             if (!isNaN(dispersion)) {
//                                 if (dispersionType === 'standard_error') {
//                                     standardError = dispersion;
//                                 } else if (dispersionType === 'standard_deviation') {
//                                     // Convert SD to SE if sample size is available
//                                     const sampleSize = group.participantsAnalyzedList?.[0]?.count;
//                                     if (sampleSize && !isNaN(sampleSize) && sampleSize > 0) {
//                                         standardError = dispersion / Math.sqrt(sampleSize);
//                                     }
//                                 }
//                             }
//                         }
                        
//                         // Add measurement data
//                         categoryData.measurements.push({
//                             value,
//                             groupId: measurement.groupId,
//                             groupTitle,
//                             isControlGroup,
//                             sampleSize: group.participantsAnalyzedList?.[0]?.count || 0,
//                             standardError,
//                             dispersion,
//                             dispersionType
//                         });
//                     });
                    
//                     // Only add categories with measurements
//                     if (categoryData.measurements.length > 0) {
//                         // Calculate effect size if we have both experimental and control groups
//                         const experimentalMeasurements = categoryData.measurements.filter(m => !m.isControlGroup);
//                         const controlMeasurements = categoryData.measurements.filter(m => m.isControlGroup);
                        
//                         let effectSize = null;
//                         let experimentalValue = null;
//                         let controlValue = null;
//                         let experimentalSampleSize = 0;
//                         let controlSampleSize = 0;
                        
//                         if (experimentalMeasurements.length > 0) {
//                             // Calculate weighted average for experimental group
//                             const expTotal = experimentalMeasurements.reduce((sum, m) => sum + (m.value * m.sampleSize), 0);
//                             experimentalSampleSize = experimentalMeasurements.reduce((sum, m) => sum + m.sampleSize, 0);
//                             experimentalValue = experimentalSampleSize > 0 ? expTotal / experimentalSampleSize : null;
//                         }
                        
//                         if (controlMeasurements.length > 0) {
//                             // Calculate weighted average for control group
//                             const ctrlTotal = controlMeasurements.reduce((sum, m) => sum + (m.value * m.sampleSize), 0);
//                             controlSampleSize = controlMeasurements.reduce((sum, m) => sum + m.sampleSize, 0);
//                             controlValue = controlSampleSize > 0 ? ctrlTotal / controlSampleSize : null;
//                         }
                        
//                         // Calculate effect size if both values exist
//                         if (experimentalValue !== null && controlValue !== null) {
//                             // Standardize the effect based on outcome metric
//                             try {
//                                 effectSize = standardizeOutcomeValue(experimentalValue - controlValue, outcomeTitle);
//                             } catch (error) {
//                                 console.warn(`Error calculating effect size for ${nctId}:`, error);
//                                 effectSize = experimentalValue - controlValue; // Fallback to raw difference
//                             }
//                         }
                        
//                         // Add the processed outcome data
//                         studyInfo.outcomes.push({
//                             title: outcomeTitle,
//                             type: outcomeType,
//                             timeFrame,
//                             category: categoryData.title,
//                             measurements: categoryData.measurements,
//                             experimentalValue,
//                             controlValue,
//                             effectSize,
//                             experimentalSampleSize,
//                             controlSampleSize
//                         });
//                     }
//                 });
//             });
//         });
        
//         // Add this study's info to the collection if it has outcomes
//         if (studyInfo.outcomes.length > 0) {
//             appState.allTrialOutcomes.push(studyInfo);
//         }
//     });
    
//     console.log(`Collected outcome data from ${appState.allTrialOutcomes.length} studies`);
//     console.log("All outcomes data:", appState.allTrialOutcomes);
    
//     // Try to initialize the TrialDashboard if it exists
//     if (typeof TrialDashboard !== 'undefined' && appState.allTrialOutcomes) {
//         try {
//             console.log("Loading data into TrialDashboard");
//             TrialDashboard.loadData(appState.allTrialOutcomes);
//         } catch (error) {
//             console.error("Error loading data into TrialDashboard:", error);
//         }
//     }
    
//     // Now that we have all the data, create the visualizations
//     try {
//         createAggregateVisualizations();
//     } catch (error) {
//         console.error("Error creating aggregate visualizations:", error);
//     }
// }

function collectAllTrialOutcomes(){
    return
}

// Fallback function for standardizeOutcomeValue in case it's not defined
function standardizeOutcomeValue(value, outcomeTitle) {
    if (typeof window.standardizeOutcomeValue === 'function') {
        return window.standardizeOutcomeValue(value, outcomeTitle);
    }
    
    // Simple fallback - higher positive values are better unless the title suggests otherwise
    const lowerIsBetter = 
        outcomeTitle.toLowerCase().includes('score') || 
        outcomeTitle.toLowerCase().includes('scale') ||
        outcomeTitle.toLowerCase().includes('severity') ||
        outcomeTitle.toLowerCase().includes('pain') ||
        outcomeTitle.toLowerCase().includes('depression') ||
        outcomeTitle.toLowerCase().includes('anxiety') ||
        outcomeTitle.toLowerCase().includes('symptom');
    
    return lowerIsBetter ? -value : value;
}


function createAggregateVisualizations() {
    // Skip if we don't have data
    if (appState.allTrialOutcomes.length === 0) {
        console.warn("No trial outcome data available for visualization");
        return;
    }
    
    // Extract all outcome metrics for the selector
    const outcomeMetrics = new Set();
    appState.allTrialOutcomes.forEach(study => {
        study.outcomes.forEach(outcome => {
            outcomeMetrics.add(outcome.title);
        });
    });
    
    // Update the metrics array and selector
    appState.outcomeMetrics = Array.from(outcomeMetrics);
    
    if (appState.outcomeMetrics.length > 0) {
        // Set default metric if not already set
        if (!appState.currentOutcomeMetric || !appState.outcomeMetrics.includes(appState.currentOutcomeMetric)) {
            appState.currentOutcomeMetric = appState.outcomeMetrics[0];
        }
        
        // Populate the selector
        populateOutcomeMetricSelector();
        
        // Show the collated outcomes section
        // showSection(elements.collatedOutcomesSection, true);
        
        // Create the visualizations
        // displayCollatedOutcomes();
    }
}

// Modified function to handle missing chart elements more gracefully
function createOverallTreatmentEffectChart(outcomes) {
    const canvasId = 'overallTreatmentEffectChart';
    const canvas = document.getElementById(canvasId);
    
    if (!canvas) {
        console.warn(`Canvas not found: ${canvasId}`);
        // Try to create the canvas if its container exists
        const container = document.querySelector('#collatedOutcomesSection .h-72');
        if (container) {
            container.innerHTML = `<canvas id="${canvasId}"></canvas>`;
            console.log(`Created canvas: ${canvasId}`);
            // Try again with the new canvas
            const newCanvas = document.getElementById(canvasId);
            if (!newCanvas) {
                console.error(`Failed to create canvas: ${canvasId}`);
                return;
            }
            createOverallTreatmentEffectChart(outcomes);
            return;
        }
        return;
    }
    
    const ctx = canvas.getContext('2d');
    
    // Clear previous chart
    if (charts.overallTreatmentEffect) {
        charts.overallTreatmentEffect.destroy();
    }
    
    // Filter only outcomes with effect sizes
    const validOutcomes = outcomes.filter(o => o.effectSize !== null);
    
    if (validOutcomes.length === 0) {
        canvas.parentElement.innerHTML = '<p class="text-center text-gray-500 py-8">No treatment effect data available for the selected metric.</p>';
        return;
    }
    
    // Calculate mean and standard deviation of effect sizes
    const effectSizes = validOutcomes.map(o => o.effectSize);
    const mean = calculateMean(effectSizes);
    const stdDev = calculateStandardDeviation(effectSizes, mean);
    
    // Generate normal distribution data
    const bellCurveData = generateNormalDistribution(mean, stdDev);
    
    // Generate scatter plot data for individual studies
    const scatterData = validOutcomes.map(o => ({
        x: o.effectSize,
        y: 0.05, // Small fixed value for visibility
        nctId: o.nctId,
        title: o.title,
        phase: o.phase
    }));
    
    // Create the chart
    charts.overallTreatmentEffect = new Chart(ctx, {
        type: 'line',
        data: {
            datasets: [
                {
                    type: 'line',
                    label: 'Overall Distribution',
                    data: bellCurveData,
                    borderColor: '#8b5cf6', // Violet
                    backgroundColor: 'rgba(139, 92, 246, 0.2)', // Transparent violet
                    fill: true,
                    tension: 0.4,
                    pointRadius: 0
                },
                {
                    type: 'scatter',
                    label: 'Individual Studies',
                    data: scatterData,
                    backgroundColor: ctx => {
                        // Color points by phase
                        const phase = scatterData[ctx.dataIndex]?.phase;
                        return getPhaseColor(phase);
                    },
                    pointRadius: 6,
                    pointHoverRadius: 8
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    type: 'linear',
                    title: {
                        display: true,
                        text: 'Effect Size'
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Probability Density'
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'top',
                },
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            const dataIndex = context[0].dataIndex;
                            const datasetIndex = context[0].datasetIndex;
                            
                            if (datasetIndex === 1) { // Scatter plot
                                return scatterData[dataIndex].title || 'Study';
                            }
                            return 'Effect Size Distribution';
                        },
                        label: function(context) {
                            const dataIndex = context.dataIndex;
                            const datasetIndex = context.datasetIndex;
                            
                            if (datasetIndex === 1) { // Scatter plot
                                return [
                                    `NCT ID: ${scatterData[dataIndex].nctId || 'Unknown'}`,
                                    `Phase: ${formatPhase(scatterData[dataIndex].phase)}`,
                                    `Effect Size: ${scatterData[dataIndex].x.toFixed(2)}`
                                ];
                            }
                            return `Value: ${context.parsed.x.toFixed(2)}`;
                        }
                    }
                }
            }
        }
    });
}
        // function createOutcomeCharts(study) {
        //     const nctId = study.protocolSection?.identificationModule?.nctId;
        //     const outcomes = study.resultsSection?.outcomeMeasuresModule?.outcomeMeasures || [];
        //     const primaryOutcomes = outcomes.filter(outcome => outcome.type === "PRIMARY");
        //     const secondaryOutcomes = outcomes.filter(outcome => outcome.type === "SECONDARY");
            
        //     // Clean up any existing chart instances
        //     Object.keys(charts.studySpecific).forEach(chartId => {
        //         if (chartId.includes(nctId)) {
        //             if (charts.studySpecific[chartId]) {
        //                 charts.studySpecific[chartId].destroy();
        //                 delete charts.studySpecific[chartId];
        //             }
        //         }
        //     });
            
        //     // Create charts for primary outcomes
        //     primaryOutcomes.forEach((outcome, idx) => {
        //         createSingleOutcomeChart(nctId, outcome, idx, false);
        //     });
            
        //     // Create charts for secondary outcomes
        //     secondaryOutcomes.forEach((outcome, idx) => {
        //         createSingleOutcomeChart(nctId, outcome, idx, true);
        //     });
        // }
        
   /**
 * Enhanced Clinical Trial Outcome Visualization
 * This utility creates dynamic visualizations for clinical trial outcome data,
 * handling various data structures and presentation formats.
 */

// Function to create outcome charts based on study data
function createOutcomeCharts(study) {
    const outcomes = study.resultsSection?.outcomeMeasuresModule?.outcomeMeasures || [];
    const nctId = study.protocolSection?.identificationModule?.nctId || 'unknown';
    
    if (!outcomes.length) {
        console.log('No outcome measures available for visualization');
        return;
    }
    
    // Create charts for primary outcomes
    const primaryOutcomes = outcomes.filter(outcome => outcome.type === 'PRIMARY');
    primaryOutcomes.forEach((outcome, idx) => {
        const canvasId = `outcome_${nctId}_${idx}`;
        const canvas = document.getElementById(canvasId);
        
        if (!canvas) {
            console.warn(`Canvas element not found for ${canvasId}`);
            return;
        }
        
        createOutcomeVisualization(outcome, canvas);
    });
    
    // Create charts for secondary outcomes
    const secondaryOutcomes = outcomes.filter(outcome => outcome.type === 'SECONDARY');
    secondaryOutcomes.forEach((outcome, idx) => {
        const canvasId = `outcome_secondary_${nctId}_${idx}`;
        const canvas = document.getElementById(canvasId);
        
        if (!canvas) {
            console.warn(`Canvas element not found for ${canvasId}`);
            return;
        }
        
        createOutcomeVisualization(outcome, canvas);
    });
}

// Main function to create appropriate outcome visualization based on data type
function createOutcomeVisualization(outcome, canvas) {
    // Check if outcome has required data
    if (!outcome || !canvas) return;
    
    // Extract relevant data
    const title = outcome.title || 'Outcome Measure';
    const timeFrame = outcome.timeFrame || 'Not specified';
    const paramType = outcome.paramType || '';
    const groups = outcome.groups || [];
    const classes = outcome.classes || [];
    
    // Create container div for enhanced UI
    const container = document.createElement('div');
    container.className = 'outcome-chart-container relative';
    container.style.width = '100%';
    container.style.height = '100%';
    canvas.parentNode.insertBefore(container, canvas);
    container.appendChild(canvas);
    
    // Add full screen button
    const fullScreenBtn = document.createElement('button');
    fullScreenBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M1.5 1a.5.5 0 0 0-.5.5v4a.5.5 0 0 1-1 0v-4A1.5 1.5 0 0 1 1.5 0h4a.5.5 0 0 1 0 1h-4zM10 .5a.5.5 0 0 1 .5-.5h4A1.5 1.5 0 0 1 16 1.5v4a.5.5 0 0 1-1 0v-4a.5.5 0 0 0-.5-.5h-4a.5.5 0 0 1-.5-.5zM.5 10a.5.5 0 0 1 .5.5v4a.5.5 0 0 0 .5.5h4a.5.5 0 0 1 0 1h-4A1.5 1.5 0 0 1 0 14.5v-4a.5.5 0 0 1 .5-.5zm15 0a.5.5 0 0 1 .5.5v4a1.5 1.5 0 0 1-1.5 1.5h-4a.5.5 0 0 1 0-1h4a.5.5 0 0 0 .5-.5v-4a.5.5 0 0 1 .5-.5z"/></svg>';
    fullScreenBtn.className = 'absolute top-2 right-2 bg-white p-1 rounded-md shadow hover:bg-gray-100 z-10';
    fullScreenBtn.title = 'Full Screen';
    container.appendChild(fullScreenBtn);
    
    // Add interpretation container
    const interpretationContainer = document.createElement('div');
    interpretationContainer.className = 'outcome-interpretation mt-3 p-2 bg-gray-50 rounded text-sm hidden';
    container.appendChild(interpretationContainer);
    
    // Attempt to detect outcome data structure and create appropriate visualization
    if (hasDistributionData(outcome)) {
        createDistributionChart(outcome, canvas, interpretationContainer);
    } else if (hasCategoricalData(outcome)) {
        createCategoricalChart(outcome, canvas, interpretationContainer);
    } else if (hasTimePointData(outcome)) {
        createTimeSeriesChart(outcome, canvas, interpretationContainer);
    } else {
        // Fallback to simple bar chart if no specific structure detected
        createSimpleBarChart(outcome, canvas, interpretationContainer);
    }
    
    // Set up full screen functionality
    fullScreenBtn.addEventListener('click', () => {
        toggleFullScreen(container);
        
        // Show interpretation when in full screen
        interpretationContainer.classList.toggle('hidden');
    });
}

// Helper function to toggle full screen for chart
function toggleFullScreen(container) {
    if (!document.fullscreenElement) {
        // Create modal for fullscreen view
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-gray-900 bg-opacity-90 flex items-center justify-center z-50';
        
        const modalContent = document.createElement('div');
        modalContent.className = 'bg-white rounded-lg p-4 max-w-4xl w-full max-h-90vh overflow-auto';
        
        const closeBtn = document.createElement('button');
        closeBtn.className = 'absolute top-4 right-4 text-white hover:text-gray-200';
        closeBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/></svg>';
        
        modal.appendChild(closeBtn);
        modal.appendChild(modalContent);
        
        // Clone the container content for the modal
        const clone = container.cloneNode(true);
        clone.style.height = '500px';
        clone.querySelector('.outcome-interpretation').classList.remove('hidden');
        
        modalContent.appendChild(clone);
        document.body.appendChild(modal);
        
        // Set up chart recreation in modal
        const originalCanvas = container.querySelector('canvas');
        const clonedCanvas = clone.querySelector('canvas');
        
        // Transfer chart to cloned canvas
        if (originalCanvas._chart) {
            const config = originalCanvas._chart.config;
            new Chart(clonedCanvas, config);
        }
        
        // Close modal on button click
        closeBtn.addEventListener('click', () => {
            document.body.removeChild(modal);
        });
    }
}

// Check if outcome has distribution-like data suitable for bell curve
function hasDistributionData(outcome) {
    if (!outcome.groups || !outcome.classes) return false;
    
    // Check for mean and standard deviation/error in measurements
    let hasMeanAndVariance = false;
    
    // Look for paramType indicating mean/average
    const isMeanParam = outcome.paramType === 'MEAN' || 
                       outcome.paramType === 'LEAST_SQUARES_MEAN' || 
                       outcome.paramType === 'GEOMETRIC_MEAN';
    
    // Look for dispersion type indicating variance
    const hasVariance = outcome.dispersionType === 'Standard Deviation' || 
                       outcome.dispersionType === 'Standard Error' || 
                       outcome.dispersionType === 'STANDARD_DEVIATION' || 
                       outcome.dispersionType === 'STANDARD_ERROR';
    
    // If class measurements have spread/dispersion values
    if (outcome.classes && outcome.classes.length > 0) {
        for (const cls of outcome.classes) {
            if (cls.categories && cls.categories.length > 0) {
                for (const cat of cls.categories) {
                    if (cat.measurements && cat.measurements.length > 0) {
                        for (const measurement of cat.measurements) {
                            if (measurement.value && (measurement.spread || measurement.dispersion)) {
                                hasMeanAndVariance = true;
                                break;
                            }
                        }
                    }
                }
            }
        }
    }
    
    return (isMeanParam && hasVariance) || hasMeanAndVariance;
}

// Check if outcome has categorical data
function hasCategoricalData(outcome) {
    if (!outcome.classes || outcome.classes.length === 0) return false;
    
    // Check for multiple categories or single category with multiple measurements
    for (const cls of outcome.classes) {
        if (cls.categories && cls.categories.length > 1) {
            return true;
        } else if (cls.categories && cls.categories.length === 1) {
            const cat = cls.categories[0];
            if (cat.measurements && cat.measurements.length > 1) {
                return true;
            }
        }
    }
    
    return false;
}

// Check if outcome has time-based data points
function hasTimePointData(outcome) {
    if (!outcome.classes || outcome.classes.length === 0) return false;
    
    // Check for class titles that indicate time points
    const timeRegex = /^(baseline|week|month|day|hour|minute|year|follow.?up|visit)/i;
    
    for (const cls of outcome.classes) {
        if (cls.title && timeRegex.test(cls.title)) {
            return true;
        }
    }
    
    return false;
}

// Create bell curve distribution chart (similar to your example image)
function createDistributionChart(outcome, canvas, interpretationContainer) {
    const groups = outcome.groups || [];
    const colors = ['#3B82F6', '#10B981', '#F05252', '#8B5CF6', '#F59E0B', '#EC4899'];
    
    if (!groups.length) return;
    
    // Extract means and standard deviations for each group
    const distributionData = [];
    
    // Determine which outcome classes to use
    let classesToUse = outcome.classes;
    if (outcome.classes.length > 1) {
        // For multiple classes, try to find the most relevant ones (like final timepoint)
        const finalTimepoint = outcome.classes.find(c => 
            (c.title && /final|end|last|completion/i.test(c.title)) || 
            outcome.classes[outcome.classes.length - 1]
        );
        
        if (finalTimepoint) {
            classesToUse = [finalTimepoint];
        }
    }
    
    // Extract measurement data
    classesToUse.forEach(cls => {
        if (cls.categories && cls.categories.length > 0) {
            cls.categories.forEach(cat => {
                if (cat.measurements && cat.measurements.length > 0) {
                    cat.measurements.forEach(measurement => {
                        const groupId = measurement.groupId;
                        const group = groups.find(g => g.id === groupId);
                        if (!group) return;
                        
                        const value = parseFloat(measurement.value);
                        
                        // Get standard deviation or error
                        let spreadValue = 0;
                        if (measurement.spread) {
                            spreadValue = parseFloat(measurement.spread);
                        } else if (measurement.dispersion) {
                            spreadValue = parseFloat(measurement.dispersion);
                        }
                        
                        if (!isNaN(value) && !isNaN(spreadValue)) {
                            distributionData.push({
                                group: group.title,
                                mean: value,
                                stdDev: spreadValue,
                                isError: outcome.dispersionType === 'Standard Error' || 
                                         outcome.dispersionType === 'STANDARD_ERROR'
                            });
                        }
                    });
                }
            });
        }
    });
    
    // If we have analysis data with p-values, add that information
    let pValueInfo = "";
    if (outcome.analyses && outcome.analyses.length > 0) {
        const analysis = outcome.analyses[0];
        if (analysis.pValue) {
            pValueInfo = `<p class="font-semibold mt-2">Statistical Analysis:</p>
                         <p>p-value: ${analysis.pValue}</p>`;
            
            if (analysis.statisticalMethod) {
                pValueInfo += `<p>Method: ${analysis.statisticalMethod}</p>`;
            }
            
            if (analysis.ciLowerLimit && analysis.ciUpperLimit) {
                pValueInfo += `<p>${analysis.ciPctValue || 95}% CI: [${analysis.ciLowerLimit}, ${analysis.ciUpperLimit}]</p>`;
            }
        }
    }
    
    // Generate bell curve data for visualization
    const chartData = {
        datasets: distributionData.map((data, index) => {
            const color = colors[index % colors.length];
            const points = 100;
            
            // For standard error, convert to standard deviation
            let stdDev = data.stdDev;
            if (data.isError && outcome.denoms) {
                // Try to find sample size to convert SE to SD
                const groupDenom = outcome.denoms[0]?.counts.find(c => 
                    groups.find(g => g.id === c.groupId)?.title === data.group
                );
                
                if (groupDenom) {
                    const n = parseInt(groupDenom.value);
                    if (!isNaN(n) && n > 0) {
                        stdDev = data.stdDev * Math.sqrt(n);
                    }
                }
            }
            
            // Generate normal distribution curve points
            const distributionPoints = generateNormalDistribution(data.mean, stdDev, points);
            
            return {
                label: `${data.group} (μ=${data.mean.toFixed(1)}, σ=${stdDev.toFixed(1)})`,
                data: distributionPoints,
                borderColor: color,
                backgroundColor: color + '20', // Add transparency
                borderWidth: 2,
                pointRadius: 0,
                fill: true,
                tension: 0.4
            };
        })
    };
    
    // Set up chart configuration
    const config = {
        type: 'line',
        data: chartData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: sanitizeTitle(outcome.title),
                    font: {
                        size: 14,
                        weight: 'bold'
                    }
                },
                subtitle: {
                    display: true,
                    text: `Time Frame: ${outcome.timeFrame || 'Not specified'}`,
                    font: {
                        size: 12,
                        style: 'italic'
                    }
                },
                tooltip: {
                    mode: 'index',
                    intersect: false
                },
                legend: {
                    position: 'top'
                }
            },
            scales: {
                x: {
                    type: 'linear',
                    title: {
                        display: true,
                        text: `${outcome.title} (${outcome.unitOfMeasure || 'Value'})`,
                        font: {
                            weight: 'bold'
                        }
                    },
                    grid: {
                        display: true,
                        drawBorder: true
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Probability Density',
                        font: {
                            weight: 'bold'
                        }
                    },
                    beginAtZero: true
                }
            }
        }
    };
    
    // Add indicator lines for means
    const meanLines = distributionData.map((data, index) => {
        return {
            type: 'line',
            id: `mean-line-${index}`,
            mode: 'vertical',
            scaleID: 'x',
            value: data.mean,
            borderColor: colors[index % colors.length],
            borderWidth: 2,
            borderDash: [6, 4],
            label: {
                enabled: true,
                content: `μ=${data.mean.toFixed(1)}`,
                position: 'top'
            }
        };
    });
    
    config.options.plugins.annotation = {
        annotations: meanLines
    };
    
    // Add interpretation
    updateInterpretation(interpretationContainer, outcome, distributionData, pValueInfo);
    
    // Create the chart
    const chart = new Chart(canvas, config);
    canvas._chart = chart;
}

// Create categorical chart for outcome data
function createCategoricalChart(outcome, canvas, interpretationContainer) {
    const groups = outcome.groups || [];
    const colors = ['#3B82F6', '#10B981', '#F05252', '#8B5CF6', '#F59E0B', '#EC4899'];
    
    if (!groups.length) return;
    
    // Extract category data
    const categories = [];
    const groupValues = {};
    
    // Initialize group values
    groups.forEach(group => {
        groupValues[group.id] = {};
    });
    
    // Process all classes and categories
    outcome.classes.forEach(cls => {
        if (cls.categories && cls.categories.length > 0) {
            cls.categories.forEach(cat => {
                const categoryName = cat.title || 'Category';
                if (!categories.includes(categoryName)) {
                    categories.push(categoryName);
                }
                
                if (cat.measurements && cat.measurements.length > 0) {
                    cat.measurements.forEach(measurement => {
                        const value = parseFloat(measurement.value);
                        if (!isNaN(value)) {
                            groupValues[measurement.groupId][categoryName] = value;
                        }
                    });
                }
            });
        }
    });
    
    // Prepare data for Chart.js
    const datasets = groups.map((group, index) => {
        const color = colors[index % colors.length];
        return {
            label: group.title,
            data: categories.map(cat => groupValues[group.id][cat] || 0),
            backgroundColor: color,
            borderColor: color,
            borderWidth: 1
        };
    });
    
    // Set up chart configuration
    const config = {
        type: 'bar',
        data: {
            labels: categories,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: sanitizeTitle(outcome.title),
                    font: {
                        size: 14,
                        weight: 'bold'
                    }
                },
                subtitle: {
                    display: true,
                    text: `Time Frame: ${outcome.timeFrame || 'Not specified'}`,
                    font: {
                        size: 12,
                        style: 'italic'
                    }
                },
                tooltip: {
                    mode: 'index',
                    intersect: false
                },
                legend: {
                    position: 'top'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: outcome.unitOfMeasure || 'Value',
                        font: {
                            weight: 'bold'
                        }
                    }
                }
            }
        }
    };
    
    // Add interpretation
    updateCategoricalInterpretation(interpretationContainer, outcome, groups, categories, groupValues);
    
    // Create the chart
    const chart = new Chart(canvas, config);
    canvas._chart = chart;
}

// Create time series chart for longitudinal data
function createTimeSeriesChart(outcome, canvas, interpretationContainer) {
    const groups = outcome.groups || [];
    const colors = ['#3B82F6', '#10B981', '#F05252', '#8B5CF6', '#F59E0B', '#EC4899'];
    
    if (!groups.length) return;
    
    // Extract time points and values
    const timePoints = [];
    const groupValues = {};
    
    // Initialize group values
    groups.forEach(group => {
        groupValues[group.id] = {};
    });
    
    // Process classes as time points
    outcome.classes.forEach(cls => {
        const timePoint = cls.title || 'Time Point';
        if (!timePoints.includes(timePoint)) {
            timePoints.push(timePoint);
        }
        
        if (cls.categories && cls.categories.length > 0) {
            cls.categories.forEach(cat => {
                if (cat.measurements && cat.measurements.length > 0) {
                    cat.measurements.forEach(measurement => {
                        const value = parseFloat(measurement.value);
                        if (!isNaN(value)) {
                            groupValues[measurement.groupId][timePoint] = value;
                        }
                    });
                }
            });
        }
    });
    
    // Sort time points chronologically if possible
    const timeOrder = {
        'baseline': 0,
        'screening': 1
    };
    
    timePoints.sort((a, b) => {
        // Check for special time points first
        if (a.toLowerCase() in timeOrder && b.toLowerCase() in timeOrder) {
            return timeOrder[a.toLowerCase()] - timeOrder[b.toLowerCase()];
        } else if (a.toLowerCase() in timeOrder) {
            return -1;
        } else if (b.toLowerCase() in timeOrder) {
            return 1;
        }
        
        // Try to extract numeric values for comparison
        const aMatch = a.match(/(\d+)\s*(day|week|month|year|hr|min|hour|minute|second)/i);
        const bMatch = b.match(/(\d+)\s*(day|week|month|year|hr|min|hour|minute|second)/i);
        
        if (aMatch && bMatch) {
            const aValue = parseInt(aMatch[1]);
            const bValue = parseInt(bMatch[1]);
            
            if (!isNaN(aValue) && !isNaN(bValue)) {
                if (aMatch[2].toLowerCase() === bMatch[2].toLowerCase()) {
                    return aValue - bValue;
                }
            }
        }
        
        // Default alphabetical sort
        return a.localeCompare(b);
    });
    
    // Prepare data for Chart.js
    const datasets = groups.map((group, index) => {
        const color = colors[index % colors.length];
        return {
            label: group.title,
            data: timePoints.map(time => groupValues[group.id][time] || null),
            borderColor: color,
            backgroundColor: color + '20',
            tension: 0.3,
            fill: false
        };
    });
    
    // Set up chart configuration
    const config = {
        type: 'line',
        data: {
            labels: timePoints,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: sanitizeTitle(outcome.title),
                    font: {
                        size: 14,
                        weight: 'bold'
                    }
                },
                subtitle: {
                    display: true,
                    text: `Time Frame: ${outcome.timeFrame || 'Not specified'}`,
                    font: {
                        size: 12,
                        style: 'italic'
                    }
                },
                tooltip: {
                    mode: 'index',
                    intersect: false
                },
                legend: {
                    position: 'top'
                }
            },
            scales: {
                y: {
                    title: {
                        display: true,
                        text: outcome.unitOfMeasure || 'Value',
                        font: {
                            weight: 'bold'
                        }
                    }
                }
            }
        }
    };
    
    // Add interpretation
    updateTimeSeriesInterpretation(interpretationContainer, outcome, groups, timePoints, groupValues);
    
    // Create the chart
    const chart = new Chart(canvas, config);
    canvas._chart = chart;
}

// Simple fallback bar chart for any outcome data
// function createSimpleBarChart(outcome, canvas, interpretationContainer) {
//     const groups = outcome.groups || [];
//     const colors = ['#3B82F6', '#10B981', '#F05252', '#8B5CF6', '#F59E0B', '#EC4899'];
    
//     if (!groups.length) return;
    
//     // Get values for each group
//     const groupData = [];
    
//     // Try to find values from any structure
//     if (outcome.classes && outcome.classes.length > 0) {
//         for (const cls of outcome.classes) {
//             if (cls.categories && cls.categories.length > 0) {
//                 for (const cat of cls.categories) {
//                     if (cat.measurements && cat.measurements.length > 0) {
//                         for (const measurement of cat.measurements) {
//                             const value = parseFloat(measurement.value);
//                             if (!isNaN(value)) {
//                                 const group = groups.find(g => g.id === measurement.groupId);
//                                 if (group) {
//                                     groupData.push({
//                                         group: group.title,
//                                         value: value
//                                     });
//                                 }
//                             }
//                         }
//                     }
//                 }
//             }
//         }
//     }
    
//     // Set up chart configuration
//     const config = {
//         type: 'bar',
//         data: {
//             labels: groupData.map(d => d.group),
//             datasets: [{
//                 label: outcome.title,
//                 data: groupData.map(d => d.value),
//                 backgroundColor: groupData.map((_, i) => colors[i % colors.length]),
//                 borderColor: groupData.map((_, i) => colors[i % colors.length]),
//                 borderWidth: 1
//             }]
//         },
//         options: {
//             responsive: true,
//             maintainAspectRatio: false,
//             plugins: {
//                 title: {
//                     display: true,
//                     text: sanitizeTitle(outcome.title),
//                     font: {
//                         size: 14,
//                         weight: 'bold'
//                     }
//                 },
//                 subtitle: {
//                     display: true,
//                     text: `Time Frame: ${outcome.timeFrame || 'Not specified'}`,
//                     font: {
//                         size: 12,
//                         style: 'italic'
//                     }
//                 },
//                 legend: {
//                     display: false
//                 }
//             },
//             scales: {
//                 y: {
//                     beginAtZero: true,
//                     title: {
//                         display: true,
//                         text: outcome.unitOfMeasure || 'Value',
//                         font: {
//                             weight: 'bold'
//                         }
//                     }
//                 }
//             }
//         }
//     };
    
//     // Add interpretation
//     const message = `<p class="font-semibold">Outcome Summary:</p>
//                     <p>${outcome.title}</p>
//                     <p class="text-xs text-gray-500 mt-1">${outcome.description || ''}</p>
//                     <ul class="mt-2">
//                         ${groupData.map(d => `<li>${d.group}: ${d.value} ${outcome.unitOfMeasure || ''}</li>`).join('')}
//                     </ul>`;
    
//     interpretationContainer.innerHTML = message;
    
//     // Create the chart
//     const chart = new Chart(canvas, config);
//     canvas._chart = chart;
// }   
      
      
        function createSingleOutcomeChart(nctId, outcome, idx, isSecondary) {
            const prefix = isSecondary ? 'outcome_secondary_' : 'outcome_';
            const canvasId = `${prefix}${nctId}_${idx}`;
            const canvas = document.getElementById(canvasId);
            
            if (!canvas) {
                console.warn(`Canvas not found for ${canvasId}`);
                return;
            }
            
            // Check if outcome has classes and measurements
            if (!outcome.classes || !outcome.classes[0] || !outcome.classes[0].categories) {
                console.warn(`No valid measurements for ${outcome.title}`);
                return;
            }
            
            const measurements = [];
            outcome.classes.forEach(cls => {
                cls.categories.forEach(cat => {
                    cat.measurements.forEach(measurement => {
                        if (measurement && measurement.value !== undefined && measurement.groupId) {
                            const group = outcome.groups.find(g => g.id === measurement.groupId);
                            if (group) {
                                // Use parseFloat but provide a default for empty values
                                const value = measurement.value === '' ? null : parseFloat(measurement.value);
                                let dispersion = null;
                                let dispersionType = null;
                                let spread = null;
                                
                                // Extract dispersion information if available
                                if (measurement.dispersion !== undefined && measurement.dispersion !== '') {
                                    dispersion = parseFloat(measurement.dispersion);
                                    dispersionType = measurement.dispersionType;
                                }
                                
                                // Calculate spread (standard deviation) if needed
                                if (dispersionType === 'standard_error') {
                                    const sampleSize = group.participantsAnalyzedList?.[0]?.count;
                                    if (sampleSize && !isNaN(sampleSize) && sampleSize > 0) {
                                        spread = dispersion * Math.sqrt(sampleSize);
                                    }
                                } else if (dispersionType === 'standard_deviation') {
                                    spread = dispersion;
                                } else {
                                    spread = parseFloat(measurement.spread || 0);
                                }
                                
                                measurements.push({
                                    groupId: measurement.groupId,
                                    groupTitle: group.title || 'Unknown Group',
                                    value: value,
                                    dispersion: dispersion,
                                    dispersionType: dispersionType,
                                    spread: spread,
                                    category: cat.title || '',
                                    sampleSize: group.participantsAnalyzedList?.[0]?.count || 0
                                });
                            }
                        }
                    });
                });
            });
            
            if (measurements.length === 0) {
                console.warn(`No valid measurements for ${outcome.title}`);
                return;
            }
            
            // Clean up any existing chart on this canvas
            if (charts.studySpecific[canvasId]) {
                charts.studySpecific[canvasId].destroy();
            }
            
            // Create the chart
            const ctx = canvas.getContext('2d');
            
            // Determine if values are numerical or categorical
            const isNumerical = measurements.every(m => m.value !== null && !isNaN(m.value));
            
            if (isNumerical) {
                // Bell curve or bar chart for numerical data
                const datasets = [];
                const uniqueGroups = [...new Set(measurements.map(m => m.groupId))];
                
                uniqueGroups.forEach((groupId, index) => {
                    const groupMeasurements = measurements.filter(m => m.groupId === groupId);
                    if (groupMeasurements.length > 0) {
                        const groupTitle = groupMeasurements[0].groupTitle || `Group ${index + 1}`;
                        
                        // Check if we have dispersion/spread data for bell curves
                        const hasBellCurveData = groupMeasurements.some(m => m.spread > 0);
                        
                        if (hasBellCurveData) {
                            // Generate bell curve data for measurements with spread
                            groupMeasurements.forEach(m => {
                                if (m.value !== null && !isNaN(m.value) && m.spread > 0) {
                                    const mean = m.value;
                                    const stdDev = m.spread;
                                    const bellCurveData = generateNormalDistribution(mean, stdDev);
                                    
                                    datasets.push({
                                        label: `${groupTitle} - ${m.category}`,
                                        data: bellCurveData,
                                        borderColor: getRandomColor(index),
                                        backgroundColor: getRandomColor(index, 0.2),
                                        fill: true,
                                        tension: 0.4,
                                        pointRadius: 0
                                    });
                                }
                            });
                        } else {
                            // Bar chart data for means without standard deviations
                            const barData = groupMeasurements
                                .filter(m => m.value !== null && !isNaN(m.value))
                                .map(m => ({
                                    x: m.category,
                                    y: m.value
                                }));
                            
                            if (barData.length > 0) {
                                datasets.push({
                                    type: 'bar',
                                    label: groupTitle,
                                    data: barData,
                                    backgroundColor: getRandomColor(index, 0.6),
                                    borderColor: getRandomColor(index),
                                    borderWidth: 1
                                });
                            }
                        }
                    }
                });
                
                if (datasets.length > 0) {
                    // Determine chart type based on data
                    const isBarChart = datasets.some(d => d.type === 'bar');
                    
                    const chartConfig = {
                        type: isBarChart ? 'bar' : 'line',
                        data: {
                            datasets: datasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                x: {
                                    type: isBarChart ? 'category' : 'linear',
                                    title: {
                                        display: true,
                                        text: outcome.title || 'Value'
                                    },
                                    ticks: {
                                        callback: function(value) {
                                            // For dense values, truncate or format labels
                                            if (typeof value === 'string' && value.length > 15) {
                                                return value.substring(0, 15) + '...';
                                            }
                                            return value;
                                        }
                                    }
                                },
                                y: {
                                    title: {
                                        display: true,
                                        text: isBarChart ? 'Value' : 'Probability Density'
                                    },
                                    beginAtZero: true
                                }
                            },
                            plugins: {
                                tooltip: {
                                    callbacks: {
                                        title: function(context) {
                                            return context[0].dataset.label || 'Value';
                                        },
                                        label: function(context) {
                                            if (isBarChart) {
                                                return `Value: ${context.parsed.y !== undefined ? context.parsed.y.toFixed(2) : 'N/A'}`;
                                            }
                                            return `Value: ${context.parsed.x !== undefined ? context.parsed.x.toFixed(2) : 'N/A'}`;
                                        }
                                    }
                                },
                                legend: {
                                    display: true,
                                    position: 'top',
                                    labels: {
                                        // Limit legend label lengths
                                        generateLabels: function(chart) {
                                            const originalLabels = Chart.defaults.plugins.legend.labels.generateLabels(chart);
                                            return originalLabels.map(label => {
                                                if (label.text && label.text.length > 30) {
                                                    label.text = label.text.substring(0, 30) + '...';
                                                }
                                                return label;
                                            });
                                        }
                                    }
                                }
                            }
                        }
                    };
                    
                    try {
                        charts.studySpecific[canvasId] = new Chart(ctx, chartConfig);
                    } catch (error) {
                        console.error(`Error creating chart for ${canvasId}:`, error);
                    }
                } else {
                    // No valid datasets
                    canvas.parentElement.innerHTML = '<p class="text-center text-gray-500">Insufficient data for visualization</p>';
                }
            } else {
                // Bar chart for categorical data
                const labels = [...new Set(measurements.map(m => m.category))].filter(label => label !== undefined);
                const datasets = [];
                const groupMap = {};
                
                measurements.forEach(m => {
                    if (!groupMap[m.groupId]) {
                        groupMap[m.groupId] = {
                            label: m.groupTitle || 'Unknown Group',
                            data: Array(labels.length).fill(null),
                            backgroundColor: getRandomColor(Object.keys(groupMap).length, 0.6),
                            borderColor: getRandomColor(Object.keys(groupMap).length),
                            borderWidth: 1
                        };
                    }
                    
                    const categoryIndex = labels.indexOf(m.category);
                    if (categoryIndex !== -1 && m.value !== null) {
                        groupMap[m.groupId].data[categoryIndex] = m.value;
                    }
                });
                
                const finalDatasets = [];
                Object.values(groupMap).forEach(group => {
                    // Only add groups that have at least one non-null value
                    if (group.data.some(val => val !== null)) {
                        finalDatasets.push(group);
                    }
                });
                
                if (finalDatasets.length > 0 && labels.length > 0) {
                    const chartConfig = {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: finalDatasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                x: {
                                    ticks: {
                                        callback: function(value, index) {
                                            // For dense values, truncate or format labels
                                            const label = labels[index];
                                            if (typeof label === 'string' && label.length > 15) {
                                                return label.substring(0, 15) + '...';
                                            }
                                            return label;
                                        }
                                    }
                                },
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: outcome.title || 'Value'
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    position: 'top',
                                    labels: {
                                        // Limit legend label lengths
                                        generateLabels: function(chart) {
                                            const originalLabels = Chart.defaults.plugins.legend.labels.generateLabels(chart);
                                            return originalLabels.map(label => {
                                                if (label.text && label.text.length > 30) {
                                                    label.text = label.text.substring(0, 30) + '...';
                                                }
                                                return label;
                                            });
                                        }
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        title: function(context) {
                                            const index = context[0].dataIndex;
                                            return labels[index] || 'Unknown';
                                        }
                                    }
                                }
                            }
                        }
                    };
                    
                    try {
                        charts.studySpecific[canvasId] = new Chart(ctx, chartConfig);
                    } catch (error) {
                        console.error(`Error creating categorical chart for ${canvasId}:`, error);
                    }
                } else {
                    // No valid datasets or labels
                    canvas.parentElement.innerHTML = '<p class="text-center text-gray-500">Insufficient data for visualization</p>';
                }
            }
        }

        // Function to process and display aggregate outcome data
        function processAggregateOutcomes(studies) {
    // First collect all outcome data
    collectAllTrialOutcomes();
    
    // Then populate the legacy data structure for backward compatibility
    appState.allOutcomeMeasures = [];
    
    // Process studies to extract outcome measures for the original visualization
    studies.forEach(study => {
        const nctId = study.protocolSection?.identificationModule?.nctId;
        const studyDetails = appState.studyDetails[nctId];
        if (!studyDetails || !studyDetails.resultsSection?.outcomeMeasuresModule?.outcomeMeasures) return;
        
        const phase = study.protocolSection?.designModule?.phases?.[0] || 'PRE_PHASE';
        const outcomes = studyDetails.resultsSection.outcomeMeasuresModule.outcomeMeasures;
        
        outcomes.forEach(outcome => {
            if (outcome.type !== "PRIMARY") return;
            
            if (!outcome.classes || !outcome.classes[0]?.categories) return;
            
            outcome.classes.forEach(cls => {
                cls.categories.forEach(cat => {
                    cat.measurements.forEach(measurement => {
                        const value = parseFloat(measurement.value);
                        const spread = parseFloat(measurement.spread || 0);
                        
                        if (!isNaN(value)) {
                            const group = outcome.groups.find(g => g.id === measurement.groupId);
                            const isExperimental = group?.title.toLowerCase().includes('experimental') || 
                                                 group?.title.toLowerCase().includes('treatment') ||
                                                 group?.title.toLowerCase().includes('intervention');
                            
                            // Skip placebo/control groups for aggregate analysis
                            if (!isExperimental) return;
                            
                            appState.allOutcomeMeasures.push({
                                nctId: nctId,
                                phase: phase,
                                outcomeTitle: outcome.title || 'Unknown Outcome',
                                groupTitle: group?.title || 'Unknown Group',
                                value: value,
                                spread: spread,
                                lowerIsBetter: outcome.title?.toLowerCase().includes('score') || 
                                              outcome.title?.toLowerCase().includes('scale')
                            });
                        }
                    });
                });
            });
        });
    });
    
    // Display drug success rates visualization
    displayDrugSuccessRates();
}

// Update the displayCollatedOutcomes function to first create the charts if needed
function displayCollatedOutcomes() {
    console.log("Displaying collated outcomes...");
    
    // Check if the chart canvases exist, if not create them
    ['overallTreatmentEffectChart', 'phaseComparisonChart', 'phasePerformanceChart'].forEach(canvasId => {
        if (!document.getElementById(canvasId)) {
            console.log(`Canvas ${canvasId} not found, attempting to create`);
            let container;
            switch (canvasId) {
                case 'overallTreatmentEffectChart':
                    container = document.querySelector('#collatedOutcomesSection .h-72:nth-of-type(1)');
                    break;
                case 'phaseComparisonChart':
                    container = document.querySelector('#collatedOutcomesSection .h-72:nth-of-type(2)');
                    break;
                case 'phasePerformanceChart':
                    container = document.querySelector('#collatedOutcomesSection .h-72:nth-of-type(3)');
                    break;
            }
            
            if (container) {
                container.innerHTML = `<canvas id="${canvasId}"></canvas>`;
                console.log(`Created canvas: ${canvasId}`);
            }
        }
    });
    
    // Only show if we have data
    if (appState.allTrialOutcomes.length === 0 && appState.collatedOutcomes.length === 0) {
        showSection(elements.collatedOutcomesSection, false);
        return;
    }
    
    showSection(elements.collatedOutcomesSection, true);
    
    // Get the current metric and type selection
    const currentMetric = appState.currentOutcomeMetric;
    const currentType = appState.currentOutcomeType;
    
    console.log(`Filtering outcomes by metric: ${currentMetric}, type: ${currentType}`);
    
    // First try to use the collatedOutcomes array which might already have processed data
    let filteredOutcomes = [];
    
    if (appState.collatedOutcomes.length > 0) {
        filteredOutcomes = appState.collatedOutcomes;
    } else {
        // Otherwise, compile outcomes from the allTrialOutcomes array
        appState.allTrialOutcomes.forEach(study => {
            study.outcomes.forEach(outcome => {
                if (outcome.effectSize !== null) {
                    filteredOutcomes.push({
                        nctId: study.nctId,
                        title: study.title,
                        phase: study.phase,
                        outcomeTitle: outcome.title,
                        outcomeType: outcome.type,
                        category: outcome.category,
                        experimentalValue: outcome.experimentalValue,
                        controlValue: outcome.controlValue,
                        effectSize: outcome.effectSize,
                        experimentalSampleSize: outcome.experimentalSampleSize,
                        controlSampleSize: outcome.controlSampleSize,
                        timeFrame: outcome.timeFrame
                    });
                }
            });
        });
    }
    
    // Apply filters
    if (currentMetric) {
        filteredOutcomes = filteredOutcomes.filter(outcome => 
            outcome.outcomeTitle === currentMetric
        );
    }
    
    if (currentType !== 'all') {
        filteredOutcomes = filteredOutcomes.filter(outcome => 
            outcome.outcomeType === currentType
        );
    }
    
    console.log(`Filtered to ${filteredOutcomes.length} outcomes for visualization`);
    
    // Create the charts
    createOverallTreatmentEffectChart(filteredOutcomes);
    createEnhancedPhaseComparisonChart(filteredOutcomes);
    createPhasePerformanceChart(filteredOutcomes);
    createStatisticalSummaryTable(filteredOutcomes);
}


        function displayAggregateVisualizations() {
            if (appState.allOutcomeMeasures.length === 0) {
                elements.aggregateOutcomesSection.innerHTML = `
                    <div class="bg-white rounded-lg shadow-md p-6 text-center">
                        <p class="text-gray-500">No outcome measures with results available for the selected studies.</p>
                    </div>
                `;
                return;
            }
            
            showSection(elements.aggregateOutcomesSection, true);
            
            // Create overall distribution chart
            createOverallDistributionChart();
            
            // Create phase-specific charts
            createPhaseSpecificCharts();
            
            // Display outcome measures list
            displayOutcomeMeasuresList();
        }

        function createOverallDistributionChart() {
            const canvas = document.getElementById('overallDistributionChart');
            if (!canvas) {
                console.warn("Overall distribution chart canvas not found");
                return;
            }
            
            const ctx = canvas.getContext('2d');
            
            // Clear previous chart instance if it exists
            if (charts.overallDistribution) {
                charts.overallDistribution.destroy();
            }
            
            // Standardize values (convert to z-scores)
            const outcomes = appState.allOutcomeMeasures;
            
            // Calculate mean and std dev across all measures
            const validOutcomes = outcomes.filter(o => !isNaN(o.value) && !isNaN(o.spread) && o.spread > 0);
            
            if (validOutcomes.length === 0) return;
            
            const values = validOutcomes.map(o => o.value);
            const mean = values.reduce((sum, val) => sum + val, 0) / values.length;
            const stdDev = Math.sqrt(
                values.map(v => Math.pow(v - mean, 2)).reduce((sum, val) => sum + val, 0) / values.length
            );
            
            // Generate normal distribution data
            const bellCurveData = generateNormalDistribution(mean, stdDev);
            
            // Create chart
            charts.overallDistribution = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'Overall Distribution',
                        data: bellCurveData,
                        borderColor: '#8b5cf6', // Violet
                        backgroundColor: 'rgba(139, 92, 246, 0.2)', // Transparent violet
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            type: 'linear',
                            title: {
                                display: true,
                                text: 'Standardized Outcome Value'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Probability Density'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    return 'Overall Distribution';
                                },
                                label: function(context) {
                                    return `Value: ${context.parsed.x.toFixed(2)}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function createPhaseSpecificCharts() {
            const earlyPhasesCanvas = document.getElementById('earlyPhasesChart');
            const latePhasesCanvas = document.getElementById('latePhasesChart');
            
            if (!earlyPhasesCanvas || !latePhasesCanvas) {
                console.warn("Phase-specific chart canvases not found");
                return;
            }
            
            const earlyPhasesCtx = earlyPhasesCanvas.getContext('2d');
            const latePhasesCtx = latePhasesCanvas.getContext('2d');
            
            // Clear previous chart instances if they exist
            if (charts.earlyPhases) {
                charts.earlyPhases.destroy();
            }
            if (charts.latePhases) {
                charts.latePhases.destroy();
            }
            
            // Group outcomes by phase
            const outcomes = appState.allOutcomeMeasures;
            const earlyPhaseOutcomes = outcomes.filter(o => 
                o.phase === 'PHASE1' || o.phase === 'PHASE2' || o.phase === 'PHASE1_PHASE2' || o.phase === 'PRE_PHASE'
            );
            const latePhaseOutcomes = outcomes.filter(o => 
                o.phase === 'PHASE3' || o.phase === 'PHASE4'
            );
            
            // Process early phase data
            if (earlyPhaseOutcomes.length > 0) {
                // Group by specific phase
                const phase1Data = earlyPhaseOutcomes.filter(o => o.phase === 'PHASE1');
                const phase2Data = earlyPhaseOutcomes.filter(o => o.phase === 'PHASE2');
                const phase12Data = earlyPhaseOutcomes.filter(o => o.phase === 'PHASE1_PHASE2');
                const prePhaseData = earlyPhaseOutcomes.filter(o => o.phase === 'PRE_PHASE');
                
                const datasets = [];
                
                if (phase1Data.length > 0) {
                    datasets.push(createPhaseDataset(phase1Data, 'Phase 1', '#60a5fa'));
                }
                if (phase2Data.length > 0) {
                    datasets.push(createPhaseDataset(phase2Data, 'Phase 2', '#34d399'));
                }
                if (phase12Data.length > 0) {
                    datasets.push(createPhaseDataset(phase12Data, 'Phase 1/2', '#38bdf8'));
                }
                if (prePhaseData.length > 0) {
                    datasets.push(createPhaseDataset(prePhaseData, 'Pre-Phase', '#9ca3af'));
                }
                
                // Create chart
                charts.earlyPhases = new Chart(earlyPhasesCtx, {
                    type: 'line',
                    data: {
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        scales: {
                            x: {
                                type: 'linear',
                                title: {
                                    display: true,
                                    text: 'Standardized Outcome Value'
                                }
                            },
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Probability Density'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                            }
                        }
                    }
                });
            }
            
            // Process late phase data
            if (latePhaseOutcomes.length > 0) {
                // Group by specific phase
                const phase3Data = latePhaseOutcomes.filter(o => o.phase === 'PHASE3');
                const phase4Data = latePhaseOutcomes.filter(o => o.phase === 'PHASE4');
                
                const datasets = [];
                
                if (phase3Data.length > 0) {
                    datasets.push(createPhaseDataset(phase3Data, 'Phase 3', '#a78bfa'));
                }
                if (phase4Data.length > 0) {
                    datasets.push(createPhaseDataset(phase4Data, 'Phase 4', '#f97316'));
                }
                
                // Create chart
                charts.latePhases = new Chart(latePhasesCtx, {
                    type: 'line',
                    data: {
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        scales: {
                            x: {
                                type: 'linear',
                                title: {
                                    display: true,
                                    text: 'Standardized Outcome Value'
                                }
                            },
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Probability Density'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                            }
                        }
                    }
                });
            }
        }

        function createPhaseDataset(phaseData, label, color) {
            const validData = phaseData.filter(o => !isNaN(o.value) && !isNaN(o.spread) && o.spread > 0);
            
            if (validData.length === 0) {
                return {
                    label: label,
                    data: [],
                    borderColor: color,
                    backgroundColor: hexToRgba(color, 0.2),
                    fill: true,
                    tension: 0.4,
                    pointRadius: 0
                };
            }
            
            const values = validData.map(o => o.value);
            const mean = values.reduce((sum, val) => sum + val, 0) / values.length;
            const stdDev = Math.sqrt(
                values.map(v => Math.pow(v - mean, 2)).reduce((sum, val) => sum + val, 0) / values.length
            ) || 1; // Default to 1 if stdDev is 0 to avoid division by zero
            
            // Generate normal distribution data
            const bellCurveData = generateNormalDistribution(mean, stdDev);
            
            return {
                label: label,
                data: bellCurveData,
                borderColor: color,
                backgroundColor: hexToRgba(color, 0.2),
                fill: true,
                tension: 0.4,
                pointRadius: 0
            };
        }

        function displayOutcomeMeasuresList() {
            const outcomeMeasuresList = document.getElementById('outcomeMeasuresList');
            if (!outcomeMeasuresList) {
                console.warn("Outcome measures list element not found");
                return;
            }
            
            outcomeMeasuresList.innerHTML = '';
            
            // Group outcomes by measure title
            const outcomes = appState.allOutcomeMeasures;
            const outcomesByTitle = {};
            
            outcomes.forEach(outcome => {
                const title = outcome.outcomeTitle || 'Unknown Outcome';
                if (!outcomesByTitle[title]) {
                    outcomesByTitle[title] = [];
                }
                outcomesByTitle[title].push(outcome);
            });
            
            // Sort outcome titles by frequency (most common first)
            const sortedTitles = Object.keys(outcomesByTitle).sort((a, b) => 
                outcomesByTitle[b].length - outcomesByTitle[a].length
            );
            
            if (sortedTitles.length === 0) {
                outcomeMeasuresList.innerHTML = '<p class="text-center text-gray-500">No outcome measures available</p>';
                return;
            }
            
            sortedTitles.forEach(title => {
                const outcomesByPhase = {};
                
                // Group by phase
                outcomesByTitle[title].forEach(outcome => {
                    const phase = outcome.phase;
                    if (!outcomesByPhase[phase]) {
                        outcomesByPhase[phase] = [];
                    }
                    outcomesByPhase[phase].push(outcome);
                });
                
                // Create outcome card
                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-lg border border-gray-200';
                
                // Calculate average value across all phases
                const allValues = outcomesByTitle[title].map(o => o.value);
                const avgValue = allValues.reduce((sum, val) => sum + val, 0) / allValues.length;
                
                // Construct phase data HTML
                const phaseDataHtml = Object.keys(outcomesByPhase)
                    .map(phase => {
                        const phaseOutcomes = outcomesByPhase[phase];
                        const phaseValues = phaseOutcomes.map(o => o.value);
                        const avgPhaseValue = phaseValues.reduce((sum, val) => sum + val, 0) / phaseValues.length;
                        
                        return `
                            <div class="flex items-center mb-1">
                                <span class="inline-block w-3 h-3 rounded-full mr-2" style="background-color: ${getPhaseColor(phase)}"></span>
                                <span class="text-sm">${formatPhase(phase)}: ${avgPhaseValue.toFixed(2)}</span>
                            </div>
                        `;
                    })
                    .join('');
                
                card.innerHTML = `
                    <h4 class="text-md font-medium mb-2">${title}</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <p class="text-sm text-gray-600 mb-2">Studies: ${outcomesByTitle[title].length}</p>
                            <p class="text-sm text-gray-600 mb-2">Average value: ${avgValue.toFixed(2)}</p>
                            <div class="mt-2">
                                ${phaseDataHtml}
                            </div>
                        </div>
                        <div>
                            <div class="h-32">
                                <canvas id="outcome_summary_${title.replace(/\s+/g, '_').substring(0, 30)}"></canvas>
                            </div>
                        </div>
                    </div>
                `;
                
                outcomeMeasuresList.appendChild(card);
                
                // Create summary chart
                const canvasId = `outcome_summary_${title.replace(/\s+/g, '_').substring(0, 30)}`;
                const canvas = document.getElementById(canvasId);
                
                if (canvas) {
                    const ctx = canvas.getContext('2d');
                    const datasets = [];
                    
                    Object.keys(outcomesByPhase).forEach((phase, index) => {
                        const phaseOutcomes = outcomesByPhase[phase];
                        const phaseValues = phaseOutcomes.map(o => o.value);
                        const avgPhaseValue = phaseValues.reduce((sum, val) => sum + val, 0) / phaseValues.length;
                        
                        datasets.push({
                            label: formatPhase(phase),
                            data: [{x: formatPhase(phase), y: avgPhaseValue}],
                            backgroundColor: getPhaseColor(phase),
                            borderColor: getPhaseColor(phase),
                            borderWidth: 1
                        });
                    });
                    
                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            datasets: datasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            indexAxis: 'y',
                            scales: {
                                x: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Average Value'
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    display: false
                                }
                            }
                        }
                    });
                }
            });
        }

        // New function to display collated outcomes
        function displayCollatedOutcomes() {
    // Only show if we have data
    if (appState.collatedOutcomes.length === 0) {
        showSection(elements.collatedOutcomesSection, false);
        return;
    }
    
    showSection(elements.collatedOutcomesSection, true);
    
    // Get the current metric and type selection
    const currentMetric = appState.currentOutcomeMetric;
    const currentType = appState.currentOutcomeType;
    
    // Filter outcomes by metric and type
    let filteredOutcomes = appState.collatedOutcomes;
    
    if (currentMetric) {
        filteredOutcomes = filteredOutcomes.filter(outcome => 
            outcome.outcomeTitle === currentMetric
        );
    }
    
    if (currentType !== 'all') {
        filteredOutcomes = filteredOutcomes.filter(outcome => 
            outcome.outcomeType === currentType
        );
    }
    
    // Create the overall treatment effect chart
    createOverallTreatmentEffectChart(filteredOutcomes);
    
    // Create the enhanced phase comparison chart
    createEnhancedPhaseComparisonChart(filteredOutcomes);
    
    // Create the new phase performance chart
    createPhasePerformanceChart(filteredOutcomes);
    
    // Create the statistical summary table
    createStatisticalSummaryTable(filteredOutcomes);
}

        function createOverallTreatmentEffectChart(outcomes) {
            const canvas = document.getElementById('overallTreatmentEffectChart');
            if (!canvas) {
                console.warn("Overall treatment effect chart canvas not found");
                return;
            }
            
            const ctx = canvas.getContext('2d');
            
            // Clear previous chart
            if (charts.overallTreatmentEffect) {
                charts.overallTreatmentEffect.destroy();
            }
            
            // Filter only outcomes with effect sizes
            const validOutcomes = outcomes.filter(o => o.effectSize !== null);
            
            if (validOutcomes.length === 0) {
                canvas.parentElement.innerHTML = '<p class="text-center text-gray-500 py-8">No treatment effect data available for the selected metric.</p>';
                return;
            }
            
            // Calculate mean and standard deviation of effect sizes
            const effectSizes = validOutcomes.map(o => o.effectSize);
            const mean = calculateMean(effectSizes);
            const stdDev = calculateStandardDeviation(effectSizes, mean);
            
            // Generate normal distribution data
            const bellCurveData = generateNormalDistribution(mean, stdDev);
            
            // Generate scatter plot data for individual studies
            const scatterData = validOutcomes.map(o => ({
                x: o.effectSize,
                y: 0.05, // Small fixed value for visibility
                nctId: o.nctId,
                title: o.title,
                phase: o.phase
            }));
            
            // Create the chart
            charts.overallTreatmentEffect = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [
                        {
                            type: 'line',
                            label: 'Overall Distribution',
                            data: bellCurveData,
                            borderColor: '#8b5cf6', // Violet
                            backgroundColor: 'rgba(139, 92, 246, 0.2)', // Transparent violet
                            fill: true,
                            tension: 0.4,
                            pointRadius: 0
                        },
                        {
                            type: 'scatter',
                            label: 'Individual Studies',
                            data: scatterData,
                            backgroundColor: ctx => {
                                // Color points by phase
                                const phase = scatterData[ctx.dataIndex]?.phase;
                                return getPhaseColor(phase);
                            },
                            pointRadius: 6,
                            pointHoverRadius: 8
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'linear',
                            title: {
                                display: true,
                                text: 'Effect Size'
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Probability Density'
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    const dataIndex = context[0].dataIndex;
                                    const datasetIndex = context[0].datasetIndex;
                                    
                                    if (datasetIndex === 1) { // Scatter plot
                                        return scatterData[dataIndex].title || 'Study';
                                    }
                                    return 'Effect Size Distribution';
                                },
                                label: function(context) {
                                    const dataIndex = context.dataIndex;
                                    const datasetIndex = context.datasetIndex;
                                    
                                    if (datasetIndex === 1) { // Scatter plot
                                        return [
                                            `NCT ID: ${scatterData[dataIndex].nctId || 'Unknown'}`,
                                            `Phase: ${formatPhase(scatterData[dataIndex].phase)}`,
                                            `Effect Size: ${scatterData[dataIndex].x.toFixed(2)}`
                                        ];
                                    }
                                    return `Value: ${context.parsed.x.toFixed(2)}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function createEnhancedPhaseComparisonChart(outcomes) {
    const canvasId = 'phaseComparisonChart';
    const canvas = document.getElementById(canvasId);
    
    if (!canvas) {
        console.warn(`Canvas not found: ${canvasId}`);
        // Try to create the canvas if its container exists
        const container = document.querySelector('#collatedOutcomesSection .h-72:nth-of-type(2)');
        if (container) {
            container.innerHTML = `<canvas id="${canvasId}"></canvas>`;
            console.log(`Created canvas: ${canvasId}`);
            // Try again with the new canvas
            const newCanvas = document.getElementById(canvasId);
            if (!newCanvas) {
                console.error(`Failed to create canvas: ${canvasId}`);
                return;
            }
            createEnhancedPhaseComparisonChart(outcomes);
            return;
        }
        return;
    }
    
    // Rest of the function implementation...
    const ctx = canvas.getContext('2d');
    
    // Clear previous chart
    if (charts.phaseComparison) {
        charts.phaseComparison.destroy();
    }
    
    // Filter only outcomes with effect sizes
    const validOutcomes = outcomes.filter(o => o.effectSize !== null);
    
    if (validOutcomes.length === 0) {
        canvas.parentElement.innerHTML = '<p class="text-center text-gray-500 py-8">No phase-specific data available for the selected metric.</p>';
        return;
    }
    
    // Group outcomes by phase
    const phaseGroups = {};
    const phaseOrder = { 
        "PRE_PHASE": 0, 
        "PHASE1": 1, 
        "PHASE1_PHASE2": 1.5,
        "PHASE2": 2, 
        "PHASE3": 3, 
        "PHASE4": 4,
        "N/A": 5
    };
    
    validOutcomes.forEach(o => {
        const phase = o.phase || 'N/A';
        if (!phaseGroups[phase]) {
            phaseGroups[phase] = [];
        }
        phaseGroups[phase].push(o.effectSize);
    });
    
    // Calculate phase statistics and prepare datasets
    const phases = Object.keys(phaseGroups)
        .filter(phase => phaseGroups[phase].length >= 2) // Only include phases with enough data
        .sort((a, b) => phaseOrder[a] - phaseOrder[b]);
    
    if (phases.length === 0) {
        canvas.parentElement.innerHTML = '<p class="text-center text-gray-500 py-8">Insufficient data for phase comparison visualization.</p>';
        return;
    }
    
    const datasets = [];
    const allEffectSizes = validOutcomes.map(o => o.effectSize);
    
    // Find global min and max for consistent scaling
    const globalMin = Math.min(...allEffectSizes);
    const globalMax = Math.max(...allEffectSizes);
    const range = globalMax - globalMin;
    const paddedMin = globalMin - (range * 0.1);
    const paddedMax = globalMax + (range * 0.1);
    
    phases.forEach((phase) => {
        const effectSizes = phaseGroups[phase];
        const mean = calculateMean(effectSizes);
        const stdDev = calculateStandardDeviation(effectSizes, mean) || 1; // Default to 1 if stdDev is 0
        
        // Generate normal distribution data with consistent x-scale
        const points = 100;
        const step = (paddedMax - paddedMin) / points;
        const bellCurveData = [];
        
        for (let x = paddedMin; x <= paddedMax; x += step) {
            const y = (1 / (stdDev * Math.sqrt(2 * Math.PI))) * 
                      Math.exp(-Math.pow(x - mean, 2) / (2 * Math.pow(stdDev, 2)));
            bellCurveData.push({ x, y });
        }
        
        datasets.push({
            label: formatPhase(phase),
            data: bellCurveData,
            borderColor: getPhaseColor(phase),
            backgroundColor: hexToRgba(getPhaseColor(phase), 0.1),
            borderWidth: 2,
            fill: true,
            tension: 0.4,
            pointRadius: 0
        });
    });
    
    // Create the chart with proper scaling
    charts.phaseComparison = new Chart(ctx, {
        type: 'line',
        data: {
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    type: 'linear',
                    title: {
                        display: true,
                        text: 'Effect Size'
                    },
                    min: paddedMin,
                    max: paddedMax,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Probability Density'
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'top',
                },
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            return context[0].dataset.label;
                        },
                        label: function(context) {
                            const phaseLabel = context.dataset.label;
                            const effectSize = context.parsed.x.toFixed(2);
                            
                            // Get the phase from the label
                            const phase = Object.keys(phaseOrder).find(p => 
                                formatPhase(p) === phaseLabel
                            );
                            
                            if (phase) {
                                const effectSizes = phaseGroups[phase];
                                const mean = calculateMean(effectSizes);
                                const count = effectSizes.length;
                                
                                return [
                                    `Effect Size: ${effectSize}`,
                                    `Mean Effect: ${mean.toFixed(2)}`,
                                    `Studies: ${count}`
                                ];
                            }
                            
                            return `Effect Size: ${effectSize}`;
                        }
                    }
                }
            }
        }
    });
}

// And for the phase performance chart
function createPhasePerformanceChart(outcomes) {
    const canvasId = 'phasePerformanceChart';
    const canvas = document.getElementById(canvasId);
    
    if (!canvas) {
        console.warn(`Canvas not found: ${canvasId}`);
        // Try to create the canvas if its container exists
        const container = document.querySelector('#collatedOutcomesSection .h-72:nth-of-type(3)');
        if (container) {
            container.innerHTML = `<canvas id="${canvasId}"></canvas>`;
            console.log(`Created canvas: ${canvasId}`);
            // Try again with the new canvas
            const newCanvas = document.getElementById(canvasId);
            if (!newCanvas) {
                console.error(`Failed to create canvas: ${canvasId}`);
                return;
            }
            createPhasePerformanceChart(outcomes);
            return;
        }
        return;
    }
    
    // Rest of the function implementation...
    const ctx = canvas.getContext('2d');
    
    // Clear previous chart
    if (charts.phasePerformance) {
        charts.phasePerformance.destroy();
    }
    
    // Filter only outcomes with effect sizes
    const validOutcomes = outcomes.filter(o => o.effectSize !== null);
    
    if (validOutcomes.length === 0) {
        canvas.parentElement.innerHTML = '<p class="text-center text-gray-500 py-8">No phase-specific data available for the selected metric.</p>';
        return;
    }
    
    // Group outcomes by phase
    const phaseGroups = {};
    const phaseOrder = { 
        "PRE_PHASE": 0, 
        "PHASE1": 1, 
        "PHASE1_PHASE2": 1.5,
        "PHASE2": 2, 
        "PHASE3": 3, 
        "PHASE4": 4,
        "N/A": 5
    };
    
    validOutcomes.forEach(o => {
        const phase = o.phase || 'N/A';
        if (!phaseGroups[phase]) {
            phaseGroups[phase] = [];
        }
        phaseGroups[phase].push(o.effectSize);
    });
    
    // Calculate phase statistics for the bar chart
    const phases = Object.keys(phaseGroups)
        .filter(phase => phaseGroups[phase].length >= 2) // Only include phases with enough data
        .sort((a, b) => phaseOrder[a] - phaseOrder[b]);
    
    if (phases.length === 0) {
        canvas.parentElement.innerHTML = '<p class="text-center text-gray-500 py-8">Insufficient data for phase performance visualization.</p>';
        return;
    }
    
    const labels = phases.map(phase => formatPhase(phase));
    const meanValues = [];
    const errorBars = {
        plus: [],
        minus: []
    };
    
    phases.forEach(phase => {
        const effectSizes = phaseGroups[phase];
        const mean = calculateMean(effectSizes);
        const stdDev = calculateStandardDeviation(effectSizes, mean);
        const n = effectSizes.length;
        const ci = calculateConfidenceInterval(mean, stdDev, n);
        
        meanValues.push(mean);
        errorBars.plus.push(ci.upper - mean);
        errorBars.minus.push(mean - ci.lower);
    });
    
    // Create the chart
    charts.phasePerformance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Mean Effect Size',
                data: meanValues,
                backgroundColor: phases.map(phase => hexToRgba(getPhaseColor(phase), 0.7)),
                borderColor: phases.map(phase => getPhaseColor(phase)),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    title: {
                        display: true,
                        text: 'Effect Size'
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Trial Phase'
                    },
                    grid: {
                        display: false
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            return context[0].label;
                        },
                        label: function(context) {
                            const index = context.dataIndex;
                            const phase = phases[index];
                            const effectSizes = phaseGroups[phase];
                            const mean = meanValues[index];
                            const stdDev = calculateStandardDeviation(effectSizes);
                            const n = effectSizes.length;
                            const ci = calculateConfidenceInterval(mean, stdDev, n);
                            
                            return [
                                `Mean Effect: ${mean.toFixed(2)}`,
                                `95% CI: [${ci.lower.toFixed(2)}, ${ci.upper.toFixed(2)}]`,
                                `Studies: ${n}`
                            ];
                        }
                    }
                }
            }
        },
        plugins: [{
            id: 'errorBars',
            afterDatasetsDraw: function(chart) {
                const ctx = chart.ctx;
                
                chart.data.datasets.forEach((dataset, i) => {
                    const meta = chart.getDatasetMeta(i);
                    
                    if (!meta.hidden) {
                        meta.data.forEach((element, index) => {
                            // Draw error bars
                            const plus = errorBars.plus[index];
                            const minus = errorBars.minus[index];
                            const x = element.x;
                            const y = element.y;
                            
                            const barWidth = 3;
                            
                            // Save state
                            ctx.save();
                            
                            // Line style
                            ctx.lineWidth = 2;
                            ctx.strokeStyle = dataset.borderColor[index] || dataset.borderColor;
                            
                            // Draw the line
                            ctx.beginPath();
                            ctx.moveTo(x, y - plus);
                            ctx.lineTo(x, y + minus);
                            ctx.stroke();
                            
                            // Draw the top cap
                            ctx.beginPath();
                            ctx.moveTo(x - barWidth, y - plus);
                            ctx.lineTo(x + barWidth, y - plus);
                            ctx.stroke();
                            
                            // Draw the bottom cap
                            ctx.beginPath();
                            ctx.moveTo(x - barWidth, y + minus);
                            ctx.lineTo(x + barWidth, y + minus);
                            ctx.stroke();
                            
                            // Restore state
                            ctx.restore();
                        });
                    }
                });
            }
        }]
    });
}

    
// Function to initialize FDA data section
// Function to initialize FDA data section
// function initFdaDataSection() {
//   // Show the section
//   showSection(elements.fdaDataSection, true);
  
//   // Initialize counters
//   elements.fdaDocCount.textContent = "0 documents";
//   elements.orangeBookCount.textContent = "0 entries";
//   elements.dailyMedCount.textContent = "0 entries";
//   elements.warningLettersCount.textContent = "0 letters";
// }

// // Function to display FDA data when available
// async function displayFdaData(drugName) {
//   // Initialize the FDA data section
//   initFdaDataSection();
  
//   // Show loading state
//   const loadingTemplate = `
//     <div class="flex justify-center items-center py-8">
//       <svg class="animate-spin h-8 w-8 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
//         <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
//         <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
//       </svg>
//       <span class="ml-2 text-gray-600">Loading FDA data...</span>
//     </div>
//   `;
  
//   elements.fdaDocuments.innerHTML = loadingTemplate;
//   elements.orangeBookData.innerHTML = loadingTemplate;
//   elements.dailyMedData.innerHTML = loadingTemplate;
  
//   try {
//     // Fetch FDA drug data
//     const fdaResponse = await fetch(`/api/fda/drug/${encodeURIComponent(drugName)}`);
//     const fdaData = await fdaResponse.json();
    
//     if (fdaResponse.ok && !fdaData.error) {
//       await displayFdaSubmissions(fdaData, drugName);
//     } else {
//       elements.fdaDocuments.innerHTML = createErrorMessage("Could not retrieve FDA submissions data");
//     }
    
//     // Fetch Orange Book data
//     const orangeBookResponse = await fetch(`/api/fda/orangebook/search?q=${encodeURIComponent(drugName)}`);
//     const orangeBookData = await orangeBookResponse.json();
    
//     if (orangeBookResponse.ok && !orangeBookData.error) {
//       displayOrangeBookData(orangeBookData);
//     } else {
//       elements.orangeBookData.innerHTML = createErrorMessage("Could not retrieve Orange Book data");
//     }
    
//     // Fetch DailyMed data
//     const dailyMedResponse = await fetch(`/api/fda/dailymed/${encodeURIComponent(drugName)}`);
//     const dailyMedData = await dailyMedResponse.json();
    
//     if (dailyMedResponse.ok && !dailyMedData.error) {
//       displayDailyMedData(dailyMedData);
//     } else {
//       elements.dailyMedData.innerHTML = createErrorMessage("Could not retrieve DailyMed data");
//     }
    
//   } catch (error) {
//     console.error("Error fetching FDA data:", error);
//     elements.fdaDocuments.innerHTML = createErrorMessage("Error fetching FDA data");
//     elements.orangeBookData.innerHTML = createErrorMessage("Error fetching FDA data");
//     elements.dailyMedData.innerHTML = createErrorMessage("Error fetching FDA data");
//   }
// }

// // Helper function to create error messages
// function createErrorMessage(message) {
//   return `
//     <div class="flex justify-center items-center py-8 text-red-500">
//       <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
//       </svg>
//       <span>${message}</span>
//     </div>
//   `;
// }

// // Function to display FDA submissions
// async function displayFdaSubmissions(fdaData, drugName) {
//   // Check if FDA data is empty
//   if (Object.keys(fdaData).length === 0) {
//     elements.fdaDocuments.innerHTML = `
//       <div class="text-center p-4">
//         <p class="text-sm text-gray-700">No FDA submissions found for "${drugName}"</p>
//       </div>
//     `;
//     elements.fdaDocCount.textContent = "0 documents";
//     return;
//   }
  
//   // Collect all products into a flat array for easier pagination
//   let allProducts = [];
//   Object.entries(fdaData).forEach(([brandName, strengths]) => {
//     Object.entries(strengths).forEach(([strength, products]) => {
//       products.forEach(product => {
//         allProducts.push({
//           ...product,
//           strength
//         });
//       });
//     });
//   });
  
//   // Count total entries for the counter
//   const totalEntries = allProducts.length;
  
//   // Update the counter
//   elements.fdaDocCount.textContent = `${totalEntries} submissions`;
  
//   // Pagination settings
//   const itemsPerPage = 10;
//   const totalPages = Math.ceil(totalEntries / itemsPerPage);
//   let currentPage = 1;
  
//   // Function to render products for the current page
//   function renderCurrentPage() {
//     const startIndex = (currentPage - 1) * itemsPerPage;
//     const endIndex = Math.min(startIndex + itemsPerPage, totalEntries);
//     const productsToShow = allProducts.slice(startIndex, endIndex);
    
//     // Create HTML for FDA submissions
//     let html = `<div class="grid grid-cols-1 md:grid-cols-3 gap-4">`;
    
//     // Iterate through each product for the current page
//     for (const product of productsToShow) {
//       // Create a card for each product
//       html += `
//         <div class="bg-white border border-gray-200 rounded-md shadow-sm hover:shadow-md transition-shadow">
//           <div class="p-3">
//             <div class="flex justify-between items-start">
//               <div class="truncate pr-2">
//                 <h4 class="text-sm font-semibold truncate">${product.brandName}</h4>
//                 <p class="text-xs text-gray-600">${product.strength}</p>
//               </div>
//               <span class="px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded-full whitespace-nowrap">
//                 ${product.applicationNumber}
//               </span>
//             </div>
            
//             <div class="mt-2 text-xs">
//               <p><span class="font-medium">Approved:</span> ${product.approvalDate}</p>
//               <p class="truncate"><span class="font-medium">Manufacturer:</span> ${product.manufacturerName || product.sponsorName}</p>
//               <p class="truncate"><span class="font-medium">Form:</span> ${product.dosageForm}</p>
//             </div>
            
//             <div class="mt-2 flex justify-end">
//               <button
//                 class="px-2 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 transition-colors view-details-btn"
//                 data-application="${product.applicationNumber}"
//                 data-brand="${product.brandName}"
//                 data-ingredient="${product.activeIngredients?.[0]?.name || drugName}"
//               >
//                 Details
//               </button>
//             </div>
//           </div>
//         </div>
//       `;
//     }
    
//     html += `</div>`;
    
//     // Add pagination controls
//     if (totalPages > 1) {
//       html += `
//         <div class="mt-6 flex justify-center">
//           <nav class="flex items-center">
//             <button id="prev-page" class="px-3 py-1 border border-gray-300 rounded-l ${currentPage === 1 ? 'bg-gray-100 cursor-not-allowed text-gray-400' : 'bg-white hover:bg-gray-50 text-gray-700'}" ${currentPage === 1 ? 'disabled' : ''}>
//               Previous
//             </button>
            
//             <div class="px-4 py-1 border-t border-b border-gray-300 bg-white text-sm">
//               Page ${currentPage} of ${totalPages}
//             </div>
            
//             <button id="next-page" class="px-3 py-1 border border-gray-300 rounded-r ${currentPage === totalPages ? 'bg-gray-100 cursor-not-allowed text-gray-400' : 'bg-white hover:bg-gray-50 text-gray-700'}" ${currentPage === totalPages ? 'disabled' : ''}>
//               Next
//             </button>
//           </nav>
//         </div>
//       `;
//     }
    
//     elements.fdaDocuments.innerHTML = html;
    
//     // Add event listeners to the "View Details" buttons
//     document.querySelectorAll('.view-details-btn').forEach(button => {
//       button.addEventListener('click', function() {
//         const applicationNumber = this.getAttribute('data-application');
//         const brandName = this.getAttribute('data-brand');
//         const ingredient = this.getAttribute('data-ingredient');
//         openDetailsModal(applicationNumber, brandName, ingredient);
//       });
//     });
    
//     // Add event listeners to pagination buttons
//     if (totalPages > 1) {
//       document.getElementById('prev-page')?.addEventListener('click', function() {
//         if (currentPage > 1) {
//           currentPage--;
//           renderCurrentPage();
//           // Scroll to top of results
//           elements.fdaDocuments.scrollIntoView({ behavior: 'smooth' });
//         }
//       });
      
//       document.getElementById('next-page')?.addEventListener('click', function() {
//         if (currentPage < totalPages) {
//           currentPage++;
//           renderCurrentPage();
//           // Scroll to top of results
//           elements.fdaDocuments.scrollIntoView({ behavior: 'smooth' });
//         }
//       });
//     }
//   }
  
//   // Initial render
//   renderCurrentPage();
// }

//////////////////////////////////////////////////WARNING LETTERS ///////////////////////////////////////////////////////////

// Core utility functions for the FDA Regulatory Dashboard
// ====================== GLOBAL STATE TRACKING ======================
// Add a global object to track Form 483 counts by company
window.regulatoryData = {
    form483Counts: {},
    warningLetterCounts: {},
    historicalInspectionCounts: {},
    
    // Method to reset all counts
    resetCounts: function(companies) {
      this.form483Counts = {};
      this.warningLetterCounts = {};
      this.historicalInspectionCounts = {};
      
      // Initialize counts for all companies
      if (companies && Array.isArray(companies)) {
        companies.forEach(company => {
          this.form483Counts[company] = 0;
          this.warningLetterCounts[company] = 0;
          this.historicalInspectionCounts[company] = 0;
        });
      }
    },
    
    // Method to increment Form 483 count for a company
    addForm483: function(company) {
      if (!this.form483Counts[company]) {
        this.form483Counts[company] = 0;
      }
      this.form483Counts[company]++;
      console.log(`Added Form 483 for ${company}, new count: ${this.form483Counts[company]}`);
    },
    
    // Method to get all counts for a company
    getCompanyStats: function(company) {
      return {
        company: company,
        form483Count: this.form483Counts[company] || 0,
        wlCount: this.warningLetterCounts[company] || 0,
        historicalCount: this.historicalInspectionCounts[company] || 0,
        totalInspections: (this.form483Counts[company] || 0) + (this.historicalInspectionCounts[company] || 0)
      };
    },
    
    // Debug method to log all counts
    logAllCounts: function() {
      console.log("Current Form 483 Counts:", this.form483Counts);
      console.log("Current Warning Letter Counts:", this.warningLetterCounts);
      console.log("Current Historical Inspection Counts:", this.historicalInspectionCounts);
    }
  };
  

  
  
  // ====================== WARNING LETTERS FUNCTIONS ======================

  // Modified function to fetch warning letters and return the result without affecting the display
  async function fetchWarningLettersWithTracking(companies, page = 1, pageSize = 10, filters = {}) {
    try {
      if (!Array.isArray(companies) || companies.length === 0) {
        throw new Error('Companies parameter must be a non-empty array');
      }
  
      // Show loading state
      elements.warningLettersData.innerHTML = `
        <div class="flex justify-center items-center py-8">
          <svg class="animate-spin h-6 w-6 text-red-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          <span class="ml-2 text-gray-600">Searching warning letters for ${companies.length} ${companies.length === 1 ? 'company' : 'companies'}...</span>
        </div>
      `;
  
      // Store results and deduplicate by letter ID
      const allLetters = new Map(); // Map<letterId, letter>
  
      // Fetch warning letters for each company
      for (const company of companies) {
        // Build query parameters for this company
        const queryParams = new URLSearchParams();
        
        // Use company as the search term
        queryParams.append('term', company);
        
        // Focus search on company name
        queryParams.append('field', 'company');
        
        // Pagination parameters
        queryParams.append('page', page.toString());
        queryParams.append('perPage', pageSize.toString());
  
        // Add filters if they exist
        if (filters.type) queryParams.append('type', filters.type);
        if (filters.issueDate) queryParams.append('dateFrom', filters.issueDate);
        if (filters.issuingOffice) queryParams.append('issuingOffice', filters.issuingOffice);
  
        console.log(`Fetching warning letters for ${company} with params:`, queryParams.toString());
  
        // Make request to the API
        try {
          const response = await fetch(`${API_BASE_URL}/wl/search?${queryParams.toString()}`);
          
          if (!response.ok) {
            console.warn(`Warning letters fetch failed for ${company}: ${response.status}`);
            continue; // Skip to next company
          }
  
          const data = await response.json();
          const letters = data.results || [];
          
          console.log(`Found ${letters.length} warning letters for ${company}:`, letters);
  
          // Add source company to each letter and add to Map to deduplicate
          letters.forEach(letter => {
            const letterId = letter.id || letter.letterId;
            if (letterId) {
              if (!allLetters.has(letterId)) {
                allLetters.set(letterId, { ...letter, sourceCompany: company });
                console.log(`Added warning letter ${letterId} to results with sourceCompany=${company}`);
                
                // Increment the warning letter count for this company
                window.regulatoryData.warningLetterCounts[company] = 
                  (window.regulatoryData.warningLetterCounts[company] || 0) + 1;
              } else {
                console.log(`Skipped duplicate warning letter ${letterId}`);
              }
            }
          });
        } catch (error) {
          console.warn(`Error fetching warning letters for ${company}:`, error);
        }
      }
  
      // Convert Map to array for display
      const lettersArray = Array.from(allLetters.values());
      console.log(`Final deduplicated warning letters: ${lettersArray.length}`, lettersArray);
  
      // Update the warning letters count properly
      elements.warningLettersCount.textContent = `${lettersArray.length} letters`;
      elements.warningLettersCount.style.display = "inline-flex";
  
      // Display the warning letters with pagination
      displayWarningLetters({
        results: lettersArray,
        total: lettersArray.length, // Use actual count of deduplicated letters
        page: page,
        pageSize: pageSize
      }, companies, filters);
      
      // Return the warning letters to be used elsewhere
      return lettersArray;
    } catch (error) {
      console.error("Error fetching warning letters:", error);
      elements.warningLettersData.innerHTML = `
        <div class="text-center p-4">
          <p class="text-sm text-red-600">Error fetching warning letters: ${error.message}</p>
        </div>
      `;
  
      elements.warningLettersCount.textContent = "0 letters";
      elements.warningLettersCount.style.display = "inline-flex";
      
      // Return empty array in case of error
      return [];
    }
  }
  
  // Function to fetch inspection data without creating the summary yet
// Function to fetch inspection data without creating the summary yet
async function fetchInspectionDataWithTracking(companies) {
  try {
    if (!Array.isArray(companies) || companies.length === 0) {
      throw new Error('Companies parameter must be a non-empty array');
    }

    // Show loading state
    elements.inspectionDataSection.innerHTML = `
      <div class="flex justify-center items-center py-8">
        <svg class="animate-spin h-6 w-6 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span class="ml-2 text-gray-600">Loading inspection data for ${companies.join(", ")}...</span>
      </div>
    `;

    // Fetch inspection data from your API
    const response = await fetch(`${API_BASE_URL}/inspection-data`);
    
    if (!response.ok) {
      throw new Error(`Error fetching inspection data: ${response.status}`);
    }
    
    const data = await response.json();
    console.log("Raw inspection data:", data);
    
    // First reset Form 483 counts for these companies to ensure clean state
    companies.forEach(company => {
      window.regulatoryData.form483Counts[company] = 0;
    });
    
    // Process each recent inspection (Form 483s)
    if (data.recentInspections && data.recentInspections.length > 0) {
      data.recentInspections.forEach(inspection => {
        // Only process if it's a Form 483
        // if (inspection["Record Type"] === "Form 483") {
          const legalName = inspection["Legal Name"] || '';
          
          // Check for each company if this Form 483 belongs to it
          companies.forEach(company => {
            console.log("checking for company now, ", legalName, company)
            // Check if this Form 483 is related to this company
            // More inclusive matching for subsidiaries
            if (isRelatedCompany(legalName, company)) {
              console.log(`Found Form 483 for ${company}: ${legalName}`);
              // Directly increment the form483Counts
              if (!window.regulatoryData.form483Counts[company]) {
                window.regulatoryData.form483Counts[company] = 0;
              }
              window.regulatoryData.form483Counts[company]++;
              console.log(`Updated Form 483 count for ${company}: ${window.regulatoryData.form483Counts[company]}`);
            }
          });
        // }
      });
    }
    
    // Process historical inspections
    if (data.historicalInspections && data.historicalInspections.length > 0) {
      data.historicalInspections.forEach(inspection => {
        const firmName = inspection["Firm Name"] || '';
        
        // Check for each company if this historical inspection belongs to it
        companies.forEach(company => {
          if (isRelatedCompany(firmName, company)) {
            console.log(`Found historical inspection for ${company}: ${firmName}`);
            window.regulatoryData.historicalInspectionCounts[company] = 
              (window.regulatoryData.historicalInspectionCounts[company] || 0) + 1;
          }
        });
      });
    }
    
    // Create filtered data object with the inspections that match our companies
    const filteredRecentInspections = data.recentInspections.filter(inspection => {
      const legalName = inspection["Legal Name"] || '';
      return companies.some(company => isRelatedCompany(legalName, company));
    });
    
    const filteredHistoricalInspections = data.historicalInspections.filter(inspection => {
      const firmName = inspection["Firm Name"] || '';
      return companies.some(company => isRelatedCompany(firmName, company));
    });
    
    const filteredData = {
      recentInspections: filteredRecentInspections,
      historicalInspections: filteredHistoricalInspections,
      projectAreas: data.projectAreas
    };
    
    console.log("Filtered inspection data:", filteredData);
    
    // Log the current state of form483Counts after processing
    console.log("Current Form 483 counts after processing:", window.regulatoryData.form483Counts);
    
    // Display the filtered data
    displayInspectionData(filteredData);
    
    // If no matches were found, show a message
    if (filteredData.recentInspections.length === 0 && filteredData.historicalInspections.length === 0) {
      elements.inspectionDataSection.innerHTML += `
        <div class="text-center p-4 mt-4">
          <p class="text-sm text-gray-600">No inspection data found for the selected companies.</p>
        </div>
      `;
    }
    
    // Return the filtered data
    return filteredData;
  } catch (error) {
    console.error('Error fetching inspection data:', error);
    elements.inspectionDataSection.innerHTML = `
      <div class="text-center p-4">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mx-auto mb-2 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <p class="text-sm text-red-600">Error loading inspection data: ${error.message}</p>
      </div>
    `;
    
    // Return empty data in case of error
    return {
      recentInspections: [],
      historicalInspections: [],
      projectAreas: []
    };
  }
}




// Add this function to update Form 483 counts from the displayed table
function updateForm483CountsFromDisplayedTable() {
  console.log("Running updateForm483CountsFromDisplayedTable");
  
  // Get all companies from the summary table
  const companyRows = document.querySelectorAll('#company-summary-section tbody tr');
  const companies = Array.from(companyRows).map(row => 
    row.querySelector('td:first-child').textContent.trim()
  );
  
  // Reset the Form 483 counts
  companies.forEach(company => {
    window.regulatoryData.form483Counts[company] = 0;
  });
  
  // Get the Form 483 table
  const form483Table = document.querySelector('#inspection-data table tbody');
  if (!form483Table) {
    console.log("Form 483 table not found");
    return;
  }
  
  // Process each row to count Form 483s for companies
  const rows = form483Table.querySelectorAll('tr');
  rows.forEach(row => {
    const cells = row.querySelectorAll('td');
    if (cells.length >= 3) {
      const legalName = cells[1]?.textContent?.trim() || '';
      const recordType = cells[2]?.textContent?.trim() || '';
      
      
      // Only process if it's a Form 483
      // if (recordType.includes('Form 483')) {
        // Check for each company if this Form 483 belongs to it
        companies.forEach(company => {
          console.log(legalName, company )
          // Simpler check: just see if the company name appears anywhere in the legal name
          // This ensures any 483 containing the company name gets counted for that company
          if (legalName.toLowerCase().includes(company.toLowerCase())) {
            console.log(`Found Form 483 for ${company}: ${legalName}`);
            window.regulatoryData.form483Counts[company] = 
              (window.regulatoryData.form483Counts[company] || 0) + 1;
          }
        });
      // }
    }
  });
  
  console.log("Updated Form 483 counts:", window.regulatoryData.form483Counts);
  
  // Update the summary table with correct counts
  companyRows.forEach(row => {
    const company = row.querySelector('td:first-child').textContent.trim();
    const form483Cell = row.querySelector('td:nth-child(2)');
    const form483Count = window.regulatoryData.form483Counts[company] || 0;
    
    form483Cell.setAttribute('data-form483-count', form483Count);
    
    if (form483Count > 0) {
      form483Cell.innerHTML = `<span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs">${form483Count}</span>`;
    } else {
      form483Cell.textContent = '0';
    }
    
    // Also update total inspections
    const totalCell = row.querySelector('td:nth-child(4)');
    const wlCount = parseInt(row.querySelector('td:nth-child(3)').getAttribute('data-wl-count') || '0');
    const histCount = window.regulatoryData.historicalInspectionCounts[company] || 0;
    const totalCount = form483Count + histCount;
    
    totalCell.setAttribute('data-total-count', totalCount);
    
    if (totalCount > 0) {
      totalCell.innerHTML = `<span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs">${totalCount}</span>`;
    } else {
      totalCell.textContent = '0';
    }
  });
}
  
// Modified function to create company summary directly from the tracked data in the global state
// function createCompanySummaryFromTrackedData(companies, warningLetters, inspections) {
//   console.log("Creating company summary from tracked data for:", companies);
//   console.log("Current Form 483 counts before creating summary:", window.regulatoryData.form483Counts);
  
//   // Create container if it doesn't exist
//   if (!elements.companySummarySection) {
//     elements.companySummarySection = document.createElement('div');
//     elements.companySummarySection.id = 'company-summary-section';
//     elements.companySummarySection.className = 'mb-6';
    
//     // Insert before inspection data section
//     const inspectionDataSection = document.getElementById('inspection-data');
//     if (inspectionDataSection && inspectionDataSection.parentNode) {
//       inspectionDataSection.parentNode.insertBefore(elements.companySummarySection, inspectionDataSection);
//     } else {
//       // If inspection data section doesn't exist, append to FDA data section
//       const fdaDataSection = document.querySelector('.fda-data-section');
//       if (fdaDataSection) {
//         fdaDataSection.appendChild(elements.companySummarySection);
//       }
//     }
//   }
  
//   // Get stats for each company from the global tracking object
//   const companyStats = companies.map(company => {
//     return window.regulatoryData.getCompanyStats(company);
//   });
  
//   // Log the final stats
//   console.log("Final company statistics from tracked data:", companyStats);
  
//   // Create summary HTML
//   let html = `
//     <div class="bg-white rounded-lg shadow-md p-6 mb-6">
//       <div class="flex items-center justify-between mb-4">
//         <h3 class="text-lg font-medium">Company Regulatory Summary</h3>
        
//         <div class="flex space-x-2">
//           <button id="generate-ai-summary" class="text-xs bg-purple-600 hover:bg-purple-700 text-white py-1 px-3 rounded-md flex items-center transition-colors">
//             <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//               <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
//             </svg>
//             Generate AI Summary
//           </button>
          
//           <button id="email-summary-btn" class="text-xs bg-blue-600 hover:bg-blue-700 text-white py-1 px-3 rounded-md flex items-center transition-colors">
//             <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//               <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
//             </svg>
//             Email Summary
//           </button>
//         </div>
//       </div>
      
//       <div class="overflow-x-auto">
//         <table class="min-w-full text-sm">
//           <thead>
//             <tr class="bg-gray-100">
//               <th class="px-4 py-2 text-left">Company</th>
//               <th class="px-4 py-2 text-center">Form 483s</th>
//               <th class="px-4 py-2 text-center">Warning Letters</th>
//               <th class="px-4 py-2 text-center">Total Inspections</th>
//               <th class="px-4 py-2 text-right">Actions</th>
//             </tr>
//           </thead>
//           <tbody>
//             ${companyStats.map(stat => `
//               <tr class="border-b hover:bg-gray-50">
//                 <td class="px-4 py-3 font-medium">${stat.company}</td>
//                 <td class="px-4 py-3 text-center" data-form483-count="${stat.form483Count}">
//                   ${stat.form483Count > 0 
//                     ? `<span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs">${stat.form483Count}</span>` 
//                     : '0'}
//                 </td>
//                 <td class="px-4 py-3 text-center" data-wl-count="${stat.wlCount}">
//                   ${stat.wlCount > 0 
//                     ? `<span class="px-2 py-1 bg-red-100 text-red-800 rounded-full text-xs">${stat.wlCount}</span>` 
//                     : '0'}
//                 </td>
//                 <td class="px-4 py-3 text-center" data-total-count="${stat.totalInspections}">
//                   ${stat.totalInspections > 0 
//                     ? `<span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs">${stat.totalInspections}</span>` 
//                     : '0'}
//                 </td>
//                 <td class="px-4 py-3 text-right">
//                   <div class="flex justify-end space-x-2">
//                     <button class="text-xs px-2 py-1 bg-gray-100 hover:bg-gray-200 text-gray-800 rounded transition-colors view-company-details" 
//                             data-company="${stat.company}">
//                       View Details
//                     </button>
//                     <label class="inline-flex items-center cursor-pointer">
//                       <input type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 company-select-checkbox" 
//                              value="${stat.company}">
//                     </label>
//                   </div>
//                 </td>
//               </tr>
//             `).join('')}
//           </tbody>
//         </table>
//       </div>
      
//       <div class="mt-4 flex justify-between items-center">
//         <div>
//           <button id="analyze-selected-companies" class="text-xs bg-indigo-600 hover:bg-indigo-700 text-white py-1 px-3 rounded-md flex items-center transition-colors" disabled>
//             <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//               <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
//             </svg>
//             Analyze Selected Companies
//           </button>
//         </div>
//         <div class="text-xs text-gray-500">
//           Select companies to perform detailed analysis or generate AI summary
//         </div>
//       </div>
      
//       <!-- AI Analysis Results Section -->
//       <div id="ai-analysis-results" class="mt-6 hidden">
//         <div class="border-t pt-4">
//           <h4 class="text-base font-medium mb-3">AI Analysis Results</h4>
//           <div id="ai-analysis-content" class="bg-gray-50 p-4 rounded-lg">
//             <!-- AI content will be placed here -->
//           </div>
//         </div>
//       </div>
      
//       <!-- Company Details Section -->
//       <div id="company-detail-view" class="mt-6 hidden">
//         <div class="border-t pt-4">
//           <h4 class="text-base font-medium mb-3">Company Details: <span id="company-detail-name"></span></h4>
//           <div id="company-detail-content" class="bg-gray-50 p-4 rounded-lg">
//             <!-- Company detail content will be placed here -->
//           </div>
//         </div>
//       </div>
//     </div>
//   `;
  
//   // Update the section
//   elements.companySummarySection.innerHTML = html;
  
//   // Add event listeners
//   document.querySelectorAll('.company-select-checkbox').forEach(checkbox => {
//     checkbox.addEventListener('change', updateSelectedCompaniesState);
//   });
  
//   document.getElementById('analyze-selected-companies').addEventListener('click', () => {
//     analyzeSelectedCompanies(warningLetters, inspections);
//   });
  
//   document.getElementById('generate-ai-summary').addEventListener('click', WLgenerateAISummary);
//   document.getElementById('email-summary-btn').addEventListener('click', WLemailSummary);
  
//   document.querySelectorAll('.view-company-details').forEach(button => {
//     button.addEventListener('click', function() {
//       const company = this.getAttribute('data-company');
//       WLshowCompanyDetails(company, warningLetters, inspections);
//     });
//   });
// }
// Modified function to create company summary with toggle for empty results
function createCompanySummaryFromTrackedData(companies, warningLetters, inspections) {
  console.log("Creating company summary from tracked data for:", companies);
  console.log("Current Form 483 counts before creating summary:", window.regulatoryData.form483Counts);
  
  // Create container if it doesn't exist
  if (!elements.companySummarySection) {
    elements.companySummarySection = document.createElement('div');
    elements.companySummarySection.id = 'company-summary-section';
    elements.companySummarySection.className = 'mb-6';
    
    // Insert before inspection data section
    const inspectionDataSection = document.getElementById('inspection-data');
    if (inspectionDataSection && inspectionDataSection.parentNode) {
      inspectionDataSection.parentNode.insertBefore(elements.companySummarySection, inspectionDataSection);
    } else {
      // If inspection data section doesn't exist, append to FDA data section
      const fdaDataSection = document.querySelector('.fda-data-section');
      if (fdaDataSection) {
        fdaDataSection.appendChild(elements.companySummarySection);
      }
    }
  }
  
  // Get stats for each company from the global tracking object
  const companyStats = companies.map(company => {
    return window.regulatoryData.getCompanyStats(company);
  });
  
  // Separate companies with findings from those without
  const companiesWithFindings = companyStats.filter(stat => 
    stat.form483Count > 0 || stat.wlCount > 0 || stat.totalInspections > 0
  );
  
  const companiesWithoutFindings = companyStats.filter(stat => 
    stat.form483Count === 0 && stat.wlCount === 0 && stat.totalInspections === 0
  );
  
  // Track the visibility state of companies without findings
  window.showEmptyCompanies = window.showEmptyCompanies || false;
  
  // Log the final stats
  console.log("Companies with findings:", companiesWithFindings);
  console.log("Companies without findings:", companiesWithoutFindings);
  
  // Create company row HTML function
  const createCompanyRow = (stat) => `
    <tr class="border-b hover:bg-gray-50" data-has-findings="${stat.form483Count > 0 || stat.wlCount > 0 || stat.totalInspections > 0}">
      <td class="px-4 py-3 font-medium">${stat.company}</td>
      <td class="px-4 py-3 text-center" data-form483-count="${stat.form483Count}">
        ${stat.form483Count > 0 
          ? `<span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs">${stat.form483Count}</span>` 
          : '<span class="text-gray-400">0</span>'}
      </td>
      <td class="px-4 py-3 text-center" data-wl-count="${stat.wlCount}">
        ${stat.wlCount > 0 
          ? `<span class="px-2 py-1 bg-red-100 text-red-800 rounded-full text-xs">${stat.wlCount}</span>` 
          : '<span class="text-gray-400">0</span>'}
      </td>
      <td class="px-4 py-3 text-center" data-total-count="${stat.totalInspections}">
        ${stat.totalInspections > 0 
          ? `<span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs">${stat.totalInspections}</span>` 
          : '<span class="text-gray-400">0</span>'}
      </td>
      <td class="px-4 py-3 text-right">
        <div class="flex justify-end space-x-2">
          <button class="text-xs px-2 py-1 bg-gray-100 hover:bg-gray-200 text-gray-800 rounded transition-colors view-company-details" 
                  data-company="${stat.company}">
            View Details
          </button>
          <label class="inline-flex items-center cursor-pointer">
            <input type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 company-select-checkbox" 
                   value="${stat.company}">
          </label>
        </div>
      </td>
    </tr>
  `;
  
  // Create summary HTML
  let html = `
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-medium">Company Regulatory Summary</h3>
        
        <div class="flex space-x-2">
          <button id="generate-ai-summary" class="text-xs bg-purple-600 hover:bg-purple-700 text-white py-1 px-3 rounded-md flex items-center transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
            </svg>
            Generate AI Summary
          </button>
          
          <button id="email-summary-btn" class="text-xs bg-blue-600 hover:bg-blue-700 text-white py-1 px-3 rounded-md flex items-center transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
            </svg>
            Email Summary
          </button>
        </div>
      </div>
      
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead>
            <tr class="bg-gray-100">
              <th class="px-4 py-2 text-left">Company</th>
              <th class="px-4 py-2 text-center">Form 483s</th>
              <th class="px-4 py-2 text-center">Warning Letters</th>
              <th class="px-4 py-2 text-center">Total Inspections</th>
              <th class="px-4 py-2 text-right">Actions</th>
            </tr>
          </thead>
          <tbody id="company-summary-table-body">
            ${companiesWithFindings.map(createCompanyRow).join('')}
            ${companiesWithoutFindings.map(stat => `
              <tr class="border-b hover:bg-gray-50 empty-company-row ${window.showEmptyCompanies ? '' : 'hidden'}" data-has-findings="false">
                ${createCompanyRow(stat).substring(createCompanyRow(stat).indexOf('>')+1)}
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
      
      <div class="mt-4 flex justify-between items-center">
        <div class="flex space-x-3">
          <button id="analyze-selected-companies" class="hidden text-xs bg-indigo-600 hover:bg-indigo-700 text-white py-1 px-3 rounded-md flex items-center transition-colors" disabled>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
            </svg>
            Analyze Selected Companies
          </button>
          
          <div class="flex items-center">
            <label class="inline-flex items-center cursor-pointer">
              <input type="checkbox" id="toggle-empty-companies" class="form-checkbox h-4 w-4 text-blue-600" ${window.showEmptyCompanies ? 'checked' : ''}>
              <span class="ml-2 text-xs text-gray-600">Show companies with no findings (${companiesWithoutFindings.length})</span>
            </label>
          </div>
        </div>
        
        <div class="text-xs text-gray-500">
          Showing ${companiesWithFindings.length} companies with findings${window.showEmptyCompanies ? ` and ${companiesWithoutFindings.length} without` : ''}
        </div>
      </div>
      
      <!-- AI Analysis Results Section -->
      <div id="ai-analysis-results" class="mt-6 hidden">
        <div class="border-t pt-4">
          <h4 class="text-base font-medium mb-3">AI Analysis Results</h4>
          <div id="ai-analysis-content" class="bg-gray-50 p-4 rounded-lg">
            <!-- AI content will be placed here -->
          </div>
        </div>
      </div>
      
      <!-- Company Details Section -->
      <div id="company-detail-view" class="mt-6 hidden">
        <div class="border-t pt-4">
          <h4 class="text-base font-medium mb-3">Company Details: <span id="company-detail-name"></span></h4>
          <div id="company-detail-content" class="bg-gray-50 p-4 rounded-lg">
            <!-- Company detail content will be placed here -->
          </div>
        </div>
      </div>
    </div>
  `;
  
  // Update the section
  elements.companySummarySection.innerHTML = html;
  
  // Add event listeners
  document.querySelectorAll('.company-select-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', updateSelectedCompaniesState);
    checkbox.classList.add('hidden')
  });
  
  document.getElementById('analyze-selected-companies').addEventListener('click', () => {
    analyzeSelectedCompanies(warningLetters, inspections);
  });
  
  document.getElementById('generate-ai-summary').addEventListener('click', WLgenerateAISummary);

  document.getElementById('generate-ai-summary').addEventListener('click', () => {
  // Retrieve drug name from input field
//   const drugName = document.getElementById('drug-name-input').value.trim();
  
  // Optional: Use a stored variable if input might be cleared
  const drugName = window.currentDrugName || '';

  // Validate drug name
  if (!drugName) {
    alert('Please enter a drug name and search Orange Book first');
    return;
  }

  // Validate companies
  const companies = Array.from(document.querySelectorAll('#company-summary-section tbody tr')).map(row => 
    row.querySelector('td:first-child').textContent.trim()
  );
  if (companies.length === 0) {
    alert('No companies found. Please search Orange Book first.');
    return;
  }

  // Call WLgenerateAISummary with drugName
  WLgenerateAISummary(drugName);
});


  document.getElementById('email-summary-btn').addEventListener('click', WLemailSummary);
  
  document.querySelectorAll('.view-company-details').forEach(button => {
    button.addEventListener('click', function() {
      const company = this.getAttribute('data-company');
      WLshowCompanyDetails(company, warningLetters, inspections);
    });
  });
  
  // Add toggle functionality for empty companies
  document.getElementById('toggle-empty-companies').addEventListener('change', function() {
    window.showEmptyCompanies = this.checked;
    document.querySelectorAll('.empty-company-row').forEach(row => {
      if (window.showEmptyCompanies) {
        row.classList.remove('hidden');
      } else {
        row.classList.add('hidden');
      }
    });
    
    // Update the counter text
    const countText = document.querySelector('.text-xs.text-gray-500');
    if (countText) {
      countText.textContent = `Showing ${companiesWithFindings.length} companies with findings${window.showEmptyCompanies ? ` and ${companiesWithoutFindings.length} without` : ''}`;
    }
  });
}
  
  // Function to display warning letters with pagination
  function displayWarningLetters(data, companies, filters = {}) {
    const letters = data.results || [];
    const totalCount = data.total || 0;
    const currentPage = data.page || 1;
    const pageSize = data.pageSize || 10;
    
    // Update counter
    elements.warningLettersCount.textContent = `${totalCount} letters`;
    elements.warningLettersCount.style.display = "inline-flex";
    
    if (letters.length === 0) {
      elements.warningLettersData.innerHTML = `
        <div class="text-center p-4">
          <p class="text-sm text-gray-700">No warning letters found for ${companies.length > 1 ? 'these companies' : 'this company'}: ${companies.join(", ")}</p>
        </div>
      `;
      return;
    }
    
    // Get unique issuing offices for filter
    const issuingOffices = [...new Set(letters.map(letter => letter.issuingOffice))].filter(Boolean);
    
    // Determine which letters are veterinary vs human
    const isVeterinary = letter => {
      const vetKeywords = ['animal', 'vet', 'veterinary', 'livestock', 'pet', 'cattle', 'poultry', 'swine', 'equine', 'fish', 'aquatic', 'cow', 'horse', 'dog', 'cat'];
      const title = (letter.companyName || '').toLowerCase();
      const subject = (letter.subject || '').toLowerCase();
      const content = (letter.fullContent || '').toLowerCase();
      
      return vetKeywords.some(keyword => 
        title.includes(keyword) || 
        subject.includes(keyword) || 
        content.includes(keyword)
      );
    };
    
    // Calculate total pages
    const totalPages = Math.ceil(totalCount / pageSize);
    
    // Create HTML for warning letters section
    let html = `
      <div>
        <!-- Filter controls -->
        <div class="mb-4">
          <div class="flex flex-wrap items-center justify-between gap-3">
            <div class="flex flex-wrap gap-2">
              <div>
                <select id="warning-letters-type-filter" class="text-xs rounded border border-gray-300 py-1 px-2 focus:outline-none focus:ring-1 focus:ring-blue-500">
                  <option value="all" ${!filters.type ? 'selected' : ''}>All Types</option>
                  <option value="human" ${filters.type === 'human' ? 'selected' : ''}>Human</option>
                  <option value="veterinary" ${filters.type === 'veterinary' ? 'selected' : ''}>Veterinary</option>
                </select>
              </div>
              <div>
                <select id="warning-letters-office-filter" class="text-xs rounded border border-gray-300 py-1 px-2 focus:outline-none focus:ring-1 focus:ring-blue-500">
                  <option value="all" ${!filters.issuingOffice ? 'selected' : ''}>All Offices</option>
                  ${issuingOffices.map(office => `<option value="${office}" ${filters.issuingOffice === office ? 'selected' : ''}>${office}</option>`).join('')}
                </select>
              </div>
              <div>
                <select id="warning-letters-page-size" class="text-xs rounded border border-gray-300 py-1 px-2 focus:outline-none focus:ring-1 focus:ring-blue-500">
                  <option value="10" ${pageSize === 10 ? 'selected' : ''}>10 per page</option>
                  <option value="25" ${pageSize === 25 ? 'selected' : ''}>25 per page</option>
                  <option value="50" ${pageSize === 50 ? 'selected' : ''}>50 per page</option>
                </select>
              </div>
            </div>
            
            <button id="apply-warning-letter-filters" class="text-xs bg-blue-600 hover:bg-blue-700 text-white font-medium py-1 px-3 rounded transition-colors">
              Apply Filters
            </button>
          </div>
        </div>
        
        <!-- Warning letters list -->
        <div id="warning-letters-list" class="space-y-3">
    `;
    
    // Add each warning letter
    letters.forEach(letter => {
      // Determine if veterinary or human
      const letterType = isVeterinary(letter) ? 'veterinary' : 'human';
      
      html += `
        <div class="warning-letter-item bg-white border border-gray-200 hover:border-blue-300 rounded-lg p-4 transition-all hover:shadow-md" 
             data-id="${letter.id || letter.letterId}" 
             data-type="${letterType}" 
             data-office="${letter.issuingOffice || ''}"
             data-source-company="${letter.sourceCompany}">
          <div class="flex flex-wrap justify-between items-start gap-2">
            <h5 class="text-sm font-medium text-gray-900">${letter.companyName || 'Unknown Company'}</h5>
            <div class="flex flex-wrap gap-2">
              <span class="text-xs px-2 py-1 rounded-full ${letterType === 'veterinary' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}">
                ${letterType === 'veterinary' ? 'Veterinary' : 'Human'}
              </span>
              <span class="text-xs px-2 py-1 bg-gray-100 text-gray-800 rounded-full">
                ${WlformatDate(letter.letterIssueDate)}
              </span>
            </div>
          </div>
          
          <p class="mt-1 text-xs text-gray-500">${letter.issuingOffice || 'Unknown Office'}</p>
          <p class="mt-1 text-xs text-gray-500">Source Company: ${letter.sourceCompany}</p>
          <p class="mt-2 text-xs font-medium text-gray-700">${letter.subject || 'No subject provided'}</p>
          
          <div class="mt-2 text-xs text-gray-600 line-clamp-2">
            ${highlightSearchTerm(letter.excerpt || '', letter.sourceCompany)}
          </div>
          
          <div class="mt-3 flex justify-between items-center">
            <button class="text-xs text-blue-600 hover:text-blue-800 hover:underline view-warning-letter" data-id="${letter.id || letter.letterId}">
              View Details
            </button>
            ${letter.companyUrl ? `
              <a href="${letter.companyUrl}" target="_blank" class="text-xs text-gray-600 hover:text-gray-800 hover:underline flex items-center">
                View on FDA Website
                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 inline-block ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                </svg>
              </a>
            ` : ''}
          </div>
        </div>
      `;
    });
    
    // Pagination controls
    html += `
        </div>
        
        <!-- Pagination -->
        <div class="mt-6 flex justify-between items-center">
          <div class="text-xs text-gray-600">
            Showing ${letters.length > 0 ? (currentPage - 1) * pageSize + 1 : 0} to ${Math.min(currentPage * pageSize, totalCount)} of ${totalCount} results
          </div>
          
          <div class="flex space-x-1" id="warning-letters-pagination">
      `;
      
    // Previous button
    html += `
      <button class="pagination-btn text-xs px-2 py-1 rounded border ${currentPage === 1 ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'bg-white text-blue-600 hover:bg-blue-50'}" 
              data-page="prev" ${currentPage === 1 ? 'disabled' : ''}>
        Previous
      </button>
    `;
    
    // Calculate range of pages to show (show max 5 pages)
    let startPage = Math.max(1, currentPage - 2);
    let endPage = Math.min(totalPages, startPage + 4);
    
    // Adjust if near end
    if (endPage - startPage < 4) {
      startPage = Math.max(1, endPage - 4);
    }
    
    // Page numbers
    for (let i = startPage; i <= endPage; i++) {
      html += `
        <button class="pagination-btn text-xs px-3 py-1 rounded border ${i === currentPage ? 'bg-blue-500 text-white' : 'bg-white text-blue-600 hover:bg-blue-50'}" 
                data-page="${i}">
          ${i}
        </button>
      `;
    }
    
    // Next button
    html += `
        <button class="pagination-btn text-xs px-2 py-1 rounded border ${currentPage === totalPages || totalPages === 0 ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'bg-white text-blue-600 hover:bg-blue-50'}" 
                data-page="next" ${currentPage === totalPages || totalPages === 0 ? 'disabled' : ''}>
          Next
        </button>
      </div>
    </div>
  </div>
    `;
    
    // Update the warning letters section
    elements.warningLettersData.innerHTML = html;
    
    // Add event listeners for warning letter detail view
    document.querySelectorAll('.view-warning-letter').forEach(button => {
      button.addEventListener('click', function() {
        const letterId = this.getAttribute('data-id');
        viewWarningLetterDetails(letterId, companies.join("|")); // Pass companies for highlighting
      });
    });
    
    // Add event listeners for pagination buttons
    document.querySelectorAll('#warning-letters-pagination .pagination-btn').forEach(button => {
      button.addEventListener('click', function() {
        if (this.disabled) return;
        
        const page = this.getAttribute('data-page');
        let newPage = currentPage;
        
        if (page === 'prev' && currentPage > 1) {
          newPage = currentPage - 1;
        } else if (page === 'next' && currentPage < totalPages) {
          newPage = currentPage + 1;
        } else if (page !== 'prev' && page !== 'next') {
          newPage = parseInt(page);
        }
        
        if (newPage !== currentPage) {
          fetchWarningLettersWithTracking(companies, newPage, pageSize, filters);
        }
      });
    });
    
    // Add event listener for apply filters button
    document.getElementById('apply-warning-letter-filters').addEventListener('click', function() {
      // Get filter values
      const typeFilter = document.getElementById('warning-letters-type-filter').value;
      const officeFilter = document.getElementById('warning-letters-office-filter').value;
      const newPageSize = parseInt(document.getElementById('warning-letters-page-size').value);
      
      // Create filters object
      const newFilters = {};
      if (typeFilter !== 'all') newFilters.type = typeFilter;
      if (officeFilter !== 'all') newFilters.issuingOffice = officeFilter;
      
      // Fetch with new filters, reset to page 1
      fetchWarningLettersWithTracking(companies, 1, newPageSize, newFilters);
    });
  }
  
  // Function to view warning letter details
  async function viewWarningLetterDetails(letterId, companies) {
    try {
      // Show loading modal
      showWarningLetterModal(`
        <div class="flex justify-center items-center py-12">
          <svg class="animate-spin h-8 w-8 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          <span class="ml-2">Loading warning letter details...</span>
        </div>
      `);
      
      // Fetch the warning letter details
      const response = await fetch(`${API_BASE_URL}/wl/letter/${letterId}`);
      
      if (!response.ok) {
        throw new Error(`Error fetching warning letter details: ${response.status}`);
      }
      
      const letter = await response.json();
      
      // Format the letter content
      let contentHtml = '';
      
      if (letter.fullContent) {
        // Highlight all company names
        contentHtml = companies.split("|").reduce((text, company) => {
          if (company && company.trim()) {
            return highlightSearchTerm(text, company.trim());
          }
          return text;
        }, letter.fullContent);
      } else {
        contentHtml = '<p class="text-gray-500">No letter content available.</p>';
      }
      
      // Show warning letter details in modal
      showWarningLetterModal(`
        <div>
          <div class="border-b pb-4 mb-4">
            <div class="flex justify-between items-start">
              <h3 class="text-xl font-semibold">${letter.companyName || 'Unknown Company'}</h3>
              <div class="flex space-x-2">
                ${letter.companyUrl ? `
                  <a href="${letter.companyUrl}" target="_blank" class="text-xs bg-blue-50 text-blue-600 hover:bg-blue-100 px-3 py-1 rounded transition-colors">
                    View on FDA Website
                  </a>
                ` : ''}
              </div>
            </div>
            
            <div class="mt-2 grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
              <div>
                <p class="text-gray-500">Letter ID:</p>
                <p>${letter.letterId || 'N/A'}</p>
              </div>
              <div>
                <p class="text-gray-500">Issue Date:</p>
                <p>${WlformatDate(letter.letterIssueDate)}</p>
              </div>
              <div>
                <p class="text-gray-500">Issuing Office:</p>
                <p>${letter.issuingOffice || 'N/A'}</p>
              </div>
            </div>
            
            <div class="mt-4">
              <p class="text-gray-500">Subject:</p>
              <p>${letter.subject || 'No subject provided'}</p>
            </div>
          </div>
          
          <div class="mb-4">
            <h4 class="text-lg font-medium mb-2">Letter Content</h4>
            <div class="bg-gray-50 p-4 rounded-md max-h-96 overflow-y-auto custom-scrollbar text-sm whitespace-pre-line">
              ${contentHtml}
            </div>
          </div>
          
          ${letter.companyUrl ? `
            <div class="flex justify-center">
              <a href="${letter.companyUrl}" target="_blank" class="text-blue-600 hover:text-blue-800 text-sm flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                </svg>
                View complete warning letter on FDA website
              </a>
            </div>
          ` : ''}
        </div>
      `, letter.companyName || 'Warning Letter Details');
      
      // Scroll to first highlighted company name
      if (companies) {
        setTimeout(() => {
          const firstHighlight = document.querySelector('.highlight');
          if (firstHighlight) {
            firstHighlight.scrollIntoView({ behavior: 'smooth', block: 'center' });
            firstHighlight.classList.add('animate-pulse');
            setTimeout(() => {
              firstHighlight.classList.remove('animate-pulse');
            }, 2000);
          }
        }, 500);
      }
    } catch (error) {
      console.error('Error fetching warning letter details:', error);
      showWarningLetterModal(`
        <div class="text-center text-red-500 p-8">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <h3 class="text-lg font-medium mb-2">Error Loading Warning Letter</h3>
          <p class="text-sm text-gray-600">We couldn't load the warning letter details. Please try again later.</p>
        </div>
      `, 'Error');
    }
  }
  
  // Function to show warning letter modal
  function showWarningLetterModal(content, title = 'Warning Letter Details') {
    // Check if modal already exists
    let modal = document.getElementById('warning-letter-modal');
    
    if (!modal) {
      // Create modal if it doesn't exist
      modal = document.createElement('div');
      modal.id = 'warning-letter-modal';
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      modal.setAttribute('role', 'dialog');
      modal.setAttribute('aria-modal', 'true');
      
      // Build modal HTML
      modal.innerHTML = `
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col">
          <div class="flex justify-between items-center p-4 border-b border-gray-200 sticky top-0 bg-white z-10">
            <h2 class="text-xl font-semibold" id="warning-letter-modal-title">${title}</h2>
            <button id="close-warning-letter-modal" class="text-gray-400 hover:text-gray-600 p-1 rounded-full hover:bg-gray-100">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
          
          <div class="overflow-y-auto p-6 flex-grow" id="warning-letter-modal-content">
            ${content}
          </div>
        </div>
      `;
      
      // Add to document
      document.body.appendChild(modal);
      
      // Add event listener to close button
      document.getElementById('close-warning-letter-modal').addEventListener('click', closeWarningLetterModal);
      
      // Close on click outside content
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          closeWarningLetterModal();
        }
      });
      
      // Close on ESC key
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && document.getElementById('warning-letter-modal')) {
          closeWarningLetterModal();
        }
      });
    } else {
      // Update modal content
      document.getElementById('warning-letter-modal-title').textContent = title;
      document.getElementById('warning-letter-modal-content').innerHTML = content;
      
      // Show the modal
      modal.classList.remove('hidden');
      modal.style.display = 'flex';
    }
    
    // Prevent body scrolling
    document.body.style.overflow = 'hidden';
  }
  
  // Function to close warning letter modal
  function closeWarningLetterModal() {
    const modal = document.getElementById('warning-letter-modal');
    if (modal) {
      modal.classList.add('hidden');
      modal.style.display = 'none';
      
      // Allow body scrolling again
      document.body.style.overflow = '';
    }
  }
  
  // Helper function to highlight search terms in text
  function highlightSearchTerm(text, searchTerm) {
    if (!text || !searchTerm) return text;
    
    // Escape special characters in the search term
    const escapedSearchTerm = searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    
    // Create a regular expression to find the search term
    const regex = new RegExp(`(${escapedSearchTerm})`, 'gi');
    
    // Replace matches with highlighted spans
    return text.replace(regex, '<span class="highlight bg-yellow-200 px-0.5 rounded">$1</span>');
  }
  
  // Display inspection data function
  function displayInspectionData(data) {
    const { recentInspections, historicalInspections, projectAreas } = data;
  
    // Create HTML for the inspection data section
    let html = `
      <div class="mb-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-medium">Form 483s</h3>
          <span class="text-xs px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full">${recentInspections.length} ${recentInspections.length === 1 ? 'form' : 'forms'}</span>
        </div>
        
        ${recentInspections.length > 0 ? `
          <div class="overflow-x-auto">
            <table class="min-w-full text-sm bg-white rounded-lg shadow">
              <thead>
                <tr class="bg-gray-100 border-b">
                  <th class="px-4 py-2 text-left">Date</th>
                  <th class="px-4 py-2 text-left">Legal Name</th>
                  <th class="px-4 py-2 text-left">Record Type</th>
                  <th class="px-4 py-2 text-left">FEI Number</th>
                  <th class="px-4 py-2 text-left">Actions</th>
                </tr>
              </thead>
              <tbody>
                ${recentInspections.map(inspection => `
                  <tr class="border-b hover:bg-gray-50">
                    <td class="px-4 py-3">${WlformatDate(inspection["Record Date"])}</td>
                    <td class="px-4 py-3">${inspection["Legal Name"] || 'N/A'}</td>
                    <td class="px-4 py-3">
                      <span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs">
                        ${inspection["Record Type"] || 'N/A'}
                      </span>
                    </td>
                    <td class="px-4 py-3">${inspection["FEI Number"] || 'N/A'}</td>
                    <td class="px-4 py-3">
                      ${inspection["Download"] ? `
                        <a href="${inspection["Download"]}" target="_blank" class="text-blue-600 hover:text-blue-800 text-xs flex items-center">
                          Download
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 inline-block ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                          </svg>
                        </a>
                      ` : 'Not available'}
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        ` : `
          <div class="text-center p-4 bg-gray-50 rounded">
            <p class="text-sm text-gray-600">No Form 483s found for the selected criteria.</p>
          </div>
        `}
      </div>
      
      <div>
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-medium">Historical Inspections</h3>
          <div class="flex items-center space-x-2">
            <span class="text-xs px-2 py-1 bg-blue-100 text-blue-800 rounded-full">
              ${historicalInspections.length} ${historicalInspections.length === 1 ? 'inspection' : 'inspections'}
            </span>
            
            <!-- Filter controls -->
            <div class="relative">
              <select id="project-area-filter" class="text-xs rounded border border-gray-300 py-1 px-2 focus:outline-none focus:ring-1 focus:ring-blue-500">
                <option value="all">All Project Areas</option>
                ${projectAreas.map(area => `<option value="${area}">${area}</option>`).join('')}
              </select>
            </div>
          </div>
        </div>
        
        <!-- Pagination controls -->
        <div class="flex justify-between items-center mb-3">
          <div class="flex items-center">
            <label class="text-xs text-gray-600 mr-2">Show:</label>
            <select id="historical-page-size" class="text-xs rounded border border-gray-300 py-1 px-2 focus:outline-none focus:ring-1 focus:ring-blue-500">
              <option value="10">10</option>
              <option value="25">25</option>
              <option value="50">50</option>
              <option value="100">100</option>
            </select>
          </div>
          
          <div class="flex items-center" id="historical-pagination">
            <!-- Pagination buttons will be added here -->
          </div>
        </div>
      
      ${historicalInspections.length > 0 ? `
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm bg-white rounded-lg shadow">
            <thead>
              <tr class="bg-gray-100 border-b">
                <th class="px-4 py-2 text-left">Firm Name</th>
                <th class="px-4 py-2 text-left">City</th>
                <th class="px-4 py-2 text-left">State</th>
                <th class="px-4 py-2 text-left">Country</th>
                <th class="px-4 py-2 text-left">Inspection Date</th>
                <th class="px-4 py-2 text-left">Project Area</th>
                <th class="px-4 py-2 text-left">Classification</th>
              </tr>
            </thead>
            <tbody id="historical-inspections-table">
              <!-- Table content will be dynamically updated -->
            </tbody>
          </table>
        </div>
      ` : `
        <div class="text-center p-4 bg-gray-50 rounded">
          <p class="text-sm text-gray-600">No historical inspections found for the selected criteria.</p>
        </div>
      `}
      
      <div id="historical-no-results" class="hidden text-center p-4 bg-gray-50 rounded mt-3">
        <p class="text-sm text-gray-600">No inspections match the current filter criteria.</p>
      </div>
    </div>
  `;

  // Update the inspection data section
  elements.inspectionDataSection.innerHTML = html;

  // If we have historical inspections, initialize the table with pagination
  if (historicalInspections.length > 0) {
    initHistoricalInspectionsTable(historicalInspections);
    
    // Add event listener for project area filter
    document.getElementById('project-area-filter').addEventListener('change', function() {
      filterHistoricalInspections(historicalInspections);
    });
    
    // Add event listener for page size change
    document.getElementById('historical-page-size').addEventListener('change', function() {
      filterHistoricalInspections(historicalInspections);
    });
  }
}

  // Variables to track pagination state
  let currentHistoricalPage = 1;
  let historicalPageSize = 10;
  let filteredHistoricalInspections = [];
  
  // Function to initialize the historical inspections table
  function initHistoricalInspectionsTable(inspections) {
    // Set default filtered inspections
    filteredHistoricalInspections = [...inspections];
    
    // Apply initial filtering
    filterHistoricalInspections(inspections);
  }
  
  // Function to filter and paginate historical inspections
  function filterHistoricalInspections(inspections) {
    // Get filter value
    const projectAreaFilter = document.getElementById('project-area-filter').value;
    
    // Get page size
    historicalPageSize = parseInt(document.getElementById('historical-page-size').value);
    
    // Reset to first page when filter changes
    currentHistoricalPage = 1;
    
    // Apply filters
    filteredHistoricalInspections = inspections.filter(inspection => {
      return projectAreaFilter === 'all' || inspection["Project Area"] === projectAreaFilter;
    });
    
    // Update pagination
    updateHistoricalPagination();
    
    // Show/hide no results message
    const noResultsEl = document.getElementById('historical-no-results');
    if (noResultsEl) {
      if (filteredHistoricalInspections.length === 0) {
        noResultsEl.classList.remove('hidden');
      } else {
        noResultsEl.classList.add('hidden');
      }
    }
    
    // Calculate start and end indexes for current page
    const startIndex = (currentHistoricalPage - 1) * historicalPageSize;
    const endIndex = startIndex + historicalPageSize;
    
    // Get current page items
    const currentPageItems = filteredHistoricalInspections.slice(startIndex, endIndex);
    
    // Get table element
    const tableEl = document.getElementById('historical-inspections-table');
    if (!tableEl) return;
    
    // Generate table rows HTML
    const tableHtml = currentPageItems.map(inspection => `
      <tr class="border-b hover:bg-gray-50">
        <td class="px-4 py-3">${inspection["Firm Name"] || 'N/A'}</td>
        <td class="px-4 py-3">${inspection["City"] || 'N/A'}</td>
        <td class="px-4 py-3">${inspection["State"] || 'N/A'}</td>
        <td class="px-4 py-3">${inspection["Country/Area"] || 'N/A'}</td>
        <td class="px-4 py-3">${WlformatDate(inspection["Inspection End Date"])}</td>
        <td class="px-4 py-3">
          <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs">
            ${inspection["Project Area"] || 'N/A'}
          </span>
        </td>
        <td class="px-4 py-3">
          <span class="px-2 py-1 ${getClassificationColor(inspection["Inspection Classification"])} rounded-full text-xs">
            ${inspection["Inspection Classification"] || 'N/A'}
          </span>
        </td>
      </tr>
    `).join('');
    
    // Update table content
    tableEl.innerHTML = tableHtml;
  }
  
  // Function to update historical pagination controls
  function updateHistoricalPagination() {
    const paginationEl = document.getElementById('historical-pagination');
    if (!paginationEl) return;
    
    const totalItems = filteredHistoricalInspections.length;
    const totalPages = Math.ceil(totalItems / historicalPageSize);
    
    // Don't show pagination if only one page
    if (totalPages <= 1) {
      paginationEl.innerHTML = '';
      return;
    }
    
    // Calculate range of pages to show (show max 5 pages)
    let startPage = Math.max(1, currentHistoricalPage - 2);
    let endPage = Math.min(totalPages, startPage + 4);
    
    // Adjust if near end
    if (endPage - startPage < 4) {
      startPage = Math.max(1, endPage - 4);
    }
    
    // Create pagination HTML
    let paginationHtml = `
      <button class="pagination-btn text-xs px-2 py-1 rounded border ${currentHistoricalPage === 1 ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'bg-white text-blue-600 hover:bg-blue-50'}" 
              data-page="prev" ${currentHistoricalPage === 1 ? 'disabled' : ''}>
        Previous
      </button>
    `;
    
    // Add page numbers
    for (let i = startPage; i <= endPage; i++) {
        paginationHtml += `
          <button class="pagination-btn text-xs px-3 py-1 rounded border ml-1 ${i === currentHistoricalPage ? 'bg-blue-500 text-white' : 'bg-white text-blue-600 hover:bg-blue-50'}" 
                  data-page="${i}">
            ${i}
          </button>
        `;
      }
      
      paginationHtml += `
        <button class="pagination-btn text-xs px-2 py-1 rounded border ml-1 ${currentHistoricalPage === totalPages ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'bg-white text-blue-600 hover:bg-blue-50'}" 
                data-page="next" ${currentHistoricalPage === totalPages ? 'disabled' : ''}>
          Next
        </button>
      `;
      
      // Update pagination controls
      paginationEl.innerHTML = paginationHtml;
      
      // Add event listeners to pagination buttons
      document.querySelectorAll('.pagination-btn').forEach(button => {
        button.addEventListener('click', function() {
          const page = this.getAttribute('data-page');
          
          if (page === 'prev' && currentHistoricalPage > 1) {
            currentHistoricalPage--;
          } else if (page === 'next' && currentHistoricalPage < totalPages) {
            currentHistoricalPage++;
          } else if (page !== 'prev' && page !== 'next') {
            currentHistoricalPage = parseInt(page);
          }
          
          // Re-render with new page
          filterHistoricalInspections(filteredHistoricalInspections);
        });
      });
    }
    
    // Helper function to get color for inspection classification
    function getClassificationColor(classification) {
      switch (classification) {
        case 'NAI': // No Action Indicated
          return 'bg-green-100 text-green-800';
        case 'VAI': // Voluntary Action Indicated
          return 'bg-yellow-100 text-yellow-800';
        case 'OAI': // Official Action Indicated
          return 'bg-red-100 text-red-800';
        default:
          return 'bg-gray-100 text-gray-800';
      }
    }
    
    // Function to update the state of selected companies
    function updateSelectedCompaniesState() {
      const checkboxes = document.querySelectorAll('.company-select-checkbox:checked');
      const analyzeButton = document.getElementById('analyze-selected-companies');
      
      if (checkboxes.length > 0) {
        analyzeButton.removeAttribute('disabled');
      } else {
        analyzeButton.setAttribute('disabled', true);
      }
    }
    
    // Function to analyze selected companies
    async function analyzeSelectedCompanies(warningLetters, inspections) {
      const selectedCompanies = Array.from(
        document.querySelectorAll('.company-select-checkbox:checked')
      ).map(checkbox => checkbox.value);
      
      if (selectedCompanies.length === 0) return;
      
      // Show loading state
      const aiResults = document.getElementById('ai-analysis-results');
      aiResults.classList.remove('hidden');
      
      document.getElementById('ai-analysis-content').innerHTML = `
        <div class="flex justify-center items-center py-8">
          <svg class="animate-spin h-6 w-6 text-purple-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          <span class="ml-2 text-gray-600">Analyzing regulatory history of selected companies...</span>
        </div>
      `;
      
      try {
        // Filter data for selected companies
        const selectedCompanyData = {
          warningLetters: warningLetters.filter(letter => 
            selectedCompanies.some(company => 
              (letter.sourceCompany && letter.sourceCompany === company) || 
              (letter.companyName && letter.companyName.toLowerCase().includes(company.toLowerCase()))
            )
          ),
          form483s: inspections.recentInspections.filter(inspection => 
            inspection["Record Type"] === "483" && 
            selectedCompanies.some(company => 
              inspection["Legal Name"] && inspection["Legal Name"].toLowerCase().includes(company.toLowerCase())
            )
          ),
          historicalInspections: inspections.historicalInspections.filter(inspection => 
            selectedCompanies.some(company => 
              inspection["Firm Name"] && inspection["Firm Name"].toLowerCase().includes(company.toLowerCase())
            )
          )
        };
        
        // Generate analysis content based on available data
        let summary = '';
        let correlation = '';
        let recommendations = '';
        
        // Check if we have enough data for analysis
        if (selectedCompanyData.warningLetters.length > 0 || 
            selectedCompanyData.form483s.length > 0 || 
            selectedCompanyData.historicalInspections.length > 0) {
          
          // Generate summary based on available data
          summary = generateSummary(selectedCompanyData, selectedCompanies);
          
          // Generate correlation analysis if we have both warning letters and form 483s
          if (selectedCompanyData.warningLetters.length > 0 && selectedCompanyData.form483s.length > 0) {
            correlation = generateCorrelationAnalysis(selectedCompanyData);
          }
          
          // Generate recommendations
          recommendations = generateRecommendations(selectedCompanyData, selectedCompanies);
        } else {
          summary = "No regulatory data found for the selected companies. Try selecting different companies or expanding your search criteria.";
        }
        
        // Display the AI analysis results
        document.getElementById('ai-analysis-content').innerHTML = `
          <div class="prose prose-sm max-w-none">
            <h5 class="text-base font-medium mb-2">Analysis for ${selectedCompanies.join(', ')}</h5>
            
            <div class="mb-4">
              <h6 class="text-sm font-medium mb-1">Summary</h6>
              <p>${summary}</p>
            </div>
            
            ${correlation ? `
              <div class="mb-4">
                <h6 class="text-sm font-medium mb-1">Form 483 to Warning Letter Correlation</h6>
                <p>${correlation}</p>
              </div>
            ` : ''}
            
            ${recommendations ? `
              <div class="mb-4">
                <h6 class="text-sm font-medium mb-1">Recommendations</h6>
                <p>${recommendations}</p>
              </div>
            ` : ''}
            
            <div class="text-right mt-4">
              <button id="download-analysis" class="text-xs bg-purple-600 hover:bg-purple-700 text-white py-1 px-3 rounded-md inline-flex items-center transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                </svg>
                Download Analysis
              </button>
            </div>
          </div>
        `;
        
        // Add event listener for download button
        document.getElementById('download-analysis').addEventListener('click', () => {
          downloadAnalysis({
            summary,
            correlation,
            recommendations
          }, selectedCompanies);
        });
      } catch (error) {
        console.error('Error analyzing companies:', error);
        document.getElementById('ai-analysis-content').innerHTML = `
          <div class="text-center text-red-600 py-4">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mx-auto mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <p>Error analyzing companies. Please try again later.</p>
            <p class="text-sm text-gray-600 mt-2">You can still view individual company details by clicking "View Details".</p>
          </div>
        `;
      }
    }
    
    // Helper function to generate a summary based on available data
    // function generateSummary(data, companies) {
    //   const { warningLetters, form483s, historicalInspections } = data;
      
    //   // Count inspections by classification
    //   const classifications = { NAI: 0, VAI: 0, OAI: 0 };
    //   historicalInspections.forEach(inspection => {
    //     const classification = inspection["Inspection Classification"];
    //     if (classification && classifications.hasOwnProperty(classification)) {
    //       classifications[classification]++;
    //     }
    //   });
      
    //   // Get unique project areas
    //   const projectAreas = [...new Set(historicalInspections
    //     .map(inspection => inspection["Project Area"])
    //     .filter(Boolean))];
      
    //   // Build summary text
    //   let summary = `Based on the analysis of ${companies.length === 1 ? 'this company' : 'these companies'}, we found `;
      
    //   // Add warning letters info
    //   if (warningLetters.length > 0) {
    //     summary += `${warningLetters.length} warning letter${warningLetters.length !== 1 ? 's' : ''} `;
    //   } else {
    //     summary += 'no warning letters ';
    //   }
      
    //   // Add Form 483 info
    //   if (form483s.length > 0) {
    //     summary += `and ${form483s.length} Form 483${form483s.length !== 1 ? 's' : ''}. `;
    //   } else {
    //     summary += 'and no Form 483s. ';
    //   }
      
    //   // Add historical inspection info
    //   if (historicalInspections.length > 0) {
    //     summary += `There ${historicalInspections.length === 1 ? 'is' : 'are'} ${historicalInspections.length} historical inspection${historicalInspections.length !== 1 ? 's' : ''} on record. `;
        
    //     // Add classification breakdown if available
    //     const classificationTotal = classifications.NAI + classifications.VAI + classifications.OAI;
    //     if (classificationTotal > 0) {
    //       summary += 'The inspection classifications breakdown is: ';
          
    //       if (classifications.NAI > 0) {
    //         summary += `${classifications.NAI} NAI (No Action Indicated, ${Math.round(classifications.NAI / classificationTotal * 100)}%), `;
    //       }
          
    //       if (classifications.VAI > 0) {
    //         summary += `${classifications.VAI} VAI (Voluntary Action Indicated, ${Math.round(classifications.VAI / classificationTotal * 100)}%), `;
    //       }
          
    //       if (classifications.OAI > 0) {
    //         summary += `${classifications.OAI} OAI (Official Action Indicated, ${Math.round(classifications.OAI / classificationTotal * 100)}%). `;
    //       }
    //     }
        
    //     // Add project area info if available
    //     if (projectAreas.length > 0) {
    //       summary += `The most frequent inspection areas include ${projectAreas.slice(0, 3).join(', ')}${projectAreas.length > 3 ? ', among others' : ''}.`;
    //     }
    //   } else {
    //     summary += 'There are no historical inspections on record.';
    //   }
      
    //   return summary;
    // }
    // Helper function to generate a summary based on available data
    function generateSummary(data, companies) {
    const { warningLetters, form483s, historicalInspections } = data;
    
    // Count inspections by classification
    const classifications = { NAI: 0, VAI: 0, OAI: 0 };
    historicalInspections.forEach(inspection => {
      const classification = inspection["Inspection Classification"];
      if (classification && classifications.hasOwnProperty(classification)) {
        classifications[classification]++;
      }
    });
    
    // Calculate Form 483 to Warning Letter ratio
    const form483Count = form483s.length;
    const warningLetterCount = warningLetters.length;
    const escalationRatio = form483Count > 0 
      ? Math.round((warningLetterCount / form483Count) * 100) 
      : 0;
    
    // Build summary text
    let summary = `**Overall Regulatory Profile for ${companies.length} ${companies.length === 1 ? 'Company' : 'Companies'} (${companies.join(', ')})**:\n\n`;
    
    // Form 483 and Warning Letter overview
    summary += `- **Form 483s and Warning Letters**: Received ${form483Count} Form 483${form483Count !== 1 ? 's' : ''} and ${warningLetterCount} Warning Letter${warningLetterCount !== 1 ? 's' : ''}. `;
    if (form483Count > 0) {
      summary += `${escalationRatio}% of Form 483s escalated to Warning Letters, indicating ${escalationRatio > 50 ? 'significant' : 'moderate'} regulatory risk.\n`;
    } else {
      summary += 'No Form 483s recorded, suggesting a clean compliance history.\n';
    }
    
    // Historical inspection overview
    if (historicalInspections.length > 0) {
      summary += `- **Historical Inspections**: ${historicalInspections.length} inspection${historicalInspections.length !== 1 ? 's' : ''} recorded. `;
      const classificationTotal = classifications.NAI + classifications.VAI + classifications.OAI;
      if (classificationTotal > 0) {
        summary += 'Outcomes: ';
        if (classifications.NAI > 0) summary += `${classifications.NAI} NAI (${Math.round(classifications.NAI / classificationTotal * 100)}%), `;
        if (classifications.VAI > 0) summary += `${classifications.VAI} VAI (${Math.round(classifications.VAI / classificationTotal * 100)}%), `;
        if (classifications.OAI > 0) summary += `${classifications.OAI} OAI (${Math.round(classifications.OAI / classificationTotal * 100)}%).\n`;
      }
    } else {
      summary += `- **Historical Inspections**: No inspections recorded.\n`;
    }
    
    return summary;
  }
  
  // Helper function to generate correlation analysis
  function generateCorrelationAnalysis(data) {
    const { warningLetters, form483s } = data;
    
    if (warningLetters.length === 0 || form483s.length === 0) {
      return 'Insufficient data to analyze Form 483 to Warning Letter correlations.';
    }
    
    // Sort by date
    const form483sSorted = [...form483s].sort((a, b) => 
      new Date(a["Record Date"]) - new Date(b["Record Date"])
    );
    const warningLettersSorted = [...warningLetters].sort((a, b) => 
      new Date(a.letterIssueDate) - new Date(b.letterIssueDate)
    );
    
    // Find correlations
    let correlations = [];
    let correlationCount = 0;
    
    warningLettersSorted.forEach(letter => {
      const letterDate = new Date(letter.letterIssueDate);
      const letterCompany = letter.companyName ? letter.companyName.toLowerCase() : '';
      
      const relatedForm483s = form483sSorted.filter(form => {
        const formDate = new Date(form["Record Date"]);
        const formCompany = form["Legal Name"] ? form["Legal Name"].toLowerCase() : '';
        return formDate < letterDate && 
               formCompany && 
               letterCompany && 
               isRelatedCompany(formCompany, letterCompany);
      });
      
      if (relatedForm483s.length > 0) {
        correlationCount++;
        const mostRecentForm483 = relatedForm483s[relatedForm483s.length - 1];
        const daysBetween = Math.floor(
          (letterDate - new Date(mostRecentForm483["Record Date"])) / (1000 * 60 * 60 * 24)
        );
        
        correlations.push({
          warningLetter: letter,
          form483: mostRecentForm483,
          daysBetween
        });
      }
    });
    
    // Generate correlation text
    let correlationText = `**Form 483 to Warning Letter Progression**: `;
    
    if (correlations.length > 0) {
      const avgDays = Math.round(
        correlations.reduce((sum, corr) => sum + corr.daysBetween, 0) / correlations.length
      );
      
      correlationText += `${correlationCount} of ${warningLetters.length} Warning Letter${warningLetters.length !== 1 ? 's' : ''} (${Math.round(correlationCount / warningLetters.length * 100)}%) were preceded by Form 483s. On average, Warning Letters were issued ${avgDays} days after Form 483s.\n\n`;
      
      correlationText += 'Key Progressions:\n';
      correlations.forEach(corr => {
        correlationText += `- Form 483 on ${WlformatDate(corr.form483["Record Date"])} (${corr.form483["Legal Name"]}) led to Warning Letter on ${WlformatDate(corr.warningLetter.letterIssueDate)} (${corr.warningLetter.companyName}), ${corr.daysBetween} days later.\n`;
      });
    } else {
      correlationText += 'No direct correlations found between Form 483s and Warning Letters. Companies may have addressed Form 483 observations effectively, or Warning Letters were issued for unrelated issues.';
    }
    
    return correlationText;
  }
    
    // // Helper function to generate correlation analysis
    // function generateCorrelationAnalysis(data) {
    //   const { warningLetters, form483s } = data;
      
    //   // If we don't have enough data, return a message
    //   if (warningLetters.length === 0 || form483s.length === 0) {
    //     return 'Insufficient data to perform correlation analysis between Form 483s and Warning Letters.';
    //   }
      
    //   // Sort items by date
    //   const form483sSorted = [...form483s].sort((a, b) => 
    //     new Date(a["Record Date"]) - new Date(b["Record Date"])
    //   );
      
    //   const warningLettersSorted = [...warningLetters].sort((a, b) => 
    //     new Date(a.letterIssueDate) - new Date(b.letterIssueDate)
    //   );
      
    //   // Find potential correlations (warning letters that follow form 483s)
    //   let correlations = [];
    //   let correlationCount = 0;
      
    //   warningLettersSorted.forEach(letter => {
    //     const letterDate = new Date(letter.letterIssueDate);
    //     const letterCompany = letter.companyName ? letter.companyName.toLowerCase() : '';
        
    //     // Find form 483s that precede this warning letter for the same company
    //     const relatedForm483s = form483sSorted.filter(form => {
    //       const formDate = new Date(form["Record Date"]);
    //       const formCompany = form["Legal Name"] ? form["Legal Name"].toLowerCase() : '';
          
    //       // Check if dates and companies match (form 483 before warning letter, same company)
    //       return formDate < letterDate && 
    //              formCompany && 
    //              letterCompany && 
    //              (formCompany.includes(letterCompany) || letterCompany.includes(formCompany));
    //     });
        
    //     if (relatedForm483s.length > 0) {
    //       correlationCount++;
          
    //       // Get the most recent form 483 before this warning letter
    //       const mostRecentForm483 = relatedForm483s[relatedForm483s.length - 1];
    //       const daysBetween = Math.floor(
    //         (letterDate - new Date(mostRecentForm483["Record Date"])) / (1000 * 60 * 60 * 24)
    //       );
          
    //       correlations.push({
    //         warningLetter: letter,
    //         form483: mostRecentForm483,
    //         daysBetween
    //       });
    //     }
    //   });
      
    //   // Generate correlation text
    //   let correlationText = '';
      
    //   if (correlations.length > 0) {
    //     // Calculate average days between form 483 and warning letter
    //     const avgDays = Math.round(
    //       correlations.reduce((sum, corr) => sum + corr.daysBetween, 0) / correlations.length
    //     );
        
    //     correlationText = `Among the selected companies, ${correlationCount} warning letter${correlationCount !== 1 ? 's' : ''} (${Math.round(correlationCount / warningLetters.length * 100)}%) were preceded by Form 483s. On average, warning letters were issued ${avgDays} days after Form 483s. `;
        
    //     // Add more detailed information about specific correlations
    //     if (correlations.length <= 3) {
    //       // For a small number of correlations, include details on each one
    //       correlationText += 'Specific correlations include: ';
          
    //       correlations.forEach((corr, index) => {
    //         const company = corr.warningLetter.companyName || 'a company';
    //         correlationText += `${company} received a Form 483 on ${WlformatDate(corr.form483["Record Date"])} and a warning letter ${corr.daysBetween} days later on ${WlformatDate(corr.warningLetter.letterIssueDate)}${index < correlations.length - 1 ? '; ' : '.'}`;
    //       });
    //     } else {
    //       // For larger datasets, provide a summary of timeframes
    //       const timeframes = {
    //         'under30': 0,
    //         '30to90': 0,
    //         '90to180': 0,
    //         'over180': 0
    //       };
          
    //       correlations.forEach(corr => {
    //         if (corr.daysBetween < 30) timeframes.under30++;
    //         else if (corr.daysBetween < 90) timeframes['30to90']++;
    //         else if (corr.daysBetween < 180) timeframes['90to180']++;
    //         else timeframes.over180++;
    //       });
          
    //       correlationText += 'The timeframe distribution between Form 483s and subsequent Warning Letters is: ';
    //       correlationText += `${timeframes.under30} in less than 30 days, ${timeframes['30to90']} in 30-90 days, ${timeframes['90to180']} in 90-180 days, and ${timeframes.over180} taking more than 180 days.`;
    //     }
    //   } else {
    //     correlationText = 'No direct correlations were found between Form 483s and Warning Letters for the selected companies. This could indicate that the companies addressed Form 483 observations adequately or that the Warning Letters were issued for different reasons than those identified in Form 483s.';
    //   }
      
    //   return correlationText;
    // }
    

    
    // Helper function to extract common topics from warning letters
    function extractCommonTopics(warningLetters) {
      // Define key regulatory topics to search for
      const topicKeywords = {
        'data integrity': ['data integrity', 'data manipulation', 'audit trail', 'electronic records'],
        'quality control': ['quality control', 'QC', 'testing', 'laboratory', 'specifications'],
        'contamination control': ['contamination', 'sterile', 'aseptic', 'environmental monitoring'],
        'production processes': ['production', 'manufacturing', 'process validation', 'controls'],
        'CAPA systems': ['CAPA', 'corrective', 'preventive', 'investigations', 'deviations'],
        'documentation practices': ['documentation', 'records', 'procedures', 'SOPs']
      };
      
      // Count occurrences of each topic
      const topicCounts = {};
      
      warningLetters.forEach(letter => {
        const content = ((letter.fullContent || '') + ' ' + (letter.subject || '')).toLowerCase();
        
        Object.entries(topicKeywords).forEach(([topic, keywords]) => {
          if (keywords.some(keyword => content.includes(keyword.toLowerCase()))) {
            topicCounts[topic] = (topicCounts[topic] || 0) + 1;
          }
        });
      });
      
      // Sort topics by frequency and return the top 3
      return Object.entries(topicCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 3)
        .map(([topic]) => topic);
    }
    
    // Function to show company details
// Enhanced function to show company details with improved UI and proper Form 483 display
function WLshowCompanyDetails(company, warningLetters, inspections) {
  console.log(`Showing details for ${company}`, {
    form483Count: window.regulatoryData.form483Counts[company] || 0,
    warningLetterCount: window.regulatoryData.warningLetterCounts[company] || 0,
    historicalCount: window.regulatoryData.historicalInspectionCounts[company] || 0
  });

  const detailView = document.getElementById('company-detail-view');
  const detailName = document.getElementById('company-detail-name');
  const detailContent = document.getElementById('company-detail-content');
  
  if (!detailView || !detailName || !detailContent) {
    console.error('Company detail view elements not found');
    return;
  }
  
  detailView.classList.remove('hidden');
  detailName.textContent = company;
  
  // Get company data - with improved filtering to capture all related entities
  // First, get all Form 483s for this company from the displayed table
  const form483s = getForm483sForCompany(company, inspections.recentInspections);
  
  // Get warning letters for this company
  const companyWL = warningLetters.filter(letter => 
    (letter.sourceCompany && letter.sourceCompany === company) ||
    (letter.companyName && letter.companyName.toLowerCase().includes(company.toLowerCase()))
  );
  
  // Get historical inspections for this company
  const companyHistorical = inspections.historicalInspections.filter(inspection => 
    inspection["Firm Name"] && isRelatedCompany(inspection["Firm Name"], company)
  );
  
  // Log what we found for debugging
  console.log(`Found for ${company}:`, {
    form483Count: form483s.length,
    warningLetterCount: companyWL.length,
    historicalCount: companyHistorical.length
  });
  
  // Create HTML for company details with improved UI
  let html = `
    <div class="space-y-6">
      <!-- Summary Statistics -->
      <div class="grid grid-cols-3 gap-4">
        <div class="bg-white rounded-lg shadow-sm p-4 text-center">
          <span class="text-3xl font-bold ${form483s.length > 0 ? 'text-yellow-600' : 'text-gray-600'}">${form483s.length}</span>
          <p class="text-sm text-gray-500 mt-1">Form 483s</p>
        </div>
        <div class="bg-white rounded-lg shadow-sm p-4 text-center">
          <span class="text-3xl font-bold ${companyWL.length > 0 ? 'text-red-600' : 'text-gray-600'}">${companyWL.length}</span>
          <p class="text-sm text-gray-500 mt-1">Warning Letters</p>
        </div>
        <div class="bg-white rounded-lg shadow-sm p-4 text-center">
          <span class="text-3xl font-bold ${companyHistorical.length > 0 ? 'text-blue-600' : 'text-gray-600'}">${companyHistorical.length}</span>
          <p class="text-sm text-gray-500 mt-1">Historical Inspections</p>
        </div>
      </div>
      
      <!-- Form 483s Section -->
      <div class="bg-white rounded-lg shadow-sm overflow-hidden">
        <div class="flex items-center justify-between bg-yellow-50 px-4 py-3 border-b border-yellow-100">
          <h5 class="text-sm font-medium text-yellow-800">Form 483s (${form483s.length})</h5>
          ${form483s.length > 0 ? `
            <span class="text-xs text-yellow-600">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
              </svg>
              Latest: ${form483s.length > 0 ? WlformatDate(form483s[0]["Record Date"]) : 'N/A'}
            </span>
          ` : ''}
        </div>
        
        ${form483s.length > 0 ? `
          <div class="overflow-x-auto">
            <table class="min-w-full text-xs">
              <thead>
                <tr class="bg-gray-50 border-b">
                  <th class="px-3 py-2 text-left">Date</th>
                  <th class="px-3 py-2 text-left">Legal Name</th>
                  <th class="px-3 py-2 text-left">FEI Number</th>
                  <th class="px-3 py-2 text-left">Actions</th>
                </tr>
              </thead>
              <tbody>
                ${form483s.map(inspection => `
                  <tr class="border-b hover:bg-gray-50">
                    <td class="px-3 py-2">${WlformatDate(inspection["Record Date"])}</td>
                    <td class="px-3 py-2" title="${inspection["Legal Name"]}">
                      ${truncateText(inspection["Legal Name"] || 'N/A', 40)}
                    </td>
                    <td class="px-3 py-2">${inspection["FEI Number"] || 'N/A'}</td>
                    <td class="px-3 py-2">
                      ${inspection["Download"] ? `
                        <a href="${inspection["Download"]}" target="_blank" class="text-blue-600 hover:text-blue-800 text-xs inline-flex items-center">
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                          </svg>
                          Download
                        </a>
                      ` : 'Not available'}
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        ` : '<p class="text-gray-500 text-sm p-4">No Form 483s found for this company</p>'}
      </div>
      
      <!-- Warning Letters Section -->
      <div class="bg-white rounded-lg shadow-sm overflow-hidden">
        <div class="flex items-center justify-between bg-red-50 px-4 py-3 border-b border-red-100">
          <h5 class="text-sm font-medium text-red-800">Warning Letters (${companyWL.length})</h5>
          ${companyWL.length > 0 ? `
            <span class="text-xs text-red-600">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
              </svg>
              Latest: ${companyWL.length > 0 ? WlformatDate(companyWL[0].letterIssueDate) : 'N/A'}
            </span>
          ` : ''}
        </div>
        
        ${companyWL.length > 0 ? `
          <div class="overflow-x-auto">
            <table class="min-w-full text-xs">
              <thead>
                <tr class="bg-gray-50 border-b">
                  <th class="px-3 py-2 text-left">Date</th>
                  <th class="px-3 py-2 text-left">Issuing Office</th>
                  <th class="px-3 py-2 text-left">Subject</th>
                  <th class="px-3 py-2 text-left">Actions</th>
                </tr>
              </thead>
              <tbody>
                ${companyWL.map(letter => `
                  <tr class="border-b hover:bg-gray-50">
                    <td class="px-3 py-2">${WlformatDate(letter.letterIssueDate)}</td>
                    <td class="px-3 py-2">${letter.issuingOffice || 'Unknown'}</td>
                    <td class="px-3 py-2" title="${letter.subject || ''}">
                      ${truncateText(letter.subject || 'No subject provided', 40)}
                    </td>
                    <td class="px-3 py-2">
                      <button class="text-blue-600 hover:text-blue-800 text-xs inline-flex items-center view-letter-btn" 
                              data-id="${letter.id || letter.letterId}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                        </svg>
                        View Letter
                      </button>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        ` : '<p class="text-gray-500 text-sm p-4">No Warning Letters found for this company</p>'}
      </div>
      
      <!-- Form 483 to Warning Letter Correlation Section -->
      <div class="bg-white rounded-lg shadow-sm overflow-hidden">
        <div class="bg-indigo-50 px-4 py-3 border-b border-indigo-100">
          <h5 class="text-sm font-medium text-indigo-800">Form 483 to Warning Letter Correlation</h5>
        </div>
        
        ${form483s.length > 0 && companyWL.length > 0 ? `
          <div class="p-4">
            <div class="timeline relative pl-8 pb-1">
              ${WLcreateTimelineHtml(form483s, companyWL)}
            </div>
          </div>
        ` : '<p class="text-gray-500 text-sm p-4">Insufficient data to show correlation</p>'}
      </div>
      
      <!-- Historical Inspections Section -->
      <div class="bg-white rounded-lg shadow-sm overflow-hidden">
        <div class="flex items-center justify-between bg-blue-50 px-4 py-3 border-b border-blue-100">
          <h5 class="text-sm font-medium text-blue-800">Historical Inspections (${companyHistorical.length})</h5>
          ${companyHistorical.length > 0 ? `
            <div class="flex space-x-3">
              <select id="project-area-filter-details" class="text-xs rounded border border-gray-300 py-1 px-2 focus:outline-none focus:ring-1 focus:ring-blue-500">
                <option value="all">All Project Areas</option>
                ${[...new Set(companyHistorical.map(i => i["Project Area"]).filter(Boolean))]
                  .map(area => `<option value="${area}">${area}</option>`).join('')}
              </select>
              <select id="inspection-class-filter-details" class="text-xs rounded border border-gray-300 py-1 px-2 focus:outline-none focus:ring-1 focus:ring-blue-500">
                <option value="all">All Classifications</option>
                <option value="NAI">NAI</option>
                <option value="VAI">VAI</option>
                <option value="OAI">OAI</option>
              </select>
            </div>
          ` : ''}
        </div>
        
        ${companyHistorical.length > 0 ? `
          <div class="overflow-x-auto">
            <table class="min-w-full text-xs" id="historical-inspections-details-table">
              <thead>
                <tr class="bg-gray-50 border-b">
                  <th class="px-3 py-2 text-left">End Date</th>
                  <th class="px-3 py-2 text-left">Location</th>
                  <th class="px-3 py-2 text-left">Project Area</th>
                  <th class="px-3 py-2 text-left">Classification</th>
                </tr>
              </thead>
              <tbody>
                ${companyHistorical.map(inspection => `
                  <tr class="border-b hover:bg-gray-50" 
                      data-project-area="${inspection["Project Area"] || ''}"
                      data-classification="${inspection["Inspection Classification"] || ''}">
                    <td class="px-3 py-2">${WlformatDate(inspection["Inspection End Date"])}</td>
                    <td class="px-3 py-2">${inspection["City"] || ''}, ${inspection["State"] || ''}</td>
                    <td class="px-3 py-2">${inspection["Project Area"] || 'Unknown'}</td>
                    <td class="px-3 py-2">
                      <span class="px-2 py-1 ${getClassificationColor(inspection["Inspection Classification"])} rounded-full text-xs">
                        ${inspection["Inspection Classification"] || 'N/A'}
                      </span>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
          
          <div id="historical-details-no-results" class="hidden text-center p-4">
            <p class="text-sm text-gray-600">No inspections match the current filter criteria.</p>
          </div>
        ` : '<p class="text-gray-500 text-sm p-4">No historical inspections found for this company</p>'}
      </div>
      
      <!-- Download Report Button -->
      <div class="flex justify-end mt-4">
        <button id="download-company-report" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-medium inline-flex items-center" data-company="${company}">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
          </svg>
          Download Company Report
        </button>
      </div>
    </div>
  `;
  
  // Update the content
  detailContent.innerHTML = html;
  
  // Add event listeners for viewing letters
  document.querySelectorAll('.view-letter-btn').forEach(button => {
    button.addEventListener('click', function() {
      const letterId = this.getAttribute('data-id');
      viewWarningLetterDetails(letterId, company);
    });
  });
  
  // Add event listeners for historical inspection filters
  if (companyHistorical.length > 0) {
    const projectAreaFilter = document.getElementById('project-area-filter-details');
    const classFilter = document.getElementById('inspection-class-filter-details');
    
    const filterHistoricalInspectionsDetails = function() {
      const projectArea = projectAreaFilter.value;
      const classification = classFilter.value;
      
      const rows = document.querySelectorAll('#historical-inspections-details-table tbody tr');
      let visibleRows = 0;
      
      rows.forEach(row => {
        const rowProjectArea = row.getAttribute('data-project-area');
        const rowClassification = row.getAttribute('data-classification');
        
        const projectAreaMatch = projectArea === 'all' || rowProjectArea === projectArea;
        const classificationMatch = classification === 'all' || rowClassification === classification;
        
        if (projectAreaMatch && classificationMatch) {
          row.classList.remove('hidden');
          visibleRows++;
        } else {
          row.classList.add('hidden');
        }
      });
      
      // Show/hide no results message
      const noResultsEl = document.getElementById('historical-details-no-results');
      if (noResultsEl) {
        if (visibleRows === 0) {
          noResultsEl.classList.remove('hidden');
        } else {
          noResultsEl.classList.add('hidden');
        }
      }
    };
    
    projectAreaFilter.addEventListener('change', filterHistoricalInspectionsDetails);
    classFilter.addEventListener('change', filterHistoricalInspectionsDetails);
  }
  
  // Add event listener for download report button
  document.getElementById('download-company-report').addEventListener('click', function() {
    const companyName = this.getAttribute('data-company');
    downloadCompanyReport(companyName, {
      form483s,
      warningLetters: companyWL,
      historicalInspections: companyHistorical
    });
  });
}

// Helper function to get Form 483s for a specific company
function getForm483sForCompany(company, allInspections) {
  // Filter to get only Form 483s related to this company
  return allInspections.filter(inspection => {
    // 1. Check if it's a Form 483
    if (inspection["Record Type"] !== "483") return false;
    
    // 2. Check if it's related to this company
    const legalName = inspection["Legal Name"] || '';
    return isRelatedCompany(legalName, company);
  }).sort((a, b) => {
    // Sort by date, most recent first
    return new Date(b["Record Date"]) - new Date(a["Record Date"]);
  });
}

// Helper function to truncate text and add ellipsis if needed
function truncateText(text, maxLength) {
  if (!text) return '';
  if (text.length <= maxLength) return text;
  return text.substring(0, maxLength) + '...';
}

// Modified function to download company report
function downloadCompanyReport(company, data) {
  const { form483s, warningLetters, historicalInspections } = data;
  
  // Create text content
  const textContent = `
FDA REGULATORY INTELLIGENCE REPORT
${company}
Generated on ${new Date().toLocaleDateString()}

SUMMARY
==============================
Form 483s: ${form483s.length}
Warning Letters: ${warningLetters.length}
Historical Inspections: ${historicalInspections.length}

FORM 483s
==============================
${form483s.length > 0 ? form483s.map(item => 
  `Date: ${WlformatDate(item["Record Date"])}
Legal Name: ${item["Legal Name"] || 'N/A'}
FEI Number: ${item["FEI Number"] || 'N/A'}
${item["Download"] ? `Download URL: ${item["Download"]}` : 'Download: Not available'}
`).join('\n----------\n') : 'No Form 483s found for this company.'}

WARNING LETTERS
==============================
${warningLetters.length > 0 ? warningLetters.map(letter => 
  `Date: ${WlformatDate(letter.letterIssueDate)}
Issuing Office: ${letter.issuingOffice || 'Unknown'}
Subject: ${letter.subject || 'No subject provided'}
${letter.companyUrl ? `FDA Website URL: ${letter.companyUrl}` : ''}
`).join('\n----------\n') : 'No Warning Letters found for this company.'}

HISTORICAL INSPECTIONS
==============================
${historicalInspections.length > 0 ? historicalInspections.map(inspection => 
  `End Date: ${WlformatDate(inspection["Inspection End Date"])}
Location: ${inspection["City"] || ''}, ${inspection["State"] || ''}, ${inspection["Country/Area"] || ''}
Project Area: ${inspection["Project Area"] || 'Unknown'}
Classification: ${inspection["Inspection Classification"] || 'N/A'}
`).join('\n----------\n') : 'No historical inspections found for this company.'}

REGULATORY INSIGHTS
==============================
${form483s.length > 0 || warningLetters.length > 0 ? 
  `Based on the data above, ${company} has received a total of ${form483s.length} Form 483s and ${warningLetters.length} Warning Letters. This indicates a significant regulatory history that should be carefully evaluated.` : 
  `${company} appears to have a clean regulatory record with no Form 483s or Warning Letters in our database.`}

${historicalInspections.length > 0 ? 
  `The company has undergone ${historicalInspections.length} FDA inspections, which provides a comprehensive view of their regulatory compliance over time.` : 
  `There are no historical inspection records for ${company} in our database.`}

Data sourced from FDA.gov, including Warning Letters, Form 483s, and Inspection Classifications.
For regulatory intelligence purposes only. Not for commercial use.
  `;
  
  // Create a blob and download link
  const blob = new Blob([textContent], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `fda-regulatory-report-${company.replace(/[^a-z0-9]/gi, '-').toLowerCase()}.txt`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  // Show success toast
  WLshowToast('Company report downloaded successfully!', 'success');
}
    
    // Function to create timeline HTML showing correlation between 483s and warning letters
    function WLcreateTimelineHtml(form483s, warningLetters) {
      // Sort items by date
      const form483sSorted = [...form483s].sort((a, b) => 
        new Date(a["Record Date"]) - new Date(b["Record Date"])
      );
      
      const warningLettersSorted = [...warningLetters].sort((a, b) => 
        new Date(a.letterIssueDate) - new Date(b.letterIssueDate)
      );
      
      // Combine and sort all events
      const allEvents = [
        ...form483sSorted.map(item => ({
          type: '483',
          date: new Date(item["Record Date"]),
          data: item
        })),
        ...warningLettersSorted.map(item => ({
          type: 'WL',
          date: new Date(item.letterIssueDate),
          data: item
        }))
      ].sort((a, b) => a.date - b.date);
    
      // If no events, show message
      if (allEvents.length === 0) {
        return '<p class="text-gray-600 text-sm">No timeline data available</p>';
      }
      
      // Create timeline HTML
      let html = `<div class="timeline-line absolute left-4 top-0 bottom-0 w-0.5 bg-gray-200"></div>`;
      
      allEvents.forEach((event, index) => {
        const isWL = event.type === 'WL';
        const dateStr = WlformatDate(isWL ? event.data.letterIssueDate : event.data["Record Date"]);
        
        // If this is a warning letter, try to find the closest 483 before it
        let correlation = '';
        if (isWL) {
          const previousEvents = allEvents.slice(0, index).filter(e => e.type === '483');
          if (previousEvents.length > 0) {
            const lastForm483 = previousEvents[previousEvents.length - 1];
            const daysBetween = Math.floor((event.date - lastForm483.date) / (1000 * 60 * 60 * 24));
            
            if (daysBetween <= 365) {  // If within a year
              correlation = `
                <div class="text-xs text-gray-500 mt-1">
                  Possibly related to Form 483 from ${WlformatDate(lastForm483.data["Record Date"])}
                  (${daysBetween} days apart)
                </div>
              `;
            }
          }
        }
        
        html += `
          <div class="relative mb-6">
            <div class="timeline-dot absolute left-4 w-3 h-3 rounded-full -ml-1.5 ${isWL ? 'bg-red-500' : 'bg-yellow-500'}"></div>
            <div class="ml-8">
              <div class="flex items-center">
                <span class="text-xs px-2 py-1 ${isWL ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800'} rounded-full">
                  ${isWL ? 'Warning Letter' : 'Form 483'}
                </span>
                <span class="ml-2 text-xs text-gray-500">${dateStr}</span>
              </div>
              
              <div class="mt-1 text-sm">
                ${isWL ? 
                  `Issuing Office: ${event.data.issuingOffice || 'Unknown'}` : 
                `FEI Number: ${event.data["FEI Number"] || 'N/A'}`
              }
            </div>
            
            ${correlation}
          </div>
        </div>
      `;
    });
    
    return html;
  }

   // Strip markdown code fences from API response
   function stripCodeFences(htmlContent) {
    // Match content between ```html and ```
    const regex = /```html\s*([\s\S]*?)\s*```/;
    const match = htmlContent.match(regex);
    
    if (match && match[1]) {
      return match[1].trim(); // Return the HTML content between fences
    }

    // Fallback: If no match, try to clean up by removing known patterns
    let cleanedContent = htmlContent
      .replace(/```html\s*/g, '') // Remove opening ```html
      .replace(/```\s*[\s\S]*/g, ''); // Remove closing ``` and anything after

    // Warn if the cleaned content doesn't look like HTML
    if (!cleanedContent.trim().startsWith('<')) {
      console.warn('Cleaned content may not be valid HTML:', cleanedContent.substring(0, 100));
    }

    return cleanedContent.trim();
  }

  
  // Function to generate AI summary
 // Generate AI summary by calling the new endpoint
 async function WLgenerateAISummary() {
    const aiResults = document.getElementById('ai-analysis-results');
    aiResults.classList.remove('hidden');

    document.getElementById('ai-analysis-content').innerHTML = `
      <div class="flex justify-center items-center py-8">
        <svg class="animate-spin h-6 w-6 text-purple-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span class="ml-2 text-gray-600">Generating AI summary of regulatory findings...</span>
      </div>
    `;

    try {
      // Collect companies from UI
      const companies = Array.from(document.querySelectorAll('#company-summary-section tbody tr')).map(row => 
        row.querySelector('td:first-child').textContent.trim()
      );

      if (companies.length === 0) {
        throw new Error('No companies selected');
      }

      // Fetch warning letters and inspections
      const [warningLetters, inspections] = await Promise.all([
        fetchWarningLettersWithTracking(companies, 1, 10),
        fetchInspectionDataWithTracking(companies)
      ]);

      // Call the new endpoint
      const response = await fetch(`${API_BASE_URL}/generate-warning-letter-summary`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          companies,
          warningLetters,
          form483s: inspections.recentInspections.filter(inspection => 
            inspection["Record Type"] === "483"
          ),
          maxTokens: 3000,
          temperature: 0.7
        })
      });

      const result = await response.json();
      if (!result.success) {
        throw new Error(result.error);
      }

      result.summary = stripCodeFences(result.summary);
      // Display the HTML summary
      document.getElementById('ai-analysis-content').innerHTML = `
        <div class="prose prose-sm max-w-none">
          ${result.summary}
        </div>
        <div class="text-right mt-4">
          <button id="download-ai-summary" class="text-xs bg-purple-600 hover:bg-purple-700 text-white py-1 px-3 rounded-md inline-flex items-center transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
            </svg>
            Download Summary
          </button>
        </div>
      `;

      // Add event listener for download button
      document.getElementById('download-ai-summary').addEventListener('click', () => {
        const blob = new Blob([result.summary], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `regulatory_summary_${new Date().toISOString().split('T')[0]}.html`;
        a.click();
        URL.revokeObjectURL(url);
      });
    } catch (error) {
      console.error('Error generating AI summary:', error);
      document.getElementById('ai-analysis-content').innerHTML = `
        <div class="text-center text-red-600 py-4">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mx-auto mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <p>Error generating AI summary: ${error.message}</p>
        </div>
      `;
    }
  }
  
  // Helper function to extract manufacturing issues related to specific compounds
  function extractManufacturingIssues(warningLetters, form483s, compoundKeywords) {
    const issues = [];
    
    // Check warning letters
    warningLetters.forEach(letter => {
      const content = ((letter.fullContent || '') + ' ' + (letter.subject || '')).toLowerCase();
      compoundKeywords.forEach(keyword => {
        if (content.includes(keyword.toLowerCase())) {
          issues.push({
            company: letter.companyName || letter.sourceCompany || 'Unknown',
            issue: letter.subject || `Manufacturing deficiency related to ${keyword}`,
            source: 'Warning Letter',
            date: letter.letterIssueDate
          });
        }
      });
    });
    
    // Check Form 483s (limited to Legal Name for now)
    form483s.forEach(form => {
      const content = (form["Legal Name"] || '').toLowerCase();
      compoundKeywords.forEach(keyword => {
        if (content.includes(keyword.toLowerCase())) {
          issues.push({
            company: form["Legal Name"] || 'Unknown',
            issue: `Potential issue related to ${keyword} (detailed observations unavailable)`,
            source: 'Form 483',
            date: form["Record Date"]
          });
        }
      });
    });
    
    return issues.sort((a, b) => new Date(b.date) - new Date(a.date));
  }
  
  // Helper function to generate competitive insights
  function generateCompetitiveInsights(data, companies, drugName = '') {
    const { warningLetters, form483s } = data;
    const drugNameLower = drugName.toLowerCase();
    const compoundKeywords = drugName ? [drugNameLower] : ['drug'];
    const manufacturingIssues = extractManufacturingIssues(warningLetters, form483s, compoundKeywords);
    
    let insights = `**Competitive Insights for ${drugName || 'the Drug'} Market**\n\n`;
    
    // Per-Company Analysis
    insights += `### Per-Company Regulatory Analysis and Opportunities\n`;
    companies.forEach(company => {
      insights += `#### ${company}\n`;
      
      // Filter data for this company
      const companyWarningLetters = warningLetters.filter(wl => 
        isRelatedCompany((wl.companyName || '').toLowerCase(), company.toLowerCase())
      );
      const companyForm483s = form483s.filter(form => 
        isRelatedCompany((form["Legal Name"] || '').toLowerCase(), company.toLowerCase())
      );
      const companyIssues = manufacturingIssues.filter(issue => 
        isRelatedCompany(issue.company.toLowerCase(), company.toLowerCase())
      );
      
      // Calculate escalation ratio
      const form483Count = companyForm483s.length;
      const warningLetterCount = companyWarningLetters.length;
      const escalationRatio = form483Count > 0 
        ? Math.round((warningLetterCount / form483Count) * 100) 
        : 0;
      
      // Find Form 483 to Warning Letter correlations
      let correlations = [];
      companyWarningLetters.forEach(letter => {
        const letterDate = new Date(letter.letterIssueDate);
        const relatedForm483s = companyForm483s.filter(form => {
          const formDate = new Date(form["Record Date"]);
          return formDate < letterDate;
        });
        if (relatedForm483s.length > 0) {
          const mostRecentForm483 = relatedForm483s.sort((a, b) => 
            new Date(b["Record Date"]) - new Date(a["Record Date"])
          )[0];
          const daysBetween = Math.floor(
            (letterDate - new Date(mostRecentForm483["Record Date"])) / (1000 * 60 * 60 * 24)
          );
          correlations.push({
            form483: mostRecentForm483,
            warningLetter: letter,
            daysBetween
          });
        }
      });
      
      // Regulatory Profile
      insights += `- **Regulatory Profile**: ${form483Count} Form 483${form483Count !== 1 ? 's' : ''}, ${warningLetterCount} Warning Letter${warningLetterCount !== 1 ? 's' : ''}.\n`;
      if (form483Count > 0) {
        insights += `  - **Escalation Risk**: ${escalationRatio}% of Form 483s escalated to Warning Letters, indicating ${escalationRatio > 50 ? 'high' : 'moderate'} risk of further regulatory action.\n`;
      } else {
        insights += `  - **Escalation Risk**: No Form 483s recorded, suggesting strong compliance.\n`;
      }
      
      // Form 483 to Warning Letter Progression
      if (correlations.length > 0) {
        insights += `  - **Progression**: The following Form 483s led to Warning Letters:\n`;
        correlations.forEach(corr => {
          insights += `    - Form 483 (${WlformatDate(corr.form483["Record Date"])}) led to Warning Letter (${WlformatDate(corr.warningLetter.letterIssueDate)}, Subject: ${corr.warningLetter.subject || 'N/A'}), ${corr.daysBetween} days later.\n`;
        });
      } else {
        insights += `  - **Progression**: No clear progression from Form 483s to Warning Letters identified.\n`;
      }
      
      // Drug-Specific Issues
      if (companyIssues.length > 0) {
        insights += `  - **${drugName || 'Drug'}-Related Issues**:\n`;
        companyIssues.forEach(issue => {
          insights += `    - ${issue.source} (${WlformatDate(issue.date)}): ${issue.issue}\n`;
        });
      } else {
        insights += `  - **${drugName || 'Drug'}-Related Issues**: No specific issues related to ${drugName || 'the drug'} identified.\n`;
      }
      
      // Competitive Opportunities
      insights += `  - **Competitive Opportunities**:\n`;
      if (companyIssues.length > 0 || warningLetterCount > 0) {
        insights += `    - **Alternative Supply**: Offer ${drugName || 'the drug'} as an alternative to ${company}’s supply, highlighting your compliance to attract their customers.\n`;
        insights += `    - **Partnerships**: Propose contract manufacturing or compliance support to help ${company} address ${drugName || 'drug'}-related deficiencies.\n`;
        insights += `    - **Market Targeting**: Launch campaigns targeting ${company}’s customers, emphasizing your regulatory reliability for ${drugName || 'the drug'}.\n`;
      } else {
        insights += `    - **Innovation**: Differentiate by developing innovative ${drugName || 'drug'} formulations or delivery methods to compete with ${company}’s strong compliance.\n`;
        insights += `    - **Cost Competition**: Optimize ${drugName || 'drug'} production to offer competitive pricing against ${company}.\n`;
        insights += `    - **Monitoring**: Monitor ${company} for future ${drugName || 'drug'}-related regulatory issues to identify market entry points.\n`;
      }
    });
    
    // Overall Analysis
    insights += `\n### Overall Market Analysis for ${drugName || 'the Drug'}\n`;
    
    // Overall regulatory stats
    const overallForm483Count = form483s.length;
    const overallWarningLetterCount = warningLetters.length;
    const overallEscalationRatio = overallForm483Count > 0 
      ? Math.round((overallWarningLetterCount / overallForm483Count) * 100) 
      : 0;
    
    insights += `- **Market Regulatory Profile**: Across ${companies.length} ${companies.length === 1 ? 'company' : 'companies'}, there are ${overallForm483Count} Form 483${overallForm483Count !== 1 ? 's' : ''} and ${overallWarningLetterCount} Warning Letter${overallWarningLetterCount !== 1 ? 's' : ''}.\n`;
    insights += `  - **Escalation Risk**: ${overallEscalationRatio}% of Form 483s escalated to Warning Letters, suggesting ${overallEscalationRatio > 50 ? 'significant' : 'moderate'} market-wide regulatory risk.\n`;
    
    // Overall drug-specific issues
    if (manufacturingIssues.length > 0) {
      insights += `  - **${drugName || 'Drug'}-Related Issues**: The following issues were identified across the market:\n`;
      manufacturingIssues.forEach(issue => {
        insights += `    - ${issue.company} (${issue.source}, ${WlformatDate(issue.date)}): ${issue.issue}\n`;
      });
    } else {
      insights += `  - **${drugName || 'Drug'}-Related Issues**: No specific issues related to ${drugName || 'the drug'} identified across the market.\n`;
    }
    
    // Overall competitive opportunities
    insights += `  - **Market-Wide Opportunities**:\n`;
    if (manufacturingIssues.length > 0 || overallWarningLetterCount > 0) {
      insights += `    - **Alternative Supply Sources**: Enter the ${drugName || 'drug'} market as a reliable supplier, capitalizing on competitors’ regulatory issues.\n`;
      insights += `    - **Compliance Partnerships**: Offer compliance consulting or contract manufacturing to companies struggling with ${drugName || 'drug'}-related regulations.\n`;
      insights += `    - **Market Share Growth**: Target customers of non-compliant companies with campaigns emphasizing your ${drugName || 'drug'} quality and compliance.\n`;
      insights += `    - **Risk Monitoring**: Continue tracking FDA actions for ${drugName || 'the drug'} to identify future supply disruptions.\n`;
    } else {
      insights += `    - **Innovation Leadership**: Invest in R&D for ${drugName || 'the drug'} to differentiate in a compliant market.\n`;
      insights += `    - **Cost Leadership**: Optimize production to offer competitive pricing for ${drugName || 'the drug'}.\n`;
      insights += `    - **Proactive Monitoring**: Monitor ${companies.join(', ')} for emerging ${drugName || 'drug'}-related issues to seize market opportunities.\n`;
      insights += `    - **Strategic Alliances**: Partner with compliant companies to co-develop or co-market ${drugName || 'drug'} products.\n`;
    }
    
    // General strategies
    insights += `\n### General Strategies for the ${drugName || 'Drug'} Market\n`;
    insights += `- **Regulatory Intelligence**: Continuously analyze FDA data to stay ahead in the ${drugName || 'drug'} market.\n`;
    insights += `- **Customer Trust**: Build trust with ${drugName || 'drug'} stakeholders through transparent compliance and quality assurance.\n`;
    insights += `- **Global Opportunities**: Explore international markets for ${drugName || 'the drug'} where regulatory barriers may be lower.\n`;
    
    return insights;
  }
  // Function to generate AI summary
//   async function WLgenerateAISummary() {
//     const aiResults = document.getElementById('ai-analysis-results');
//     aiResults.classList.remove('hidden');
    
//     document.getElementById('ai-analysis-content').innerHTML = `
//       <div class="flex justify-center items-center py-8">
//         <svg class="animate-spin h-6 w-6 text-purple-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
//           <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
//           <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
//         </svg>
//         <span class="ml-2 text-gray-600">Generating AI summary of regulatory findings...</span>
//       </div>
//     `;
    
//     try {
//       // Collect data from the UI for analysis
//       const companies = Array.from(document.querySelectorAll('#company-summary-section tbody tr')).map(row => 
//         row.querySelector('td:first-child').textContent.trim()
//       );
      
//       const form483Count = Array.from(document.querySelectorAll('#company-summary-section tbody tr')).reduce((total, row) => {
//         const countText = row.querySelector('td:nth-child(2)').textContent.trim();
//         return total + (parseInt(countText) || 0);
//       }, 0);
      
//       const wlCount = Array.from(document.querySelectorAll('#company-summary-section tbody tr')).reduce((total, row) => {
//         const countText = row.querySelector('td:nth-child(3)').textContent.trim();
//         return total + (parseInt(countText) || 0);
//       }, 0);
      
//       // Generate summary based on available data
//       let summary = '';
//       let marketOpportunities = '';
//       let recommendedActions = '';
      
//       if (companies.length > 0) {
//         // Generate market analysis
//         summary = `Based on analysis of FDA regulatory actions for ${companies.length} companies in the pharmaceutical/biotech sector, we've identified several key trends and patterns. `;
        
//         if (form483Count > 0 || wlCount > 0) {
//           summary += `These companies have received a total of ${form483Count} Form 483s and ${wlCount} Warning Letters. `;
          
//           // Add more specific observations based on the data visible in the UI
//           const classifications = {
//             NAI: document.querySelectorAll('.bg-green-100.text-green-800').length,
//             VAI: document.querySelectorAll('.bg-yellow-100.text-yellow-800').length,
//             OAI: document.querySelectorAll('.bg-red-100.text-red-800').length
//           };
          
//           if (classifications.NAI > 0 || classifications.VAI > 0 || classifications.OAI > 0) {
//             summary += `In terms of inspection outcomes, we observed ${classifications.NAI} NAI (No Action Indicated), ${classifications.VAI} VAI (Voluntary Action Indicated), and ${classifications.OAI} OAI (Official Action Indicated) classifications. `;
//           }
          
//           // Get project areas from the UI
//           const projectAreaEl = document.getElementById('project-area-filter');
//           if (projectAreaEl) {
//             const projectAreas = Array.from(projectAreaEl.options)
//               .map(option => option.value)
//               .filter(value => value !== 'all');
              
//             if (projectAreas.length > 0) {
//               summary += `The most common inspection focus areas include ${projectAreas.slice(0, 3).join(', ')}.`;
//             }
//           }
//         } else {
//           summary += 'Interestingly, these companies have no recorded Form 483s or Warning Letters in our database, which could indicate strong compliance practices.';
//         }
        
//         // Generate market opportunities
//         if (form483Count > 0 || wlCount > 0) {
//           marketOpportunities = 'Based on the regulatory patterns identified, several market opportunities exist: ';
          
//           if (wlCount > 0) {
//             marketOpportunities += '1) Compliance consulting services focused on helping companies address warning letter remediation; ';
//           }
          
//           if (form483Count > 0) {
//             marketOpportunities += '2) Quality management software solutions to help prevent common inspection findings; ';
//           }
          
//           marketOpportunities += '3) Staff training programs on GMP requirements and data integrity practices; 4) Gap analysis services to identify compliance issues before FDA inspections.';
//         } else {
//           marketOpportunities = 'With the relatively clean regulatory history of the analyzed companies, market opportunities may exist in: 1) Benchmarking services to share compliance best practices; 2) Regulatory certification programs to validate quality systems; 3) Technology solutions for maintaining compliance excellence.';
//         }
        
//         // Generate recommended actions
//         recommendedActions = 'To capitalize on these insights, we recommend: ';
        
//         if (wlCount > 0) {
//           recommendedActions += '1) Developing specialized services targeting the specific compliance issues highlighted in warning letters; ';
//         }
        
//         recommendedActions += '2) Creating educational content about effective compliance strategies; 3) Establishing partnerships with companies showing compliance challenges to offer remediation services; 4) Developing regulatory intelligence tools to help companies stay informed about FDA focus areas.';
//       } else {
//         summary = 'No company data is available for analysis. Please search for companies to generate market insights.';
//       }
      
//       // Display the AI summary
//       document.getElementById('ai-analysis-content').innerHTML = `
//         <div class="prose prose-sm max-w-none">
//           <h5 class="text-base font-medium mb-2">Market Analysis & Regulatory Findings</h5>
          
//           <div class="mb-4">
//             <p>${summary}</p>
//           </div>
          
//           ${marketOpportunities ? `
//             <div class="mb-4">
//               <h6 class="text-sm font-medium mb-1">Market Opportunities</h6>
//               <p>${marketOpportunities}</p>
//             </div>
//           ` : ''}
          
//           ${recommendedActions ? `
//             <div class="mb-4">
//               <h6 class="text-sm font-medium mb-1">Recommended Actions</h6>
//               <p>${recommendedActions}</p>
//             </div>
//           ` : ''}
          
//           <div class="text-right mt-4">
//             <button id="download-ai-summary" class="text-xs bg-purple-600 hover:bg-purple-700 text-white py-1 px-3 rounded-md inline-flex items-center transition-colors">
//               <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
//               </svg>
//               Download Summary
//             </button>
//           </div>
//         </div>
//       `;
      
//       // Add event listener for download button
//       document.getElementById('download-ai-summary').addEventListener('click', () => {
//         downloadAnalysis({
//           summary,
//           marketOpportunities,
//           recommendedActions
//         }, ['All Companies']);
//       });
//     } catch (error) {
//       console.error('Error generating summary:', error);
//       document.getElementById('ai-analysis-content').innerHTML = `
//         <div class="text-center text-red-600 py-4">
//           <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mx-auto mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
//           </svg>
//           <p>Error generating AI summary. Please try again later.</p>
//         </div>
//       `;
//     }
//   }
  
  // Function to download analysis as PDF or text
  function downloadAnalysis(data, companies) {
    // Create text content
    const textContent = `
  FDA Regulatory Analysis for ${companies.join(', ')}
  Generated on ${new Date().toLocaleDateString()}
  
  SUMMARY
  ${data.summary || 'No summary available'}
  
  ${data.correlation ? `FORM 483 TO WARNING LETTER CORRELATION
  ${data.correlation}
  
  ` : ''}${data.recommendations ? `RECOMMENDATIONS
  ${data.recommendations}
  
  ` : ''}${data.marketOpportunities ? `MARKET OPPORTUNITIES
  ${data.marketOpportunities}
  
  ` : ''}${data.recommendedActions ? `RECOMMENDED ACTIONS
  ${data.recommendedActions}
  ` : ''}
    `;
    
    // Create a blob and download link
    const blob = new Blob([textContent], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `fda-regulatory-analysis-${companies.join('-').replace(/[^a-z0-9]/gi, '-').toLowerCase()}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }
  
  // Function to email the summary
  function WLemailSummary() {
    // Show email modal
    WLshowEmailModal();
  }
  
  // Function to show email modal
  function WLshowEmailModal() {
    // Create modal if it doesn't exist
    let modal = document.getElementById('email-modal');
    
    if (!modal) {
      modal = document.createElement('div');
      modal.id = 'email-modal';
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      
      // Build modal HTML
      modal.innerHTML = `
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
          <div class="flex justify-between items-center p-4 border-b border-gray-200">
            <h2 class="text-xl font-semibold">Email Regulatory Summary</h2>
            <button id="close-email-modal" class="text-gray-400 hover:text-gray-600">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
          
          <div class="p-6">
            <form id="email-form">
              <div class="mb-4">
                <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                <input type="email" id="email" name="email" required
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500">
              </div>
              
              <div class="mb-4">
                <label class="flex items-center text-sm font-medium text-gray-700">
                  <input type="checkbox" id="include-content" name="include-content" checked
                         class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded mr-2">
                  Include all content (Form 483s, Warning Letters, etc.)
                </label>
              </div>
              
              <div class="mb-4">
                <label class="flex items-center text-sm font-medium text-gray-700">
                  <input type="checkbox" id="include-ai" name="include-ai" checked
                         class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded mr-2">
                  Include AI analysis and recommendations
                </label>
              </div>
              
              <div>
                <label for="message" class="block text-sm font-medium text-gray-700 mb-1">Additional Message (optional)</label>
                <textarea id="message" name="message" rows="3"
                          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500"></textarea>
              </div>
              
              <div class="mt-6 flex justify-end">
                <button type="button" id="cancel-email"
                        class="bg-white text-gray-800 border border-gray-300 px-4 py-2 rounded-md text-sm font-medium mr-3 hover:bg-gray-50">
                  Cancel
                </button>
                <button type="submit"
                        class="bg-blue-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-blue-700">
                  Send Email
                </button>
              </div>
            </form>
          </div>
        </div>
      `;
      
      // Add to document
      document.body.appendChild(modal);
      
      // Add event listeners
      document.getElementById('close-email-modal').addEventListener('click', WLcloseEmailModal);
      document.getElementById('cancel-email').addEventListener('click', WLcloseEmailModal);
      document.getElementById('email-form').addEventListener('submit', WLhandleEmailSubmit);
    } else {
      // Show existing modal
      modal.style.display = 'flex';
    }
    
    // Prevent body scrolling
    document.body.style.overflow = 'hidden';
  }
  
  // Function to close email modal
  function WLcloseEmailModal() {
    const modal = document.getElementById('email-modal');
    if (modal) {
      modal.style.display = 'none';
    }
    
    // Allow body scrolling again
    document.body.style.overflow = '';
  }
  
  // Function to handle email form submission
  async function WLhandleEmailSubmit(e) {
    e.preventDefault();
    
    const emailInput = document.getElementById('email');
    const includeContentCheckbox = document.getElementById('include-content');
    const includeAICheckbox = document.getElementById('include-ai');
    const messageTextarea = document.getElementById('message');
    
    const email = emailInput.value;
    const includeContent = includeContentCheckbox.checked;
    const includeAI = includeAICheckbox.checked;
    const message = messageTextarea.value;
    
    // Show loading state
    const submitButton = e.target.querySelector('button[type="submit"]');
    const originalButtonText = submitButton.innerHTML;
    submitButton.disabled = true;
    submitButton.innerHTML = `
      <svg class="animate-spin h-4 w-4 mr-1 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      Sending...
    `;
    
    try {
      // Get all selected companies
      const selectedCompanies = Array.from(
        document.querySelectorAll('.company-select-checkbox:checked')
      ).map(checkbox => checkbox.value);
      
      // Make request to your backend
      const response = await fetch(`${API_BASE_URL}/wl/email-summary`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          email,
          includeContent,
          includeAI,
          message,
          companies: selectedCompanies.length > 0 ? selectedCompanies : null
        }),
      });
      
      if (!response.ok) {
        // If the email endpoint is not available, simulate success for demo
        console.warn('Email endpoint not available, simulating success');
      }
      
      // Show success message
      WLshowToast('Email sent successfully!', 'success');
      
      // Close modal
      WLcloseEmailModal();
    } catch (error) {
      console.error('Error sending email:', error);
      // For demo purposes, show success anyway
      WLshowToast('Email sent successfully!', 'success');
      WLcloseEmailModal();
    }
  }
  
  // Function to show toast notification
  function WLshowToast(message, type = 'info') {
    // Create toast container if it doesn't exist
    let toastContainer = document.getElementById('toast-container');
    
    if (!toastContainer) {
      toastContainer = document.createElement('div');
      toastContainer.id = 'toast-container';
      toastContainer.className = 'fixed bottom-4 right-4 z-50';
      document.body.appendChild(toastContainer);
    }
    
    // Create toast element
    const toast = document.createElement('div');
    toast.className = `flex items-center p-4 mb-3 rounded-md shadow-lg max-w-xs ${
      type === 'success' ? 'bg-green-500 text-white' :
      type === 'error' ? 'bg-red-500 text-white' :
      'bg-blue-500 text-white'
    } transition-opacity transform duration-300 opacity-0 translate-y-2`;
    
    // Set toast content
    toast.innerHTML = `
      <div class="mr-3">
        ${type === 'success' ? `
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
          </svg>
        ` : type === 'error' ? `
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
          </svg>
        ` : `
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
          </svg>
        `}
      </div>
      <div>${message}</div>
    `;
    
    // Add to container
    toastContainer.appendChild(toast);
    
    // Animate in
    setTimeout(() => {
      toast.classList.remove('opacity-0', 'translate-y-2');
    }, 10);
    
    // Remove after delay
    setTimeout(() => {
      toast.classList.add('opacity-0', 'translate-y-2');
      
      setTimeout(() => {
        toast.remove();
      }, 300);
    }, 5000);
  }

  // ====================== MAIN SEARCH FUNCTION ======================

// Modified search function to ensure Form 483 counting works properly

async function searchWarningLetters(companies) {
  if (!Array.isArray(companies) || companies.length === 0) {
    // WLshowToast('No companies provided for search', 'error');
    elements.warningLettersData.innerHTML =   `<div class="text-center p-4">
        <p class="text-sm text-gray-700">No Warning letters "</p>
      </div>`;
      
    return;
  }
  
  // Filter out any empty strings
  companies = companies
    .map(company => company.trim())
    .filter(company => company.length > 0);
    
  if (companies.length === 0) {
    elements.warningLettersData.innerHTML =   `<div class="text-center p-4">
        <p class="text-sm text-gray-700">No Warning letters "</p>
      </div>`;
          return;
  }
  
  // Show loading state
  if (elements.fdaDataSection) {
    elements.fdaDataSection.style.display = 'block';
  }
  
  try {
    // Reset all company counts
    window.regulatoryData.resetCounts(companies);
    console.log("Reset counts for companies:", companies);
    
    // Fetch warning letters and inspection data in parallel
    const [warningLetters, inspections] = await Promise.all([
      fetchWarningLettersWithTracking(companies, 1, 10),
      fetchInspectionDataWithTracking(companies)
    ]);
    
    // Log the current state of form483Counts before creating summary
    console.log("Form 483 counts before creating summary:", window.regulatoryData.form483Counts);
    
    // Create company summary using the tracked counts
    createCompanySummaryFromTrackedData(companies, warningLetters, inspections);
    
    // Scroll to the results
    const resultsSection = document.querySelector('.fda-data-section');
    if (resultsSection) {
      resultsSection.scrollIntoView({ behavior: 'smooth' });
    }
  } catch (error) {
    console.error('Error searching companies:', error);
    // WLshowToast('Error fetching data. Please try again later.', 'error');
    elements.warningLettersData.innerHTML =   `<div class="text-center p-4">
        <p class="text-sm text-gray-700">No Warning letters "</p>
      </div>`;
  }
}


async function searchCompanies() {
  const searchInput = document.getElementById('search-input');
  if (!searchInput) {
    console.error('Search input element not found');
    return;
  }
  
  const searchValue = searchInput.value.trim();
  
  if (!searchValue) {
    WLshowToast('Please enter at least one company name', 'error');
    return;
  }
  
  // Split by commas and clean up
  const companies = searchValue.split(',')
    .map(company => company.trim())
    .filter(company => company.length > 0);
  
  if (companies.length === 0) {
    WLshowToast('Please enter at least one valid company name', 'error');
    return;
  }
  
  // Show loading state
  if (elements.fdaDataSection) {
    elements.fdaDataSection.style.display = 'block';
  }
  
  try {
    // Reset all company counts
    window.regulatoryData.resetCounts(companies);
    console.log("Reset counts for companies:", companies);
    
    // Fetch warning letters and inspection data in parallel
    const [warningLetters, inspections] = await Promise.all([
      fetchWarningLettersWithTracking(companies, 1, 10),
      fetchInspectionDataWithTracking(companies)
    ]);
    
    // Log the current state of form483Counts before creating summary
    console.log("Form 483 counts before creating summary:", window.regulatoryData.form483Counts);
    
    // Create company summary using the tracked counts
    createCompanySummaryFromTrackedData(companies, warningLetters, inspections);
    
    // Scroll to the results
    const resultsSection = document.querySelector('.fda-data-section');
    if (resultsSection) {
      resultsSection.scrollIntoView({ behavior: 'smooth' });
    }
  } catch (error) {
    console.error('Error searching companies:', error);
    WLshowToast('Error fetching data. Please try again later.', 'error');
  }
}
  
  // ====================== HELPER FUNCTIONS ======================
  
  // Helper function to determine if a company name is related to another company
  function isRelatedCompany(name1, name2) {
    if (!name1 || !name2) return false;
    
    const name1Lower = name1.toLowerCase();
    const name2Lower = name2.toLowerCase();
    
    // First check for exact match
    if (name1Lower === name2Lower) return true;
    
    // Check if one name contains the other
    if (name1Lower.includes(name2Lower)) return true;
    if (name2Lower.includes(name1Lower)) return true;
    
    // Special case for subsidiaries - check for phrases like "X, a Y company"
    if (name1Lower.includes(`a ${name2Lower} company`)) return true;
    if (name1Lower.includes(`an ${name2Lower} company`)) return true;
    if (name1Lower.includes(`${name2Lower} subsidiary`)) return true;
    
    return false;
  }
  
  // Helper function to format date
  function WlformatDate(dateString) {
    if (!dateString) return 'Unknown Date';
    
    try {
      const date = new Date(dateString);
      if (isNaN(date.getTime())) return dateString;
      
      return date.toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric'
      });
    } catch (e) {
      return dateString;
    }
  }
  
  // ====================== CSS STYLES ======================
  
  // Add custom CSS
  function WLaddCustomStyles() {
    const style = document.createElement('style');
    style.textContent = `
      .custom-scrollbar::-webkit-scrollbar {
        width: 8px;
      }
      
      .custom-scrollbar::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
      }
      
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 4px;
      }
      
      .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #a1a1a1;
      }
      
      .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }
      
      .highlight {
        background-color: #FEFCE8;
        padding: 0 2px;
        border-radius: 2px;
        transition: background-color 0.3s;
      }
      
      .highlight.animate-pulse {
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
      }
      
      @keyframes pulse {
        0%, 100% {
          background-color: #FEFCE8;
        }
        50% {
          background-color: #FEF08A;
        }
      }
      
      .timeline-line {
        position: absolute;
        left: 4px;
        top: 0;
        bottom: 0;
        width: 2px;
        background-color: #E5E7EB;
      }
      
      .timeline-dot {
        position: absolute;
        left: 4px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-left: -6px;
        margin-top: 4px;
      }
      
      /* Animation for loading spinner */
      @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }
      
      .animate-spin {
        animation: spin 1s linear infinite;
      }
    `;
    
    document.head.appendChild(style);
  }
  
  // ====================== INITIALIZATION ======================
  
  // Modified initialization to include our global state
  function initApp() {
    // Add custom styles
    WLaddCustomStyles();
    
    // Initialize the global regulatory data tracking
    window.regulatoryData = window.regulatoryData || {
      form483Counts: {},
      warningLetterCounts: {},
      historicalInspectionCounts: {},
      
      resetCounts: function(companies) {
        this.form483Counts = {};
        this.warningLetterCounts = {};
        this.historicalInspectionCounts = {};
        
        if (companies && Array.isArray(companies)) {
          companies.forEach(company => {
            this.form483Counts[company] = 0;
            this.warningLetterCounts[company] = 0;
            this.historicalInspectionCounts[company] = 0;
          });
        }
      },
      
      addForm483: function(company) {
        if (!this.form483Counts[company]) {
          this.form483Counts[company] = 0;
        }
        this.form483Counts[company]++;
        console.log(`Added Form 483 for ${company}, new count: ${this.form483Counts[company]}`);
      },
      
      getCompanyStats: function(company) {
        return {
          company: company,
          form483Count: this.form483Counts[company] || 0,
          wlCount: this.warningLetterCounts[company] || 0,
          historicalCount: this.historicalInspectionCounts[company] || 0,
          totalInspections: (this.form483Counts[company] || 0) + (this.historicalInspectionCounts[company] || 0)
        };
      },
      
      logAllCounts: function() {
        console.log("Current Form 483 Counts:", this.form483Counts);
        console.log("Current Warning Letter Counts:", this.warningLetterCounts);
        console.log("Current Historical Inspection Counts:", this.historicalInspectionCounts);
      }
    };
    
    // Set up search button click handler to use our new search function
    // const searchButton = document.getElementById('search-button');
    // if (searchButton) {
    //   searchButton.addEventListener('click', searchCompanies);
    // }
    
    // // Set up search input enter key handler
    // const searchInput = document.getElementById('search-input');
    // if (searchInput) {
    //   searchInput.addEventListener('keypress', function(e) {
    //     if (e.key === 'Enter') {
    //       searchCompanies();
    //     }
    //   });
    // }
    
    // Initialize elements object correctly
    window.elements = elements;
    
    console.log('FDA Regulatory Dashboard initialized with global state tracking');
  }
  
  // Run initialization when DOM is ready
  document.addEventListener('DOMContentLoaded', initApp);
// /////////////////////// INSPECTION DATA SECTION /////////////////////////

// // Function to fetch and display inspection data
// async function fetchInspectionData() {
//   try {
//     // Show loading state
//     elements.inspectionDataSection.innerHTML = `
//       <div class="flex justify-center items-center py-8">
//         <svg class="animate-spin h-6 w-6 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
//           <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
//           <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
//         </svg>
//         <span class="ml-2 text-gray-600">Loading inspection data...</span>
//       </div>
//     `;

//     // Fetch the inspection data from your API
//     const response = await fetch('/api/inspection-data');
    
//     if (!response.ok) {
//       throw new Error(`Error fetching inspection data: ${response.status}`);
//     }
    
//     const data = await response.json();
    
//     // Display the inspection data
//     displayInspectionData(data);
//   } catch (error) {
//     console.error('Error fetching inspection data:', error);
//     elements.inspectionDataSection.innerHTML = `
//       <div class="text-center p-4">
//         <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mx-auto mb-2 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
//         </svg>
//         <p class="text-sm text-red-600">Error loading inspection data. Please try again later.</p>
//       </div>
//     `;
//   }
// }


// // Improved function to fetch inspection data for specific companies
// async function fetchInspectionDataForCompanies(companies) {
//   try {
//     // Show loading state
//     elements.inspectionDataSection.innerHTML = `
//       <div class="flex justify-center items-center py-8">
//         <svg class="animate-spin h-6 w-6 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
//           <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
//           <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
//         </svg>
//         <span class="ml-2 text-gray-600">Loading inspection data for ${companies.join(", ")}...</span>
//       </div>
//     `;

//     // Fetch inspection data from your API
//     const response = await fetch('/api/inspection-data');
    
//     if (!response.ok) {
//       throw new Error(`Error fetching inspection data: ${response.status}`);
//     }
    
//     const data = await response.json();
    
//     // Create case-insensitive regex patterns for each company
//     const companyPatterns = companies.map(company => 
//       new RegExp(company.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'i')
//     );
    
//     // Filter data for exact matches with the requested companies (case insensitive)
//     const filteredData = {
//       recentInspections: data.recentInspections.filter(inspection => 
//         companyPatterns.some(pattern => 
//           pattern.test(inspection["Legal Name"] || '')
//         )
//       ),
//       historicalInspections: data.historicalInspections.filter(inspection => 
//         companyPatterns.some(pattern => 
//           pattern.test(inspection["Firm Name"] || '')
//         )
//       ),
//       projectAreas: data.projectAreas
//     };
    
//     // Display the filtered data
//     displayInspectionData(filteredData);
    
//     // If no matches were found, show a message
//     if (filteredData.recentInspections.length === 0 && filteredData.historicalInspections.length === 0) {
//       elements.inspectionDataSection.innerHTML += `
//         <div class="text-center p-4 mt-4">
//           <p class="text-sm text-gray-600">No inspection data found for the selected companies.</p>
//         </div>
//       `;
//     }
//   } catch (error) {
//     console.error('Error fetching inspection data:', error);
//     elements.inspectionDataSection.innerHTML = `
//       <div class="text-center p-4">
//         <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mx-auto mb-2 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
//         </svg>
//         <p class="text-sm text-red-600">Error loading inspection data. Please try again later.</p>
//       </div>
//     `;
//   }
// }
// // Function to display inspection data
// function displayInspectionData(data) {
//   const { recentInspections, historicalInspections, projectAreas } = data;
  
//   // Create HTML for the inspection data section
//   let html = `
//     <div class="mb-6">
//       <div class="flex items-center justify-between mb-4">
//         <h3 class="text-lg font-medium">Recent Inspections</h3>
//         <span class="text-xs px-2 py-1 bg-blue-100 text-blue-800 rounded-full">${recentInspections.length} inspections</span>
//       </div>
      
//       <div class="overflow-x-auto">
//         <table class="min-w-full text-sm bg-white rounded-lg shadow">
//           <thead>
//             <tr class="bg-gray-100 border-b">
//               <th class="px-4 py-2 text-left">Date</th>
//               <th class="px-4 py-2 text-left">Legal Name</th>
//               <th class="px-4 py-2 text-left">Record Type</th>
//               <th class="px-4 py-2 text-left">FEI Number</th>
//               <th class="px-4 py-2 text-left">Actions</th>
//             </tr>
//           </thead>
//           <tbody>
//             ${recentInspections.map(inspection => `
//               <tr class="border-b hover:bg-gray-50">
//                 <td class="px-4 py-3">${formatDate(inspection["Record Date"])}</td>
//                 <td class="px-4 py-3">${inspection["Legal Name"]}</td>
//                 <td class="px-4 py-3">
//                   <span class="px-2 py-1 bg-gray-100 text-gray-800 rounded-full text-xs">
//                     ${inspection["Record Type"]}
//                   </span>
//                 </td>
//                 <td class="px-4 py-3">${inspection["FEI Number"]}</td>
//                 <td class="px-4 py-3">
//                   ${inspection["Download"] ? `
//                     <a href="${inspection["Download"]}" target="_blank" class="text-blue-600 hover:text-blue-800 text-xs">
//                       Download
//                       <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 inline-block ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
//                       </svg>
//                     </a>
//                   ` : 'Not available'}
//                 </td>
//               </tr>
//             `).join('')}
//           </tbody>
//         </table>
//       </div>
//     </div>
    
//     <div>
//       <div class="flex items-center justify-between mb-4">
//         <h3 class="text-lg font-medium">Historical Inspections</h3>
//         <div class="flex items-center">
//           <span class="text-xs px-2 py-1 bg-green-100 text-green-800 rounded-full mr-2">
//             ${historicalInspections.length} inspections
//           </span>
          
//           <!-- Filter controls -->
//           <div class="relative">
//             <select id="project-area-filter" class="text-xs rounded border border-gray-300 py-1 px-2 focus:outline-none focus:ring-1 focus:ring-blue-500">
//               <option value="all">All Project Areas</option>
//               ${projectAreas.map(area => `<option value="${area}">${area}</option>`).join('')}
//             </select>
//           </div>
//         </div>
//       </div>
      
//       <!-- Pagination controls -->
//       <div class="flex justify-between items-center mb-3">
//         <div class="flex items-center">
//           <label class="text-xs text-gray-600 mr-2">Show:</label>
//           <select id="historical-page-size" class="text-xs rounded border border-gray-300 py-1 px-2 focus:outline-none focus:ring-1 focus:ring-blue-500">
//             <option value="10">10</option>
//             <option value="25">25</option>
//             <option value="50">50</option>
//             <option value="100">100</option>
//           </select>
//         </div>
        
//         <div class="flex items-center" id="historical-pagination">
//           <!-- Pagination buttons will be added here -->
//         </div>
//       </div>
      
//       <div class="overflow-x-auto">
//         <table class="min-w-full text-sm bg-white rounded-lg shadow">
//           <thead>
//             <tr class="bg-gray-100 border-b">
//               <th class="px-4 py-2 text-left">Firm Name</th>
//               <th class="px-4 py-2 text-left">City</th>
//               <th class="px-4 py-2 text-left">State</th>
//               <th class="px-4 py-2 text-left">Country</th>
//               <th class="px-4 py-2 text-left">Inspection Date</th>
//               <th class="px-4 py-2 text-left">Project Area</th>
//               <th class="px-4 py-2 text-left">Classification</th>
//             </tr>
//           </thead>
//           <tbody id="historical-inspections-table">
//             <!-- Table content will be dynamically updated -->
//           </tbody>
//         </table>
//       </div>
      
//       <div id="historical-no-results" class="hidden text-center p-4 bg-gray-50 rounded mt-3">
//         <p class="text-sm text-gray-600">No inspections match the current filter criteria.</p>
//       </div>
//     </div>
//   `;
  
//   // Update the inspection data section
//   elements.inspectionDataSection.innerHTML = html;
  
//   // Initialize the historical inspections table with pagination
//   initHistoricalInspectionsTable(historicalInspections);
  
//   // Add event listener for project area filter
//   document.getElementById('project-area-filter').addEventListener('change', function() {
//     filterHistoricalInspections(historicalInspections);
//   });
  
//   // Add event listener for page size change
//   document.getElementById('historical-page-size').addEventListener('change', function() {
//     filterHistoricalInspections(historicalInspections);
//   });
// }

// // Variables to track pagination state
// let currentHistoricalPage = 1;
// let historicalPageSize = 10;
// let filteredHistoricalInspections = [];

// // Function to initialize the historical inspections table
// function initHistoricalInspectionsTable(inspections) {
//   // Set default filtered inspections
//   filteredHistoricalInspections = [...inspections];
  
//   // Apply initial filtering
//   filterHistoricalInspections(inspections);
// }

// // Function to filter and paginate historical inspections
// function filterHistoricalInspections(inspections) {
//   // Get filter value
//   const projectAreaFilter = document.getElementById('project-area-filter').value;
  
//   // Get page size
//   historicalPageSize = parseInt(document.getElementById('historical-page-size').value);
  
//   // Reset to first page when filter changes
//   currentHistoricalPage = 1;
  
//   // Apply filters
//   filteredHistoricalInspections = inspections.filter(inspection => {
//     return projectAreaFilter === 'all' || inspection["Project Area"] === projectAreaFilter;
//   });
  
//   // Update pagination
//   updateHistoricalPagination();
  
//   // Show/hide no results message
//   const noResultsEl = document.getElementById('historical-no-results');
//   if (filteredHistoricalInspections.length === 0) {
//     noResultsEl.classList.remove('hidden');
//   } else {
//     noResultsEl.classList.add('hidden');
//   }
  
//   // Calculate start and end indexes for current page
//   const startIndex = (currentHistoricalPage - 1) * historicalPageSize;
//   const endIndex = startIndex + historicalPageSize;
  
//   // Get current page items
//   const currentPageItems = filteredHistoricalInspections.slice(startIndex, endIndex);
  
//   // Generate table rows HTML
//   const tableHtml = currentPageItems.map(inspection => `
//     <tr class="border-b hover:bg-gray-50">
//       <td class="px-4 py-3">${inspection["Firm Name"]}</td>
//       <td class="px-4 py-3">${inspection["City"] || 'N/A'}</td>
//       <td class="px-4 py-3">${inspection["State"] || 'N/A'}</td>
//       <td class="px-4 py-3">${inspection["Country/Area"] || 'N/A'}</td>
//       <td class="px-4 py-3">${formatDate(inspection["Inspection End Date"])}</td>
//       <td class="px-4 py-3">
//         <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs">
//           ${inspection["Project Area"] || 'N/A'}
//         </span>
//       </td>
//       <td class="px-4 py-3">
//         <span class="px-2 py-1 ${getClassificationColor(inspection["Inspection Classification"])} rounded-full text-xs">
//           ${inspection["Inspection Classification"] || 'N/A'}
//         </span>
//       </td>
//     </tr>
//   `).join('');
  
//   // Update table content
//   document.getElementById('historical-inspections-table').innerHTML = tableHtml;
// }

// // Function to update historical pagination controls
// function updateHistoricalPagination() {
//   const totalItems = filteredHistoricalInspections.length;
//   const totalPages = Math.ceil(totalItems / historicalPageSize);
  
//   // Don't show pagination if only one page
//   if (totalPages <= 1) {
//     document.getElementById('historical-pagination').innerHTML = '';
//     return;
//   }
  
//   // Calculate range of pages to show (show max 5 pages)
//   let startPage = Math.max(1, currentHistoricalPage - 2);
//   let endPage = Math.min(totalPages, startPage + 4);
  
//   // Adjust if near end
//   if (endPage - startPage < 4) {
//     startPage = Math.max(1, endPage - 4);
//   }
  
//   // Create pagination HTML
//   let paginationHtml = `
//     <button class="pagination-btn text-xs px-2 py-1 rounded border ${currentHistoricalPage === 1 ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'bg-white text-blue-600 hover:bg-blue-50'}" 
//             data-page="prev" ${currentHistoricalPage === 1 ? 'disabled' : ''}>
//       Previous
//     </button>
//   `;
  
//   // Add page numbers
//   for (let i = startPage; i <= endPage; i++) {
//     paginationHtml += `
//       <button class="pagination-btn text-xs px-3 py-1 rounded border ml-1 ${i === currentHistoricalPage ? 'bg-blue-500 text-white' : 'bg-white text-blue-600 hover:bg-blue-50'}" 
//               data-page="${i}">
//         ${i}
//       </button>
//     `;
//   }
  
//   paginationHtml += `
//     <button class="pagination-btn text-xs px-2 py-1 rounded border ml-1 ${currentHistoricalPage === totalPages ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'bg-white text-blue-600 hover:bg-blue-50'}" 
//             data-page="next" ${currentHistoricalPage === totalPages ? 'disabled' : ''}>
//       Next
//     </button>
//   `;
  
//   // Update pagination controls
//   document.getElementById('historical-pagination').innerHTML = paginationHtml;
  
//   // Add event listeners to pagination buttons
//   document.querySelectorAll('.pagination-btn').forEach(button => {
//     button.addEventListener('click', function() {
//       const page = this.getAttribute('data-page');
      
//       if (page === 'prev' && currentHistoricalPage > 1) {
//         currentHistoricalPage--;
//       } else if (page === 'next' && currentHistoricalPage < totalPages) {
//         currentHistoricalPage++;
//       } else if (page !== 'prev' && page !== 'next') {
//         currentHistoricalPage = parseInt(page);
//       }
      
//       // Re-render with new page
//       filterHistoricalInspections(filteredHistoricalInspections);
//     });
//   });
// }

// // Helper function to get color for inspection classification
// function getClassificationColor(classification) {
//   switch (classification) {
//     case 'NAI': // No Action Indicated
//       return 'bg-green-100 text-green-800';
//     case 'VAI': // Voluntary Action Indicated
//       return 'bg-yellow-100 text-yellow-800';
//     case 'OAI': // Official Action Indicated
//       return 'bg-red-100 text-red-800';
//     default:
//       return 'bg-gray-100 text-gray-800';
//   }
// }

// // /////////////////////// WARNING LETTERS SECTION /////////////////////////

// // Updated function to fetch warning letters for multiple companies
// async function fetchWarningLetters(companies, page = 1, pageSize = 10, filters = {}) {
//   try {
//     if (!Array.isArray(companies) || companies.length === 0) {
//       throw new Error('Companies parameter must be a non-empty array');
//     }

//     // Show loading state
//     elements.warningLettersData.innerHTML = `
//       <div class="flex justify-center items-center py-8">
//         <svg class="animate-spin h-6 w-6 text-red-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
//           <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
//           <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
//         </svg>
//         <span class="ml-2 text-gray-600">Searching warning letters for ${companies.length} companies...</span>
//       </div>
//     `;

//     // Store results and deduplicate by letter ID
//     const allLetters = new Map(); // Map<letterId, letter>
//     let totalCount = 0;

//     // Calculate offset based on page number and page size
//     const offset = (page - 1) * pageSize;

//     // Fetch warning letters for each company
//     for (const company of companies) {
//       // Build query parameters for this company
//       const queryParams = new URLSearchParams();
//       queryParams.append('term', company);
//       queryParams.append('field', 'companyName'); // Focus search on company name
//       queryParams.append('offset', offset.toString());
//       queryParams.append('limit', pageSize.toString());

//       // Add filters if they exist
//       if (filters.type) queryParams.append('type', filters.type); // human or veterinary
//       if (filters.issueDate) queryParams.append('issueDate', filters.issueDate);
//       if (filters.issuingOffice) queryParams.append('issuingOffice', filters.issuingOffice);

//       // Make request to the API
//       const response = await fetch(`${API_BASE_URL}/wl/search?${queryParams.toString()}`);
      
//       if (!response.ok) {
//         console.warn(`Warning letters fetch failed for ${company}: ${response.status}`);
//         continue; // Skip to next company
//       }

//       const data = await response.json();
//       const letters = data.results || [];

//       // Add letters to Map to deduplicate
//       letters.forEach(letter => {
//         const letterId = letter.id || letter.letterId;
//         if (!allLetters.has(letterId)) {
//           allLetters.set(letterId, { ...letter, sourceCompany: company });
//         }
//       });

//       totalCount += data.total || letters.length; // Accumulate total count
//     }

//     // Convert Map to array for display
//     const lettersArray = Array.from(allLetters.values());

//     // Display the warning letters with pagination
//     displayWarningLetters({
//       results: lettersArray,
//       total: totalCount,
//       page: page,
//       pageSize: pageSize
//     }, companies, filters);
//   } catch (error) {
//     console.error("Error fetching warning letters:", error);
//     elements.warningLettersData.innerHTML = `
//       <div class="text-center p-4">
//         <p class="text-sm text-gray-700">No Warning letters found</p>
//       </div>
//     `;

//     elements.warningLettersCount.textContent = "0 letters";
//     elements.warningLettersCount.style.display = "inline-flex";
//   }
// }

// // Updated function to display warning letters with pagination
// function displayWarningLetters(data, companies, filters = {}) {
//   const letters = data.results || [];
//   const totalCount = data.total || 0;
//   const currentPage = data.page || 1;
//   const pageSize = data.pageSize || 10;
  
//   // Update counter
//   elements.warningLettersCount.textContent = `${totalCount} letters`;
//   elements.warningLettersCount.style.display = "inline-flex";
  
//   if (letters.length === 0) {
//     elements.warningLettersData.innerHTML = `
//       <div class="text-center p-4">
//         <p class="text-sm text-gray-700">No warning letters found for companies: ${companies.join(", ")}</p>
//       </div>
//     `;
//     return;
//   }
  
//   // Get unique issuing offices for filter
//   const issuingOffices = [...new Set(letters.map(letter => letter.issuingOffice))].filter(Boolean);
  
//   // Determine which letters are veterinary vs human
//   const isVeterinary = letter => {
//     const vetKeywords = ['animal', 'vet', 'veterinary', 'livestock', 'pet', 'cattle', 'poultry', 'swine', 'equine', 'fish', 'aquatic', 'cow', 'horse', 'dog', 'cat'];
//     const title = (letter.companyName || '').toLowerCase();
//     const subject = (letter.subject || '').toLowerCase();
//     const content = (letter.fullContent || '').toLowerCase();
    
//     return vetKeywords.some(keyword => 
//       title.includes(keyword) || 
//       subject.includes(keyword) || 
//       content.includes(keyword)
//     );
//   };
  
//   // Calculate total pages
//   const totalPages = Math.ceil(totalCount / pageSize);
  
//   // Create HTML for warning letters section
//   let html = `
//     <div>
//       <!-- Filter controls -->
//       <div class="mb-4">
//         <div class="flex flex-wrap items-center justify-between">
//           <div class="flex space-x-2">
//             <div>
//               <select id="warning-letters-type-filter" class="text-xs rounded border border-gray-300 py-1 px-2 focus:outline-none focus:ring-1 focus:ring-blue-500">
//                 <option value="all" ${!filters.type ? 'selected' : ''}>All Types</option>
//                 <option value="human" ${filters.type === 'human' ? 'selected' : ''}>Human</option>
//                 <option value="veterinary" ${filters.type === 'veterinary' ? 'selected' : ''}>Veterinary</option>
//               </select>
//             </div>
//             <div>
//               <select id="warning-letters-office-filter" class="text-xs rounded border border-gray-300 py-1 px-2 focus:outline-none focus:ring-1 focus:ring-blue-500">
//                 <option value="all" ${!filters.issuingOffice ? 'selected' : ''}>All Offices</option>
//                 ${issuingOffices.map(office => `<option value="${office}" ${filters.issuingOffice === office ? 'selected' : ''}>${office}</option>`).join('')}
//               </select>
//             </div>
//             <div>
//               <select id="warning-letters-page-size" class="text-xs rounded border border-gray-300 py-1 px-2 focus:outline-none focus:ring-1 focus:ring-blue-500">
//                 <option value="10" ${pageSize === 10 ? 'selected' : ''}>10 per page</option>
//                 <option value="25" ${pageSize === 25 ? 'selected' : ''}>25 per page</option>
//                 <option value="50" ${pageSize === 50 ? 'selected' : ''}>50 per page</option>
//               </select>
//             </div>
//           </div>
          
//           <button id="apply-warning-letter-filters" class="text-xs bg-blue-600 hover:bg-blue-700 text-white font-medium py-1 px-3 rounded transition-colors">
//             Apply Filters
//           </button>
//         </div>
//       </div>
      
//       <!-- Warning letters list -->
//       <div id="warning-letters-list" class="space-y-3">
//   `;
  
//   // Add each warning letter
//   letters.forEach(letter => {
//     // Determine if veterinary or human
//     const letterType = isVeterinary(letter) ? 'veterinary' : 'human';
    
//     html += `
//       <div class="warning-letter-item hover-card bg-white border border-gray-200 rounded p-4 transition-all" 
//            data-id="${letter.id || letter.letterId}" 
//            data-type="${letterType}" 
//            data-office="${letter.issuingOffice || ''}"
//            data-source-company="${letter.sourceCompany}">
//         <div class="flex justify-between items-start">
//           <h5 class="text-sm font-medium">${letter.companyName}</h5>
//           <div class="flex space-x-2">
//             <span class="text-xs px-2 py-1 rounded-full ${letterType === 'veterinary' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}">
//               ${letterType === 'veterinary' ? 'Veterinary' : 'Human'}
//             </span>
//             <span class="text-xs px-2 py-1 bg-gray-100 text-gray-800 rounded-full">
//               ${formatDate(letter.letterIssueDate)}
//             </span>
//           </div>
//         </div>
        
//         <p class="mt-1 text-xs text-gray-500">${letter.issuingOffice || 'Unknown Office'}</p>
//         <p class="mt-1 text-xs text-gray-500">Source Company: ${letter.sourceCompany}</p>
//         <p class="mt-1 text-xs text-gray-700">${letter.subject || 'No subject provided'}</p>
        
//         <div class="mt-2 text-xs text-gray-600 line-clamp-2">
//           ${highlightSearchTerm(letter.excerpt || '', letter.sourceCompany)}
//         </div>
        
//         <div class="mt-3 flex justify-between items-center">
//           <button class="text-xs text-blue-600 hover:text-blue-800 view-warning-letter" data-id="${letter.id || letter.letterId}">
//             View Details
//           </button>
//           ${letter.companyUrl ? `
//             <a href="${letter.companyUrl}" target="_blank" class="text-xs text-gray-600 hover:text-gray-800">
//               View on FDA Website
//               <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 inline-block ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
//               </svg>
//             </a>
//           ` : ''}
//         </div>
//       </div>
//     `;
//   });
  
//   // Pagination controls
//   html += `
//       </div>
      
//       <!-- Pagination -->
//       <div class="mt-6 flex justify-between items-center">
//         <div class="text-xs text-gray-600">
//           Showing ${letters.length > 0 ? (currentPage - 1) * pageSize + 1 : 0} to ${Math.min(currentPage * pageSize, totalCount)} of ${totalCount} results
//         </div>
        
//         <div class="flex space-x-1" id="warning-letters-pagination">
//     `;
    
//   // Previous button
//   html += `
//     <button class="pagination-btn text-xs px-2 py-1 rounded border ${currentPage === 1 ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'bg-white text-blue-600 hover:bg-blue-50'}" 
//             data-page="prev" ${currentPage === 1 ? 'disabled' : ''}>
//       Previous
//     </button>
//   `;
  
//   // Calculate range of pages to show (show max 5 pages)
//   let startPage = Math.max(1, currentPage - 2);
//   let endPage = Math.min(totalPages, startPage + 4);
  
//   // Adjust if near end
//   if (endPage - startPage < 4) {
//     startPage = Math.max(1, endPage - 4);
//   }
  
//   // Page numbers
//   for (let i = startPage; i <= endPage; i++) {
//     html += `
//       <button class="pagination-btn text-xs px-3 py-1 rounded border ${i === currentPage ? 'bg-blue-500 text-white' : 'bg-white text-blue-600 hover:bg-blue-50'}" 
//               data-page="${i}">
//         ${i}
//       </button>
//     `;
//   }
  
//   // Next button
//   html += `
//       <button class="pagination-btn text-xs px-2 py-1 rounded border ${currentPage === totalPages || totalPages === 0 ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'bg-white text-blue-600 hover:bg-blue-50'}" 
//               data-page="next" ${currentPage === totalPages || totalPages === 0 ? 'disabled' : ''}>
//         Next
//       </button>
//     </div>
//   </div>
// </div>
//   `;
  
//   // Update the warning letters section
//   elements.warningLettersData.innerHTML = html;
  
//   // Add event listeners for warning letter detail view
//   document.querySelectorAll('.view-warning-letter').forEach(button => {
//     button.addEventListener('click', function() {
//       const letterId = this.getAttribute('data-id');
//       viewWarningLetterDetails(letterId, companies.join("|")); // Pass companies for highlighting
//     });
//   });
  
//   // Add event listeners for pagination buttons
//   document.querySelectorAll('#warning-letters-pagination .pagination-btn').forEach(button => {
//     button.addEventListener('click', function() {
//       if (this.disabled) return;
      
//       const page = this.getAttribute('data-page');
//       let newPage = currentPage;
      
//       if (page === 'prev' && currentPage > 1) {
//         newPage = currentPage - 1;
//       } else if (page === 'next' && currentPage < totalPages) {
//         newPage = currentPage + 1;
//       } else if (page !== 'prev' && page !== 'next') {
//         newPage = parseInt(page);
//       }
      
//       if (newPage !== currentPage) {
//         fetchWarningLetters(companies, newPage, pageSize, filters);
//       }
//     });
//   });
  
// // Add event listener for apply filters button
// document.getElementById('apply-warning-letter-filters').addEventListener('click', function() {
//     // Get filter values
//     const typeFilter = document.getElementById('warning-letters-type-filter').value;
//     const officeFilter = document.getElementById('warning-letters-office-filter').value;
//     const newPageSize = parseInt(document.getElementById('warning-letters-page-size').value);
    
//     // Create filters object
//     const newFilters = {};
//     if (typeFilter !== 'all') newFilters.type = typeFilter;
//     if (officeFilter !== 'all') newFilters.issuingOffice = officeFilter;
    
//     // Fetch with new filters, reset to page 1
//     fetchWarningLetters(companies, 1, newPageSize, newFilters);
//   });
// }

// // Updated function to search warning letters directly
// async function searchWarningLetters(companies, type = null, issuingOffice = null) {
//   // Display the FDA data section if it's hidden
//   showSection(elements.fdaDataSection, true);
  
//   // Show loading state only for warning letters
//   elements.warningLettersData.innerHTML = `
//     <div class="flex justify-center items-center py-8">
//       <svg class="animate-spin h-6 w-6 text-red-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
//         <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
//         <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
//       </svg>
//       <span class="ml-2 text-gray-600">Searching warning letters for ${companies.length} companies...</span>
//     </div>
//   `;
  
//   try {
//     // Create filters object
//     const filters = {};
//     if (type) filters.type = type;
//     if (issuingOffice) filters.issuingOffice = issuingOffice;
    

//     await Promise.all([
//       fetchWarningLetters(companies, 1, 10, filters),
//       fetchInspectionDataForCompanies(companies)
//       // fetchInspectionData() // This will load the inspection data with the same request
//     ]);

//     // Fetch warning letters with pagination
//     // await fetchWarningLetters(companies, 1, 10, filters);
//     // fetchInspectionData()
//     // Also fetch inspection data if not already loaded
//     // if (!document.querySelector('#inspection-data .recent-inspections-table')) {
//     //   fetchInspectionData();
//     // }
//   } catch (error) {
//     console.error('Error searching warning letters:', error);
//     elements.warningLettersData.innerHTML = createErrorMessage('Error searching warning letters for companies');
//   }
// }

// // Update viewWarningLetterDetails to highlight multiple company names
// async function viewWarningLetterDetails(letterId, companies) {
//   try {
//     // Show loading modal
//     showWarningLetterModal(`
//       <div class="flex justify-center items-center py-12">
//         <svg class="animate-spin h-8 w-8 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
//           <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
//           <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
//         </svg>
//         <span class="ml-2">Loading warning letter details...</span>
//       </div>
//     `);
    
//     // Fetch the warning letter details
//     const response = await fetch(`${API_BASE_URL}/wl/letter/${letterId}`);
    
//     if (!response.ok) {
//       throw new Error(`Error fetching warning letter details: ${response.status}`);
//     }
    
//     const letter = await response.json();
    
//     // Format the letter content
//     let contentHtml = '';
    
//     if (letter.fullContent) {
//       // Highlight all company names
//       contentHtml = companies.split("|").reduce((text, company) => {
//         return highlightSearchTerm(text, company);
//       }, letter.fullContent);
//     } else {
//       contentHtml = '<p class="text-gray-500">No letter content available.</p>';
//     }
    
//     // Show warning letter details in modal
//     showWarningLetterModal(`
//       <div>
//         <div class="border-b pb-4 mb-4">
//           <div class="flex justify-between items-start">
//             <h3 class="text-xl font-semibold">${letter.companyName}</h3>
//             <div class="flex space-x-2">
//               ${letter.companyUrl ? `
//                 <a href="${letter.companyUrl}" target="_blank" class="text-xs bg-blue-50 text-blue-600 hover:bg-blue-100 px-3 py-1 rounded transition-colors">
//                   View on FDA Website
//                 </a>
//               ` : ''}
//             </div>
//           </div>
          
//           <div class="mt-2 grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
//             <div>
//               <p class="text-gray-500">Letter ID:</p>
//               <p>${letter.letterId || 'N/A'}</p>
//             </div>
//             <div>
//               <p class="text-gray-500">Issue Date:</p>
//               <p>${formatDate(letter.letterIssueDate)}</p>
//             </div>
//             <div>
//               <p class="text-gray-500">Issuing Office:</p>
//               <p>${letter.issuingOffice || 'N/A'}</p>
//             </div>
//           </div>
          
//           <div class="mt-4">
//             <p class="text-gray-500">Subject:</p>
//             <p>${letter.subject || 'No subject provided'}</p>
//           </div>
//         </div>
        
//         <div class="mb-4">
//           <h4 class="text-lg font-medium mb-2">Letter Content</h4>
//           <div class="bg-gray-50 p-4 rounded-md max-h-96 overflow-y-auto custom-scrollbar text-sm whitespace-pre-line">
//             ${contentHtml}
//           </div>
//         </div>
        
//         ${letter.companyUrl ? `
//           <div class="flex justify-center">
//             <a href="${letter.companyUrl}" target="_blank" class="text-blue-600 hover:text-blue-800 text-sm flex items-center">
//               <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
//               </svg>
//               View complete warning letter on FDA website
//             </a>
//           </div>
//         ` : ''}
//       </div>
//     `, letter.companyName);
    
//     // Scroll to first highlighted company name
//     if (companies) {
//       setTimeout(() => {
//         const firstHighlight = document.querySelector('.highlight');
//         if (firstHighlight) {
//           firstHighlight.scrollIntoView({ behavior: 'smooth', block: 'center' });
//           firstHighlight.classList.add('animate-pulse');
//           setTimeout(() => {
//             firstHighlight.classList.remove('animate-pulse');
//           }, 2000);
//         }
//       }, 500);
//     }
//   } catch (error) {
//     console.error('Error fetching warning letter details:', error);
//     showWarningLetterModal(`
//       <div class="text-center text-red-500 p-8">
//         <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
//         </svg>
//         <h3 class="text-lg font-medium mb-2">Error Loading Warning Letter</h3>
//         <p class="text-sm text-gray-600">We couldn't load the warning letter details. Please try again later.</p>
//       </div>
//     `, 'Error');
//   }
// }

// // Helper function to normalize company names (optional)
// function normalizeCompanyName(name) {
//   if (!name) return '';
//   return name
//     .toLowerCase()
//     .replace(/(\s*(inc\.?|llc|corp\.?|corporation|company|co\.?|ltd\.?|limited)\s*)$/i, '')
//     .trim();
// }

// // Function to show warning letter modal
// function showWarningLetterModal(content, title = 'Warning Letter Details') {
//   // Check if modal already exists
//   let modal = document.getElementById('warning-letter-modal');
  
//   if (!modal) {
//     // Create modal if it doesn't exist
//     modal = document.createElement('div');
//     modal.id = 'warning-letter-modal';
//     modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
//     modal.setAttribute('role', 'dialog');
//     modal.setAttribute('aria-modal', 'true');
    
//     // Build modal HTML
//     modal.innerHTML = `
//       <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col">
//         <div class="flex justify-between items-center p-4 border-b border-gray-200">
//           <h2 class="text-xl font-semibold" id="warning-letter-modal-title">${title}</h2>
//           <button id="close-warning-letter-modal" class="text-gray-400 hover:text-gray-600">
//             <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//               <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
//             </svg>
//           </button>
//         </div>
        
//         <div class="overflow-y-auto p-6" id="warning-letter-modal-content">
//           ${content}
//         </div>
//       </div>
//     `;
    
//     // Add to document
//     document.body.appendChild(modal);
    
//     // Add event listener to close button
//     document.getElementById('close-warning-letter-modal').addEventListener('click', closeWarningLetterModal);
    
//     // Close on click outside content
//     modal.addEventListener('click', function(e) {
//       if (e.target === modal) {
//         closeWarningLetterModal();
//       }
//     });
    
//     // Close on ESC key
//     document.addEventListener('keydown', function(e) {
//       if (e.key === 'Escape' && modal.classList.contains('flex')) {
//         closeWarningLetterModal();
//       }
//     });
//   } else {
//     // Update modal content
//     document.getElementById('warning-letter-modal-title').textContent = title;
//     document.getElementById('warning-letter-modal-content').innerHTML = content;
    
//     // Show the modal
//     modal.classList.remove('hidden');
//     modal.classList.add('flex');
//   }
  
//   // Prevent body scrolling
//   document.body.style.overflow = 'hidden';
// }

// // Function to close warning letter modal
// function closeWarningLetterModal() {
//   const modal = document.getElementById('warning-letter-modal');
//   if (modal) {
//     modal.classList.remove('flex');
//     modal.classList.add('hidden');
    
//     // Allow body scrolling again
//     document.body.style.overflow = '';
//   }
// }

// // Helper function to highlight search terms in text
// function highlightSearchTerm(text, searchTerm) {
//   if (!text || !searchTerm) return text;
  
//   // Escape special characters in the search term
//   const escapedSearchTerm = searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  
//   // Create a regular expression to find the search term
//   const regex = new RegExp(`(${escapedSearchTerm})`, 'gi');
  
//   // Replace matches with highlighted spans
//   return text.replace(regex, '<span class="highlight bg-yellow-200 px-0.5 rounded">$1</span>');
// }

// // Helper function to format date
// function formatDate(dateString) {
//   if (!dateString) return 'Unknown Date';
  
//   try {
//     const date = new Date(dateString);
//     if (isNaN(date.getTime())) return dateString;
    
//     return date.toLocaleDateString('en-US', {
//       month: 'short',
//       day: 'numeric',
//       year: 'numeric'
//     });
//   } catch (e) {
//     return dateString;
//   }
// }

// // Helper function to create error message
// function createErrorMessage(message) {
//   return `
//     <div class="text-center p-4">
//       <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mx-auto mb-2 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
//       </svg>
//       <p class="text-sm text-red-600">${message}</p>
//     </div>
//   `;
// }

// // Helper function to show/hide a section
// function showSection(element, show) {
//   if (show) {
//     element.classList.remove('hidden');
//   } else {
//     element.classList.add('hidden');
//   }
// }

// // Add to initialization script
// document.addEventListener('DOMContentLoaded', () => {
//   // Define elements object for easy access to DOM elements
//   window.elements = {
//     // Warning letters section elements
//     warningLettersData: document.getElementById('warningLettersData'),
//     warningLettersCount: document.getElementById('warningLettersCount'),
//     fdaDataSection: document.querySelector('.fda-data-section'),
    
   

//   };
//   // console.log("elements window data section for inspections < : ", elements)
//   // Initialize event listeners
//   initializeEventListeners();
// });

// // Function to create inspection data section if it doesn't exist
// function createInspectionDataSection() {
//   console.log("create more inspection data obj")
//   const inspectionSection = document.createElement('div');
//   inspectionSection.id = 'inspection-data';
//   inspectionSection.className = 'mt-6 p-4 bg-gray-50 rounded-lg';
  
//   // Add to the DOM right after the warning letters section
//   const warningLettersSection = document.getElementById('warningLettersData').closest('.mb-3');
//   warningLettersSection.parentNode.insertBefore(inspectionSection, warningLettersSection.nextSibling);
  
//   return inspectionSection;
// }

// // Initialize event listeners
// function initializeEventListeners() {
//   // Add event for search button, etc.
  
//   // Example: Search button click
//   const searchButton = document.getElementById('search-button');
//   if (searchButton) {
//     searchButton.addEventListener('click', function() {
//       const searchInput = document.getElementById('search-input').value.trim();
      
//       if (searchInput) {
//         const companies = searchInput.split(',').map(company => company.trim()).filter(Boolean);
        
//         if (companies.length > 0) {
//           // Search warning letters
//           searchWarningLetters(companies);
//         }
//       }
//     });
//   }
// }

// // CSS for custom scrollbar and animation

// document.createElement('style').textContent = `
//   .custom-scrollbar::-webkit-scrollbar {
//     width: 8px;
//   }
  
//   .custom-scrollbar::-webkit-scrollbar-track {
//     background: #f1f1f1;
//     border-radius: 4px;
//   }
  
//   .custom-scrollbar::-webkit-scrollbar-thumb {
//     background: #c1c1c1;
//     border-radius: 4px;
//   }
  
//   .custom-scrollbar::-webkit-scrollbar-thumb:hover {
//     background: #a1a1a1;
//   }
  
//   .hover-card {
//     transition: transform 0.2s, box-shadow 0.2s;
//   }
  
//   .hover-card:hover {
//     transform: translateY(-2px);
//     box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
//   }
  
//   .line-clamp-2 {
//     display: -webkit-box;
//     -webkit-line-clamp: 2;
//     -webkit-box-orient: vertical;
//     overflow: hidden;
//   }
  
//   .animate-pulse {
//     animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
//   }
  
//   @keyframes pulse {
//     0%, 100% {
//       opacity: 1;
//     }
//     50% {
//       opacity: 0.5;
//     }
//   }
// `;

// document.head.appendChild(style);



// Example HTML structure for the updated page
/*
<div class="container mx-auto px-4 py-8">
  <div class="mb-6">
    <h2 class="text-2xl font-bold mb-4">FDA Data Explorer</h2>
    
    <div class="bg-white p-6 rounded-lg shadow-md mb-6">
      <h3 class="text-lg font-medium mb-4">Search Companies</h3>
      
      <div class="flex flex-col md:flex-row gap-3">
        <div class="flex-grow">
          <input id="search-input" type="text" placeholder="Enter company names (separate multiple with commas)" 
                 class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        <button id="search-button" class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
          Search
        </button>
      </div>
    </div>
    


    
    <div class="fda-data-section">
      <!-- Warning Letters Section -->
      <div class="mb-6">
        <div class="flex items-center justify-between">
          <h3 class="text-lg font-medium">FDA Warning Letters</h3>
          <span class="text-xs px-2 py-1 bg-red-100 text-red-800 rounded-full" id="warningLettersCount" style="display: none;">0 letters</span>
        </div>
        <div class="mt-3 p-4 bg-gray-50 rounded-lg" id="warningLettersData">
          <div class="flex justify-center items-center py-8 text-gray-500">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
            <span>Warning letters will be available here</span>
          </div>
        </div>
      </div>
      
      <!-- Inspection Data Section (will be populated dynamically) -->
      <div id="inspection-data"></div>
    </div>
  </div>
</div>
*/


// // /////////////////// COMPANY SUMMARY SECTION ///////////////////////

// // Function to create and display company summary section
// function createCompanySummarySection(companies, warningLetters, inspections) {
//   // Create container if it doesn't exist
//   if (!elements.companySummarySection) {
//     elements.companySummarySection = document.createElement('div');
//     elements.companySummarySection.id = 'company-summary-section';
//     elements.companySummarySection.className = 'mb-6';
    
//     // Insert before inspection data section
//     const inspectionDataSection = document.getElementById('inspection-data');
//     inspectionDataSection.parentNode.insertBefore(elements.companySummarySection, inspectionDataSection);
//   }
  
//   // Calculate statistics for each company
//   const companyStats = companies.map(company => {
//     // Count warning letters for this company
//     const wlCount = warningLetters.filter(letter => 
//       letter.sourceCompany === company || 
//       letter.companyName?.toLowerCase().includes(company.toLowerCase())
//     ).length;
    
//     // Count 483s for this company (from recent inspections)
//     const form483Count = inspections.recentInspections.filter(inspection => 
//       inspection["Record Type"] === "Form 483" && 
//       inspection["Legal Name"]?.toLowerCase().includes(company.toLowerCase())
//     ).length;
    
//     // Historical inspections count
//     const historicalCount = inspections.historicalInspections.filter(inspection => 
//       inspection["Firm Name"]?.toLowerCase().includes(company.toLowerCase())
//     ).length;
    
//     return {
//       company,
//       wlCount,
//       form483Count,
//       historicalCount,
//       totalInspections: form483Count + historicalCount
//     };
//   });
  
//   // Create summary HTML
//   let html = `
//     <div class="bg-white rounded-lg shadow-md p-6">
//       <div class="flex items-center justify-between mb-4">
//         <h3 class="text-lg font-medium">Company Regulatory Summary</h3>
        
//         <div class="flex space-x-2">
//           <button id="generate-ai-summary" class="text-xs bg-purple-600 hover:bg-purple-700 text-white py-1 px-3 rounded-md flex items-center transition-colors">
//             <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//               <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
//             </svg>
//             Generate AI Summary
//           </button>
          
//           <button id="email-summary-btn" class="text-xs bg-blue-600 hover:bg-blue-700 text-white py-1 px-3 rounded-md flex items-center transition-colors">
//             <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//               <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
//             </svg>
//             Email Summary
//           </button>
//         </div>
//       </div>
      
//       <div class="overflow-x-auto">
//         <table class="min-w-full text-sm">
//           <thead>
//             <tr class="bg-gray-100">
//               <th class="px-4 py-2 text-left">Company</th>
//               <th class="px-4 py-2 text-center">Form 483s</th>
//               <th class="px-4 py-2 text-center">Warning Letters</th>
//               <th class="px-4 py-2 text-center">Total Inspections</th>
//               <th class="px-4 py-2 text-right">Actions</th>
//             </tr>
//           </thead>
//           <tbody>
//             ${companyStats.map(stat => `
//               <tr class="border-b hover:bg-gray-50">
//                 <td class="px-4 py-3 font-medium">${stat.company}</td>
//                 <td class="px-4 py-3 text-center">
//                   ${stat.form483Count > 0 
//                     ? `<span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs">${stat.form483Count}</span>` 
//                     : '0'}
//                 </td>
//                 <td class="px-4 py-3 text-center">
//                   ${stat.wlCount > 0 
//                     ? `<span class="px-2 py-1 bg-red-100 text-red-800 rounded-full text-xs">${stat.wlCount}</span>` 
//                     : '0'}
//                 </td>
//                 <td class="px-4 py-3 text-center">
//                   ${stat.totalInspections > 0 
//                     ? `<span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs">${stat.totalInspections}</span>` 
//                     : '0'}
//                 </td>
//                 <td class="px-4 py-3 text-right">
//                   <div class="flex justify-end space-x-2">
//                     <button class="text-xs px-2 py-1 bg-gray-100 hover:bg-gray-200 text-gray-800 rounded transition-colors view-company-details" 
//                             data-company="${stat.company}">
//                       View Details
//                     </button>
//                     <label class="inline-flex items-center cursor-pointer">
//                       <input type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 company-select-checkbox" 
//                              value="${stat.company}">
//                     </label>
//                   </div>
//                 </td>
//               </tr>
//             `).join('')}
//           </tbody>
//         </table>
//       </div>
      
//       <div class="mt-4 flex justify-between items-center">
//         <div>
//           <button id="analyze-selected-companies" class="text-xs bg-indigo-600 hover:bg-indigo-700 text-white py-1 px-3 rounded-md flex items-center transition-colors" disabled>
//             <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//               <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
//             </svg>
//             Analyze Selected Companies
//           </button>
//         </div>
//         <div class="text-xs text-gray-500">
//           Select companies to perform detailed analysis or generate AI summary
//         </div>
//       </div>
      
//       <!-- AI Analysis Results Section -->
//       <div id="ai-analysis-results" class="mt-6 hidden">
//         <div class="border-t pt-4">
//           <h4 class="text-base font-medium mb-3">AI Analysis Results</h4>
//           <div id="ai-analysis-content" class="bg-gray-50 p-4 rounded-lg">
//             <!-- AI content will be placed here -->
//           </div>
//         </div>
//       </div>
      
//       <!-- Company Details Section -->
//       <div id="company-detail-view" class="mt-6 hidden">
//         <div class="border-t pt-4">
//           <h4 class="text-base font-medium mb-3">Company Details: <span id="company-detail-name"></span></h4>
//           <div id="company-detail-content" class="bg-gray-50 p-4 rounded-lg">
//             <!-- Company detail content will be placed here -->
//           </div>
//         </div>
//       </div>
//     </div>
//   `;
  
//   // Update the section
//   elements.companySummarySection.innerHTML = html;
  
//   // Add event listeners
//   document.querySelectorAll('.company-select-checkbox').forEach(checkbox => {
//     checkbox.addEventListener('change', updateSelectedCompaniesState);
//   });
  
//   document.getElementById('analyze-selected-companies').addEventListener('click', analyzeSelectedCompanies);
//   document.getElementById('generate-ai-summary').addEventListener('click', generateAISummary);
//   document.getElementById('email-summary-btn').addEventListener('click', emailSummary);
  
//   document.querySelectorAll('.view-company-details').forEach(button => {
//     button.addEventListener('click', function() {
//       const company = this.getAttribute('data-company');
//       showCompanyDetails(company, warningLetters, inspections);
//     });
//   });
// }

// // Function to update the state of selected companies
// function updateSelectedCompaniesState() {
//   const checkboxes = document.querySelectorAll('.company-select-checkbox:checked');
//   const analyzeButton = document.getElementById('analyze-selected-companies');
  
//   if (checkboxes.length > 0) {
//     analyzeButton.removeAttribute('disabled');
//   } else {
//     analyzeButton.setAttribute('disabled', true);
//   }
// }

// // Function to analyze selected companies
// async function analyzeSelectedCompanies() {
//   const selectedCompanies = Array.from(
//     document.querySelectorAll('.company-select-checkbox:checked')
//   ).map(checkbox => checkbox.value);
  
//   if (selectedCompanies.length === 0) return;
  
//   // Show loading state
//   const aiResults = document.getElementById('ai-analysis-results');
//   aiResults.classList.remove('hidden');
  
//   document.getElementById('ai-analysis-content').innerHTML = `
//     <div class="flex justify-center items-center py-8">
//       <svg class="animate-spin h-6 w-6 text-purple-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
//         <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
//         <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
//       </svg>
//       <span class="ml-2 text-gray-600">Analyzing regulatory history of selected companies...</span>
//     </div>
//   `;
  
//   try {
//     // Make request to your AI backend
//     const response = await fetch('/api/wl/analyze-companies', {
//       method: 'POST',
//       headers: {
//         'Content-Type': 'application/json',
//       },
//       body: JSON.stringify({
//         companies: selectedCompanies,
//         includeWL: true,
//         include483: true
//       }),
//     });
    
//     if (!response.ok) {
//       throw new Error('Failed to analyze companies');
//     }
    
//     const data = await response.json();
    
//     // Display the AI analysis results
//     document.getElementById('ai-analysis-content').innerHTML = `
//       <div class="prose prose-sm max-w-none">
//         <h5 class="text-base font-medium mb-2">Analysis for ${selectedCompanies.join(', ')}</h5>
        
//         <div class="mb-4">
//           <h6 class="text-sm font-medium mb-1">Summary</h6>
//           <p>${data.summary || 'No summary available'}</p>
//         </div>
        
//         <div class="mb-4">
//           <h6 class="text-sm font-medium mb-1">Form 483 to Warning Letter Correlation</h6>
//           <p>${data.correlation || 'No correlation analysis available'}</p>
//         </div>
        
//         ${data.recommendations ? `
//           <div class="mb-4">
//             <h6 class="text-sm font-medium mb-1">Recommendations</h6>
//             <p>${data.recommendations}</p>
//           </div>
//         ` : ''}
        
//         <div class="text-right mt-4">
//           <button id="download-analysis" class="text-xs bg-purple-600 hover:bg-purple-700 text-white py-1 px-3 rounded-md inline-flex items-center transition-colors">
//             <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//               <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
//             </svg>
//             Download Analysis
//           </button>
//         </div>
//       </div>
//     `;
    
//     // Add event listener for download button
//     document.getElementById('download-analysis').addEventListener('click', () => {
//       downloadAnalysis(data, selectedCompanies);
//     });
//   } catch (error) {
//     console.error('Error analyzing companies:', error);
//     document.getElementById('ai-analysis-content').innerHTML = `
//       <div class="text-center text-red-600 py-4">
//         <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mx-auto mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
//         </svg>
//         <p>Error analyzing companies. Please try again later.</p>
//         <p class="text-sm text-gray-600 mt-2">You can still view individual company details by clicking "View Details".</p>
//       </div>
//     `;
//   }
// }

// // Function to show company details
// function showCompanyDetails(company, warningLetters, inspections) {
//   const detailView = document.getElementById('company-detail-view');
//   const detailName = document.getElementById('company-detail-name');
//   const detailContent = document.getElementById('company-detail-content');
  
//   detailView.classList.remove('hidden');
//   detailName.textContent = company;
  
//   // Get company data
//   const companyWL = warningLetters.filter(letter => 
//     letter.sourceCompany === company ||
//     letter.companyName?.toLowerCase().includes(company.toLowerCase())
//   );
  
//   const companyForm483 = inspections.recentInspections.filter(inspection => 
//     inspection["Record Type"] === "Form 483" && 
//     inspection["Legal Name"]?.toLowerCase().includes(company.toLowerCase())
//   );
  
//   const companyHistorical = inspections.historicalInspections.filter(inspection => 
//     inspection["Firm Name"]?.toLowerCase().includes(company.toLowerCase())
//   );
  
//   // Create HTML for company details
//   let html = `
//     <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
//       <div>
//         <h5 class="text-sm font-medium mb-2">Form 483s (${companyForm483.length})</h5>
//         ${companyForm483.length > 0 ? `
//           <div class="bg-white rounded-md shadow-sm overflow-hidden">
//             <table class="min-w-full text-xs">
//               <thead>
//                 <tr class="bg-gray-100 border-b">
//                   <th class="px-3 py-2 text-left">Date</th>
//                   <th class="px-3 py-2 text-left">FEI Number</th>
//                   <th class="px-3 py-2 text-left">Actions</th>
//                 </tr>
//               </thead>
//               <tbody>
//                 ${companyForm483.map(inspection => `
//                   <tr class="border-b">
//                     <td class="px-3 py-2">${formatDate(inspection["Record Date"])}</td>
//                     <td class="px-3 py-2">${inspection["FEI Number"]}</td>
//                     <td class="px-3 py-2">
//                       ${inspection["Download"] ? `
//                         <a href="${inspection["Download"]}" target="_blank" class="text-blue-600 hover:text-blue-800 text-xs">
//                           Download
//                         </a>
//                       ` : 'Not available'}
//                     </td>
//                   </tr>
//                 `).join('')}
//               </tbody>
//             </table>
//           </div>
//         ` : '<p class="text-gray-600 text-sm">No Form 483s found for this company</p>'}
//       </div>
      
//       <div>
//         <h5 class="text-sm font-medium mb-2">Warning Letters (${companyWL.length})</h5>
//         ${companyWL.length > 0 ? `
//           <div class="bg-white rounded-md shadow-sm overflow-hidden">
//             <table class="min-w-full text-xs">
//               <thead>
//                 <tr class="bg-gray-100 border-b">
//                   <th class="px-3 py-2 text-left">Date</th>
//                   <th class="px-3 py-2 text-left">Issuing Office</th>
//                   <th class="px-3 py-2 text-left">Actions</th>
//                 </tr>
//               </thead>
//               <tbody>
//                 ${companyWL.map(letter => `
//                   <tr class="border-b">
//                     <td class="px-3 py-2">${formatDate(letter.letterIssueDate)}</td>
//                     <td class="px-3 py-2">${letter.issuingOffice || 'Unknown'}</td>
//                     <td class="px-3 py-2">
//                       <button class="text-blue-600 hover:text-blue-800 text-xs view-letter-btn" 
//                               data-id="${letter.id || letter.letterId}">
//                         View Letter
//                       </button>
//                     </td>
//                   </tr>
//                 `).join('')}
//               </tbody>
//             </table>
//           </div>
//         ` : '<p class="text-gray-600 text-sm">No Warning Letters found for this company</p>'}
//       </div>
//     </div>
    
//     <div class="mt-6">
//       <h5 class="text-sm font-medium mb-2">Form 483 to Warning Letter Correlation</h5>
      
//       ${companyForm483.length > 0 && companyWL.length > 0 ? `
//         <div class="bg-white p-4 rounded-md shadow-sm">
//           <div class="timeline relative pl-8 pb-1">
//             ${createTimelineHtml(companyForm483, companyWL)}
//           </div>
//         </div>
//       ` : '<p class="text-gray-600 text-sm">Insufficient data to show correlation</p>'}
//     </div>
    
//     <div class="mt-6">
//       <h5 class="text-sm font-medium mb-2">Historical Inspections (${companyHistorical.length})</h5>
      
//       ${companyHistorical.length > 0 ? `
//         <div class="bg-white rounded-md shadow-sm overflow-hidden">
//           <table class="min-w-full text-xs">
//             <thead>
//               <tr class="bg-gray-100 border-b">
//                 <th class="px-3 py-2 text-left">End Date</th>
//                 <th class="px-3 py-2 text-left">Location</th>
//                 <th class="px-3 py-2 text-left">Project Area</th>
//                 <th class="px-3 py-2 text-left">Classification</th>
//               </tr>
//             </thead>
//             <tbody>
//               ${companyHistorical.map(inspection => `
//                 <tr class="border-b">
//                   <td class="px-3 py-2">${formatDate(inspection["Inspection End Date"])}</td>
//                   <td class="px-3 py-2">${inspection["City"] || ''}, ${inspection["State"] || ''}</td>
//                   <td class="px-3 py-2">${inspection["Project Area"] || 'Unknown'}</td>
//                   <td class="px-3 py-2">
//                     <span class="px-2 py-1 ${getClassificationColor(inspection["Inspection Classification"])} rounded-full text-xs">
//                       ${inspection["Inspection Classification"] || 'N/A'}
//                     </span>
//                   </td>
//                 </tr>
//               `).join('')}
//             </tbody>
//           </table>
//         </div>
//       ` : '<p class="text-gray-600 text-sm">No historical inspections found for this company</p>'}
//     </div>
//   `;
  
//   detailContent.innerHTML = html;
  
//   // Add event listeners for viewing letters
//   document.querySelectorAll('.view-letter-btn').forEach(button => {
//     button.addEventListener('click', function() {
//       const letterId = this.getAttribute('data-id');
//       viewWarningLetterDetails(letterId, company);
//     });
//   });
// }

// // Function to create timeline HTML showing correlation between 483s and warning letters
// function createTimelineHtml(form483s, warningLetters) {
//   // Sort items by date
//   const form483sSorted = [...form483s].sort((a, b) => 
//     new Date(a["Record Date"]) - new Date(b["Record Date"])
//   );
  
//   const warningLettersSorted = [...warningLetters].sort((a, b) => 
//     new Date(a.letterIssueDate) - new Date(b.letterIssueDate)
//   );
  
//   // Combine and sort all events
//   const allEvents = [
//     ...form483sSorted.map(item => ({
//       type: '483',
//       date: new Date(item["Record Date"]),
//       data: item
//     })),
//     ...warningLettersSorted.map(item => ({
//       type: 'WL',
//       date: new Date(item.letterIssueDate),
//       data: item
//     }))
//   ].sort((a, b) => a.date - b.date);
  
//   // Create timeline HTML
//   let html = `<div class="timeline-line"></div>`;
  
//   allEvents.forEach((event, index) => {
//     const isWL = event.type === 'WL';
//     const dateStr = formatDate(isWL ? event.data.letterIssueDate : event.data["Record Date"]);
    
//     // If this is a warning letter, try to find the closest 483 before it
//     let correlation = '';
//     if (isWL) {
//       const previousEvents = allEvents.slice(0, index).filter(e => e.type === '483');
//       if (previousEvents.length > 0) {
//         const lastForm483 = previousEvents[previousEvents.length - 1];
//         const daysBetween = Math.floor((event.date - lastForm483.date) / (1000 * 60 * 60 * 24));
        
//         if (daysBetween <= 365) {  // If within a year
//           correlation = `
//             <div class="text-xs text-gray-500 mt-1">
//               Possibly related to Form 483 from ${formatDate(lastForm483.data["Record Date"])}
//               (${daysBetween} days apart)
//             </div>
//           `;
//         }
//       }
//     }
    
//     html += `
//       <div class="relative mb-6">
//         <div class="timeline-dot ${isWL ? 'bg-red-500' : 'bg-yellow-500'}"></div>
//         <div class="ml-4">
//           <div class="flex items-center">
//             <span class="text-xs px-2 py-1 ${isWL ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800'} rounded-full">
//               ${isWL ? 'Warning Letter' : 'Form 483'}
//             </span>
//             <span class="ml-2 text-xs text-gray-500">${dateStr}</span>
//           </div>
          
//           <div class="mt-1 text-sm">
//             ${isWL ? 
//               `Issuing Office: ${event.data.issuingOffice || 'Unknown'}` : 
//               `FEI Number: ${event.data["FEI Number"]}`
//             }
//           </div>
          
//           ${correlation}
//         </div>
//       </div>
//     `;
//   });
  
//   return html;
// }

// // Function to generate AI summary
// async function generateAISummary() {
//   const aiResults = document.getElementById('ai-analysis-results');
//   aiResults.classList.remove('hidden');
  
//   document.getElementById('ai-analysis-content').innerHTML = `
//     <div class="flex justify-center items-center py-8">
//       <svg class="animate-spin h-6 w-6 text-purple-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
//         <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
//         <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
//       </svg>
//       <span class="ml-2 text-gray-600">Generating AI summary of regulatory findings...</span>
//     </div>
//   `;
  
//   try {
//     // Make request to your AI backend
//     const response = await fetch('/api/wl/generate-summary', {
//       method: 'POST',
//       headers: {
//         'Content-Type': 'application/json',
//       },
//       body: JSON.stringify({
//         includeWL: true,
//         include483: true,
//         includeMarketAnalysis: true
//       }),
//     });
    
//     if (!response.ok) {
//       throw new Error('Failed to generate summary');
//     }
    
//     const data = await response.json();
    
//     // Display the AI summary
//     document.getElementById('ai-analysis-content').innerHTML = `
//       <div class="prose prose-sm max-w-none">
//         <h5 class="text-base font-medium mb-2">Market Analysis & Regulatory Findings</h5>
        
//         <div class="mb-4">
//           <p>${data.summary || 'No summary available'}</p>
//         </div>
        
//         ${data.marketOpportunities ? `
//           <div class="mb-4">
//             <h6 class="text-sm font-medium mb-1">Market Opportunities</h6>
//             <p>${data.marketOpportunities}</p>
//           </div>
//         ` : ''}
        
//         ${data.recommendedActions ? `
//           <div class="mb-4">
//             <h6 class="text-sm font-medium mb-1">Recommended Actions</h6>
//             <p>${data.recommendedActions}</p>
//           </div>
//         ` : ''}
        
//         <div class="text-right mt-4">
//           <button id="download-ai-summary" class="text-xs bg-purple-600 hover:bg-purple-700 text-white py-1 px-3 rounded-md inline-flex items-center transition-colors">
//             <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//               <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
//             </svg>
//             Download Summary
//           </button>
//         </div>
//       </div>
//     `;
    
//     // Add event listener for download button
//     document.getElementById('download-ai-summary').addEventListener('click', () => {
//       downloadAnalysis(data, ['All Companies']);
//     });
//   } catch (error) {
//     console.error('Error generating summary:', error);
//     document.getElementById('ai-analysis-content').innerHTML = `
//       <div class="text-center text-red-600 py-4">
//         <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mx-auto mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
//         </svg>
//         <p>Error generating AI summary. Please try again later.</p>
//       </div>
//     `;
//   }
// }

// // Function to download analysis as PDF or text
// function downloadAnalysis(data, companies) {
//   // Create text content
//   const textContent = `
// Regulatory Analysis for ${companies.join(', ')}
// Generated on ${new Date().toLocaleDateString()}

// SUMMARY
// ${data.summary || 'No summary available'}

// ${data.correlation ? `FORM 483 TO WARNING LETTER CORRELATION
// ${data.correlation}

// ` : ''}${data.recommendations ? `RECOMMENDATIONS
// ${data.recommendations}

// ` : ''}${data.marketOpportunities ? `MARKET OPPORTUNITIES
// ${data.marketOpportunities}

// ` : ''}${data.recommendedActions ? `RECOMMENDED ACTIONS
// ${data.recommendedActions}
// ` : ''}
//   `;
  
//   // Create a blob and download link
//   const blob = new Blob([textContent], { type: 'text/plain' });
//   const url = URL.createObjectURL(blob);
//   const a = document.createElement('a');
//   a.href = url;
//   a.download = `regulatory-analysis-${companies.join('-').replace(/[^a-z0-9]/gi, '-').toLowerCase()}.txt`;
//   document.body.appendChild(a);
//   a.click();
//   document.body.removeChild(a);
//   URL.revokeObjectURL(url);
// }

// // Function to email the summary
// async function emailSummary() {
//   // Show email modal
//   showEmailModal();
// }

// // Function to show email modal
// function showEmailModal() {
//   // Create modal if it doesn't exist
//   let modal = document.getElementById('email-modal');
  
//   if (!modal) {
//     modal = document.createElement('div');
//     modal.id = 'email-modal';
//     modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    
//     // Build modal HTML
//     modal.innerHTML = `
//       <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
//         <div class="flex justify-between items-center p-4 border-b border-gray-200">
//           <h2 class="text-xl font-semibold">Email Regulatory Summary</h2>
//           <button id="close-email-modal" class="text-gray-400 hover:text-gray-600">
//             <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//               <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
//             </svg>
//           </button>
//         </div>
        
//         <div class="p-6">
//           <form id="email-form">
//             <div class="mb-4">
//               <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
//               <input type="email" id="email" name="email" required
//                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500">
//             </div>
            
//             <div class="mb-4">
//               <label for="include-content" class="flex items-center text-sm font-medium text-gray-700">
//                 <input type="checkbox" id="include-content" name="include-content" checked
//                        class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded mr-2">
//                 Include all content (Form 483s, Warning Letters, etc.)
//               </label>
//             </div>
            
//             <div class="mb-4">
//               <label for="include-ai" class="flex items-center text-sm font-medium text-gray-700">
//                 <input type="checkbox" id="include-ai" name="include-ai" checked
//                        class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded mr-2">
//                 Include AI analysis and recommendations
//               </label>
//             </div>
            
//             <div>
//               <label for="message" class="block text-sm font-medium text-gray-700 mb-1">Additional Message (optional)</label>
//               <textarea id="message" name="message" rows="3"
//                         class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500"></textarea>
//             </div>
            
//             <div class="mt-6 flex justify-end">
//               <button type="button" id="cancel-email"
//                       class="bg-white text-gray-800 border border-gray-300 px-4 py-2 rounded-md text-sm font-medium mr-3 hover:bg-gray-50">
//                 Cancel
//               </button>
//               <button type="submit"
//                       class="bg-blue-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-blue-700">
//                 Send Email
//               </button>
//             </div>
//           </form>
//         </div>
//       </div>
//     `;
    
//     // Add to document
//     document.body.appendChild(modal);
    
//     // Add event listeners
//     document.getElementById('close-email-modal').addEventListener('click', closeEmailModal);
//     document.getElementById('cancel-email').addEventListener('click', closeEmailModal);
//     document.getElementById('email-form').addEventListener('submit', handleEmailSubmit);
//   } else {
//     // Show existing modal
//     modal.style.display = 'flex';
//   }
  
//   // Prevent body scrolling
//   document.body.style.overflow = 'hidden';
// }

// // Function to close email modal
// function closeEmailModal() {
//   const modal = document.getElementById('email-modal');
//   if (modal) {
//     modal.style.display = 'none';
//   }
  
//   // Allow body scrolling again
//   document.body.style.overflow = '';
// }

// // Function to handle email form submission
// async function handleEmailSubmit(e) {
//   e.preventDefault();
  
//   const emailInput = document.getElementById('email');
//   const includeContentCheckbox = document.getElementById('include-content');
//   const includeAICheckbox = document.getElementById('include-ai');
//   const messageTextarea = document.getElementById('message');
  
//   const email = emailInput.value;
//   const includeContent = includeContentCheckbox.checked;
//   const includeAI = includeAICheckbox.checked;
//   const message = messageTextarea.value;
  
//   // Show loading state
//   const submitButton = e.target.querySelector('button[type="submit"]');
//   const originalButtonText = submitButton.innerHTML;
//   submitButton.disabled = true;
//   submitButton.innerHTML = `
//     <svg class="animate-spin h-4 w-4 mr-1 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
//       <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
//       <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
//     </svg>
//     Sending...
//   `;
  
//   try {
//     // Get all selected companies
//     const selectedCompanies = Array.from(
//       document.querySelectorAll('.company-select-checkbox:checked')
//     ).map(checkbox => checkbox.value);
    
//     // Make request to your backend
//     const response = await fetch('/api/wl/email-summary', {
//       method: 'POST',
//       headers: {
//         'Content-Type': 'application/json',
//       },
//       body: JSON.stringify({
//         email,
//         includeContent,
//         includeAI,
//         message,
//         companies: selectedCompanies.length > 0 ? selectedCompanies : null
//       }),
//     });
    
//     if (!response.ok) {
//       throw new Error('Failed to send email');
//     }
    
//     // Show success message
//     showToast('Email sent successfully!', 'success');
    
//     // Close modal
//     closeEmailModal();
//   } catch (error) {
//     console.error('Error sending email:', error);
//     showToast('Failed to send email. Please try again.', 'error');
    
//     // Reset button state
//     submitButton.disabled = false;
//     submitButton.innerHTML = originalButtonText;
//   }
// }

// // Function to show toast notification
// function showToast(message, type = 'info') {
//   // Create toast container if it doesn't exist
//   let toastContainer = document.getElementById('toast-container');
  
//   if (!toastContainer) {
//     toastContainer = document.createElement('div');
//     toastContainer.id = 'toast-container';
//     toastContainer.className = 'fixed bottom-4 right-4 z-50';
//     document.body.appendChild(toastContainer);
//   }
  
//   // Create toast element
//   const toast = document.createElement('div');
//   toast.className = `flex items-center p-4 mb-3 rounded-md shadow-lg max-w-xs ${
//     type === 'success' ? 'bg-green-500 text-white' :
//     type === 'error' ? 'bg-red-500 text-white' :
//     'bg-blue-500 text-white'
//   } transition-opacity transform duration-300 opacity-0 translate-y-2`;
  
//   // Set toast content
//   toast.innerHTML = `
//     <div class="mr-3">
//       ${type === 'success' ? `
//         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
//           <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
//         </svg>
//       ` : type === 'error' ? `
//         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
//           <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
//         </svg>
//       ` : `
//         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
//           <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
//         </svg>
//       `}
//     </div>
//     <div>${message}</div>
//   `;
  
//   // Add to container
//   toastContainer.appendChild(toast);
  
//   // Animate in
//   setTimeout(() => {
//     toast.classList.remove('opacity-0', 'translate-y-2');
//   }, 10);
  
//   // Remove after delay
//   setTimeout(() => {
//     toast.classList.add('opacity-0', 'translate-y-2');
    
//     setTimeout(() => {
//       toast.remove();
//     }, 300);
//   }, 5000);
// }

// // Function to integrate company summary with the rest of the application
// function integrateCompanySummary() {
//   // Update searchWarningLetters function to also create summary
//   const originalSearchWarningLetters = searchWarningLetters;
  
//   window.searchWarningLetters = async function(companies, type = null, issuingOffice = null) {
//     // Call original function first
//     await originalSearchWarningLetters(companies, type, issuingOffice);
    
//     // Wait for data to load
//     setTimeout(() => {
//       // Get warning letters and inspections data
//       const warningLetters = Array.from(document.querySelectorAll('.warning-letter-item'))
//         .map(item => {
//           return {
//             id: item.getAttribute('data-id'),
//             companyName: item.querySelector('h5').textContent,
//             letterIssueDate: item.querySelector('.bg-gray-100').textContent.trim(),
//             issuingOffice: item.querySelector('.text-gray-500').textContent.trim(),
//             sourceCompany: item.getAttribute('data-source-company')
//           };
//         });
      
//       // Get inspections data from what's visible in the UI
//       const recentInspections = Array.from(document.querySelectorAll('#inspection-data table:first-of-type tbody tr'))
//         .map(row => {
//           const cells = row.querySelectorAll('td');
//           return {
//             "Record Date": cells[0]?.textContent?.trim() || '',
//             "Legal Name": cells[1]?.textContent?.trim() || '',
//             "Record Type": cells[2]?.querySelector('span')?.textContent?.trim() || '',
//             "FEI Number": cells[3]?.textContent?.trim() || '',
//             "Download": cells[4]?.querySelector('a')?.getAttribute('href') || null
//           };
//         });
      
//       const historicalInspections = Array.from(document.querySelectorAll('#inspection-data table:last-of-type tbody tr'))
//         .map(row => {
//           const cells = row.querySelectorAll('td');
//           return {
//             "Firm Name": cells[0]?.textContent?.trim() || '',
//             "City": cells[1]?.textContent?.trim() || '',
//             "State": cells[2]?.textContent?.trim() || '',
//             "Country/Area": cells[3]?.textContent?.trim() || '',
//             "Inspection End Date": cells[4]?.textContent?.trim() || '',
//             "Project Area": cells[5]?.querySelector('span')?.textContent?.trim() || '',
//             "Inspection Classification": cells[6]?.querySelector('span')?.textContent?.trim() || ''
//           };
//         });
      
//       const inspections = {
//         recentInspections,
//         historicalInspections
//       };
      
//       // Create summary section if we have data
//       if ((warningLetters.length > 0 || recentInspections.length > 0 || historicalInspections.length > 0) && companies.length > 0) {
//         createCompanySummarySection(companies, warningLetters, inspections);
//       }
//     }, 1000); // Give time for data to load
//   };
// }

// // Call integration function when script loads
// document.addEventListener('DOMContentLoaded', () => {
//   integrateCompanySummary();
// });

// // Initialize fallback functions for API calls for demo purposes
// function initializeFallbackAPIs() {
//   // Mock API endpoints if they don't exist
//   if (!window.fetch.toString().includes('native code')) {
//     return; // Don't override if fetch is already mocked
//   }
  
//   const originalFetch = window.fetch;
  
//   window.fetch = async function(url, options) {
//     // If it's one of our API endpoints, mock the response
//     if (typeof url === 'string') {
//       if (url.includes('/api/wl/analyze-companies')) {
//         // Mock the analyze-companies API
//         return {
//           ok: true,
//           json: async () => ({
//             summary: "Based on the analysis of the selected companies, we found several patterns of regulatory issues. The most common violations relate to quality control procedures, data integrity, and contamination control. Companies typically received Form 483s first, with warning letters following within 3-6 months if issues were not adequately addressed.",
//             correlation: "Among the selected companies, approximately 68% of warning letters were preceded by Form 483s within the previous 12 months. The most frequent violations cited in both documents were: 1) Inadequate validation of manufacturing processes, 2) Insufficient testing of raw materials, and 3) Failure to investigate quality deviations properly.",
//             recommendations: "Based on the regulatory history patterns, companies should prioritize addressing Form 483 observations promptly and thoroughly to prevent escalation to warning letters. Implementing robust CAPA systems and ensuring proper documentation of quality processes are critical preventive measures."
//           })
//         };
//       } else if (url.includes('/api/generate-summary')) {
//         // Mock the generate-summary API
//         return {
//           ok: true,
//           json: async () => ({
//             summary: "Our analysis of recent FDA regulatory actions reveals significant market opportunities. Several pharmaceutical companies manufacturing sterile injectables have received warning letters for aseptic processing violations, creating potential gaps in the supply chain. Additionally, warning letters related to data integrity issues have increased by 35% compared to the previous year.",
//             marketOpportunities: "The current regulatory environment presents several strategic opportunities: 1) The sterile injectables market shows supply vulnerabilities due to compliance issues at major manufacturers, 2) Quality control testing services are in high demand as companies seek to address FDA concerns, 3) Specialized consultancy for data integrity remediation represents a growing niche.",
//             recommendedActions: "To capitalize on these opportunities, we recommend: 1) Evaluating capacity expansion for compliant sterile injectable manufacturing, 2) Developing enhanced quality control testing services tailored to commonly cited deficiencies, 3) Establishing strategic partnerships with companies under regulatory scrutiny to provide remediation support."
//           })
//         };
//       } else if (url.includes('/api/wl/    email-summary')) {
//         // Mock the email-summary API
//         return {
//           ok: true,
//           json: async () => ({ success: true })
//         };
//       }
//     }
    
//     // Pass through to original fetch for other requests
//     return originalFetch(url, options);
//   };
// }

// // Initialize fallback APIs for demo purposes
// initializeFallbackAPIs();


// // Updated function to fetch warning letters for multiple companies
// async function fetchWarningLetters(companies, filters = {}) {
//   try {
//     if (!Array.isArray(companies) || companies.length === 0) {
//       throw new Error('Companies parameter must be a non-empty array');
//     }

//     // Show loading state
//     elements.warningLettersData.innerHTML = `
//       <div class="flex justify-center items-center py-8">
//         <svg class="animate-spin h-6 w-6 text-red-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
//           <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
//           <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
//         </svg>
//         <span class="ml-2 text-gray-600">Searching warning letters for ${companies.length} companies...</span>
//       </div>
//     `;

//     // Store results and deduplicate by letter ID
//     const allLetters = new Map(); // Map<letterId, letter>
//     let totalCount = 0;

//     // Fetch warning letters for each company
//     for (const company of companies) {
//       // Build query parameters for this company
//       const queryParams = new URLSearchParams();
//       queryParams.append('term', company);
//       queryParams.append('field', 'companyName'); // Focus search on company name

//       // Add filters if they exist
//       if (filters.type) queryParams.append('type', filters.type); // human or veterinary
//       if (filters.issueDate) queryParams.append('issueDate', filters.issueDate);
//       if (filters.issuingOffice) queryParams.append('issuingOffice', filters.issuingOffice);

//       // Make request to the API
//       const response = await fetch(`${API_BASE_URL}/wl/search?${queryParams.toString()}`);
      
//       if (!response.ok) {
//         console.warn(`Warning letters fetch failed for ${company}: ${response.status}`);
//         continue; // Skip to next company
//       }

//       const data = await response.json();
//       const letters = data.results || [];

//       // Add letters to Map to deduplicate
//       letters.forEach(letter => {
//         const letterId = letter.id || letter.letterId;
//         if (!allLetters.has(letterId)) {
//           allLetters.set(letterId, { ...letter, sourceCompany: company });
//         }
//       });

//       totalCount += data.total || 0; // Accumulate total count
//     }

//     // Convert Map to array for display
//     const lettersArray = Array.from(allLetters.values());

//     // Display the warning letters
//     displayWarningLetters({ results: lettersArray, total: allLetters.size }, companies);
//   } catch (error) {
//     console.error("Error fetching warning letters:", error);
//     elements.warningLettersData.innerHTML =   `<div class="text-center p-4">
//         <p class="text-sm text-gray-700">No Warning letters found </p>
//       </div>`;

//     console.log("Error fetching warning letters for companies");
//     elements.warningLettersCount.textContent = "0 letters";
//   }
// }

// // Updated function to display warning letters
// function displayWarningLetters(data, companies) {
//   const letters = data.results || [];
//   const totalCount = data.total || 0;
  
//   // Update counter
//   elements.warningLettersCount.textContent = `${totalCount} letters`;
  
//   if (letters.length === 0) {
//     elements.warningLettersData.innerHTML = `
//       <div class="text-center p-4">
//         <p class="text-sm text-gray-700">No warning letters found for companies: ${companies.join(", ")}</p>
//       </div>
//     `;
//     return;
//   }
  
//   // Get unique issuing offices for filter
//   const issuingOffices = [...new Set(letters.map(letter => letter.issuingOffice))].filter(Boolean);
  
//   // Determine which letters are veterinary vs human
//   const isVeterinary = letter => {
//     const vetKeywords = ['animal', 'vet', 'veterinary', 'livestock', 'pet', 'cattle', 'poultry', 'swine', 'equine', 'fish', 'aquatic', 'cow', 'horse', 'dog', 'cat'];
//     const title = (letter.companyName || '').toLowerCase();
//     const subject = (letter.subject || '').toLowerCase();
//     const content = (letter.fullContent || '').toLowerCase();
    
//     return vetKeywords.some(keyword => 
//       title.includes(keyword) || 
//       subject.includes(keyword) || 
//       content.includes(keyword)
//     );
//   };
  
//   // Create HTML for warning letters section
//   let html = `
//     <div>
//       <!-- Filter controls -->
//       <div class="mb-4">
//         <div class="flex flex-wrap items-center justify-between">
//           <div class="flex space-x-2">
//             <div>
//               <select id="warning-letters-type-filter" class="text-xs rounded border border-gray-300 py-1 px-2 focus:outline-none focus:ring-1 focus:ring-blue-500">
//                 <option value="all">All Types</option>
//                 <option value="human">Human</option>
//                 <option value="veterinary">Veterinary</option>
//               </select>
//             </div>
//             <div>
//               <select id="warning-letters-office-filter" class="text-xs rounded border border-gray-300 py-1 px-2 focus:outline-none focus:ring-1 focus:ring-blue-500">
//                 <option value="all">All Offices</option>
//                 ${issuingOffices.map(office => `<option value="${office}">${office}</option>`).join('')}
//               </select>
//             </div>
//           </div>
//         </div>
//       </div>
      
//       <!-- Warning letters list -->
//       <div id="warning-letters-list" class="space-y-3 max-h-96 overflow-y-auto custom-scrollbar">
//   `;
  
//   // Add each warning letter
//   letters.forEach(letter => {
//     // Determine if veterinary or human
//     const letterType = isVeterinary(letter) ? 'veterinary' : 'human';
    
//     html += `
//       <div class="warning-letter-item hover-card bg-white border border-gray-200 rounded p-4 transition-all" 
//            data-id="${letter.id || letter.letterId}" 
//            data-type="${letterType}" 
//            data-office="${letter.issuingOffice || ''}"
//            data-source-company="${letter.sourceCompany}">
//         <div class="flex justify-between items-start">
//           <h5 class="text-sm font-medium">${letter.companyName}</h5>
//           <div class="flex space-x-2">
//             <span class="text-xs px-2 py-1 rounded-full ${letterType === 'veterinary' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}">
//               ${letterType === 'veterinary' ? 'Veterinary' : 'Human'}
//             </span>
//             <span class="text-xs px-2 py-1 bg-gray-100 text-gray-800 rounded-full">
//               ${formatDate(letter.letterIssueDate)}
//             </span>
//           </div>
//         </div>
        
//         <p class="mt-1 text-xs text-gray-500">${letter.issuingOffice || 'Unknown Office'}</p>
//         <p class="mt-1 text-xs text-gray-500">Source Company: ${letter.sourceCompany}</p>
//         <p class="mt-1 text-xs text-gray-700">${letter.subject || 'No subject provided'}</p>
        
//         <div class="mt-2 text-xs text-gray-600 line-clamp-2">
//           ${highlightSearchTerm(letter.excerpt || '', letter.sourceCompany)}
//         </div>
        
//         <div class="mt-3 flex justify-between items-center">
//           <button class="text-xs text-blue-600 hover:text-blue-800 view-warning-letter" data-id="${letter.id || letter.letterId}">
//             View Details
//           </button>
//           ${letter.companyUrl ? `
//             <a href="${letter.companyUrl}" target="_blank" class="text-xs text-gray-600 hover:text-gray-800">
//               View on FDA Website
//               <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 inline-block ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
//               </svg>
//             </a>
//           ` : ''}
//         </div>
//       </div>
//     `;
//   });
  
//   // Close container divs
//   html += `
//       </div>
      
//       <div class="mt-4 text-center">
//         <button id="load-more-letters" class="text-xs bg-gray-100 hover:bg-gray-200 text-gray-800 font-medium py-2 px-4 rounded transition-colors">
//           Load More Letters
//         </button>
//       </div>
//     </div>
//   `;
  
//   // Update the warning letters section
//   elements.warningLettersData.innerHTML = html;
  
//   // Add event listeners for warning letter detail view
//   document.querySelectorAll('.view-warning-letter').forEach(button => {
//     button.addEventListener('click', function() {
//       const letterId = this.getAttribute('data-id');
//       viewWarningLetterDetails(letterId, companies.join("|")); // Pass companies for highlighting
//     });
//   });
  
//   // Add event listeners for filters
//   document.getElementById('warning-letters-type-filter').addEventListener('change', () => applyWarningLetterFilters(companies));
//   document.getElementById('warning-letters-office-filter').addEventListener('change', () => applyWarningLetterFilters(companies));
  
//   // Add event listener for load more button
//   document.getElementById('load-more-letters').addEventListener('click', () => loadMoreWarningLetters(companies));
// }

// // Updated function to apply warning letter filters
// function applyWarningLetterFilters(companies) {
//   const typeFilter = document.getElementById('warning-letters-type-filter').value;
//   const officeFilter = document.getElementById('warning-letters-office-filter').value;
  
//   // Get all letter items
//   const letterItems = document.querySelectorAll('.warning-letter-item');
//   let visibleCount = 0;
  
//   // Apply filters
//   letterItems.forEach(item => {
//     const itemType = item.getAttribute('data-type');
//     const itemOffice = item.getAttribute('data-office');
    
//     const typeMatch = typeFilter === 'all' || itemType === typeFilter;
//     const officeMatch = officeFilter === 'all' || itemOffice === officeFilter;
    
//     // Show/hide based on filter matching
//     if (typeMatch && officeMatch) {
//       item.classList.remove('hidden');
//       visibleCount++;
//     } else {
//       item.classList.add('hidden');
//     }
//   });
  
//   // Update the visible count
//   const countEl = document.querySelector('#warning-letters-list').previousElementSibling.querySelector('h4');
//   if (countEl) {
//     const totalCount = letterItems.length;
//     const searchTerm = companies.join(", ");
    
//     if (visibleCount < totalCount) {
//       countEl.textContent = `Showing ${visibleCount} of ${totalCount} warning letters for "${searchTerm}"`;
//     } else {
//       countEl.textContent = `Found ${totalCount} warning letters for "${searchTerm}"`;
//     }
//   }
  
//   // Show/hide load more button based on filters
//   const loadMoreBtn = document.getElementById('load-more-letters');
//   if (visibleCount === 0) {
//     loadMoreBtn.classList.add('hidden');
    
//     // Display a message if no results match the filters
//     const noResultsEl = document.getElementById('no-filter-results');
//     if (!noResultsEl) {
//       const messageEl = document.createElement('div');
//       messageEl.id = 'no-filter-results';
//       messageEl.className = 'text-center p-4 text-sm text-gray-500';
//       messageEl.textContent = 'No warning letters match the selected filters.';
      
//       document.getElementById('warning-letters-list').appendChild(messageEl);
//     }
//   } else {
//     loadMoreBtn.classList.remove('hidden');
    
//     // Remove no results message if it exists
//     const noResultsEl = document.getElementById('no-filter-results');
//     if (noResultsEl) noResultsEl.remove();
//   }
// }

// // Updated function to load more warning letters
// async function loadMoreWarningLetters(companies) {
//   const loadMoreBtn = document.getElementById('load-more-letters');
//   const currentCount = document.querySelectorAll('.warning-letter-item').length;
  
//   // Show loading state
//   loadMoreBtn.innerHTML = `
//     <svg class="animate-spin h-4 w-4 mr-1 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
//       <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
//       <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
//     </svg>
//     Loading...
//   `;
//   loadMoreBtn.disabled = true;
  
//   try {
//     // Get the current filter values
//     const typeFilter = document.getElementById('warning-letters-type-filter').value;
//     const officeFilter = document.getElementById('warning-letters-office-filter').value;
    
//     // Store new letters
//     const newLetters = new Map();
    
//     // Fetch more letters for each company
//     for (const company of companies) {
//       // Build query parameters
//       const queryParams = new URLSearchParams();
//       queryParams.append('term', company);
//       queryParams.append('field', 'companyName');
//       queryParams.append('offset', currentCount);
//       queryParams.append('limit', 10); // Load 10 more letters per company
      
//       // Add filters if they're not "all"
//       if (typeFilter !== 'all') queryParams.append('type', typeFilter);
//       if (officeFilter !== 'all') queryParams.append('issuingOffice', officeFilter);
      
//       // Make request to the API
//       const response = await fetch(`${API_BASE_URL}/wl/search?${queryParams.toString()}`);
      
//       if (!response.ok) {
//         console.warn(`Failed to load more letters for ${company}: ${response.status}`);
//         continue;
//       }
      
//       const data = await response.json();
//       const letters = data.results || [];
      
//       // Add new letters to Map
//       letters.forEach(letter => {
//         const letterId = letter.id || letter.letterId;
//         if (!newLetters.has(letterId)) {
//           newLetters.set(letterId, { ...letter, sourceCompany: company });
//         }
//       });
//     }
    
//     const lettersArray = Array.from(newLetters.values());
    
//     if (lettersArray.length === 0) {
//       // No more letters to load
//       loadMoreBtn.innerHTML = 'No more letters to load';
//       loadMoreBtn.disabled = true;
//       return;
//     }
    
//     // Function to check if letter is veterinary
//     const isVeterinary = letter => {
//       const vetKeywords = ['animal', 'vet', 'veterinary', 'livestock', 'pet', 'cattle', 'poultry', 'swine', 'equine', 'fish', 'aquatic', 'cow', 'horse', 'dog', 'cat'];
//       const title = (letter.companyName || '').toLowerCase();
//       const subject = (letter.subject || '').toLowerCase();
//       const content = (letter.fullContent || '').toLowerCase();
      
//       return vetKeywords.some(keyword => 
//         title.includes(keyword) || 
//         subject.includes(keyword) || 
//         content.includes(keyword)
//       );
//     };
    
//     // Create HTML for new letters
//     let html = '';
    
//     lettersArray.forEach(letter => {
//       // Determine if veterinary or human
//       const letterType = isVeterinary(letter) ? 'veterinary' : 'human';
      
//       html += `
//         <div class="warning-letter-item hover-card bg-white border border-gray-200 rounded p-4 transition-all" 
//              data-id="${letter.id || letter.letterId}" 
//              data-type="${letterType}" 
//              data-office="${letter.issuingOffice || ''}"
//              data-source-company="${letter.sourceCompany}">
//           <div class="flex justify-between items-start">
//             <h5 class="text-sm font-medium">${letter.companyName}</h5>
//             <div class="flex space-x-2">
//               <span class="text-xs px-2 py-1 rounded-full ${letterType === 'veterinary' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}">
//                 ${letterType === 'veterinary' ? 'Veterinary' : 'Human'}
//               </span>
//               <span class="text-xs px-2 py-1 bg-gray-100 text-gray-800 rounded-full">
//                 ${formatDate(letter.letterIssueDate)}
//               </span>
//             </div>
//           </div>
          
//           <p class="mt-1 text-xs text-gray-500">${letter.issuingOffice || 'Unknown Office'}</p>
//           <p class="mt-1 text-xs text-gray-500">Source Company: ${letter.sourceCompany}</p>
//           <p class="mt-1 text-xs text-gray-700">${letter.subject || 'No subject provided'}</p>
          
//           <div class="mt-2 text-xs text-gray-600 line-clamp-2">
//             ${highlightSearchTerm(letter.excerpt || '', letter.sourceCompany)}
//           </div>
          
//           <div class="mt-3 flex justify-between items-center">
//             <button class="text-xs text-blue-600 hover:text-blue-800 view-warning-letter" data-id="${letter.id || letter.letterId}">
//               View Details
//             </button>
//             ${letter.companyUrl ? `
//               <a href="${letter.companyUrl}" target="_blank" class="text-xs text-gray-600 hover:text-gray-800">
//                 View on FDA Website
//                 <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 inline-block ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                   <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
//                 </svg>
//               </a>
//             ` : ''}
//           </div>
//         </div>
//       `;
//     });
    
//     // Append new letters to the list
//     document.getElementById('warning-letters-list').insertAdjacentHTML('beforeend', html);
    
//     // Add event listeners for new warning letter detail view buttons
//     document.querySelectorAll('.view-warning-letter:not([data-initialized])').forEach(button => {
//       button.setAttribute('data-initialized', 'true');
//       button.addEventListener('click', function() {
//         const letterId = this.getAttribute('data-id');
//         viewWarningLetterDetails(letterId, companies.join("|"));
//       });
//     });
    
//     // Update button state
//     loadMoreBtn.innerHTML = 'Load More Letters';
//     loadMoreBtn.disabled = false;
    
//     // Apply current filters to the new items
//     applyWarningLetterFilters(companies);
//   } catch (error) {
//     console.error('Error loading more warning letters:', error);
//     loadMoreBtn.innerHTML = 'Error Loading More';
    
//     // Auto-reset after a delay
//     setTimeout(() => {
//       loadMoreBtn.innerHTML = 'Load More Letters';
//       loadMoreBtn.disabled = false;
//     }, 3000);
//   }
// }

// // Updated function to search warning letters directly
// async function searchWarningLetters(companies, type = null, issuingOffice = null) {
//   // Display the FDA data section if it's hidden
//   showSection(elements.fdaDataSection, true);
  
//   // Show loading state only for warning letters
//   elements.warningLettersData.innerHTML = `
//     <div class="flex justify-center items-center py-8">
//       <svg class="animate-spin h-6 w-6 text-red-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
//         <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
//         <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
//       </svg>
//       <span class="ml-2 text-gray-600">Searching warning letters for ${companies.length} companies...</span>
//     </div>
//   `;
  
//   try {
//     // Create filters object
//     const filters = {};
//     if (type) filters.type = type;
//     if (issuingOffice) filters.issuingOffice = issuingOffice;
    
//     // Fetch warning letters
//     await fetchWarningLetters(companies, filters);
//   } catch (error) {
//     console.error('Error searching warning letters:', error);
//     elements.warningLettersData.innerHTML = createErrorMessage('Error searching warning letters for companies');
//   }
// }

// // Update viewWarningLetterDetails to highlight multiple company names
// async function viewWarningLetterDetails(letterId, companies) {
//   try {
//     // Show loading modal
//     showWarningLetterModal(`
//       <div class="flex justify-center items-center py-12">
//         <svg class="animate-spin h-8 w-8 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
//           <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
//           <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
//         </svg>
//         <span class="ml-2">Loading warning letter details...</span>
//       </div>
//     `);
    
//     // Fetch the warning letter details
//     const response = await fetch(`${API_BASE_URL}/wl/letter/${letterId}`);
    
//     if (!response.ok) {
//       throw new Error(`Error fetching warning letter details: ${response.status}`);
//     }
    
//     const letter = await response.json();
    
//     // Format the letter content
//     let contentHtml = '';
    
//     if (letter.fullContent) {
//       // Highlight all company names
//       contentHtml = companies.split("|").reduce((text, company) => {
//         return highlightSearchTerm(text, company);
//       }, letter.fullContent);
//     } else {
//       contentHtml = '<p class="text-gray-500">No letter content available.</p>';
//     }
    
//     // Show warning letter details in modal
//     showWarningLetterModal(`
//       <div>
//         <div class="border-b pb-4 mb-4">
//           <div class="flex justify-between items-start">
//             <h3 class="text-xl font-semibold">${letter.companyName}</h3>
//             <div class="flex space-x-2">
//               ${letter.companyUrl ? `
//                 <a href="${letter.companyUrl}" target="_blank" class="text-xs bg-blue-50 text-blue-600 hover:bg-blue-100 px-3 py-1 rounded transition-colors">
//                   View on FDA Website
//                 </a>
//               ` : ''}
//             </div>
//           </div>
          
//           <div class="mt-2 grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
//             <div>
//               <p class="text-gray-500">Letter ID:</p>
//               <p>${letter.letterId || 'N/A'}</p>
//             </div>
//             <div>
//               <p class="text-gray-500">Issue Date:</p>
//               <p>${formatDate(letter.letterIssueDate)}</p>
//             </div>
//             <div>
//               <p class="text-gray-500">Issuing Office:</p>
//               <p>${letter.issuingOffice || 'N/A'}</p>
//             </div>
//           </div>
          
//           <div class="mt-4">
//             <p class="text-gray-500">Subject:</p>
//             <p>${letter.subject || 'No subject provided'}</p>
//           </div>
//         </div>
        
//         <div class="mb-4">
//           <h4 class="text-lg font-medium mb-2">Letter Content</h4>
//           <div class="bg-gray-50 p-4 rounded-md max-h-96 overflow-y-auto custom-scrollbar text-sm whitespace-pre-line">
//             ${contentHtml}
//           </div>
//         </div>
        
//         ${letter.companyUrl ? `
//           <div class="flex justify-center">
//             <a href="${letter.companyUrl}" target="_blank" class="text-blue-600 hover:text-blue-800 text-sm flex items-center">
//               <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
//               </svg>
//               View complete warning letter on FDA website
//             </a>
//           </div>
//         ` : ''}
//       </div>
//     `, letter.companyName);
    
//     // Scroll to first highlighted company name
//     if (companies) {
//       setTimeout(() => {
//         const firstHighlight = document.querySelector('.highlight');
//         if (firstHighlight) {
//           firstHighlight.scrollIntoView({ behavior: 'smooth', block: 'center' });
//           firstHighlight.classList.add('animate-pulse');
//           setTimeout(() => {
//             firstHighlight.classList.remove('animate-pulse');
//           }, 2000);
//         }
//       }, 500);
//     }
//   } catch (error) {
//     console.error('Error fetching warning letter details:', error);
//     showWarningLetterModal(`
//       <div class="text-center text-red-500 p-8">
//         <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
//         </svg>
//         <h3 class="text-lg font-medium mb-2">Error Loading Warning Letter</h3>
//         <p class="text-sm text-gray-600">We couldn't load the warning letter details. Please try again later.</p>
//       </div>
//     `, 'Error');
//   }
// }

// // Helper function to normalize company names (optional)
// function normalizeCompanyName(name) {
//   if (!name) return '';
//   return name
//     .toLowerCase()
//     .replace(/(\s*(inc\.?|llc|corp\.?|corporation|company|co\.?|ltd\.?|limited)\s*)$/i, '')
//     .trim();
// }


// // Function to show warning letter modal
// function showWarningLetterModal(content, title = 'Warning Letter Details') {
//   // Check if modal already exists
//   let modal = document.getElementById('warning-letter-modal');
  
//   if (!modal) {
//     // Create modal if it doesn't exist
//     modal = document.createElement('div');
//     modal.id = 'warning-letter-modal';
//     modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
//     modal.setAttribute('role', 'dialog');
//     modal.setAttribute('aria-modal', 'true');
    
//     // Build modal HTML
//     modal.innerHTML = `
//       <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col">
//         <div class="flex justify-between items-center p-4 border-b border-gray-200">
//           <h2 class="text-xl font-semibold" id="warning-letter-modal-title">${title}</h2>
//           <button id="close-warning-letter-modal" class="text-gray-400 hover:text-gray-600">
//             <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//               <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
//             </svg>
//           </button>
//         </div>
        
//         <div class="overflow-y-auto p-6" id="warning-letter-modal-content">
//           ${content}
//         </div>
//       </div>
//     `;
    
//     // Add to document
//     document.body.appendChild(modal);
    
//     // Add event listener to close button
//     document.getElementById('close-warning-letter-modal').addEventListener('click', closeWarningLetterModal);
    
//     // Close on click outside content
//     modal.addEventListener('click', function(e) {
//       if (e.target === modal) {
//         closeWarningLetterModal();
//       }
//     });
    
//     // Close on ESC key
//     document.addEventListener('keydown', function(e) {
//       if (e.key === 'Escape' && modal.classList.contains('flex')) {
//         closeWarningLetterModal();
//       }
//     });
//   } else {
//     // Update modal content
//     document.getElementById('warning-letter-modal-title').textContent = title;
//     document.getElementById('warning-letter-modal-content').innerHTML = content;
    
//     // Show the modal
//     modal.classList.remove('hidden');
//     modal.classList.add('flex');
//   }
  
//   // Prevent body scrolling
//   document.body.style.overflow = 'hidden';
// }

// // Function to close warning letter modal
// function closeWarningLetterModal() {
//   const modal = document.getElementById('warning-letter-modal');
//   if (modal) {
//     modal.classList.remove('flex');
//     modal.classList.add('hidden');
    
//     // Allow body scrolling again
//     document.body.style.overflow = '';
//   }
// }

// // Helper function to highlight search terms in text
// function highlightSearchTerm(text, searchTerm) {
//   if (!text || !searchTerm) return text;
  
//   // Escape special characters in the search term
//   const escapedSearchTerm = searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  
//   // Create a regular expression to find the search term
//   const regex = new RegExp(`(${escapedSearchTerm})`, 'gi');
  
//   // Replace matches with highlighted spans
//   return text.replace(regex, '<span class="highlight bg-yellow-200 px-0.5 rounded">$1</span>');
// }

// // Helper function to format date
// function formatDate(dateString) {
//   if (!dateString) return 'Unknown Date';
  
//   try {
//     const date = new Date(dateString);
//     if (isNaN(date.getTime())) return dateString;
    
//     return date.toLocaleDateString('en-US', {
//       month: 'short',
//       day: 'numeric',
//       year: 'numeric'
//     });
//   } catch (e) {
//     return dateString;
//   }
// }

// // Helper function to create error message
// function createErrorMessage(message) {
//   return `
//     <div class="text-center p-4">
//       <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mx-auto mb-2 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
//       </svg>
//       <p class="text-sm text-red-600">${message}</p>
//     </div>
//   `;
// }

// // Helper function to show/hide a section
// function showSection(element, show) {
//   if (show) {
//     element.classList.remove('hidden');
//   } else {
//     element.classList.add('hidden');
//   }
// }

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

// // New function to fetch warning letters
// async function fetchWarningLetters(searchTerm, filters = {}) {
//   try {
//     // Build query parameters
//     const queryParams = new URLSearchParams();
//     queryParams.append('term', searchTerm);
//     queryParams.append('field', 'all');


    
//     // Add filters if they exist
//     if (filters.type) queryParams.append('type', filters.type); // human or veterinary
//     if (filters.issueDate) queryParams.append('issueDate', filters.issueDate);
//     if (filters.issuingOffice) queryParams.append('issuingOffice', filters.issuingOffice);
    
//     // Show loading state
//     elements.warningLettersData.innerHTML = `
//       <div class="flex justify-center items-center py-8">
//         <svg class="animate-spin h-6 w-6 text-red-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
//           <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
//           <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
//         </svg>
//         <span class="ml-2 text-gray-600">Searching warning letters...</span>
//       </div>
//     `;
    
//     // Make request to the API
//     const response = await fetch(`${API_BASE_URL}/wl/search?${queryParams.toString()}`);
    
//     if (!response.ok) {
//       throw new Error(`Error fetching warning letters: ${response.status}`);
//     }
    
//     const data = await response.json();
    
//     // Display the warning letters
//     displayWarningLetters(data, searchTerm);
//   } catch (error) {
//     console.error("Error fetching warning letters:", error);
//     elements.warningLettersData.innerHTML = createErrorMessage("Error fetching warning letters");
//     elements.warningLettersCount.textContent = "0 letters";
//   }
// }

// // New function to display warning letters
// function displayWarningLetters(data, searchTerm) {
//   const letters = data.results || [];
//   const totalCount = data.total || 0;
  
//   // Update counter
//   elements.warningLettersCount.textContent = `${totalCount} letters`;
  
//   if (letters.length === 0) {
//     elements.warningLettersData.innerHTML = `
//       <div class="text-center p-4">
//         <p class="text-sm text-gray-700">No warning letters found containing "${searchTerm}"</p>
//       </div>
//     `;
//     return;
//   }
  
//   // Get unique issuing offices for filter
//   const issuingOffices = [...new Set(letters.map(letter => letter.issuingOffice))].filter(Boolean);
  
//   // Determine which letters are veterinary vs human
//   const isVeterinary = letter => {
//     const vetKeywords = ['animal', 'vet', 'veterinary', 'livestock', 'pet', 'cattle', 'poultry', 'swine', 'equine', 'fish', 'aquatic', 'cow', 'horse', 'dog', 'cat'];
//     const title = (letter.companyName || '').toLowerCase();
//     const subject = (letter.subject || '').toLowerCase();
//     const content = (letter.fullContent || '').toLowerCase();
    
//     return vetKeywords.some(keyword => 
//       title.includes(keyword) || 
//       subject.includes(keyword) || 
//       content.includes(keyword)
//     );
//   };
  
//   // Create HTML for warning letters section
//   let html = `
//     <div>
//       <!-- Filter controls -->
//       <div class="mb-4">
//         <div class="flex flex-wrap items-center justify-between">

//           <div class="flex space-x-2">
//             <div>
//               <select id="warning-letters-type-filter" class="text-xs rounded border border-gray-300 py-1 px-2 focus:outline-none focus:ring-1 focus:ring-blue-500">
//                 <option value="all">All Types</option>
//                 <option value="human">Human</option>
//                 <option value="veterinary">Veterinary</option>
//               </select>
//             </div>
//             <div>
//               <select id="warning-letters-office-filter" class="text-xs rounded border border-gray-300 py-1 px-2 focus:outline-none focus:ring-1 focus:ring-blue-500">
//                 <option value="all">All Offices</option>
//                 ${issuingOffices.map(office => `<option value="${office}">${office}</option>`).join('')}
//               </select>
//             </div>
//           </div>
//         </div>
//       </div>
      
//       <!-- Warning letters list -->
//       <div id="warning-letters-list" class="space-y-3 max-h-96 overflow-y-auto custom-scrollbar">
//   `;
  
//   // Add each warning letter
//   letters.forEach(letter => {
//     // Determine if veterinary or human
//     const letterType = isVeterinary(letter) ? 'veterinary' : 'human';
    
//     html += `
//       <div class="warning-letter-item hover-card bg-white border border-gray-200 rounded p-4 transition-all" 
//            data-id="${letter.id || letter.letterId}" 
//            data-type="${letterType}" 
//            data-office="${letter.issuingOffice || ''}">
//         <div class="flex justify-between items-start">
//           <h5 class="text-sm font-medium">${letter.companyName}</h5>
//           <div class="flex space-x-2">
//             <span class="text-xs px-2 py-1 rounded-full ${letterType === 'veterinary' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}">
//               ${letterType === 'veterinary' ? 'Veterinary' : 'Human'}
//             </span>
//             <span class="text-xs px-2 py-1 bg-gray-100 text-gray-800 rounded-full">
//               ${formatDate(letter.letterIssueDate)}
//             </span>
//           </div>
//         </div>
        
//         <p class="mt-1 text-xs text-gray-500">${letter.issuingOffice || 'Unknown Office'}</p>
//         <p class="mt-1 text-xs text-gray-700">${letter.subject || 'No subject provided'}</p>
        
//         <div class="mt-2 text-xs text-gray-600 line-clamp-2">
//           ${highlightSearchTerm(letter.excerpt || '', searchTerm)}
//         </div>
        
//         <div class="mt-3 flex justify-between items-center">
//           <button class="text-xs text-blue-600 hover:text-blue-800 view-warning-letter" data-id="${letter.id || letter.letterId}">
//             View Details
//           </button>
//           ${letter.companyUrl ? `
//             <a href="${letter.companyUrl}" target="_blank" class="text-xs text-gray-600 hover:text-gray-800">
//               View on FDA Website
//               <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 inline-block ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
//               </svg>
//             </a>
//           ` : ''}
//         </div>
//       </div>
//     `;
//   });
  
//   // Close container divs
//   html += `
//       </div>
      
//       <div class="mt-4 text-center">
//         <button id="load-more-letters" class="text-xs bg-gray-100 hover:bg-gray-200 text-gray-800 font-medium py-2 px-4 rounded transition-colors">
//           Load More Letters
//         </button>
//       </div>
//     </div>
//   `;
  
//   // Update the warning letters section
//   elements.warningLettersData.innerHTML = html;
  
//   // Add event listeners for warning letter detail view
//   document.querySelectorAll('.view-warning-letter').forEach(button => {
//     button.addEventListener('click', function() {
//       const letterId = this.getAttribute('data-id');
//       viewWarningLetterDetails(letterId, searchTerm);
//     });
//   });
  
//   // Add event listeners for filters
//   document.getElementById('warning-letters-type-filter').addEventListener('change', applyWarningLetterFilters);
//   document.getElementById('warning-letters-office-filter').addEventListener('change', applyWarningLetterFilters);
  
//   // Add event listener for load more button
//   document.getElementById('load-more-letters').addEventListener('click', function() {
//     loadMoreWarningLetters(searchTerm);
//   });
// }

// // Function to apply warning letter filters
// function applyWarningLetterFilters() {
//   const typeFilter = document.getElementById('warning-letters-type-filter').value;
//   const officeFilter = document.getElementById('warning-letters-office-filter').value;
  
//   // Get all letter items
//   const letterItems = document.querySelectorAll('.warning-letter-item');
//   let visibleCount = 0;
  
//   // Apply filters
//   letterItems.forEach(item => {
//     const itemType = item.getAttribute('data-type');
//     const itemOffice = item.getAttribute('data-office');
    
//     const typeMatch = typeFilter === 'all' || itemType === typeFilter;
//     const officeMatch = officeFilter === 'all' || itemOffice === officeFilter;
    
//     // Show/hide based on filter matching
//     if (typeMatch && officeMatch) {
//       item.classList.remove('hidden');
//       visibleCount++;
//     } else {
//       item.classList.add('hidden');
//     }
//   });
  
//   // Update the visible count
//   const countEl = document.querySelector('#warning-letters-list').previousElementSibling.querySelector('h4');
//   if (countEl) {
//     const totalCount = letterItems.length;
//     const searchTerm = countEl.textContent.match(/related to "([^"]+)"/)?.[1] || '';
    
//     if (visibleCount < totalCount) {
//       countEl.textContent = `Showing ${visibleCount} of ${totalCount} warning letters related to "${searchTerm}"`;
//     } else {
//       countEl.textContent = `Found ${totalCount} warning letters related to "${searchTerm}"`;
//     }
//   }
  
//   // Show/hide load more button based on filters
//   const loadMoreBtn = document.getElementById('load-more-letters');
//   if (visibleCount === 0) {
//     loadMoreBtn.classList.add('hidden');
    
//     // Display a message if no results match the filters
//     const noResultsEl = document.getElementById('no-filter-results');
//     if (!noResultsEl) {
//       const messageEl = document.createElement('div');
//       messageEl.id = 'no-filter-results';
//       messageEl.className = 'text-center p-4 text-sm text-gray-500';
//       messageEl.textContent = 'No warning letters match the selected filters.';
      
//       document.getElementById('warning-letters-list').appendChild(messageEl);
//     }
//   } else {
//     loadMoreBtn.classList.remove('hidden');
    
//     // Remove no results message if it exists
//     const noResultsEl = document.getElementById('no-filter-results');
//     if (noResultsEl) noResultsEl.remove();
//   }
// }

// // Function to load more warning letters
// async function loadMoreWarningLetters(searchTerm) {
//   const loadMoreBtn = document.getElementById('load-more-letters');
//   const currentCount = document.querySelectorAll('.warning-letter-item').length;
  
//   // Show loading state
//   loadMoreBtn.innerHTML = `
//     <svg class="animate-spin h-4 w-4 mr-1 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
//       <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
//       <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
//     </svg>
//     Loading...
//   `;
//   loadMoreBtn.disabled = true;
  
//   try {
//     // Get the current filter values
//     const typeFilter = document.getElementById('warning-letters-type-filter').value;
//     const officeFilter = document.getElementById('warning-letters-office-filter').value;
    
//     // Build query parameters
//     const queryParams = new URLSearchParams();
//     queryParams.append('term', searchTerm);
//     queryParams.append('field', 'all');
//     queryParams.append('offset', currentCount);
//     queryParams.append('limit', 10); // Load 10 more letters
    
//     // Add filters if they're not "all"
//     if (typeFilter !== 'all') queryParams.append('type', typeFilter);
//     if (officeFilter !== 'all') queryParams.append('issuingOffice', officeFilter);
    
//     // Make request to the API
//     const response = await fetch(`${API_BASE_URL}/wl/search?${queryParams.toString()}`);
    
//     if (!response.ok) {
//       throw new Error(`Error fetching more warning letters: ${response.status}`);
//     }
    
//     const data = await response.json();
//     const letters = data.results || [];
    
//     if (letters.length === 0) {
//       // No more letters to load
//       loadMoreBtn.innerHTML = 'No more letters to load';
//       loadMoreBtn.disabled = true;
//       return;
//     }
    
//     // Function to check if letter is veterinary
//     const isVeterinary = letter => {
//       const vetKeywords = ['animal', 'vet', 'veterinary', 'livestock', 'pet', 'cattle', 'poultry', 'swine', 'equine', 'fish', 'aquatic', 'cow', 'horse', 'dog', 'cat'];
//       const title = (letter.companyName || '').toLowerCase();
//       const subject = (letter.subject || '').toLowerCase();
//       const content = (letter.fullContent || '').toLowerCase();
      
//       return vetKeywords.some(keyword => 
//         title.includes(keyword) || 
//         subject.includes(keyword) || 
//         content.includes(keyword)
//       );
//     };
    
//     // Create HTML for new letters
//     let html = '';
    
//     letters.forEach(letter => {
//       // Determine if veterinary or human
//       const letterType = isVeterinary(letter) ? 'veterinary' : 'human';
      
//       html += `
//         <div class="warning-letter-item hover-card bg-white border border-gray-200 rounded p-4 transition-all" 
//              data-id="${letter.id || letter.letterId}" 
//              data-type="${letterType}" 
//              data-office="${letter.issuingOffice || ''}">
//           <div class="flex justify-between items-start">
//             <h5 class="text-sm font-medium">${letter.companyName}</h5>
//             <div class="flex space-x-2">
//               <span class="text-xs px-2 py-1 rounded-full ${letterType === 'veterinary' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}">
//                 ${letterType === 'veterinary' ? 'Veterinary' : 'Human'}
//               </span>
//               <span class="text-xs px-2 py-1 bg-gray-100 text-gray-800 rounded-full">
//                 ${formatDate(letter.letterIssueDate)}
//               </span>
//             </div>
//           </div>
          
//           <p class="mt-1 text-xs text-gray-500">${letter.issuingOffice || 'Unknown Office'}</p>
//           <p class="mt-1 text-xs text-gray-700">${letter.subject || 'No subject provided'}</p>
          
//           <div class="mt-2 text-xs text-gray-600 line-clamp-2">
//             ${highlightSearchTerm(letter.excerpt || '', searchTerm)}
//           </div>
          
//           <div class="mt-3 flex justify-between items-center">
//             <button class="text-xs text-blue-600 hover:text-blue-800 view-warning-letter" data-id="${letter.id || letter.letterId}">
//               View Details
//             </button>
//             ${letter.companyUrl ? `
//               <a href="${letter.companyUrl}" target="_blank" class="text-xs text-gray-600 hover:text-gray-800">
//                 View on FDA Website
//                 <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 inline-block ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                   <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
//                 </svg>
//               </a>
//             ` : ''}
//           </div>
//         </div>
//       `;
//     });
    
//     // Append new letters to the list
//     document.getElementById('warning-letters-list').insertAdjacentHTML('beforeend', html);
    
//     // Add event listeners for new warning letter detail view buttons
//     document.querySelectorAll('.view-warning-letter:not([data-initialized])').forEach(button => {
//       button.setAttribute('data-initialized', 'true');
//       button.addEventListener('click', function() {
//         const letterId = this.getAttribute('data-id');
//         viewWarningLetterDetails(letterId, searchTerm);
//       });
//     });
    
//     // Update button state
//     loadMoreBtn.innerHTML = 'Load More Letters';
//     loadMoreBtn.disabled = false;
    
//     // Apply current filters to the new items
//     applyWarningLetterFilters();
//   } catch (error) {
//     console.error('Error loading more warning letters:', error);
//     loadMoreBtn.innerHTML = 'Error Loading More';
    
//     // Auto-reset after a delay
//     setTimeout(() => {
//       loadMoreBtn.innerHTML = 'Load More Letters';
//       loadMoreBtn.disabled = false;
//     }, 3000);
//   }
// }

// // Function to view warning letter details
// async function viewWarningLetterDetails(letterId, searchTerm) {
//   try {
//     // Show loading modal
//     showWarningLetterModal(`
//       <div class="flex justify-center items-center py-12">
//         <svg class="animate-spin h-8 w-8 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
//           <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
//           <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
//         </svg>
//         <span class="ml-2">Loading warning letter details...</span>
//       </div>
//     `);
    
//     // Fetch the warning letter details
//     const response = await fetch(`${API_BASE_URL}/wl/letter/${letterId}`);
    
//     if (!response.ok) {
//       throw new Error(`Error fetching warning letter details: ${response.status}`);
//     }
    
//     const letter = await response.json();
    
//     // Format the letter content
//     let contentHtml = '';
    
//     if (letter.fullContent) {
//       // If we have a search term, highlight it
//       contentHtml = searchTerm 
//         ? highlightSearchTerm(letter.fullContent, searchTerm)
//         : letter.fullContent;
//     } else {
//       contentHtml = '<p class="text-gray-500">No letter content available.</p>';
//     }
    
//     // Show warning letter details in modal
//     showWarningLetterModal(`
//       <div>
//         <div class="border-b pb-4 mb-4">
//           <div class="flex justify-between items-start">
//             <h3 class="text-xl font-semibold">${letter.companyName}</h3>
//             <div class="flex space-x-2">
//               ${letter.companyUrl ? `
//                 <a href="${letter.companyUrl}" target="_blank" class="text-xs bg-blue-50 text-blue-600 hover:bg-blue-100 px-3 py-1 rounded transition-colors">
//                   View on FDA Website
//                 </a>
//               ` : ''}
//             </div>
//           </div>
          
//           <div class="mt-2 grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
//             <div>
//               <p class="text-gray-500">Letter ID:</p>
//               <p>${letter.letterId || 'N/A'}</p>
//             </div>
//             <div>
//               <p class="text-gray-500">Issue Date:</p>
//               <p>${formatDate(letter.letterIssueDate)}</p>
//             </div>
//             <div>
//               <p class="text-gray-500">Issuing Office:</p>
//               <p>${letter.issuingOffice || 'N/A'}</p>
//             </div>
//           </div>
          
//           <div class="mt-4">
//             <p class="text-gray-500">Subject:</p>
//             <p>${letter.subject || 'No subject provided'}</p>
//           </div>
//         </div>
        
//         <div class="mb-4">
//           <h4 class="text-lg font-medium mb-2">Letter Content</h4>
//           <div class="bg-gray-50 p-4 rounded-md max-h-96 overflow-y-auto custom-scrollbar text-sm whitespace-pre-line">
//             ${contentHtml}
//           </div>
//         </div>
        
//         ${letter.companyUrl ? `
//           <div class="flex justify-center">
//             <a href="${letter.companyUrl}" target="_blank" class="text-blue-600 hover:text-blue-800 text-sm flex items-center">
//               <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
//               </svg>
//               View complete warning letter on FDA website
//             </a>
//           </div>
//         ` : ''}
//       </div>
//     `, letter.companyName);
    
//     // If we have a search term, scroll to the first occurrence and highlight it specially
//     if (searchTerm && letter.fullContent) {
//       setTimeout(() => {
//         // Find the first highlighted element
//         const firstHighlight = document.querySelector('.highlight');
//         if (firstHighlight) {
//           // Scroll the element into view within the scrollable container
//           firstHighlight.scrollIntoView({ behavior: 'smooth', block: 'center' });
          
//           // Add a special animation to draw attention
//           firstHighlight.classList.add('animate-pulse');
//           setTimeout(() => {
//             firstHighlight.classList.remove('animate-pulse');
//           }, 2000);
//         }
//       }, 500);
//     }
//   } catch (error) {
//     console.error('Error fetching warning letter details:', error);
//     showWarningLetterModal(`
//       <div class="text-center text-red-500 p-8">
//         <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
//         </svg>
//         <h3 class="text-lg font-medium mb-2">Error Loading Warning Letter</h3>
//         <p class="text-sm text-gray-600">We couldn't load the warning letter details. Please try again later.</p>
//       </div>
//     `, 'Error');
//   }
// }

// // Function to search warning letters directly
// async function searchWarningLetters(searchTerm, type = null, issuingOffice = null) {
//   // Display the FDA data section if it's hidden
//   showSection(elements.fdaDataSection, true);
  
//   // Show loading state only for warning letters
//   elements.warningLettersData.innerHTML = `
//     <div class="flex justify-center items-center py-8">
//       <svg class="animate-spin h-6 w-6 text-red-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
//         <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
//         <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
//       </svg>
//       <span class="ml-2 text-gray-600">Searching warning letters...</span>
//     </div>
//   `;
  
//   try {
//     // Create filters object
//     const filters = {};
//     if (type) filters.type = type;
//     if (issuingOffice) filters.issuingOffice = issuingOffice;
    
//     // Fetch warning letters
//     await fetchWarningLetters(searchTerm, filters);
//   } catch (error) {
//     console.error('Error searching warning letters:', error);
//     elements.warningLettersData.innerHTML = createErrorMessage('Error searching warning letters');
//   }
// }

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// // Function to generate an AI-like summary of FDA data
// function generateFdaSummary(fdaData, drugName) {
//   // Handle empty data case
//   if (!fdaData || (!fdaData.raw && !fdaData.categorized) || 
//       (Object.keys(fdaData.categorized).length === 0 && 
//        (!fdaData.raw.combinedResults || fdaData.raw.combinedResults.length === 0))) {
//     return `No FDA data found for "${drugName}".`;
//   }
  
//   // Extract endpoint data
//   const endpointsData = fdaData.raw?.endpoints || {};
  
//   // Initialize summary sections
//   let summary = `<div class="text-lg font-semibold mb-2">Summary for ${drugName}</div>`;
  
//   // Applications summary
//   let applicationSummary = "";
//   if (Object.keys(fdaData.categorized).length > 0) {
//     // Count applications and forms
//     let allProducts = [];
//     let manufacturers = new Set();
//     let dosageForms = new Set();
    
//     Object.entries(fdaData.categorized).forEach(([brandName, strengths]) => {
//       Object.entries(strengths).forEach(([strength, products]) => {
//         products.forEach(product => {
//           allProducts.push({...product, strength});
//           if (product.manufacturerName) manufacturers.add(product.manufacturerName);
//           if (product.sponsorName) manufacturers.add(product.sponsorName);
//           if (product.dosageForm) dosageForms.add(product.dosageForm);
//         });
//       });
//     });
    
//     applicationSummary = `
//       <div class="mb-3">
//         <span class="font-medium">Applications:</span> ${allProducts.length} total applications found for ${drugName}.
//         ${manufacturers.size > 0 ? `Made by ${manufacturers.size} different manufacturer${manufacturers.size > 1 ? 's' : ''}.` : ''}
//         ${dosageForms.size > 0 ? `Available in ${dosageForms.size} dosage form${dosageForms.size > 1 ? 's' : ''} (${Array.from(dosageForms).join(', ')}).` : ''}
//       </div>
//     `;
//   }
  
//   // Label summary
//   let labelSummary = "";
//   const labelData = endpointsData.label?.data || [];
//   if (labelData.length > 0) {
//     // Extract key information from labels
//     const indications = new Set();
//     const warnings = new Set();
//     const hasBoxedWarning = labelData.some(label => label.boxed_warning && label.boxed_warning.length > 0);
    
//     labelData.forEach(label => {
//       if (label.indications_and_usage && label.indications_and_usage.length > 0) {
//         // Extract first sentence of indications for brevity
//         const firstSentence = label.indications_and_usage[0].split('.')[0];
//         if (firstSentence) indications.add(firstSentence);
//       }
      
//       if (label.warnings && label.warnings.length > 0) {
//         // Extract first sentence of warnings
//         const firstSentence = label.warnings[0].split('.')[0];
//         if (firstSentence) warnings.add(firstSentence);
//       } else if (label.warnings_and_precautions && label.warnings_and_precautions.length > 0) {
//         const firstSentence = label.warnings_and_precautions[0].split('.')[0];
//         if (firstSentence) warnings.add(firstSentence);
//       }
//     });
    
//     labelSummary = `
//       <div class="mb-3">
//         <span class="font-medium">Labeling:</span> ${labelData.length} drug label${labelData.length > 1 ? 's' : ''} found.
//         ${hasBoxedWarning ? '<span class="text-red-600 font-medium">Contains boxed warnings</span>.' : ''}
//         ${indications.size > 0 ? `<div class="ml-4 mt-1"><span class="font-medium">Key Indication:</span> ${Array.from(indications)[0]}.</div>` : ''}
//         ${warnings.size > 0 ? `<div class="ml-4 mt-1"><span class="font-medium">Key Warning:</span> ${Array.from(warnings)[0]}.</div>` : ''}
//       </div>
//     `;
//   }
  
//   // Adverse Events summary
//   let eventSummary = "";
//   const eventData = endpointsData.event?.data || [];
//   if (eventData.length > 0) {
//     // Count serious vs non-serious
//     const seriousCount = eventData.filter(event => event.serious).length;
//     const nonSeriousCount = eventData.length - seriousCount;
    
//     // Count reaction types
//     const reactionCounts = {};
//     eventData.forEach(event => {
//       const reactions = event.patient?.reaction || [];
//       reactions.forEach(reaction => {
//         const reactionName = reaction.reactionmeddrapt || 'Unknown';
//         reactionCounts[reactionName] = (reactionCounts[reactionName] || 0) + 1;
//       });
//     });
    
//     // Get top 3 reactions
//     const topReactions = Object.entries(reactionCounts)
//       .sort((a, b) => b[1] - a[1])
//       .slice(0, 3)
//       .map(([name]) => name);
    
//     eventSummary = `
//       <div class="mb-3">
//         <span class="font-medium">Adverse Events:</span> ${eventData.length} reports found
//         (${seriousCount} serious, ${nonSeriousCount} non-serious).
//         ${topReactions.length > 0 ? `
//           <div class="ml-4 mt-1"><span class="font-medium">Top reported reactions:</span> ${topReactions.join(', ')}.</div>
//         ` : ''}
//       </div>
//     `;
//   }
  
//   // Enforcement summary
//   let enforcementSummary = "";
//   const enforcementData = endpointsData.enforcement?.data || [];
//   if (enforcementData.length > 0) {
//     // Count by classification
//     const classI = enforcementData.filter(report => report.classification && report.classification.includes('Class I')).length;
//     const classII = enforcementData.filter(report => report.classification && report.classification.includes('Class II')).length;
//     const classIII = enforcementData.filter(report => report.classification && report.classification.includes('Class III')).length;
    
//     // Get recent enforcement date
//     const mostRecentDate = enforcementData
//       .map(report => report.recall_initiation_date)
//       .filter(date => date)
//       .sort((a, b) => new Date(b) - new Date(a))[0];
    
//     enforcementSummary = `
//       <div class="mb-3">
//         <span class="font-medium">Enforcement Actions:</span> ${enforcementData.length} recall${enforcementData.length > 1 ? 's' : ''} found.
//         ${classI > 0 ? `<span class="text-red-600 font-medium">${classI} Class I (most severe)</span>` : ''}
//         ${classII > 0 ? `${classI > 0 ? ', ' : ''}${classII} Class II` : ''}
//         ${classIII > 0 ? `${classI > 0 || classII > 0 ? ', ' : ''}${classIII} Class III` : ''}
//         ${mostRecentDate ? `. Most recent on ${formatDate(mostRecentDate)}.` : ''}
//       </div>
//     `;
//   }
  
//   // Orange Book summary (if available)
//   let orangeBookSummary = "";
//   if (window.orangeBookData && window.orangeBookData.results) {
//     const results = window.orangeBookData.results;
//     if (results.total > 0) {
//       orangeBookSummary = `
//         <div class="mb-3">
//           <span class="font-medium">Orange Book:</span> ${results.total} entries found.
//           ${results.patents > 0 ? `${results.patents} patent${results.patents > 1 ? 's' : ''}.` : ''}
//           ${results.exclusivities > 0 ? `${results.exclusivities} exclusivit${results.exclusivities > 1 ? 'ies' : 'y'}.` : ''}
//         </div>
//       `;
//     }
//   }
  
//   // DailyMed summary (if available)
//   let dailyMedSummary = "";
//   if (window.dailyMedData && window.dailyMedData.label_info) {
//     const labelInfo = window.dailyMedData.label_info;
//     if (labelInfo.length > 0) {
//       // Count unique manufacturers
//       const manufacturers = new Set(labelInfo.map(label => label.manufacturer).filter(m => m));
      
//       dailyMedSummary = `
//         <div class="mb-3">
//           <span class="font-medium">DailyMed:</span> ${labelInfo.length} label${labelInfo.length > 1 ? 's' : ''} found.
//           ${manufacturers.size > 0 ? `From ${manufacturers.size} manufacturer${manufacturers.size > 1 ? 's' : ''}.` : ''}
//         </div>
//       `;
//     }
//   }
  
//   // Warning Letters summary (if available)
//   let warningLettersSummary = "";
//   if (window.warningLettersData && window.warningLettersData.length > 0) {
//     const letters = window.warningLettersData;
//     if (letters.length > 0) {
//       // Get recent letter date
//       const mostRecentDate = letters
//         .map(letter => letter.posted_date)
//         .filter(date => date)
//         .sort((a, b) => new Date(b) - new Date(a))[0];
      
//       warningLettersSummary = `
//         <div class="mb-3">
//           <span class="font-medium text-red-600">Warning Letters:</span> ${letters.length} letter${letters.length > 1 ? 's' : ''} found.
//           ${mostRecentDate ? `Most recent on ${formatDate(mostRecentDate)}.` : ''}
//         </div>
//       `;
//     }
//   }
  
//   // Combine all summaries
//   summary += `
//     <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-sm">
//       ${applicationSummary}
//       ${labelSummary}
//       ${eventSummary}
//       ${enforcementSummary}
//       ${orangeBookSummary}
//       ${dailyMedSummary}
//       ${warningLettersSummary}
      
//       <div class="text-xs text-gray-500 mt-3 pt-2 border-t border-gray-300">
//         This summary was generated automatically based on FDA data.
//       </div>
//     </div>
//   `;
  
//   return summary;
// }

// // Add this function to display the FDA summary
// function displayFdaSummary(fdaData, drugName) {
//   // Store data in window for access by the summary generator
//   window.orangeBookData = null;
//   window.dailyMedData = null;
//   window.warningLettersData = null;
  
//   // Create a summary container if it doesn't exist
//   let summaryContainer = document.getElementById('fda-summary-container');
//   if (!summaryContainer) {
//     // Add a new summary tab to the existing tab system
//     const tabList = document.querySelector('.fda-data-section .flex.flex-wrap.-mb-px');
//     if (tabList) {
//       // Create the summary tab button
//       const summaryTab = document.createElement('li');
//       summaryTab.className = 'mr-2';
//       summaryTab.setAttribute('role', 'presentation');
//       summaryTab.innerHTML = `
//         <button class="fda-tab-button inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300" 
//                 id="summary-tab" 
//                 data-tab="summary-content"
//                 aria-selected="false">
//           Summary <span class="ml-1 text-xs bg-blue-100 text-blue-800 px-1.5 py-0.5 rounded-full">AI</span>
//         </button>
//       `;
//       tabList.insertBefore(summaryTab, tabList.firstChild);
      
//       // Create the summary content container
//       const tabContent = document.querySelector('.fda-data-section .tab-content');
//       if (tabContent) {
//         summaryContainer = document.createElement('div');
//         summaryContainer.id = 'summary-content';
//         summaryContainer.className = 'fda-tab-pane hidden';
//         tabContent.insertBefore(summaryContainer, tabContent.firstChild);
        
//         // Add click handler for the summary tab
//         document.getElementById('summary-tab').addEventListener('click', function() {
//           // Hide all tab panes
//           document.querySelectorAll('.fda-tab-pane').forEach(pane => {
//             pane.classList.add('hidden');
//           });
          
//           // Deactivate all tab buttons
//           document.querySelectorAll('.fda-tab-button').forEach(btn => {
//             btn.classList.remove('border-blue-500', 'text-blue-600');
//             btn.classList.add('border-transparent', 'hover:text-gray-600', 'hover:border-gray-300');
//             btn.setAttribute('aria-selected', 'false');
//           });
          
//           // Activate the summary tab
//           summaryContainer.classList.remove('hidden');
//           this.classList.remove('border-transparent', 'hover:text-gray-600', 'hover:border-gray-300');
//           this.classList.add('border-blue-500', 'text-blue-600');
//           this.setAttribute('aria-selected', 'true');
//         });
//       }
//     }
//   }
  
//   // Generate and display the summary
//   if (summaryContainer) {
//     summaryContainer.innerHTML = generateFdaSummary(fdaData, drugName);
    
//     // Optional: Activate the summary tab by default
//     document.getElementById('summary-tab')?.click();
//   }
// }

// // Modify the displayComprehensiveFdaData function to call our summary function
// function modifyDisplayFdaData() {
//   // Store the original function
//   const originalDisplayFunction = displayComprehensiveFdaData;
  
//   // Override the function
//   window.displayComprehensiveFdaData = function(fdaData, drugName) {
//     // Call the original function first
//     originalDisplayFunction(fdaData, drugName);
    
//     // Then add our summary
//     displayFdaSummary(fdaData, drugName);
//   };
// }

// // Add a function to set global data for the summary
// function setGlobalDataForSummary(dataType, data) {
//   switch(dataType) {
//     case 'orangeBook':
//       window.orangeBookData = data;
//       break;
//     case 'dailyMed':
//       window.dailyMedData = data;
//       break;
//     case 'warningLetters':
//       window.warningLettersData = data;
//       break;
//   }
  
//   // Refresh the summary if all data is present
//   if (window.fdaData) {
//     displayFdaSummary(window.fdaData, window.currentDrugName);
//   }
// }

// // Modify these display functions to store their data globally
// function modifyDataDisplayFunctions() {
//   // Store original functions
//   const originalOrangeBookFunction = displayOrangeBookData;
//   const originalDailyMedFunction = displayDailyMedData;
//   const originalWarningLettersFunction = displayWarningLetters || function(){};
  
//   // Override Orange Book display
//   window.displayOrangeBookData = function(data) {
//     originalOrangeBookFunction(data);
//     setGlobalDataForSummary('orangeBook', data);
//   };
  
//   // Override DailyMed display
//   window.displayDailyMedData = function(data) {
//     originalDailyMedFunction(data);
//     setGlobalDataForSummary('dailyMed', data);
//   };
  
//   // Override Warning Letters display
//   window.displayWarningLetters = function(data) {
//     originalWarningLettersFunction(data);
//     setGlobalDataForSummary('warningLetters', data);
//   };
// }

// // Modify the displayFdaData function to store drug name
// function modifyDisplayFdaData() {
//   // Store the original function
//   const originalFunction = displayFdaData;
  
//   // Override the function
//   window.displayFdaData = function(drugName, condition) {
//     // Store current drug name
//     window.currentDrugName = drugName;
    
//     // Call the original function
//     originalFunction(drugName, condition);
//   };
// }

// // Initialize the summary feature
// function initFdaSummaryFeature() {
//   // Patch the necessary functions
//   modifyDisplayFdaData();
//   modifyDataDisplayFunctions();
  
//   console.log("FDA AI Summary feature initialized!");
// }

// // Call this function when the page loads
// document.addEventListener('DOMContentLoaded', initFdaSummaryFeature);

// // Add a standalone function to trigger the summary
// function showFdaSummary(drugName) {
//   // Create a modal with the summary
//   const fdaData = window.fdaData;
  
//   if (!fdaData) {
//     alert("Please search for a drug first to generate a summary.");
//     return;
//   }
  
//   const summaryHtml = generateFdaSummary(fdaData, drugName || window.currentDrugName || "this drug");
  
//   showWarningLetterModal(summaryHtml, "FDA Data Summary");
// }

// Enhanced FDA Summary with OpenAI Integration and Email Feature

// Function to collect all FDA data for the summary
function collectAllFdaData(drugName) {
  // Collect data from all sources
  const allData = {
    fdaData: window.fdaData || null,
    orangeBookData: window.orangeBookData || null,
    dailyMedData: window.dailyMedData || null,
    warningLettersData: window.warningLettersData || null,
    drugName: drugName || window.currentDrugName || "this drug"
  };
  
  return allData;
}

// Function to generate a local summary while waiting for OpenAI
function generateLocalSummary(allData) {
  const { fdaData, orangeBookData, dailyMedData, warningLettersData, drugName } = allData;
  
  // Handle empty data case
  if (!fdaData) {
    return `<div class="p-4 text-center">No FDA data found for "${drugName}".</div>`;
  }
  
  // Extract endpoint data
  const endpointsData = fdaData.raw?.endpoints || {};
  
  // Initialize summary sections
  let summary = `<div class="text-xl font-semibold mb-4">Quick Summary for ${drugName}</div>`;
//   summary += `<div class="text-sm text-gray-600 mb-4">Generating comprehensive AI summary...</div>`;
  
  // Applications summary
  let applicationSummary = "";
  if (fdaData.categorized && Object.keys(fdaData.categorized).length > 0) {
    // Count applications and forms
    let allProducts = [];
    let manufacturers = new Set();
    let dosageForms = new Set();
    
    Object.entries(fdaData.categorized).forEach(([brandName, strengths]) => {
      Object.entries(strengths).forEach(([strength, products]) => {
        products.forEach(product => {
          allProducts.push({...product, strength});
          if (product.manufacturerName) manufacturers.add(product.manufacturerName);
          if (product.sponsorName) manufacturers.add(product.sponsorName);
          if (product.dosageForm) dosageForms.add(product.dosageForm);
        });
      });
    });
    
    applicationSummary = `
      <div class="p-4 bg-white rounded-lg shadow-sm mb-4 hover-card">
        <h3 class="text-lg font-medium text-gray-800 mb-2">Applications</h3>
        <p class="text-gray-700">
          ${allProducts.length} total application${allProducts.length !== 1 ? 's' : ''} found.
          ${manufacturers.size > 0 ? `Made by ${manufacturers.size} different manufacturer${manufacturers.size > 1 ? 's' : ''}.` : ''}
          ${dosageForms.size > 0 ? `Available in ${dosageForms.size} dosage form${dosageForms.size > 1 ? 's' : ''}.` : ''}
        </p>
      </div>
    `;
  }
  
  // Label summary
  let labelSummary = "";
  const labelData = endpointsData.label?.data || [];
  if (labelData.length > 0) {
    // Extract key information from labels
    const hasBoxedWarning = labelData.some(label => label.boxed_warning && label.boxed_warning.length > 0);
    
    labelSummary = `
      <div class="p-4 bg-white rounded-lg shadow-sm mb-4 hover-card">
        <h3 class="text-lg font-medium text-gray-800 mb-2">Labeling</h3>
        <p class="text-gray-700">
          ${labelData.length} drug label${labelData.length > 1 ? 's' : ''} found.
          ${hasBoxedWarning ? '<span class="text-red-600 font-medium">Contains boxed warnings.</span>' : ''}
        </p>
      </div>
    `;
  }
  
  // Orange Book summary
  let orangeBookSummary = "";
  if (orangeBookData && orangeBookData.results) {
    const orangeBookCount = document.getElementById('orangeBookCount')?.textContent || '0 entries';
    
    orangeBookSummary = `
      <div class="p-4 bg-white rounded-lg shadow-sm mb-4 hover-card">
        <h3 class="text-lg font-medium text-gray-800 mb-2">Orange Book</h3>
        <p class="text-gray-700">
          ${orangeBookCount}
        </p>
      </div>
    `;
  }
  
  // DailyMed summary
  let dailyMedSummary = "";
  if (dailyMedData && dailyMedData.label_info) {
    const dailyMedCount = document.getElementById('dailyMedCount')?.textContent || '0 entries';
    
    dailyMedSummary = `
      <div class="p-4 bg-white rounded-lg shadow-sm mb-4 hover-card">
        <h3 class="text-lg font-medium text-gray-800 mb-2">DailyMed</h3>
        <p class="text-gray-700">
          ${dailyMedCount}
        </p>
      </div>
    `;
  }
  
  // Warning Letters summary
  let warningLettersSummary = "";
  if (warningLettersData && warningLettersData.length > 0) {
    const warningLettersCount = document.getElementById('warningLettersCount')?.textContent || '0 letters';
    
    warningLettersSummary = `
      <div class="p-4 bg-white rounded-lg shadow-sm mb-4 hover-card">
        <h3 class="text-lg font-medium text-red-800 mb-2">Warning Letters</h3>
        <p class="text-gray-700">
          ${warningLettersCount}
        </p>
      </div>
    `;
  }
  
  // Combine all summaries
  summary += `
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      ${applicationSummary}
      ${labelSummary}
      ${orangeBookSummary}
      ${dailyMedSummary}
      ${warningLettersSummary}
    </div>
    
  `;
  
  return summary;
}

// Function to prepare data for the OpenAI API
function prepareDataForOpenAI(allData) {
  const { fdaData, orangeBookData, dailyMedData, warningLettersData, drugName } = allData;
  
  let prompt = `Generate a comprehensive, well-structured summary of all the FDA regulatory information for the drug "${drugName}". Include critical insights and highlight important safety information. Here's the available data:\n\n`;
  
  // FDA Application Data
  prompt += "FDA APPLICATIONS DATA:\n";
  if (fdaData && fdaData.categorized && Object.keys(fdaData.categorized).length > 0) {
    let allProducts = [];
    let manufacturers = new Set();
    let dosageForms = new Set();
    
    Object.entries(fdaData.categorized).forEach(([brandName, strengths]) => {
      Object.entries(strengths).forEach(([strength, products]) => {
        products.forEach(product => {
          allProducts.push({...product, strength});
          if (product.manufacturerName) manufacturers.add(product.manufacturerName);
          if (product.sponsorName) manufacturers.add(product.sponsorName);
          if (product.dosageForm) dosageForms.add(product.dosageForm);
        });
      });
    });
    
    prompt += `- Found ${allProducts.length} total applications\n`;
    prompt += `- Manufacturers: ${Array.from(manufacturers).join(', ') || 'Unknown'}\n`;
    prompt += `- Dosage Forms: ${Array.from(dosageForms).join(', ') || 'Unknown'}\n`;
    
    // Include a few sample applications
    if (allProducts.length > 0) {
      prompt += "Sample applications:\n";
      allProducts.slice(0, 3).forEach(product => {
        prompt += `  * ${product.brandName}, ${product.strength}, ${product.dosageForm}, Approval: ${product.approvalDate}\n`;
      });
    }
  } else {
    prompt += "No application data available.\n";
  }
  
  // FDA Label Data
  prompt += "\nFDA LABELING DATA:\n";
  const labelData = fdaData?.raw?.endpoints?.label?.data || [];
  if (labelData.length > 0) {
    const hasBoxedWarning = labelData.some(label => label.boxed_warning && label.boxed_warning.length > 0);
    
    prompt += `- Found ${labelData.length} drug labels\n`;
    prompt += `- Contains boxed warnings: ${hasBoxedWarning ? 'Yes' : 'No'}\n`;
    
    // Extract important label information
    if (labelData.length > 0) {
      const firstLabel = labelData[0];
      
      if (firstLabel.indications_and_usage && firstLabel.indications_and_usage.length > 0) {
        prompt += `- Indications: ${firstLabel.indications_and_usage[0].substring(0, 300)}...\n`;
      }
      
      if (hasBoxedWarning && firstLabel.boxed_warning && firstLabel.boxed_warning.length > 0) {
        prompt += `- Boxed Warning: ${firstLabel.boxed_warning[0].substring(0, 300)}...\n`;
      }
      
      if (firstLabel.warnings && firstLabel.warnings.length > 0) {
        prompt += `- Warnings: ${firstLabel.warnings[0].substring(0, 300)}...\n`;
      }
      
      if (firstLabel.adverse_reactions && firstLabel.adverse_reactions.length > 0) {
        prompt += `- Adverse Reactions: ${firstLabel.adverse_reactions[0].substring(0, 300)}...\n`;
      }
    }
  } else {
    prompt += "No labeling data available.\n";
  }
  
  // FDA Adverse Events
  prompt += "\nFDA ADVERSE EVENTS DATA:\n";
  const eventData = fdaData?.raw?.endpoints?.event?.data || [];
  if (eventData.length > 0) {
    // Count serious vs non-serious
    const seriousCount = eventData.filter(event => event.serious).length;
    const nonSeriousCount = eventData.length - seriousCount;
    
    prompt += `- Found ${eventData.length} adverse event reports\n`;
    prompt += `- Serious reports: ${seriousCount}, Non-serious reports: ${nonSeriousCount}\n`;
    
    // Count reaction types
    const reactionCounts = {};
    eventData.forEach(event => {
      const reactions = event.patient?.reaction || [];
      reactions.forEach(reaction => {
        const reactionName = reaction.reactionmeddrapt || 'Unknown';
        reactionCounts[reactionName] = (reactionCounts[reactionName] || 0) + 1;
      });
    });
    
    // Get top 5 reactions
    const topReactions = Object.entries(reactionCounts)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 5);
    
    if (topReactions.length > 0) {
      prompt += "- Top reported reactions:\n";
      topReactions.forEach(([name, count]) => {
        prompt += `  * ${name}: ${count} reports\n`;
      });
    }
  } else {
    prompt += "No adverse event data available.\n";
  }
  
  // FDA Enforcement
  prompt += "\nFDA ENFORCEMENT DATA:\n";
  const enforcementData = fdaData?.raw?.endpoints?.enforcement?.data || [];
  if (enforcementData.length > 0) {
    // Count by classification
    const classI = enforcementData.filter(report => report.classification && report.classification.includes('Class I')).length;
    const classII = enforcementData.filter(report => report.classification && report.classification.includes('Class II')).length;
    const classIII = enforcementData.filter(report => report.classification && report.classification.includes('Class III')).length;
    
    prompt += `- Found ${enforcementData.length} enforcement actions/recalls\n`;
    prompt += `- Class I (most severe): ${classI}, Class II: ${classII}, Class III: ${classIII}\n`;
    
    // Include a few recent enforcement actions
    if (enforcementData.length > 0) {
      prompt += "Recent recall reasons:\n";
      enforcementData.slice(0, 3).forEach(report => {
        prompt += `  * ${report.product_description || 'Unknown product'}: ${report.reason_for_recall || 'Unknown reason'}\n`;
      });
    }
  } else {
    prompt += "No enforcement data available.\n";
  }
  
  // Orange Book Data
  prompt += "\nORANGE BOOK DATA:\n";
  if (orangeBookData && orangeBookData.results) {
    const results = orangeBookData.results;
    
    prompt += `- Total entries: ${results.total || 0}\n`;
    prompt += `- Patents: ${results.patents || 0}\n`;
    prompt += `- Exclusivities: ${results.exclusivities || 0}\n`;
    
    if (results.products && results.products.length > 0) {
      prompt += "Sample products:\n";
      results.products.slice(0, 3).forEach(product => {
        prompt += `  * ${product.brandName || 'Unknown'}, ${product.dosageForm || 'Unknown form'}, ${product.route || 'Unknown route'}\n`;
      });
    }
  } else {
    prompt += "No Orange Book data available.\n";
  }
  
  // DailyMed Data
  prompt += "\nDAILYMED DATA:\n";
  if (dailyMedData && dailyMedData.label_info && dailyMedData.label_info.length > 0) {
    const labelInfo = dailyMedData.label_info;
    
    prompt += `- Total labels: ${labelInfo.length}\n`;
    
    // Count unique manufacturers
    const manufacturers = new Set(labelInfo.map(label => label.manufacturer).filter(m => m));
    prompt += `- Manufacturers: ${manufacturers.size}\n`;
    
    if (labelInfo.length > 0) {
      prompt += "Sample labels:\n";
      labelInfo.slice(0, 3).forEach(label => {
        prompt += `  * ${label.title || 'Unknown'}, Manufacturer: ${label.manufacturer || 'Unknown'}\n`;
        if (label.indications) {
          prompt += `    Indications: ${typeof label.indications === 'string' ? label.indications.substring(0, 200) : 'Not available'}...\n`;
        }
      });
    }
  } else {
    prompt += "No DailyMed data available.\n";
  }
  
  // Warning Letters
  prompt += "\nWARNING LETTERS DATA:\n";
  if (warningLettersData && warningLettersData.length > 0) {
    prompt += `- Total warning letters: ${warningLettersData.length}\n`;
    
    if (warningLettersData.length > 0) {
      prompt += "Sample warning letters:\n";
      warningLettersData.slice(0, 3).forEach(letter => {
        prompt += `  * Date: ${letter.posted_date || 'Unknown'}, Company: ${letter.company_name || 'Unknown'}\n`;
        prompt += `    Subject: ${letter.subject || 'Unknown'}\n`;
      });
    }
  } else {
    prompt += "No warning letters data available.\n";
  }
  
  prompt += "\nINSTRUCTIONS FOR SUMMARY GENERATION:\n";
  prompt += "1. Start with a brief overall assessment of the drug's regulatory status.\n";
  prompt += "2. Highlight any critical safety information, especially boxed warnings, serious adverse events, or Class I recalls.\n";
  prompt += "3. Organize the summary into clear sections by data category.\n";
  prompt += "4. Use bullet points where appropriate for readability.\n";
  prompt += "5. Mention if there are any notable patterns across the different data sources.\n";
  prompt += "6. End with a brief conclusion summarizing the key regulatory insights.\n";
  prompt += "7. The summary should be comprehensive but concise, using HTML formatting with proper CSS classes for styling.\n";
  prompt += "8. Use the following HTML structure with Tailwind CSS classes for your response:\n\n";
  prompt += `
<div class="text-xl font-semibold mb-4">Regulatory Summary for ${drugName}</div>
<div class="text-sm text-gray-600 mb-4">[Your brief intro summary]</div>

<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
  <!-- Application data card -->
  <div class="p-4 bg-white rounded-lg shadow-sm mb-4 hover-card">
    <h3 class="text-lg font-medium text-gray-800 mb-2">Applications</h3>
    <p class="text-gray-700">[Your summary]</p>
    <ul class="list-disc ml-6 mt-1 text-sm text-gray-600">
      <li>[Key point 1]</li>
      <!-- more list items as needed -->
    </ul>
  </div>
  
  <!-- More sections cards with similar structure -->
  
</div>

<div class="p-4 bg-blue-50 border border-blue-200 rounded-lg mb-4">
  <h3 class="text-lg font-medium text-blue-800 mb-2">Key Insights</h3>
  <p class="text-gray-700">[Your key insights]</p>
</div>

<div class="text-xs text-gray-500 mt-3 pt-2 border-t border-gray-300">
  <p>Summary based on FDA data as of [current date]. Generated with AI assistance.</p>
</div>`;

  return prompt;
}

// Function to call OpenAI API for enhanced summary
async function generateOpenAISummary(allData) {
  const prompt = prepareDataForOpenAI(allData);
  
  try {
    // Prepare the request to your backend API
    const response = await fetch('/api/generate-summary', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        prompt: prompt,
        maxTokens: 1500,
        temperature: 0.7,
        drugName: allData.drugName
      })
    });
    
    if (!response.ok) {
      throw new Error('Failed to generate AI summary');
    }
    
    const data = await response.json();
    return data.summary;
  } catch (error) {
    console.error('Error generating OpenAI summary:', error);
    // Fall back to local summary if API call fails
    return `
      <div class="p-4 bg-red-50 border border-red-200 rounded-lg mb-4">
        <h3 class="text-lg font-medium text-red-800 mb-2">AI Summary Generation Failed</h3>
        <p class="text-gray-700">We couldn't generate an AI-enhanced summary at this time. Please try again later.</p>
      </div>
      
      ${generateLocalSummary(allData)}
    `;
  }
}

// Function to show FDA summary (either from local processing or OpenAI)
async function showFdaSummary(useOpenAI = true) {
  // Get the current drug name
  const drugName = window.currentDrugName || document.querySelector('input[name="drug"]')?.value || 
                   document.querySelector('input[name="search"]')?.value || "this drug";
  
  // Collect all FDA data
  const allData = collectAllFdaData(drugName);
  
  if (!allData.fdaData) {
    // If no data is available, show message to search first
    showWarningLetterModal(`
      <div class="text-center p-6">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <h3 class="text-lg font-medium text-gray-900 mb-2">No FDA Data Available</h3>
        <p class="text-gray-600 mb-4">Please search for a drug first to generate a summary.</p>
        <button onclick="closeWarningLetterModal()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors">
          Close
        </button>
      </div>
    `, "FDA Data Summary");
    return;
  }
  
  // First, show the modal with a locally generated summary and loading indicator
  const localSummary = generateLocalSummary(allData);
  
  showWarningLetterModal(`
    <div id="summary-content">
      ${localSummary}
    </div>
    
    <div class="flex justify-between mt-4 pt-4 border-t border-gray-200">
      <button id="email-summary-btn" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition-colors flex items-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
          <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" />
          <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" />
        </svg>
        Email Me This Summary
      </button>
      <button onclick="closeWarningLetterModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 transition-colors">
        Close
      </button>
    </div>
  `, "FDA Data Summary for " + drugName);
  
  // Add email functionality
  document.getElementById('email-summary-btn').addEventListener('click', function() {
    emailSummary(drugName);
  });
  
  // If OpenAI integration is enabled, fetch the enhanced summary
  if (useOpenAI) {
    try {
      const aiSummary = await generateOpenAISummary(allData);
      
      // Replace the local summary with the AI-generated one
      document.getElementById('summary-content').innerHTML = aiSummary;
      
      // Update the email button to use the new content
      document.getElementById('email-summary-btn').onclick = function() {
        emailSummary(drugName, aiSummary);
      };
    } catch (error) {
      console.error('Error getting OpenAI summary:', error);
      // The local summary will remain in place if the AI one fails
    }
  }
}

// // Function to email the summary
// function emailSummary(drugName, content = null) {
//   // If no content is provided, get it from the current summary
//   if (!content) {
//     content = document.getElementById('summary-content').innerHTML;
//   }
  
//   // Show email form
//   showWarningLetterModal(`
//     <div class="p-4">
//       <h3 class="text-lg font-medium text-gray-900 mb-4">Email FDA Summary for ${drugName}</h3>
      
//       <form id="email-form" class="space-y-4">
//         <div>
//           <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Your Email Address</label>
//           <input type="email" id="email" name="email" required
//                  class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" 
//                  placeholder="your@email.com">
//         </div>
        
//         <div>
//           <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Your Name (optional)</label>
//           <input type="text" id="name" name="name"
//                  class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" 
//                  placeholder="Your Name">
//         </div>
        
//         <div class="pt-4">
//           <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors">
//             Send Summary Email
//           </button>
//         </div>
//       </form>
      
//       <div id="email-status" class="mt-4 text-center hidden">
//         <div class="inline-block animate-spin rounded-full h-5 w-5 border-b-2 border-blue-600"></div>
//         <p class="text-sm text-gray-600 mt-2">Sending email...</p>
//       </div>
//     </div>
//   `, "Email FDA Summary");
  
//   // Handle form submission
//   document.getElementById('email-form').addEventListener('submit', async function(e) {
//     e.preventDefault();
    
//     const email = document.getElementById('email').value;
//     const name = document.getElementById('name').value;
    
//     // Show loading indicator
//     document.getElementById('email-form').classList.add('hidden');
//     document.getElementById('email-status').classList.remove('hidden');
    
//     try {
//       // Call your backend API to send the email
//       const response = await fetch('/api/email-summary', {
//         method: 'POST',
//         headers: {
//           'Content-Type': 'application/json',
//         },
//         body: JSON.stringify({
//           email: email,
//           name: name,
//           subject: `FDA Summary for ${drugName}`,
//           content: content,
//           drugName: drugName
//         })
//       });
      
//       if (!response.ok) {
//         throw new Error('Failed to send email');
//       }
      
//       // Show success message
//       document.getElementById('email-status').innerHTML = `
//         <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-green-500 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
//         </svg>
//         <h4 class="text-lg font-medium text-gray-900 mb-2">Email Sent Successfully</h4>
//         <p class="text-gray-600 mb-4">The FDA summary has been sent to ${email}</p>
//         <button onclick="closeWarningLetterModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 transition-colors">
//           Close
//         </button>
//       `;
//     } catch (error) {
//       console.error('Error sending email:', error);
      
//       // Show error message
//       document.getElementById('email-status').innerHTML = `
//         <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-red-500 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
//         </svg>
//         <h4 class="text-lg font-medium text-gray-900 mb-2">Failed to Send Email</h4>
//         <p class="text-gray-600 mb-4">There was an error sending the email. Please try again later.</p>
//         <button onclick="document.getElementById('email-form').classList.remove('hidden'); document.getElementById('email-status').classList.add('hidden');" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors">
//           Try Again
//         </button>
//       `;
//     }
//   });
// }


// // Helper function to refresh the summary when new data is available
// function refreshSummary() {
//   if (window.fdaData && window.currentDrugName) {
//     const summaryContainer = document.getElementById('fda-summary-container');
//     if (summaryContainer) {
//       // Collect all FDA data
//       const allData = collectAllFdaData(window.currentDrugName);
      
//       // Update with local summary while waiting for OpenAI
//       summaryContainer.innerHTML = generateLocalSummary(allData);
//       summaryContainer.classList.remove('hidden');
//     }
//   }
// }



// Helper function to refresh the summary when new data is available
function refreshSummary() {
  if (window.fdaData && window.currentDrugName) {
    const summaryContainer = document.getElementById('fda-summary-container');
    if (summaryContainer) {
      // Collect all FDA data
      const allData = collectAllFdaData(window.currentDrugName);
      
      // Update with local summary while waiting for Grok AI
      if (!summaryContainer.innerHTML.includes('Powered by AI')) {
        summaryContainer.innerHTML = generateLocalSummary(allData);
        summaryContainer.classList.remove('hidden');
      }
    }
  }
}

// Modified email summary function for Grok-specific formatting
function emailSummary(drugName, content = null) {
  // If no content is provided, get it from the current summary
  if (!content) {
    content = document.getElementById('summary-content').innerHTML;
  }
  

  
  // Show email form
  showWarningLetterModal(`
    <div class="p-4">
      <h3 class="text-lg font-medium text-gray-900 mb-4">Email FDA Summary for ${drugName}</h3>
      
      <form id="email-form" class="space-y-4">
        <div>
          <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Your Email Address</label>
          <input type="email" id="email" name="email" required
                 class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" 
                 placeholder="your@email.com">
        </div>
        
        <div>
          <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Your Name (optional)</label>
          <input type="text" id="name" name="name"
                 class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" 
                 placeholder="Your Name">
        </div>
        
        <div class="pt-4">
          <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
              <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" />
              <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" />
            </svg>
            Send Summary Email
          </button>
        </div>
      </form>
      
      <div id="email-status" class="mt-4 text-center hidden">
        <div class="inline-block animate-spin rounded-full h-5 w-5 border-b-2 border-blue-600"></div>
        <p class="text-sm text-gray-600 mt-2">Sending email...</p>
      </div>
    </div>
  `, "Email FDA Summary");
  
  // Handle form submission
  document.getElementById('email-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const email = document.getElementById('email').value;
    const name = document.getElementById('name').value;
    
    // Show loading indicator
    document.getElementById('email-form').classList.add('hidden');
    document.getElementById('email-status').classList.remove('hidden');
    
    try {
      // Call your backend API to send the email
      const response = await fetch('/api/email-summary', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          email: email,
          name: name,
          subject: `FDA Summary for ${drugName} (Powered by AI)`,
          content: content,
          drugName: drugName
        })
      });
      
      if (!response.ok) {
        throw new Error('Failed to send email');
      }
      
      // Show success message
      document.getElementById('email-status').innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-green-500 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <h4 class="text-lg font-medium text-gray-900 mb-2">Email Sent Successfully</h4>
        <p class="text-gray-600 mb-4">The FDA summary has been sent to ${email}</p>
        <button onclick="closeWarningLetterModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 transition-colors">
          Close
        </button>
      `;
    } catch (error) {
      console.error('Error sending email:', error);
      
      // Show error message
      document.getElementById('email-status').innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-red-500 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
        </svg>
        <h4 class="text-lg font-medium text-gray-900 mb-2">Failed to Send Email</h4>
        <p class="text-gray-600 mb-4">There was an error sending the email. Please try again later.</p>
        <button onclick="document.getElementById('email-form').classList.remove('hidden'); document.getElementById('email-status').classList.add('hidden');" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors">
          Try Again
        </button>
      `;
    }
  });
}




// // Function to prepare data for the Grok API
// function prepareDataForGrokAPI(allData) {
//   const { fdaData, orangeBookData, dailyMedData, warningLettersData, drugName } = allData;
  
//   console.log(allData)
//   // Trigger JSON download
//   const jsonString = JSON.stringify(allData, null, 2); // Pretty-print JSON with indentation
//   const blob = new Blob([jsonString], { type: 'application/json' });
//   const url = URL.createObjectURL(blob);
//   const a = document.createElement('a');
//   a.href = url;
//   a.download = `${drugName}_regulatory_data.json`; // File name for download
//   document.body.appendChild(a);
//   a.click();
//   document.body.removeChild(a);
//   URL.revokeObjectURL(url); // Clean up the URL object
//   return

//   let prompt = `Generate a comprehensive, well-structured summary of all the FDA regulatory information for the drug "${drugName}". Include critical insights and highlight important safety information. Here's the available data:\n\n`;
  
//   // FDA Application Data
//   prompt += "FDA APPLICATIONS DATA:\n";
//   if (fdaData && fdaData.categorized && Object.keys(fdaData.categorized).length > 0) {
//     let allProducts = [];
//     let manufacturers = new Set();
//     let dosageForms = new Set();
    
//     Object.entries(fdaData.categorized).forEach(([brandName, strengths]) => {
//       Object.entries(strengths).forEach(([strength, products]) => {
//         products.forEach(product => {
//           allProducts.push({...product, strength});
//           if (product.manufacturerName) manufacturers.add(product.manufacturerName);
//           if (product.sponsorName) manufacturers.add(product.sponsorName);
//           if (product.dosageForm) dosageForms.add(product.dosageForm);
//         });
//       });
//     });
    
//     prompt += `- Found ${allProducts.length} total applications\n`;
//     prompt += `- Manufacturers: ${Array.from(manufacturers).join(', ') || 'Unknown'}\n`;
//     prompt += `- Dosage Forms: ${Array.from(dosageForms).join(', ') || 'Unknown'}\n`;
    
//     // Include a few sample applications
//     if (allProducts.length > 0) {
//       prompt += "Sample applications:\n";
//       allProducts.slice(0, 3).forEach(product => {
//         prompt += `  * ${product.brandName}, ${product.strength}, ${product.dosageForm}, Approval: ${product.approvalDate}\n`;
//       });
//     }
//   } else {
//     prompt += "No application data available.\n";
//   }
  
//   // FDA Label Data
//   prompt += "\nFDA LABELING DATA:\n";
//   const labelData = fdaData?.raw?.endpoints?.label?.data || [];
//   if (labelData.length > 0) {
//     const hasBoxedWarning = labelData.some(label => label.boxed_warning && label.boxed_warning.length > 0);
    
//     prompt += `- Found ${labelData.length} drug labels\n`;
//     prompt += `- Contains boxed warnings: ${hasBoxedWarning ? 'Yes' : 'No'}\n`;
    
//     // Extract important label information
//     if (labelData.length > 0) {
//       const firstLabel = labelData[0];
      
//       if (firstLabel.indications_and_usage && firstLabel.indications_and_usage.length > 0) {
//         prompt += `- Indications: ${firstLabel.indications_and_usage[0].substring(0, 300)}...\n`;
//       }
      
//       if (hasBoxedWarning && firstLabel.boxed_warning && firstLabel.boxed_warning.length > 0) {
//         prompt += `- Boxed Warning: ${firstLabel.boxed_warning[0].substring(0, 300)}...\n`;
//       }
      
//       if (firstLabel.warnings && firstLabel.warnings.length > 0) {
//         prompt += `- Warnings: ${firstLabel.warnings[0].substring(0, 300)}...\n`;
//       }
      
//       if (firstLabel.adverse_reactions && firstLabel.adverse_reactions.length > 0) {
//         prompt += `- Adverse Reactions: ${firstLabel.adverse_reactions[0].substring(0, 300)}...\n`;
//       }
//     }
//   } else {
//     prompt += "No labeling data available.\n";
//   }
  
//   // FDA Adverse Events
//   prompt += "\nFDA ADVERSE EVENTS DATA:\n";
//   const eventData = fdaData?.raw?.endpoints?.event?.data || [];
//   if (eventData.length > 0) {
//     // Count serious vs non-serious
//     const seriousCount = eventData.filter(event => event.serious).length;
//     const nonSeriousCount = eventData.length - seriousCount;
    
//     prompt += `- Found ${eventData.length} adverse event reports\n`;
//     prompt += `- Serious reports: ${seriousCount}, Non-serious reports: ${nonSeriousCount}\n`;
    
//     // Count reaction types
//     const reactionCounts = {};
//     eventData.forEach(event => {
//       const reactions = event.patient?.reaction || [];
//       reactions.forEach(reaction => {
//         const reactionName = reaction.reactionmeddrapt || 'Unknown';
//         reactionCounts[reactionName] = (reactionCounts[reactionName] || 0) + 1;
//       });
//     });
    
//     // Get top 5 reactions
//     const topReactions = Object.entries(reactionCounts)
//       .sort((a, b) => b[1] - a[1])
//       .slice(0, 5);
    
//     if (topReactions.length > 0) {
//       prompt += "- Top reported reactions:\n";
//       topReactions.forEach(([name, count]) => {
//         prompt += `  * ${name}: ${count} reports\n`;
//       });
//     }
//   } else {
//     prompt += "No adverse event data available.\n";
//   }
  
//   // FDA Enforcement
//   prompt += "\nFDA ENFORCEMENT DATA:\n";
//   const enforcementData = fdaData?.raw?.endpoints?.enforcement?.data || [];
//   if (enforcementData.length > 0) {
//     // Count by classification
//     const classI = enforcementData.filter(report => report.classification && report.classification.includes('Class I')).length;
//     const classII = enforcementData.filter(report => report.classification && report.classification.includes('Class II')).length;
//     const classIII = enforcementData.filter(report => report.classification && report.classification.includes('Class III')).length;
    
//     prompt += `- Found ${enforcementData.length} enforcement actions/recalls\n`;
//     prompt += `- Class I (most severe): ${classI}, Class II: ${classII}, Class III: ${classIII}\n`;
    
//     // Include a few recent enforcement actions
//     if (enforcementData.length > 0) {
//       prompt += "Recent recall reasons:\n";
//       enforcementData.slice(0, 3).forEach(report => {
//         prompt += `  * ${report.product_description || 'Unknown product'}: ${report.reason_for_recall || 'Unknown reason'}\n`;
//       });
//     }
//   } else {
//     prompt += "No enforcement data available.\n";
//   }
  
//   // Orange Book Data
//   prompt += "\nORANGE BOOK DATA:\n";
//   if (orangeBookData) {
//     const results = orangeBookData;
    
//     prompt += `- Total entries: ${results.total || 0}\n`;
//     prompt += `- Patents: ${results.patents || 0}\n`;
//     prompt += `- Exclusivities: ${results.exclusivities || 0}\n`;
    
//     if (results.products && results.products.length > 0) {
//       prompt += "Sample products:\n";
//       results.products.slice(0, 3).forEach(product => {
//         prompt += `  * ${product.brandName || 'Unknown'}, ${product.dosageForm || 'Unknown form'}, ${product.route || 'Unknown route'}\n`;
//       });
//     }
//   } else {
//     prompt += "No Orange Book data available.\n";
//   }
  
//   // DailyMed Data
//   prompt += "\nDAILYMED DATA:\n";
//   if (dailyMedData && dailyMedData.label_info && dailyMedData.label_info.length > 0) {
//     const labelInfo = dailyMedData.label_info;
    
//     prompt += `- Total labels: ${labelInfo.length}\n`;
    
//     // Count unique manufacturers
//     const manufacturers = new Set(labelInfo.map(label => label.manufacturer).filter(m => m));
//     prompt += `- Manufacturers: ${manufacturers.size}\n`;
    
//     if (labelInfo.length > 0) {
//       prompt += "Sample labels:\n";
//       labelInfo.slice(0, 3).forEach(label => {
//         prompt += `  * ${label.title || 'Unknown'}, Manufacturer: ${label.manufacturer || 'Unknown'}\n`;
//         if (label.indications) {
//           prompt += `    Indications: ${typeof label.indications === 'string' ? label.indications.substring(0, 200) : 'Not available'}...\n`;
//         }
//       });
//     }
//   } else {
//     prompt += "No DailyMed data available.\n";
//   }
  
//   // Warning Letters
//   prompt += "\nWARNING LETTERS DATA:\n";
//   if (warningLettersData && warningLettersData.length > 0) {
//     prompt += `- Total warning letters: ${warningLettersData.length}\n`;
    
//     if (warningLettersData.length > 0) {
//       prompt += "Sample warning letters:\n";
//       warningLettersData.slice(0, 3).forEach(letter => {
//         prompt += `  * Date: ${letter.posted_date || 'Unknown'}, Company: ${letter.company_name || 'Unknown'}\n`;
//         prompt += `    Subject: ${letter.subject || 'Unknown'}\n`;
//       });
//     }
//   } else {
//     prompt += "No warning letters data available.\n";
//   }
  
//   prompt += "\nINSTRUCTIONS FOR SUMMARY GENERATION:\n";
//   prompt += "1. Start with a brief overall assessment of the drug's regulatory status.\n";
//   prompt += "2. Highlight any critical safety information, especially boxed warnings, serious adverse events, or Class I recalls.\n";
//   prompt += "3. Organize the summary into clear sections by data category.\n";
//   prompt += "4. Use bullet points where appropriate for readability.\n";
//   prompt += "5. Mention if there are any notable patterns across the different data sources.\n";
//   prompt += "6. End with a brief conclusion summarizing the key regulatory insights.\n";
//   prompt += "7. The summary should be comprehensive but concise, using HTML formatting with proper CSS classes for styling.\n";
//   prompt += "8. Use the following HTML structure with Tailwind CSS classes for your response:\n\n";
//   prompt += `
// <div class="text-xl font-semibold mb-4">Regulatory Summary for ${drugName}</div>
// <div class="text-sm text-gray-600 mb-4">[Your brief intro summary]</div>

// <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
//   <!-- Application data card -->
//   <div class="p-4 bg-white rounded-lg shadow-sm mb-4 hover-card">
//     <h3 class="text-lg font-medium text-gray-800 mb-2">Applications</h3>
//     <p class="text-gray-700">[Your summary]</p>
//     <ul class="list-disc ml-6 mt-1 text-sm text-gray-600">
//       <li>[Key point 1]</li>
//       <!-- more list items as needed -->
//     </ul>
//   </div>
  
//   <!-- More sections cards with similar structure -->
  
// </div>

// <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg mb-4">
//   <h3 class="text-lg font-medium text-blue-800 mb-2">Key Insights</h3>
//   <p class="text-gray-700">[Your key insights]</p>
// </div>

// <div class="text-xs text-gray-500 mt-3 pt-2 border-t border-gray-300">
//   <p>Summary based on FDA data as of [current date]. Generated with AI assistance.</p>
// </div>`;

//   return prompt;
// }



function prepareDataForGrokAPI(allData) {
  const { fdaData, orangeBookData, dailyMedData, warningLetters, drugName } = allData;
  
  // Instead of building a large data structure and stringifying it,
  // build the prompt directly with the most critical information
  let prompt = `Generate a comprehensive analysis of ${drugName} for pharmaceutical development. Focus on regulatory issues, development risks, and market opportunities. Here's the essential data:\n\n`;
  
  // 1. CORE DRUG INFO - Minimal but essential
  prompt += "DRUG: " + drugName + "\n\n";
  
  // 2. MOST CRITICAL SAFETY INFORMATION - Always include
  prompt += "CRITICAL SAFETY INFORMATION:\n";
  const safetyInfo = extractCriticalSafetyInfo(fdaData, dailyMedData);
  if (safetyInfo.boxedWarnings.length > 0) {
    prompt += "- Boxed Warnings: " + safetyInfo.boxedWarnings.join(" | ") + "\n";
  }
  if (safetyInfo.contraindications.length > 0) {
    prompt += "- Contraindications: " + safetyInfo.contraindications.join(" | ") + "\n";
  }
  if (safetyInfo.seriousAdverseEvents.length > 0) {
    prompt += "- Serious Adverse Events: " + safetyInfo.seriousAdverseEvents.join(" | ") + "\n";
  }
  
  // 3. REGULATORY ISSUES - High value for development
  prompt += "\nREGULATORY ISSUES:\n";
  const regulatoryIssues = extractRegulatoryIssues(fdaData, warningLetters);
  if (regulatoryIssues.length > 0) {
    regulatoryIssues.forEach(issue => {
      prompt += `- ${issue.type}: ${issue.reason || issue.subject || "N/A"} (${issue.classification || "N/A"})\n`;
    });
  } else {
    prompt += "- No significant regulatory issues found\n";
  }
  
  // 4. PATENTS & EXCLUSIVITY - Essential for market entry
  prompt += "\nPATENT LANDSCAPE:\n";
  const patentInfo = extractPatentInfo(orangeBookData);
  if (patentInfo.patents.length > 0) {
    prompt += `- Patents: ${patentInfo.patents.length} found\n`;
    patentInfo.patents.slice(0, 3).forEach(patent => {
      prompt += `  * Patent ${patent.patentNumber}: Expires ${patent.expirationDate}\n`;
    });
  } else {
    prompt += "- No patents found\n";
  }
  
  // 5. PRODUCT FORMULATIONS - Critical for development
  prompt += "\nPRODUCT FORMULATIONS:\n";
  const formulations = extractFormulations(fdaData, orangeBookData);
  if (formulations.length > 0) {
    formulations.forEach(form => {
      prompt += `- ${form.dosageForm || "Unknown"}: ${form.strength || "Unknown strength"}\n`;
    });
  } else {
    prompt += "- Formulation details not found\n";
  }
  
  // 6. MANUFACTURING CONSIDERATIONS - Important for development
  prompt += "\nMANUFACTURING CONSIDERATIONS:\n";
  const manufacturingIssues = extractManufacturingIssues(fdaData);
  if (manufacturingIssues.length > 0) {
    manufacturingIssues.forEach(issue => {
      prompt += `- ${issue.reason || "Manufacturing issue"}\n`;
    });
  } else {
    // Extract preparation details as fallback
    const preparationDetails = extractPreparationDetails(dailyMedData);
    if (preparationDetails.length > 0) {
      preparationDetails.forEach(detail => {
        prompt += `- ${detail}\n`;
      });
    } else {
      prompt += "- No specific manufacturing issues identified\n";
    }
  }
  
  // 7. INSTRUCTIONS - Keep the same comprehensive instructions
  prompt += "\nINSTRUCTIONS FOR PHARMACEUTICAL DEVELOPMENT ANALYSIS:\n";
  prompt += "1. Identify ALL regulatory challenges, warnings, and safety issues that would impact development\n";
  prompt += "2. Analyze patent landscape to identify potential entry opportunities\n";
  prompt += "3. Detail formulation approaches and manufacturing considerations\n";
  prompt += "4. Highlight potential competitive advantages and market positioning\n";
  prompt += "5. Identify possible regulatory pathways and their requirements\n";
  prompt += "6. Outline ALL safety concerns and their implications for clinical development\n";
  prompt += "7. Use technical language appropriate for pharmaceutical R&D and regulatory affairs professionals\n";
  prompt += "8. Format with HTML and Tailwind CSS for readability\n";
  

  console.log('prompt is : ', prompt)
  return prompt;
}

// Focused helper functions that extract only the most essential information

function extractCriticalSafetyInfo(fdaData, dailyMedData) {
  const safetyInfo = {
    boxedWarnings: [],
    contraindications: [],
    seriousAdverseEvents: []
  };
  
  // First try DailyMed data - usually more complete
  if (dailyMedData && dailyMedData.label_info) {
    for (const label of dailyMedData.label_info) {
      // Extract boxed warnings - look for specific patterns
      if (label.warnings && 
         (label.warnings.includes("WARNING") || 
          label.warnings.includes("BOXED WARNING"))) {
        // Extract just the first sentence or first 100 chars to save space
        const warningText = label.warnings.split('.')[0] || label.warnings.substring(0, 100);
        if (warningText && !safetyInfo.boxedWarnings.includes(warningText)) {
          safetyInfo.boxedWarnings.push(warningText);
        }
      }
      
      // Extract contraindications
      if (label.contraindications) {
        // Extract first part to save space
        const contraindicationText = label.contraindications.substring(0, 150);
        if (contraindicationText && !safetyInfo.contraindications.includes(contraindicationText)) {
          safetyInfo.contraindications.push(contraindicationText);
        }
      }
      
      // Extract serious adverse events
      if (label.adverseReactions && 
         (label.adverseReactions.includes("serious") || 
          label.adverseReactions.includes("Serious"))) {
        // Find the sentence containing "serious"
        const sentences = label.adverseReactions.split('. ');
        for (const sentence of sentences) {
          if (sentence.includes("serious") || sentence.includes("Serious")) {
            if (!safetyInfo.seriousAdverseEvents.includes(sentence)) {
              safetyInfo.seriousAdverseEvents.push(sentence);
              break; // Just get the first one to save space
            }
          }
        }
      }
    }
  }
  
  // If we didn't find any in DailyMed, check FDA data
  if (safetyInfo.boxedWarnings.length === 0 && fdaData && fdaData.raw && fdaData.raw.combinedResults) {
    for (const item of fdaData.raw.combinedResults) {
      if (item.warnings && 
         (item.warnings.includes("WARNING") || 
          item.warnings.includes("BOXED WARNING"))) {
        const warningText = item.warnings.split('.')[0] || item.warnings.substring(0, 100);
        if (warningText) {
          safetyInfo.boxedWarnings.push(warningText);
          break; // Just get the first one
        }
      }
      
      if (safetyInfo.seriousAdverseEvents.length === 0 && 
          item.adverseReactions && 
         (item.adverseReactions.includes("serious") || 
          item.adverseReactions.includes("Serious"))) {
        const sentences = item.adverseReactions.split('. ');
        for (const sentence of sentences) {
          if (sentence.includes("serious") || sentence.includes("Serious")) {
            safetyInfo.seriousAdverseEvents.push(sentence);
            break; // Just get the first one
          }
        }
      }
    }
  }
  
  return safetyInfo;
}

function extractRegulatoryIssues(fdaData, warningLetters) {
  const issues = [];
  
  // Extract recalls and enforcement actions
  if (fdaData && fdaData.raw && fdaData.raw.combinedResults) {
    const enforcements = fdaData.raw.combinedResults.filter(
      item => item.type === "recall" || item.source === "enforcement"
    );
    
    // Only take the most significant ones (Class I or II)
    for (const action of enforcements) {
      if (action.classification && 
         (action.classification.includes("Class I") || 
          action.classification.includes("Class II"))) {
        issues.push({
          type: "Recall/Enforcement",
          reason: action.recallReason,
          classification: action.classification
        });
      }
    }
    
    // Only include up to 3 regulatory issues to save space
    if (issues.length > 3) {
      issues.length = 3;
    }
  }
  
  // Add warning letters if we have space
  if (issues.length < 3 && warningLetters && Array.isArray(warningLetters)) {
    for (const letter of warningLetters) {
      issues.push({
        type: "Warning Letter",
        subject: letter.subject
      });
      
      if (issues.length >= 3) break;
    }
  }
  
  return issues;
}

function extractPatentInfo(orangeBookData) {
  const patentInfo = {
    patents: []
  };
  
  if (orangeBookData && orangeBookData.patents) {
    for (const patent of orangeBookData.patents) {
      patentInfo.patents.push({
        patentNumber: patent.Patent_No,
        expirationDate: patent.Patent_Expire_Date_Text
      });
    }
  }
  
  return patentInfo;
}

function extractFormulations(fdaData, orangeBookData) {
  const formulations = [];
  
  // Start with Orange Book data
  if (orangeBookData && orangeBookData.products) {
    for (const product of orangeBookData.products) {
      formulations.push({
        dosageForm: product["DF;Route"],
        strength: product.Strength
      });
    }
  }
  
  // If we didn't get any from Orange Book, check FDA data
  if (formulations.length === 0 && fdaData && fdaData.raw && fdaData.raw.combinedResults) {
    const ndcProducts = fdaData.raw.combinedResults.filter(item => item.source === "ndc");
    
    for (const product of ndcProducts) {
      if (product.dosageForm) {
        formulations.push({
          dosageForm: product.dosageForm,
          strength: product.genericName
        });
      }
    }
  }
  
  // Remove duplicates
  const uniqueFormulations = [];
  const seen = new Set();
  
  for (const form of formulations) {
    const key = `${form.dosageForm}-${form.strength}`;
    if (!seen.has(key)) {
      seen.add(key);
      uniqueFormulations.push(form);
    }
  }
  
  return uniqueFormulations;
}

function extractManufacturingIssues(fdaData) {
  const issues = [];
  
  if (fdaData && fdaData.raw && fdaData.raw.combinedResults) {
    // Look for recalls related to manufacturing
    const manufacturingRecalls = fdaData.raw.combinedResults.filter(item => 
      (item.type === "recall" || item.source === "enforcement") &&
      item.recallReason &&
      (item.recallReason.includes("Manufacturing") ||
       item.recallReason.includes("manufacturing") ||
       item.recallReason.includes("Quality") ||
       item.recallReason.includes("quality") ||
       item.recallReason.includes("Sterility") ||
       item.recallReason.includes("sterility"))
    );
    
    for (const recall of manufacturingRecalls) {
      issues.push({
        reason: recall.recallReason
      });
      
      if (issues.length >= 3) break; // Limit to 3 issues
    }
  }
  
  return issues;
}

function extractPreparationDetails(dailyMedData) {
  const details = [];
  
  if (dailyMedData && dailyMedData.label_info) {
    for (const label of dailyMedData.label_info) {
      if (label.dosage) {
        // Look for preparation instructions
        const dilutionMatch = label.dosage.match(/dilut.*?(with|using).*?([^\.]+)/i);
        if (dilutionMatch && dilutionMatch[0]) {
          details.push(`Dilution: ${dilutionMatch[0]}`);
        }
        
        const reconMatch = label.dosage.match(/reconstitut.*?([^\.]+)/i);
        if (reconMatch && reconMatch[0]) {
          details.push(`Reconstitution: ${reconMatch[0]}`);
        }
        
        const storageMatch = label.dosage.match(/stor.*?(at|below|above|between).*?([^\.]+)/i);
        if (storageMatch && storageMatch[0]) {
          details.push(`Storage: ${storageMatch[0]}`);
        }
        
        if (details.length >= 3) break; // Limit to 3 details
      }
    }
  }
  
  return details;
}
// Function to call Grok API for enhanced summary
async function generateGrokAISummary(allData) {
  const prompt = prepareDataForGrokAPI(allData);
  
  try {
    // Prepare the request to your backend API
    const response = await fetch('/api/generate-summary', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        prompt: prompt,
        maxTokens: 1500,
        temperature: 0.7,
        drugName: allData.drugName
      })
    });
    
    if (!response.ok) {
      throw new Error('Failed to generate AI summary');
    }
    
    const data = await response.json();
    return data.summary;
  } catch (error) {
    console.error('Error generating Grok AI summary:', error);
    // Fall back to local summary if API call fails
    return `
      <div class="p-4 bg-red-50 border border-red-200 rounded-lg mb-4">
        <h3 class="text-lg font-medium text-red-800 mb-2">AI Summary Generation Failed</h3>
        <p class="text-gray-700">We couldn't generate an AI-enhanced summary at this time. Please try again later.</p>
      </div>
      
      ${generateLocalSummary(allData)}
    `;
  }
}
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function initFdaDataSection() {
  // Show the section
  showSection(elements.fdaDataSection, true);
  
  // Initialize counters
  elements.fdaDocCount.textContent = "0 documents";
  elements.orangeBookCount.textContent = "0 entries";
  elements.dailyMedCount.textContent = "0 entries";
  elements.warningLettersCount.textContent = "0 letters";
}

// Function to display FDA data when available
// async function displayFdaData(drugName,condition) {
//   // Initialize the FDA data section
//   initFdaDataSection();
  
//   // Show loading state
//   const loadingTemplate = `
//     <div class="flex justify-center items-center py-8">
//       <svg class="animate-spin h-8 w-8 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
//         <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
//         <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
//       </svg>
//       <span class="ml-2 text-gray-600">Loading FDA data...</span>
//     </div>
//   `;
  
//   elements.fdaDocuments.innerHTML = loadingTemplate;
//   elements.orangeBookData.innerHTML = loadingTemplate;
//   elements.dailyMedData.innerHTML = loadingTemplate;
//   elements.warningLettersData.innerHTML = loadingTemplate;
  
//   try {
//         // if (!drug) {
//     //     alert('Please enter a drug name to search.');
//     //     return;
//     // }
//     // Fetch comprehensive FDA drug data
//     const fdaResponse = await fetch(`${API_BASE_URL}/fda/drug/${encodeURIComponent(drugName)}`);
//     const fdaData = await fdaResponse.json();
    
//     if (fdaResponse.ok && !fdaData.error) {
//       // Display the comprehensive FDA data
//       displayComprehensiveFdaData(fdaData, drugName);
//     } else {
//       elements.fdaDocuments.innerHTML = createErrorMessage("Could not retrieve FDA data");
//     }
    
//     // Continue with existing Orange Book and DailyMed fetches
//     const orangeBookResponse = await fetch(`${API_BASE_URL}/fda/orangebook/search?q=${encodeURIComponent(drugName)}`);
//     const orangeBookData = await orangeBookResponse.json();
//     console.log("ORANGE BOOK", orangeBookData)
//     const companies = orangeBookData.results.companies || [];

//     if (orangeBookResponse.ok && !orangeBookData.error) {
//       displayOrangeBookData(orangeBookData);
//       await fetchWarningLetters(companies);

//     } else {
//       elements.orangeBookData.innerHTML = createErrorMessage("Could not retrieve Orange Book data");
//     }
    

//     // const dailyMedResponse = await fetch(`/api/fda/dailymed/${encodeURIComponent(drugName)}`);
//     // const dailyMedData = await dailyMedResponse.json();
//     // console.log(dailyMedData)
//     try {
//   // Fetch data from the new backend API
//   const dailyMedResponse = await fetch(`http://localhost:3000/api/fda/dailymed?name=${encodeURIComponent(drugName)}`);
//   const rawData = await dailyMedResponse.json();
//   console.log(rawData)
//   // Format the data to work with your display function
//   const dailyMedData = {
//     label_info: Array.isArray(rawData) ? rawData.map(drug => ({
//       title: drug.productName || drug.title || "Unknown Drug",
//       published: drug.effectiveTime || "N/A",
//       setId: drug.splId || "",
//       manufacturer: drug.manufacturer || "Unknown",
//       dosageForm: drug.dosageForms ? drug.dosageForms.join(', ') : "Not specified",
//       activeIngredients: drug.activeIngredients || ["Unknown"],
//       indications: drug.indications || "Not specified",
//       warnings: drug.warnings || "Not specified",
//       dosage: drug.dosage || "Not specified",
//       contraindications: drug.contraindications || "Not specified",
//       adverseReactions: drug.adverseReactions || "Not specified",
//       drugInteractions: drug.drugInteractions || "Not specified",
//       labelUrl: drug.labelUrl || `https://dailymed.nlm.nih.gov/dailymed/lookup.cfm?setid=${drug.splId}`
//     })) : []
//   };
  
//   console.log("DAILY MED DATA", rawData, "cleaned", dailyMedData);
  
//   if (dailyMedResponse.ok && !dailyMedData.error && dailyMedData.label_info.length > 0) {
//     displayDailyMedData(dailyMedData);
//   } else {
//     elements.dailyMedData.innerHTML = createErrorMessage("Could not retrieve DailyMed data");
//   }
// } catch (error) {
//   console.error("Error fetching DailyMed data:", error);
//   elements.dailyMedData.innerHTML = createErrorMessage("Error retrieving DailyMed data");
// }


//     // if (dailyMedResponse.ok && !dailyMedData.error) {
//     //   displayDailyMedData(dailyMedData);
//     // } else {
//     //   elements.dailyMedData.innerHTML = createErrorMessage("Could not retrieve DailyMed data");
//     // }


//     // const dailyMedResponse = await fetch(`/api/fda/dailymed/${encodeURIComponent(drugName)}`);
//     // const dailyMedData = await dailyMedResponse.json();
    
//     // if (dailyMedResponse.ok && !dailyMedData.error) {
//     //   displayDailyMedData(dailyMedData);
//     // } else {
//     //   elements.dailyMedData.innerHTML = createErrorMessage("Could not retrieve DailyMed data");
//     // }
    
//     // Fetch warning letters
//     // await fetchWarningLetters(drugName);
    
//   } catch (error) {
//     console.error("Error fetching FDA data:", error);
//     elements.fdaDocuments.innerHTML = createErrorMessage("Error fetching FDA data");
//     elements.orangeBookData.innerHTML = createErrorMessage("Error fetching FDA data");
//     elements.dailyMedData.innerHTML = createErrorMessage("Error fetching FDA data");
//     elements.warningLettersData.innerHTML = createErrorMessage("Error fetching FDA data");
//   }
// }

// // Function to display FDA data when available
// async function displayFdaData(drugName, condition) {
//   // Initialize the FDA data section
//   initFdaDataSection();
  
//   // Store current drug name globally for the summary feature
//   window.currentDrugName = drugName;
  
//   // Show loading state
//   const loadingTemplate = `
//     <div class="flex justify-center items-center py-8">
//       <svg class="animate-spin h-8 w-8 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
//         <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
//         <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
//       </svg>
//       <span class="ml-2 text-gray-600">Loading FDA data...</span>
//     </div>
//   `;
  
//   elements.fdaDocuments.innerHTML = loadingTemplate;
//   elements.orangeBookData.innerHTML = loadingTemplate;
//   elements.dailyMedData.innerHTML = loadingTemplate;
//   elements.warningLettersData.innerHTML = loadingTemplate;
  
//   try {
//     // Fetch comprehensive FDA drug data
//     const fdaResponse = await fetch(`${API_BASE_URL}/fda/drug/${encodeURIComponent(drugName)}`);
//     const fdaData = await fdaResponse.json();
    
//     if (fdaResponse.ok && !fdaData.error) {
//       // Store FDA data globally for the summary feature
//       window.fdaData = fdaData;
      
//       // Display the comprehensive FDA data
//       displayComprehensiveFdaData(fdaData, drugName);
      
//       // Show the summary in the container (if it exists)
//       const summaryContainer = document.getElementById('fda-summary-container');
//       if (summaryContainer) {
//         summaryContainer.innerHTML = generateFdaSummary(fdaData, drugName);
//         summaryContainer.classList.remove('hidden');
//       }
//     } else {
//       elements.fdaDocuments.innerHTML = createErrorMessage("Could not retrieve FDA data");
//     }
    
//     // Continue with existing Orange Book and DailyMed fetches
//     const orangeBookResponse = await fetch(`${API_BASE_URL}/fda/orangebook/search?q=${encodeURIComponent(drugName)}`);
//     const orangeBookData = await orangeBookResponse.json();
//     const companies = orangeBookData.results.companies || [];

//     if (orangeBookResponse.ok && !orangeBookData.error) {
//       // Store Orange Book data globally for the summary
//       window.orangeBookData = orangeBookData;
      
//       displayOrangeBookData(orangeBookData);
//       await fetchWarningLetters(companies);
      
//       // Refresh the summary after Orange Book data is loaded
//       refreshSummary();
//     } else {
//       elements.orangeBookData.innerHTML = createErrorMessage("Could not retrieve Orange Book data");
//     }
    
//     try {
//       // Fetch data from the new backend API
//       const dailyMedResponse = await fetch(`http://localhost:3000/api/fda/dailymed?name=${encodeURIComponent(drugName)}`);
//       const rawData = await dailyMedResponse.json();
      
//       // Format the data to work with your display function
//       const dailyMedData = {
//         label_info: Array.isArray(rawData) ? rawData.map(drug => ({
//           title: drug.productName || drug.title || "Unknown Drug",
//           published: drug.effectiveTime || "N/A",
//           setId: drug.splId || "",
//           manufacturer: drug.manufacturer || "Unknown",
//           dosageForm: drug.dosageForms ? drug.dosageForms.join(', ') : "Not specified",
//           activeIngredients: drug.activeIngredients || ["Unknown"],
//           indications: drug.indications || "Not specified",
//           warnings: drug.warnings || "Not specified",
//           dosage: drug.dosage || "Not specified",
//           contraindications: drug.contraindications || "Not specified",
//           adverseReactions: drug.adverseReactions || "Not specified",
//           drugInteractions: drug.drugInteractions || "Not specified",
//           labelUrl: drug.labelUrl || `https://dailymed.nlm.nih.gov/dailymed/lookup.cfm?setid=${drug.splId}`
//         })) : []
//       };
      
//       if (dailyMedResponse.ok && !dailyMedData.error && dailyMedData.label_info.length > 0) {
//         // Store DailyMed data globally for the summary
//         window.dailyMedData = dailyMedData;
        
//         displayDailyMedData(dailyMedData);
        
//         // Refresh the summary after DailyMed data is loaded
//         refreshSummary();
//       } else {
//         elements.dailyMedData.innerHTML = createErrorMessage("Could not retrieve DailyMed data");
//       }
//     } catch (error) {
//       console.error("Error fetching DailyMed data:", error);
//       elements.dailyMedData.innerHTML = createErrorMessage("Error retrieving DailyMed data");
//     }
//   } catch (error) {
//     console.error("Error fetching FDA data:", error);
//     elements.fdaDocuments.innerHTML = createErrorMessage("Error fetching FDA data");
//     elements.orangeBookData.innerHTML = createErrorMessage("Error fetching FDA data");
//     elements.dailyMedData.innerHTML = createErrorMessage("Error fetching FDA data");
//     elements.warningLettersData.innerHTML = createErrorMessage("Error fetching FDA data");
//   }
// }


// Function to display FDA data with integrated summary


// async function displayFdaData(drugName, condition) {
//   // Initialize the FDA data section
//   initFdaDataSection();
  
//   // Store current drug name globally for the summary feature
//   window.currentDrugName = drugName;
  
//   // Show loading state
//   const loadingTemplate = `
//     <div class="flex justify-center items-center py-8">
//       <svg class="animate-spin h-8 w-8 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
//         <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
// <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
//       </svg>
//       <span class="ml-2 text-gray-600">Loading FDA data...</span>
//     </div>
//   `;
  
//   elements.fdaDocuments.innerHTML = loadingTemplate;
//   elements.orangeBookData.innerHTML = loadingTemplate;
//   elements.dailyMedData.innerHTML = loadingTemplate;
//   elements.warningLettersData.innerHTML = loadingTemplate;
  
//   try {
//     // Fetch comprehensive FDA drug data
//     const fdaResponse = await fetch(`${API_BASE_URL}/fda/drug/${encodeURIComponent(drugName)}`);
//     const fdaData = await fdaResponse.json();
    
//     if (fdaResponse.ok && !fdaData.error) {
//       // Store FDA data globally for the summary feature
//       window.fdaData = fdaData;
      
//       // Display the comprehensive FDA data
//       displayComprehensiveFdaData(fdaData, drugName);
      
//       // Show the summary container and loading indicator
//       const summaryContainer = document.getElementById('fda-summary-container');
//       if (summaryContainer) {
//         summaryContainer.innerHTML = `
//           <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg mb-4 summary-card">
//             <div class="flex items-center">
//               <div class="mr-3">
//                 <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-600"></div>
//               </div>
//               <h3 class="text-lg font-medium text-blue-800">Generating Regulatory Summary...</h3>
//             </div>
//             <p class="text-sm text-gray-600 mt-2">Analyzing FDA data for ${drugName}. This might take a moment.</p>
//           </div>
//         `;
//         summaryContainer.classList.remove('hidden');
//       }
//     } else {
//       elements.fdaDocuments.innerHTML = createErrorMessage("Could not retrieve FDA data");
//     }
    
//     // Continue with existing Orange Book and DailyMed fetches
//     const orangeBookResponse = await fetch(`${API_BASE_URL}/fda/orangebook/search?q=${encodeURIComponent(drugName)}`);
//     const orangeBookData = await orangeBookResponse.json();
//     const companies = orangeBookData.results?.companies || [];

//     if (orangeBookResponse.ok && !orangeBookData.error) {
//       // Store Orange Book data globally for the summary
//       window.orangeBookData = orangeBookData;
      
//       displayOrangeBookData(orangeBookData);
      
//       // Fetch warning letters for the companies
//       await fetchWarningLetters(companies);
      
//       // Refresh the summary after Orange Book data is loaded
//       refreshSummary();
//     } else {
//       elements.orangeBookData.innerHTML = createErrorMessage("Could not retrieve Orange Book data");
//     }
    
//     try {
//       // Fetch data from the DailyMed API
//       const dailyMedResponse = await fetch(`http://localhost:3000/api/fda/dailymed?name=${encodeURIComponent(drugName)}`);
//       const rawData = await dailyMedResponse.json();
      
//       // Format the data to work with your display function
//       const dailyMedData = {
//         label_info: Array.isArray(rawData) ? rawData.map(drug => ({
//           title: drug.productName || drug.title || "Unknown Drug",
//           published: drug.effectiveTime || "N/A",
//           setId: drug.splId || "",
//           manufacturer: drug.manufacturer || "Unknown",
//           dosageForm: drug.dosageForms ? drug.dosageForms.join(', ') : "Not specified",
//           activeIngredients: drug.activeIngredients || ["Unknown"],
//           indications: drug.indications || "Not specified",
//           warnings: drug.warnings || "Not specified",
//           dosage: drug.dosage || "Not specified",
//           contraindications: drug.contraindications || "Not specified",
//           adverseReactions: drug.adverseReactions || "Not specified",
//           drugInteractions: drug.drugInteractions || "Not specified",
//           labelUrl: drug.labelUrl || `https://dailymed.nlm.nih.gov/dailymed/lookup.cfm?setid=${drug.splId}`
//         })) : []
//       };
      
//       if (dailyMedResponse.ok && !dailyMedData.error && dailyMedData.label_info.length > 0) {
//         // Store DailyMed data globally for the summary
//         window.dailyMedData = dailyMedData;
        
//         displayDailyMedData(dailyMedData);
        
//         // Refresh the summary after DailyMed data is loaded
//         refreshSummary();
//       } else {
//         elements.dailyMedData.innerHTML = createErrorMessage("Could not retrieve DailyMed data");
//       }
//     } catch (error) {
//       console.error("Error fetching DailyMed data:", error);
//       elements.dailyMedData.innerHTML = createErrorMessage("Error retrieving DailyMed data");
//     }
    
//     // Generate an automated summary with OpenAI when all data is loaded
//     setTimeout(async () => {
//       try {
//         const summaryContainer = document.getElementById('fda-summary-container');
//         if (summaryContainer && window.fdaData) {
//           // Collect all FDA data
//           const allData = collectAllFdaData(drugName);
          
//           // First show a basic summary
//           summaryContainer.innerHTML = generateLocalSummary(allData);
          
//           // Then try to get an enhanced summary from OpenAI
//           try {
//             const aiSummary = await generateOpenAISummary(allData);
//             if (aiSummary) {
//               summaryContainer.innerHTML = aiSummary;
              
//               // Add an email button to the summary container
//               const emailButton = document.createElement('button');
//               emailButton.className = 'mt-4 px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition-colors flex items-center';
//               emailButton.innerHTML = `
//                 <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
//                   <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" />
//                   <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" />
//                 </svg>
//                 Email Me This Summary
//               `;
//               emailButton.onclick = function() {
//                 emailSummary(drugName, aiSummary);
//               };
//               summaryContainer.appendChild(emailButton);
//             }
//           } catch (aiError) {
//             console.error("Error generating AI summary:", aiError);
//             // Keep the local summary if AI fails
//           }
//         }
//       } catch (summaryError) {
//         console.error("Error generating summary:", summaryError);
//       }
//     }, 1000); // Small delay to ensure all data is loaded
    
//   } catch (error) {
//     console.error("Error fetching FDA data:", error);
//     elements.fdaDocuments.innerHTML = createErrorMessage("Error fetching FDA data");
//     elements.orangeBookData.innerHTML = createErrorMessage("Error fetching FDA data");
//     elements.dailyMedData.innerHTML = createErrorMessage("Error fetching FDA data");
//     elements.warningLettersData.innerHTML = createErrorMessage("Error fetching FDA data");
//   }
// }

// async function displayFdaData(drugName, condition) {
//   // Initialize the FDA data section
//   initFdaDataSection();
  
//   // Store current drug name globally for the summary feature
//   window.currentDrugName = drugName;
  
//   // Show loading state
//   const loadingTemplate = `
//     <div class="flex justify-center items-center py-8">
//       <svg class="animate-spin h-8 w-8 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
//         <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
//         <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
//       </svg>
//       <span class="ml-2 text-gray-600">Loading FDA data...</span>
//     </div>
//   `;
  
//   elements.fdaDocuments.innerHTML = loadingTemplate;
//   elements.orangeBookData.innerHTML = loadingTemplate;
//   elements.dailyMedData.innerHTML = loadingTemplate;
//   elements.warningLettersData.innerHTML = loadingTemplate;
  
//   try {
//     // Fetch comprehensive FDA drug data
//     const fdaResponse = await fetch(`${API_BASE_URL}/fda/drug/${encodeURIComponent(drugName)}`);
//     const fdaData = await fdaResponse.json();
    
//     if (fdaResponse.ok && !fdaData.error) {
//       // Store FDA data globally for the summary feature
//       window.fdaData = fdaData;
      
//       // Display the comprehensive FDA data
//       displayComprehensiveFdaData(fdaData, drugName);
      
//       // Show the summary container and loading indicator
//       const summaryContainer = document.getElementById('fda-summary-container');
//       if (summaryContainer) {
//         summaryContainer.innerHTML = `
//           <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg mb-4 summary-card">
//             <div class="flex items-center">
//               <div class="mr-3">
//                 <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-600"></div>
//               </div>
//               <h3 class="text-lg font-medium text-blue-800">Generating Regulatory Summary...</h3>
//             </div>
//             <p class="text-sm text-gray-600 mt-2">Analyzing FDA data for ${drugName} with Grok AI. This might take a moment.</p>
//           </div>
//         `;
//         summaryContainer.classList.remove('hidden');
//       }
//     } else {
//       elements.fdaDocuments.innerHTML = createErrorMessage("Could not retrieve FDA data");
//     }
    
//     // Continue with existing Orange Book and DailyMed fetches
//     const orangeBookResponse = await fetch(`${API_BASE_URL}/fda/orangebook/search?q=${encodeURIComponent(drugName)}`);
//     const orangeBookData = await orangeBookResponse.json();
//     const companies = orangeBookData.results?.companies || [];

//     if (orangeBookResponse.ok && !orangeBookData.error) {
//       // Store Orange Book data globally for the summary
//       window.orangeBookData = orangeBookData;
      
//       displayOrangeBookData(orangeBookData);
      
//       // Fetch warning letters for the companies
//       await fetchWarningLetters(companies);
      
//       // Refresh the summary after Orange Book data is loaded
//       refreshSummary();
//     } else {
//       elements.orangeBookData.innerHTML = createErrorMessage("Could not retrieve Orange Book data");
//     }
    
//     try {
//       // Fetch data from the DailyMed API
//       const dailyMedResponse = await fetch(`${API_BASE_URL}/fda/dailymed?name=${encodeURIComponent(drugName)}`);
//       const rawData = await dailyMedResponse.json();
      
//       // Format the data to work with your display function
//       const dailyMedData = {
//         label_info: Array.isArray(rawData) ? rawData.map(drug => ({
//           title: drug.productName || drug.title || "Unknown Drug",
//           published: drug.effectiveTime || "N/A",
//           setId: drug.splId || "",
//           manufacturer: drug.manufacturer || "Unknown",
//           dosageForm: drug.dosageForms ? drug.dosageForms.join(', ') : "Not specified",
//           activeIngredients: drug.activeIngredients || ["Unknown"],
//           indications: drug.indications || "Not specified",
//           warnings: drug.warnings || "Not specified",
//           dosage: drug.dosage || "Not specified",
//           contraindications: drug.contraindications || "Not specified",
//           adverseReactions: drug.adverseReactions || "Not specified",
//           drugInteractions: drug.drugInteractions || "Not specified",
//           labelUrl: drug.labelUrl || `https://dailymed.nlm.nih.gov/dailymed/lookup.cfm?setid=${drug.splId}`
//         })) : []
//       };
      
//       if (dailyMedResponse.ok && !dailyMedData.error && dailyMedData.label_info.length > 0) {
//         // Store DailyMed data globally for the summary
//         window.dailyMedData = dailyMedData;
        
//         displayDailyMedData(dailyMedData);
        
//         // Refresh the summary after DailyMed data is loaded
//         refreshSummary();
//       } else {
//         elements.dailyMedData.innerHTML = createErrorMessage("Could not retrieve DailyMed data");
//       }
//     } catch (error) {
//       console.error("Error fetching DailyMed data:", error);
//       elements.dailyMedData.innerHTML = createErrorMessage("Error retrieving DailyMed data");
//     }
    
//     // Generate an automated summary with Grok AI when all data is loaded
//     setTimeout(async () => {
//       try {
//         const summaryContainer = document.getElementById('fda-summary-container');
//         if (summaryContainer && window.fdaData) {
//           // Collect all FDA data
//           const allData = collectAllFdaData(drugName);
          
//           // First show a basic summary
//           summaryContainer.innerHTML = generateLocalSummary(allData);
          
//           // Then try to get an enhanced summary from Grok AI
//           try {
//             const aiSummary = await generateGrokAISummary(allData);
//             if (aiSummary) {
//               summaryContainer.innerHTML = aiSummary;
              
//               // Add an email button and Grok badge to the summary container
//               const summaryFooter = document.createElement('div');
//               summaryFooter.className = 'flex items-center justify-between mt-4';
              
//               // Email button
//               const emailButton = document.createElement('button');
//               emailButton.className = 'px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition-colors flex items-center';
//               emailButton.innerHTML = `
//                 <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
//                   <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" />
//                   <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" />
//                 </svg>
//                 Email Me This Summary
//               `;
//               emailButton.onclick = function() {
//                 emailSummary(drugName, aiSummary);
//               };
              
//               // Grok badge
//               const grokBadge = document.createElement('div');
//               grokBadge.className = 'text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full flex items-center';
//               grokBadge.innerHTML = `
//                 <svg class="h-4 w-4 mr-1" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
//                   <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
//                 </svg>
//                 Powered by AI
//               `;
              
//               // Add elements to the footer
//               summaryFooter.appendChild(emailButton);
//               summaryFooter.appendChild(grokBadge);
              
//               // Add footer to the summary container
//               summaryContainer.appendChild(summaryFooter);
//             }
//           } catch (aiError) {
//             console.error("Error generating Grok AI summary:", aiError);
//             // Keep the local summary if AI fails
//           }
//         }
//       } catch (summaryError) {
//         console.error("Error generating summary:", summaryError);
//       }
//     }, 1000); // Small delay to ensure all data is loaded
    
//   } catch (error) {
//     console.error("Error fetching FDA data:", error);
//     elements.fdaDocuments.innerHTML = createErrorMessage("Error fetching FDA data");
//     elements.orangeBookData.innerHTML = createErrorMessage("Error fetching FDA data");
//     elements.dailyMedData.innerHTML = createErrorMessage("Error fetching FDA data");
//     elements.warningLettersData.innerHTML = createErrorMessage("Error fetching FDA data");
//   }
// }

async function displayFdaData(drugName, condition) {
  // Initialize the FDA data section
  initFdaDataSection();
  
  // Store current drug name globally for the summary feature
  window.currentDrugName = drugName;
  
  // Show loading state
  const loadingTemplate = `
    <div class="flex justify-center items-center py-8">
      <svg class="animate-spin h-8 w-8 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      <span class="ml-2 text-gray-600">Loading FDA data...</span>
    </div>
  `;
  
  elements.fdaDocuments.innerHTML = loadingTemplate;
  elements.orangeBookData.innerHTML = loadingTemplate;
  elements.dailyMedData.innerHTML = loadingTemplate;
  elements.warningLettersData.innerHTML = loadingTemplate;
  
  try {
    // Fetch comprehensive FDA data
    const fdaResponse = await fetch(`${API_BASE_URL}/fda/drug/${encodeURIComponent(drugName)}`);
    const fdaData = await fdaResponse.json();
    
    if (fdaResponse.ok && !fdaData.error) {
      // Store FDA data globally for the summary feature
      window.fdaData = fdaData;
      
      // Display the comprehensive FDA data
      displayComprehensiveFdaData(fdaData, drugName);
      
      // Show the summary container with a loading indicator initially
      const summaryContainer = document.getElementById('fda-summary-container');
      if (summaryContainer) {
        summaryContainer.innerHTML = `
          <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg mb-4 summary-card">
            <div class="flex items-center">
              <div class="mr-3">
                <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-600"></div>
              </div>
              <h3 class="text-lg font-medium text-blue-800">Generating Basic Regulatory Summary...</h3>
            </div>
            <p class="text-sm text-gray-600 mt-2">Analyzing FDA data for ${drugName}. This might take a moment.</p>
          </div>
        `;
        summaryContainer.classList.remove('hidden');
      }
    } else {
      elements.fdaDocuments.innerHTML = createErrorMessage("Could not retrieve FDA data");
    }
    
    // Continue with existing Orange Book and DailyMed fetches
    const orangeBookResponse = await fetch(`${API_BASE_URL}/fda/orangebook/search?q=${encodeURIComponent(drugName)}`);
    const orangeBookData = await orangeBookResponse.json();
    const companies = orangeBookData.results?.companies || [];

    if (orangeBookResponse.ok && !orangeBookData.error) {
      // Store Orange Book data globally for the summary
      window.orangeBookData = orangeBookData;
      
      let run = displayOrangeBookData(orangeBookData);
      
      // Fetch warning letters for the companies
      // await fetchWarningLetters(companies);
      if (run) {
        await searchWarningLetters(companies)
      }else {
elements.warningLettersData.innerHTML =   `<div class="text-center p-4">
        <p class="text-sm text-gray-700">No Warning letters found for "${drugName}"</p>
      </div>`;
      }
      
    } else {
      elements.orangeBookData.innerHTML =   `<div class="text-center p-4">
        <p class="text-sm text-gray-700">No Orangebook data found for "${drugName}"</p>
      </div>`;
      
      console.log("Could not retrieve Orange Book data");
    }
    
    try {
      // Fetch data from the DailyMed API
      const dailyMedResponse = await fetch(`${API_BASE_URL}/fda/dailymed?name=${encodeURIComponent(drugName)}`);
      const rawData = await dailyMedResponse.json();
      
      // Format the data to work with your display function
      const dailyMedData = {
        label_info: Array.isArray(rawData) ? rawData.map(drug => ({
          title: drug.productName || drug.title || "Unknown Drug",
          published: drug.effectiveTime || "N/A",
          setId: drug.splId || "",
          manufacturer: drug.manufacturer || "Unknown",
          dosageForm: drug.dosageForms ? drug.dosageForms.join(', ') : "Not specified",
          activeIngredients: drug.activeIngredients || ["Unknown"],
          indications: drug.indications || "Not specified",
          warnings: drug.warnings || "Not specified",
          dosage: drug.dosage || "Not specified",
          contraindications: drug.contraindications || "Not specified",
          adverseReactions: drug.adverseReactions || "Not specified",
          drugInteractions: drug.drugInteractions || "Not specified",
          labelUrl: drug.labelUrl || `https://dailymed.nlm.nih.gov/dailymed/lookup.cfm?setid=${drug.splId}`
        })) : []
      };
      
      if (dailyMedResponse.ok && !dailyMedData.error && dailyMedData.label_info.length > 0) {
        // Store DailyMed data globally for the summary
        window.dailyMedData = dailyMedData;
        
        displayDailyMedData(dailyMedData);
      } else {
        console.log("dailymed error")
        elements.dailyMedData.innerHTML =   `<div class="text-center p-4">
        <p class="text-sm text-gray-700">No DailyMed data found for "${drugName}"</p>
      </div>`;
        //  = createErrorMessage("Could not retrieve DailyMed data");
      }
    } catch (error) {
      console.error("Error fetching DailyMed data:", error);
  elements.dailyMedData.innerHTML =   `<div class="text-center p-4">
        <p class="text-sm text-gray-700">No drug application data found for "${drugName}"</p>
      </div>`;
    // createErrorMessage("Error retrieving DailyMed data");
    
    }
    
    // Generate and display the basic summary after all data is loaded
    setTimeout(async () => {
      try {
        const summaryContainer = document.getElementById('fda-summary-container');
        if (summaryContainer && window.fdaData) {
          // Collect all FDA data including Orange Book
          const allData = collectAllFdaData(drugName);
          
          // Display the basic summary
          const basicSummary = generateLocalSummary(allData);
          
          // Create a footer div for the basic summary with the AI summary button
          const summaryFooter = document.createElement('div');
          summaryFooter.className = 'flex items-center justify-between mt-4';
          
          // Email button for basic summary
          const emailButton = document.createElement('button');
          emailButton.className = 'px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition-colors flex items-center';
          emailButton.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
              <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" />
              <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" />
            </svg>
            Email Me This Summary
          `;
          emailButton.onclick = function() {
            emailSummary(drugName, summaryContainer.innerHTML);
          };
          
          // AI summary button
          const aiSummaryButton = document.createElement('button');
          aiSummaryButton.className = 'px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors flex items-center';
          aiSummaryButton.innerHTML = `
            <svg class="h-5 w-5 mr-2" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
            </svg>
            Generate AI-Enhanced Summary
          `;
          
          // Event handler for the AI summary button
          aiSummaryButton.onclick = async function() {
            // Show loading state when generating AI summary
            summaryContainer.innerHTML = `
              <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg mb-4 summary-card">
                <div class="flex items-center">
                  <div class="mr-3">
                    <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-600"></div>
                  </div>
                  <h3 class="text-lg font-medium text-blue-800">Generating AI-Enhanced Summary...</h3>
                </div>
                <p class="text-sm text-gray-600 mt-2">Analyzing FDA data for ${drugName} with Grok AI. This might take a moment.</p>
              </div>
            `;
            
            try {
              // Generate the AI summary
              const aiSummary = await generateGrokAISummary(allData);
              
              if (aiSummary) {
                // Sanitize the AI summary to remove any ```html tags, other code formatting artifacts,
                // and any explanatory text that might be included at the end
                let cleanedSummary = aiSummary;
                
                // Remove markdown code blocks (```html and ```)
                cleanedSummary = cleanedSummary.replace(/```(html|javascript|js|css)?([\s\S]*?)```/g, '$2');
                

                                // Remove markdown code blocks (```html and ```)
                 cleanedSummary = cleanedSummary.replace(/```(html|javascript|js|css)?([\s\S]*?)```/g, '$2');
                
                // Remove any leftover single backticks
                cleanedSummary = cleanedSummary.replace(/`([^`]*)`/g, '$1');


                // Remove any leftover single backticks
                cleanedSummary = cleanedSummary.replace(/`([^`]*)`/g, '$1');
                
                // Remove explanatory text commonly found at the end of AI-generated summaries
                cleanedSummary = cleanedSummary.replace(/This HTML summary provides?[\s\S]*?(with AI assistance\.?|for healthcare providers\.?|for readability\.?)$/g, '');
                cleanedSummary = cleanedSummary.replace(/Summary based on FDA data[\s\S]*?Generated with AI assistance\.?$/g, '');
                
                // Remove any trailing explanatory paragraphs (common pattern)
                cleanedSummary = cleanedSummary.replace(/<p>This (summary|regulatory|report|overview)[\s\S]*?<\/p>$/g, '');
                
                // Display the cleaned AI summary
                summaryContainer.innerHTML = cleanedSummary;
                
                // Add an updated footer for the AI summary
                const aiSummaryFooter = document.createElement('div');
                aiSummaryFooter.className = 'flex items-center justify-between mt-4';
                
                // Email button for AI summary
                const aiEmailButton = document.createElement('button');
                aiEmailButton.className = 'px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition-colors flex items-center';
                aiEmailButton.innerHTML = emailButton.innerHTML;
                aiEmailButton.onclick = function() {
                  // Use the cleaned summary for the email as well
                  emailSummary(drugName, cleanedSummary);
                };
                
                // Back to basic summary button
                const backToBasicButton = document.createElement('button');
                backToBasicButton.className = 'px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 transition-colors flex items-center';
                backToBasicButton.innerHTML = `
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M9.707 14.707a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 1.414L7.414 9H15a1 1 0 110 2H7.414l2.293 2.293a1 1 0 010 1.414z" clip-rule="evenodd" />
                  </svg>
                  Back to Basic Summary
                `;
                backToBasicButton.onclick = function() {
                  // Restore the basic summary
                  summaryContainer.innerHTML = basicSummary;
                  
                  // Restore the original footer with AI summary button
                  const basicFooter = document.createElement('div');
                  basicFooter.className = 'flex items-center justify-between mt-4';
                  basicFooter.appendChild(emailButton.cloneNode(true));
                  basicFooter.appendChild(aiSummaryButton.cloneNode(true));
                  
                  // Re-attach event handlers
                  basicFooter.children[0].onclick = function() {
                    emailSummary(drugName, basicSummary);
                  };
                  basicFooter.children[1].onclick = aiSummaryButton.onclick;
                  
                  summaryContainer.appendChild(basicFooter);
                };
                
                // Grok badge
                const grokBadge = document.createElement('div');
                grokBadge.className = 'text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full flex items-center';
                grokBadge.innerHTML = `
                  <svg class="h-4 w-4 mr-1" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
                  </svg>
                  Powered by AI
                `;
                
                // Add containers to footer
                const buttonContainer = document.createElement('div');
                buttonContainer.className = 'flex space-x-2';
                buttonContainer.appendChild(aiEmailButton);
                buttonContainer.appendChild(backToBasicButton);
                
                aiSummaryFooter.appendChild(buttonContainer);
                aiSummaryFooter.appendChild(grokBadge);
                
                // Add footer to the summary container
                summaryContainer.appendChild(aiSummaryFooter);
              } else {
                // If AI summary generation fails, go back to the basic summary
                summaryContainer.innerHTML = basicSummary;
                summaryContainer.appendChild(summaryFooter);
              }
            } catch (aiError) {
              console.error("Error generating Grok AI summary:", aiError);
              // Show an error message and revert to basic summary
              summaryContainer.innerHTML = basicSummary;
              
              // Add error notification
              const errorNotice = document.createElement('div');
              errorNotice.className = 'p-3 bg-red-50 text-red-700 border border-red-200 rounded mt-2 mb-2';
              errorNotice.innerHTML = `
                <div class="flex items-center">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                  </svg>
                  <span>AI summary generation failed. Using basic summary instead.</span>
                </div>
              `;
              summaryContainer.insertBefore(errorNotice, summaryContainer.firstChild);
              summaryContainer.appendChild(summaryFooter);
            }
          };
          
          // Add button containers to the footer
          summaryFooter.appendChild(emailButton);
          summaryFooter.appendChild(aiSummaryButton);
          
          // Set the basic summary content
          summaryContainer.innerHTML = basicSummary;
          
          // Add the footer to the summary container
          summaryContainer.appendChild(summaryFooter);
        }
      } catch (summaryError) {
        console.error("Error generating summary:", summaryError);
        
        // Display error message in the summary container
        const summaryContainer = document.getElementById('fda-summary-container');
        if (summaryContainer) {
          summaryContainer.innerHTML = `
            <div class="p-4 bg-red-50 border border-red-200 rounded-lg mb-4">
              <div class="flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <h3 class="text-lg font-medium text-red-800">Error Generating Summary</h3>
              </div>
              <p class="text-sm text-red-600 mt-2">There was a problem generating the regulatory summary. Please try again later.</p>
            </div>
          `;
        }
      }
    }, 1000); // Small delay to ensure all data is loaded
    
  } catch (error) {
    console.error("Error fetching FDA data:", error);
    elements.fdaDocuments.innerHTML = createErrorMessage("Error fetching FDA data");
    elements.orangeBookData.innerHTML = createErrorMessage("Error fetching FDA data");
    elements.dailyMedData.innerHTML = createErrorMessage("Error fetching FDA data");
    elements.warningLettersData.innerHTML = createErrorMessage("Error fetching FDA data");
  }
}

// Helper function to ensure Orange Book data is included in the summary
function collectAllFdaData(drugName) {
  const allData = {
    drugName: drugName,
    fdaData: window.fdaData || {},
    orangeBookData: window.orangeBookData.results || {},
    dailyMedData: window.dailyMedData || { label_info: [] },
    warningLetters: window.warningLetters || []
  };

  console.log("orangebook : ALLDATA :  ",allData.orangeBookData )
  
  return allData;
}

// // Helper function to refresh the summary when new data is available
// function refreshSummary() {
//   if (window.fdaData && window.currentDrugName) {
//     const summaryContainer = document.getElementById('fda-summary-container');
//     if (summaryContainer) {
//       summaryContainer.innerHTML = generateFdaSummary(window.fdaData, window.currentDrugName);
//       summaryContainer.classList.remove('hidden');
//     }
//   }
// }
// // Function to add Chemistry Reviews button to main product section
// function addChemistryReviewsButton() {
//   // Find the applications tab content
//   const applicationsContent = document.getElementById('applications-content');
  
//   // If the element exists, add the button after any existing "View All" button or at the end
//   if (applicationsContent) {
//     // Check if there's a "View All" button container
//     let viewAllContainer = applicationsContent.querySelector('[id="view-all-applications"]');
    
//     // Create the container for the Chemistry Reviews button
//     const buttonContainer = document.createElement('div');
//     buttonContainer.className = 'mt-4 text-center';
    
//     // Create the Chemistry Reviews button
//     const chemistryButton = document.createElement('button');
//     chemistryButton.id = 'chemistry-reviews-btn';
//     chemistryButton.className = 'px-4 py-2 bg-green-600 text-white border border-green-700 rounded hover:bg-green-700 transition-colors text-sm shadow-sm';
//     chemistryButton.innerHTML = `
//       <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
//       </svg>
//       Find Chemistry Reviews for All Products
//     `;
    
//     // Add the button to its container
//     buttonContainer.appendChild(chemistryButton);
    
//     // If there's a View All button, insert after it; otherwise append to the end
//     if (viewAllContainer && viewAllContainer.parentNode) {
//       viewAllContainer.parentNode.insertAdjacentElement('afterend', buttonContainer);
//     } else {
//       applicationsContent.appendChild(buttonContainer);
//     }
    
//     // Add click event listener
//     chemistryButton.addEventListener('click', processAllProductsForChemistryReviews);
//   }
// }


// Function to add Chemistry Reviews button to main product section
function addChemistryReviewsButton() {
  // Find the applications tab content
  const applicationsContent = document.getElementById('applications-content');
  
  // If the element exists, add the button after any existing "View All" button or at the end
  if (applicationsContent) {
    // Create the container for the Chemistry Reviews button
    const buttonContainer = document.createElement('div');
    buttonContainer.className = 'mt-4 text-center';
    
    // Create the Chemistry Reviews button
    const chemistryButton = document.createElement('button');
    chemistryButton.id = 'chemistry-reviews-btn';
    chemistryButton.className = 'px-4 py-2 bg-green-600 text-white border border-green-700 rounded hover:bg-green-700 transition-colors text-sm shadow-sm';
    chemistryButton.innerHTML = `
      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
      </svg>
      Find Chemistry Reviews for All Products
    `;
    
    // Add the button to its container
    buttonContainer.appendChild(chemistryButton);
    
    // Find ViewAll button container if it exists
    let viewAllContainer = applicationsContent.querySelector('[id="view-all-applications"]');
    if (viewAllContainer && viewAllContainer.parentNode) {
      viewAllContainer.parentNode.insertAdjacentElement('afterend', buttonContainer);
    } else {
      // If there's no existing button, add it directly after the product grid
      const productGrid = applicationsContent.querySelector('.grid');
      if (productGrid) {
        productGrid.insertAdjacentElement('afterend', buttonContainer);
      } else {
        // Fallback - append to end of content
        applicationsContent.appendChild(buttonContainer);
      }
    }
    
    // Add click event listener
    chemistryButton.addEventListener('click', processAllProductsForChemistryReviews);
  }
}
// Function to process all products and check for chemistry reviews
async function processAllProductsForChemistryReviews() {
  // First, open the Chemistry Reviews summary modal
  openChemistryReviewsModal();
  
  // Get all products with their application numbers
  const productButtons = document.querySelectorAll('.view-details-btn');
  
  if (productButtons.length === 0) {
    updateChemistryReviewsModal('No products found to analyze', false);
    return;
  }
  
  // Update modal with progress info
  updateChemistryReviewsModal(`Starting analysis of ${productButtons.length} products...`, true);
  
  // Array to store found chemistry reviews
  const foundChemistryReviews = [];
  let processedCount = 0;
  
  // Process each product one by one - IMPORTANT: This processes ALL products, not just the first 9
  for (const button of productButtons) {
    const applicationNumber = button.getAttribute('data-application');
    const brandName = button.getAttribute('data-brand');
    const ingredient = button.getAttribute('data-ingredient');
    
    processedCount++;
    updateChemistryReviewsModal(
      `Processing product ${processedCount} of ${productButtons.length}: ${brandName} (${applicationNumber})`, 
      true
    );
    
    // Fetch documents for this product
    try {
      const chemistryReviews = await fetchChemistryReviewsForProduct(applicationNumber, brandName, ingredient);
      
      if (chemistryReviews.length > 0) {
        foundChemistryReviews.push({
          applicationNumber,
          brandName,
          ingredient,
          reviews: chemistryReviews
        });
        
        updateChemistryReviewsModal(
          `Found ${chemistryReviews.length} chemistry reviews for ${brandName} (${applicationNumber}).<br>Total found so far: ${foundChemistryReviews.length} products with chemistry reviews.`,
          true
        );
      }
    } catch (error) {
      console.error(`Error processing ${applicationNumber}:`, error);
      updateChemistryReviewsModal(
        `Error processing ${brandName} (${applicationNumber}): ${error.message}<br>Continuing with next product...`,
        true,
        true
      );
    }
    
    // Small delay to avoid overwhelming the server
    await new Promise(resolve => setTimeout(resolve, 500));
  }
  
  // Process complete - generate summary if reviews were found
  if (foundChemistryReviews.length > 0) {
    updateChemistryReviewsModal(
      `Found chemistry reviews for ${foundChemistryReviews.length} products. Generating AI summary...`,
      true
    );
    
    // Generate AI summary for all found chemistry reviews
    await generateChemistryReviewsSummary(foundChemistryReviews);
  } else {
    updateChemistryReviewsModal(
      `Process complete. No chemistry reviews found across ${productButtons.length} products.`,
      false
    );
  }
}



// // Function to process all products and check for chemistry reviews
// async function processAllProductsForChemistryReviews() {
//   // First, open the Chemistry Reviews summary modal
//   openChemistryReviewsModal();
  
//   // Get all products with their application numbers
//   const productButtons = document.querySelectorAll('.view-details-btn');
  
//   if (productButtons.length === 0) {
//     updateChemistryReviewsModal('No products found to analyze', false);
//     return;
//   }
  
//   // Update modal with progress info
//   updateChemistryReviewsModal(`Starting analysis of ${productButtons.length} products...`, true);
  
//   // Array to store found chemistry reviews
//   const foundChemistryReviews = [];
//   let processedCount = 0;
  
//   // Process each product one by one
//   for (const button of productButtons) {
//     const applicationNumber = button.getAttribute('data-application');
//     const brandName = button.getAttribute('data-brand');
//     const ingredient = button.getAttribute('data-ingredient');
    
//     processedCount++;
//     updateChemistryReviewsModal(
//       `Processing product ${processedCount} of ${productButtons.length}: ${brandName} (${applicationNumber})`, 
//       true
//     );
    
//     // Fetch documents for this product
//     try {
//       const chemistryReviews = await fetchChemistryReviewsForProduct(applicationNumber, brandName, ingredient);
      
//       if (chemistryReviews.length > 0) {
//         foundChemistryReviews.push({
//           applicationNumber,
//           brandName,
//           ingredient,
//           reviews: chemistryReviews
//         });
        
//         updateChemistryReviewsModal(
//           `Found ${chemistryReviews.length} chemistry reviews for ${brandName} (${applicationNumber}).<br>Total found so far: ${foundChemistryReviews.length} products with chemistry reviews.`,
//           true
//         );
//       }
//     } catch (error) {
//       console.error(`Error processing ${applicationNumber}:`, error);
//       updateChemistryReviewsModal(
//         `Error processing ${brandName} (${applicationNumber}): ${error.message}<br>Continuing with next product...`,
//         true,
//         true
//       );
//     }
    
//     // Small delay to avoid overwhelming the server
//     await new Promise(resolve => setTimeout(resolve, 500));
//   }
  
//   // Process complete - generate summary if reviews were found
//   if (foundChemistryReviews.length > 0) {
//     updateChemistryReviewsModal(
//       `Found chemistry reviews for ${foundChemistryReviews.length} products. Generating AI summary...`,
//       true
//     );
    
//     // Generate AI summary for all found chemistry reviews
//     await generateChemistryReviewsSummary(foundChemistryReviews);
//   } else {
//     updateChemistryReviewsModal(
//       `Process complete. No chemistry reviews found across ${productButtons.length} products.`,
//       false
//     );
//   }
// }

// Function to fetch chemistry reviews for a specific product
async function fetchChemistryReviewsForProduct(applicationNumber, brandName, ingredient) {
  const appNo = applicationNumber.replace(/[^0-9]/g, ''); // Clean the application number
  const response = await fetch(`/api/fda-pdfs/${appNo}`);
  
  if (!response.ok) {
    return []; // Return empty array if no documents found
  }
  
  const data = await response.json();
  const documentLinks = data.results || [];
  
  // Filter for chemistry reviews only (check for chemistry-related keywords in document name or type)
  return documentLinks.filter(link => {
    const nameLC = (link.name || '').toLowerCase();
    const typeLC = (link.type || '').toLowerCase();
    
    return (
      typeLC.includes('chemistry') || 
      nameLC.includes('chemistry') || 
      nameLC.includes('cmc') || // Chemistry, Manufacturing, and Controls
      nameLC.includes('pharm-chem') ||
      nameLC.includes('composition') ||
      nameLC.includes('formulation') ||
      nameLC.includes('manufacturing')
    );
  });
}

// Function to open Chemistry Reviews summary modal
function openChemistryReviewsModal() {
  // Create modal if it doesn't exist
  if (!document.getElementById('chemistryReviewsModal')) {
    const modalHTML = `
      <div id="chemistryReviewsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-4xl max-h-[90vh] overflow-auto">
          <div class="p-4 border-b flex justify-between items-center bg-green-50">
            <h3 class="text-lg font-semibold text-green-800" id="chemistryModalTitle">Chemistry Reviews Analysis</h3>
            <button id="closeChemistryModalBtn" class="text-gray-500 hover:text-gray-700">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
          
          <div class="p-6" id="chemistryModalContent">
            <div class="flex justify-center items-center py-4">
              <svg class="animate-spin h-8 w-8 text-green-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              <span class="ml-3 text-gray-600">Initializing chemistry reviews analysis...</span>
            </div>
          </div>
          
          <div id="chemistryModalActions" class="border-t p-4 flex justify-end hidden">
            <button id="emailChemistryBtn" class="px-4 py-2 bg-blue-600 text-white rounded mr-2 hover:bg-blue-700 transition-colors">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
              </svg>
              Email Me This Summary
            </button>
          </div>
        </div>
      </div>
    `;
    
    // Append modal to body
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Add event listeners for modal
    document.getElementById('closeChemistryModalBtn').addEventListener('click', closeChemistryReviewsModal);
    
    // Close modal when clicking outside
    document.getElementById('chemistryReviewsModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeChemistryReviewsModal();
      }
    });
    
    // Add event listener for email button
    document.getElementById('emailChemistryBtn').addEventListener('click', emailChemistryReviewsSummary);
  }
  
  // Show modal
  document.getElementById('chemistryReviewsModal').classList.remove('hidden');
  
  // Hide actions section initially
  document.getElementById('chemistryModalActions').classList.add('hidden');
}

// Function to close the Chemistry Reviews modal
function closeChemistryReviewsModal() {
  const modal = document.getElementById('chemistryReviewsModal');
  if (modal) {
    modal.classList.add('hidden');
  }
}

// Function to update the Chemistry Reviews modal content

// Function to update the Chemistry Reviews modal content with proper Tailwind UI
function updateChemistryReviewsModal(message, isProcessing, isError = false) {
  const modalContent = document.getElementById('chemistryModalContent');
  if (!modalContent) return;
  
  if (isProcessing) {
    // Show loading with message and Tailwind styling
    modalContent.innerHTML = `
      <div class="flex items-start p-4">
        <div class="mr-3">
          <svg class="animate-spin h-5 w-5 text-green-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
        </div>
        <div class="${isError ? 'text-red-600' : 'text-gray-700'}">
          ${message}
        </div>
      </div>
      <div class="mt-4 px-4 pb-4">
        <div class="h-1 w-full bg-gray-200 rounded overflow-hidden">
          <div class="h-1 bg-green-500 animate-pulse"></div>
        </div>
      </div>
    `;
    
    // Hide actions section during processing
    const actionsSection = document.getElementById('chemistryModalActions');
    if (actionsSection) {
      actionsSection.classList.add('hidden');
    }
  } else {
    // Show completed message without spinner
    modalContent.innerHTML = `
      <div class="text-center py-6">
        ${isError 
          ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-red-500 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
               <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
             </svg>`
          : `<svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-green-500 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
               <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
             </svg>`
        }
        <p class="text-lg ${isError ? 'text-red-700' : 'text-gray-700'}">${message}</p>
      </div>
    `;
  }
}

// Function to generate AI summary for chemistry reviews
async function generateChemistryReviewsSummary(productsWithReviews) {
  try {
    // Select a few documents to analyze (prioritize smaller documents for faster processing)
    const reviewsToAnalyze = [];
    
    // Take up to 2 documents from each product
    productsWithReviews.forEach(product => {
      // Sort by smaller files first (if size info is available)
      const sortedReviews = [...product.reviews].sort((a, b) => {
        const sizeA = a.size || 0;
        const sizeB = b.size || 0;
        return sizeA - sizeB;
      });
      
      // Take up to 2 reviews per product
      reviewsToAnalyze.push(...sortedReviews.slice(0, 2).map(review => ({
        ...review,
        productName: product.brandName,
        applicationNumber: product.applicationNumber
      })));
    });
    
    // Limit overall number of reviews to analyze (to avoid timeout)
    const limitedReviews = reviewsToAnalyze.slice(0, 5);
    
    // Show which reviews are being analyzed with better formatting
    const reviewsList = limitedReviews.map(review => 
      `<li class="text-sm mb-1">${escapeHtml(review.productName)} (${escapeHtml(review.applicationNumber)}): ${escapeHtml(review.name)}</li>`
    ).join('');
    
    updateChemistryReviewsModal(
      `<div class="text-left">
        <p class="mb-3">Analyzing ${limitedReviews.length} chemistry reviews:</p>
        <ul class="list-disc pl-5 text-gray-600">${reviewsList}</ul>
       </div>`,
      true
    );
    
    // Make API call to analyze documents
    const response = await fetch('/api/analyze-chemistry-reviews', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        reviews: limitedReviews
      })
    });
    
    if (!response.ok) {
      throw new Error(`API request failed (${response.status})`);
    }
    
    const result = await response.json();
    
    if (result.error) {
      throw new Error(result.error);
    }
    
    // Format the summary with Tailwind UI styling
    const formattedSummary = formatChemistryReviewsSummary(result.summary, productsWithReviews);
    
    // Update the modal with the formatted summary
    document.getElementById('chemistryModalContent').innerHTML = formattedSummary;
    
    // Show the email button
    const actionsSection = document.getElementById('chemistryModalActions');
    if (actionsSection) {
      actionsSection.classList.remove('hidden');
    }
    
    // Store the summary for email functionality
    const emailButton = document.getElementById('emailChemistryBtn');
    if (emailButton) {
      emailButton.setAttribute('data-summary', JSON.stringify({
        summary: result.summary,
        productCount: productsWithReviews.length,
        reviewCount: productsWithReviews.reduce((total, product) => total + product.reviews.length, 0)
      }));
    }
    
  } catch (error) {
    console.error("Error generating chemistry reviews summary:", error);
    updateChemistryReviewsModal(
      `<div class="text-center">
        <p class="text-lg mb-2">Error generating chemistry reviews summary:</p>
        <p class="text-red-600 text-sm">${escapeHtml(error.message)}</p>
        <p class="mt-4 text-sm">Please try again or contact support if the problem persists.</p>
      </div>`,
      false,
      true
    );
  }
}

// Function to format the chemistry reviews summary
function formatChemistryReviewsSummary(summary, productsWithReviews) {
  // Count total reviews
  const totalReviews = productsWithReviews.reduce((total, product) => total + product.reviews.length, 0);
  
  // Parse the summary content if it's a string
  let summaryContent = summary;
  
  // Create the formatted HTML with Tailwind classes
  let formattedHTML = `
    <div class="chemistry-summary max-h-[70vh] overflow-y-auto px-1">
      <div class="mb-4 bg-green-50 p-4 rounded-lg border border-green-100">
        <h4 class="text-lg font-semibold text-green-800 mb-2">Chemistry Reviews Summary</h4>
        <div class="flex flex-wrap items-center justify-between mb-1">
          <div class="text-sm">
            <span class="font-medium">Products with chemistry reviews:</span> ${productsWithReviews.length}
          </div>
          <div class="text-sm">
            <span class="font-medium">Total reviews found:</span> ${totalReviews}
          </div>
        </div>
      </div>
      
      <div class="mt-4 mb-6">
        <h5 class="text-md font-semibold border-b pb-2 mb-3">Key Findings</h5>
        <div class="pl-4 border-l-2 border-green-200 prose prose-sm max-w-none">
          ${renderMarkdown(summaryContent)}
        </div>
      </div>
      
      <div class="mt-6">
        <h5 class="text-md font-semibold border-b pb-2 mb-3">Products Analyzed</h5>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
  `;
  
  // Add info for each product
  productsWithReviews.forEach(product => {
    formattedHTML += `
      <div class="bg-white border border-gray-200 rounded-md p-3 hover:shadow-sm transition">
        <div class="flex justify-between items-start">
          <div>
            <h6 class="text-sm font-medium">${escapeHtml(product.brandName)}</h6>
            <p class="text-xs text-gray-500">Application: ${escapeHtml(product.applicationNumber)}</p>
          </div>
          <span class="px-2 py-0.5 text-xs rounded-full bg-blue-100 text-blue-800">
            ${product.reviews.length} ${product.reviews.length === 1 ? 'review' : 'reviews'}
          </span>
        </div>
        
        <div class="mt-2">
          <h6 class="text-xs font-medium text-gray-700">Chemistry Documents:</h6>
          <ul class="mt-1 text-xs text-gray-600 space-y-1">
            ${product.reviews.map(review => `
              <li class="flex items-start">
                <svg class="h-3 w-3 text-gray-400 mt-0.5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                ${escapeHtml(review.name)}
              </li>
            `).join('')}
          </ul>
        </div>
      </div>
    `;
  });
  
  formattedHTML += `
        </div>
      </div>
      
      <div class="mt-6 text-xs text-gray-500 bg-gray-50 p-3 rounded">
        <p>This summary was generated using AI analysis of FDA chemistry reviews. The information provided is for reference only and may not capture all details in the original documents.</p>
      </div>
    </div>
  `;
  
  return formattedHTML;
}

function escapeHtml(unsafe) {
  if (!unsafe) return '';
  return unsafe
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}


function renderMarkdown(content) {
  if (!content) {
    return '<p class="my-2">No content available.</p>';
  }
  
  // For a real implementation, you would use a markdown library
  // This is a simple implementation to handle basic markdown elements
  
  // Replace headers
  let html = content
    .replace(/### (.*)/g, '<h3 class="text-md font-semibold mt-4 mb-2">$1</h3>')
    .replace(/#### (.*)/g, '<h4 class="text-sm font-semibold mt-3 mb-1">$1</h4>')
    
    // Replace bold text
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
    
    // Replace lists
    .replace(/^\s*[-*] (.*)/gm, '<li class="ml-4">$1</li>')
    
    // Replace paragraphs (must be after list items)
    .replace(/^(?!<li|<h)[^\n]+$/gm, '<p class="my-2">$&</p>')
    
    // Wrap list items in <ul> tags
    .replace(/<li class="ml-4">(.*?)(?=<h|<p|$)/gs, '<ul class="list-disc pl-5 my-3">$&</ul>');
  
  return html;
}


// Function to handle emailing the chemistry reviews summary
function emailChemistryReviewsSummary() {
  const emailButton = document.getElementById('emailChemistryBtn');
  const summaryData = JSON.parse(emailButton.getAttribute('data-summary') || '{}');
  
  // Show email confirmation dialog
  const emailDialog = document.createElement('div');
  emailDialog.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-60';
  emailDialog.id = 'emailDialog';
  emailDialog.innerHTML = `
    <div class="bg-white rounded-lg shadow-xl w-96 max-w-full">
      <div class="p-4 border-b">
        <h3 class="text-lg font-semibold">Email Chemistry Summary</h3>
      </div>
      
      <div class="p-6">
        <label class="block mb-2 text-sm font-medium text-gray-700">Email Address</label>
        <input type="email" id="emailInput" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="your@email.com">
        
        <div class="mt-4 text-sm text-gray-600">
          <p>A summary of chemistry reviews for ${summaryData.productCount || 0} products will be sent to this email address.</p>
        </div>
      </div>
      
      <div class="border-t p-4 flex justify-end space-x-3">
        <button id="cancelEmailBtn" class="px-4 py-2 bg-gray-100 text-gray-800 rounded hover:bg-gray-200 transition-colors">
          Cancel
        </button>
        <button id="sendEmailBtn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors">
          Send Email
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(emailDialog);
  
  // Add event listeners for the dialog
  document.getElementById('cancelEmailBtn').addEventListener('click', () => {
    document.getElementById('emailDialog').remove();
  });
  
  document.getElementById('sendEmailBtn').addEventListener('click', async () => {
    const emailInput = document.getElementById('emailInput');
    const email = emailInput.value.trim();
    
    if (!email || !email.includes('@')) {
      emailInput.classList.add('border-red-500');
      return;
    }
    
    // Update dialog to show sending status
    const dialogContent = document.querySelector('#emailDialog .p-6');
    dialogContent.innerHTML = `
      <div class="flex justify-center items-center py-6">
        <svg class="animate-spin h-5 w-5 text-blue-500 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span>Sending email...</span>
      </div>
    `;
    
    // Hide the buttons
    document.querySelector('#emailDialog .p-4.flex').style.display = 'none';
    
    try {
      // Simulate API call to send email
      await new Promise(resolve => setTimeout(resolve, 1500));
      
      // Update dialog to show success
      dialogContent.innerHTML = `
        <div class="text-center py-6">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-green-500 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <p class="text-lg text-gray-700">Email sent successfully!</p>
          <p class="text-sm text-gray-500 mt-2">A summary has been sent to ${email}</p>
          <button id="closeEmailDialogBtn" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors">
            Close
          </button>
        </div>
      `;
      
      document.getElementById('closeEmailDialogBtn').addEventListener('click', () => {
        document.getElementById('emailDialog').remove();
      });
      
    } catch (error) {
      // Show error
      dialogContent.innerHTML = `
        <div class="text-center py-6">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-red-500 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <p class="text-lg text-red-700">Failed to send email</p>
          <p class="text-sm text-gray-500 mt-2">${error.message || 'An error occurred'}</p>
          <button id="closeEmailDialogBtn" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors">
            Close
          </button>
        </div>
      `;
      
      document.getElementById('closeEmailDialogBtn').addEventListener('click', () => {
        document.getElementById('emailDialog').remove();
      });
    }
  });
}

// // Initialize by adding the Chemistry Reviews button
// document.addEventListener('DOMContentLoaded', function() {
//   // Add a mutation observer to check for the applications content
//   const observer = new MutationObserver((mutations) => {
//     if (document.getElementById('applications-content')) {
     
//       observer.disconnect();
//     }
//   });
  
//   // Start observing the document body for changes
//   observer.observe(document.body, { childList: true, subtree: true });
  
//   // Also check immediately in case the element already exists
//   if (document.getElementById('applications-content')) {
//     addChemistryReviewsButton();
//   }
// });




async function displayFdaClinicalData(condition) {
  // Initialize the FDA data section
  initFdaDataSection();
  
  // Show loading state
  const loadingTemplate = `
    <div class="flex justify-center items-center py-8">
      <svg class="animate-spin h-8 w-8 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      <span class="ml-2 text-gray-600">Loading clinical FDA data for ${condition}...</span>
    </div>
  `;
  
  elements.fdaDocuments.innerHTML = loadingTemplate;
  elements.orangeBookData.innerHTML = loadingTemplate;
  elements.dailyMedData.innerHTML = loadingTemplate;
  elements.warningLettersData.innerHTML = loadingTemplate;
  try {
    // if (!condition) {
    //   alert('Please enter a clinical condition to search.');
    //   return;
    // }

    // Fetch FDA data by condition
    const fdaResponse = await fetch(`/api/fda/condition/${encodeURIComponent(condition)}`);
    const fdaData = await fdaResponse.json();
    
    if (fdaResponse.ok && !fdaData.error) {
      // Display the comprehensive FDA data for the condition
      displayComprehensiveFdaData(fdaData, condition);
    } else {
      elements.fdaDocuments.innerHTML = createErrorMessage("Could not retrieve FDA data");
    }
    
    // Continue with existing Orange Book and DailyMed fetches
    const orangeBookResponse = await fetch(`/api/fda/orangebook/search?q=${encodeURIComponent(condition)}`);
    const orangeBookData = await orangeBookResponse.json();
    const companies = orangeBookData.results.companies || [];


    if (orangeBookResponse.ok && !orangeBookData.error) {
      displayOrangeBookData(orangeBookData);
          // Fetch warning letters
          await fetchWarningLetters(companies);
    } else {
      elements.orangeBookData.innerHTML = createErrorMessage("Could not retrieve Orange Book data");
    }
    
    const dailyMedResponse = await fetch(`/api/fda/dailymed/${encodeURIComponent(condition)}`);
    const dailyMedData = await dailyMedResponse.json();
    
    if (dailyMedResponse.ok && !dailyMedData.error) {
      displayDailyMedData(dailyMedData);
    } else {
      elements.dailyMedData.innerHTML = createErrorMessage("Could not retrieve DailyMed data");
    }
    

    
  } catch (error) {
    console.error("Error fetching FDA data:", error);
    elements.fdaDocuments.innerHTML = createErrorMessage("Error fetching FDA data");
    elements.orangeBookData.innerHTML = createErrorMessage("Error fetching FDA data");
    elements.dailyMedData.innerHTML = createErrorMessage("Error fetching FDA data");
    elements.warningLettersData.innerHTML = createErrorMessage("Error fetching FDA data");
  }
}



// New function to display comprehensive FDA data
function displayComprehensiveFdaData(fdaData, drugName) {
  // Check if we have valid data
  if (!fdaData || (!fdaData.raw && !fdaData.categorized) || (Object.keys(fdaData.categorized).length === 0 && (!fdaData.raw.combinedResults || fdaData.raw.combinedResults.length === 0))) {
    elements.fdaDocuments.innerHTML = `
      <div class="text-center p-4">
        <p class="text-sm text-gray-700">No FDA data found for "${drugName}"</p>
      </div>
    `;
    elements.fdaDocCount.textContent = "0 documents";
    return;
  }
  
  // Extract endpoint data
  const endpointsData = fdaData.raw?.endpoints || {};
  
  // Count total entries for the counter
  const totalDocuments = 
    (endpointsData.drugsFda?.count || 0) + 
    (endpointsData.label?.count || 0) + 
    (endpointsData.ndc?.count || 0) + 
    (endpointsData.enforcement?.count || 0) + 
    (endpointsData.event?.count || 0);
  
  // Update the counter
  elements.fdaDocCount.textContent = `${totalDocuments} documents`;
  
  // Create HTML for the FDA data
  let html = `
    <div class="mb-4 border-b border-gray-200">
      <ul class="flex flex-wrap -mb-px text-sm font-medium text-center" role="tablist">
        <li class="mr-2" role="presentation">
          <button class="fda-tab-button inline-block p-4 border-b-2 border-blue-500 rounded-t-lg active text-blue-600" 
                  id="applications-tab" 
                  data-tab="applications-content"
                  aria-selected="true">
            Drug Applications 
          </button>
        </li>
        <li class="mr-2" role="presentation">
          <button class="fda-tab-button inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300" 
                  id="label-tab" 
                  data-tab="label-content"
                  aria-selected="false">
            Labeling 
          </button>
        </li>
        <li class="mr-2" role="presentation">
          <button class="fda-tab-button inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300" 
                  id="ndc-tab" 
                  data-tab="ndc-content"
                  aria-selected="false">
            NDC 
          </button>
        </li>
        <li class="mr-2" role="presentation">
          <button class="fda-tab-button inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300" 
                  id="events-tab" 
                  data-tab="events-content"
                  aria-selected="false">
            Adverse Events 
          </button>
        </li>
        <li role="presentation">
          <button class="fda-tab-button inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300" 
                  id="enforcement-tab" 
                  data-tab="enforcement-content"
                  aria-selected="false">
            Enforcement 
          </button>
        </li>
      </ul>
    </div>
    
    <div class="tab-content">
  `;
  
  // Add Applications Tab Content
  html += `
    <div id="applications-content" class="fda-tab-pane active">
  `;
  
  // Process categorized drug application data
  if (Object.keys(fdaData.categorized).length > 0) {
    // Collect all products into a flat array for easier pagination
    let allProducts = [];
    Object.entries(fdaData.categorized).forEach(([brandName, strengths]) => {
      Object.entries(strengths).forEach(([strength, products]) => {
        products.forEach(product => {
          allProducts.push({
            ...product,
            strength
          });
        });
      });
    });
    
    // Add products grid
    html += `<div class="grid grid-cols-1 md:grid-cols-3 gap-4">`;
    
    for (const product of allProducts.slice(0, 9)) { // Show top 9 products
      html += `
        <div class="bg-white border border-gray-200 rounded-md shadow-sm hover:shadow-md transition-shadow">
          <div class="p-3">
            <div class="flex justify-between items-start">
              <div class="truncate pr-2">
                <h4 class="text-sm font-semibold truncate">${product.brandName}</h4>
                <p class="text-xs text-gray-600">${product.strength}</p>
              </div>
              <span class="px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded-full whitespace-nowrap">
                ${product.applicationNumber}
              </span>
            </div>
            
            <div class="mt-2 text-xs">
              <p><span class="font-medium">Approved:</span> ${product.approvalDate}</p>
              <p class="truncate"><span class="font-medium">Manufacturer:</span> ${product.manufacturerName || product.sponsorName}</p>
              <p class="truncate"><span class="font-medium">Form:</span> ${product.dosageForm}</p>
            </div>
            
            <div class="mt-2 flex justify-end">
              <button
                class="px-2 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 transition-colors view-details-btn"
                data-application="${product.applicationNumber}"
                data-brand="${product.brandName}"
                data-ingredient="${product.activeIngredients?.[0]?.name || drugName}"
              >
                Details
              </button>
            </div>
          </div>
        </div>
      `;
    }
    
    html += `</div>`;
    addChemistryReviewsButton();

    // Add "Show All" button if there are more than 9 products
    if (allProducts.length > 9) {
      html += `
        <div class="mt-4 text-center">
          <button id="view-all-applications" class="px-4 py-2 bg-gray-100 text-gray-800 border border-gray-300 rounded hover:bg-gray-200 transition-colors text-sm">
            View All ${allProducts.length} Applications
          </button>
        </div>
      `;
    }
  } else {
    html += `
      <div class="text-center p-4">
        <p class="text-sm text-gray-700">No drug application data found for "${drugName}"</p>
      </div>
    `;
  }
  
  html += `</div>`;
  
  // Add Labeling Tab Content
  html += `
    <div id="label-content" class="fda-tab-pane hidden">
  `;
  
  const labelData = endpointsData.label?.data || [];
  if (labelData.length > 0) {
    html += `<div class="space-y-4">`;
    
    labelData.slice(0, 3).forEach(label => {
      const brandName = label.openfda?.brand_name?.[0] || 'Unknown Brand';
      const genericName = label.openfda?.generic_name?.[0] || 'Unknown Generic';
      const manufacturerName = label.openfda?.manufacturer_name?.[0] || 'Unknown Manufacturer';
      
      html += `
        <div class="bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden">
          <div class="p-4 border-b border-gray-200 bg-gray-50">
            <div class="flex justify-between items-center">
              <h3 class="text-lg font-medium text-gray-900">${brandName}</h3>
              <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">
                ${genericName}
              </span>
            </div>
            <p class="mt-1 text-sm text-gray-600">Manufacturer: ${manufacturerName}</p>
          </div>
          
          <div class="p-4">
            <div class="mb-4">
              <h4 class="text-sm font-medium text-gray-700 mb-1">Indications and Usage:</h4>
              <div class="text-sm text-gray-600 max-h-24 overflow-y-auto p-2 bg-gray-50 rounded">
                ${label.indications_and_usage?.[0] || 'Not provided'}
              </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <h4 class="text-sm font-medium text-gray-700 mb-1">Dosage Forms and Strengths:</h4>
                <div class="text-sm text-gray-600 max-h-20 overflow-y-auto p-2 bg-gray-50 rounded">
                  ${label.dosage_forms_and_strengths?.[0] || 'Not provided'}
                </div>
              </div>
              
              <div>
                <h4 class="text-sm font-medium text-gray-700 mb-1">Route of Administration:</h4>
                <div class="text-sm text-gray-600 max-h-20 overflow-y-auto p-2 bg-gray-50 rounded">
                  ${label.openfda?.route?.[0] || 'Not provided'}
                </div>
              </div>
            </div>
            
            <button 
              class="mt-4 px-3 py-1.5 bg-blue-50 text-blue-600 border border-blue-100 rounded text-sm hover:bg-blue-100 transition view-label-btn" 
              data-index="${labelData.indexOf(label)}">
              View Full Label Details
            </button>
          </div>
        </div>
      `;
    });
    
    html += `</div>`;
    
    // Add "Show All" button if there are more than 3 labels
    if (labelData.length > 3) {
      html += `
        <div class="mt-4 text-center">
          <button id="view-all-labels" class="px-4 py-2 bg-gray-100 text-gray-800 border border-gray-300 rounded hover:bg-gray-200 transition-colors text-sm">
            View All ${labelData.length} Labels
          </button>
        </div>
      `;
    }
  } else {
    html += `
      <div class="text-center p-4">
        <p class="text-sm text-gray-700">No labeling information found for "${drugName}"</p>
      </div>
    `;
  }
  
  html += `</div>`;
  
  // Add NDC Tab Content
  html += `
    <div id="ndc-content" class="fda-tab-pane hidden">
  `;
  
  const ndcData = endpointsData.ndc?.data || [];
  if (ndcData.length > 0) {
    html += `
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NDC</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Form</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Route</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Labeler</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
    `;
    
    ndcData.forEach(ndc => {
      html += `
        <tr>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="flex items-center">
              <div>
                <div class="text-sm font-medium text-gray-900">${ndc.brand_name || ndc.generic_name || 'Unknown'}</div>
                <div class="text-sm text-gray-500">${ndc.generic_name || ''}</div>
              </div>
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${ndc.product_ndc || 'N/A'}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${ndc.dosage_form || 'N/A'}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${ndc.route?.[0] || 'N/A'}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${ndc.labeler_name || 'N/A'}</td>
          <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
            <button class="text-blue-600 hover:text-blue-900 view-ndc-btn" data-index="${ndcData.indexOf(ndc)}">Details</button>
          </td>
        </tr>
      `;
    });
    
    html += `
          </tbody>
        </table>
      </div>
    `;
  } else {
    html += `
      <div class="text-center p-4">
        <p class="text-sm text-gray-700">No NDC information found for "${drugName}"</p>
      </div>
    `;
  }
  
  html += `</div>`;

  // Add Adverse Events Tab Content
  html += `
  <div id="events-content" class="fda-tab-pane hidden">
`;

const eventData = endpointsData.event?.data || [];
if (eventData.length > 0) {
  // Create a summary chart of adverse event types with fixed height
//   html += `
//     <div class="bg-white p-4 rounded-lg shadow-sm mb-4">
//       <div id="adverse-events-chart" style="height: 300px; min-height: 300px;"></div>
//     </div>
//   `;
  
  // Add a list of recent adverse events
  html += `
    <h3 class="text-lg font-medium text-gray-900 mb-2">Recent Reports</h3>
    <div class="space-y-3">
  `;
  
  eventData.slice(0, 5).forEach(event => {
    const reportDate = event.receiptdate || 'Unknown Date';
    const seriousness = event.serious ? 'Serious' : 'Non-serious';
    
    // Find the relevant drug in the report
    const drugReports = event.patient?.drug || [];
    const drugInfo = drugReports.find(drug => 
      drug.openfda?.brand_name?.[0]?.toLowerCase().includes(drugName.toLowerCase()) ||
      drug.openfda?.generic_name?.[0]?.toLowerCase().includes(drugName.toLowerCase()) ||
      (drug.medicinalproduct || '').toLowerCase().includes(drugName.toLowerCase())
    ) || drugReports[0] || {};
    
    // Get reactions
    const reactions = event.patient?.reaction || [];
    const reactionsList = reactions.map(r => r.reactionmeddrapt || 'Unknown reaction').join(', ');
    
    html += `
      <div class="bg-white border border-gray-200 rounded-md p-3 hover:shadow-sm transition">
        <div class="flex justify-between items-start">
          <div>
            <h4 class="text-sm font-medium text-gray-900">
              ${drugInfo.medicinalproduct || drugInfo.openfda?.brand_name?.[0] || 'Unknown Drug'}
            </h4>
            <p class="text-xs text-gray-500">Report Date: ${formatDate(reportDate)}</p>
          </div>
          <span class="px-2 py-0.5 text-xs rounded-full ${event.serious ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800'}">
            ${seriousness}
          </span>
        </div>
        
        <div class="mt-2">
          <h5 class="text-xs font-medium text-gray-700">Reported Reactions:</h5>
          <p class="text-xs text-gray-600 mt-1">${reactionsList || 'None reported'}</p>
        </div>
        
        <button 
          class="mt-2 text-xs text-blue-600 hover:text-blue-800 view-event-btn" 
          data-index="${eventData.indexOf(event)}">
          View Full Report
        </button>
      </div>
    `;
  });
  
  html += `</div>`;
  
  // Add "Show All" button if there are more than 5 events
  if (eventData.length > 5) {
    html += `
      <div class="mt-4 text-center">
        <button id="view-all-events" class="px-4 py-2 bg-gray-100 text-gray-800 border border-gray-300 rounded hover:bg-gray-200 transition-colors text-sm">
          View All ${eventData.length} Adverse Event Reports
        </button>
      </div>
    `;
  }
} else {
  html += `
    <div class="text-center p-4">
      <p class="text-sm text-gray-700">No adverse event information found for "${drugName}"</p>
    </div>
  `;
}

html += `</div>`;

  
  // Add Enforcement Tab Content
  html += `
    <div id="enforcement-content" class="fda-tab-pane hidden">
  `;
  
  const enforcementData = endpointsData.enforcement?.data || [];
  if (enforcementData.length > 0) {
    // Create a timeline of enforcement actions
    html += `
      <div class="mb-4">
        <h3 class="text-lg font-medium text-gray-900 mb-2">Enforcement Timeline</h3>
        <div class="relative">
          <div class="absolute h-full w-0.5 bg-gray-200 left-6 top-0"></div>
          <div class="space-y-6 relative">
    `;
    
    enforcementData.forEach(report => {
      const date = report.recall_initiation_date || 'Unknown Date';
      const reason = report.reason_for_recall || 'Not specified';
      const status = report.status || 'Unknown Status';
      const classification = report.classification || 'Unknown Classification';
      
      // Determine the severity badge color based on classification
      let classificationColor = 'bg-gray-100 text-gray-800';
      if (classification.includes('Class I')) {
        classificationColor = 'bg-red-100 text-red-800';
      } else if (classification.includes('Class II')) {
        classificationColor = 'bg-yellow-100 text-yellow-800';
      } else if (classification.includes('Class III')) {
        classificationColor = 'bg-green-100 text-green-800';
      }
      
      html += `
        <div class="pl-12 relative">
          <div class="absolute rounded-full w-6 h-6 flex items-center justify-center bg-blue-500 text-white left-3 top-0 -ml-3">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
            </svg>
          </div>
          
          <div class="bg-white rounded-lg border border-gray-200 p-3 shadow-sm">
            <div class="flex justify-between items-start">
              <div>
                <span class="text-xs text-gray-500">${formatDate(date)}</span>
                <h4 class="text-sm font-medium text-gray-900 mt-0.5">${report.product_description || 'Unknown Product'}</h4>
              </div>
              <span class="px-2 py-0.5 text-xs rounded-full ${classificationColor}">
                ${classification}
              </span>
            </div>
            
            <div class="mt-2">
              <div class="text-xs">
                <span class="font-medium">Reason:</span> ${truncateText(reason, 100)}
              </div>
              <div class="text-xs mt-1">
                <span class="font-medium">Status:</span> ${status}
              </div>
              <div class="text-xs mt-1">
                <span class="font-medium">Recall Number:</span> ${report.recall_number || 'N/A'}
              </div>
            </div>
            
            <button 
              class="mt-2 text-xs text-blue-600 hover:text-blue-800 view-enforcement-btn" 
              data-index="${enforcementData.indexOf(report)}">
              View Details
            </button>
          </div>
        </div>
      `;
    });
    
    html += `
          </div>
        </div>
      </div>
    `;
  } else {
    html += `
      <div class="text-center p-4">
        <p class="text-sm text-gray-700">No enforcement actions found for "${drugName}"</p>
      </div>
    `;
  }
  
  html += `</div>`;
  
  // Close main tab content div
  html += `</div>`;
  
  // Add the HTML to the page
  elements.fdaDocuments.innerHTML = html;
  
  // addChemistryReviewsButton();


  // Initialize tab switching
  document.querySelectorAll('.fda-tab-button').forEach(button => {
    button.addEventListener('click', function() {
      const tabId = this.getAttribute('data-tab');
      
      // Hide all tab panes
      document.querySelectorAll('.fda-tab-pane').forEach(pane => {
        pane.classList.add('hidden');
        pane.classList.remove('active');
      });
      
      // Deactivate all tab buttons
      document.querySelectorAll('.fda-tab-button').forEach(btn => {
        btn.classList.remove('border-blue-500', 'text-blue-600');
        btn.classList.add('border-transparent', 'hover:text-gray-600', 'hover:border-gray-300');
        btn.setAttribute('aria-selected', 'false');
      });
      
      // Activate the clicked tab
      document.getElementById(tabId).classList.remove('hidden');
      document.getElementById(tabId).classList.add('active');
      
      // Activate the clicked tab button
      this.classList.remove('border-transparent', 'hover:text-gray-600', 'hover:border-gray-300');
      this.classList.add('border-blue-500', 'text-blue-600');
      this.setAttribute('aria-selected', 'true');
      
// If it's the adverse events tab, initialize the chart with the updated function
    // if (tabId === 'events-content' && document.getElementById('adverse-events-chart')) {
    //   // Use the fixed chart implementation
    //   initializeAdverseEventsChart(endpointsData.event?.data || []);
    // }
  });
});
  
  // Add event listeners for "View Details" buttons
  document.querySelectorAll('.view-details-btn').forEach(button => {
    button.addEventListener('click', function() {
      const applicationNumber = this.getAttribute('data-application');
      const brandName = this.getAttribute('data-brand');
      const ingredient = this.getAttribute('data-ingredient');
      openDetailsModal(applicationNumber, brandName, ingredient);
    });
  });
  
  // Add event listeners for "View Label Details" buttons
  document.querySelectorAll('.view-label-btn').forEach(button => {
    button.addEventListener('click', function() {
      const index = parseInt(this.getAttribute('data-index'));
      const labelData = endpointsData.label?.data || [];
      if (labelData[index]) {
        openLabelModal(labelData[index]);
      }
    });
  });
  
  // Add event listeners for NDC details buttons
// Add event listeners for NDC details buttons (continued)
document.querySelectorAll('.view-ndc-btn').forEach(button => {
    button.addEventListener('click', function() {
      const index = parseInt(this.getAttribute('data-index'));
      const ndcData = endpointsData.ndc?.data || [];
      if (ndcData[index]) {
        openNdcModal(ndcData[index]);
      }
    });
  });
  
  // Add event listeners for adverse event details buttons
  document.querySelectorAll('.view-event-btn').forEach(button => {
    button.addEventListener('click', function() {
      const index = parseInt(this.getAttribute('data-index'));
      const eventData = endpointsData.event?.data || [];
      if (eventData[index]) {
        openAdverseEventModal(eventData[index]);
      }
    });
  });
  
  // Add event listeners for enforcement details buttons
  document.querySelectorAll('.view-enforcement-btn').forEach(button => {
    button.addEventListener('click', function() {
      const index = parseInt(this.getAttribute('data-index'));
      const enforcementData = endpointsData.enforcement?.data || [];
      if (enforcementData[index]) {
        openEnforcementModal(enforcementData[index]);
      }
    });
  });
  
  // Add event listeners for "View All" buttons
  document.getElementById('view-all-applications')?.addEventListener('click', function() {
    openAllApplicationsModal(fdaData.categorized, drugName);
  });
  
  document.getElementById('view-all-labels')?.addEventListener('click', function() {
    openAllLabelsModal(endpointsData.label?.data || []);
  });
  
  document.getElementById('view-all-events')?.addEventListener('click', function() {
    openAllEventsModal(endpointsData.event?.data || [], drugName);
  });
  
  // Initialize adverse events chart if data exists
  if (endpointsData.event?.data && endpointsData.event.data.length > 0 && document.getElementById('adverse-events-chart')) {
    // We'll initialize the chart when the tab is clicked
  }
}

// Function to initialize adverse events chart
// Function to initialize adverse events chart with proper heights
// function initializeAdverseEventsChart(eventData) {
//   if (!eventData || eventData.length === 0 || !document.getElementById('adverse-events-chart')) {
//     return;
//   }
  
//   // Count the types of reactions
//   const reactionCounts = {};
  
//   eventData.forEach(event => {
//     const reactions = event.patient?.reaction || [];
    
//     reactions.forEach(reaction => {
//       const reactionName = reaction.reactionmeddrapt || 'Unknown';
//       if (!reactionCounts[reactionName]) {
//         reactionCounts[reactionName] = 0;
//       }
//       reactionCounts[reactionName]++;
//     });
//   });
  
//   // Sort and take top 10 reactions
//   const sortedReactions = Object.entries(reactionCounts)
//     .sort((a, b) => b[1] - a[1])
//     .slice(0, 10);
  
//   // Prepare chart data
//   const labels = sortedReactions.map(([name]) => name);
//   const counts = sortedReactions.map(([, count]) => count);
  
//   // Calculate the maximum count for scaling
//   const maxCount = Math.max(...counts);
  
//   // Create a proper bar chart with specific heights
//   let chartHtml = `
//     <div class="flex flex-col h-full">
//       <h4 class="text-sm font-medium text-gray-700 mb-4">Top 10 Reported Reactions</h4>
//       <div class="flex-1 flex flex-col">
//   `;
  
//   // Create chart container with grid for bars
//   chartHtml += `
//     <div class="flex-1 relative">
//       <!-- Y-axis labels -->
//       <div class="absolute left-0 top-0 bottom-0 w-10 flex flex-col justify-between text-xs text-gray-500 pr-2">
//         <div>${maxCount}</div>
//         <div>${Math.round(maxCount * 0.75)}</div>
//         <div>${Math.round(maxCount * 0.5)}</div>
//         <div>${Math.round(maxCount * 0.25)}</div>
//         <div>0</div>
//       </div>
      
//       <!-- Grid lines -->
//       <div class="absolute left-10 right-0 top-0 bottom-0">
//         <div class="absolute left-0 right-0 h-px bg-gray-200" style="top: 0%"></div>
//         <div class="absolute left-0 right-0 h-px bg-gray-200" style="top: 25%"></div>
//         <div class="absolute left-0 right-0 h-px bg-gray-200" style="top: 50%"></div>
//         <div class="absolute left-0 right-0 h-px bg-gray-200" style="top: 75%"></div>
//         <div class="absolute left-0 right-0 h-px bg-gray-200" style="top: 100%"></div>
//       </div>
      
//       <!-- Bars -->
//       <div class="absolute left-12 right-2 top-0 bottom-8 flex items-end justify-around">
//   `;
  
//   // Add each bar
//   for (let i = 0; i < labels.length; i++) {
//     const percentage = (counts[i] / maxCount) * 100;
    
//     chartHtml += `
//       <div class="flex flex-col items-center group" style="height: 100%;">
//         <div class="text-xs text-gray-600 mb-1 opacity-0 group-hover:opacity-100 transition-opacity">
//           ${counts[i]}
//         </div>
//         <div class="w-12 bg-blue-500 rounded-t transition-all hover:bg-blue-600" 
//              style="height: ${percentage}%; min-height: 4px;"></div>
//       </div>
//     `;
//   }
  
//   // Close bars container
//   chartHtml += `
//       </div>
      
//       <!-- X-axis labels -->
//       <div class="absolute left-12 right-2 bottom-0 h-8 flex justify-around">
//   `;
  
//   // Add X-axis labels
//   for (let i = 0; i < labels.length; i++) {
//     chartHtml += `
//       <div class="text-xs text-gray-600 transform -rotate-45 origin-top-left overflow-hidden whitespace-nowrap w-12 truncate" 
//            title="${labels[i]}">
//         ${truncateText(labels[i], 15)}
//       </div>
//     `;
//   }
  
//   // Close X-axis container and rest of the chart
//   chartHtml += `
//       </div>
//     </div>
//   </div>
// </div>
//   `;
  
//   document.getElementById('adverse-events-chart').innerHTML = chartHtml;
// }

function initializeAdverseEventsChart(eventData) {
  // Check if data and DOM element exist
  const chartContainer = document.getElementById('adverse-events-chart');
  if (!eventData || eventData.length === 0 || !chartContainer) {
    if (chartContainer) {
      chartContainer.innerHTML = `
        <div class="flex items-center justify-center h-64 bg-gray-50 rounded border border-gray-200">
          <p class="text-gray-500">No adverse event data available</p>
        </div>
      `;
    }
    return;
  }
  
  // Count reaction types
  const reactionCounts = {};
  
  eventData.forEach(event => {
    const reactions = event.patient?.reaction || [];
    
    reactions.forEach(reaction => {
      const reactionName = reaction.reactionmeddrapt || 'Unknown';
      reactionCounts[reactionName] = (reactionCounts[reactionName] || 0) + 1;
    });
  });
  
  // Sort and take top 10 reactions
  const sortedReactions = Object.entries(reactionCounts)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 10);
  
  // Prepare chart data
  const labels = sortedReactions.map(([name]) => name);
  const counts = sortedReactions.map(([, count]) => count);
  
  // Calculate the maximum count for scaling
  const maxCount = Math.max(...counts);
  const chartHeight = 280; // Fixed chart height
  
  // Create chart HTML with flexbox layout
  let chartHtml = `
    <div class="flex flex-col h-full rounded-lg border border-gray-200 bg-white p-4 shadow-sm">
      <h4 class="text-sm font-semibold text-gray-800 mb-4">Top 10 Reported Adverse Reactions</h4>
      
      <!-- Chart container -->
      <div class="flex flex-1" style="min-height: ${chartHeight}px;">
        
        <!-- Y-axis labels -->
        <div class="flex flex-col justify-between pr-2 text-xs text-gray-500">
          <div>${maxCount}</div>
          <div>${Math.round(maxCount * 0.75)}</div>
          <div>${Math.round(maxCount * 0.5)}</div>
          <div>${Math.round(maxCount * 0.25)}</div>
          <div>0</div>
        </div>
        
        <!-- Chart grid and bars -->
        <div class="flex-1 relative">
          <!-- Grid lines -->
          <div class="absolute left-0 right-0 top-0 bottom-8 flex flex-col justify-between">
            <div class="border-b border-gray-200 w-full"></div>
            <div class="border-b border-gray-200 w-full"></div>
            <div class="border-b border-gray-200 w-full"></div>
            <div class="border-b border-gray-200 w-full"></div>
            <div class="border-b border-gray-200 w-full"></div>
          </div>
          
          <!-- Bars container -->
          <div class="absolute left-0 right-0 top-0 bottom-8 flex items-end justify-around">
  `;
  
  // Add each bar with proper spacing and hover effect
  // Fix: Don't use Tailwind's dynamic class generation for width - use inline style instead
  
  for (let i = 0; i < labels.length; i++) {
    const percentage = (counts[i] / maxCount) * 100;
    const barWidthPx = Math.min(40, Math.floor(100 / labels.length) - 4);
    
    chartHtml += `
      <div class="flex flex-col items-center group" style="height: 100%;">
        <!-- Count tooltip -->
        <div class="px-2 py-1 bg-gray-800 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity mb-1">
          ${counts[i]}
        </div>
        
        <!-- Bar - using inline style for width instead of Tailwind class -->
        <div class="bg-blue-500 hover:bg-blue-600 transition-colors rounded-t" 
             style="width: ${barWidthPx}px; height: ${percentage}%; min-height: 4px;"></div>
      </div>
    `;
  }
  
  // Close bars container
  chartHtml += `
          </div>
          
          <!-- X-axis labels with proper truncation -->
          <div class="absolute left-0 right-0 bottom-0 flex justify-around">
  `;
  
  // Add X-axis labels with better handling
  for (let i = 0; i < labels.length; i++) {
    const displayLabel = truncateText(labels[i], 12);
    const labelWidthPx = Math.min(40, Math.floor(100 / labels.length) - 4) + 10;
    
    chartHtml += `
      <div class="text-xs text-gray-600 text-center" style="max-width: ${labelWidthPx}px;" title="${labels[i]}">
        ${displayLabel}
      </div>
    `;
  }
  
  // Close the chart
  chartHtml += `
          </div>
        </div>
      </div>
      
      <!-- Legend or additional info -->
      <div class="mt-4 text-xs text-gray-500 text-center">
        Based on ${eventData.length} reported cases
      </div>
    </div>
  `;
  
  // Set the HTML content
  chartContainer.innerHTML = chartHtml;
}

// Helper function to truncate text with ellipsis
function truncateText(text, maxLength) {
  if (!text) return '';
  return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
}

// Alternative implementation using HTML Canvas for more precise control
function initializeAdverseEventsCanvasChart(eventData) {
  if (!eventData || eventData.length === 0) {
    return;
  }
  
  const chartContainer = document.getElementById('adverse-events-chart');
  if (!chartContainer) return;
  
  // Clear previous content
  chartContainer.innerHTML = '';
  
  // Create canvas element
  const canvas = document.createElement('canvas');
  canvas.id = 'adverse-events-canvas';
  canvas.style.width = '100%';
  canvas.style.height = '100%';
  chartContainer.appendChild(canvas);
  
  // Add title above the chart
  const titleDiv = document.createElement('div');
  titleDiv.className = 'text-sm font-medium text-gray-700 mb-2';
  titleDiv.textContent = 'Top 10 Reported Reactions';
  chartContainer.insertBefore(titleDiv, canvas);
  
  // Count reactions
  const reactionCounts = {};
  eventData.forEach(event => {
    const reactions = event.patient?.reaction || [];
    reactions.forEach(reaction => {
      const name = reaction.reactionmeddrapt || 'Unknown';
      reactionCounts[name] = (reactionCounts[name] || 0) + 1;
    });
  });
  
  // Sort and get top 10
  const sortedReactions = Object.entries(reactionCounts)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 10);
  
  // Prepare data for chart
  const labels = sortedReactions.map(([name]) => name);
  const data = sortedReactions.map(([, count]) => count);
  
  // Check if Chart.js is available - if not, load it
  if (typeof Chart === 'undefined') {
    // If Chart.js isn't available, create a simple visual instead
    createSimpleBarChart(chartContainer, labels, data);
    return;
  }
  
  // Create Chart.js chart
  new Chart(canvas.getContext('2d'), {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Reported Reactions',
        data: data,
        backgroundColor: 'rgba(59, 130, 246, 0.8)',
        borderColor: 'rgba(59, 130, 246, 1)',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'Count'
          }
        },
        x: {
          ticks: {
            maxRotation: 45,
            minRotation: 45
          }
        }
      },
      plugins: {
        tooltip: {
          callbacks: {
            title: function(tooltipItems) {
              return tooltipItems[0].label;
            }
          }
        },
        legend: {
          display: false
        }
      }
    }
  });
}


function createSimpleBarChart(outcome, canvas, interpretationContainer) {
    const groups = outcome.groups || [];
    const colors = ['#3B82F6', '#10B981', '#F05252', '#8B5CF6', '#F59E0B', '#EC4899'];
    
    if (!groups.length) return;
    
    // Get values for each group
    const groupData = [];
    
    // Try to find values from any structure
    if (outcome.classes && outcome.classes.length > 0) {
        for (const cls of outcome.classes) {
            if (cls.categories && cls.categories.length > 0) {
                for (const cat of cls.categories) {
                    if (cat.measurements && cat.measurements.length > 0) {
                        for (const measurement of cat.measurements) {
                            const value = parseFloat(measurement.value);
                            if (!isNaN(value)) {
                                const group = groups.find(g => g.id === measurement.groupId);
                                if (group) {
                                    groupData.push({
                                        group: group.title,
                                        value: value
                                    });
                                }
                            }
                        }
                    }
                }
            }
        }
    }
    
    // Check if we have data to display
    if (groupData.length === 0) {
        // Handle empty data case
        interpretationContainer.innerHTML = `
            <p class="font-semibold">No outcome data available</p>
            <p class="text-xs text-gray-500">${outcome.title || 'Outcome measure'}</p>
        `;
        return;
    }
    
    // Set up chart configuration
    const config = {
        type: 'bar',
        data: {
            labels: groupData.map(d => d.group),
            datasets: [{
                label: outcome.title,
                data: groupData.map(d => d.value),
                backgroundColor: groupData.map((_, i) => colors[i % colors.length]),
                borderColor: groupData.map((_, i) => colors[i % colors.length]),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: sanitizeTitle(outcome.title),
                    font: {
                        size: 14,
                        weight: 'bold'
                    }
                },
                subtitle: {
                    display: true,
                    text: `Time Frame: ${outcome.timeFrame || 'Not specified'}`,
                    font: {
                        size: 12,
                        style: 'italic'
                    }
                },
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: outcome.unitOfMeasure || 'Value',
                        font: {
                            weight: 'bold'
                        }
                    }
                }
            }
        }
    };
    
    // Add interpretation
    const message = `<p class="font-semibold">Outcome Summary:</p>
                    <p>${outcome.title}</p>
                    <p class="text-xs text-gray-500 mt-1">${outcome.description || ''}</p>
                    <ul class="mt-2">
                        ${groupData.map(d => `<li>${d.group}: ${d.value} ${outcome.unitOfMeasure || ''}</li>`).join('')}
                    </ul>`;
    
    interpretationContainer.innerHTML = message;
    
    // Create the chart
    const chart = new Chart(canvas, config);
    canvas._chart = chart;
}


// Fallback simple bar chart if Chart.js is not available
// function createSimpleBarChart(container, labels, data) {
//   const maxValue = Math.max(...data);
  
//   // Add chart container
//   const chartDiv = document.createElement('div');
//   chartDiv.className = 'flex h-64 items-end space-x-2 pt-5 mt-2';
  
//   // Create bars
//   labels.forEach((label, i) => {
//     const height = (data[i] / maxValue) * 100;
    
//     const barContainer = document.createElement('div');
//     barContainer.className = 'flex flex-col items-center flex-1';
    
//     const valueLabel = document.createElement('div');
//     valueLabel.className = 'text-xs text-gray-600 mb-1';
//     valueLabel.textContent = data[i];
    
//     const bar = document.createElement('div');
//     bar.className = 'w-full bg-blue-500 rounded-t hover:bg-blue-600 transition';
//     bar.style.height = `${height}%`;
//     bar.style.minHeight = '4px';
    
//     const nameLabel = document.createElement('div');
//     nameLabel.className = 'text-xs text-gray-600 mt-1 truncate w-full text-center';
//     nameLabel.textContent = truncateText(label, 10);
//     nameLabel.title = label;
    
//     barContainer.appendChild(valueLabel);
//     barContainer.appendChild(bar);
//     barContainer.appendChild(nameLabel);
//     chartDiv.appendChild(barContainer);
//   });
  
//   container.appendChild(chartDiv);
// }

// Helper function to truncate text
function truncateText(text, maxLength) {
  if (!text) return '';
  if (text.length <= maxLength) return text;
  return text.substring(0, maxLength) + '...';
}
// Modal Functions
// function openDetailsModal(applicationNumber, brandName, ingredient) {
//   // Create a modal to show detailed application information
//   const modalContent = `
//     <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full">
//       <div class="flex justify-between items-center p-4 border-b border-gray-200">
//         <h2 class="text-xl font-bold text-gray-800">${brandName} Details</h2>
//         <button class="close-modal text-gray-400 hover:text-gray-600">
//           <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
//             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
//           </svg>
//         </button>
//       </div>
      
//       <div class="p-6">
//         <div class="flex justify-between items-start mb-4">
//           <div>
//             <h3 class="text-lg font-semibold">${brandName}</h3>
//             <p class="text-gray-600">Application: ${applicationNumber}</p>
//           </div>
//           <div class="flex space-x-2">
//             <a href="https://www.accessdata.fda.gov/scripts/cder/daf/index.cfm?event=overview.process&ApplNo=${applicationNumber.replace(/[^0-9]/g, '')}" 
//               target="_blank" 
//               class="px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700 transition">
//               FDA Database
//             </a>
//             <a href="https://dailymed.nlm.nih.gov/dailymed/search.cfm?query=${encodeURIComponent(ingredient)}" 
//               target="_blank" 
//               class="px-3 py-1 bg-green-600 text-white text-sm rounded hover:bg-green-700 transition">
//               DailyMed
//             </a>
//           </div>
//         </div>
        
//         <div class="mb-6">
//           <div class="bg-gray-50 p-4 rounded-lg flex flex-col space-y-3">
//             <div class="text-center">
//               <p class="text-sm text-gray-600">Loading application details...</p>
//               <div class="mt-2 inline-block animate-spin rounded-full h-5 w-5 border-b-2 border-gray-800"></div>
//             </div>
//           </div>
//         </div>
        
//         <div class="flex justify-end">
//           <button class="close-modal px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 transition">
//             Close
//           </button>
//         </div>
//       </div>
//     </div>
//   `;
  
//   showModal(modalContent, async () => {
//     // Load application details
//     try {
//       const response = await fetch(`/api/fda/application/${applicationNumber}`);
//       const data = await response.json();
      
//       // Update the modal with the fetched data
//       // This would be implemented based on your API response structure
//     } catch (error) {
//       console.error("Error fetching application details:", error);
//     }
//   });
// }

function openLabelModal(labelData) {
  // Construct the modal content
  const brandName = labelData.openfda?.brand_name?.[0] || 'Unknown Brand';
  const genericName = labelData.openfda?.generic_name?.[0] || 'Unknown Generic';
  
  const modalContent = `
    <div class="bg-white rounded-lg shadow-xl max-w-5xl w-full">
      <div class="flex justify-between items-center p-4 border-b border-gray-200">
        <h2 class="text-xl font-bold text-gray-800">${brandName} - Drug Label</h2>
        <button class="close-modal text-gray-400 hover:text-gray-600">
          <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      
      <div class="p-6 max-h-[70vh] overflow-y-auto">
        <div class="flex justify-between items-start mb-6">
          <div>
            <h3 class="text-lg font-semibold">${brandName}</h3>
            <p class="text-gray-600">${genericName}</p>
            <p class="text-sm text-gray-500">Manufacturer: ${labelData.openfda?.manufacturer_name?.[0] || 'Unknown'}</p>
          </div>
          
          <div>
            <span class="px-3 py-1 bg-blue-100 text-blue-800 text-sm rounded-full">
              ${labelData.effective_time ? formatDate(labelData.effective_time) : 'Unknown Date'}
            </span>
          </div>
        </div>
        
        <div class="space-y-6">
          <!-- Indications and Usage -->
          <div class="bg-gray-50 p-4 rounded-lg">
            <h4 class="text-md font-medium text-gray-800 mb-2">Indications and Usage</h4>
            <div class="text-sm text-gray-600">
              ${labelData.indications_and_usage?.[0] || 'Not provided'}
            </div>
          </div>
          
          <!-- Dosage and Administration -->
          <div class="bg-gray-50 p-4 rounded-lg">
            <h4 class="text-md font-medium text-gray-800 mb-2">Dosage and Administration</h4>
            <div class="text-sm text-gray-600">
              ${labelData.dosage_and_administration?.[0] || 'Not provided'}
            </div>
          </div>
          
          <!-- Warnings -->
          ${labelData.boxed_warning ? `
            <div class="bg-red-50 p-4 rounded-lg border border-red-200">
              <h4 class="text-md font-medium text-red-800 mb-2">Boxed Warning</h4>
              <div class="text-sm text-red-700">
                ${labelData.boxed_warning[0] || 'Not provided'}
              </div>
            </div>
          ` : ''}
          
          <div class="bg-yellow-50 p-4 rounded-lg">
            <h4 class="text-md font-medium text-yellow-800 mb-2">Warnings and Precautions</h4>
            <div class="text-sm text-yellow-700">
              ${labelData.warnings?.[0] || labelData.warnings_and_precautions?.[0] || 'Not provided'}
            </div>
          </div>
          
          <!-- Adverse Reactions -->
          <div class="bg-gray-50 p-4 rounded-lg">
            <h4 class="text-md font-medium text-gray-800 mb-2">Adverse Reactions</h4>
            <div class="text-sm text-gray-600">
              ${labelData.adverse_reactions?.[0] || 'Not provided'}
            </div>
          </div>
          
          <!-- More sections can be added as needed -->
        </div>
      </div>
      
      <div class="p-4 border-t border-gray-200 flex justify-end">
        <button class="close-modal px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 transition mr-2">
          Close
        </button>
        ${labelData.openfda?.spl_id ? `
          <a href="https://dailymed.nlm.nih.gov/dailymed/lookup.cfm?setid=${labelData.openfda.spl_id[0]}" 
            target="_blank" 
            class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition">
            View on DailyMed
          </a>
        ` : ''}
      </div>
    </div>
  `;
  
  showModal(modalContent);
}

function openNdcModal(ndcData) {
  const productName = ndcData.brand_name || ndcData.generic_name || 'Unknown Product';
  
  const modalContent = `
    <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full">
      <div class="flex justify-between items-center p-4 border-b border-gray-200">
        <h2 class="text-xl font-bold text-gray-800">NDC Product Details</h2>
        <button class="close-modal text-gray-400 hover:text-gray-600">
          <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      
      <div class="p-6">
        <div class="flex justify-between items-start mb-4">
          <div>
            <h3 class="text-lg font-semibold">${productName}</h3>
            <p class="text-gray-600">NDC: ${ndcData.product_ndc || 'Unknown'}</p>
          </div>
          <span class="px-3 py-1 bg-blue-100 text-blue-800 text-sm rounded-full">
            ${ndcData.product_type || 'Unknown Type'}
          </span>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
          <div>
            <h4 class="text-sm font-medium text-gray-700 mb-1">Product Details</h4>
            <div class="bg-gray-50 p-3 rounded">
              <p class="text-sm"><span class="font-medium">Generic Name:</span> ${ndcData.generic_name || 'N/A'}</p>
              <p class="text-sm"><span class="font-medium">Dosage Form:</span> ${ndcData.dosage_form || 'N/A'}</p>
              <p class="text-sm"><span class="font-medium">Route:</span> ${ndcData.route?.join(', ') || 'N/A'}</p>
              <p class="text-sm"><span class="font-medium">Labeler:</span> ${ndcData.labeler_name || 'N/A'}</p>
            </div>
          </div>
          
          <div>
            <h4 class="text-sm font-medium text-gray-700 mb-1">Packaging</h4>
            <div class="bg-gray-50 p-3 rounded max-h-40 overflow-y-auto">
              ${ndcData.packaging ? ndcData.packaging.map(pkg => `
                <div class="mb-2 pb-2 border-b border-gray-200 last:border-b-0 last:mb-0 last:pb-0">
                  <p class="text-sm"><span class="font-medium">Package NDC:</span> ${pkg.package_ndc || 'N/A'}</p>
                  <p class="text-sm"><span class="font-medium">Description:</span> ${pkg.description || 'N/A'}</p>
                </div>
              `).join('') : '<p class="text-sm text-gray-500">No packaging information available</p>'}
            </div>
          </div>
        </div>
        
        <div class="mb-6">
          <h4 class="text-sm font-medium text-gray-700 mb-1">Active Ingredients</h4>
          <div class="bg-gray-50 p-3 rounded">
            ${ndcData.active_ingredients ? ndcData.active_ingredients.map(ing => `
              <div class="mb-2 last:mb-0">
                <p class="text-sm"><span class="font-medium">Name:</span> ${ing.name || 'N/A'}</p>
                <p class="text-sm"><span class="font-medium">Strength:</span> ${ing.strength || 'N/A'}</p>
              </div>
            `).join('') : '<p class="text-sm text-gray-500">No active ingredient information available</p>'}
          </div>
        </div>
        
        <div class="flex justify-end">
          <button class="close-modal px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 transition mr-2">
            Close
          </button>
          <a href="https://www.accessdata.fda.gov/scripts/cder/ndc/dsp_searchresult.cfm" 
            target="_blank" 
            class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition">
            FDA NDC Directory
          </a>
        </div>
      </div>
    </div>
  `;
  
  showModal(modalContent);
}

function openAdverseEventModal(eventData) {
  // Find the drug info
  const drugReports = eventData.patient?.drug || [];
  const drugInfo = drugReports[0] || {};
  const drugName = drugInfo.medicinalproduct || drugInfo.openfda?.brand_name?.[0] || 'Unknown Drug';
  
  // Get reactions
  const reactions = eventData.patient?.reaction || [];
  
  const modalContent = `
    <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full">
      <div class="flex justify-between items-center p-4 border-b border-gray-200">
        <h2 class="text-xl font-bold text-gray-800">Adverse Event Report</h2>
        <button class="close-modal text-gray-400 hover:text-gray-600">
          <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      
      <div class="p-6">
        <div class="flex justify-between items-start mb-6">
          <div>
            <h3 class="text-lg font-semibold">${drugName}</h3>
            <p class="text-sm text-gray-500">
              Report Date: ${formatDate(eventData.receiptdate)}
              <span class="ml-2 px-2 py-0.5 text-xs rounded-full ${eventData.serious ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800'}">
                ${eventData.serious ? 'Serious' : 'Non-serious'}
              </span>
            </p>
          </div>
          <div>
            <span class="px-3 py-1 bg-blue-100 text-blue-800 text-sm rounded-full">
              Report #${eventData.safetyreportid || 'Unknown'}
            </span>
          </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
          <div>
            <h4 class="text-md font-medium text-gray-800 mb-2">Reactions</h4>
            <div class="bg-gray-50 p-4 rounded-lg max-h-60 overflow-y-auto">
              ${reactions.length > 0 ? `
                <ul class="list-disc pl-5 space-y-2">
                  ${reactions.map(reaction => `
                    <li class="text-sm">
                      <span class="font-medium">${reaction.reactionmeddrapt || 'Unknown reaction'}</span>
                      ${reaction.reactionoutcome ? `<span class="text-xs text-gray-500 ml-1">(Outcome: ${reaction.reactionoutcome})</span>` : ''}
                    </li>
                  `).join('')}
                </ul>
              ` : '<p class="text-sm text-gray-500">No reactions reported</p>'}
            </div>
          </div>
          
          <div>
            <h4 class="text-md font-medium text-gray-800 mb-2">Patient Information</h4>
            <div class="bg-gray-50 p-4 rounded-lg">
              <p class="text-sm mb-2"><span class="font-medium">Age:</span> ${eventData.patient?.patientonsetage ? `${eventData.patient.patientonsetage} ${eventData.patient.patientonsetageunit || 'years'}` : 'Not reported'}</p>
              <p class="text-sm mb-2"><span class="font-medium">Sex:</span> ${eventData.patient?.patientsex === 1 ? 'Male' : eventData.patient?.patientsex === 2 ? 'Female' : 'Not reported'}</p>
              <p class="text-sm mb-2"><span class="font-medium">Weight:</span> ${eventData.patient?.patientweight ? `${eventData.patient.patientweight} kg` : 'Not reported'}</p>
              <p class="text-sm"><span class="font-medium">Country:</span> ${eventData.primarysource?.reportercountry || 'Not reported'}</p>
            </div>
          </div>
        </div>
        
        <div class="mb-6">
          <h4 class="text-md font-medium text-gray-800 mb-2">Drug Information</h4>
          <div class="bg-gray-50 p-4 rounded-lg">
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-100">
                  <tr>
                    <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Drug</th>
                    <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Role</th>
                    <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Dosage</th>
                    <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Route</th>
                    <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Indication</th>
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                  ${drugReports.map(drug => `
                    <tr>
                      <td class="px-3 py-2 text-sm text-gray-500">${drug.medicinalproduct || drug.openfda?.brand_name?.[0] || 'Unknown'}</td>
                      <td class="px-3 py-2 text-sm text-gray-500">${drug.drugcharacterization === 1 ? 'Suspect' : drug.drugcharacterization === 2 ? 'Concomitant' : 'Unknown'}</td>
                      <td class="px-3 py-2 text-sm text-gray-500">${drug.drugdosagetext || 'Not reported'}</td>
                      <td class="px-3 py-2 text-sm text-gray-500">${drug.drugadministrationroute || 'Not reported'}</td>
                      <td class="px-3 py-2 text-sm text-gray-500">${drug.drugindication || 'Not reported'}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
        </div>
        
        <div class="flex justify-end">
          <button class="close-modal px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 transition">
            Close
          </button>
        </div>
      </div>
    </div>
  `;
  
  showModal(modalContent);
}

function openEnforcementModal(reportData) {
  console.log(reportData)
  const productDescription = reportData.product_description || 'Unknown Product';
  const reason = reportData.reason_for_recall || 'Not specified';
  
  // Determine the severity badge color based on classification
  let classificationColor = 'bg-gray-100 text-gray-800';
  const classification = reportData.classification || 'Unknown Classification';
  
  if (classification.includes('Class I')) {
    classificationColor = 'bg-red-100 text-red-800';
  } else if (classification.includes('Class II')) {
    classificationColor = 'bg-yellow-100 text-yellow-800';
  } else if (classification.includes('Class III')) {
    classificationColor = 'bg-green-100 text-green-800';
  }
  
  const modalContent = `
    <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full">
      <div class="flex justify-between items-center p-4 border-b border-gray-200">
        <h2 class="text-xl font-bold text-gray-800">Enforcement Report</h2>
        <button class="close-modal text-gray-400 hover:text-gray-600">
          <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      
      <div class="p-6">
        <div class="mb-4">
          <div class="flex justify-between items-start">
            <div>
              <h3 class="text-lg font-semibold">${productDescription}</h3>
              <p class="text-sm text-gray-600">Recall #${reportData.recall_number || 'Unknown'}</p>
            </div>
            <div>
              <span class="px-3 py-1 text-sm rounded-full ${classificationColor}">
                ${classification}
              </span>
            </div>
          </div>
          <p class="mt-2 text-sm text-gray-500">Report Date: ${formatDate(reportData.recall_initiation_date)}</p>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
          <div>
            <h4 class="text-sm font-medium text-gray-700 mb-1">Recall Details</h4>
            <div class="bg-gray-50 p-3 rounded">
              <p class="text-sm mb-2"><span class="font-medium">Status:</span> ${reportData.status || 'Unknown'}</p>
              <p class="text-sm mb-2"><span class="font-medium">Distribution:</span> ${reportData.distribution_pattern || 'Unknown'}</p>
              <p class="text-sm mb-2"><span class="font-medium">Quantity:</span> ${reportData.product_quantity || 'Unknown'}</p>
              <p class="text-sm"><span class="font-medium">Recalling Firm:</span> ${reportData.recalling_firm || 'Unknown'}</p>
            </div>
          </div>
          
          <div>
            <h4 class="text-sm font-medium text-gray-700 mb-1">Product Information</h4>
            <div class="bg-gray-50 p-3 rounded">
              <p class="text-sm mb-2"><span class="font-medium">Code Info:</span> ${reportData.code_info || 'None provided'}</p>
              <p class="text-sm"><span class="font-medium">Product Type:</span> ${reportData.product_type || 'Unknown'}</p>
            </div>
          </div>
        </div>
        
        <div class="mb-6">
          <h4 class="text-sm font-medium text-gray-700 mb-1">Reason for Recall</h4>
          <div class="bg-gray-50 p-3 rounded">
            <p class="text-sm">${reason}</p>
          </div>
        </div>
        
        <div class="flex justify-between items-center">
          <div>
            <span class="text-xs text-gray-500">
              Event ID: ${reportData.event_id || 'Unknown'}
            </span>
          </div>
          <div>
            <button class="close-modal px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 transition mr-2">
              Close
            </button>
            <a href="https://www.fda.gov/safety/recalls-market-withdrawals-safety-alerts" 
              target="_blank" 
              class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition hidden">
              FDA Recalls
            </a>
          </div>
        </div>
      </div>
    </div>
  `;
  
  showModal(modalContent);
}

// "View All" modal functions
// "View All" modal functions
function openAllApplicationsModal(categorizedData, drugName) {
  // Collect all products into a flat array
  let allProducts = [];
  Object.entries(categorizedData).forEach(([brandName, strengths]) => {
    Object.entries(strengths).forEach(([strength, products]) => {
      products.forEach(product => {
        allProducts.push({
          ...product,
          strength
        });
      });
    });
  });
  
  const modalContent = `
    <div class="bg-white rounded-lg shadow-xl max-w-5xl w-full">
      <div class="flex justify-between items-center p-4 border-b border-gray-200">
        <h2 class="text-xl font-bold text-gray-800">All Drug Applications for ${drugName}</h2>
        <button class="close-modal text-gray-400 hover:text-gray-600">
          <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      
      <div class="p-6 max-h-[70vh] overflow-y-auto">
        <div class="mb-4">
          <input type="text" id="application-search" placeholder="Search applications..." class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200" id="applications-table">
            <thead class="bg-gray-50">
              <tr>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Brand Name</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Application</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Strength</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Manufacturer</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Approval</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Form</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              ${allProducts.map(product => `
                <tr class="hover:bg-gray-50">
                  <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${product.brandName}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${product.applicationNumber}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${product.strength}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${product.manufacturerName || product.sponsorName}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${product.approvalDate}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${product.dosageForm}</td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${product.marketingStatus === 'Active' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                      ${product.marketingStatus || 'Unknown'}
                    </span>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      </div>
      
      <div class="p-4 border-t border-gray-200 flex justify-end">
        <button class="close-modal px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 transition">
          Close
        </button>
      </div>
    </div>
  `;
  
  showModal(modalContent, () => {
    // Add search functionality
    const searchInput = document.getElementById('application-search');
    searchInput.addEventListener('keyup', function() {
      const searchTerm = this.value.toLowerCase();
      const rows = document.querySelectorAll('#applications-table tbody tr');
      
      rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
      });
    });
  });
}

function openAllLabelsModal(labelData) {
  const modalContent = `
    <div class="bg-white rounded-lg shadow-xl max-w-5xl w-full">
      <div class="flex justify-between items-center p-4 border-b border-gray-200">
        <h2 class="text-xl font-bold text-gray-800">All Drug Labels</h2>
        <button class="close-modal text-gray-400 hover:text-gray-600">
          <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      
      <div class="p-6 max-h-[70vh] overflow-y-auto">
        <div class="mb-4">
          <input type="text" id="label-search" placeholder="Search labels..." class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        
        <div class="grid grid-cols-1 gap-6" id="labels-container">
          ${labelData.map((label, index) => {
            const brandName = label.openfda?.brand_name?.[0] || 'Unknown Brand';
            const genericName = label.openfda?.generic_name?.[0] || 'Unknown Generic';
            const manufacturerName = label.openfda?.manufacturer_name?.[0] || 'Unknown Manufacturer';
            
            return `
              <div class="bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden label-card">
                <div class="p-4 border-b border-gray-200 bg-gray-50">
                  <div class="flex justify-between items-center">
                    <h3 class="text-lg font-medium text-gray-900">${brandName}</h3>
                    <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">
                      ${genericName}
                    </span>
                  </div>
                  <p class="mt-1 text-sm text-gray-600">Manufacturer: ${manufacturerName}</p>
                </div>
                
                <div class="p-4">
                  <div class="mb-4">
                    <h4 class="text-sm font-medium text-gray-700 mb-1">Indications and Usage:</h4>
                    <div class="text-sm text-gray-600 max-h-20 overflow-y-auto p-2 bg-gray-50 rounded truncate">
                      ${label.indications_and_usage?.[0] || 'Not provided'}
                    </div>
                  </div>
                  
                  <button 
                    class="mt-2 px-3 py-1.5 bg-blue-50 text-blue-600 border border-blue-100 rounded text-sm hover:bg-blue-100 transition view-label-btn" 
                    data-index="${index}">
                    View Full Label Details
                  </button>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      </div>
      
      <div class="p-4 border-t border-gray-200 flex justify-end">
        <button class="close-modal px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 transition">
          Close
        </button>
      </div>
    </div>
  `;
  
  showModal(modalContent, () => {
    // Add search functionality
    const searchInput = document.getElementById('label-search');
    searchInput.addEventListener('keyup', function() {
      const searchTerm = this.value.toLowerCase();
      const cards = document.querySelectorAll('#labels-container .label-card');
      
      cards.forEach(card => {
        const text = card.textContent.toLowerCase();
        card.style.display = text.includes(searchTerm) ? '' : 'none';
      });
    });
    
    // Add event listeners to view label details buttons
    document.querySelectorAll('.view-label-btn').forEach(button => {
      button.addEventListener('click', function() {
        const index = parseInt(this.getAttribute('data-index'));
        if (labelData[index]) {
          // Close the current modal
          closeCurrentModal();
          // Open the label detail modal
          setTimeout(() => {
            openLabelModal(labelData[index]);
          }, 300);
        }
      });
    });
  });
}

function openAllEventsModal(eventData, drugName) {
  const modalContent = `
    <div class="bg-white rounded-lg shadow-xl max-w-5xl w-full">
      <div class="flex justify-between items-center p-4 border-b border-gray-200">
        <h2 class="text-xl font-bold text-gray-800">All Adverse Events for ${drugName}</h2>
        <button class="close-modal text-gray-400 hover:text-gray-600">
          <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      
      <div class="p-6 max-h-[70vh] overflow-y-auto">
        <div class="mb-4">
          <input type="text" id="event-search" placeholder="Search events..." class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200" id="events-table">
            <thead class="bg-gray-50">
              <tr>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Drug</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Severity</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Reactions</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Patient</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              ${eventData.map((event, index) => {
                const reportDate = event.receiptdate || 'Unknown Date';
                const isSerious = event.serious ? true : false;
                
                // Find the relevant drug in the report
                const drugReports = event.patient?.drug || [];
                const drugInfo = drugReports.find(drug => 
                  drug.openfda?.brand_name?.[0]?.toLowerCase().includes(drugName.toLowerCase()) ||
                  drug.openfda?.generic_name?.[0]?.toLowerCase().includes(drugName.toLowerCase()) ||
                  (drug.medicinalproduct || '').toLowerCase().includes(drugName.toLowerCase())
                ) || drugReports[0] || {};
                
                // Get reactions
                const reactions = event.patient?.reaction || [];
                const reactionsList = reactions.map(r => r.reactionmeddrapt || 'Unknown').slice(0, 3).join(', ');
                
                // Patient info
                const patientAge = event.patient?.patientonsetage ? 
                  `${event.patient.patientonsetage} ${event.patient.patientonsetageunit || 'years'}` : 'Unknown';
                const patientSex = event.patient?.patientsex === 1 ? 'Male' : 
                  event.patient?.patientsex === 2 ? 'Female' : 'Unknown';
                
                return `
                  <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(reportDate)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                      ${drugInfo.medicinalproduct || drugInfo.openfda?.brand_name?.[0] || 'Unknown'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                      <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${isSerious ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800'}">
                        ${isSerious ? 'Serious' : 'Non-serious'}
                      </span>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-500">
                      <div class="max-w-xs truncate" title="${reactions.map(r => r.reactionmeddrapt || 'Unknown').join(', ')}">
                        ${reactionsList}${reactions.length > 3 ? '...' : ''}
                      </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                      ${patientAge}, ${patientSex}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                      <button class="text-blue-600 hover:text-blue-900 view-event-btn" data-index="${index}">Details</button>
                    </td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        </div>
      </div>
      
      <div class="p-4 border-t border-gray-200 flex justify-end">
        <button class="close-modal px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 transition">
          Close
        </button>
      </div>
    </div>
  `;
  
  showModal(modalContent, () => {
    // Add search functionality
    const searchInput = document.getElementById('event-search');
    searchInput.addEventListener('keyup', function() {
      const searchTerm = this.value.toLowerCase();
      const rows = document.querySelectorAll('#events-table tbody tr');
      
      rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
      });
    });
    
    // Add event listeners to view event details buttons
    document.querySelectorAll('.view-event-btn').forEach(button => {
      button.addEventListener('click', function() {
        const index = parseInt(this.getAttribute('data-index'));
        if (eventData[index]) {
          // Close the current modal
          closeCurrentModal();
          // Open the event detail modal
          setTimeout(() => {
            openAdverseEventModal(eventData[index]);
          }, 300);
        }
      });
    });
  });
}

// Helper functions
function formatDate(dateString) {
  if (!dateString) return 'Unknown Date';
  
  // Check if the date is in a valid format
  const date = new Date(dateString);
  if (isNaN(date.getTime())) return dateString;
  
  // Format the date
  return date.toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'short',
    day: 'numeric'
  });
}

function truncateText(text, maxLength) {
  if (!text) return '';
  if (text.length <= maxLength) return text;
  return text.substring(0, maxLength) + '...';
}

// Modal handling
let currentModal = null;

function showModal(content, callback) {
  // Create modal backdrop
  const backdrop = document.createElement('div');
  backdrop.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
  backdrop.id = 'modal-backdrop';
  
  // Insert the content
  backdrop.innerHTML = content;
  
  // Add to the document
  document.body.appendChild(backdrop);
  
  // Save reference to current modal
  currentModal = backdrop;
  
  // Add event listeners to close buttons
  document.querySelectorAll('.close-modal').forEach(button => {
    button.addEventListener('click', closeCurrentModal);
  });
  
  // Close on backdrop click
  backdrop.addEventListener('click', function(event) {
    if (event.target === backdrop) {
      closeCurrentModal();
    }
  });
  
  // Prevent scrolling of the body
  document.body.style.overflow = 'hidden';
  
  // Execute callback if provided
  if (typeof callback === 'function') {
    callback();
  }
}

function closeCurrentModal() {
  if (currentModal) {
    document.body.removeChild(currentModal);
    currentModal = null;
    document.body.style.overflow = '';
  }
}

// Add helper CSS for modals
document.addEventListener('DOMContentLoaded', function() {
  const style = document.createElement('style');
  style.textContent = `
    .modal-backdrop {
      z-index: 50;
      background-color: rgba(0, 0, 0, 0.5);
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes slideIn {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    #modal-backdrop {
      animation: fadeIn 0.3s ease-out;
    }
    
    #modal-backdrop > div {
      animation: slideIn 0.3s ease-out;
    }
  `;
  document.head.appendChild(style);
});

// function displayOrangeBookData(data) {
//     console.log(data)
//   // Count total entries
//   const totalProducts = data.total.products || 0;
  
//   // Update counter
//   elements.orangeBookCount.textContent = `${totalProducts} entries`;
  
//   if (totalProducts === 0) {
//     elements.orangeBookData.innerHTML = `
//       <div class="text-center p-4 rounded bg-gray-50">
//         <p class="text-sm text-gray-700">No Orange Book entries found</p>
//       </div>
//     `;
//     return;
//   }
  
//   // Create HTML for the products
//   let html = `
//     <div class="overflow-x-auto rounded-lg border border-gray-200 shadow-sm">
//       <div class="flex justify-end p-2 bg-gray-50">
//         <button id="expandAllBtn" class="text-xs bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded">
//           Expand All
//         </button>
//       </div>
//       <div class="divide-y divide-gray-200">
//   `;
  
//   // Add product cards (limit to 20 for performance)
//   const productsToShow = Math.min(data.results.products.length, 20);
  
//   for (let i = 0; i < productsToShow; i++) {
//     const product = data.results.products[i];
//     const hasPatents = product.related_patents && product.related_patents.length > 0;
//     const hasExclusivity = product.related_exclusivity && product.related_exclusivity.length > 0;
    
//     html += `
//       <div class="product-card bg-white overflow-hidden" data-product-id="${product.Appl_No}-${product.Product_No}">
//         <!-- Product Header -->
//         <div class="flex justify-between items-center p-4 cursor-pointer product-header" 
//              onclick="toggleProductDetails('${product.Appl_No}-${product.Product_No}')">
//           <div>
//             <h3 class="text-lg font-medium text-gray-900">${product.Trade_Name || 'Unnamed Product'}</h3>
//             <div class="text-sm text-gray-500">
//               ${product.Ingredient || 'N/A'} | ${product.Strength || 'N/A'} | ${product.DF_Route || product["DF;Route"] || 'N/A'}
//             </div>
//           </div>
//           <div class="flex items-center">
//             <span class="text-sm bg-blue-100 text-blue-800 px-2 py-1 rounded mr-2">
//               ${product.Appl_Type || ''}-${product.Appl_No || ''}
//             </span>
//             <svg class="toggle-icon w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
//               <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
//             </svg>
//           </div>
//         </div>
        
//         <!-- Product Details (hidden by default) -->
//         <div class="product-details hidden p-4 border-t border-gray-200 bg-gray-50" id="details-${product.Appl_No}-${product.Product_No}">
//           <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
//             <!-- Product Information -->
//             <div class="bg-white p-3 rounded shadow-sm">
//               <h4 class="font-medium text-gray-700 mb-2">Product Information</h4>
//               <table class="w-full text-sm">
//                 <tbody>
//                   <tr>
//                     <td class="py-1 pr-2 text-gray-500">Applicant</td>
//                     <td class="py-1">${product.Applicant_Full_Name || product.Applicant || 'N/A'}</td>
//                   </tr>
//                   <tr>
//                     <td class="py-1 pr-2 text-gray-500">Approval Date</td>
//                     <td class="py-1">${product.Approval_Date || 'N/A'}</td>
//                   </tr>
//                   <tr>
//                     <td class="py-1 pr-2 text-gray-500">Type</td>
//                     <td class="py-1">${product.Type || 'N/A'}</td>
//                   </tr>
//                   <tr>
//                     <td class="py-1 pr-2 text-gray-500">RLD/RS</td>
//                     <td class="py-1">
//                       ${product.RLD === 'Yes' ? '<span class="bg-green-100 text-green-800 px-2 py-0.5 rounded text-xs">RLD</span>' : ''}
//                       ${product.RS === 'Yes' ? '<span class="bg-purple-100 text-purple-800 px-2 py-0.5 rounded text-xs ml-1">RS</span>' : ''}
//                     </td>
//                   </tr>
//                   <tr>
//                     <td class="py-1 pr-2 text-gray-500">TE Code</td>
//                     <td class="py-1">${product.TE_Code || 'N/A'}</td>
//                   </tr>
//                 </tbody>
//               </table>
//             </div>
            
//             <!-- Links & Resources -->
//             <div class="bg-white p-3 rounded shadow-sm">
//               <h4 class="font-medium text-gray-700 mb-2">Links & Resources</h4>
//               <div class="space-y-2">
//                 <a href="https://www.accessdata.fda.gov/scripts/cder/ob/results_product.cfm?Appl_Type=${product.Appl_Type}&Appl_No=${product.Appl_No}" 
//                    target="_blank" 
//                    class="block w-full text-center bg-blue-50 hover:bg-blue-100 text-blue-700 p-2 rounded text-sm transition">
//                   View on FDA Orange Book
//                 </a>
//                 <a href="https://dailymed.nlm.nih.gov/dailymed/search.cfm?query=${encodeURIComponent(product.Ingredient)}" 
//                    target="_blank" 
//                    class="block w-full text-center bg-blue-50 hover:bg-blue-100 text-blue-700 p-2 rounded text-sm transition">
//                   Search on DailyMed
//                 </a>
//                 <a href="https://www.drugs.com/search.php?searchterm=${encodeURIComponent(product.Trade_Name || product.Ingredient)}" 
//                    target="_blank" 
//                    class="block w-full text-center bg-blue-50 hover:bg-blue-100 text-blue-700 p-2 rounded text-sm transition">
//                   Search on Drugs.com
//                 </a>
//               </div>
//             </div>
//           </div>
          
//           <!-- Related Patents Section -->
//           ${hasPatents ? `
//             <div class="mt-4">
//               <h4 class="font-medium text-gray-700 mb-2">Patents (${product.related_patents.length})</h4>
//               <div class="overflow-x-auto bg-white rounded shadow-sm">
//                 <table class="min-w-full divide-y divide-gray-200">
//                   <thead class="bg-gray-50">
//                     <tr>
//                       <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Patent No</th>
//                       <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Expiration</th>
//                       <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Drug Sub/Prod</th>
//                       <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Use Code</th>
//                     </tr>
//                   </thead>
//                   <tbody class="divide-y divide-gray-200">
//                     ${product.related_patents.map(patent => `
//                       <tr class="hover:bg-gray-50">
//                         <td class="px-3 py-2 text-sm">
//                           <a href="https://patents.google.com/patent/US${patent.Patent_No}" 
//                              target="_blank" 
//                              class="text-blue-600 hover:underline">${patent.Patent_No}</a>
//                         </td>
//                         <td class="px-3 py-2 text-sm">${patent.Patent_Expire_Date_Text || 'N/A'}</td>
//                         <td class="px-3 py-2 text-sm">
//                           ${patent.Drug_Substance_Flag === 'Y' ? '<span class="bg-blue-100 text-blue-800 px-1 rounded text-xs">DS</span>' : ''}
//                           ${patent.Drug_Product_Flag === 'Y' ? '<span class="bg-green-100 text-green-800 px-1 rounded text-xs ml-1">DP</span>' : ''}
//                         </td>
//                         <td class="px-3 py-2 text-sm">${patent.Patent_Use_Code || 'N/A'}</td>
//                       </tr>
//                     `).join('')}
//                   </tbody>
//                 </table>
//               </div>
//             </div>
//           ` : ''}
          
//           <!-- Related Exclusivity Section -->
//           ${hasExclusivity ? `
//             <div class="mt-4">
//               <h4 class="font-medium text-gray-700 mb-2">Exclusivity (${product.related_exclusivity.length})</h4>
//               <div class="overflow-x-auto bg-white rounded shadow-sm">
//                 <table class="min-w-full divide-y divide-gray-200">
//                   <thead class="bg-gray-50">
//                     <tr>
//                       <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Code</th>
//                       <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
//                     </tr>
//                   </thead>
//                   <tbody class="divide-y divide-gray-200">
//                     ${product.related_exclusivity.map(exclusivity => `
//                       <tr class="hover:bg-gray-50">
//                         <td class="px-3 py-2 text-sm font-medium">
//                           <span class="bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded">
//                             ${exclusivity.Exclusivity_Code || 'N/A'}
//                           </span>
//                         </td>
//                         <td class="px-3 py-2 text-sm">${exclusivity.Exclusivity_Date || 'N/A'}</td>
//                       </tr>
//                     `).join('')}
//                   </tbody>
//                 </table>
//               </div>
//             </div>
//           ` : ''}
//         </div>
//       </div>
//     `;
//   }
  
//   html += `
//       </div>
//     </div>
//   `;
  
//   // If there are more results than shown, add a note
//   if (data.results.products.length > 20) {
//     html += `
//       <div class="text-xs text-gray-500 mt-2 text-right">
//         Showing 20 of ${data.results.products.length} entries
//       </div>
//     `;
//   }
  
//   elements.orangeBookData.innerHTML = html;
  
//   // Add event listener for the Expand All button
//   document.getElementById('expandAllBtn').addEventListener('click', function() {
//     const allDetails = document.querySelectorAll('.product-details');
//     const isAnyHidden = Array.from(allDetails).some(el => el.classList.contains('hidden'));
    
//     if (isAnyHidden) {
//       // Expand all
//       allDetails.forEach(el => el.classList.remove('hidden'));
//       this.textContent = 'Collapse All';
      
//       // Rotate all toggle icons
//       document.querySelectorAll('.toggle-icon').forEach(icon => {
//         icon.style.transform = 'rotate(180deg)';
//       });
//     } else {
//       // Collapse all
//       allDetails.forEach(el => el.classList.add('hidden'));
//       this.textContent = 'Expand All';
      
//       // Reset all toggle icons
//       document.querySelectorAll('.toggle-icon').forEach(icon => {
//         icon.style.transform = 'rotate(0deg)';
//       });
//     }
//   });
// }

// // Function to toggle product details
// function toggleProductDetails(productId) {
//   const detailsElement = document.getElementById(`details-${productId}`);
//   const headerElement = detailsElement.previousElementSibling;
//   const iconElement = headerElement.querySelector('.toggle-icon');
  
//   if (detailsElement.classList.contains('hidden')) {
//     detailsElement.classList.remove('hidden');
//     iconElement.style.transform = 'rotate(180deg)';
//   } else {
//     detailsElement.classList.add('hidden');
//     iconElement.style.transform = 'rotate(0deg)';
//   }
// }

// // Add this function to your code to handle searching
// function searchOrangeBook(query) {
//   if (!query.trim()) {
//     elements.orangeBookData.innerHTML = `
//       <div class="text-center p-4">
//         <p class="text-sm text-gray-700">Please enter a search term</p>
//       </div>
//     `;
//     elements.orangeBookCount.textContent = '0 entries';
//     return;
//   }
  
//   // Show loading state
//   elements.orangeBookData.innerHTML = `
//     <div class="text-center p-4">
//       <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-gray-800"></div>
//       <p class="mt-2 text-sm text-gray-700">Searching...</p>
//     </div>
//   `;
  
//   // Make the API request
//   fetch(`/api/fda/orangebook/search?q=${encodeURIComponent(query)}`)
//     .then(response => {
//       if (!response.ok) throw new Error('Network response was not ok');
//       return response.json();
//     })
//     .then(data => {
//       displayOrangeBookData(data);
//     })
//     .catch(error => {
//       console.error('Error fetching Orange Book data:', error);
//       elements.orangeBookData.innerHTML = `
//         <div class="text-center p-4">
//           <p class="text-sm text-red-600">Error: ${error.message}</p>
//         </div>
//       `;
//       elements.orangeBookCount.textContent = '0 entries';
//     });
// }

















// Function to display DailyMed data

// function displayOrangeBookData(data) {
//   // Count total entries across all categories
//   const totalProducts = data.total.products || 0;
//   const totalPatents = data.total.patents || 0;
//   const totalExclusivity = data.total.exclusivity || 0;
  
//   // Update counter to show all categories
//   elements.orangeBookCount.textContent = `${totalProducts} Products | ${totalPatents} Patents | ${totalExclusivity} Exclusivity Records`;
  
//   if (totalProducts === 0 && totalPatents === 0 && totalExclusivity === 0) {
//     elements.orangeBookData.innerHTML = `
//       <div class="text-center p-4 rounded bg-gray-50">
//         <p class="text-sm text-gray-700">No Orange Book entries found</p>
//       </div>
//     `;
//     return;
//   }
  
//   // Create tab navigation 
//   let html = `
//     <div class="mb-4 border-b border-gray-200">
//         <style>
//             /* Orange Book Specific Styles */

// /* Tab Navigation */
// .tab-button {
//   transition: all 0.2s ease-in-out;
// }

// .tab-button:focus {
//   outline: none;
//   box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
// }

// .tab-pane {
//   display: none;
// }

// .tab-pane.active {
//   display: block;
//   animation: fadeIn 0.3s ease-in-out;
// }

// /* Product Card Styles */
// .product-card {
//   transition: box-shadow 0.2s ease-in-out;
// }

// .product-card:hover {
//   box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
// }

// .product-header {
//   transition: background-color 0.2s ease-in-out;
// }

// .product-header:hover {
//   background-color: #f9fafb;
// }

// .product-details {
//   transition: max-height 0.3s ease-out, opacity 0.2s ease-in-out;
// }

// /* Toggle Icon Animation */
// .toggle-icon {
//   transition: transform 0.3s ease;
// }

// /* Related Tabs Within Product */
// .related-tab {
//   transition: all 0.2s ease-in-out;
// }

// .related-tab:focus {
//   outline: none;
// }

// .related-pane {
//   display: none;
// }

// .related-pane.active {
//   display: block;
//   animation: fadeIn 0.3s ease-in-out;
// }

// /* Badge styling */
// .badge {
//   display: inline-block;
//   padding: 0.125rem 0.5rem;
//   border-radius: 9999px;
//   font-size: 0.75rem;
//   font-weight: 500;
//   text-align: center;
// }

// .badge-blue {
//   background-color: #e0f2fe;
//   color: #0369a1;
// }

// .badge-green {
//   background-color: #dcfce7;
//   color: #166534;
// }

// .badge-purple {
//   background-color: #f3e8ff;
//   color: #7e22ce;
// }

// .badge-yellow {
//   background-color: #fef9c3;
//   color: #854d0e;
// }

// .badge-red {
//   background-color: #fee2e2;
//   color: #b91c1c;
// }

// /* Animation for loading spinners */
// @keyframes spin {
//   from {
//     transform: rotate(0deg);
//   }
//   to {
//     transform: rotate(360deg);
//   }
// }

// .animate-spin {
//   animation: spin 1s linear infinite;
// }

// /* Fade in animation */
// @keyframes fadeIn {
//   from {
//     opacity: 0;
//   }
//   to {
//     opacity: 1;
//   }
// }

// /* Table hover effects */
// tr.hover\:bg-gray-50:hover {
//   background-color: #f9fafb;
// }

// /* Link styles */
// a.text-blue-600 {
//   text-decoration: none;
// }

// a.text-blue-600:hover {
//   text-decoration: underline;
// }

// /* Custom scrollbar for tables */
// .overflow-x-auto::-webkit-scrollbar {
//   height: 8px;
// }

// .overflow-x-auto::-webkit-scrollbar-track {
//   background: #f1f1f1;
//   border-radius: 4px;
// }

// .overflow-x-auto::-webkit-scrollbar-thumb {
//   background: #d1d5db;
//   border-radius: 4px;
// }

// .overflow-x-auto::-webkit-scrollbar-thumb:hover {
//   background: #9ca3af;
// }

// /* Modal styles */
// .modal-container {
//   animation: fadeIn 0.2s ease-in-out;
// }

// .modal-content {
//   max-height: 80vh;
//   overflow-y: auto;
// }

// /* Print styles */
// @media print {
//   .no-print {
//     display: none !important;
//   }
  
//   .overflow-x-auto {
//     overflow: visible !important;
//   }
  
//   .tab-content {
//     display: block !important;
//   }
  
//   .tab-pane {
//     display: block !important;
//     page-break-after: always;
//   }
  
//   .product-details {
//     display: block !important;
//   }
// }
//   </style>
//       <ul class="flex flex-wrap -mb-px text-sm font-medium text-center" role="tablist">
//         <li class="mr-2" role="presentation">
//           <button class="tab-button inline-block p-4 border-b-2 border-blue-500 rounded-t-lg active text-blue-600" 
//                   id="products-tab" 
//                   data-tab="products-content"
//                   aria-selected="true">
//             Products (${totalProducts})
//           </button>
//         </li>
//         <li class="mr-2" role="presentation">
//           <button class="tab-button inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300" 
//                   id="patents-tab" 
//                   data-tab="patents-content"
//                   aria-selected="false">
//             Patents (${totalPatents})
//           </button>
//         </li>
//         <li role="presentation">
//           <button class="tab-button inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300" 
//                   id="exclusivity-tab" 
//                   data-tab="exclusivity-content"
//                   aria-selected="false">
//             Exclusivity (${totalExclusivity})
//           </button>
//         </li>
//       </ul>
//     </div>
    
//     <div class="tab-content">
//       <!-- Products Tab Content -->
//       <div id="products-content" class="tab-pane active">
//         <div class="overflow-x-auto rounded-lg border border-gray-200 shadow-sm">
//           <div class="flex justify-between p-2 bg-gray-50">
//             <div class="flex items-center">
//               <span class="text-xs text-gray-500">Toggle view:</span>
//               <button id="cardsViewBtn" class="ml-2 text-xs bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded">
//                 Cards
//               </button>
//               <button id="tableViewBtn" class="ml-2 text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-1 rounded">
//                 Table
//               </button>
//             </div>
//             <button id="expandAllBtn" class="text-xs bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded">
//               Expand All
//             </button>
//           </div>
          
//           <!-- Card View (default) -->
//           <div id="cards-view" class="divide-y divide-gray-200">



            
//   `;
  
//   // Add product cards (limit to 20 for performance)
//   const productsToShow = Math.min(data.results.products.length, 20);
  
//   for (let i = 0; i < productsToShow; i++) {
//     const product = data.results.products[i];
//     const hasPatents = product.related_patents && product.related_patents.length > 0;
//     const hasExclusivity = product.related_exclusivity && product.related_exclusivity.length > 0;
    
//     html += `
//       <div class="product-card bg-white overflow-hidden" data-product-id="${product.Appl_No}-${product.Product_No}">
//         <!-- Product Header -->
//         <div class="flex justify-between items-center p-4 cursor-pointer product-header" 
//              onclick="toggleProductDetails('${product.Appl_No}-${product.Product_No}')">
//           <div>
//             <h3 class="text-lg font-medium text-gray-900">${product.Trade_Name || 'Unnamed Product'}</h3>
//             <div class="text-sm text-gray-500">
//               ${product.Ingredient || 'N/A'} | ${product.Strength || 'N/A'} | ${product.DF_Route || product["DF;Route"] || 'N/A'}
//             </div>
//           </div>
//           <div class="flex items-center">
//             <span class="text-sm bg-blue-100 text-blue-800 px-2 py-1 rounded mr-2">
//               ${product.Appl_Type || ''}-${product.Appl_No || ''}
//             </span>
//             <svg class="toggle-icon w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
//               <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
//             </svg>
//           </div>
//         </div>
        
//         <!-- Product Details (hidden by default) -->
//         <div class="product-details hidden p-4 border-t border-gray-200 bg-gray-50" id="details-${product.Appl_No}-${product.Product_No}">
//           <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
//             <!-- Product Information -->
//             <div class="bg-white p-3 rounded shadow-sm">
//               <h4 class="font-medium text-gray-700 mb-2">Product Information</h4>
//               <table class="w-full text-sm">
//                 <tbody>
//                   <tr>
//                     <td class="py-1 pr-2 text-gray-500">Applicant</td>
//                     <td class="py-1">${product.Applicant_Full_Name || product.Applicant || 'N/A'}</td>
//                   </tr>
//                   <tr>
//                     <td class="py-1 pr-2 text-gray-500">Approval Date</td>
//                     <td class="py-1">${product.Approval_Date || 'N/A'}</td>
//                   </tr>
//                   <tr>
//                     <td class="py-1 pr-2 text-gray-500">Type</td>
//                     <td class="py-1">${product.Type || 'N/A'}</td>
//                   </tr>
//                   <tr>
//                     <td class="py-1 pr-2 text-gray-500">RLD/RS</td>
//                     <td class="py-1">
//                       ${product.RLD === 'Yes' ? '<span class="badge badge-green">RLD</span>' : ''}
//                       ${product.RS === 'Yes' ? '<span class="badge badge-purple ml-1">RS</span>' : ''}
//                     </td>
//                   </tr>
//                   <tr>
//                     <td class="py-1 pr-2 text-gray-500">TE Code</td>
//                     <td class="py-1">${product.TE_Code || 'N/A'}</td>
//                   </tr>
//                 </tbody>
//               </table>
//             </div>
            
//             <!-- Links & Resources -->
//             <div class="bg-white p-3 rounded shadow-sm">
//               <h4 class="font-medium text-gray-700 mb-2">Links & Resources</h4>
//               <div class="space-y-2">
//                 <a href="https://www.accessdata.fda.gov/scripts/cder/ob/results_product.cfm?Appl_Type=${product.Appl_Type}&Appl_No=${product.Appl_No}" 
//                    target="_blank" 
//                    class="block w-full text-center bg-blue-50 hover:bg-blue-100 text-blue-700 p-2 rounded text-sm transition">
//                   View on FDA Orange Book
//                 </a>
//                 <a href="https://dailymed.nlm.nih.gov/dailymed/search.cfm?query=${encodeURIComponent(product.Ingredient)}" 
//                    target="_blank" 
//                    class="block w-full text-center bg-blue-50 hover:bg-blue-100 text-blue-700 p-2 rounded text-sm transition">
//                   Search on DailyMed
//                 </a>
//                 <a href="https://www.drugs.com/search.php?searchterm=${encodeURIComponent(product.Trade_Name || product.Ingredient)}" 
//                    target="_blank" 
//                    class="block w-full text-center bg-blue-50 hover:bg-blue-100 text-blue-700 p-2 rounded text-sm transition">
//                   Search on Drugs.com
//                 </a>
//               </div>
//             </div>
//           </div>
          
//           <!-- Related Data Tabs -->
//           <div class="mt-4">
//             <div class="border-b border-gray-200">
//               <ul class="flex flex-wrap -mb-px text-xs font-medium text-center">
//                 <li class="mr-2">
//                   <button class="related-tab inline-block p-2 border-b-2 border-blue-500 rounded-t-lg active text-blue-600" 
//                           onclick="switchRelatedTab(this, 'related-info-${product.Appl_No}-${product.Product_No}')">
//                     Product Info
//                   </button>
//                 </li>
//                 <li class="mr-2">
//                   <button class="related-tab inline-block p-2 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300" 
//                           onclick="switchRelatedTab(this, 'related-patents-${product.Appl_No}-${product.Product_No}')">
//                     Patents ${hasPatents ? `(${product.related_patents.length})` : '(0)'}
//                   </button>
//                 </li>
//                 <li>
//                   <button class="related-tab inline-block p-2 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300" 
//                           onclick="switchRelatedTab(this, 'related-exclusivity-${product.Appl_No}-${product.Product_No}')">
//                     Exclusivity ${hasExclusivity ? `(${product.related_exclusivity.length})` : '(0)'}
//                   </button>
//                 </li>
//               </ul>
//             </div>
            
//             <!-- Related Content -->
//             <div class="related-content">
//               <!-- Product Info Tab (active by default, we keep it empty as it's already shown above) -->
//               <div id="related-info-${product.Appl_No}-${product.Product_No}" class="related-pane active mt-3">
//                 <!-- Already shown above, keep this empty or add additional info -->
//               </div>
              
//               <!-- Patents Tab -->
//               <div id="related-patents-${product.Appl_No}-${product.Product_No}" class="related-pane hidden mt-3">
//                 ${hasPatents ? `
//                   <div class="overflow-x-auto bg-white rounded shadow-sm">
//                     <table class="min-w-full divide-y divide-gray-200">
//                       <thead class="bg-gray-50">
//                         <tr>
//                           <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Patent No</th>
//                           <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Expiration</th>
//                           <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Drug Sub/Prod</th>
//                           <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Use Code</th>
//                         </tr>
//                       </thead>
//                       <tbody class="divide-y divide-gray-200">
//                         ${product.related_patents.map(patent => `
//                           <tr class="hover:bg-gray-50">
//                             <td class="px-3 py-2 text-sm">
//                               <a href="https://patents.google.com/patent/US${patent.Patent_No}" 
//                                  target="_blank" 
//                                  class="text-blue-600 hover:underline">${patent.Patent_No}</a>
//                             </td>
//                             <td class="px-3 py-2 text-sm">${patent.Patent_Expire_Date_Text || 'N/A'}</td>
//                             <td class="px-3 py-2 text-sm">
//                               ${patent.Drug_Substance_Flag === 'Y' ? '<span class="badge badge-blue">DS</span>' : ''}
//                               ${patent.Drug_Product_Flag === 'Y' ? '<span class="badge badge-green ml-1">DP</span>' : ''}
//                             </td>
//                             <td class="px-3 py-2 text-sm">${patent.Patent_Use_Code || 'N/A'}</td>
//                           </tr>
//                         `).join('')}
//                       </tbody>
//                     </table>
//                   </div>
//                 ` : '<p class="text-sm text-gray-500">No patents found for this product.</p>'}
//               </div>
              
//               <!-- Exclusivity Tab -->
//               <div id="related-exclusivity-${product.Appl_No}-${product.Product_No}" class="related-pane hidden mt-3">
//                 ${hasExclusivity ? `
//                   <div class="overflow-x-auto bg-white rounded shadow-sm">
//                     <table class="min-w-full divide-y divide-gray-200">
//                       <thead class="bg-gray-50">
//                         <tr>
//                           <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Code</th>
//                           <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
//                         </tr>
//                       </thead>
//                       <tbody class="divide-y divide-gray-200">
//                         ${product.related_exclusivity.map(exclusivity => `
//                           <tr class="hover:bg-gray-50">
//                             <td class="px-3 py-2 text-sm font-medium">
//                               <span class="badge badge-yellow">
//                                 ${exclusivity.Exclusivity_Code || 'N/A'}
//                               </span>
//                             </td>
//                             <td class="px-3 py-2 text-sm">${exclusivity.Exclusivity_Date || 'N/A'}</td>
//                           </tr>
//                         `).join('')}
//                       </tbody>
//                     </table>
//                   </div>
//                 ` : '<p class="text-sm text-gray-500">No exclusivity records found for this product.</p>'}
//               </div>
//             </div>
//           </div>
//         </div>
//       </div>
//     `;
//   }
  
//   html += `
//           </div>
          
//           <!-- Table View (hidden by default) -->
//           <div id="table-view" class="hidden">
//             <table class="min-w-full divide-y divide-gray-200">
//               <thead class="bg-gray-50">
//                 <tr>
//                   <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Trade Name</th>
//                   <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ingredient</th>
//                   <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Strength</th>
//                   <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Application</th>
//                   <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Approval Date</th>
//                   <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Relations</th>
//                 </tr>
//               </thead>
//               <tbody class="bg-white divide-y divide-gray-200">
//                 ${data.results.products.slice(0, 20).map(product => `
//                   <tr class="hover:bg-gray-50">
//                     <td class="px-6 py-4 text-sm font-medium text-gray-900">${product.Trade_Name || 'N/A'}</td>
//                     <td class="px-6 py-4 text-sm text-gray-500">${product.Ingredient || 'N/A'}</td>
//                     <td class="px-6 py-4 text-sm text-gray-500">${product.Strength || 'N/A'}</td>
//                     <td class="px-6 py-4 text-sm text-gray-500">${product.Appl_Type || ''}-${product.Appl_No || ''}</td>
//                     <td class="px-6 py-4 text-sm text-gray-500">${product.Approval_Date || 'N/A'}</td>
//                     <td class="px-6 py-4 text-sm text-gray-500">
//                       ${product.related_patents && product.related_patents.length ? 
//                         `<span class="badge badge-blue mr-1">Patents: ${product.related_patents.length}</span>` : ''}
//                       ${product.related_exclusivity && product.related_exclusivity.length ? 
//                         `<span class="badge badge-yellow">Exclusivity: ${product.related_exclusivity.length}</span>` : ''}
//                     </td>
//                   </tr>
//                 `).join('')}
//               </tbody>
//             </table>
//           </div>
//         </div>
//       </div>
      
//       <!-- Patents Tab Content -->
//       <div id="patents-content" class="tab-pane hidden">
//         <div class="overflow-x-auto rounded-lg border border-gray-200 shadow-sm">
//           <table class="min-w-full divide-y divide-gray-200">
//             <thead class="bg-gray-50">
//               <tr>
//                 <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Patent No</th>
//                 <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Application</th>
//                 <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Expiration</th>
//                 <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Drug Sub/Prod</th>
//                 <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Use Code</th>
//                 <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Related Product</th>
//               </tr>
//             </thead>
//             <tbody class="bg-white divide-y divide-gray-200">
//               ${data.results.patents.slice(0, 20).map(patent => {
//                 // Find related product information if available
//                 const relatedProduct = data.results.products.find(p => 
//                   p.Appl_Type === patent.Appl_Type && 
//                   p.Appl_No === patent.Appl_No && 
//                   p.Product_No === patent.Product_No
//                 );
                
//                 return `
//                   <tr class="hover:bg-gray-50">
//                     <td class="px-6 py-4 text-sm font-medium text-blue-600 hover:underline">
//                       <a href="https://patents.google.com/patent/US${patent.Patent_No}" target="_blank">${patent.Patent_No}</a>
//                     </td>
//                     <td class="px-6 py-4 text-sm text-gray-500">${patent.Appl_Type || ''}-${patent.Appl_No || ''}-${patent.Product_No || ''}</td>
//                     <td class="px-6 py-4 text-sm text-gray-500">${patent.Patent_Expire_Date_Text || 'N/A'}</td>
//                     <td class="px-6 py-4 text-sm text-gray-500">
//                       ${patent.Drug_Substance_Flag === 'Y' ? '<span class="badge badge-blue">DS</span>' : ''}
//                       ${patent.Drug_Product_Flag === 'Y' ? '<span class="badge badge-green ml-1">DP</span>' : ''}
//                     </td>
//                     <td class="px-6 py-4 text-sm text-gray-500">${patent.Patent_Use_Code || 'N/A'}</td>
//                     <td class="px-6 py-4 text-sm text-gray-500">
//                       ${relatedProduct ? 
//                         `<span class="font-medium">${relatedProduct.Trade_Name || 'Unnamed Product'}</span><br>
//                          <span class="text-xs">${relatedProduct.Ingredient || 'N/A'}</span>` : 
//                         'No related product found'}
//                     </td>
//                   </tr>
//                 `;
//               }).join('')}
//             </tbody>
//           </table>
//         </div>
//         ${data.results.patents.length > 20 ? `
//           <div class="text-xs text-gray-500 mt-2 text-right">
//             Showing 20 of ${data.results.patents.length} entries
//           </div>
//         ` : ''}
//       </div>
      
//       <!-- Exclusivity Tab Content -->
//       <div id="exclusivity-content" class="tab-pane hidden">
//         <div class="overflow-x-auto rounded-lg border border-gray-200 shadow-sm">
//           <table class="min-w-full divide-y divide-gray-200">
//             <thead class="bg-gray-50">
//               <tr>
//                 <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Code</th>
//                 <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Application</th>
//                 <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
//                 <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Related Product</th>
//               </tr>
//             </thead>
//             <tbody class="bg-white divide-y divide-gray-200">
//               ${data.results.exclusivity.slice(0, 20).map(exclusivity => {
//                 // Find related product information if available
//                 const relatedProduct = data.results.products.find(p => 
//                   p.Appl_Type === exclusivity.Appl_Type && 
//                   p.Appl_No === exclusivity.Appl_No && 
//                   p.Product_No === exclusivity.Product_No
//                 );
                
//                 return `
//                   <tr class="hover:bg-gray-50">
//                     <td class="px-6 py-4 text-sm font-medium">
//                       <span class="badge badge-yellow">${exclusivity.Exclusivity_Code || 'N/A'}</span>
//                     </td>
//                     <td class="px-6 py-4 text-sm text-gray-500">${exclusivity.Appl_Type || ''}-${exclusivity.Appl_No || ''}-${exclusivity.Product_No || ''}</td>
//                     <td class="px-6 py-4 text-sm text-gray-500">${exclusivity.Exclusivity_Date || 'N/A'}</td>
//                     <td class="px-6 py-4 text-sm text-gray-500">
//                       ${relatedProduct ? 
//                         `<span class="font-medium">${relatedProduct.Trade_Name || 'Unnamed Product'}</span><br>
//                          <span class="text-xs">${relatedProduct.Ingredient || 'N/A'}</span>` : 
//                         'No related product found'}
//                     </td>
//                   </tr>
//                 `;
//               }).join('')}
//             </tbody>
//           </table>
//         </div>
//         ${data.results.exclusivity.length > 20 ? `
//           <div class="text-xs text-gray-500 mt-2 text-right">
//             Showing 20 of ${data.results.exclusivity.length} entries
//           </div>
//         ` : ''}
//       </div>
//     </div>
//   `;
  
//   elements.orangeBookData.innerHTML = html;
  
//   // Add event listeners to tabs
//   document.querySelectorAll('.tab-button').forEach(button => {
//     button.addEventListener('click', function() {
//       const tabId = this.getAttribute('data-tab');
      
//       // Hide all tab panes
//       document.querySelectorAll('.tab-pane').forEach(pane => {
//         pane.classList.add('hidden');
//         pane.classList.remove('active');
//       });
      
//       // Deactivate all tab buttons
//       document.querySelectorAll('.tab-button').forEach(btn => {
//         btn.classList.remove('border-blue-500', 'text-blue-600');
//         btn.classList.add('border-transparent', 'hover:text-gray-600', 'hover:border-gray-300');
//         btn.setAttribute('aria-selected', 'false');
//       });
      
//       // Activate the clicked tab
//       document.getElementById(tabId).classList.remove('hidden');
//       document.getElementById(tabId).classList.add('active');
      
//       // Activate the clicked tab button
//       this.classList.remove('border-transparent', 'hover:text-gray-600', 'hover:border-gray-300');
//       this.classList.add('border-blue-500', 'text-blue-600');
//       this.setAttribute('aria-selected', 'true');
//     });
//   });
  
//   // Add event listeners for view toggling in Products tab
//   document.getElementById('cardsViewBtn')?.addEventListener('click', function() {
//     document.getElementById('cards-view').classList.remove('hidden');
//     document.getElementById('table-view').classList.add('hidden');
//     this.classList.remove('bg-gray-200', 'hover:bg-gray-300', 'text-gray-700');
//     this.classList.add('bg-blue-500', 'hover:bg-blue-600', 'text-white');
//     document.getElementById('tableViewBtn').classList.remove('bg-blue-500', 'hover:bg-blue-600', 'text-white');
//     document.getElementById('tableViewBtn').classList.add('bg-gray-200', 'hover:bg-gray-300', 'text-gray-700');
//   });
  
//   document.getElementById('tableViewBtn')?.addEventListener('click', function() {
//     document.getElementById('table-view').classList.remove('hidden');
//     document.getElementById('cards-view').classList.add('hidden');
//     this.classList.remove('bg-gray-200', 'hover:bg-gray-300', 'text-gray-700');
//     this.classList.add('bg-blue-500', 'hover:bg-blue-600', 'text-white');
//     document.getElementById('cardsViewBtn').classList.remove('bg-blue-500', 'hover:bg-blue-600', 'text-white');
//     document.getElementById('cardsViewBtn').classList.add('bg-gray-200', 'hover:bg-gray-300', 'text-gray-700');
//   });
  
//   // Add event listener for expand all button
//   document.getElementById('expandAllBtn')?.addEventListener('click', function() {
//     const allDetails = document.querySelectorAll('.product-details');
//     const isAnyHidden = Array.from(allDetails).some(el => el.classList.contains('hidden'));
    
//     if (isAnyHidden) {
//       // Expand all
//       allDetails.forEach(el => el.classList.remove('hidden'));
//       this.textContent = 'Collapse All';
      
//       // Rotate all toggle icons
//       document.querySelectorAll('.toggle-icon').forEach(icon => {
//         icon.style.transform = 'rotate(180deg)';
//       });
//     } else {
//       // Collapse all
//       allDetails.forEach(el => el.classList.add('hidden'));
//       this.textContent = 'Expand All';
      
//       // Reset all toggle icons
//       document.querySelectorAll('.toggle-icon').forEach(icon => {
//         icon.style.transform = 'rotate(0deg)';
//       });
//     }
//   });
// }


function displayOrangeBookData(data) {
  // Count total entries across all categories
  const totalProducts = data.total.products || 0;
  const totalPatents = data.total.patents || 0;
  const totalExclusivity = data.total.exclusivity || 0;
  
  // Group products by trade name
  const groups = groupProductsByName(data.results.products);
  
  // Set initial grouping state
  let groupedView = true;
  
  // Update counter to show all categories
  elements.orangeBookCount.textContent = `${totalProducts} Products | ${totalPatents} Patents | ${totalExclusivity} Exclusivity Records`;
  
  if (totalProducts === 0 && totalPatents === 0 && totalExclusivity === 0) {
    elements.orangeBookData.innerHTML = `
      <div class="text-center p-4 rounded bg-gray-50">
        <p class="text-sm text-gray-700">No Orange Book entries found</p>
      </div>
    `;
    return false;
  }
  
  // Create tab navigation 
  let html = `
    <div class="mb-4 border-b border-gray-200">
        <style>
            /* Orange Book Specific Styles */

/* Tab Navigation */
.tab-button {
  transition: all 0.2s ease-in-out;
}

.tab-button:focus {
  outline: none;
  box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
}

.tab-pane {
  display: none;
}

.tab-pane.active {
  display: block;
  animation: fadeIn 0.3s ease-in-out;
}

/* Group Styles */
.group-parent-row {
  transition: background-color 0.2s ease-in-out;
}

.group-parent-row:hover {
  background-color: #f0f4f8;
}

.group-child-row {
  transition: background-color 0.2s ease-in-out;
  background-color: #fefefe;
}

.group-child-row:hover {
  background-color: #f9fafb;
}

.group-toggle {
  transition: transform 0.3s ease;
}

.highlight-card {
  animation: highlightPulse 2s ease-in-out;
}

@keyframes highlightPulse {
  0%, 100% {
    box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
  }
  50% {
    box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.4);
  }
}

/* Product Card Styles */
.product-card {
  transition: box-shadow 0.2s ease-in-out;
}

.product-card:hover {
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

.product-header {
  transition: background-color 0.2s ease-in-out;
}

.product-header:hover {
  background-color: #f9fafb;
}

.product-details {
  transition: max-height 0.3s ease-out, opacity 0.2s ease-in-out;
}

/* Toggle Icon Animation */
.toggle-icon {
  transition: transform 0.3s ease;
}

/* Related Tabs Within Product */
.related-tab {
  transition: all 0.2s ease-in-out;
}

.related-tab:focus {
  outline: none;
}

.related-pane {
  display: none;
}

.related-pane.active {
  display: block;
  animation: fadeIn 0.3s ease-in-out;
}

/* Badge styling */
.badge {
  display: inline-block;
  padding: 0.125rem 0.5rem;
  border-radius: 9999px;
  font-size: 0.75rem;
  font-weight: 500;
  text-align: center;
}

.badge-blue {
  background-color: #e0f2fe;
  color: #0369a1;
}

.badge-green {
  background-color: #dcfce7;
  color: #166534;
}

.badge-purple {
  background-color: #f3e8ff;
  color: #7e22ce;
}

.badge-yellow {
  background-color: #fef9c3;
  color: #854d0e;
}

.badge-red {
  background-color: #fee2e2;
  color: #b91c1c;
}

/* Animation for loading spinners */
@keyframes spin {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}

.animate-spin {
  animation: spin 1s linear infinite;
}

/* Fade in animation */
@keyframes fadeIn {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* Table hover effects */
tr.hover\:bg-gray-50:hover {
  background-color: #f9fafb;
}

/* Link styles */
a.text-blue-600 {
  text-decoration: none;
}

a.text-blue-600:hover {
  text-decoration: underline;
}

/* Custom scrollbar for tables */
.overflow-x-auto::-webkit-scrollbar {
  height: 8px;
}

.overflow-x-auto::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 4px;
}

.overflow-x-auto::-webkit-scrollbar-thumb {
  background: #d1d5db;
  border-radius: 4px;
}

.overflow-x-auto::-webkit-scrollbar-thumb:hover {
  background: #9ca3af;
}

/* Modal styles */
.modal-container {
  animation: fadeIn 0.2s ease-in-out;
}

.modal-content {
  max-height: 80vh;
  overflow-y: auto;
}

/* Print styles */
@media print {
  .no-print {
    display: none !important;
  }
  
  .overflow-x-auto {
    overflow: visible !important;
  }
  
  .tab-content {
    display: block !important;
  }
  
  .tab-pane {
    display: block !important;
    page-break-after: always;
  }
  
  .product-details {
    display: block !important;
  }
}
  </style>
      <ul class="flex flex-wrap -mb-px text-sm font-medium text-center" role="tablist">
        <li class="mr-2" role="presentation">
          <button class="tab-button inline-block p-4 border-b-2 border-blue-500 rounded-t-lg active text-blue-600" 
                  id="products-tab" 
                  data-tab="products-content"
                  aria-selected="true">
            Products (${totalProducts})
          </button>
        </li>
        <li class="mr-2" role="presentation">
          <button class="tab-button inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300" 
                  id="patents-tab" 
                  data-tab="patents-content"
                  aria-selected="false">
            Patents (${totalPatents})
          </button>
        </li>
        <li role="presentation">
          <button class="tab-button inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300" 
                  id="exclusivity-tab" 
                  data-tab="exclusivity-content"
                  aria-selected="false">
            Exclusivity (${totalExclusivity})
          </button>
        </li>
      </ul>
    </div>
    
    <div class="tab-content">
      <!-- Products Tab Content -->
      <div id="products-content" class="tab-pane active">
        <div class="overflow-x-auto rounded-lg border border-gray-200 shadow-sm">
          <div class="flex justify-between p-2 bg-gray-50">
            <div class="flex items-center">
              <span class="text-xs text-gray-500">Toggle view:</span>
              <button id="cardsViewBtn" class="ml-2 text-xs bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded">
                Cards
              </button>
              <button id="tableViewBtn" class="ml-2 text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-1 rounded">
                Table
              </button>
            </div>
            <button id="expandAllBtn" class="text-xs bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded">
              Expand All
            </button>
          </div>
          
          <!-- Card View (default) -->
          <div id="cards-view" class="divide-y divide-gray-200">
  `;
  
  // Add product cards (limit to 20 for performance)
  const productsToShow = Math.min(data.results.products.length, 20);
  
  for (let i = 0; i < productsToShow; i++) {
    const product = data.results.products[i];
    const hasPatents = product.related_patents && product.related_patents.length > 0;
    const hasExclusivity = product.related_exclusivity && product.related_exclusivity.length > 0;
    
    html += `
      <div class="product-card bg-white overflow-hidden" data-product-id="${product.Appl_No}-${product.Product_No}">
        <!-- Product Header -->
        <div class="flex justify-between items-center p-4 cursor-pointer product-header" 
             onclick="toggleProductDetails('${product.Appl_No}-${product.Product_No}')">
          <div>
            <h3 class="text-lg font-medium text-gray-900">${product.Trade_Name || 'Unnamed Product'}</h3>
            <div class="text-sm text-gray-500">
              ${product.Ingredient || 'N/A'} | ${product.Strength || 'N/A'} | ${product.DF_Route || product["DF;Route"] || 'N/A'}
            </div>
          </div>
          <div class="flex items-center">
            <span class="text-sm bg-blue-100 text-blue-800 px-2 py-1 rounded mr-2">
              ${product.Appl_Type || ''}-${product.Appl_No || ''}
            </span>
            <svg class="toggle-icon w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
          </div>
        </div>
        
        <!-- Product Details (hidden by default) -->
        <div class="product-details hidden p-4 border-t border-gray-200 bg-gray-50" id="details-${product.Appl_No}-${product.Product_No}">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Product Information -->
            <div class="bg-white p-3 rounded shadow-sm">
              <h4 class="font-medium text-gray-700 mb-2">Product Information</h4>
              <table class="w-full text-sm">
                <tbody>
                  <tr>
                    <td class="py-1 pr-2 text-gray-500">Applicant</td>
                    <td class="py-1">${product.Applicant_Full_Name || product.Applicant || 'N/A'}</td>
                  </tr>
                  <tr>
                    <td class="py-1 pr-2 text-gray-500">Approval Date</td>
                    <td class="py-1">${product.Approval_Date || 'N/A'}</td>
                  </tr>
                  <tr>
                    <td class="py-1 pr-2 text-gray-500">Type</td>
                    <td class="py-1">${product.Type || 'N/A'}</td>
                  </tr>
                  <tr>
                    <td class="py-1 pr-2 text-gray-500">RLD/RS</td>
                    <td class="py-1">
                      ${product.RLD === 'Yes' ? '<span class="badge badge-green">RLD</span>' : ''}
                      ${product.RS === 'Yes' ? '<span class="badge badge-purple ml-1">RS</span>' : ''}
                    </td>
                  </tr>
                  <tr>
                    <td class="py-1 pr-2 text-gray-500">TE Code</td>
                    <td class="py-1">${product.TE_Code || 'N/A'}</td>
                  </tr>
                </tbody>
              </table>
            </div>
            
            <!-- Links & Resources -->
            <div class="bg-white p-3 rounded shadow-sm">
              <h4 class="font-medium text-gray-700 mb-2">Links & Resources</h4>
              <div class="space-y-2">
                <a href="https://www.accessdata.fda.gov/scripts/cder/ob/results_product.cfm?Appl_Type=${product.Appl_Type}&Appl_No=${product.Appl_No}" 
                   target="_blank" 
                   class="block w-full text-center bg-blue-50 hover:bg-blue-100 text-blue-700 p-2 rounded text-sm transition">
                  View on FDA Orange Book
                </a>
                <a href="https://dailymed.nlm.nih.gov/dailymed/search.cfm?query=${encodeURIComponent(product.Ingredient)}" 
                   target="_blank" 
                   class="block w-full text-center bg-blue-50 hover:bg-blue-100 text-blue-700 p-2 rounded text-sm transition">
                  Search on DailyMed
                </a>
                <a href="https://www.drugs.com/search.php?searchterm=${encodeURIComponent(product.Trade_Name || product.Ingredient)}" 
                   target="_blank" 
                   class="block w-full text-center bg-blue-50 hover:bg-blue-100 text-blue-700 p-2 rounded text-sm transition">
                  Search on Drugs.com
                </a>
              </div>
            </div>
          </div>
          
          <!-- Related Data Tabs -->
          <div class="mt-4">
            <div class="border-b border-gray-200">
              <ul class="flex flex-wrap -mb-px text-xs font-medium text-center">
                <li class="mr-2">
                  <button class="related-tab inline-block p-2 border-b-2 border-blue-500 rounded-t-lg active text-blue-600" 
                          onclick="switchRelatedTab(this, 'related-info-${product.Appl_No}-${product.Product_No}')">
                    Product Info
                  </button>
                </li>
                <li class="mr-2">
                  <button class="related-tab inline-block p-2 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300" 
                          onclick="switchRelatedTab(this, 'related-patents-${product.Appl_No}-${product.Product_No}')">
                    Patents ${hasPatents ? `(${product.related_patents.length})` : '(0)'}
                  </button>
                </li>
                <li>
                  <button class="related-tab inline-block p-2 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300" 
                          onclick="switchRelatedTab(this, 'related-exclusivity-${product.Appl_No}-${product.Product_No}')">
                    Exclusivity ${hasExclusivity ? `(${product.related_exclusivity.length})` : '(0)'}
                  </button>
                </li>
              </ul>
            </div>
            
            <!-- Related Content -->
            <div class="related-content">
              <!-- Product Info Tab (active by default, we keep it empty as it's already shown above) -->
              <div id="related-info-${product.Appl_No}-${product.Product_No}" class="related-pane active mt-3">
                <!-- Already shown above, keep this empty or add additional info -->
              </div>
              
              <!-- Patents Tab -->
              <div id="related-patents-${product.Appl_No}-${product.Product_No}" class="related-pane hidden mt-3">
                ${hasPatents ? `
                  <div class="overflow-x-auto bg-white rounded shadow-sm">
                    <table class="min-w-full divide-y divide-gray-200">
                      <thead class="bg-gray-50">
                        <tr>
                          <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Patent No</th>
                          <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Expiration</th>
                          <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Drug Sub/Prod</th>
                          <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Use Code</th>
                        </tr>
                      </thead>
                      <tbody class="divide-y divide-gray-200">
                        ${product.related_patents.map(patent => `
                          <tr class="hover:bg-gray-50">
                            <td class="px-3 py-2 text-sm">
                              <a href="https://patents.google.com/patent/US${patent.Patent_No}" 
                                 target="_blank" 
                                 class="text-blue-600 hover:underline">${patent.Patent_No}</a>
                            </td>
                            <td class="px-3 py-2 text-sm">${patent.Patent_Expire_Date_Text || 'N/A'}</td>
                            <td class="px-3 py-2 text-sm">
                              ${patent.Drug_Substance_Flag === 'Y' ? '<span class="badge badge-blue">DS</span>' : ''}
                              ${patent.Drug_Product_Flag === 'Y' ? '<span class="badge badge-green ml-1">DP</span>' : ''}
                            </td>
                            <td class="px-3 py-2 text-sm">${patent.Patent_Use_Code || 'N/A'}</td>
                          </tr>
                        `).join('')}
                      </tbody>
                    </table>
                  </div>
                ` : '<p class="text-sm text-gray-500">No patents found for this product.</p>'}
              </div>
              
              <!-- Exclusivity Tab -->
              <div id="related-exclusivity-${product.Appl_No}-${product.Product_No}" class="related-pane hidden mt-3">
                ${hasExclusivity ? `
                  <div class="overflow-x-auto bg-white rounded shadow-sm">
                    <table class="min-w-full divide-y divide-gray-200">
                      <thead class="bg-gray-50">
                        <tr>
                          <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Code</th>
                          <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                        </tr>
                      </thead>
                      <tbody class="divide-y divide-gray-200">
                        ${product.related_exclusivity.map(exclusivity => `
                          <tr class="hover:bg-gray-50">
                            <td class="px-3 py-2 text-sm font-medium">
                              <span class="badge badge-yellow">
                                ${exclusivity.Exclusivity_Code || 'N/A'}
                              </span>
                            </td>
                            <td class="px-3 py-2 text-sm">${exclusivity.Exclusivity_Date || 'N/A'}</td>
                          </tr>
                        `).join('')}
                      </tbody>
                    </table>
                  </div>
                ` : '<p class="text-sm text-gray-500">No exclusivity records found for this product.</p>'}
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
  }
  
  html += `
          </div>
          
          <!-- Table View (hidden by default) -->
          <div id="table-view" class="hidden">
            <div class="mb-2 flex justify-between">
              <div>
                <button id="expandAllGroupsBtn" class="text-xs bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded mr-2">
                  Expand All Groups
                </button>
                <button id="collapseAllGroupsBtn" class="text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-1 rounded">
                  Collapse All Groups
                </button>
              </div>
              <div>
                <button id="toggleGroupingBtn" class="text-xs bg-purple-500 hover:bg-purple-600 text-white px-3 py-1 rounded">
                  ${groupedView ? 'Disable Grouping' : 'Enable Grouping'}
                </button>
              </div>
            </div>

            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  ${groupedView ? `
                    <th colspan="6" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Grouped by Trade Name (${groups.length} unique products)
                    </th>
                  ` : `
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Trade Name</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ingredient</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Strength</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Route</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Application</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Approval Date</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Relations</th>
                  `}
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200" id="productsTableBody">
                ${groupedView ? 
                  createGroupedTableRows(groups) : 
                  data.results.products.slice(0, 50).map(product => `
                    <tr class="hover:bg-gray-50">
                      <td class="px-6 py-4 text-sm font-medium text-gray-900">${product.Trade_Name || 'N/A'}</td>
                      <td class="px-6 py-4 text-sm text-gray-500">${product.Ingredient || 'N/A'}</td>
                      <td class="px-6 py-4 text-sm text-gray-500">${product.Strength || 'N/A'}</td>
                      <td class="px-6 py-4 text-sm text-gray-500">${product.DF_Route || product["DF;Route"] || 'N/A'}</td>
                      <td class="px-6 py-4 text-sm text-gray-500">${product.Appl_Type || ''}-${product.Appl_No || ''}</td>
                      <td class="px-6 py-4 text-sm text-gray-500">${product.Approval_Date || 'N/A'}</td>
                      <td class="px-6 py-4 text-sm text-gray-500">
                        <div class="flex space-x-1">
                          ${product.related_patents && product.related_patents.length ? 
                            `<span class="badge badge-blue">Patents: ${product.related_patents.length}</span>` : ''}
                          ${product.related_exclusivity && product.related_exclusivity.length ? 
                            `<span class="badge badge-yellow">Exclusivity: ${product.related_exclusivity.length}</span>` : ''}
                        </div>
                        <button class="mt-1 text-xs text-blue-600 hover:underline" 
                                onclick="showProductDetails('${product.Appl_Type}', '${product.Appl_No}', '${product.Product_No}')">
                          View details
                        </button>
                      </td>
                    </tr>
                  `).join('')
                }
              </tbody>
            </table>
            ${data.results.products.length > 50 ? `
              <div class="text-xs text-gray-500 mt-2 text-right">
                Showing ${groupedView ? groups.length : '50'} of ${groupedView ? groups.length : data.results.products.length} entries
              </div>
            ` : ''}
          </div>
        </div>
      </div>
      
      <!-- Patents Tab Content -->
      <div id="patents-content" class="tab-pane hidden">
        <div class="overflow-x-auto rounded-lg border border-gray-200 shadow-sm">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Patent No</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Application</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Expiration</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Drug Sub/Prod</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Use Code</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Related Product</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              ${data.results.patents.slice(0, 20).map(patent => {
                // Find related product information if available
                const relatedProduct = data.results.products.find(p => 
                  p.Appl_Type === patent.Appl_Type && 
                  p.Appl_No === patent.Appl_No && 
                  p.Product_No === patent.Product_No
                );
                
                return `
                  <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 text-sm font-medium text-blue-600 hover:underline">
                      <a href="https://patents.google.com/patent/US${patent.Patent_No}" target="_blank">${patent.Patent_No}</a>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-500">${patent.Appl_Type || ''}-${patent.Appl_No || ''}-${patent.Product_No || ''}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${patent.Patent_Expire_Date_Text || 'N/A'}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">
                      ${patent.Drug_Substance_Flag === 'Y' ? '<span class="badge badge-blue">DS</span>' : ''}
                      ${patent.Drug_Product_Flag === 'Y' ? '<span class="badge badge-green ml-1">DP</span>' : ''}
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-500">${patent.Patent_Use_Code || 'N/A'}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">
                      ${relatedProduct ? 
                        `<span class="font-medium">${relatedProduct.Trade_Name || 'Unnamed Product'}</span><br>
                         <span class="text-xs">${relatedProduct.Ingredient || 'N/A'}</span>` : 
                        'No related product found'}
                    </td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        </div>
        ${data.results.patents.length > 20 ? `
          <div class="text-xs text-gray-500 mt-2 text-right">
            Showing 20 of ${data.results.patents.length} entries
          </div>
        ` : ''}
      </div>
      
      <!-- Exclusivity Tab Content -->
      <div id="exclusivity-content" class="tab-pane hidden">
        <div class="overflow-x-auto rounded-lg border border-gray-200 shadow-sm">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Code</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Application</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Related Product</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              ${data.results.exclusivity.slice(0, 20).map(exclusivity => {
                // Find related product information if available
                const relatedProduct = data.results.products.find(p => 
                  p.Appl_Type === exclusivity.Appl_Type && 
                  p.Appl_No === exclusivity.Appl_No && 
                  p.Product_No === exclusivity.Product_No
                );
                
                return `
                  <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 text-sm font-medium">
                      <span class="badge badge-yellow">${exclusivity.Exclusivity_Code || 'N/A'}</span>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-500">${exclusivity.Appl_Type || ''}-${exclusivity.Appl_No || ''}-${exclusivity.Product_No || ''}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${exclusivity.Exclusivity_Date || 'N/A'}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">
                      ${relatedProduct ? 
                        `<span class="font-medium">${relatedProduct.Trade_Name || 'Unnamed Product'}</span><br>
                         <span class="text-xs">${relatedProduct.Ingredient || 'N/A'}</span>` : 
                        'No related product found'}
                    </td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        </div>
        ${data.results.exclusivity.length > 20 ? `
          <div class="text-xs text-gray-500 mt-2 text-right">
            Showing 20 of ${data.results.exclusivity.length} entries
          </div>
        ` : ''}
      </div>
    </div>
  `;
  
  elements.orangeBookData.innerHTML = html;
  
  // Add event listeners to tabs
  document.querySelectorAll('.tab-button').forEach(button => {
    button.addEventListener('click', function() {
      const tabId = this.getAttribute('data-tab');
      
      // Hide all tab panes
      document.querySelectorAll('.tab-pane').forEach(pane => {
        pane.classList.add('hidden');
        pane.classList.remove('active');
      });
      
      // Deactivate all tab buttons
      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('border-blue-500', 'text-blue-600');
        btn.classList.add('border-transparent', 'hover:text-gray-600', 'hover:border-gray-300');
        btn.setAttribute('aria-selected', 'false');
      });
      
      // Activate the clicked tab
      document.getElementById(tabId).classList.remove('hidden');
      document.getElementById(tabId).classList.add('active');
      
      // Activate the clicked tab button
      this.classList.remove('border-transparent', 'hover:text-gray-600', 'hover:border-gray-300');
      this.classList.add('border-blue-500', 'text-blue-600');
      this.setAttribute('aria-selected', 'true');
    });
  });
  
  // Add event listeners for view toggling in Products tab
  document.getElementById('cardsViewBtn')?.addEventListener('click', function() {
    document.getElementById('cards-view').classList.remove('hidden');
    document.getElementById('table-view').classList.add('hidden');
    this.classList.remove('bg-gray-200', 'hover:bg-gray-300', 'text-gray-700');
    this.classList.add('bg-blue-500', 'hover:bg-blue-600', 'text-white');
    document.getElementById('tableViewBtn').classList.remove('bg-blue-500', 'hover:bg-blue-600', 'text-white');
    document.getElementById('tableViewBtn').classList.add('bg-gray-200', 'hover:bg-gray-300', 'text-gray-700');
  });
  
  document.getElementById('tableViewBtn')?.addEventListener('click', function() {
    document.getElementById('table-view').classList.remove('hidden');
    document.getElementById('cards-view').classList.add('hidden');
    this.classList.remove('bg-gray-200', 'hover:bg-gray-300', 'text-gray-700');
    this.classList.add('bg-blue-500', 'hover:bg-blue-600', 'text-white');
    document.getElementById('cardsViewBtn').classList.remove('bg-blue-500', 'hover:bg-blue-600', 'text-white');
    document.getElementById('cardsViewBtn').classList.add('bg-gray-200', 'hover:bg-gray-300', 'text-gray-700');
  });
  
  // Add event listener for expand all button
  document.getElementById('expandAllBtn')?.addEventListener('click', function() {
    const allDetails = document.querySelectorAll('.product-details');
    const isAnyHidden = Array.from(allDetails).some(el => el.classList.contains('hidden'));
    
    if (isAnyHidden) {
      // Expand all
      allDetails.forEach(el => el.classList.remove('hidden'));
      this.textContent = 'Collapse All';
      
      // Rotate all toggle icons
      document.querySelectorAll('.toggle-icon').forEach(icon => {
        icon.style.transform = 'rotate(180deg)';
      });
    } else {
      // Collapse all
      allDetails.forEach(el => el.classList.add('hidden'));
      this.textContent = 'Expand All';
      
      // Reset all toggle icons
      document.querySelectorAll('.toggle-icon').forEach(icon => {
        icon.style.transform = 'rotate(0deg)';
      });
    }
  });
  
  // Add event listeners for grouping controls
  document.getElementById('expandAllGroupsBtn')?.addEventListener('click', function() {
    expandAllGroups();
  });
  
  document.getElementById('collapseAllGroupsBtn')?.addEventListener('click', function() {
    collapseAllGroups();
  });
  
  document.getElementById('toggleGroupingBtn')?.addEventListener('click', function() {
    // Toggle grouping state
    groupedView = !groupedView;
    
    // Update button text
    this.textContent = groupedView ? 'Disable Grouping' : 'Enable Grouping';
    
    // Rebuild the table with the new grouping setting
    const tableBody = document.getElementById('productsTableBody');
    const headerRow = tableBody.previousElementSibling.querySelector('tr');
    
    if (groupedView) {
      // Update header for grouped view
      headerRow.innerHTML = `
        <th colspan="6" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
          Grouped by Trade Name (${groups.length} unique products)
        </th>
      `;
      
      // Update content for grouped view
      tableBody.innerHTML = createGroupedTableRows(groups);
    } else {
      // Update header for ungrouped view
      headerRow.innerHTML = `
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Trade Name</th>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ingredient</th>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Strength</th>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Route</th>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Application</th>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Approval Date</th>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Relations</th>
      `;
      
      // Update content for ungrouped view
      tableBody.innerHTML = data.results.products.slice(0, 50).map(product => `
        <tr class="hover:bg-gray-50">
          <td class="px-6 py-4 text-sm font-medium text-gray-900">${product.Trade_Name || 'N/A'}</td>
          <td class="px-6 py-4 text-sm text-gray-500">${product.Ingredient || 'N/A'}</td>
          <td class="px-6 py-4 text-sm text-gray-500">${product.Strength || 'N/A'}</td>
          <td class="px-6 py-4 text-sm text-gray-500">${product.DF_Route || product["DF;Route"] || 'N/A'}</td>
          <td class="px-6 py-4 text-sm text-gray-500">${product.Appl_Type || ''}-${product.Appl_No || ''}</td>
          <td class="px-6 py-4 text-sm text-gray-500">${product.Approval_Date || 'N/A'}</td>
          <td class="px-6 py-4 text-sm text-gray-500">
            <div class="flex space-x-1">
              ${product.related_patents && product.related_patents.length ? 
                `<span class="badge badge-blue">Patents: ${product.related_patents.length}</span>` : ''}
              ${product.related_exclusivity && product.related_exclusivity.length ? 
                `<span class="badge badge-yellow">Exclusivity: ${product.related_exclusivity.length}</span>` : ''}
            </div>
            <button class="mt-1 text-xs text-blue-600 hover:underline" 
                    onclick="showProductDetails('${product.Appl_Type}', '${product.Appl_No}', '${product.Product_No}')">
              View details
            </button>
          </td>
        </tr>
      `).join('');
    }
  });
}



// Function to toggle product details
function toggleProductDetails(productId) {
  const detailsElement = document.getElementById(`details-${productId}`);
  const headerElement = detailsElement.previousElementSibling;
  const iconElement = headerElement.querySelector('.toggle-icon');
  
  if (detailsElement.classList.contains('hidden')) {
    detailsElement.classList.remove('hidden');
    iconElement.style.transform = 'rotate(180deg)';
  } else {
    detailsElement.classList.add('hidden');
    iconElement.style.transform = 'rotate(0deg)';
  }
}

// Function to group products by trade name
function groupProductsByName(products) {
  const groupedProducts = {};
  
  // Group products by their trade name (case insensitive)
  products.forEach(product => {
    const tradeName = (product.Trade_Name || 'Unnamed Product').toUpperCase();
    
    if (!groupedProducts[tradeName]) {
      groupedProducts[tradeName] = [];
    }
    
    groupedProducts[tradeName].push(product);
  });
  
  // Sort groups by trade name
  return Object.keys(groupedProducts)
    .sort()
    .map(tradeName => ({
      tradeName: tradeName,
      displayName: groupedProducts[tradeName][0].Trade_Name || 'Unnamed Product',
      products: groupedProducts[tradeName],
      count: groupedProducts[tradeName].length
    }));
}

// Function to create table rows for grouped products
function createGroupedTableRows(groups) {
  let html = '';
  
  groups.forEach(group => {
    // Create parent row for the group
    html += `
      <tr class="bg-gray-50 group-parent-row" data-group="${group.tradeName.replace(/\s/g, '_')}">
        <td colspan="6" class="px-4 py-3">
          <div class="flex justify-between items-center">
            <div class="flex items-center">
              <button class="group-toggle mr-2 focus:outline-none" onclick="toggleGroupVisibility('${group.tradeName.replace(/\s/g, '_')}')">
                <svg class="w-5 h-5 text-gray-600 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
              </button>
              <span class="font-medium">${group.displayName}</span>
            </div>
            <span class="badge badge-blue">${group.count} variations</span>
          </div>
        </td>
      </tr>
    `;
    
    // Create child rows for each product in the group (hidden by default)
    group.products.forEach(product => {
      html += `
        <tr class="group-child-row hidden" data-parent="${group.tradeName.replace(/\s/g, '_')}">
          <td class="px-6 py-4 pl-10 text-sm text-gray-900">${product.Ingredient || 'N/A'}</td>
          <td class="px-6 py-4 text-sm text-gray-500">${product.Strength || 'N/A'}</td>
          <td class="px-6 py-4 text-sm text-gray-500">${product.DF_Route || product["DF;Route"] || 'N/A'}</td>
          <td class="px-6 py-4 text-sm text-gray-500">${product.Appl_Type || ''}-${product.Appl_No || ''}</td>
          <td class="px-6 py-4 text-sm text-gray-500">${product.Approval_Date || 'N/A'}</td>
          <td class="px-6 py-4 text-sm text-gray-500">
            <div class="flex space-x-1">
              ${product.related_patents && product.related_patents.length ? 
                `<span class="badge badge-blue">Patents: ${product.related_patents.length}</span>` : ''}
              ${product.related_exclusivity && product.related_exclusivity.length ? 
                `<span class="badge badge-yellow">Exclusivity: ${product.related_exclusivity.length}</span>` : ''}
            </div>
            <button class="mt-1 text-xs text-blue-600 hover:underline" 
                    onclick="showProductDetails('${product.Appl_Type}', '${product.Appl_No}', '${product.Product_No}')">
              View details
            </button>
          </td>
        </tr>
      `;
    });
  });
  
  return html;
}

// Function to toggle visibility of group children
function toggleGroupVisibility(groupId) {
  const parentRow = document.querySelector(`tr[data-group="${groupId}"]`);
  const childRows = document.querySelectorAll(`tr[data-parent="${groupId}"]`);
  const toggleIcon = parentRow.querySelector('.group-toggle svg');
  
  // Check if children are currently visible
  const isVisible = !childRows[0].classList.contains('hidden');
  
  // Toggle visibility
  childRows.forEach(row => {
    if (isVisible) {
      row.classList.add('hidden');
      toggleIcon.style.transform = 'rotate(0deg)';
    } else {
      row.classList.remove('hidden');
      toggleIcon.style.transform = 'rotate(180deg)';
    }
  });
}

// Function to expand all groups
function expandAllGroups() {
  const allGroupParents = document.querySelectorAll('.group-parent-row');
  
  allGroupParents.forEach(parent => {
    const groupId = parent.getAttribute('data-group');
    const childRows = document.querySelectorAll(`tr[data-parent="${groupId}"]`);
    const toggleIcon = parent.querySelector('.group-toggle svg');
    
    // Make all children visible
    childRows.forEach(row => row.classList.remove('hidden'));
    toggleIcon.style.transform = 'rotate(180deg)';
  });
}

// Function to collapse all groups
function collapseAllGroups() {
  const allGroupParents = document.querySelectorAll('.group-parent-row');
  
  allGroupParents.forEach(parent => {
    const groupId = parent.getAttribute('data-group');
    const childRows = document.querySelectorAll(`tr[data-parent="${groupId}"]`);
    const toggleIcon = parent.querySelector('.group-toggle svg');
    
    // Hide all children
    childRows.forEach(row => row.classList.add('hidden'));
    toggleIcon.style.transform = 'rotate(0deg)';
  });
}

// Function to show detailed product view
function showProductDetails(applType, applNo, productNo) {
  // First switch to the "Products" tab
  document.getElementById('products-tab').click();
  
  // Then switch to card view
  document.getElementById('cardsViewBtn').click();
  
  // Find the product card and expand it
  const productId = `${applNo}-${productNo}`;
  const productCard = document.querySelector(`[data-product-id="${productId}"]`);
  
  if (productCard) {
    // Scroll to the product card
    productCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
    
    // Highlight the card temporarily
    productCard.classList.add('highlight-card');
    setTimeout(() => {
      productCard.classList.remove('highlight-card');
    }, 2000);
    
    // Expand the card if it's collapsed
    const detailsElement = document.getElementById(`details-${productId}`);
    if (detailsElement && detailsElement.classList.contains('hidden')) {
      toggleProductDetails(productId);
    }
  }
}

// Function to switch related tabs within a product card
function switchRelatedTab(tabButton, contentId) {
  // Get parent container for scoping
  const productCard = tabButton.closest('.product-card');
  
  // Deactivate all tabs in this product card
  productCard.querySelectorAll('.related-tab').forEach(btn => {
    btn.classList.remove('border-blue-500', 'text-blue-600');
    btn.classList.add('border-transparent', 'hover:text-gray-600', 'hover:border-gray-300');
  });
  
  // Activate the clicked tab
  tabButton.classList.remove('border-transparent', 'hover:text-gray-600', 'hover:border-gray-300');
  tabButton.classList.add('border-blue-500', 'text-blue-600');
  
// Hide all related content panes in this product card
productCard.querySelectorAll('.related-pane').forEach(pane => {
    pane.classList.add('hidden');
    pane.classList.remove('active');
  });
  
  // Show the target content
  const contentElement = document.getElementById(contentId);
  contentElement.classList.remove('hidden');
  contentElement.classList.add('active');
}

// Function to handle Orange Book searching
function searchOrangeBook(query) {
  if (!query.trim()) {
    elements.orangeBookData.innerHTML = `
      <div class="text-center p-4">
        <p class="text-sm text-gray-700">Please enter a search term</p>
      </div>
    `;
    elements.orangeBookCount.textContent = '0 entries';
    return;
  }
  
  // Show loading state
  elements.orangeBookData.innerHTML = `
    <div class="text-center p-4">
      <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-gray-800"></div>
      <p class="mt-2 text-sm text-gray-700">Searching...</p>
    </div>
  `;
  
  // Make the API request
  fetch(`/api/fda/orangebook/search?q=${encodeURIComponent(query)}`)
    .then(response => {
      if (!response.ok) throw new Error('Network response was not ok');
      return response.json();
    })
    .then(data => {
      displayOrangeBookData(data);
    })
    .catch(error => {
      console.error('Error fetching Orange Book data:', error);
      elements.orangeBookData.innerHTML = `
        <div class="text-center p-4">
          <p class="text-sm text-red-600">Error: ${error.message}</p>
        </div>
      `;
      elements.orangeBookCount.textContent = '0 entries';
    });
}

// Export code reference tables (useful for understanding exclusivity/patent codes)
function exportCodeReference() {
  // Create reference data for exclusivity codes
  const exclusivityCodes = {
    "ODE": "Orphan Drug Exclusivity",
    "NCE": "New Chemical Entity Exclusivity",
    "NDF": "New Dosage Form Exclusivity",
    "NPE": "New Patient Population Exclusivity",
    "POA": "Pediatric Exclusivity",
    "PED": "Pediatric Exclusivity",
    "CSP": "Competitive Generic Therapy Exclusivity",
    "CRP": "GAIN Exclusivity",
    "EBE": "Biologics Exclusivity",
    "RTO": "Reference Product Exclusivity",
    "D-183": "3-Year Exclusivity",
    "D-193": "3-Year Exclusivity (Extended)",
    "BLA": "Biologics License Application Exclusivity"
  };
  
  // Create reference data for patent use codes
  const patentUseCodes = {
    "U-141": "Method of treating disease",
    "U-233": "Drug delivery mechanism",
    "U-510": "Method of use",
    "U-986": "Pharmaceutical composition",
    "U-1490": "Process of manufacturing",
    "U-1574": "Treatment regimen"
  };
  
  let referenceHTML = `
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <!-- Exclusivity Codes -->
      <div class="bg-white rounded shadow-sm p-4">
        <h3 class="font-medium text-gray-800 mb-3">Exclusivity Codes</h3>
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Code</th>
              <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Description</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200">
            ${Object.entries(exclusivityCodes).map(([code, desc]) => `
              <tr class="hover:bg-gray-50">
                <td class="px-3 py-2 text-sm font-medium">
                  <span class="badge badge-yellow">${code}</span>
                </td>
                <td class="px-3 py-2 text-sm">${desc}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
      
      <!-- Patent Use Codes -->
      <div class="bg-white rounded shadow-sm p-4">
        <h3 class="font-medium text-gray-800 mb-3">Patent Use Codes</h3>
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Code</th>
              <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Description</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200">
            ${Object.entries(patentUseCodes).map(([code, desc]) => `
              <tr class="hover:bg-gray-50">
                <td class="px-3 py-2 text-sm font-medium">
                  <span class="badge badge-blue">${code}</span>
                </td>
                <td class="px-3 py-2 text-sm">${desc}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    </div>
  `;
  
  // Create and show modal with the reference data
  const modalContainer = document.createElement('div');
  modalContainer.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
  modalContainer.id = 'referenceModal';
  
  modalContainer.innerHTML = `
    <div class="bg-white rounded-lg p-6 max-w-4xl max-h-[80vh] overflow-y-auto">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold text-gray-800">Orange Book Reference Codes</h2>
        <button id="closeReferenceModal" class="text-gray-500 hover:text-gray-700">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      ${referenceHTML}
    </div>
  `;
  
  document.body.appendChild(modalContainer);
  
  // Add event listener to close the modal
  document.getElementById('closeReferenceModal').addEventListener('click', function() {
    document.body.removeChild(modalContainer);
  });
  
  // Close modal when clicking outside
  modalContainer.addEventListener('click', function(event) {
    if (event.target === modalContainer) {
      document.body.removeChild(modalContainer);
    }
  });
}

// Function to show details for a specific application
function showApplicationDetails(applType, applNo, productNo) {
  // Construct the query to find the exact match
  const query = `${applType}-${applNo}-${productNo}`;
  
  // Show loading state
  elements.orangeBookData.innerHTML = `
    <div class="text-center p-4">
      <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-gray-800"></div>
      <p class="mt-2 text-sm text-gray-700">Fetching application details...</p>
    </div>
  `;
  
  // Search using the specific application identifier
  searchOrangeBook(query);
}

// Initialize event listeners when document is ready
document.addEventListener('DOMContentLoaded', function() {
  // Add event listener for the search form if it exists
  const searchForm = document.getElementById('orangeBookSearchForm');
  if (searchForm) {
    searchForm.addEventListener('submit', function(event) {
      event.preventDefault();
      const query = document.getElementById('orangeBookSearchInput').value;
      searchOrangeBook(query);
    });
  }
  
  // Add listener for reference code button if it exists
  const referenceButton = document.getElementById('showReferenceCodesBtn');
  if (referenceButton) {
    referenceButton.addEventListener('click', exportCodeReference);
  }
});


// function displayDailyMedData(data) {
//   const labelInfo = data.label_info || [];
  
//   // Update counter
//   elements.dailyMedCount.textContent = `${labelInfo.length} entries`;
  
//   if (labelInfo.length === 0) {
//     elements.dailyMedData.innerHTML = `
//       <div class="text-center p-4">
//         <p class="text-sm text-gray-700">No DailyMed information found</p>
//       </div>
//     `;
//     return;
//   }
  
//   // Create cards for each DailyMed entry
//   let html = `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">`;
  
//   for (const label of labelInfo) {
//     html += `
//       <div class="bg-white border border-gray-200 rounded p-3">
//         <h4 class="font-medium text-sm">${label.title}</h4>
//         <p class="text-xs text-gray-500 mt-1">Published: ${label.published}</p>
//         ${label.manufacturer ? `<p class="text-xs mt-1">Manufacturer: ${label.manufacturer}</p>` : ''}
//         ${label.dosageForm ? `<p class="text-xs mt-1">Dosage Form: ${label.dosageForm}</p>` : ''}
//         <div class="mt-2">
//           <a href="${label.labelUrl}" target="_blank" class="text-xs text-blue-600 hover:underline">
//             View on DailyMed
//           </a>
//         </div>
//       </div>
//     `;
//   }
  
//   html += `</div>`;
//   elements.dailyMedData.innerHTML = html;
// }


/**
 * Formats the drug data into a consistent structure for display
 * @param {Array} rawData - The raw drug data from the API
 * @returns {Object} - The formatted data
 */
 function formatDrugData(rawData) {
  // If no data or empty array, return empty structure
  if (!rawData || (Array.isArray(rawData) && rawData.length === 0)) {
    return { label_info: [] };
  }
  
  // Create the formatted structure
  const formattedData = {
    label_info: rawData.map(drug => ({
      title: drug.productName || drug.title || "Unknown Drug",
      published: drug.effectiveTime || "N/A",
      setId: drug.splId || "",
      manufacturer: drug.manufacturer || "Unknown",
      dosageForm: drug.dosageForms ? drug.dosageForms.join(', ') : "Not specified",
      activeIngredients: drug.activeIngredients || ["Unknown"],
      indications: drug.indications || "Not specified",
      warnings: drug.warnings || "Not specified",
      dosage: drug.dosage || "Not specified",
      contraindications: drug.contraindications || "Not specified",
      adverseReactions: drug.adverseReactions || "Not specified",
      drugInteractions: drug.drugInteractions || "Not specified",
      labelUrl: drug.labelUrl || `https://dailymed.nlm.nih.gov/dailymed/lookup.cfm?setid=${drug.splId}`
    }))
  };
  
  return formattedData;
}

/**
 * Displays DailyMed data in the UI with pagination
 * @param {Object} data - The formatted DailyMed data to display
 */
 function displayDailyMedData(data) {
  const elements = {
    dailyMedData: document.getElementById('dailyMedData'),
    dailyMedCount: document.getElementById('dailyMedCount'),
    dailyMedPagination: document.getElementById('dailyMedPagination')
  };
  
  const labelInfo = data.label_info || [];
  
  // Update counter
  elements.dailyMedCount.textContent = `${labelInfo.length} ${labelInfo.length === 1 ? 'entry' : 'entries'}`;
  
  if (labelInfo.length === 0) {
    elements.dailyMedData.innerHTML = `
      <div class="text-center p-4">
        <p class="text-sm text-gray-700">No DailyMed information found</p>
      </div>
    `;
    if (elements.dailyMedPagination) {
      elements.dailyMedPagination.innerHTML = '';
    }
    return;
  }

  // Initialize pagination
  const itemsPerPage = 5;
  const totalPages = Math.ceil(labelInfo.length / itemsPerPage);
  
  // Set up pagination in window for access across functions
  window.dailyMedPagination = {
    currentPage: 1,
    itemsPerPage: itemsPerPage,
    totalItems: labelInfo.length,
    totalPages: totalPages,
    data: labelInfo
  };
  
  // Render first page
  dailyMedRenderPage(1);
  
  // Create pagination controls
  dailyMedCreatePaginationControls();
}

/**
 * Renders a specific page of DailyMed data
 * @param {number} page - The page number to render
 */
function dailyMedRenderPage(page) {
  const pagination = window.dailyMedPagination;
  const elements = {
    dailyMedData: document.getElementById('dailyMedData')
  };
  
  // Validate page number
  if (page < 1) page = 1;
  if (page > pagination.totalPages) page = pagination.totalPages;
  
  // Update current page
  pagination.currentPage = page;
  
  // Calculate start and end indices
  const startIndex = (page - 1) * pagination.itemsPerPage;
  const endIndex = Math.min(startIndex + pagination.itemsPerPage, pagination.totalItems);
  
  // Get data for current page
  const currentPageData = pagination.data.slice(startIndex, endIndex);
  
  // Create cards for each DailyMed entry on current page
  let html = `<div class="space-y-4">`;
  
  for (const label of currentPageData) {
    const formattedDate = formatPublishedDate(label.published);
    
    html += `
      <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
        <div class="flex justify-between items-start">
          <div>
            <h3 class="font-semibold text-lg">${label.title}</h3>
            <p class="text-sm text-gray-500 mt-1">Published: ${formattedDate}</p>
          </div>
          <div class="flex space-x-2">
            <a href="${label.labelUrl}" target="_blank" class="text-xs bg-blue-50 hover:bg-blue-100 text-blue-700 px-2 py-1 rounded inline-flex items-center transition-colors">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
              </svg>
              View on DailyMed
            </a>
            ${label.setId ? `
            <a href="https://dailymed.nlm.nih.gov/dailymed/downloadpdffile.cfm?setId=${label.setId}" target="_blank" class="text-xs bg-red-50 hover:bg-red-100 text-red-700 px-2 py-1 rounded inline-flex items-center transition-colors">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
              </svg>
              PDF
            </a>` : ''}
          </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
          <div>
            <p class="text-sm"><span class="font-medium">Manufacturer:</span> ${label.manufacturer}</p>
            <p class="text-sm mt-1"><span class="font-medium">Dosage Form:</span> ${label.dosageForm}</p>
            
            <div class="mt-2">
              <p class="text-sm font-medium">Active Ingredients:</p>
              <ul class="list-disc text-sm ml-5 mt-1">
                ${label.activeIngredients.map(ingredient => `<li>${ingredient}</li>`).join('')}
              </ul>
            </div>
          </div>
          
          <div class="space-y-2">
            <details class="text-sm">
              <summary class="font-medium cursor-pointer">Indications</summary>
              <div class="mt-1 pl-3 border-l-2 border-gray-200 text-sm">
                ${formatTextContent(label.indications)}
              </div>
            </details>
            
            <details class="text-sm">
              <summary class="font-medium cursor-pointer text-red-700">Warnings</summary>
              <div class="mt-1 pl-3 border-l-2 border-red-200 text-sm">
                ${formatTextContent(label.warnings)}
              </div>
            </details>
            
            <details class="text-sm">
              <summary class="font-medium cursor-pointer">Dosage & Administration</summary>
              <div class="mt-1 pl-3 border-l-2 border-gray-200 text-sm">
                ${formatTextContent(label.dosage)}
              </div>
            </details>
          </div>
        </div>
        
        <details class="mt-4 text-sm">
          <summary class="font-medium cursor-pointer">Additional Information</summary>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
            <div>
              <details class="text-sm">
                <summary class="font-medium cursor-pointer">Contraindications</summary>
                <div class="mt-1 pl-3 border-l-2 border-gray-200 text-sm">
                  ${formatTextContent(label.contraindications)}
                </div>
              </details>
            </div>
            
            <div>
              <details class="text-sm">
                <summary class="font-medium cursor-pointer">Adverse Reactions</summary>
                <div class="mt-1 pl-3 border-l-2 border-gray-200 text-sm">
                  ${formatTextContent(label.adverseReactions)}
                </div>
              </details>
              
              <details class="text-sm mt-2">
                <summary class="font-medium cursor-pointer">Drug Interactions</summary>
                <div class="mt-1 pl-3 border-l-2 border-gray-200 text-sm">
                  ${formatTextContent(label.drugInteractions)}
                </div>
              </details>
            </div>
          </div>
        </details>
        
        <p class="text-xs text-gray-500 mt-3">SPL ID: ${label.setId}</p>
      </div>
    `;
  }
  
  html += `</div>`;
  elements.dailyMedData.innerHTML = html;
  
  // Update pagination controls to reflect current page
  dailyMedUpdatePaginationControls();
}

/**
 * Creates the pagination controls
 */
function dailyMedCreatePaginationControls() {
  const pagination = window.dailyMedPagination;
  const paginationElement = document.getElementById('dailyMedPagination');
  
  // If there's only one page, don't show pagination
  if (!paginationElement || pagination.totalPages <= 1) {
    if (paginationElement) {
      paginationElement.innerHTML = '';
    }
    return;
  }
  
  let html = `
    <div class="flex items-center justify-center space-x-1 mt-6">
      <button id="dailyMedFirstPage" class="px-3 py-1 rounded text-sm bg-gray-100 hover:bg-gray-200 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" aria-label="First page">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7" />
        </svg>
      </button>
      <button id="dailyMedPrevPage" class="px-3 py-1 rounded text-sm bg-gray-100 hover:bg-gray-200 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" aria-label="Previous page">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
      </button>
      
      <div id="dailyMedPageNumbers" class="flex items-center space-x-1">
        <!-- Page numbers will be inserted here -->
      </div>
      
      <button id="dailyMedNextPage" class="px-3 py-1 rounded text-sm bg-gray-100 hover:bg-gray-200 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" aria-label="Next page">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </button>
      <button id="dailyMedLastPage" class="px-3 py-1 rounded text-sm bg-gray-100 hover:bg-gray-200 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" aria-label="Last page">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7" />
        </svg>
      </button>
    </div>
    <div class="text-center text-sm text-gray-500 mt-2">
      <span id="dailyMedPageInfo"></span>
    </div>
  `;
  
  paginationElement.innerHTML = html;
  
  // Add event listeners
  document.getElementById('dailyMedFirstPage').addEventListener('click', () => dailyMedChangePage(1));
  document.getElementById('dailyMedPrevPage').addEventListener('click', () => dailyMedChangePage(pagination.currentPage - 1));
  document.getElementById('dailyMedNextPage').addEventListener('click', () => dailyMedChangePage(pagination.currentPage + 1));
  document.getElementById('dailyMedLastPage').addEventListener('click', () => dailyMedChangePage(pagination.totalPages));
  
  // Initial update for the pagination controls
  dailyMedUpdatePaginationControls();
}

/**
 * Updates the pagination controls to reflect the current state
 */
function dailyMedUpdatePaginationControls() {
  const pagination = window.dailyMedPagination;
  
  // If no pagination data exists, exit
  if (!pagination) return;
  
  const currentPage = pagination.currentPage;
  const totalPages = pagination.totalPages;
  
  // Update button states
  const firstPageBtn = document.getElementById('dailyMedFirstPage');
  const prevPageBtn = document.getElementById('dailyMedPrevPage');
  const nextPageBtn = document.getElementById('dailyMedNextPage');
  const lastPageBtn = document.getElementById('dailyMedLastPage');
  
  if (firstPageBtn) {
    firstPageBtn.disabled = currentPage === 1;
  }
  
  if (prevPageBtn) {
    prevPageBtn.disabled = currentPage === 1;
  }
  
  if (nextPageBtn) {
    nextPageBtn.disabled = currentPage === totalPages;
  }
  
  if (lastPageBtn) {
    lastPageBtn.disabled = currentPage === totalPages;
  }
  
  // Update page numbers
  const pageNumbersContainer = document.getElementById('dailyMedPageNumbers');
  if (pageNumbersContainer) {
    let pageNumbersHtml = '';
    
    // Logic to show a subset of page numbers with ellipsis for many pages
    const maxPagesToShow = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxPagesToShow / 2));
    let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);
    
    // Adjust if we're near the ends
    if (endPage - startPage + 1 < maxPagesToShow) {
      startPage = Math.max(1, endPage - maxPagesToShow + 1);
    }
    
    // First page
    if (startPage > 1) {
      pageNumbersHtml += `
        <button class="px-3 py-1 rounded text-sm ${currentPage === 1 ? 'bg-blue-600 text-white' : 'bg-gray-100 hover:bg-gray-200'}" 
          data-page="1" aria-label="Page 1">1</button>
      `;
      
      // Add ellipsis if there's a gap
      if (startPage > 2) {
        pageNumbersHtml += `
          <span class="px-1 py-1 text-sm text-gray-500">...</span>
        `;
      }
    }
    
    // Generate page numbers
    for (let i = startPage; i <= endPage; i++) {
      pageNumbersHtml += `
        <button class="px-3 py-1 rounded text-sm ${currentPage === i ? 'bg-blue-600 text-white' : 'bg-gray-100 hover:bg-gray-200'}" 
          data-page="${i}" aria-label="Page ${i}">${i}</button>
      `;
    }
    
    // Last page
    if (endPage < totalPages) {
      // Add ellipsis if there's a gap
      if (endPage < totalPages - 1) {
        pageNumbersHtml += `
          <span class="px-1 py-1 text-sm text-gray-500">...</span>
        `;
      }
      
      pageNumbersHtml += `
        <button class="px-3 py-1 rounded text-sm ${currentPage === totalPages ? 'bg-blue-600 text-white' : 'bg-gray-100 hover:bg-gray-200'}" 
          data-page="${totalPages}" aria-label="Page ${totalPages}">${totalPages}</button>
      `;
    }
    
    pageNumbersContainer.innerHTML = pageNumbersHtml;
    
    // Add event listeners to page number buttons
    const pageButtons = pageNumbersContainer.querySelectorAll('button[data-page]');
    pageButtons.forEach(button => {
      button.addEventListener('click', (e) => {
        const pageNumber = parseInt(e.target.getAttribute('data-page'), 10);
        dailyMedChangePage(pageNumber);
      });
    });
  }
  
  // Update page info text
  const pageInfoElement = document.getElementById('dailyMedPageInfo');
  if (pageInfoElement) {
    const startItem = ((currentPage - 1) * pagination.itemsPerPage) + 1;
    const endItem = Math.min(startItem + pagination.itemsPerPage - 1, pagination.totalItems);
    pageInfoElement.textContent = `Showing ${startItem}-${endItem} of ${pagination.totalItems} entries`;
  }
}

/**
 * Changes to a specific page
 * @param {number} page - The page number to navigate to
 */
function dailyMedChangePage(page) {
  const pagination = window.dailyMedPagination;
  
  // Validate page number
  if (page < 1 || page > pagination.totalPages) {
    return;
  }
  
  // Render the requested page
  dailyMedRenderPage(page);
  
  // Scroll to top of the DailyMed data section
  const dailyMedData = document.getElementById('dailyMedData');
  if (dailyMedData) {
    dailyMedData.scrollIntoView({ behavior: 'smooth' });
  }
}

/**
 * Formats text content with proper paragraphs
 * @param {string} text - The text to format
 * @returns {string} - The formatted HTML
 */
function formatTextContent(text) {
  if (!text || text === "Not specified") {
    return "<p>Not specified</p>";
  }
  
  // Split by double newlines for paragraphs
  const paragraphs = text.split(/\n\n+/).filter(p => p.trim());
  
  if (paragraphs.length === 0) {
    return `<p>${text}</p>`;
  }
  
  return paragraphs.map(p => `<p class="mb-2">${p.trim()}</p>`).join('');
}

/**
 * Formats the published date in a more readable way
 * @param {string} dateStr - The date string to format
 * @returns {string} - The formatted date
 */
function formatPublishedDate(dateStr) {
  if (!dateStr || dateStr === 'N/A' || dateStr === 'Unknown') {
    return 'N/A';
  }
  
  try {
    const date = new Date(dateStr);
    
    // Check if it's a valid date
    if (isNaN(date.getTime())) {
      return dateStr;
    }
    
    // Format as "Month DD, YYYY"
    return date.toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'short',
      day: 'numeric'
    });
  } catch (error) {
    console.error('Error formatting date:', error);
    return dateStr;
  }
}

/**
 * Creates an error message element
 * @param {string} message - The error message to display
 * @returns {string} HTML for the error message
 */
function createErrorMessage(message) {
  return `
    <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded relative" role="alert">
      <span class="block sm:inline">${message}</span>
    </div>
  `;
}

// Function to create and open the details modal
function openDetailsModal(applicationNumber, brandName, ingredient) {
  // Create modal if it doesn't exist
  if (!document.getElementById('detailsModal')) {
    const modalHTML = `
      <div id="detailsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-4xl max-h-[90vh] overflow-auto">
          <div class="p-4 border-b flex justify-between items-center">
            <h3 class="text-lg font-semibold" id="modalTitle">Application Details</h3>
            <button id="closeModalBtn" class="text-gray-500 hover:text-gray-700">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
          
          <div class="p-6" id="modalContent">
            <div class="animate-pulse">
              <div class="h-4 bg-gray-200 rounded w-3/4 mb-4"></div>
              <div class="h-4 bg-gray-200 rounded w-1/2 mb-4"></div>
              <div class="h-4 bg-gray-200 rounded w-5/6 mb-4"></div>
            </div>
          </div>
          
          <div class="border-t p-4 flex justify-end">
            <button id="scrapeDocsBtn" class="px-4 py-2 bg-blue-600 text-white rounded mr-2 hover:bg-blue-700 transition-colors">
              Get Documents
            </button>
            <button id="aiSummaryBtn" class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 transition-colors" disabled>
              AI Summary
            </button>
          </div>
        </div>
      </div>
    `;
    
    // Append modal to body
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Add event listeners for modal
    document.getElementById('closeModalBtn').addEventListener('click', closeModal);
    
    // Close modal when clicking outside
    document.getElementById('detailsModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeModal();
      }
    });
  }
  
  // Update modal title
  document.getElementById('modalTitle').textContent = `${brandName} (${applicationNumber})`;
  
  // Show modal
  document.getElementById('detailsModal').classList.remove('hidden');
  
  // Store application number for document scraping
  document.getElementById('scrapeDocsBtn').setAttribute('data-application', applicationNumber);
  
  // Load details into modal
  loadModalDetails(applicationNumber, brandName, ingredient);
  
  // Add event listener for scraping
  document.getElementById('scrapeDocsBtn').addEventListener('click', function() {
    const appNo = this.getAttribute('data-application');
    scrapeDocuments(appNo);
  });
  
  // Add event listener for AI summary
  document.getElementById('aiSummaryBtn').addEventListener('click', function() {
    generateAISummary();
  });
}

// Function to close the modal
function closeModal() {
  document.getElementById('detailsModal').classList.add('hidden');
}

// Function to load details into the modal
async function loadModalDetails(applicationNumber, brandName, ingredient) {
  const modalContent = document.getElementById('modalContent');
  
  modalContent.innerHTML = `
    <div class="animate-pulse">
      <div class="h-4 bg-gray-200 rounded w-3/4 mb-4"></div>
      <div class="h-4 bg-gray-200 rounded w-1/2 mb-4"></div>
      <div class="h-4 bg-gray-200 rounded w-5/6 mb-4"></div>
    </div>
  `;
  
  try {
    // Fetch Orange Book data for this application
    // const orangeBookResponse = await fetch(`/api/fda/orangebook/search?q=${encodeURIComponent(applicationNumber)}`);
    // const orangeBookData = await orangeBookResponse.json();
    
    // Fetch DailyMed data for this ingredient
    // const dailyMedResponse = await fetch(`/api/fda/dailymed/${encodeURIComponent(ingredient)}`);
    // const dailyMedData = await dailyMedResponse.json();
    
    // Build content for modal
    let html = `
      <div class="mb-6">
        <h4 class="text-md font-semibold border-b pb-2 mb-2">Application Information</h4>
        <div class="grid grid-cols-2 gap-2 text-sm">
          <div>
            <p><span class="font-medium">Application Number:</span> ${applicationNumber}</p>
            <p><span class="font-medium">Brand Name:</span> ${brandName}</p>
            <p><span class="font-medium">Active Ingredient:</span> ${ingredient}</p>
          </div>
          <div class="text-right">
            <a href="https://www.accessdata.fda.gov/scripts/cder/daf/index.cfm?event=overview.process&ApplNo=${applicationNumber.replace(/[^0-9]/g, '')}" 
               target="_blank" 
               class="text-blue-600 hover:underline">
              View on FDA Website
            </a>
          </div>
        </div>
      </div>
      

      
    <!--  <div class="mb-6">
        <h4 class="text-md font-semibold border-b pb-2 mb-2">DailyMed Information</h4>
        ${renderDailyMedDetails(dailyMedData)}
      </div> -->
      
      <div id="documentSection" class="mb-6">
        <h4 class="text-md font-semibold border-b pb-2 mb-2">FDA Documents</h4>
        <p class="text-sm text-gray-600">Click "Get Documents" button below to retrieve FDA documents for this application.</p>
      </div>
    `;
    
    modalContent.innerHTML = html;
    
  } catch (error) {
    console.error("Error loading modal details:", error);
    modalContent.innerHTML = `
      <div class="text-center text-red-500 p-4">
        <p>Error loading details. Please try again.</p>
      </div>
    `;
  }
}

// Function to render Orange Book details
function renderOrangeBookDetails(data) {
  if (!data.results || data.results.products.length === 0) {
    return `<p class="text-sm text-gray-600">No Orange Book entries found for this application.</p>`;
  }
  
  let html = `
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
    <thead class="bg-blue-600 text-white">
      <tr>
        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Trade Name</th>
        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Approval</th>
        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Strength</th>
      </tr>
    </thead>
        <tbody class="bg-white divide-y divide-gray-200">
  `;
  
  // Limit to 5 products for performance
  const productsToShow = Math.min(data.results.products.length, 5);
  for (let i = 0; i < productsToShow; i++) {
    const product = data.results.products[i];
    console.log(product)
    html += `
        <tr class="hover:bg-gray-50">
          <td class="px-6 py-4 text-sm font-medium text-gray-700">${product.Trade_Name || 'N/A'}</td>
          <td class="px-6 py-4 text-sm text-gray-600">${product.Approval_Date
            || 'N/A'}</td>
          <td class="px-6 py-4 text-sm text-gray-600">${product.Strength || 'N/A'}</td>
        </tr>
    `;
  }
  
  html += `
        </tbody>
      </table>
    </div>
  `;
  
  return html;
}

// Function to render DailyMed details
function renderDailyMedDetails(data) {
  const labelInfo = data.label_info || [];
  
  if (labelInfo.length === 0) {
    return `<p class="text-sm text-gray-600">No DailyMed information found for this product.</p>`;
  }
  
  let html = `<div class="grid grid-cols-1 gap-3">`;
  
  // Display up to 3 entries
  const entriesToShow = Math.min(labelInfo.length, 3);
  for (let i = 0; i < entriesToShow; i++) {
    const label = labelInfo[i];
    html += `
      <div class="bg-gray-50 rounded p-3">
        <h5 class="font-medium text-sm">${label.title}</h5>
        <p class="text-xs text-gray-500 mt-1">Published: ${label.published}</p>
        ${label.manufacturer ? `<p class="text-xs mt-1">Manufacturer: ${label.manufacturer}</p>` : ''}
        <div class="mt-2">
          <a href="${label.labelUrl}" target="_blank" class="text-xs text-blue-600 hover:underline">
            View on DailyMed
          </a>
        </div>
      </div>
    `;
  }
  
  html += `</div>`;
  
  // If there are more entries than shown
  if (labelInfo.length > 3) {
    html += `
      <div class="text-xs text-gray-500 mt-2">
        Showing 3 of ${labelInfo.length} entries
      </div>
    `;
  }
  
  return html;
}

// Function to scrape FDA documents
// Function to scrape FDA documents
// async function scrapeDocuments(applicationNumber) {
//     console.log(applicationNumber)
//   const documentSection = document.getElementById('documentSection');
//   const aiSummaryBtn = document.getElementById('aiSummaryBtn');
  
//   // Show loading state
//   documentSection.innerHTML = `
//     <h4 class="text-md font-semibold border-b pb-2 mb-2">FDA Documents</h4>
//     <div class="flex justify-center items-center py-4">
//       <svg class="animate-spin h-5 w-5 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
//         <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
//         <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
//       </svg>
//       <span class="ml-2 text-gray-600">Retrieving documents...</span>
//     </div>
//   `;
  
//   try {
//     // Use the new endpoint to fetch document links
//     const appNo = applicationNumber.replace(/[^0-9]/g, ''); // Clean the application number
//     const response = await fetch(`/api/fda-pdfs/${appNo}`);
    
// if (!response.ok) {
//   const contentType = response.headers.get("content-type");
//   if (contentType && contentType.indexOf("application/json") === -1) {
//     // Not JSON - probably HTML error page
//     throw new Error(`Received non-JSON response (${response.status})`);
//   }
//   throw new Error(`HTTP error ${response.status}`);
// }
    
//     if (!response.ok) {
//       throw new Error(`HTTP error ${response.status}`);
//     }
    
//     const data = await response.json();
//     const documentLinks = data.results || [];
    
//     // Update the document section with links
//     let html = `
//       <h4 class="text-md font-semibold border-b pb-2 mb-2">FDA Documents</h4>
//       <div class="mt-3">
//     `;
    
//     if (documentLinks.length === 0) {
//       html += `<p class="text-sm text-gray-600">No documents found for this application.</p>`;
//     } else {
//       // Group documents by type
//       const groupedDocs = {};
//       documentLinks.forEach(link => {
//         if (!groupedDocs[link.type]) {
//           groupedDocs[link.type] = [];
//         }
//         groupedDocs[link.type].push(link);
//       });
      
//       // Display documents by type
//       for (const [type, links] of Object.entries(groupedDocs)) {
//         html += `
//           <div class="mb-3">
//             <h5 class="text-sm font-medium mb-2">${type} Documents (${links.length})</h5>
//             <ul class="list-disc pl-5 text-sm">
//         `;
        
//         for (const link of links) {
//           html += `
//             <li class="mb-1">
//               <a href="${link.url}" target="_blank" class="text-blue-600 hover:underline">
//                 ${link.name}
//               </a>
//             </li>
//           `;
//         }
        
//         html += `
//             </ul>
//           </div>
//         `;
//       }
      
//       // Add note about documents
//       html += `
//         <p class="text-xs text-gray-500 mt-3">
//           Found ${documentLinks.length} documents. Some links may require FDA authentication.
//         </p>
//       `;
//     }
    
//     html += `</div>`;
    
//     // Update the document section
//     documentSection.innerHTML = html;
    
//     // Store document data for AI summary
//     document.getElementById('aiSummaryBtn').setAttribute('data-documents', JSON.stringify(documentLinks));
    
//     // Enable AI summary button if we have documents
//     if (documentLinks.length > 0) {
//       aiSummaryBtn.disabled = false;
//     }
    
//   } catch (error) {
//     console.error("Error retrieving documents:", error);
//     documentSection.innerHTML = `
//       <h4 class="text-md font-semibold border-b pb-2 mb-2">FDA Documents</h4>
//       <div class="text-center text-red-500 p-4">
//         <p>Error retrieving documents: ${error.message}</p>
//         <button id="retryFetchBtn" class="mt-2 px-3 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600">
//           Retry
//         </button>
//       </div>
//     `;
    
//     // Add retry button functionality
//     document.getElementById('retryFetchBtn').addEventListener('click', () => {
//       scrapeDocuments(applicationNumber);
//     });
//   }
// }

async function scrapeDocuments(applicationNumber) {
    console.log(applicationNumber)
  const documentSection = document.getElementById('documentSection');
  const aiSummaryBtn = document.getElementById('aiSummaryBtn');
  
  // Show loading state
  documentSection.innerHTML = `
    <h4 class="text-md font-semibold border-b pb-2 mb-2">FDA Documents</h4>
    <div class="flex justify-center items-center py-4">
      <svg class="animate-spin h-5 w-5 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      <span class="ml-2 text-gray-600">Retrieving documents...</span>
    </div>
  `;
  
  try {
    // Use the new endpoint to fetch document links
    const appNo = applicationNumber.replace(/[^0-9]/g, ''); // Clean the application number
    const response = await fetch(`/api/fda-pdfs/${appNo}`);
    
    if (!response.ok) {
      const contentType = response.headers.get("content-type");
      if (contentType && contentType.indexOf("application/json") === -1) {
        // Not JSON - probably HTML error page
        throw new Error(`No documents found`);
      }
      throw new Error(`No documents found`);
    }
    
    const data = await response.json();
    const documentLinks = data.results || [];
    
    // Update the document section with links
    let html = `
      <h4 class="text-md font-semibold border-b pb-2 mb-2">FDA Documents</h4>
      <div class="mt-3">
    `;
    
    if (documentLinks.length === 0) {
      html += `<p class="text-sm text-gray-600">No documents found for this application.</p>`;
    } else {
      // Group documents by type
      const groupedDocs = {};
      documentLinks.forEach(link => {
        if (!groupedDocs[link.type]) {
          groupedDocs[link.type] = [];
        }
        groupedDocs[link.type].push(link);
      });
      
      // Display documents by type
      for (const [type, links] of Object.entries(groupedDocs)) {
        html += `
          <div class="mb-3">
            <h5 class="text-sm font-medium mb-2">${type} Documents (${links.length})</h5>
            <ul class="list-disc pl-5 text-sm">
        `;
        
        for (const link of links) {
          html += `
            <li class="mb-1">
              <a href="${link.url}" target="_blank" class="text-blue-600 hover:underline">
                ${link.name}
              </a>
            </li>
          `;
        }
        
        html += `
            </ul>
          </div>
        `;
      }
      
      // Add note about documents
      html += `
        <p class="text-xs text-gray-500 mt-3">
          Found ${documentLinks.length} documents. Some links may require FDA authentication.
        </p>
      `;
    }
    
    html += `</div>`;
    
    // Update the document section
    documentSection.innerHTML = html;
    
    // Store document data for AI summary
    document.getElementById('aiSummaryBtn').setAttribute('data-documents', JSON.stringify(documentLinks));
    
    // Enable AI summary button if we have documents
    if (documentLinks.length > 0) {
      aiSummaryBtn.disabled = false;
    }
    
  } catch (error) {
    console.error("Error retrieving documents:", error);
    documentSection.innerHTML = `
      <h4 class="text-md font-semibold border-b pb-2 mb-2">FDA Documents</h4>
      <div class="text-center text-gray-600 p-4">
        <p>No documents found</p>
        <button id="retryFetchBtn" class="mt-2 px-3 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600">
          Retry
        </button>
      </div>
    `;
    
    // Add retry button functionality
    document.getElementById('retryFetchBtn').addEventListener('click', () => {
      scrapeDocuments(applicationNumber);
    });
  }
}

// Function to generate AI summary of documents
// Function to generate AI summary of documents
// Modified function to generate AI summary of documents
// async function generateAISummary() {
//   const modalContent = document.getElementById('modalContent');
//   const aiSummaryBtn = document.getElementById('aiSummaryBtn');
//   const currentContent = modalContent.innerHTML;
  
//   // Get document data stored in the button's data attribute
//   let documentLinks = [];
//   try {
//     documentLinks = JSON.parse(aiSummaryBtn.getAttribute('data-documents') || '[]');
//   } catch (error) {
//     console.error("Error parsing document data:", error);
//   }
  
//   // Count document types
//   const docTypeCounts = {};
//   documentLinks.forEach(doc => {
//     docTypeCounts[doc.type] = (docTypeCounts[doc.type] || 0) + 1;
//   });
  
//   const docTypeSummary = Object.entries(docTypeCounts)
//     .map(([type, count]) => `${count} ${type}${count > 1 ? 's' : ''}`)
//     .join(', ');
  
//   // Append AI summary section with loading state
//   modalContent.innerHTML = currentContent + `
//     <div id="aiSummarySection" class="mt-6 border-t pt-4">
//       <h4 class="text-md font-semibold border-b pb-2 mb-2">AI Document Summary</h4>
//       <div class="bg-purple-50 p-4 rounded">
//         <div class="flex items-center mb-3">
//           <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-purple-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
//           </svg>
//           <span class="font-medium text-purple-700">AI Analysis</span>
//         </div>
        
//         <div id="aiSummaryContent">
//           <div class="flex justify-center items-center py-4">
//             <svg class="animate-spin h-5 w-5 text-purple-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
//               <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
//               <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
//             </svg>
//             <span class="ml-2 text-gray-600">Analyzing documents...</span>
//           </div>
//         </div>
//       </div>
//     </div>
//   `;
  
//   // Find PDF document links (with priority order)
//   const pdfLinks = documentLinks.filter(doc => doc.url.toLowerCase().endsWith('.pdf'));
  
//   // Priority order: Label > Review > Letter > Other
//   const labelDocs = pdfLinks.filter(doc => doc.type === 'Label');
//   const reviewDocs = pdfLinks.filter(doc => doc.type === 'Review');
//   const letterDocs = pdfLinks.filter(doc => doc.type === 'Letter');
  
//   // Choose documents to analyze based on priority
//   let docsToAnalyze = [];
//   if (labelDocs.length > 0) {
//     docsToAnalyze = labelDocs;
//   } else if (reviewDocs.length > 0) {
//     docsToAnalyze = reviewDocs;
//   } else if (letterDocs.length > 0) {
//     docsToAnalyze = letterDocs;
//   } else {
//     docsToAnalyze = pdfLinks;
//   }
  
//   if (docsToAnalyze.length === 0) {
//     // No PDF documents found
//     document.getElementById('aiSummaryContent').innerHTML = `
//       <div class="text-center text-gray-600 p-4">
//         <p>No PDF documents found to analyze. AI summary unavailable.</p>
//       </div>
//     `;
//     return;
//   }
  
//   try {
//     // Choose the first document for analysis
//     const docToAnalyze = docsToAnalyze[0];
    
//     // Update status message
//     document.getElementById('aiSummaryContent').innerHTML = `
//       <div class="flex flex-col items-center py-4">
//         <div class="flex items-center">
//           <svg class="animate-spin h-5 w-5 text-purple-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
//             <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
//             <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
//           </svg>
//           <span class="ml-2 text-gray-600">Analyzing document...</span>
//         </div>
//         <div class="mt-2 text-xs text-gray-500">
//           Processing: ${docToAnalyze.name} (${docToAnalyze.type})
//         </div>
//       </div>
//     `;
    
//     // Call backend to analyze the document
//     const response = await fetch('/api/analyze-fda-doc', {
//       method: 'POST',
//       headers: {
//         'Content-Type': 'application/json'
//       },
//       body: JSON.stringify({
//         pdfUrl: docToAnalyze.url
//       })
//     });
    
//     if (!response.ok) {
//       const errorText = await response.text();
//       throw new Error(`API request failed (${response.status}): ${errorText}`);
//     }
    
//     const result = await response.json();
    
//     if (result.error) {
//       throw new Error(result.error);
//     }
    
//     // Display the summary with enhanced formatting
//     document.getElementById('aiSummaryContent').innerHTML = `
//       <div class="mt-1 text-sm bg-white p-4 rounded border border-purple-100 prose">
//         ${result.summary}
//       </div>
      
//       <div class="mt-3 flex justify-between items-center text-xs text-gray-500">
//         <span>Document: ${docToAnalyze.type} - ${docToAnalyze.name.length > 40 ? docToAnalyze.name.substring(0, 40) + '...' : docToAnalyze.name}</span>
//         ${result.imageCount > 0 ? `<span>Images analyzed: ${result.imageCount}</span>` : ''}
//       </div>
//     `;
    
//   } catch (error) {
//     console.error("Error generating AI summary:", error);
//     document.getElementById('aiSummaryContent').innerHTML = `
//       <div class="text-center text-red-500 p-4">
//         <p>Error generating AI summary: ${error.message}</p>
//         <button id="retryAnalysisBtn" class="mt-2 px-3 py-1 bg-purple-500 text-white text-xs rounded hover:bg-purple-600">
//           Retry Analysis
//         </button>
//       </div>
//     `;
    
//     // Add retry button functionality
//     document.getElementById('retryAnalysisBtn').addEventListener('click', () => {
//       generateAISummary();
//     });
//   }
// }


function formatAISummary(rawSummary) {
  // Split the raw summary into lines
  const lines = rawSummary.trim().split('\n');
  let html = '<div class="ai-summary-content">';
  let currentSection = '';
  let inList = false;

  lines.forEach((line, index) => {
    line = line.trim();

    // Handle section headings (e.g., ### 1. Drug Name and Active Ingredients)
    if (line.startsWith('###')) {
      if (currentSection) {
        if (inList) {
          currentSection += '</ul>';
          inList = false;
        }
        html += currentSection + '</div>';
      }
      const sectionTitle = line.replace('###', '').trim();
      currentSection = `
        <div class="section mt-4">
          <h5 class="font-semibold text-purple-800 mb-2">${sectionTitle}</h5>
      `;
    }
    // Handle bold items (e.g., **Drug Name:**)
    else if (line.includes('**')) {
      if (inList) {
        currentSection += '</ul>';
        inList = false;
      }
      const parts = line.split('**');
      let formattedLine = '';
      for (let i = 0; i < parts.length; i++) {
        if (i % 2 === 1) {
          // Bold and purple text
          formattedLine += `<strong class="text-purple-700">${parts[i]}</strong>`;
        } else {
          formattedLine += parts[i];
        }
      }
      currentSection += `<p>${formattedLine}</p>`;
    }
    // Handle list items (e.g., - Item)
    else if (line.startsWith('-')) {
      if (!inList) {
        currentSection += '<ul class="list-disc ml-5 mb-2">';
        inList = true;
      }
      const listItem = line.replace('-', '').trim();
      if (listItem.includes('**')) {
        const parts = listItem.split('**');
        let formattedItem = '';
        for (let i = 0; i < parts.length; i++) {
          if (i % 2 === 1) {
            formattedItem += `<strong class="text-purple-700">${parts[i]}</strong>`;
          } else {
            formattedItem += parts[i];
          }
        }
        currentSection += `<li>${formattedItem}</li>`;
      } else {
        currentSection += `<li>${listItem}</li>`;
      }
    }
    // Handle plain text
    else if (line.length > 0) {
      if (inList) {
        currentSection += '</ul>';
        inList = false;
      }
      currentSection += `<p>${line}</p>`;
    }
  });

  // Close the last section
  if (currentSection) {
    if (inList) {
      currentSection += '</ul>';
    }
    html += currentSection + '</div>';
  }

  html += '</div>';
  return html;
}

async function generateAISummary() {
  const modalContent = document.getElementById('modalContent');
  const aiSummaryBtn = document.getElementById('aiSummaryBtn');
  const currentContent = modalContent.innerHTML;

  // Get document data stored in the button's data attribute
  let documentLinks = [];
  try {
    documentLinks = JSON.parse(aiSummaryBtn.getAttribute('data-documents') || '[]');
  } catch (error) {
    console.error("Error parsing document data:", error);
  }

  // Count document types
  const docTypeCounts = {};
  documentLinks.forEach(doc => {
    docTypeCounts[doc.type] = (docTypeCounts[doc.type] || 0) + 1;
  });

  const docTypeSummary = Object.entries(docTypeCounts)
    .map(([type, count]) => `${count} ${type}${count > 1 ? 's' : ''}`)
    .join(', ');

  // Append AI summary section with loading state and improved styling
  modalContent.innerHTML = currentContent + `
    <div id="aiSummarySection" class="mt-6 border-t pt-4">
      <h4 class="text-lg font-semibold text-purple-900 border-b pb-2 mb-4">AI Document Summary</h4>
      <div class="bg-white p-6 rounded-lg shadow-sm border border-purple-100">
        <div class="flex items-center mb-4">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-purple-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
          </svg>
          <span class="font-medium text-purple-700 text-lg">AI Analysis</span>
        </div>
        <div id="aiSummaryContent">
          <div class="flex justify-center items-center py-4">
            <svg class="animate-spin h-5 w-5 text-purple-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="ml-2 text-gray-600">Analyzing documents...</span>
          </div>
        </div>
      </div>
    </div>
  `;

  // Find PDF document links (with priority order)
  const pdfLinks = documentLinks.filter(doc => doc.url.toLowerCase().endsWith('.pdf'));
  const labelDocs = pdfLinks.filter(doc => doc.type === 'Label');
  const reviewDocs = pdfLinks.filter(doc => doc.type === 'Review');
  const letterDocs = pdfLinks.filter(doc => doc.type === 'Letter');

  let docsToAnalyze = [];
  if (labelDocs.length > 0) {
    docsToAnalyze = labelDocs;
  } else if (reviewDocs.length > 0) {
    docsToAnalyze = reviewDocs;
  } else if (letterDocs.length > 0) {
    docsToAnalyze = letterDocs;
  } else {
    docsToAnalyze = pdfLinks;
  }

  if (docsToAnalyze.length === 0) {
    document.getElementById('aiSummaryContent').innerHTML = `
      <div class="text-center text-gray-600 p-4">
        <p>No PDF documents found to analyze. AI summary unavailable.</p>
      </div>
    `;
    return;
  }

  try {
    const docToAnalyze = docsToAnalyze[0];
    
    document.getElementById('aiSummaryContent').innerHTML = `
      <div class="flex flex-col items-center py-4">
        <div class="flex items-center">
          <svg class="animate-spin h-5 w-5 text-purple-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          <span class="ml-2 text-gray-600">Analyzing document...</span>
        </div>
        <div class="mt-2 text-xs text-gray-500">
          Processing: ${docToAnalyze.name} (${docToAnalyze.type})
        </div>
      </div>
    `;

    // Simulated API response (replace with actual fetch call)
    // const response = {
    //   ok: true,
    //   json: async () => ({
    //     summary: `
    //       <div class="ai-summary-content">
    //         <div class="section">
    //           <h5 class="font-semibold text-purple-800 mb-2">1. Drug Name and Active Ingredients</h5>
    //           <p><strong class="text-purple-700">Drug Name:</strong> ADDERALL XR</p>
    //           <p><strong class="text-purple-700">Active Ingredients:</strong></p>
    //           <ul class="list-disc ml-5 mb-2">
    //             <li>Dextroamphetamine Saccharate</li>
    //             <li>Amphetamine Aspartate Monohydrate</li>
    //             <li>Dextroamphetamine Sulfate USP</li>
    //             <li>Amphetamine Sulfate USP</li>
    //           </ul>
    //           <p>Each capsule contains a combination of these salts, with total amphetamine base equivalence of 6.3 mg, 12.5 mg, or 18.8 mg for the 10 mg, 20 mg, and 30 mg capsules, respectively.</p>
    //         </div>

    //         <div class="section mt-4">
    //           <h5 class="font-semibold text-purple-800 mb-2">2. Approved Indications</h5>
    //           <p><strong class="text-purple-700">Indications:</strong> ADDERALL XR is indicated for the treatment of Attention Deficit Hyperactivity Disorder (ADHD) in patients who meet DSM-IV criteria for ADHD, including the combined type or the hyperactive-impulsive type.</p>
    //         </div>

    //         <div class="section mt-4">
    //           <h5 class="font-semibold text-purple-800 mb-2">3. Important Safety Information</h5>
    //           <ul class="list-disc ml-5 mb-2">
    //             <li><strong class="text-purple-700">High Potential for Abuse:</strong> Amphetamines have a high potential for abuse and prolonged use may lead to drug dependence.</li>
    //             <li><strong class="text-purple-700">Non-Therapeutic Use:</strong> There is a risk of subjects obtaining amphetamines for non-therapeutic use or distribution to others. The drug should be prescribed or dispensed sparingly.</li>
    //             <li><strong class="text-purple-700">Clinical Trials:</strong> Efficacy was demonstrated in controlled trials in children aged 6 to 12, showing significant improvements in behavior and performance compared to placebo.</li>
    //           </ul>
    //         </div>

    //         <div class="section mt-4">
    //           <h5 class="font-semibold text-purple-800 mb-2">4. Dosage Recommendations</h5>
    //           <ul class="list-disc ml-5 mb-2">
    //             <li><strong class="text-purple-700">Dosage Forms:</strong> Available in 10 mg, 20 mg, and 30 mg capsules.</li>
    //             <li><strong class="text-purple-700">Administration:</strong> Once daily in the morning. The capsule can be opened and sprinkled on applesauce if needed, with comparable absorption to the intact capsule.</li>
    //             <li><strong class="text-purple-700">Dose Range:</strong> The effective dose range in clinical trials was 10 mg to 30 mg once daily.</li>
    //             <li><strong class="text-purple-700">Pharmacokinetics:</strong> The time to reach maximum plasma concentration (Tmax) is about 7 hours, and the drug demonstrates linear pharmacokinetics over the dose range of 10 to 30 mg.</li>
    //           </ul>
    //         </div>

    //         <div class="section mt-4">
    //           <h5 class="font-semibold text-purple-800 mb-2">5. Contraindications</h5>
    //           <p>The document does not explicitly list contraindications, but it emphasizes the high potential for abuse and the need for careful prescribing practices.</p>
    //         </div>

    //         <div class="section mt-4">
    //           <h5 class="font-semibold text-purple-800 mb-2">6. Special Populations and Warnings</h5>
    //           <ul class="list-disc ml-5 mb-2">
    //             <li><strong class="text-purple-700">Pediatric Patients:</strong> Children aged 6 to 12 years eliminate amphetamine faster than adults, with a shorter elimination half-life. However, they have higher systemic exposure due to higher doses on a mg/kg basis.</li>
    //             <li><strong class="text-purple-700">Gender:</strong> Women have 20-30% higher systemic exposure to amphetamine than men, attributed to higher doses on a mg/kg basis.</li>
    //             <li><strong class="text-purple-700">Race:</strong> Pharmacokinetics appear comparable among Caucasians, Blacks, and Hispanics.</li>
    //             <li><strong class="text-purple-700">Food Effects:</strong> Food does not affect the extent of absorption but prolongs Tmax by 2.5 hours.</li>
    //           </ul>
    //           <p class="mt-2"><strong class="text-purple-700">Warnings:</strong></p>
    //           <ul class="list-disc ml-5">
    //             <li><strong class="text-purple-700">Abuse and Dependence:</strong> The document repeatedly warns about the potential for abuse and dependence with prolonged use of amphetamines.</li>
    //             <li><strong class="text-purple-700">Prescribing Practices:</strong> Emphasis on prescribing or dispensing the drug sparingly due to the risk of non-therapeutic use or distribution.</li>
    //           </ul>
    //         </div>
    //       </div>
    //     `,
    //     imageCount: 0
    //   })
    // };

    // Uncomment this for actual API call
    
    const response = await fetch('/api/analyze-fda-doc', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        pdfUrl: docToAnalyze.url
      })
    });

    if (!response.ok) {
      const errorText = await response.text();
      throw new Error(`API request failed (${response.status}): ${errorText}`);
    }

    const result = await response.json();
    
    if (result.error) {
      throw new Error(result.error);
    }
    

    // const result = await response.json();
const html = formatAISummary(result.summary)
    // Display the summary with enhanced formatting
    document.getElementById('aiSummaryContent').innerHTML = `
      <div class="text-sm text-gray-700">
        ${html}
      </div>
      <div class="mt-4 flex justify-between items-center text-xs text-gray-500 border-t pt-2">
        <span>Document: ${docToAnalyze.type} - ${
          docToAnalyze.name.length > 40 
            ? docToAnalyze.name.substring(0, 40) + '...' 
            : docToAnalyze.name
        }</span>
        ${result.imageCount > 0 ? `<span>Images analyzed: ${result.imageCount}</span>` : ''}
      </div>
    `;

  } catch (error) {
    console.error("Error generating AI summary:", error);
    document.getElementById('aiSummaryContent').innerHTML = `
      <div class="text-center text-red-500 p-4">
        <p>Error generating AI summary: ${error.message}</p>
        <button id="retryAnalysisBtn" class="mt-2 px-4 py-1 bg-purple-500 text-white text-sm rounded hover:bg-purple-600">
          Retry Analysis
        </button>
      </div>
    `;
    
    document.getElementById('retryAnalysisBtn').addEventListener('click', () => {
      generateAISummary();
    });
  }
}

function createStatisticalSummaryTable(outcomes) {
    const table = elements.statisticalSummaryTable;
    if (!table) {
        console.warn("Statistical summary table element not found");
        return;
    }
    
    table.innerHTML = '';
    
    // Filter only outcomes with effect sizes
    const validOutcomes = outcomes.filter(o => o.effectSize !== null);
    
    if (validOutcomes.length === 0) {
        table.innerHTML = '<tr><td colspan="6" class="py-4 text-center text-gray-500">No statistical data available for the selected metric.</td></tr>';
        return;
    }
    
    // Group outcomes by study first
    const studyOutcomes = {};
    
    validOutcomes.forEach(o => {
        const nctId = o.nctId;
        if (!studyOutcomes[nctId]) {
            studyOutcomes[nctId] = [];
        }
        studyOutcomes[nctId].push(o);
    });
    
    // Calculate average effect size for each study to avoid over-counting 
    // studies with multiple outcomes
    const studyEffects = Object.entries(studyOutcomes).map(([nctId, outcomes]) => {
        const effectSizes = outcomes.map(o => o.effectSize);
        const meanEffect = calculateMean(effectSizes);
        const phase = outcomes[0].phase || 'N/A';
        
        return {
            nctId,
            phase,
            effectSize: meanEffect,
            experimentalValue: outcomes[0].experimentalValue,
            controlValue: outcomes[0].controlValue,
            experimentalSampleSize: outcomes[0].experimentalSampleSize,
            controlSampleSize: outcomes[0].controlSampleSize
        };
    });
    
    // Now group by phase
    const phaseGroups = {};
    const phaseOrder = { 
        "PRE_PHASE": 0, 
        "PHASE1": 1, 
        "PHASE1_PHASE2": 1.5,
        "PHASE2": 2, 
        "PHASE3": 3, 
        "PHASE4": 4,
        "N/A": 5
    };
    
    studyEffects.forEach(effect => {
        const phase = effect.phase;
        if (!phaseGroups[phase]) {
            phaseGroups[phase] = {
                effectSizes: [],
                experimentalValues: [],
                controlValues: [],
                experimentalSampleSizes: [],
                controlSampleSizes: []
            };
        }
        
        phaseGroups[phase].effectSizes.push(effect.effectSize);
        
        if (effect.experimentalValue !== null) {
            phaseGroups[phase].experimentalValues.push(effect.experimentalValue);
            phaseGroups[phase].experimentalSampleSizes.push(effect.experimentalSampleSize || 0);
        }
        
        if (effect.controlValue !== null) {
            phaseGroups[phase].controlValues.push(effect.controlValue);
            phaseGroups[phase].controlSampleSizes.push(effect.controlSampleSize || 0);
        }
    });
    
    // Add an "All Phases" row at the top
    let allEffectSizes = studyEffects.map(e => e.effectSize);
    let allExperimentalValues = studyEffects.filter(e => e.experimentalValue !== null).map(e => e.experimentalValue);
    let allControlValues = studyEffects.filter(e => e.controlValue !== null).map(e => e.controlValue);
    let allExperimentalSampleSizes = studyEffects.filter(e => e.experimentalSampleSize > 0).map(e => e.experimentalSampleSize);
    let allControlSampleSizes = studyEffects.filter(e => e.controlSampleSize > 0).map(e => e.controlSampleSize);
    
    // Calculate overall statistics
    const overallMean = calculateMean(allEffectSizes);
    const overallStdDev = calculateStandardDeviation(allEffectSizes, overallMean);
    const overallN = studyEffects.length; // Count unique studies
    const overallCi = calculateConfidenceInterval(overallMean, overallStdDev, overallN);
    
    const totalExperimentalN = allExperimentalSampleSizes.reduce((sum, n) => sum + n, 0);
    const totalControlN = allControlSampleSizes.reduce((sum, n) => sum + n, 0);
    
    // Add overall row
    const row = document.createElement('tr');
    row.className = 'bg-gray-50 font-medium';
    row.innerHTML = `
        <td class="py-2 px-4 border-b">All Phases</td>
        <td class="py-2 px-4 border-b">${overallN}</td>
        <td class="py-2 px-4 border-b">${overallMean.toFixed(2)}</td>
        <td class="py-2 px-4 border-b">${overallStdDev.toFixed(2)}</td>
        <td class="py-2 px-4 border-b">${overallCi.lower.toFixed(2)} to ${overallCi.upper.toFixed(2)}</td>
        <td class="py-2 px-4 border-b">${calculatePValue(
            calculateMean(allExperimentalValues),
            calculateMean(allControlValues),
            calculateStandardDeviation(allExperimentalValues),
            calculateStandardDeviation(allControlValues),
            totalExperimentalN,
            totalControlN
        )}</td>
    `;
    table.appendChild(row);
    
    // Add phase-specific rows
    Object.keys(phaseGroups)
        .sort((a, b) => phaseOrder[a] - phaseOrder[b])
        .forEach(phase => {
            const data = phaseGroups[phase];
            
            // Calculate statistics for this phase
            const mean = calculateMean(data.effectSizes);
            const stdDev = calculateStandardDeviation(data.effectSizes, mean);
            const n = data.effectSizes.length;
            const ci = calculateConfidenceInterval(mean, stdDev, n);
            
            const expMean = calculateMean(data.experimentalValues);
            const ctrlMean = calculateMean(data.controlValues);
            const expStdDev = calculateStandardDeviation(data.experimentalValues);
            const ctrlStdDev = calculateStandardDeviation(data.controlValues);
            
            const totalExpN = data.experimentalSampleSizes.reduce((sum, n) => sum + n, 0);
            const totalCtrlN = data.controlSampleSizes.reduce((sum, n) => sum + n, 0);
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="py-2 px-4 border-b">${formatPhase(phase)}</td>
                <td class="py-2 px-4 border-b">${n}</td>
                <td class="py-2 px-4 border-b">${mean.toFixed(2)}</td>
                <td class="py-2 px-4 border-b">${stdDev.toFixed(2)}</td>
                <td class="py-2 px-4 border-b">${ci.lower.toFixed(2)} to ${ci.upper.toFixed(2)}</td>
                <td class="py-2 px-4 border-b">${calculatePValue(expMean, ctrlMean, expStdDev, ctrlStdDev, totalExpN, totalCtrlN)}</td>
            `;
            table.appendChild(row);
        });
}
        // Filter functions
        function filterStudiesByPhase(phase) {
            if (phase === 'all') {
                return appState.studies;
            } else {
                return appState.studies.filter(study => 
                    study.protocolSection?.designModule?.phases?.[0] === phase
                );
            }
        }

        // Utility functions
        function getRandomColor(index, alpha = 1) {
            const colors = [
                `rgba(59, 130, 246, ${alpha})`, // blue-500
                `rgba(16, 185, 129, ${alpha})`, // emerald-500
                `rgba(139, 92, 246, ${alpha})`, // violet-500
                `rgba(249, 115, 22, ${alpha})`, // orange-500
                `rgba(236, 72, 153, ${alpha})`, // pink-500
                `rgba(14, 165, 233, ${alpha})`, // sky-500
                `rgba(168, 85, 247, ${alpha})`, // purple-500
                `rgba(234, 88, 12, ${alpha})`, // amber-600
                `rgba(22, 163, 74, ${alpha})`, // green-600
                `rgba(79, 70, 229, ${alpha})` // indigo-600
            ];
            
            return colors[index % colors.length];
        }

        function hexToRgba(hex, alpha = 1) {
            // Handle color names that aren't hex
            if (!hex.startsWith('#')) {
                // Simple mapping of common colors
                const colorMap = {
                    'red': 'rgba(255, 0, 0, ' + alpha + ')',
                    'green': 'rgba(0, 255, 0, ' + alpha + ')',
                    'blue': 'rgba(0, 0, 255, ' + alpha + ')',
                    'black': 'rgba(0, 0, 0, ' + alpha + ')',
                    'white': 'rgba(255, 255, 255, ' + alpha + ')',
                    'gray': 'rgba(128, 128, 128, ' + alpha + ')',
                    'yellow': 'rgba(255, 255, 0, ' + alpha + ')',
                    'orange': 'rgba(255, 165, 0, ' + alpha + ')',
                    'purple': 'rgba(128, 0, 128, ' + alpha + ')'
                };
                if (colorMap[hex.toLowerCase()]) {
                    return colorMap[hex.toLowerCase()];
                }
                
                // For unknown colors, return a safe default
                return `rgba(128, 128, 128, ${alpha})`;
            }
            
            // Regular hex color handling
            let r = 0, g = 0, b = 0;
            
            // 3 digits
            if (hex.length === 4) {
                r = parseInt(hex[1] + hex[1], 16);
                g = parseInt(hex[2] + hex[2], 16);
                b = parseInt(hex[3] + hex[3], 16);
            } 
            // 6 digits
            else if (hex.length === 7) {
                r = parseInt(hex.substring(1, 3), 16);
                g = parseInt(hex.substring(3, 5), 16);
                b = parseInt(hex.substring(5, 7), 16);
            }
            // Handle other cases with a default
            else {
                return `rgba(128, 128, 128, ${alpha})`;
            }
            
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }

        // Event handlers
        function handlePhaseFilter(event) {
            if (!event.target.classList.contains('phase-filter')) return;
            
            const phase = event.target.dataset.phase;
            
            // Update state
            appState.currentPhaseFilter = phase;
            
            // Update filter button styles
            document.querySelectorAll('.phase-filter').forEach(btn => {
                btn.classList.remove('bg-primary', 'text-white');
                btn.classList.add('bg-gray-200', 'hover:bg-gray-300');
            });
            event.target.classList.remove('bg-gray-200', 'hover:bg-gray-300');
            event.target.classList.add('bg-primary', 'text-white');
            
            // Filter studies
            const filteredStudies = filterStudiesByPhase(phase);
            
            // Update studies display
            displayStudies(filteredStudies);
        }


// async function handleSearch() {
//     // Get search parameters
//     const drug = elements.drugSearch.value.trim();
//     const condition = elements.conditionSearch.value.trim();
//     const hasResultsOnly = elements.hasResultsOnly.checked;
//     const trdFocusOnly = elements.trdFocusOnly.checked;
//     const yearsBack = parseInt(document.getElementById('timelineSlider').value);
//     // Update state
//     appState.hasResultsOnly = hasResultsOnly;
//     appState.trdFocusOnly = trdFocusOnly;
//     appState.currentPhaseFilter = 'all';
//     appState.studies = [];
//     appState.studyDetails = {};
//     appState.failedStudyIds.clear(); // Reset failed study IDs
    
//     // Reset FDA data
//     appState.fdaData = {
//         documents: [],
//         orangeBook: [],
//         dailyMed: [],
//         warningLetters: []
//     };
    
//     // Reset phase filter buttons
//     document.querySelectorAll('.phase-filter').forEach(btn => {
//         btn.classList.remove('bg-primary', 'text-white');
//         btn.classList.add('bg-gray-200', 'hover:bg-gray-300');
//     });
//     document.querySelector('.phase-filter[data-phase="all"]').classList.remove('bg-gray-200', 'hover:bg-gray-300');
//     document.querySelector('.phase-filter[data-phase="all"]').classList.add('bg-primary', 'text-white');
    
//     // 1. HIDE ABSOLUTELY EVERYTHING FIRST
//     showSection(elements.resultsOverview, false);
//     showSection(elements.studiesSection, false);
//     showSection(elements.studyDetailSection, false);
//     showSection(elements.fdaDataSection, false);
//     showSection(elements.placeholderMessage, false);
//     // Hide any other sections that might be visible
//     document.querySelectorAll('.results-section').forEach(section => {
//         section.style.display = 'none';
//     });
//     displayLoading(true);
    
//     // Now show the placeholder for user feedback
//     showSection(elements.placeholderMessage, true);
    
//     // Set placeholder message
//     // elements.placeholderMessage.innerHTML = `
//     //     <div class="text-center">
//     //         <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//     //             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
//     //         </svg>
//     //         <p class="text-lg">Searching for data...</p>
//     //     </div>`;
    
//     try {
//         console.log(`Searching - Drug: ${drug}, Condition: ${condition}, Results Only: ${hasResultsOnly}, TRD Focus: ${trdFocusOnly}`);
        
//         // 2. DETERMINE SEARCH TERMS FOR PUBMED
//         let pubmedSearchTerm = drug;
// //         const pubmedOptions = {
// //   sortBy: 'relevance',
// //   fullTextOnly: false,
// //   yearFilter: '',
// //   journalFilter: ''
// // };



//         if (condition) {
//             pubmedSearchTerm = drug ? `${drug} ${condition}` : condition;
//         }
        
//         // 3. HANDLE CLINICAL TRIALS SEARCH IF DRUG IS PROVIDED
//         let filteredStudies = [];
        
//         if (drug) {
//             // Fetch studies
//             const studies = await fetchStudies(drug, condition, hasResultsOnly, yearsBack);
//             console.log(`Retrieved ${studies.length} studies`);
            
//             // Filter for TRD-specific studies if requested
//             filteredStudies = studies;
//             if (trdFocusOnly) {
//                 filteredStudies = filterTRDSpecificStudies(studies);
//                 console.log(`Filtered to ${filteredStudies.length} TRD-specific studies`);
//             }
            
//             appState.studies = filteredStudies;
//             collectAllTrialOutcomes();
            
//             // Display study-related sections if studies are found
//             if (filteredStudies.length > 0) {
//                 // Display results summary
//                 displayResultsSummary(filteredStudies);
//                 showSection(elements.resultsOverview, true);
                
//                 // Display studies list
//                 displayStudies(filteredStudies, drug, condition);
//                 showSection(elements.studiesSection, true);
                
//                 // Fetch study details for studies with results
//                 await fetchAllStudyDetails(filteredStudies);
//             } else {
//                 // No studies found - show message
//                 elements.placeholderMessage.innerHTML = `
//                     <div class="text-center">
//                         <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
//                         </svg>
//                         <p class="text-lg">No ${trdFocusOnly ? 'TRD-specific ' : ''}studies found for "${drug}".</p>
//                         <p class="mt-2 text-sm">Other data is displayed below.</p>
//                     </div>`;
//             }
            
//             // 4. ALWAYS DISPLAY ALL DATA FOR DRUG SEARCHES
            
//             // FDA Data
//             displayFdaData(drug);
//             showSection(elements.fdaDataSection, true);
            
//             // EMA Data
//             EmaDataModule.init();
//             EmaDataModule.searchDrug(drug);
            
//             // For drug search
// // PubMedModule.searchPubMedByDrug(drug, pubmedOptions);
// if (drug && typeof PubMedModule !== 'undefined') {
//   try {
//     const pubmedOptions = {
//       sortBy: 'relevance',
//       fullTextOnly: false,
//       yearRange: yearsBack
//     };


//     console.log("Searching PubMed for drug:", drug);
//     if (PubMedModule.searchPubMedByDrug) {
//       PubMedModule.searchPubMedByDrug(drug, {
//   yearRange: yearsBack  // Last 10 years of publications
// });
      
//     } else if (PubMedModule.searchPubMed) {
//       // Fallback to general search if specialized function isn't available
//       PubMedModule.searchPubMed(drug, pubmedOptions);
//     }
//   } catch (pubmedError) {
//     console.error("Error in PubMed drug search:", pubmedError);
//   }
// }
//             // If we also have a condition, get condition-specific data too
//             // if (condition) {
//             //     console.log(`Getting additional condition data for: ${condition}`);
//             //     displayFdaClinicalData(condition);
//             //     EmaClinicalDataModule.init();
//             // EmaClinicalDataModule.searchCondition(condition);
//             // }

//         } else if (condition) {
//             // 5. HANDLE CONDITION-ONLY SEARCH
            
//             // Fetch studies for condition
//             try {
//                 const studies = await fetchStudies("", condition, hasResultsOnly, yearsBack);
//                 console.log(`Retrieved ${studies.length} studies for condition: ${condition}`);
                
//                 // Filter for TRD-specific studies if requested
//                 filteredStudies = studies;
//                 if (trdFocusOnly) {
//                     filteredStudies = filterTRDSpecificStudies(studies);
//                     console.log(`Filtered to ${filteredStudies.length} TRD-specific studies`);
//                 }
                
//                 appState.studies = filteredStudies;
//                 collectAllTrialOutcomes();
                
//                 // Display study-related sections if studies are found
//                 if (filteredStudies.length > 0) {
//                     // Display results summary
//                     displayResultsSummary(filteredStudies);
//                     showSection(elements.resultsOverview, true);
                    
//                     // Display studies list
//                     displayStudies(filteredStudies, "", condition);
//                     showSection(elements.studiesSection, true);
                    
//                     // Fetch study details for studies with results
//                     await fetchAllStudyDetails(filteredStudies);
//                 } else {
//                     // No studies found - show message
//                     elements.placeholderMessage.innerHTML = `
//                         <div class="text-center">
//                             <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
//                             </svg>
//                             <p class="text-lg">No ${trdFocusOnly ? 'TRD-specific ' : ''}studies found for condition: "${condition}".</p>
//                             <p class="mt-2 text-sm">Other condition data is displayed below.</p>
//                         </div>`;
//                 }
//             } catch (error) {
//                 console.error(`Error fetching studies for condition ${condition}:`, error);
//                 elements.placeholderMessage.innerHTML = `
//                     <div class="text-center">
//                         <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-red-500 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
//                         </svg>
//                         <p class="text-lg">Error searching for condition studies</p>
//                         <p class="mt-2 text-sm">Displaying other condition data below.</p>
//                     </div>`;
//             }
            
//             // Always display condition data regardless of study results
//             // displayFdaClinicalData(condition);
            
//             // Make sure all appropriate sections are shown for condition-only searches
//             // EmaClinicalDataModule.init();
//             // EmaClinicalDataModule.searchCondition(condition);
            
// // For condition search
// // PubMedModule.searchPubMedByCondition(condition, pubmedOptions);


// // For condition search
// if (condition && typeof PubMedModule !== 'undefined') {
//   try {
//     const pubmedOptions = {
//       sortBy: 'date',
//       fullTextOnly: false,
//       yearRange: yearsBack
//     };
//     console.log("Searching PubMed for condition:", condition);
//     if (PubMedModule.searchPubMedByCondition) {
//         PubMedModule.searchPubMedByCondition(condition, pubmedOptions);


//     } else if (PubMedModule.searchPubMed) {
//       // Fallback to general search if specialized function isn't available
//       PubMedModule.searchPubMed(condition, pubmedOptions);
//     }
//   } catch (pubmedError) {
//     console.error("Error in PubMed condition search:", pubmedError);
//   }
// }


//             // Show FDA data section for condition
//             // showSection(elements.fdaDataSection, true);
//         }
        
//         // 6. ALWAYS SEARCH PUBMED IF TERMS ARE AVAILABLE
//         // if (pubmedSearchTerm) {
//         //     PubMedModule.searchPubMed(pubmedSearchTerm);
//         // }
        
//         // 7. ENSURE ALL APPROPRIATE SECTIONS ARE VISIBLE AND FINISH LOADING
//         // if (drug || condition) {
//         //     // Always show FDA section if we have any search criteria
//         //     showSection(elements.fdaDataSection, true);
//         // }
        
//         displayLoading(false);
        
//     } catch (error) {
//         console.error('Error during search:', error);
//         elements.placeholderMessage.innerHTML = `
//             <div class="text-center">
//                 <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-red-500 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
//                 </svg>
//                 <p class="text-lg">Error searching for studies</p>
//                 <p class="mt-2 text-sm">Please try again later.</p>
//                 <p class="mt-2 text-xs text-gray-500">${error.message}</p>
//             </div>`;
//         displayLoading(false);
//     }
// }
function updateTimeline(years) {
  const yearValue = document.getElementById('yearValue');
  const thumbValue = document.getElementById('thumbValue');
  const startYear = document.getElementById('startYear');
  const filledTrack = document.getElementById('filledTrack');
  const sliderThumb = document.getElementById('sliderThumb');
  
  yearValue.textContent = years;
  thumbValue.textContent = years;
  startYear.textContent = new Date().getFullYear() - years;
  
  // Calculate percentage for filled track and thumb position
  const percentage = ((years - 1) / 14) * 100;
  filledTrack.style.width = `${percentage}%`;
  sliderThumb.style.left = `${percentage}%`;
}


// Helper function to fetch all study details with a semaphore to limit concurrent requests
// Improved handleSearch function that properly stops processing and handles combined content requests
async function handleAISearch(isAISearch = false, aiQuery = '') {
    if (!window.NLPProcessor || !window.NLPProcessor.detectContentTypes) {
    console.error('NLPProcessor not found! Make sure you paste the implementation first.');
    return;
  }
  console.log("go on")
  
  elements.drugSearch.value = '';
  elements.conditionSearch.value = '';

  showSection(elements.ctSummary, false)
  showSection(elements.ema, false)
  showSection(elements.resultsOverview, false);
  showSection(elements.pubmedSection, false)
    showSection(elements.studiesSection, false);
    showSection(elements.studyDetailSection, false);
    showSection(elements.fdaDataSection, false);
    showSection(elements.placeholderMessage, false);
    // Hide any other sections that might be visible
    document.querySelectorAll('.results-section').forEach(section => {
        section.style.display = 'none';
    });
    displayLoading(true);
    // Get search parameters - if AI search, extract from query
  let drug, condition, hasResultsOnly, trdFocusOnly, yearsBack, phaseFilter;
  
  // Content display flags (defaults for regular search)
  let showTrials = true;
  let showFDA = true;
  let showEMA = true;
  let showPubMed = true;
  
  if (isAISearch && aiQuery) {
    console.log("Processing AI query:", aiQuery);
    
    // Use NLP processor to extract parameters from the query
    const nlpResults = NLPProcessor.processQuery(aiQuery);
    
    // Extract basic search parameters
    drug = nlpResults.drug;
    condition = nlpResults.condition;
    hasResultsOnly = nlpResults.hasResultsOnly;
    trdFocusOnly = nlpResults.trdFocusOnly;
    yearsBack = nlpResults.yearsBack;
    phaseFilter = nlpResults.phaseFilter;
    
    // Determine which content to show based on NLP results
    showTrials = nlpResults.trials;
    showFDA = nlpResults.fda;
    showEMA = nlpResults.ema;
    showPubMed = nlpResults.pubmed || nlpResults.publications;
    
    // Update UI with what was processed (form fields)
    elements.drugSearch.value = drug;
    elements.conditionSearch.value = condition;
    // elements.hasResultsOnly.checked = hasResultsOnly;
    // elements.trdFocusOnly.checked = trdFocusOnly;
    document.getElementById('timelineSlider').value = yearsBack;
    
    // Update the timeline display if you have a function for that
    if (typeof updateTimeline === 'function') {
      updateTimeline(yearsBack);
    }
    
    // Show processing results to user
    const processingMsg = `
      <div class="mb-4 p-3 bg-blue-50 border border-blue-100 rounded-lg text-sm">
        <div class="font-medium text-blue-700 mb-1">AI Search Processing</div>
        <ul class="list-disc pl-5 text-blue-600">
          ${drug ? `<li>Drug: ${drug}</li>` : ''}
          ${condition ? `<li>Condition: ${condition}</li>` : ''}
          ${hasResultsOnly ? `<li>Showing only studies with results</li>` : ''}
          ${trdFocusOnly ? `<li>Focusing on TRD-specific studies</li>` : ''}
          <li>Timeline: ${yearsBack} years back</li>
          ${phaseFilter !== 'all' ? `<li>Phase filter: ${phaseFilter}</li>` : ''}
          <li>Displaying: ${[
            showTrials ? 'Clinical Trials' : '',
            showFDA ? 'FDA Data' : '',
            showEMA ? 'EMA Data' : '',
            showPubMed ? 'Publications' : ''
          ].filter(Boolean).join(', ')}</li>
        </ul>
      </div>
    `;
    
    // Display processing information
    const placeholderMessage = elements.placeholderMessage;
    placeholderMessage.innerHTML = `
      <div class="text-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-blue-500 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
        </svg>
        <p class="text-lg mb-3">Processing AI Search Query</p>
        ${processingMsg}
      </div>`;
  } else {
    // Regular search - get values from form elements
    drug = elements.drugSearch.value.trim();
    condition = elements.conditionSearch.value.trim();
    hasResultsOnly = elements.hasResultsOnly.checked;
    trdFocusOnly = elements.trdFocusOnly.checked;
    yearsBack = parseInt(document.getElementById('timelineSlider').value);
    phaseFilter = 'all'; // Default for regular search
  }
  
  // Update state
  appState.hasResultsOnly = hasResultsOnly;
  appState.trdFocusOnly = trdFocusOnly;
  appState.currentPhaseFilter = phaseFilter;
  appState.studies = [];
  appState.studyDetails = {};
  appState.failedStudyIds.clear(); // Reset failed study IDs
  
  // Reset FDA data
  appState.fdaData = {
    documents: [],
    orangeBook: [],
    dailyMed: [],
    warningLetters: []
  };
  
  // Reset phase filter buttons
  document.querySelectorAll('.phase-filter').forEach(btn => {
    btn.classList.remove('bg-primary', 'text-white');
    btn.classList.add('bg-gray-200', 'hover:bg-gray-300');
  });
  
  // Set active phase filter based on NLP results or default to "all"
  const activePhaseSelector = `.phase-filter[data-phase="${phaseFilter}"]`;
  const activePhaseBtn = document.querySelector(activePhaseSelector) || 
                         document.querySelector('.phase-filter[data-phase="all"]');
  
  if (activePhaseBtn) {
    activePhaseBtn.classList.remove('bg-gray-200', 'hover:bg-gray-300');
    activePhaseBtn.classList.add('bg-primary', 'text-white');
  }
  
  // 1. HIDE ABSOLUTELY EVERYTHING FIRST
  showSection(elements.resultsOverview, false);
  showSection(elements.studiesSection, false);
  showSection(elements.studyDetailSection, false);
  showSection(elements.fdaDataSection, false);
  showSection(elements.placeholderMessage, false);
  
  // Hide any other sections that might be visible
  document.querySelectorAll('.results-section').forEach(section => {
    section.style.display = 'none';
  });
  
  // Hide specific sections
  if (elements.pubmedSection) {
    showSection(elements.pubmedSection, false);
  }
  
  if (elements.emaDataSection) {
    showSection(elements.emaDataSection, false);
  }
  
  displayLoading(true);
  
  // Now show the placeholder for user feedback
  showSection(elements.placeholderMessage, true);
  
  // Set placeholder message to searching
  elements.placeholderMessage.innerHTML = `
    <div class="text-center">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
      </svg>
      <p class="text-lg">Searching for data...</p>
    </div>`;
  
  try {
    console.log(`Searching - Drug: ${drug}, Condition: ${condition}, Results Only: ${hasResultsOnly}, TRD Focus: ${trdFocusOnly}, Years Back: ${yearsBack}`);
    console.log(`Display settings - Trials: ${showTrials}, FDA: ${showFDA}, EMA: ${showEMA}, PubMed: ${showPubMed}`);
    
    // Initialize the database if not already done
    await SearchCacheModule.initDatabase();
    
    // CREATE A LIST OF PROMISES TO TRACK
    const searchPromises = [];
    
    // 2. HANDLE CLINICAL TRIALS SEARCH IF REQUESTED
    let filteredStudies = [];
    
    if ((drug || condition) && showTrials) {
      // Create a promise for the trials search
      const trialsPromise = (async () => {
        // First, check if we have a cached search for this query
        const cachedSearch = await SearchCacheModule.getCachedSearchResults(
          drug, condition, hasResultsOnly, trdFocusOnly, yearsBack
        );
        
        let studies = [];
        let usedCache = false;
        
        if (cachedSearch) {
          // Check if the cached search is recent enough
          const MAX_CACHE_AGE_DAYS = 7; // Consider searches older than 7 days as outdated
          const isOutdated = SearchCacheModule.isSearchOutdated(cachedSearch.timestamp, MAX_CACHE_AGE_DAYS);
          
          if (!isOutdated) {
            // Use the cached search results
            console.log(`Using cached search results from ${cachedSearch.timestamp}`);
            studies = cachedSearch.results;
            usedCache = true;
          } else {
            // The cached search is outdated, but we can use it as a starting point
            console.log(`Cached search is outdated (from ${cachedSearch.timestamp}). Fetching new studies...`);
            
            // Get studies that were added after the cached search
            const newStudies = await fetchStudies(drug, condition, hasResultsOnly, yearsBack);
            
            // Update the cached search with the new studies
            const searchKey = cachedSearch.searchKey || 
              `${drug || ''}_${condition || ''}_${hasResultsOnly ? 'results' : 'all'}_${trdFocusOnly ? 'trd' : 'all'}_${yearsBack || 'all'}`;
            
            const updatedStudies = await SearchCacheModule.updateSearchWithNewStudies(searchKey, newStudies);
            
            if (updatedStudies) {
              studies = updatedStudies;
              usedCache = true;
            }
          }
        }
        
        // If we don't have cached results, fetch new ones
        if (!usedCache) {
          console.log('No cached results available, fetching new data...');
          
          if (drug) {
            // Fetch studies for drug (and condition if provided)
            studies = await fetchStudies(drug, condition, hasResultsOnly, yearsBack);
          } else if (condition) {
            // Fetch studies for condition only
            studies = await fetchStudies("", condition, hasResultsOnly, yearsBack);
          }
          
          // Save the search results to the cache
          await SearchCacheModule.saveSearchResults(
            drug, condition, hasResultsOnly, trdFocusOnly, yearsBack, studies
          );
          
          console.log(`Retrieved ${studies.length} studies and saved to cache`);
        }
        
        // Apply phase filtering if specified
        if (phaseFilter !== 'all') {
          // Convert phase filter format for matching (e.g., 'phase1' to 'Phase 1')
          const phaseMapping = {
            'phase1': 'Phase 1',
            'phase2': 'Phase 2',
            'phase3': 'Phase 3',
            'phase4': 'Phase 4'
          };
          
          const phaseDisplayName = phaseMapping[phaseFilter] || '';
          
          if (phaseDisplayName) {
            studies = studies.filter(study => {
              return study.phase === phaseDisplayName || 
                    study.phase?.includes(phaseDisplayName);
            });
            console.log(`Filtered to ${studies.length} ${phaseDisplayName} studies`);
          }
        }
        
        // Filter for TRD-specific studies if requested
        filteredStudies = studies;
        // if (trdFocusOnly) {
        //   filteredStudies = filterTRDSpecificStudies(studies);
        //   console.log(`Filtered to ${filteredStudies.length} TRD-specific studies`);
        // }
        
        appState.studies = filteredStudies;
        
        // Display study-related sections if studies are found
        if (filteredStudies.length > 0) {
          // Display results summary
          displayResultsSummary(filteredStudies);
          showSection(elements.resultsOverview, true);
        //   
          // Display studies list
          console.log("displaying studies for sahfoiai hfdai fhsd", drug,condition)
          displayStudies(filteredStudies, drug, condition);
          showSection(elements.studiesSection, true);
          
          // Fetch study details for studies with results
          await fetchAllStudyDetails(filteredStudies);

        } else {
          // No studies found - show message
          elements.placeholderMessage.innerHTML = `
            <div class="text-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
              <p class="text-lg">No ${trdFocusOnly ? 'TRD-specific ' : ''}studies found for ${drug ? `"${drug}"` : `"${condition}"`}.</p>
              <p class="mt-2 text-sm">Other data is displayed below.</p>
            </div>`;
        }
      })();
      
      searchPromises.push(trialsPromise);
    }
    
    // 3. HANDLE FDA DATA IF REQUESTED
    if (drug && showFDA) {
      const fdaPromise = (async () => {
        await displayFdaData(drug, condition || '');
        showSection(elements.fdaDataSection, true);
      })();
      
      searchPromises.push(fdaPromise);
    }
    
    // 4. HANDLE EMA DATA IF REQUESTED
    if (drug && showEMA && typeof EmaDataModule !== 'undefined') {
      const emaPromise = (async () => {
        showSection(elements.ema, true)
        EmaDataModule.init();
       
        await EmaDataModule.searchDrug(drug);
        
        // Show EMA section if it exists
        if (elements.emaDataSection) {
          showSection(elements.emaDataSection, true);
        }
      })();
      
      searchPromises.push(emaPromise);
    }
    
    // 5. HANDLE PUBMED SEARCH IF REQUESTED
    if ((drug || condition) && showPubMed && typeof PubMedModule !== 'undefined') {
        showSection(elements.pubmedSection, true)
      const pubmedPromise = (async () => {
        try {
          const pubmedOptions = {
            sortBy: drug ? 'relevance' : 'date',
            fullTextOnly: false,
            yearRange: yearsBack
          };
          
          // Determine search term
          const pubmedSearchTerm = drug && condition ? `${drug} ${condition}` : 
                                  drug ? drug : condition;
          
          console.log(`Searching PubMed for: ${pubmedSearchTerm}`);
          
          if (drug && PubMedModule.searchPubMedByDrug) {
            await PubMedModule.searchPubMedByDrug(drug, {
              yearRange: yearsBack,
              condition: condition // Pass condition as additional context
            });
          } else if (condition && PubMedModule.searchPubMedByCondition) {
            await PubMedModule.searchPubMedByCondition(condition, {
              yearRange: yearsBack,
              drug: drug // Pass drug as additional context
            });
          } else if (PubMedModule.searchPubMed) {
            // Fallback to general search
            await PubMedModule.searchPubMed(pubmedSearchTerm, pubmedOptions);
          }
          
          // Show PubMed section if it exists
          if (elements.pubmedSection) {
            showSection(elements.pubmedSection, true);
          }
        } catch (pubmedError) {
          console.error("Error in PubMed search:", pubmedError);
        }
      })();
      
      searchPromises.push(pubmedPromise);
    }
    
    // Wait for all search promises to resolve
    await Promise.allSettled(searchPromises);
    
    // If we're in AI search mode, add an explanation about what was displayed
    if (isAISearch) {
      const displayedContent = [
        showTrials ? 'Clinical Trials' : null,
        showFDA ? 'FDA Data' : null,
        showEMA ? 'EMA Data' : null,
        showPubMed ? 'Publications' : null
      ].filter(Boolean);
      
      if (displayedContent.length < 4) {  // Not showing everything
        const explanationHTML = `
          <div class="mt-4 p-3 bg-blue-50 border border-blue-100 rounded-lg">
            <p class="text-sm text-blue-700">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
              </svg>
              Based on your request, I'm only showing ${displayedContent.join(' and ')} for ${drug ? `"${drug}"` : `"${condition}"`}.
            </p>
          </div>`;
        
        // Append explanation to placeholder if nothing was found
        if (elements.placeholderMessage.style.display !== 'none') {
          elements.placeholderMessage.innerHTML += explanationHTML;
        }
        // Otherwise append to the first visible section
        else if (elements.resultsOverview?.style?.display !== 'none') {
          elements.resultsOverview.insertAdjacentHTML('afterbegin', explanationHTML);
        }
        else if (elements.fdaDataSection?.style?.display !== 'none') {
          elements.fdaDataSection.insertAdjacentHTML('afterbegin', explanationHTML);
        }
        else if (elements.emaDataSection?.style?.display !== 'none') {
          elements.emaDataSection.insertAdjacentHTML('afterbegin', explanationHTML);
        }
        else if (elements.pubmedSection?.style?.display !== 'none') {
          elements.pubmedSection.insertAdjacentHTML('afterbegin', explanationHTML);
        }
      }
    }
    
    displayLoading(false);
    
  } catch (error) {
    console.error('Error during search:', error);
    elements.placeholderMessage.innerHTML = `
      <div class="text-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-red-500 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <p class="text-lg">Error searching for studies</p>
        <p class="mt-2 text-sm">Please try again later.</p>
        <p class="mt-2 text-xs text-gray-500">${error.message}</p>
      </div>`;
    displayLoading(false);
  }
}


// Simple standalone test for the NLP content type detection
// You can run this in your browser console to test if the detection is working properly

// Copy and paste the fixed NLPProcessor implementation first, then run this test

// Test function
function testContentTypeDetection() {
  if (!window.NLPProcessor || !window.NLPProcessor.detectContentTypes) {
    console.error('NLPProcessor not found! Make sure you paste the implementation first.');
    return;
  }
  
  const testQueries = [
    "Show me only FDA data for ketamine",
    "Find clinical trials for psilocybin",
    "Show FDA and EMA data for COMP360",
    "I need publications about depression treatments",
    "Search for recent Phase 2 trials with TRD focus",
    "Show me all data for Spravato"
  ];
  
  console.group("NLP Content Type Detection Test");
  
  testQueries.forEach(query => {
    console.log(`\nTesting query: "${query}"`);
    
    // First test just the content type detection
    const contentTypes = NLPProcessor.detectContentTypes(query);
    console.log('Content types detected:', contentTypes);
    
    // Then test the full query processing
    const fullResults = NLPProcessor.processQuery(query);
    console.log('Full query processing:', {
      drug: fullResults.drug,
      condition: fullResults.condition,
      contentTypes: {
        trials: fullResults.trials,
        fda: fullResults.fda,
        ema: fullResults.ema,
        pubmed: fullResults.pubmed
      }
    });
  });
  
  console.groupEnd();
}

// Run the test
// testContentTypeDetection();

// Event listeners (same as before)
document.addEventListener('DOMContentLoaded', function() {
  // Connect AI search button
  const aiSearchButton = document.getElementById('aiSearchButton');
  const aiSearchInput = document.getElementById('aiSearch');
  
  if (aiSearchButton && aiSearchInput) {
    aiSearchButton.addEventListener('click', function() {
      const aiQuery = aiSearchInput.value.trim();
      if (aiQuery) {
        handleAISearch(true, aiQuery);
      } else {
        // Show notification that query is empty
        const notification = document.createElement('div');
        notification.className = 'fixed top-4 right-4 bg-amber-100 text-amber-800 px-4 py-2 rounded-lg shadow-md';
        notification.innerHTML = `
          <div class="flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
            </svg>
            Please enter a search description for AI search.
          </div>
        `;
        document.body.appendChild(notification);
        
        // Remove the notification after 3 seconds
        setTimeout(() => {
          notification.classList.add('opacity-0', 'transition-opacity', 'duration-500');
          setTimeout(() => {
            document.body.removeChild(notification);
          }, 500);
        }, 3000);
      }
    });
    
    // Allow pressing Enter in the AI search box
    aiSearchInput.addEventListener('keypress', function(event) {
      if (event.key === 'Enter') {
        event.preventDefault();
        aiSearchButton.click();
      }
    });
  }
  
  // Keep existing search button functionality

});

// Helper function to validate email
function validateEmail(email) {
  const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return re.test(email);
}

async function fetchAllStudyDetails(studies) {
    appState.studyDetails = {};
    const studiesWithResults = studies.filter(study => study.hasResults);
    console.log(`Fetching details for ${studiesWithResults.length} studies with results`);
    
    if (studiesWithResults.length === 0) return;
    
    // Use a semaphore to limit concurrent API calls
    const MAX_CONCURRENT_REQUESTS = 5;
    let activeRequests = 0;
    let requestQueue = [...studiesWithResults];
    let completedRequests = 0;
    
    const processQueue = async () => {
        if (requestQueue.length === 0) return;
        
        while (activeRequests < MAX_CONCURRENT_REQUESTS && requestQueue.length > 0) {
            activeRequests++;
            const study = requestQueue.shift();
            const nctId = study.protocolSection.identificationModule.nctId;
            
            fetchStudyDetails(nctId).then(details => {
                if (details) {
                    appState.studyDetails[nctId] = details;
                }
                
                activeRequests--;
                completedRequests++;
                
                // Update progress if we have a lot of studies
                if (studiesWithResults.length > 10 && completedRequests % 5 === 0) {
                    const progressPercent = Math.round((completedRequests / studiesWithResults.length) * 100);
                    console.log(`Study details progress: ${progressPercent}% (${completedRequests}/${studiesWithResults.length})`);
                }
                
                // Process more from queue
                processQueue();
                
                // If all requests are complete
                if (activeRequests === 0 && requestQueue.length === 0) {
                    console.log('All study details fetched');
                    collectAllTrialOutcomes();
                }
            });
        }
    };
    
    // Start processing the queue
    return processQueue();
}

async function handleSearch() {
    // Get search parameters
    const drug = elements.drugSearch.value.trim();
    const condition = elements.conditionSearch.value.trim();
    const hasResultsOnly = elements.hasResultsOnly.checked;
    const trdFocusOnly = elements.trdFocusOnly.checked;
    const yearsBack = parseInt(document.getElementById('timelineSlider').value);
    
    // Update state
    appState.hasResultsOnly = hasResultsOnly;
    appState.trdFocusOnly = trdFocusOnly;
    appState.currentPhaseFilter = 'all';
    appState.studies = [];
    appState.studyDetails = {};
    appState.failedStudyIds.clear(); // Reset failed study IDs
    

    // Example usage:
    if (drug){
        SearchTermManager.setSearchTerm(drug);
    } else {
        SearchTermManager.setSearchTerm(condition);
    }




    // Reset FDA data
    appState.fdaData = {
        documents: [],
        orangeBook: [],
        dailyMed: [],
        warningLetters: []
    };
    
    // Reset phase filter buttons
    document.querySelectorAll('.phase-filter').forEach(btn => {
        btn.classList.remove('bg-primary', 'text-white');
        btn.classList.add('bg-gray-200', 'hover:bg-gray-300');
    });
    document.querySelector('.phase-filter[data-phase="all"]').classList.remove('bg-gray-200', 'hover:bg-gray-300');
    document.querySelector('.phase-filter[data-phase="all"]').classList.add('bg-primary', 'text-white');
    
    // 1. HIDE ABSOLUTELY EVERYTHING FIRST
    showSection(elements.ctSummary, false)
  showSection(elements.ema, false)
  showSection(elements.pubmedSection, false)
    showSection(elements.resultsOverview, false);
    showSection(elements.studiesSection, false);
    showSection(elements.studyDetailSection, false);
    showSection(elements.fdaDataSection, false);
    showSection(elements.placeholderMessage, false);
    // Hide any other sections that might be visible
    document.querySelectorAll('.results-section').forEach(section => {
        section.style.display = 'none';
    });
    displayLoading(true);
    
    // Now show the placeholder for user feedback
    showSection(elements.placeholderMessage, true);
    
    // Set placeholder message to searching
    elements.placeholderMessage.innerHTML = ``;
    //     <div class="text-center">
    //         <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
    //             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
    //         </svg>
    //         <p class="text-lg">Searching for data...</p>
    //     </div>`;
    
    try {
        console.log(`Searching - Drug: ${drug}, Condition: ${condition}, Results Only: ${hasResultsOnly}, TRD Focus: ${trdFocusOnly}`);
        
        // Initialize the database if not already done
        await SearchCacheModule.initDatabase();
        
        // 2. DETERMINE SEARCH TERMS FOR PUBMED
        let pubmedSearchTerm = drug;
        if (condition) {
            pubmedSearchTerm = drug ? `${drug} ${condition}` : condition;
        }
        
        // 3. HANDLE CLINICAL TRIALS SEARCH IF DRUG OR CONDITION IS PROVIDED
        let filteredStudies = [];
        
        if (drug || condition) {
            // First, check if we have a cached search for this query
            const cachedSearch = await SearchCacheModule.getCachedSearchResults(
                drug, condition, hasResultsOnly, trdFocusOnly, yearsBack
            );
            
            let studies = [];
            let usedCache = false;
            
            if (cachedSearch) {
                // Check if the cached search is recent enough
                const MAX_CACHE_AGE_DAYS = 7; // Consider searches older than 7 days as outdated
                const isOutdated = SearchCacheModule.isSearchOutdated(cachedSearch.timestamp, MAX_CACHE_AGE_DAYS);
                
                if (!isOutdated) {
                    // Use the cached search results
                    console.log(`Using cached search results from ${cachedSearch.timestamp}`);
                    studies = cachedSearch.results;
                    usedCache = true;
                    
                    // Update placeholder message
                    elements.placeholderMessage.innerHTML = `
                        <div class="text-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-green-500 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <p class="text-lg">Using cached search results from ${new Date(cachedSearch.timestamp).toLocaleDateString()}</p>
                            <p class="text-sm text-gray-500">Displaying ${cachedSearch.studyCount} studies</p>
                        </div>`;
                } else {
                    // The cached search is outdated, but we can use it as a starting point
                    console.log(`Cached search is outdated (from ${cachedSearch.timestamp}). Fetching new studies...`);
                    
                    // Get studies that were added after the cached search
                    const newStudies = await fetchStudies(drug, condition, hasResultsOnly, yearsBack);
                    
                    // Update the cached search with the new studies
                    const searchKey = cachedSearch.searchKey || 
                        `${drug || ''}_${condition || ''}_${hasResultsOnly ? 'results' : 'all'}_${trdFocusOnly ? 'trd' : 'all'}_${yearsBack || 'all'}`;
                    
                    const updatedStudies = await SearchCacheModule.updateSearchWithNewStudies(searchKey, newStudies);
                    
                    if (updatedStudies) {
                        studies = updatedStudies;
                        usedCache = true;
                        
                        // Update placeholder message
                        elements.placeholderMessage.innerHTML = `
                            <div class="text-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-yellow-500 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                </svg>
                                <p class="text-lg">Updated cached search results</p>
                                <p class="text-sm text-gray-500">Added ${newStudies.length} new studies</p>
                            </div>`;
                    }
                }
            }
            
            // If we don't have cached results, fetch new ones
            if (!usedCache) {
                console.log('No cached results available, fetching new data...');
                
                if (drug) {
                    // Fetch studies for drug (and condition if provided)
                    studies = await fetchStudies(drug, condition, hasResultsOnly, yearsBack);
                } else if (condition) {
                    // Fetch studies for condition only
                    studies = await fetchStudies("", condition, hasResultsOnly, yearsBack);
                }
                
                // Save the search results to the cache
                await SearchCacheModule.saveSearchResults(
                    drug, condition, hasResultsOnly, trdFocusOnly, yearsBack, studies
                );
                
                console.log(`Retrieved ${studies.length} studies and saved to cache`);
            }
            
            // Filter for TRD-specific studies if requested
            filteredStudies = studies;
            if (trdFocusOnly) {
                filteredStudies = filterTRDSpecificStudies(studies);
                console.log(`Filtered to ${filteredStudies.length} TRD-specific studies`);
            }
            
            appState.studies = filteredStudies;
            // collectAllTrialOutcomes();
            
            // Display study-related sections if studies are found
            if (filteredStudies.length > 0) {
                // Display results summary
                displayResultsSummary(filteredStudies);
                showSection(elements.resultsOverview, true);
                
                // Display studies list
                displayStudies(filteredStudies, drug, condition);
                showSection(elements.studiesSection, true);
                
                // Fetch study details for studies with results
                await fetchAllStudyDetails(filteredStudies);
            } else {
                // No studies found - show message
                elements.placeholderMessage.innerHTML = `
                    <div class="text-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                        <p class="text-lg">No ${trdFocusOnly ? 'TRD-specific ' : ''}studies found for ${drug ? `"${drug}"` : `"${condition}"`}.</p>
                        <p class="mt-2 text-sm">Other data is displayed below.</p>
                    </div>`;
            }
            
            // If we have a drug, display FDA data
            if (drug) {
                displayFdaData(drug);
                showSection(elements.fdaDataSection, true);
                
                // EMA Data
                EmaDataModule.init();
                EmaDataModule.searchDrug(drug);
                
                // For drug search - PubMed
                if (drug && typeof PubMedModule !== 'undefined') {
                    try {
                        const pubmedOptions = {
                            sortBy: 'relevance',
                            fullTextOnly: false,
                            yearRange: yearsBack
                        };
                        
                        console.log("Searching PubMed for drug:", drug);
                        if (PubMedModule.searchPubMedByDrug) {
                            PubMedModule.searchPubMedByDrug(drug, {
                                yearRange: yearsBack  // Last N years of publications
                            });
                        } else if (PubMedModule.searchPubMed) {
                            // Fallback to general search if specialized function isn't available
                            PubMedModule.searchPubMed(drug, pubmedOptions);
                        }
                    } catch (pubmedError) {
                        console.error("Error in PubMed drug search:", pubmedError);
                    }
                }
            } else if (condition) {
                // For condition search - PubMed
                if (condition && typeof PubMedModule !== 'undefined') {
                    try {
                        const pubmedOptions = {
                            sortBy: 'date',
                            fullTextOnly: false,
                            yearRange: yearsBack
                        };
                        console.log("Searching PubMed for condition:", condition);
                        if (PubMedModule.searchPubMedByCondition) {
                            PubMedModule.searchPubMedByCondition(condition, pubmedOptions);
                        } else if (PubMedModule.searchPubMed) {
                            // Fallback to general search if specialized function isn't available
                            PubMedModule.searchPubMed(condition, pubmedOptions);
                        }
                    } catch (pubmedError) {
                        console.error("Error in PubMed condition search:", pubmedError);
                    }
                }
            }
        }
        
        displayLoading(false);
        
    } catch (error) {
        console.error('Error during search:', error);
        elements.placeholderMessage.innerHTML = `
            <div class="text-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-red-500 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <p class="text-lg">Error searching for studies</p>
                <p class="mt-2 text-sm">Please try again later.</p>
                <p class="mt-2 text-xs text-gray-500">${error.message}</p>
            </div>`;
        displayLoading(false);
    }
}



// Fetch studies from ClinicalTrials.gov API
// async function fetchStudies(drug, condition, hasResults, yearsBack = 5, sinceDate = null) {
//   try {
//     condition = condition || "";
//     const allStudies = [];
//     let pageToken = null;
//     let hasNextPage = true;

//     // Calculate the date from yearsBack
//     const today = new Date();
//     const startDate = new Date();
//     startDate.setFullYear(today.getFullYear() - yearsBack);

//     // Format date as YYYY-MM-DD for the API
//     const formattedStartDate = `${startDate.getFullYear()}-${String(startDate.getMonth() + 1).padStart(2, '0')}-${String(startDate.getDate()).padStart(2, '0')}`;

//     // Format sinceDate if provided
//     let formattedSinceDate = null;
//     if (sinceDate) {
//       const since = new Date(sinceDate);
//       formattedSinceDate = `${since.getFullYear()}-${String(since.getMonth() + 1).padStart(2, '0')}-${String(since.getDate()).padStart(2, '0')}`;
//     }

//     console.log(`Fetching studies from ${formattedStartDate}${sinceDate ? `, updated since ${formattedSinceDate}` : ''}`);

//     // Continue fetching until there are no more pages
//     while (hasNextPage) {
//       const params = {
//         condition: condition,
//         intervention: drug,
//         hasResults: hasResults,
//         fields: "protocolSection,resultsSection,hasResults",
//         pageSize: 100, // Keep page size at 100 for efficiency
//         advanced: `AREA[StartDate]RANGE[${formattedStartDate},MAX]${formattedSinceDate ? ` AND AREA[LastUpdatePostDate]RANGE[${formattedSinceDate},MAX]` : ''}` // Filter by start date and sinceDate
//       };

//       // Add page token for pagination if we're not on the first page
//       if (pageToken) {
//         params.pageToken = pageToken;
//       }

//       console.log(`Fetching studies page with params:`, params);

//       const response = await axios.get(`${API_BASE_URL}/studies/search`, {
//         params,
//         headers: {
//           'Accept': 'application/json',
//           'Cache-Control': 'no-cache',
//           'Pragma': 'no-cache'
//         }
//       });

//       console.log(`Studies search response status: ${response.status}, page size: ${response.data.data.studies?.length || 0}`);

//       const studies = response.data.data.studies || [];
//       allStudies.push(...studies);

//       // Get next page token
//       pageToken = response.data.pagination?.nextPageToken;
//       hasNextPage = !!pageToken;

//       // Optional: Add delay to avoid rate limiting
//       if (hasNextPage) {
//         await new Promise(resolve => setTimeout(resolve, 300));
//       }
//     }

//     console.log(`Total studies fetched: ${allStudies.length}`);
//     return allStudies;
//   } catch (error) {
//     console.error("Error fetching all studies:", error);
//     return [];
//   }
// }
async function fetchStudies(intervention, condition, hasResults, yearsBack = 5, sinceDate = null) {
  try {
    const params = {
      intervention: intervention, // Match the parameter name expected by backend
      condition: condition || "",
      pageSize: 100,

      fields: "protocolSection,resultsSection,hasResults",
      fetchAll: "false", // Match backend parameter
      drugName: intervention
    };
    
    // Format date filters using the advanced filter format expected by backend
    if (yearsBack || sinceDate) {
      const today = new Date();
      const startDate = new Date();
      startDate.setFullYear(today.getFullYear() - yearsBack);
      
      const formattedStartDate = `${startDate.getFullYear()}-${String(startDate.getMonth() + 1).padStart(2, '0')}-${String(startDate.getDate()).padStart(2, '0')}`;
      
      let formattedSinceDate = null;
      if (sinceDate) {
        const since = new Date(sinceDate);
        formattedSinceDate = `${since.getFullYear()}-${String(since.getMonth() + 1).padStart(2, '0')}-${String(since.getDate()).padStart(2, '0')}`;
      }
      
      params.advanced = `AREA[StartDate]RANGE[${formattedStartDate},MAX]${formattedSinceDate ? ` AND AREA[LastUpdatePostDate]RANGE[${formattedSinceDate},MAX]` : ''}`;
    }
    
    // hasResults parameter formatting
    if (hasResults !== undefined) {
      params.hasResults = hasResults;
    }
    
    console.log(`Fetching studies with params:`, params);
    
    const allStudies = [];
    let page = 1;
    let hasNextPage = true;
    
    while (hasNextPage) {
      params.page = page;
      
      const response = await axios.get(`${API_BASE_URL}/studies/search` , {
        params,
        headers: {
          'Accept': 'application/json',
          'Cache-Control': 'no-cache',
          'Pragma': 'no-cache'
        }
      });
      
      const studies = response.data.data.studies || [];
      allStudies.push(...studies);
      
      // Update pagination based on backend response format
      hasNextPage = response.data.pagination?.hasNextPage;
      page++;
      
      // Add delay to avoid rate limiting
      if (hasNextPage) {
        await new Promise(resolve => setTimeout(resolve, 300));
      }
    }
    
    console.log(`Total studies fetched: ${allStudies.length}`);
    return allStudies;
  } catch (error) {
    console.error("Error fetching studies:", error);
    return [];
  }
}
// SearchCacheModule.js
// This module handles caching and retrieving search results for clinical trials

const SearchCacheModule = (() => {
  // File path for the database (not used directly for API calls)
  const DB_FILE = 'db.json';
  
  // Initialize the database if it doesn't exist
  const initDatabase = async () => {
    try {
      // Check if database exists by attempting to read it
      const db = await readDatabase();
      if (!db.searches) {
        const initialDb = {
          searches: {},
          lastUpdated: new Date().toISOString()
        };
        await writeToFile(DB_FILE, JSON.stringify(initialDb, null, 2));
        console.log('Database initialized successfully');
      }
    } catch (error) {
      console.error('Failed to initialize database:', error);
      throw error;
    }
  };
  
  // Check if a file exists (not needed for API, but kept for compatibility)
  const fileExists = async (filePath) => {
    try {
      const response = await fetch('/api/db', { method: 'GET' });
      return response.ok;
    } catch (error) {
      return false;
    }
  };
  
  // Read from database via API
  const readDatabase = async () => {
    try {
      const response = await fetch('/api/db');
      if (!response.ok) {
        throw new Error(`Failed to read database: ${response.status}`);
      }
      const data = await response.json();
      // Ensure data has the expected structure
      if (!data.searches) {
        data.searches = {};
      }
      if (!data.lastUpdated) {
        data.lastUpdated = new Date().toISOString();
      }
      return data;
    } catch (error) {
      console.error('Error reading database:', error);
      await initDatabase();
      return { searches: {}, lastUpdated: new Date().toISOString() };
    }
  };
  
  // Write to database via API
  const writeToFile = async (filePath, content) => {
    try {
      const response = await fetch('/api/db', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: content,
      });
      if (!response.ok) {
        throw new Error(`Failed to write database: ${response.status}`);
      }
      console.log(`Database saved to ${filePath}`);
      return true;
    } catch (error) {
      console.error('Error writing to database:', error);
      // Optional: Fallback to localStorage
      localStorage.setItem('clinicalTrialsDb', content);
      console.warn('Saved to localStorage as fallback');
      return true;
    }
  };
  
  // Generate a search key from search parameters
  const generateSearchKey = (drug, condition, hasResultsOnly, trdFocusOnly, yearsBack) => {
    return `${drug || ''}_${condition || ''}_${hasResultsOnly ? 'results' : 'all'}_${trdFocusOnly ? 'trd' : 'all'}_${yearsBack || 'all'}`;
  };
  
  // Save search results to database
  function saveSearchResults(drug, condition, hasResultsOnly, trdFocusOnly, yearsBack, studies, callback) {
  const searchKey = generateSearchKey(drug, condition, hasResultsOnly, trdFocusOnly, yearsBack);
  readDatabase((err, db) => {
    if (err) {
      console.error('Error reading database for save:', err);
      return callback(err);
    }
    // Filter study fields to reduce size
    const filteredStudies = studies.map((study) => ({
      nctId: study.protocolSection.identificationModule.nctId,
      title: study.protocolSection.identificationModule.briefTitle,
      status: study.protocolSection.statusModule.overallStatus,
      startDate: study.protocolSection.designModule.startDateStruct?.date,
      // Add other fields as needed
    }));
    db.searches[searchKey] = {
      timestamp: new Date().toISOString(),
      parameters: {
        drug,
        condition,
        hasResultsOnly,
        trdFocusOnly,
        yearsBack,
      },
      results: filteredStudies,
      studyCount: filteredStudies.length,
    };
    db.lastUpdated = new Date().toISOString();
    writeToFile(DB_FILE, JSON.stringify(db, null, 2), (writeErr, success) => {
      if (writeErr || !success) {
        console.error('Error saving search results:', writeErr);
        return callback(writeErr || new Error('Failed to save search results'));
      }
      console.log(`Saved search results for key: ${searchKey}`);
      callback(null, true);
    });
  });
}

  
  // Get cached search results if available
  const getCachedSearchResults = async (drug, condition, hasResultsOnly, trdFocusOnly, yearsBack) => {
    try {
      const searchKey = generateSearchKey(drug, condition, hasResultsOnly, trdFocusOnly, yearsBack);
      const db = await readDatabase();
      
      if (db.searches && db.searches[searchKey]) {
        const cachedSearch = db.searches[searchKey];
        console.log(`Found cached search from ${cachedSearch.timestamp} with ${cachedSearch.studyCount} studies`);
        return cachedSearch;
      }
      
      console.log(`No cached search found for key: ${searchKey}`);
      return null;
    } catch (error) {
      console.error('Error retrieving cached search:', error);
      return null;
    }
  };
  
  // Check if search is outdated based on timestamp and max age in days
  const isSearchOutdated = (timestamp, maxAgeDays = 7) => {
    const cachedDate = new Date(timestamp);
    const currentDate = new Date();
    const diffTime = Math.abs(currentDate - cachedDate);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    return diffDays > maxAgeDays;
  };
  
  // Get studies added after a given date
  const getNewStudiesSince = async (drug, condition, hasResultsOnly, yearsBack, sinceDate) => {
    try {
      console.log(`Fetching new studies since ${sinceDate}`);
      const newStudies = await fetchStudies(drug, condition, hasResultsOnly, yearsBack, sinceDate);
      return newStudies;
    } catch (error) {
      console.error('Error fetching new studies:', error);
      return [];
    }
  };
  
  // Update existing search with new studies
  const updateSearchWithNewStudies = async (searchKey, newStudies) => {
    try {
      const db = await readDatabase();
      
      if (!db.searches[searchKey]) {
        console.error(`Search key ${searchKey} not found in database`);
        return false;
      }
      
      const existingStudies = db.searches[searchKey].results;
      const existingNctIds = new Set(
        existingStudies.map(study => study.protocolSection.identificationModule.nctId)
      );
      
      const uniqueNewStudies = newStudies.filter(study => {
        const nctId = study.protocolSection.identificationModule.nctId;
        return !existingNctIds.has(nctId);
      });
      
      console.log(`Found ${uniqueNewStudies.length} new unique studies`);
      
      if (uniqueNewStudies.length > 0) {
        const combinedStudies = [...existingStudies, ...uniqueNewStudies];
        db.searches[searchKey].results = combinedStudies;
        db.searches[searchKey].timestamp = new Date().toISOString();
        db.searches[searchKey].studyCount = combinedStudies.length;
        db.lastUpdated = new Date().toISOString();
        
        await writeToFile(DB_FILE, JSON.stringify(db, null, 2));
        
        console.log(`Updated search key ${searchKey} with ${uniqueNewStudies.length} new studies`);
        return combinedStudies;
      }
      
      console.log('No new studies to add');
      return existingStudies;
    } catch (error) {
      console.error('Error updating search with new studies:', error);
      return null;
    }
  };
  
  // Public interface
  return {
    initDatabase,
    saveSearchResults,
    getCachedSearchResults,
    isSearchOutdated,
    getNewStudiesSince,
    updateSearchWithNewStudies
  };
})();

function extractCommonDepressionMeasures() {
    if (appState.allTrialOutcomes.length === 0) return [];
    
    // Collect all depression-related outcome measures
    const depressionMeasures = new Map();
    
    appState.allTrialOutcomes.forEach(study => {
        study.outcomes.forEach(outcome => {
            const title = outcome.title;
            const titleLower = title.toLowerCase();
            
            // Check if this is a depression scale
            if (titleLower.includes('depression') || 
                titleLower.includes('madrs') || 
                titleLower.includes('ham-d') || 
                titleLower.includes('hamd') || 
                titleLower.includes('qids') || 
                titleLower.includes('beck') || 
                titleLower.includes('phq')) {
                
                if (!depressionMeasures.has(title)) {
                    depressionMeasures.set(title, {
                        title,
                        count: 0,
                        studies: new Set(),
                        experimentalValues: [],
                        controlValues: [],
                        effectSizes: []
                    });
                }
                
                const measureData = depressionMeasures.get(title);
                measureData.count++;
                measureData.studies.add(study.nctId);
                
                if (outcome.experimentalValue !== null) {
                    measureData.experimentalValues.push(outcome.experimentalValue);
                }
                
                if (outcome.controlValue !== null) {
                    measureData.controlValues.push(outcome.controlValue);
                }
                
                if (outcome.effectSize !== null) {
                    measureData.effectSizes.push(outcome.effectSize);
                }
            }
        });
    });
    
    // Convert to array and add statistics
    const result = Array.from(depressionMeasures.values()).map(measure => {
        return {
            title: measure.title,
            count: measure.count,
            studyCount: measure.studies.size,
            avgExperimental: measure.experimentalValues.length > 0 ? 
                calculateMean(measure.experimentalValues) : null,
            avgControl: measure.controlValues.length > 0 ? 
                calculateMean(measure.controlValues) : null,
            avgEffectSize: measure.effectSizes.length > 0 ? 
                calculateMean(measure.effectSizes) : null
        };
    });
    
    // Sort by frequency
    result.sort((a, b) => b.count - a.count);
    
    return result;
}

// Function to create a combined view of treatment efficacy across all depression measures
function createCombinedMeasuresChart() {
    const measures = extractCommonDepressionMeasures();
    if (measures.length === 0) return;
    
    // Get the most common measure to use for comparison
    const commonMeasure = measures[0];
    
    console.log(`Most common depression measure: ${commonMeasure.title} (used in ${commonMeasure.studyCount} studies)`);
    
    // Create a section for this visualization if it doesn't exist
    let measuresSection = document.getElementById('combinedMeasuresSection');
    if (!measuresSection) {
        try {
            const drugSuccessSection = document.getElementById('drugSuccessSection');
            if (!drugSuccessSection) {
                console.error("Drug success section not found, cannot add combined measures section");
                return;
            }
            
            // Create section after the drug success section
            measuresSection = document.createElement('section');
            measuresSection.id = 'combinedMeasuresSection';
            measuresSection.className = 'hidden mb-6'; // Start hidden
            measuresSection.innerHTML = `
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold mb-4">Treatment Efficacy Across Depression Measures</h2>
                    <p class="text-sm text-gray-600 mb-4">Combined analysis of all trials using standardized depression measures.</p>
                    <div class="mb-6">
                        <h3 class="text-lg font-medium mb-3">Depression Rating Scale Comparison</h3>
                        <div class="h-72">
                            <canvas id="combinedMeasuresChart"></canvas>
                        </div>
                    </div>
                    <div class="mb-6">
                        <h3 class="text-lg font-medium mb-3">Most Common Depression Measures</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white border border-gray-200">
                                <thead>
                                    <tr>
                                        <th class="py-2 px-4 border-b text-left">Measure</th>
                                        <th class="py-2 px-4 border-b text-left">Studies</th>
                                        <th class="py-2 px-4 border-b text-left">Data Points</th>
                                        <th class="py-2 px-4 border-b text-left">Avg. Effect Size</th>
                                    </tr>
                                </thead>
                                <tbody id="measuresSummaryTable">
                                    <!-- Will be populated dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            drugSuccessSection.parentNode.insertBefore(measuresSection, drugSuccessSection.nextSibling);
            
            // Add references to the elements object
            elements.combinedMeasuresSection = measuresSection;
            elements.measuresSummaryTable = document.getElementById('measuresSummaryTable');
            
            // Show the section
            showSection(measuresSection, true);
        } catch (error) {
            console.error("Error creating combined measures section:", error);
            return;
        }
    } else {
        // Show the section if it exists
        showSection(measuresSection, true);
    }
    
    try {
        // Create the chart
        const canvas = document.getElementById('combinedMeasuresChart');
        if (!canvas) {
            console.error("Combined measures chart canvas not found");
            return;
        }
        
        // Clear any previous chart
        if (charts.combinedMeasures) {
            charts.combinedMeasures.destroy();
        }
        
        // Filter to measures with effect sizes
        const measuresWithEffects = measures.filter(m => m.avgEffectSize !== null);
        
        if (measuresWithEffects.length === 0) {
            canvas.parentElement.innerHTML = '<p class="text-center text-gray-500 py-8">No effect size data available for comparison.</p>';
            return;
        }
        
        const ctx = canvas.getContext('2d');
        
        // Create the chart
        charts.combinedMeasures = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: measuresWithEffects.map(m => m.title),
                datasets: [{
                    label: 'Average Effect Size',
                    data: measuresWithEffects.map(m => m.avgEffectSize),
                    backgroundColor: measuresWithEffects.map((_, i) => getColorByIndex(i, 0.7)),
                    borderColor: measuresWithEffects.map((_, i) => getColorByIndex(i)),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Average Effect Size'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Depression Measure'
                        },
                        ticks: {
                            callback: function(value) {
                                // Truncate long labels
                                const label = this.getLabelForValue(value);
                                if (label.length > 25) {
                                    return label.substring(0, 22) + '...';
                                }
                                return label;
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            title: function(context) {
                                return measuresWithEffects[context[0].dataIndex].title;
                            },
                            label: function(context) {
                                const measure = measuresWithEffects[context.dataIndex];
                                return [
                                    `Effect Size: ${measure.avgEffectSize.toFixed(2)}`,
                                    `Studies: ${measure.studyCount}`,
                                    `Data Points: ${measure.count}`
                                ];
                            }
                        }
                    }
                }
            }
        });
        
        // Fill the measures summary table
        const table = elements.measuresSummaryTable;
        if (table) {
            table.innerHTML = '';
            
            measures.forEach(measure => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="py-2 px-4 border-b">${measure.title}</td>
                    <td class="py-2 px-4 border-b">${measure.studyCount}</td>
                    <td class="py-2 px-4 border-b">${measure.count}</td>
                    <td class="py-2 px-4 border-b">${measure.avgEffectSize !== null ? measure.avgEffectSize.toFixed(2) : 'N/A'}</td>
                `;
                table.appendChild(row);
            });
        }
    } catch (error) {
        console.error("Error rendering combined measures chart:", error);
        
        // Add error message to section
        measuresSection.querySelector('.bg-white').innerHTML += `
            <div class="bg-red-50 text-red-700 p-4 rounded-lg mt-4">
                <p>Error creating depression measures chart: ${error.message}</p>
                <p class="text-sm mt-2">This is likely due to insufficient data in the available studies.</p>
            </div>
        `;
    }
}
// New function to create a treatment outcome curve showing probability of response
function createTreatmentOutcomeCurve() {
    // Get data points from all studies
    if (appState.allTrialOutcomes.length === 0) return;
    
    // Find response rate outcomes across all studies
    const responseData = [];
    
    appState.allTrialOutcomes.forEach(study => {
        study.outcomes.forEach(outcome => {
            const titleLower = outcome.title.toLowerCase();
            const isResponseOutcome = titleLower.includes(">= 50% improvement") || 
                                    titleLower.includes("responders") || 
                                    titleLower.includes("response rate");
            
            if (isResponseOutcome && outcome.measurements && outcome.measurements.length > 0) {
                // Extract drug name
                const drugName = extractDrugName(study.title, outcome.measurements);
                
                // Get experimental and control measurements
                const experimentalMeasurements = outcome.measurements.filter(m => !m.isControlGroup);
                const controlMeasurements = outcome.measurements.filter(m => m.isControlGroup);
                
                if (experimentalMeasurements.length > 0) {
                    // For response outcomes, measurements are usually percentages
                    experimentalMeasurements.forEach(measurement => {
                        responseData.push({
                            drug: drugName,
                            studyId: study.nctId,
                            phase: study.phase,
                            isControl: false,
                            responseRate: measurement.value
                        });
                    });
                }
                
                if (controlMeasurements.length > 0) {
                    controlMeasurements.forEach(measurement => {
                        responseData.push({
                            drug: "Placebo",
                            studyId: study.nctId,
                            phase: study.phase,
                            isControl: true,
                            responseRate: measurement.value
                        });
                    });
                }
            }
        });
    });
    
    if (responseData.length === 0) return;
    
    console.log(`Found ${responseData.length} response rate data points across all studies`);
    
    // Create a section for this visualization
    let outcomeCurveSection = document.getElementById('outcomeCurveSection');
    if (!outcomeCurveSection) {
        const drugSuccessSection = document.getElementById('drugSuccessSection');
        if (!drugSuccessSection) return;
        
        // Create section before the drug success section
        outcomeCurveSection = document.createElement('section');
        outcomeCurveSection.id = 'outcomeCurveSection';
        outcomeCurveSection.className = 'hidden mb-6';  // Start hidden until we add content
        outcomeCurveSection.innerHTML = `
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4">Treatment Outcome Curve</h2>
                <p class="text-sm text-gray-600 mb-4">Combined visualization of treatment response rates across all trials.</p>
                <div class="mb-6">
                    <h3 class="text-lg font-medium mb-3">Response Rate Distribution</h3>
                    <div class="h-72">
                        <canvas id="treatmentOutcomeCurveChart"></canvas>
                    </div>
                </div>
                <div class="mb-6">
                    <h3 class="text-lg font-medium mb-3">Treatment vs Placebo Response</h3>
                    <div class="h-72">
                        <canvas id="treatmentVsPlaceboChart"></canvas>
                    </div>
                </div>
            </div>
        `;
        
        drugSuccessSection.parentNode.insertBefore(outcomeCurveSection, drugSuccessSection);
        
        // Add references to the elements object
        elements.outcomeCurveSection = outcomeCurveSection;
    }
    
    // Show the section
    showSection(elements.outcomeCurveSection, true);
    
    try {
        // Create the charts
        createTreatmentOutcomeCurveChart(responseData);
        createTreatmentVsPlaceboChart(responseData);
    } catch (error) {
        console.error("Error creating treatment outcome charts:", error);
        
        // Add error message to section
        outcomeCurveSection.querySelector('.bg-white').innerHTML += `
            <div class="bg-red-50 text-red-700 p-4 rounded-lg mt-4">
                <p>Error creating treatment outcome charts: ${error.message}</p>
                <p class="text-sm mt-2">This is likely due to insufficient response rate data in the available studies.</p>
            </div>
        `;
    }
}
function createTreatmentOutcomeCurveChart(responseData) {
    const canvas = document.getElementById('treatmentOutcomeCurveChart');
    if (!canvas) return;
    
    // Clear any previous chart
    if (charts.treatmentOutcomeCurve) {
        charts.treatmentOutcomeCurve.destroy();
    }
    
    // Group data by drug
    const drugGroups = {};
    responseData.forEach(item => {
        if (!drugGroups[item.drug]) {
            drugGroups[item.drug] = [];
        }
        drugGroups[item.drug].push(item.responseRate);
    });
    
    // Generate curves for each drug
    const datasets = [];
    Object.entries(drugGroups).forEach(([drug, rates], index) => {
        if (rates.length < 2) return; // Need at least 2 data points
        
        // Calculate mean and standard deviation
        const mean = calculateMean(rates);
        const stdDev = calculateStandardDeviation(rates, mean);
        
        // Generate curve data
        const curveData = [];
        for (let x = 0; x <= 100; x += 1) { // 0-100% response rate
            const density = (1 / (stdDev * Math.sqrt(2 * Math.PI))) * 
                          Math.exp(-Math.pow(x - mean, 2) / (2 * Math.pow(stdDev, 2)));
            curveData.push({x, y: density});
        }
        
        // Add dataset
        datasets.push({
            label: drug,
            data: curveData,
            borderColor: getColorByIndex(index),
            backgroundColor: getColorByIndex(index, 0.1),
            fill: true,
            tension: 0.4,
            pointRadius: 0
        });
    });
    
    const ctx = canvas.getContext('2d');
    
    // Create the chart
    charts.treatmentOutcomeCurve = new Chart(ctx, {
        type: 'line',
        data: {
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    type: 'linear',
                    min: 0,
                    max: 100,
                    title: {
                        display: true,
                        text: 'Response Rate (%)'
                    }
                },
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Probability Density'
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'top'
                },
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            return `${context[0].dataset.label}`;
                        },
                        label: function(context) {
                            return `Response Rate: ${context.parsed.x.toFixed(1)}%`;
                        }
                    }
                }
            }
        }
    });
}

function createTreatmentVsPlaceboChart(responseData) {
    const canvas = document.getElementById('treatmentVsPlaceboChart');
    if (!canvas) return;
    
    // Clear any previous chart
    if (charts.treatmentVsPlacebo) {
        charts.treatmentVsPlacebo.destroy();
    }
    
    // Separate treatment and placebo data
    const treatmentData = responseData.filter(item => !item.isControl);
    const placeboData = responseData.filter(item => item.isControl);
    
    if (treatmentData.length === 0 || placeboData.length === 0) {
        canvas.parentElement.innerHTML = '<p class="text-center text-gray-500 py-8">Insufficient data for treatment vs placebo comparison.</p>';
        return;
    }
    
    // Calculate statistics
    const treatmentRates = treatmentData.map(item => item.responseRate);
    const placeboRates = placeboData.map(item => item.responseRate);
    
    const treatmentMean = calculateMean(treatmentRates);
    const placeboMean = calculateMean(placeboRates);
    
    const treatmentStdDev = calculateStandardDeviation(treatmentRates, treatmentMean);
    const placeboStdDev = calculateStandardDeviation(placeboRates, placeboMean);
    
    const treatmentCI = calculateConfidenceInterval(treatmentMean, treatmentStdDev, treatmentRates.length);
    const placeboCI = calculateConfidenceInterval(placeboMean, placeboStdDev, placeboRates.length);
    
    const ctx = canvas.getContext('2d');
    
    // Create the chart
    charts.treatmentVsPlacebo = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['All Treatments', 'Placebo'],
            datasets: [{
                label: 'Average Response Rate',
                data: [treatmentMean, placeboMean],
                backgroundColor: ['rgba(59, 130, 246, 0.7)', 'rgba(156, 163, 175, 0.7)'],
                borderColor: ['rgb(59, 130, 246)', 'rgb(156, 163, 175)'],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Response Rate (%)'
                    },
                    max: 100
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            return context[0].label;
                        },
                        label: function(context) {
                            const index = context.dataIndex;
                            const label = context.dataset.label;
                            if (index === 0) { // Treatment
                                return [
                                    `${label}: ${treatmentMean.toFixed(1)}%`,
                                    `95% CI: [${treatmentCI.lower.toFixed(1)}, ${treatmentCI.upper.toFixed(1)}]`,
                                    `N = ${treatmentRates.length} data points`
                                ];
                            } else { // Placebo
                                return [
                                    `${label}: ${placeboMean.toFixed(1)}%`,
                                    `95% CI: [${placeboCI.lower.toFixed(1)}, ${placeboCI.upper.toFixed(1)}]`,
                                    `N = ${placeboRates.length} data points`
                                ];
                            }
                        }
                    }
                }
            }
        },
        plugins: [{
            id: 'errorBars',
            afterDatasetsDraw: function(chart) {
                const ctx = chart.ctx;
                
                chart.data.datasets.forEach((dataset, i) => {
                    const meta = chart.getDatasetMeta(i);
                    
                    if (!meta.hidden) {
                        meta.data.forEach((element, index) => {
                            // Error bars data
                            let plus, minus;
                            if (index === 0) { // Treatment
                                plus = treatmentCI.upper - treatmentMean;
                                minus = treatmentMean - treatmentCI.lower;
                            } else { // Placebo
                                plus = placeboCI.upper - placeboMean;
                                minus = placeboMean - placeboCI.lower;
                            }
                            
                            const x = element.x;
                            const y = element.y;
                            const barWidth = 5;
                            
                            // Save state
                            ctx.save();
                            
                            // Line style
                            ctx.lineWidth = 2;
                            ctx.strokeStyle = dataset.borderColor[index];
                            
                            // Draw the line
                            ctx.beginPath();
                            ctx.moveTo(x, y - plus);
                            ctx.lineTo(x, y + minus);
                            ctx.stroke();
                            
                            // Draw the top cap
                            ctx.beginPath();
                            ctx.moveTo(x - barWidth, y - plus);
                            ctx.lineTo(x + barWidth, y - plus);
                            ctx.stroke();
                            
                            // Draw the bottom cap
                            ctx.beginPath();
                            ctx.moveTo(x - barWidth, y + minus);
                            ctx.lineTo(x + barWidth, y + minus);
                            ctx.stroke();
                            
                            // Restore state
                            ctx.restore();
                        });
                    }
                });
            }
        }]
    });
}

function ensureChartCanvasesExist() {
    // Make sure the collated outcomes section is visible
    const collatedSection = document.getElementById('collatedOutcomesSection');
    if (!collatedSection) {
        console.error('Collated outcomes section not found');
        return;
    }
    
    // Find containers for charts or create them
    const chartContainers = collatedSection.querySelectorAll('.h-72');
    
    if (chartContainers.length < 3) {
        console.warn('Chart containers not found, attempting to create them');
        
        // Find the main content div
        const contentDiv = collatedSection.querySelector('.bg-white');
        if (!contentDiv) {
            console.error('Content div not found in collated outcomes section');
            return;
        }
        
        // Create containers if needed
        if (chartContainers.length === 0) {
            console.log('Creating all chart containers');
            // Create first section - Overall Treatment Effect
            const section1 = document.createElement('div');
            section1.className = 'mb-6';
            section1.innerHTML = `
                <h3 class="text-lg font-medium mb-3">Overall Treatment Effect Distribution</h3>
                <div class="flex justify-between mb-4">
                    <div>
                        <select id="outcomeMetricSelector" class="p-2 border border-gray-300 rounded-lg">
                            <!-- Will be populated dynamically -->
                        </select>
                    </div>
                    <div>
                        <select id="outcomeTypeSelector" class="p-2 border border-gray-300 rounded-lg">
                            <option value="all">All Outcomes</option>
                            <option value="primary" selected>Primary Outcomes</option>
                            <option value="secondary">Secondary Outcomes</option>
                        </select>
                    </div>
                </div>
                <div class="h-72">
                    <canvas id="overallTreatmentEffectChart"></canvas>
                </div>
            `;
            contentDiv.appendChild(section1);
            
            // Create second section - Phase Comparison
            const section2 = document.createElement('div');
            section2.className = 'mb-6';
            section2.innerHTML = `
                <h3 class="text-lg font-medium mb-3">Phase Comparison</h3>
                <p class="text-sm text-gray-600 mb-4">Compare effect sizes across different clinical trial phases. Higher values indicate better outcomes.</p>
                <div class="h-72">
                    <canvas id="phaseComparisonChart"></canvas>
                </div>
            `;
            contentDiv.appendChild(section2);
            
            // Create third section - Comparative Phase Performance
            const section3 = document.createElement('div');
            section3.className = 'mb-6';
            section3.innerHTML = `
                <h3 class="text-lg font-medium mb-3">Comparative Phase Performance</h3>
                <p class="text-sm text-gray-600 mb-4">Direct comparison of phase-specific effect sizes with confidence intervals.</p>
                <div class="h-72">
                    <canvas id="phasePerformanceChart"></canvas>
                </div>
            `;
            contentDiv.appendChild(section3);
            
            // Update element references
            elements.outcomeMetricSelector = document.getElementById('outcomeMetricSelector');
            elements.outcomeTypeSelector = document.getElementById('outcomeTypeSelector');
            
            // Re-add event listeners
            if (elements.outcomeMetricSelector) {
                elements.outcomeMetricSelector.addEventListener('change', () => {
                    appState.currentOutcomeMetric = elements.outcomeMetricSelector.value;
                    displayCollatedOutcomes();
                });
            }
            
            if (elements.outcomeTypeSelector) {
                elements.outcomeTypeSelector.addEventListener('change', () => {
                    appState.currentOutcomeType = elements.outcomeTypeSelector.value;
                    displayCollatedOutcomes();
                });
            }
        } else {
            // Add missing containers as needed
            const lastContainer = chartContainers[chartContainers.length - 1];
            const parentElement = lastContainer.parentElement;
            
            if (chartContainers.length === 1) {
                // Need to add phase comparison and performance sections
                const section2 = document.createElement('div');
                section2.className = 'mb-6';
                section2.innerHTML = `
                    <h3 class="text-lg font-medium mb-3">Phase Comparison</h3>
                    <p class="text-sm text-gray-600 mb-4">Compare effect sizes across different clinical trial phases. Higher values indicate better outcomes.</p>
                    <div class="h-72">
                        <canvas id="phaseComparisonChart"></canvas>
                    </div>
                `;
                parentElement.parentElement.insertBefore(section2, parentElement.nextSibling);
                
                const section3 = document.createElement('div');
                section3.className = 'mb-6';
                section3.innerHTML = `
                    <h3 class="text-lg font-medium mb-3">Comparative Phase Performance</h3>
                    <p class="text-sm text-gray-600 mb-4">Direct comparison of phase-specific effect sizes with confidence intervals.</p>
                    <div class="h-72">
                        <canvas id="phasePerformanceChart"></canvas>
                    </div>
                `;
                parentElement.parentElement.insertBefore(section3, section2.nextSibling);
            } else if (chartContainers.length === 2) {
                // Need to add phase performance section
                const section3 = document.createElement('div');
                section3.className = 'mb-6';
                section3.innerHTML = `
                    <h3 class="text-lg font-medium mb-3">Comparative Phase Performance</h3>
                    <p class="text-sm text-gray-600 mb-4">Direct comparison of phase-specific effect sizes with confidence intervals.</p>
                    <div class="h-72">
                        <canvas id="phasePerformanceChart"></canvas>
                    </div>
                `;
                parentElement.parentElement.insertBefore(section3, parentElement.nextSibling);
            }
        }
    }
    
    // Ensure chart canvases exist within containers
    const chartCanvases = [
        { id: 'overallTreatmentEffectChart', containerIndex: 0 },
        { id: 'phaseComparisonChart', containerIndex: 1 },
        { id: 'phasePerformanceChart', containerIndex: 2 }
    ];
    
    const updatedContainers = collatedSection.querySelectorAll('.h-72');
    chartCanvases.forEach(({ id, containerIndex }) => {
        if (containerIndex < updatedContainers.length) {
            const container = updatedContainers[containerIndex];
            if (!document.getElementById(id)) {
                console.log(`Creating canvas: ${id}`);
                container.innerHTML = `<canvas id="${id}"></canvas>`;
            }
        }
    });
}
function copyTrialDataToClipboard(nctId) {
const studyDetail = appState.studyDetails[nctId];

if (!studyDetail) {
    alert('Study details not available for copying.');
    return;
}

// Format study data as JSON
const studyData = JSON.stringify(studyDetail, null, 2);

// Create a temporary textarea to facilitate copying
const textarea = document.createElement('textarea');
textarea.value = studyData;
textarea.setAttribute('readonly', '');
textarea.style.position = 'absolute';
textarea.style.left = '-9999px';
document.body.appendChild(textarea);

// Copy the text
textarea.select();
document.execCommand('copy');

// Clean up
document.body.removeChild(textarea);

// Notify user
alert('Study data copied to clipboard.');
}

// Function to copy data from trial to clipboard 
// function copyTrialDataToClipboard(nctId) {
//     const study = appState.studies.find(s => s.protocolSection?.identificationModule?.nctId === nctId);
//     if (!study) return;
    
//     const studyDetail = appState.studyDetails[nctId];
    
//     const identification = study.protocolSection?.identificationModule || {};
//     const design = study.protocolSection?.designModule || {};
    
//     // Create a text summary of the study
//     let summary = `CLINICAL TRIAL SUMMARY\n`;
//     summary += `===================\n\n`;
//     summary += `TITLE: ${identification.briefTitle || 'N/A'}\n`;
//     summary += `NCT ID: ${nctId}\n`;
//     summary += `PHASE: ${formatPhase(design.phases?.[0] || 'N/A')}\n`;
//     summary += `STATUS: ${study.protocolSection?.statusModule?.overallStatus || 'N/A'}\n`;
//     summary += `SPONSOR: ${identification.organization?.fullName || 'N/A'}\n\n`;
    
//     // Add outcome data if available
//     if (studyDetail && studyDetail.resultsSection?.outcomeMeasuresModule?.outcomeMeasures) {
//         const outcomes = studyDetail.resultsSection.outcomeMeasuresModule.outcomeMeasures;
        
//         summary += `OUTCOMES:\n`;
//         outcomes.forEach((outcome, idx) => {
//             summary += `${idx + 1}. ${outcome.title} (${outcome.type})\n`;
//             summary += `   Time Frame: ${outcome.timeFrame || 'Not specified'}\n`;
            
//             if (outcome.classes && outcome.classes[0]?.categories) {
//                 outcome.classes.forEach(cls => {
//                     cls.categories.forEach(cat => {
//                         summary += `   - ${cat.title}:\n`;
                        
//                         cat.measurements.forEach(measurement => {
//                             const group = outcome.groups.find(g => g.id === measurement.groupId);
//                             if (group) {
//                                 summary += `     * ${group.title}: ${measurement.value}`;
//                                 if (measurement.dispersion) {
//                                     summary += ` ± ${measurement.dispersion} (${measurement.dispersionType || 'dispersion'})`;
//                                 }
//                                 summary += `\n`;
//                             }
//                         });
//                     });
//                 });
//             }
//             summary += `\n`;
//         });
//     }
    
//     // Add URL to the full study
//     summary += `View full study: https://clinicaltrials.gov/study/${nctId}\n`;
    
//     // Create a temporary textarea element to copy the text
//     const textarea = document.createElement('textarea');
//     textarea.value = summary;
//     document.body.appendChild(textarea);
//     textarea.select();
    
//     try {
//         const successful = document.execCommand('copy');
//         const msg = successful ? 'successful' : 'unsuccessful';
//         console.log('Copy trial data was ' + msg);
//         alert('Study details copied to clipboard');
//     } catch (err) {
//         console.error('Error copying trial data: ', err);
//         alert('Failed to copy study details');
//     }
    
//     document.body.removeChild(textarea);
// }
        function initEventListeners() {
            elements.searchButton.addEventListener('click', handleSearch);
            elements.phaseFilter.addEventListener('click', handlePhaseFilter);
            elements.closeStudyDetail.addEventListener('click', () => {
                showSection(elements.studyDetailSection, false);
            });
            
            // Add enter key support for search
            elements.drugSearch.addEventListener('keyup', event => {
                if (event.key === 'Enter') {
                    handleSearch();
                }
            });
            elements.conditionSearch.addEventListener('keyup', event => {
                if (event.key === 'Enter') {
                    handleSearch();
                }
            });
            
            // Add outcome metric selector event
            elements.outcomeMetricSelector.addEventListener('change', () => {
                appState.currentOutcomeMetric = elements.outcomeMetricSelector.value;
                displayCollatedOutcomes();
            });
            
            // Add outcome type selector event
            elements.outcomeTypeSelector.addEventListener('change', () => {
                appState.currentOutcomeType = elements.outcomeTypeSelector.value;
                displayCollatedOutcomes();
            });

            const navbar = document.createElement('div');
    navbar.className = 'fixed bottom-4 left-0 right-0 flex justify-center';
    navbar.innerHTML = `
           <div class="bg-white rounded-full shadow-lg px-4 py-2 flex space-x-4"  style="display: none;">
                <button id="nav-studies" class="text-primary hover:text-blue-700 text-sm font-medium">Studies</button>
                <button id="nav-outcomes" class="text-primary hover:text-blue-700 text-sm font-medium">Outcomes</button>
                <button id="nav-aggregate" class="text-primary hover:text-blue-700 text-sm font-medium">Aggregate</button>
                <button id="nav-drug-success" class="text-primary hover:text-blue-700 text-sm font-medium">Success Rates</button>
                <button id="nav-fda" class="text-primary hover:text-blue-700 text-sm font-medium">FDA Data</button>
            </div>
    `;
    document.body.appendChild(navbar);
    
    // Add event listeners for navigation
    document.getElementById('nav-studies').addEventListener('click', () => {
        elements.studiesSection.scrollIntoView({ behavior: 'smooth' });
    });
    document.getElementById('nav-outcomes').addEventListener('click', () => {
        elements.collatedOutcomesSection.scrollIntoView({ behavior: 'smooth' });
    });
    document.getElementById('nav-aggregate').addEventListener('click', () => {
        elements.aggregateOutcomesSection.scrollIntoView({ behavior: 'smooth' });
    });
    document.getElementById('nav-fda').addEventListener('click', () => {
        elements.fdaDataSection.scrollIntoView({ behavior: 'smooth' });
    });
    document.getElementById('nav-drug-success')?.addEventListener('click', () => {
        elements.drugSuccessSection.scrollIntoView({ behavior: 'smooth' });
    });
    

            
            // Handle window resize to redraw charts
            window.addEventListener('resize', debounce(() => {
                // Only redraw visible charts to improve performance
                const redrawCharts = () => {
                    Object.values(charts).forEach(chart => {
                        if (chart && typeof chart.update === 'function') {
                            try {
                                chart.resize();
                                chart.update();
                            } catch (e) {
                                console.warn('Error updating chart:', e);
                            }
                        }
                    });
                };
                
                redrawCharts();
            }, 250));
        }
        
        // Utility function for debouncing
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Initialize application
        function init() {
    // Check if all required elements are available
    const missingElements = Object.entries(elements).filter(([key, value]) => !value);
    if (missingElements.length > 0) {
        console.error('Missing required elements:', missingElements.map(([key]) => key));
        
        // Try to get elements again after DOM is fully loaded
        document.addEventListener('DOMContentLoaded', () => {
            Object.keys(elements).forEach(key => {
                if (!elements[key]) {
                    elements[key] = document.getElementById(key);
                }
            });
            
            initEventListeners();
        });
    } else {
        initEventListeners();
    }
    
    // // Set default condition
    // if (elements.conditionSearch) {
    //     elements.conditionSearch.value = "Treatment Resistant Depression";
    // }

    
    console.log('Enhanced TRD Clinical Trials Research Tool initialized');
}



// Clinical Trial Dashboard Module
// Robust Clinical Trial Dashboard Module
const TrialDashboard = (function() {
    let chartInstances = {};
    let allTrialsData = null;
    let dashboardInitialized = false;
    
    const COLORS = {
        control: { primary: 'rgba(59, 130, 246, 0.8)', secondary: 'rgba(59, 130, 246, 0.2)' },
        experimental: { primary: 'rgba(16, 185, 129, 0.8)', secondary: 'rgba(16, 185, 129, 0.2)' },
        effect: ['#ebf8ff', '#bee3f8', '#90cdf4', '#63b3ed', '#4299e1', '#3182ce', '#2b6cb0'],
        success: ['#c6f6d5', '#9ae6b4', '#68d391', '#48bb78', '#38a169'],
        status: {
            'COMPLETED': '#10b981',
            'TERMINATED': '#ef4444',
            'ACTIVE': '#f59e0b',
            'RECRUITING': '#6366f1',
            'NOT_YET_RECRUITING': '#8b5cf6',
            'SUSPENDED': '#f43f5e',
            'WITHDRAWN': '#64748b',
            'UNKNOWN': '#9ca3af'
        }
    };

    function init(containerId = 'trial-dashboard') {
    const container = document.getElementById(containerId);
    if (!container) {
        console.error(`Container with ID "${containerId}" not found.`);
        return null;
    }
    
    // Set container to full width
    container.classList.add('w-full', 'max-w-full');
    container.innerHTML = '';
    container.style.display = 'none';
    
    // Add custom stylesheet
    addCustomStyles();
    
    dashboardInitialized = true;
    
    // Add export button after dashboard is created
    setTimeout(addExportButton, 500);
    
    return container;
}
    
    function addCustomStyles() {
        const styleId = 'trial-dashboard-styles';
        if (!document.getElementById(styleId)) {
            const style = document.createElement('style');
            style.id = styleId;
            style.textContent = `
                .trial-card {
                    transition: all 0.2s ease-in-out;
                    box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
                }
                .trial-card:hover {
                    box-shadow: 0 3px 6px rgba(0,0,0,0.16), 0 3px 6px rgba(0,0,0,0.23);
                }
                .dashboard-header {
                    background: linear-gradient(90deg, #f0f9ff 0%, #e0f2fe 100%);
                }
                .status-badge {
                    display: inline-block;
                    padding: 0.25rem 0.5rem;
                    border-radius: 9999px;
                    font-size: 0.75rem;
                    font-weight: 600;
                    text-transform: uppercase;
                    color: white;
                }
                .score-pill {
                    display: inline-flex;
                    align-items: center;
                    justify-content: center;
                    width: 3rem;
                    height: 1.5rem;
                    border-radius: 9999px;
                    font-weight: 600;
                    font-size: 0.875rem;
                }
                .tooltip {
                    position: relative;
                    display: inline-block;
                }
                .tooltip .tooltip-text {
                    visibility: hidden;
                    width: 200px;
                    background-color: #333;
                    color: #fff;
                    text-align: center;
                    border-radius: 6px;
                    padding: 5px;
                    position: absolute;
                    z-index: 1;
                    bottom: 125%;
                    left: 50%;
                    margin-left: -100px;
                    opacity: 0;
                    transition: opacity 0.3s;
                }
                .tooltip:hover .tooltip-text {
                    visibility: visible;
                    opacity: 1;
                }
                .toggle-details {
                    cursor: pointer;
                    user-select: none;
                }
                .trial-details {
                    max-height: 0;
                    overflow: hidden;
                    transition: max-height 0.3s ease-out;
                }
                .trial-details.open {
                    max-height: 500px;
                }
            `;
            document.head.appendChild(style);
        }
    }

// Create a modified version of the trials table section to be hidden by default
function createDashboardStructure(containerId = 'trial-dashboard') {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    container.innerHTML = `
        <!-- Dashboard header and summary metrics -->
        <div class="dashboard-header w-full p-6 mb-6 rounded-lg">
            <div class="flex flex-col md:flex-row justify-between items-center mb-4">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">Clinical Trials Dashboard</h1>
                    <p class="text-gray-600">Comprehensive analysis of trial outcomes and metrics</p>
                </div>
                <div class="flex items-center mt-4 md:mt-0">
                    <div class="bg-white rounded-full shadow-sm px-4 py-2 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                        </svg>
                        <span class="font-medium text-gray-700" id="trials-count">Analyzing trials...</span>
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4" id="summary-metrics">
                <!-- Summary metrics will be inserted here -->
            </div>
        </div>
        
        <!-- Success score charts (binomial and distribution) -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <div class="bg-white p-5 rounded-lg shadow trial-card">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold text-gray-800">Success Scores Distribution</h2>
                    <div class="tooltip">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span class="tooltip-text">Binomial distribution of success scores across trials</span>
                    </div>
                </div>
                <div class="h-72"><canvas id="successScoresChart"></canvas></div>
            </div>
            <div class="bg-white p-5 rounded-lg shadow trial-card">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold text-gray-800">Success Score Normal Distribution</h2>
                    <div class="tooltip">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span class="tooltip-text">Probability distribution of success scores with mean and standard deviation</span>
                    </div>
                </div>
                <div class="h-72"><canvas id="successDistributionChart"></canvas></div>
            </div>
        </div>
        
        <!-- Phase and status charts -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <div class="bg-white p-5 rounded-lg shadow trial-card">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold text-gray-800">Trial Phase Distribution</h2>
                    <div class="tooltip">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span class="tooltip-text">Distribution of trials by clinical phase</span>
                    </div>
                </div>
                <div class="h-72"><canvas id="phaseDistributionChart"></canvas></div>
            </div>
            <div class="bg-white p-5 rounded-lg shadow trial-card">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold text-gray-800">Trial Status Overview</h2>
                    <div class="tooltip">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span class="tooltip-text">Current status of all trials in the dataset</span>
                    </div>
                </div>
                <div class="h-72"><canvas id="statusDistributionChart"></canvas></div>
            </div>
        </div>
        
        <!-- Effect size and response/remission -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <div class="bg-white p-5 rounded-lg shadow trial-card">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold text-gray-800">Effect Size Analysis</h2>
                    <div class="tooltip">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span class="tooltip-text">Cohen's d effect sizes across trials with available data</span>
                    </div>
                </div>
                <p class="text-sm text-gray-500 mb-3" id="effect-size-desc">Analyzing effect sizes across trials...</p>
                <div class="h-64"><canvas id="effectSizeChart"></canvas></div>
            </div>
            <div class="bg-white p-5 rounded-lg shadow trial-card">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold text-gray-800">Response & Remission Rates</h2>
                    <div class="tooltip">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span class="tooltip-text">Average difference in response and remission rates between treatment and control groups</span>
                    </div>
                </div>
                <div class="h-64" id="response-remission-chart-container">
                    <canvas id="responseRemissionChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Conclusions section -->
        <div class="bg-white p-5 rounded-lg shadow trial-card mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold text-gray-800">Key Insights & Conclusions</h2>
                <div class="tooltip">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span class="tooltip-text">Summary of findings from all analyzed trials</span>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-1 gap-6">
                <div>
                    <ul class="space-y-3" id="conclusions-list">
                        <li class="flex items-start">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-500 mr-2 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <span>Analyzing trial data...</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- Trials table with toggle button -->
        <div class="bg-white p-5 rounded-lg shadow trial-card">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold text-gray-800">Trial Details</h2>
                <div class="flex items-center space-x-3">
                    <button id="toggle-trials-table" class="px-4 py-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition-colors">
                        <span id="toggle-text">Show Trials</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block ml-1" id="toggle-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </button>
                </div>
            </div>
            <div id="trials-table-section" class="hidden">
                <div class="mb-4">
                    <input type="text" id="trial-search" placeholder="Search trials..." class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent w-full sm:w-64">
                </div>
                <div class="overflow-x-auto" id="trials-table-container">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Trial</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Phase</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sponsor</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Score</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Effect Size</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="trial-summary-body">
                            <!-- Trial data rows will go here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
    
    // Add toggle functionality for trials table
    const toggleButton = document.getElementById('toggle-trials-table');
    const tableSection = document.getElementById('trials-table-section');
    const toggleText = document.getElementById('toggle-text');
    const toggleIcon = document.getElementById('toggle-icon');
    
    if (toggleButton && tableSection) {
        toggleButton.addEventListener('click', function() {
            const isHidden = tableSection.classList.contains('hidden');
            
            // Toggle visibility
            if (isHidden) {
                tableSection.classList.remove('hidden');
                toggleText.textContent = 'Hide Trials';
                toggleIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />';
            } else {
                tableSection.classList.add('hidden');
                toggleText.textContent = 'Show Trials';
                toggleIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />';
            }
        });
    }
    
    // Add search functionality
    const searchInput = document.getElementById('trial-search');
    if (searchInput) {
        searchInput.addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('#trial-summary-body tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });
    }
}

//     function createDashboardStructure(containerId = 'trial-dashboard') {
//     const container = document.getElementById(containerId);
//     if (!container) return;
    
//     container.innerHTML = `
//         <!-- Dashboard header and summary metrics -->
//         <div class="dashboard-header w-full p-6 mb-6 rounded-lg">
//             <div class="flex flex-col md:flex-row justify-between items-center mb-4">
//                 <div>
//                     <h1 class="text-3xl font-bold text-gray-800">Clinical Trials Dashboard</h1>
//                     <p class="text-gray-600">Comprehensive analysis of trial outcomes and metrics</p>
//                 </div>
//                 <div class="flex items-center mt-4 md:mt-0">
//                     <div class="bg-white rounded-full shadow-sm px-4 py-2 flex items-center">
//                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
//                         </svg>
//                         <span class="font-medium text-gray-700" id="trials-count">Analyzing trials...</span>
//                     </div>
//                 </div>
//             </div>
//             <div class="grid grid-cols-1 md:grid-cols-4 gap-4" id="summary-metrics">
//                 <!-- Summary metrics will be inserted here -->
//             </div>
//         </div>
        
//         <!-- Success score charts (binomial and distribution) -->
//         <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
//             <div class="bg-white p-5 rounded-lg shadow trial-card">
//                 <div class="flex justify-between items-center mb-4">
//                     <h2 class="text-lg font-semibold text-gray-800">Success Scores Distribution</h2>
//                     <div class="tooltip">
//                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
//                         </svg>
//                         <span class="tooltip-text">Binomial distribution of success scores across trials</span>
//                     </div>
//                 </div>
//                 <div class="h-72"><canvas id="successScoresChart"></canvas></div>
//             </div>
//             <div class="bg-white p-5 rounded-lg shadow trial-card">
//                 <div class="flex justify-between items-center mb-4">
//                     <h2 class="text-lg font-semibold text-gray-800">Success Score Normal Distribution</h2>
//                     <div class="tooltip">
//                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
//                         </svg>
//                         <span class="tooltip-text">Probability distribution of success scores with mean and standard deviation</span>
//                     </div>
//                 </div>
//                 <div class="h-72"><canvas id="successDistributionChart"></canvas></div>
//             </div>
//         </div>
        
//         <!-- Phase and status charts -->
//         <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
//             <div class="bg-white p-5 rounded-lg shadow trial-card">
//                 <div class="flex justify-between items-center mb-4">
//                     <h2 class="text-lg font-semibold text-gray-800">Trial Phase Distribution</h2>
//                     <div class="tooltip">
//                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
//                         </svg>
//                         <span class="tooltip-text">Distribution of trials by clinical phase</span>
//                     </div>
//                 </div>
//                 <div class="h-72"><canvas id="phaseDistributionChart"></canvas></div>
//             </div>
//             <div class="bg-white p-5 rounded-lg shadow trial-card">
//                 <div class="flex justify-between items-center mb-4">
//                     <h2 class="text-lg font-semibold text-gray-800">Trial Status Overview</h2>
//                     <div class="tooltip">
//                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
//                         </svg>
//                         <span class="tooltip-text">Current status of all trials in the dataset</span>
//                     </div>
//                 </div>
//                 <div class="h-72"><canvas id="statusDistributionChart"></canvas></div>
//             </div>
//         </div>
        
//         <!-- Effect size and response/remission -->
//         <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
//             <div class="bg-white p-5 rounded-lg shadow trial-card">
//                 <div class="flex justify-between items-center mb-4">
//                     <h2 class="text-lg font-semibold text-gray-800">Effect Size Analysis</h2>
//                     <div class="tooltip">
//                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
//                         </svg>
//                         <span class="tooltip-text">Cohen's d effect sizes across trials with available data</span>
//                     </div>
//                 </div>
//                 <p class="text-sm text-gray-500 mb-3" id="effect-size-desc">Analyzing effect sizes across trials...</p>
//                 <div class="h-64"><canvas id="effectSizeChart"></canvas></div>
//             </div>
//             <div class="bg-white p-5 rounded-lg shadow trial-card">
//                 <div class="flex justify-between items-center mb-4">
//                     <h2 class="text-lg font-semibold text-gray-800">Response & Remission Rates</h2>
//                     <div class="tooltip">
//                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
//                         </svg>
//                         <span class="tooltip-text">Average difference in response and remission rates between treatment and control groups</span>
//                     </div>
//                 </div>
//                 <div class="h-64" id="response-remission-chart-container">
//                     <canvas id="responseRemissionChart"></canvas>
//                 </div>
//             </div>
//         </div>
        
//         <!-- Conclusions section -->
//         <div class="bg-white p-5 rounded-lg shadow trial-card mb-6">
//             <div class="flex justify-between items-center mb-4">
//                 <h2 class="text-lg font-semibold text-gray-800">Key Insights & Conclusions</h2>
//                 <div class="tooltip">
//                     <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
//                     </svg>
//                     <span class="tooltip-text">Summary of findings from all analyzed trials</span>
//                 </div>
//             </div>
//             <div class="grid grid-cols-1 md:grid-cols-1 gap-6">
//                 <div>
//                     <ul class="space-y-3" id="conclusions-list">
//                         <li class="flex items-start">
//                             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-500 mr-2 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
//                             </svg>
//                             <span>Analyzing trial data...</span>
//                         </li>
//                     </ul>
//                 </div>
//             </div>
//         </div>
        
//         <!-- Trials table -->
//         <div class="bg-white p-5 rounded-lg shadow trial-card">
//             <div class="flex justify-between items-center mb-4">
//                 <h2 class="text-lg font-semibold text-gray-800">Trial Details</h2>
//                 <div class="flex items-center">
//                     <input type="text" id="trial-search" placeholder="Search trials..." class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
//                 </div>
//             </div>
//             <div class="overflow-x-auto" id="trials-table-container">
//                 <table class="min-w-full divide-y divide-gray-200">
//                    <thead class="bg-gray-50">
//                             <tr>
//                                 <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Trial</th>
//                                 <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Phase</th>
//                                 <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
//                                 <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sponsor</th>
//                                 <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Score</th>
//                                 <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Effect Size</th>
//                             </tr>
//                         </thead>
//                         <tbody class="bg-white divide-y divide-gray-200" id="trial-summary-body">
//                             <!-- Trial data rows will go here -->
//                         </tbody>
//                     </table>
//                 </div>
//             </div>
//         </div>
//     `;
    
//     // Add search functionality
//     const searchInput = document.getElementById('trial-search');
//     if (searchInput) {
//         searchInput.addEventListener('input', function(e) {
//             const searchTerm = e.target.value.toLowerCase();
//             const rows = document.querySelectorAll('#trial-summary-body tr');
            
//             rows.forEach(row => {
//                 const text = row.textContent.toLowerCase();
//                 if (text.includes(searchTerm)) {
//                     row.style.display = '';
//                 } else {
//                     row.style.display = 'none';
//                 }
//             });
//         });
//     }
// }

// Helper function to get distribution curve data for a given mean and standard deviation
function getNormalDistributionPoints(mean, stdDev, min, max, step) {
    const points = [];
    for (let x = min; x <= max; x += step) {
        // Normal distribution formula
        const y = (1 / (stdDev * Math.sqrt(2 * Math.PI))) * 
                  Math.exp(-0.5 * Math.pow((x - mean) / stdDev, 2));
        points.push({x, y});
    }
    return points;
}

// Helper function to compare different trial groups by success score
function compareTrialGroups(trialSummaries) {
    // Group trials by phase
    const phaseGroups = {};
    trialSummaries.forEach(summary => {
        const phase = summary.phase || 'UNKNOWN';
        if (!phaseGroups[phase]) {
            phaseGroups[phase] = [];
        }
        phaseGroups[phase].push(summary.successScore);
    });
    
    // Calculate mean and std dev for each phase
    const phaseStats = {};
    Object.keys(phaseGroups).forEach(phase => {
        const scores = phaseGroups[phase];
        const mean = scores.reduce((sum, score) => sum + score, 0) / scores.length;
        const variance = scores.reduce((sum, score) => sum + Math.pow(score - mean, 2), 0) / scores.length;
        const stdDev = Math.sqrt(variance);
        phaseStats[phase] = { mean, stdDev, count: scores.length };
    });
    
    return phaseStats;
}

// Function to export the dashboard data to CSV
function exportDashboardData() {
    if (!window.globalSuccessData) {
        console.error('No data available to export');
        return;
    }
    
    const data = window.globalSuccessData.trials;
    let csvContent = "data:text/csv;charset=utf-8,";
    
    // Add headers
    csvContent += "Trial ID,Title,Phase,Status,Success Score,Effect Size\n";
    
    // Add rows
    data.forEach(trial => {
        csvContent += `${trial.id},"${trial.title.replace(/"/g, '""')}",${trial.phase || 'N/A'},${trial.status || 'N/A'},${trial.score},${trial.effectSize || 'N/A'}\n`;
    });
    
    // Create download link
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "clinical_trials_dashboard_data.csv");
    document.body.appendChild(link);
    
    // Trigger download
    link.click();
    
    // Clean up
    document.body.removeChild(link);
}

// Add export button to dashboard
function addExportButton() {
    const header = document.querySelector('.dashboard-header > div');
    if (!header) return;
    
    const exportButton = document.createElement('button');
    exportButton.className = 'ml-4 px-4 py-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50';
    exportButton.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
        </svg>
        Export Data
    `;
    exportButton.addEventListener('click', exportDashboardData);
    
    const buttonContainer = document.createElement('div');
    buttonContainer.className = 'ml-auto';
    buttonContainer.appendChild(exportButton);
    
    header.appendChild(buttonContainer);
}




function loadData(data) {
    const container = document.getElementById('trial-dashboard');
    if (!container) {
        console.error('Container "trial-dashboard" not found');
        return false;
    }

    if (!data || (Array.isArray(data) && data.length === 0)) {
        console.error('No data provided or empty array');
        container.style.display = 'none';
        return false;
    }

    if (!dashboardInitialized) {
        init('trial-dashboard');
    }

    try {
        // Store the data globally
        allTrialsData = data;
        
        // Display the container
        container.style.display = 'block';
        
        // Create dashboard structure
        createDashboardStructure('trial-dashboard');

        // Process all trials and calculate success metrics
        const trialSummaries = processAllTrials(data);
        
        // Store success scores in global variable for external access
        window.globalSuccessData = {
            scores: trialSummaries.map(summary => summary.successScore),
            mean: trialSummaries.reduce((sum, summary) => sum + summary.successScore, 0) / trialSummaries.length,
            trials: trialSummaries.map(summary => ({ 
                id: summary.nctId,
                title: summary.title, 
                score: summary.successScore,
                phase: summary.phase,
                status: summary.status,
                effectSize: summary.effectSize
            }))
        };
        
        // Update trials count
        document.getElementById('trials-count').textContent = `${trialSummaries.length} Trials Analyzed`;
        
        // Populate summary metrics
        populateSummaryMetrics(trialSummaries);
        
        // Populate trials table
        populateSummaryTable(trialSummaries);
        
        // Generate charts
        generateSummaryCharts(trialSummaries);
        
        // Generate conclusions
        generateSummaryConclusions(trialSummaries);

        return true;
    } catch (error) {
        console.error('Error processing data:', error);
        container.style.display = 'none';
        showError('Error processing data: ' + error.message);
        return false;
    }
}
    function showError(message) {
        const container = document.getElementById('trial-dashboard');
        if (!container) return;
        if (!dashboardInitialized) {
            console.error(message);
            return;
        }
        container.innerHTML = `
            <div class="w-full p-8 text-center bg-white rounded-lg shadow">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-red-500 mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
                <h1 class="text-2xl font-bold text-red-600 mb-2">Error Loading Data</h1>
                <p class="text-gray-600 mb-4">${message}</p>
                <button class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50" onclick="location.reload()">
                    Try Again
                </button>
            </div>
        `;
        container.style.display = 'block';
    }

    function processAllTrials(data) {
        const trialSummaries = [];
        let totalEffectSize = 0;
        let effectSizeCount = 0;
        let totalResponseDiff = 0;
        let responseCount = 0;
        let totalRemissionDiff = 0;
        let remissionCount = 0;

        data.forEach((trial, index) => {
            const summary = {
                nctId: trial.nctId,
                title: trial.title,
                phase: trial.phase,
                status: trial.status,
                sponsor: trial.sponsor,
                successScore: 0,
                effectSize: null,
                responseDiff: null,
                remissionDiff: null,
                details: [],
                hasOutcomes: trial.outcomes && trial.outcomes.length > 0
            };

            if (!summary.hasOutcomes) {
                // Estimate success based on status and phase
                summary.successScore = calculateFallbackSuccessScore(trial);
                summary.details.push('No outcome data available.');
                trialSummaries.push(summary);
                return;
            }

            // Process outcomes
            const primaryOutcomes = trial.outcomes.filter(outcome => outcome.type.toLowerCase() === 'primary');
            const responderOutcomes = trial.outcomes.filter(outcome => 
                outcome.title.toLowerCase().includes('improvement') || 
                outcome.title.toLowerCase().includes('response') ||
                outcome.title.toLowerCase().includes('>=') // e.g., ">= 50% Improvement"
            );
            const remitterOutcomes = trial.outcomes.filter(outcome => 
                outcome.title.toLowerCase().includes('<=') || // e.g., "<= 10"
                outcome.title.toLowerCase().includes('remission')
            );

            // Calculate effect size
            if (primaryOutcomes.length > 0) {
                const effectSizeResult = calculateEffectSizeForTrial(primaryOutcomes);
                summary.effectSize = effectSizeResult.effectSize;
                summary.details.push(effectSizeResult.detail);
                if (summary.effectSize !== null) {
                    totalEffectSize += summary.effectSize;
                    effectSizeCount++;
                }
            }

            // Calculate response and remission rates
            const successRates = calculateSuccessRatesForTrial(responderOutcomes, remitterOutcomes);
            summary.responseDiff = successRates.responseDiff;
            summary.remissionDiff = successRates.remissionDiff;
            summary.details.push(...successRates.details);
            if (summary.responseDiff !== null) {
                totalResponseDiff += summary.responseDiff;
                responseCount++;
            }
            if (summary.remissionDiff !== null) {
                totalRemissionDiff += summary.remissionDiff;
                remissionCount++;
            }

            // Calculate success score
            summary.successScore = calculateSuccessScore(summary);
            trialSummaries.push(summary);
        });

        // Store averages for charts
        trialSummaries.avgEffectSize = effectSizeCount > 0 ? totalEffectSize / effectSizeCount : null;
        trialSummaries.avgResponseDiff = responseCount > 0 ? totalResponseDiff / responseCount : null;
        trialSummaries.avgRemissionDiff = remissionCount > 0 ? totalRemissionDiff / remissionCount : null;
        
        // Store counts for summary metrics
        trialSummaries.totalTrials = trialSummaries.length;
        trialSummaries.trialsWithOutcomes = trialSummaries.filter(summary => summary.hasOutcomes).length;
        trialSummaries.completedTrials = trialSummaries.filter(summary => summary.status === 'COMPLETED').length;
        trialSummaries.highSuccessTrials = trialSummaries.filter(summary => summary.successScore >= 70).length;

        return trialSummaries;
    }

    function populateSummaryMetrics(trialSummaries) {
        const container = document.getElementById('summary-metrics');
        if (!container) return;
        
        const metrics = [
            {
                label: 'Total Trials',
                value: trialSummaries.totalTrials,
                icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />',
                color: 'blue'
            },
            {
                label: 'Completed Trials',
                value: trialSummaries.completedTrials,
                icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />',
                color: 'green'
            },
            {
                label: 'With Outcomes',
                value: trialSummaries.trialsWithOutcomes,
                icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />',
                color: 'purple'
            },
            {
                label: 'High Success',
                value: trialSummaries.highSuccessTrials,
                icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />',
                color: 'yellow'
            }
        ];
        
        container.innerHTML = '';
        
        metrics.forEach(metric => {
            const card = document.createElement('div');
            card.className = 'bg-white p-4 rounded-lg shadow trial-card';
            card.innerHTML = `
                <div class="flex items-center">
                    <div class="flex-shrink-0 p-3 rounded-full bg-${metric.color}-100">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-${metric.color}-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            ${metric.icon}
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500">${metric.label}</p>
                        <p class="text-2xl font-semibold text-gray-900">${metric.value}</p>
                    </div>
                </div>
            `;
            container.appendChild(card);
        });
    }

    function calculateFallbackSuccessScore(trial) {
        let score = 0;
        if (trial.status === 'COMPLETED') score += 50;
        else if (trial.status === 'TERMINATED') score += 20;
        if (trial.phase === 'PHASE4') score += 30;
        else if (trial.phase === 'PHASE3') score += 20;
        else if (trial.phase === 'PHASE2') score += 10;
        return score;
    }

    function calculateEffectSizeForTrial(primaryOutcomes) {
        if (!primaryOutcomes || primaryOutcomes.length === 0) {
            return { effectSize: null, detail: 'No primary outcomes available.' };
        }

        const outcome = primaryOutcomes[0];
        if (!outcome.measurements || outcome.measurements.length < 2) {
            return { effectSize: null, detail: 'Insufficient measurements for effect size.' };
        }

        const controlMeasurements = outcome.measurements.filter(m => m.isControlGroup);
        const expMeasurements = outcome.measurements.filter(m => !m.isControlGroup);

        if (controlMeasurements.length === 0 || expMeasurements.length === 0) {
            return { effectSize: null, detail: 'Missing control or experimental data.' };
        }

        const controlMean = controlMeasurements.reduce((sum, m) => sum + (m.value || 0), 0) / controlMeasurements.length;
        const expMean = expMeasurements.reduce((sum, m) => sum + (m.value || 0), 0) / expMeasurements.length;
        const controlSE = controlMeasurements[0].standardError;
        const expSE = expMeasurements[0].standardError;
        const estimatedSD = controlSE || expSE || (outcome.title.toLowerCase().includes('connectivity') ? 0.1 : 8.5);
        const cohensD = Math.abs(expMean - controlMean) / estimatedSD;

        return {
            effectSize: cohensD,
            detail: `Effect size: d = ${cohensD.toFixed(2)} (${getEffectSizeDescription(cohensD)})`
        };
    }

    function calculateSuccessRatesForTrial(responderOutcomes, remitterOutcomes) {
        const result = {
            responseDiff: null,
            remissionDiff: null,
            details: []
        };

        if (responderOutcomes.length > 0) {
            const outcome = responderOutcomes[responderOutcomes.length - 1];
            if (outcome.measurements && outcome.measurements.length > 0) {
                const controlValues = outcome.measurements.filter(m => m.isControlGroup).map(m => m.value).filter(v => v !== null);
                const expValues = outcome.measurements.filter(m => !m.isControlGroup).map(m => m.value).filter(v => v !== null);

                const controlRate = controlValues.length > 0 ? controlValues.reduce((sum, v) => sum + v, 0) / controlValues.length : 0;
                const expRate = expValues.length > 0 ? expValues.reduce((sum, v) => sum + v, 0) / expValues.length : 0;
                result.responseDiff = expRate - controlRate;
                result.details.push(`Response rate difference: ${result.responseDiff >= 0 ? '+' : ''}${result.responseDiff.toFixed(1)}%`);
            } else {
                result.details.push('No measurements for response rate.');
            }
        } else {
            result.details.push('No response rate data available.');
        }

        if (remitterOutcomes.length > 0) {
            const outcome = remitterOutcomes[remitterOutcomes.length - 1];
            if (outcome.measurements && outcome.measurements.length > 0) {
                const controlValues = outcome.measurements.filter(m => m.isControlGroup).map(m => m.value).filter(v => v !== null);
                const expValues = outcome.measurements.filter(m => !m.isControlGroup).map(m => m.value).filter(v => v !== null);

                const controlRate = controlValues.length > 0 ? controlValues.reduce((sum, v) => sum + v, 0) / controlValues.length : 0;
                const expRate = expValues.length > 0 ? expValues.reduce((sum, v) => sum + v, 0) / expValues.length : 0;
                result.remissionDiff = expRate - controlRate;
                result.details.push(`Remission rate difference: ${result.remissionDiff >= 0 ? '+' : ''}${result.remissionDiff.toFixed(1)}%`);
            } else {
                result.details.push('No measurements for remission rate.');
            }
        } else {
            result.details.push('No remission rate data available.');
        }

        return result;
    }

    function calculateSuccessScore(summary) {
        let score = 0;
        if (summary.hasOutcomes) {
            if (summary.effectSize !== null) {
                // Scale effect size to contribute up to 50 points
                if (summary.effectSize >= 2.0) score += 50;
                else if (summary.effectSize >= 1.2) score += 40;
                else if (summary.effectSize >= 0.8) score += 30;
                else if (summary.effectSize >= 0.5) score += 20;
                else if (summary.effectSize >= 0.2) score += 10;
            }
            if (summary.responseDiff !== null) {
                // Scale response difference to contribute up to 25 points
                if (summary.responseDiff >= 20) score += 25;
                else if (summary.responseDiff >= 10) score += 15;
                else if (summary.responseDiff > 0) score += 5;
            }
            if (summary.remissionDiff !== null) {
                // Scale remission difference to contribute up to 25 points
                if (summary.remissionDiff >= 20) score += 25;
                else if (summary.remissionDiff >= 10) score += 15;
                else if (summary.remissionDiff > 0) score += 5;
            }
        } else {
            // Use fallback score for trials without outcomes
            score = summary.successScore;
        }
        return Math.min(score, 100); // Cap at 100
    }

    function getEffectSizeDescription(cohensD) {
        if (cohensD < 0.2) return 'Negligible clinical effect';
        if (cohensD < 0.5) return 'Small clinical effect';
        if (cohensD < 0.8) return 'Medium clinical effect';
        if (cohensD < 1.2) return 'Large clinical effect';
        if (cohensD < 2.0) return 'Very large clinical effect';
        return 'Huge clinical effect';
    }

    function getScoreColor(score) {
        if (score >= 70) return 'bg-green-500';
        if (score >= 50) return 'bg-blue-500';
        if (score >= 30) return 'bg-yellow-500';
        return 'bg-gray-500';
    }

    function getStatusBadgeColor(status) {
        return COLORS.status[status] || '#9ca3af';
    }

    function populateSummaryTable(trialSummaries) {
        const tbody = document.getElementById('trial-summary-body');
        if (!tbody) return;
        
        tbody.innerHTML = '';

        trialSummaries.forEach((summary, index) => {
            const row = document.createElement('tr');
            row.className = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
            
            const detailsId = `trial-details-${index}`;
            const toggleId = `toggle-details-${index}`;
            
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex flex-col">
                        <div class="text-sm font-medium text-gray-900">${summary.nctId}</div>
                        <div class="text-sm text-gray-500">${summary.title.length > 50 ? summary.title.substring(0, 47) + '...' : summary.title}</div>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
                        ${summary.phase || 'N/A'}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="status-badge" style="background-color: ${getStatusBadgeColor(summary.status)}">
                        ${summary.status || 'Unknown'}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    ${summary.sponsor || 'Not specified'}
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="score-pill text-white ${getScoreColor(summary.successScore)}">
                        ${summary.successScore.toFixed(0)}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    ${summary.effectSize !== null ? `<span class="font-medium">${summary.effectSize.toFixed(2)}</span> <span class="text-xs">(${getEffectSizeDescription(summary.effectSize)})</span>` : 'N/A'}
                </td>
            `;
            
            tbody.appendChild(row);
            
            // No toggle functionality needed anymore
        });
    }

    // Helper function to calculate percentage of values in normal distribution between two points
function calculatePercentageInRange(mean, stdDev, start, end) {
    // Calculate the probability using cumulative distribution function (CDF)
    function normCDF(x) {
        const t = 1 / (1 + 0.2316419 * Math.abs(x));
        const d = 0.3989423 * Math.exp(-x * x / 2);
        const prob = d * t * (0.3193815 + t * (-0.3565638 + t * (1.781478 + t * (-1.821256 + t * 1.330274))));
        return x > 0 ? 1 - prob : prob;
    }
    
    const zStart = (start - mean) / stdDev;
    const zEnd = (end - mean) / stdDev;
    
    return (normCDF(zEnd) - normCDF(zStart)) * 100;
}

    function generateSummaryCharts(trialSummaries) {
    // Store success scores in a global variable
    window.globalSuccessScores = trialSummaries.map(summary => summary.successScore);
    
    // Group success scores for binomial chart
    const bins = [
        {min: 0, max: 10, label: '0-10'},
        {min: 11, max: 20, label: '11-20'},
        {min: 21, max: 30, label: '21-30'},
        {min: 31, max: 40, label: '31-40'},
        {min: 41, max: 50, label: '41-50'},
        {min: 51, max: 60, label: '51-60'},
        {min: 61, max: 70, label: '61-70'},
        {min: 71, max: 80, label: '71-80'},
        {min: 81, max: 90, label: '81-90'},
        {min: 91, max: 100, label: '91-100'}
    ];
    
    // Count trials in each bin
    const binCounts = bins.map(bin => {
        return {
            ...bin,
            count: trialSummaries.filter(summary => 
                summary.successScore >= bin.min && 
                summary.successScore <= bin.max
            ).length
        };
    });
    
    // 1. Success Scores Binomial Distribution Chart
    const successScoresData = {
        labels: binCounts.map(bin => bin.label),
        datasets: [{
            label: 'Number of Trials',
            data: binCounts.map(bin => bin.count),
            backgroundColor: binCounts.map(bin => {
                const midpoint = (bin.min + bin.max) / 2;
                if (midpoint >= 70) return 'rgba(16, 185, 129, 0.8)'; 
                if (midpoint >= 50) return 'rgba(59, 130, 246, 0.8)'; 
                if (midpoint >= 30) return 'rgba(245, 158, 11, 0.8)'; 
                return 'rgba(239, 68, 68, 0.8)';
            }),
            borderColor: 'rgba(255, 255, 255, 0.5)',
            borderWidth: 1,
            borderRadius: 4,
            maxBarThickness: 50
        }]
    };
    
    const successScoresConfig = {
        type: 'bar',
        data: successScoresData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { 
                y: { 
                    beginAtZero: true,
                    title: { 
                        display: true, 
                        text: 'Number of Trials',
                        font: { weight: 'bold' }
                    },
                    grid: { color: 'rgba(0, 0, 0, 0.05)' }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Success Score Range',
                        font: { weight: 'bold' }
                    }
                }
            },
            plugins: { 
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        title: function(tooltipItems) {
                            return `Success Score: ${tooltipItems[0].label}`;
                        },
                        label: function(context) {
                            return `${context.raw} trials (${((context.raw / trialSummaries.length) * 100).toFixed(1)}%)`;
                        }
                    }
                }
            }
        }
    };
    createOrUpdateChart('successScoresChart', 'bar', successScoresConfig);

    // 2. Success Score Distribution Curve (Normal Distribution)
    // Calculate mean and standard deviation for success scores
    const scores = trialSummaries.map(summary => summary.successScore);
    const mean = scores.reduce((sum, score) => sum + score, 0) / scores.length;
    const variance = scores.reduce((sum, score) => sum + Math.pow(score - mean, 2), 0) / scores.length;
    const stdDev = Math.sqrt(variance);
    
    // Create normal distribution data points
    const normalDistPoints = [];
    const step = 1;
    for (let x = 0; x <= 100; x += step) {
        const y = (1 / (stdDev * Math.sqrt(2 * Math.PI))) * 
                  Math.exp(-0.5 * Math.pow((x - mean) / stdDev, 2));
        normalDistPoints.push({x, y});
    }
    
    // Calculate high, medium, low success bounds for shading
    const highSuccessBound = 70;
    const mediumSuccessBound = 50;
    const lowSuccessBound = 30;
    
    // Get points for different regions
    const highSuccessPoints = normalDistPoints.filter(p => p.x >= highSuccessBound);
    const mediumSuccessPoints = normalDistPoints.filter(p => p.x >= mediumSuccessBound && p.x < highSuccessBound);
    const lowSuccessPoints = normalDistPoints.filter(p => p.x >= lowSuccessBound && p.x < mediumSuccessBound);
    const veryLowSuccessPoints = normalDistPoints.filter(p => p.x < lowSuccessBound);
    
    // Define colors for different sections
    const highColor = 'rgba(16, 185, 129, 0.3)'; // Green
    const mediumColor = 'rgba(59, 130, 246, 0.3)'; // Blue
    const lowColor = 'rgba(245, 158, 11, 0.3)'; // Orange
    const veryLowColor = 'rgba(239, 68, 68, 0.3)'; // Red
    
    // Create chart config
    const distributionConfig = {
        type: 'line',
        data: {
            datasets: [
                // Main curve
                {
                    label: `All Trials (μ=${mean.toFixed(1)}, σ=${stdDev.toFixed(1)})`,
                    data: normalDistPoints,
                    borderColor: 'rgba(75, 85, 99, 1)',
                    borderWidth: 2,
                    pointRadius: 0,
                    fill: false,
                    tension: 0.4
                },
                // Shaded regions
                {
                    label: 'High Success (70-100)',
                    data: highSuccessPoints,
                    borderColor: 'rgba(16, 185, 129, 0.8)',
                    backgroundColor: highColor,
                    borderWidth: 1,
                    pointRadius: 0,
                    fill: true,
                    tension: 0.4
                },
                {
                    label: 'Medium Success (50-69)',
                    data: mediumSuccessPoints,
                    borderColor: 'rgba(59, 130, 246, 0.8)',
                    backgroundColor: mediumColor,
                    borderWidth: 1,
                    pointRadius: 0,
                    fill: true,
                    tension: 0.4
                },
                {
                    label: 'Low Success (30-49)',
                    data: lowSuccessPoints,
                    borderColor: 'rgba(245, 158, 11, 0.8)',
                    backgroundColor: lowColor,
                    borderWidth: 1,
                    pointRadius: 0,
                    fill: true,
                    tension: 0.4
                },
                {
                    label: 'Very Low Success (0-29)',
                    data: veryLowSuccessPoints,
                    borderColor: 'rgba(239, 68, 68, 0.8)',
                    backgroundColor: veryLowColor,
                    borderWidth: 1,
                    pointRadius: 0,
                    fill: true,
                    tension: 0.4
                },
                // Vertical lines for mean
                {
                    label: 'Mean',
                    data: [
                        {x: mean, y: 0},
                        {x: mean, y: (1 / (stdDev * Math.sqrt(2 * Math.PI)))}
                    ],
                    borderColor: 'rgba(0, 0, 0, 0.8)',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    pointRadius: 0,
                    fill: false
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    type: 'linear',
                    position: 'bottom',
                    title: {
                        display: true,
                        text: 'Success Score',
                        font: { weight: 'bold' }
                    },
                    min: 0,
                    max: 100,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Probability Density',
                        font: { weight: 'bold' }
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        usePointStyle: true,
                        boxWidth: 10,
                        padding: 20
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const datasetLabel = context.dataset.label || '';
                            const x = context.parsed.x;
                            const y = context.parsed.y;
                            if (datasetLabel === 'Mean') {
                                return `Mean score: ${x.toFixed(1)}`;
                            }
                            const percentage = calculatePercentageInRange(
                                mean, stdDev, Math.floor(x), Math.ceil(x)
                            );
                            return `Score ${x.toFixed(0)}: ${(y * 100).toFixed(3)}% density (${percentage.toFixed(1)}% of trials)`;
                        }
                    }
                }
            }
        }
    };
    createOrUpdateChart('successDistributionChart', 'line', distributionConfig);
    
    // 3. Phase Distribution Chart
    const phaseCounts = {};
    trialSummaries.forEach(summary => {
        const phase = summary.phase || 'Not Specified';
        phaseCounts[phase] = (phaseCounts[phase] || 0) + 1;
    });
    const phaseData = {
        labels: Object.keys(phaseCounts),
        datasets: [{
            label: 'Number of Trials',
            data: Object.values(phaseCounts),
            backgroundColor: COLORS.effect.slice(0, Object.keys(phaseCounts).length),
            borderWidth: 1,
            borderColor: '#fff'
        }]
    };
    const phaseConfig = {
        type: 'doughnut',
        data: phaseData,
        options: { 
            responsive: true, 
            maintainAspectRatio: false, 
            plugins: { 
                legend: { 
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        usePointStyle: true,
                        pointStyle: 'circle'
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.raw || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = Math.round((value / total) * 100);
                            return `${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            },
            cutout: '60%'
        }
    };
    createOrUpdateChart('phaseDistributionChart', 'doughnut', phaseConfig);

    // 4. Status Distribution Chart
    const statusCounts = {};
    trialSummaries.forEach(summary => {
        const status = summary.status || 'UNKNOWN';
        statusCounts[status] = (statusCounts[status] || 0) + 1;
    });
    const statusColors = Object.keys(statusCounts).map(status => getStatusBadgeColor(status));
    const statusData = {
        labels: Object.keys(statusCounts),
        datasets: [{
            label: 'Number of Trials',
            data: Object.values(statusCounts),
            backgroundColor: statusColors,
            borderWidth: 1,
            borderColor: '#fff'
        }]
    };
    const statusConfig = {
        type: 'doughnut',
        data: statusData,
        options: { 
            responsive: true, 
            maintainAspectRatio: false, 
            plugins: { 
                legend: { 
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        usePointStyle: true,
                        pointStyle: 'circle'
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.raw || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = Math.round((value / total) * 100);
                            return `${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            },
            cutout: '60%'
        }
    };
    createOrUpdateChart('statusDistributionChart', 'doughnut', statusConfig);

    // 5. Effect Size Chart
    const effectSizes = trialSummaries.filter(summary => summary.effectSize !== null);
    effectSizes.sort((a, b) => b.effectSize - a.effectSize);
    const topEffectSizes = effectSizes.slice(0, 10); // Show top 10 for better readability
    
    const effectSizeData = {
        labels: topEffectSizes.map(summary => summary.nctId),
        datasets: [{
            label: 'Effect Size (Cohen\'s d)',
            data: topEffectSizes.map(summary => summary.effectSize),
            backgroundColor: function(context) {
                const value = context.raw;
                if (value >= 0.8) return 'rgba(16, 185, 129, 0.8)'; // Large effect
                if (value >= 0.5) return 'rgba(59, 130, 246, 0.8)'; // Medium effect
                return 'rgba(249, 115, 22, 0.8)'; // Small effect
            },
            borderColor: 'rgba(255, 255, 255, 0.5)',
            borderWidth: 1,
            borderRadius: 4,
            maxBarThickness: 35
        }]
    };
    const effectSizeConfig = {
        type: 'bar',
        data: effectSizeData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            scales: { 
                x: { 
                    beginAtZero: true, 
                    title: { 
                        display: true, 
                        text: 'Effect Size (Cohen\'s d)',
                        font: { weight: 'bold' }
                    },
                    grid: { color: 'rgba(0, 0, 0, 0.05)' }
                }
            },
            plugins: { 
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        title: function(tooltipItems) {
                            const index = tooltipItems[0].dataIndex;
                            return topEffectSizes[index].title;
                        },
                        label: function(context) {
                            const value = context.raw;
                            return `Effect Size: ${value.toFixed(2)} (${getEffectSizeDescription(value)})`;
                        }
                    }
                }
            }
        }
    };
    createOrUpdateChart('effectSizeChart', 'bar', effectSizeConfig);

    document.getElementById('effect-size-desc').textContent = effectSizes.length > 0 
        ? `Average effect size: ${trialSummaries.avgEffectSize.toFixed(2)} (${getEffectSizeDescription(trialSummaries.avgEffectSize)})`
        : 'No effect size data available.';
        
    // 6. Response & Remission Chart
    const responseData = {
        labels: ['Response Rate', 'Remission Rate'],
        datasets: [{
            label: 'Average Difference (%)',
            data: [
                trialSummaries.avgResponseDiff !== null ? trialSummaries.avgResponseDiff : 0,
                trialSummaries.avgRemissionDiff !== null ? trialSummaries.avgRemissionDiff : 0
            ],
            backgroundColor: [COLORS.experimental.primary, COLORS.control.primary],
            borderColor: 'rgba(255, 255, 255, 0.5)',
            borderWidth: 1,
            borderRadius: 4
        }]
    };
    const responseConfig = {
        type: 'bar',
        data: responseData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { 
                y: { 
                    title: { 
                        display: true, 
                        text: 'Average Difference (%)',
                        font: { weight: 'bold' }
                    },
                    grid: { color: 'rgba(0, 0, 0, 0.05)' }
                }
            },
            plugins: { 
                legend: { display: false },
                title: {
                    display: true,
                    text: 'Treatment vs Control Difference',
                    font: { weight: 'bold' }
                }
            }
        }
    };
    createOrUpdateChart('responseRemissionChart', 'bar', responseConfig);
}
    function generateSummaryConclusions(trialSummaries) {
        const conclusionsList = document.getElementById('conclusions-list');
        if (!conclusionsList) return;
        
        conclusionsList.innerHTML = '';

        const conclusions = [];
        
        // Add conclusion items with icons
        const addConclusion = (text, icon, color = 'blue') => {
            const li = document.createElement('li');
            li.className = 'flex items-start mb-3';
            li.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-${color}-500 mr-2 mt-0.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    ${icon}
                </svg>
                <span>${text}</span>
            `;
            conclusionsList.appendChild(li);
        };

        // Analysis summary
        addConclusion(
            `Analyzed ${trialSummaries.length} trials with ${trialSummaries.trialsWithOutcomes} providing detailed outcome data.`,
            '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />'
        );

        // Trial status
        const completedTrials = trialSummaries.filter(summary => summary.status === 'COMPLETED').length;
        const completionRate = ((completedTrials / trialSummaries.length) * 100).toFixed(1);
        addConclusion(
            `${completedTrials} trials were completed (${completionRate}%), ${trialSummaries.length - completedTrials} were terminated or in other states.`,
            '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />',
            completionRate >= 70 ? 'green' : completionRate >= 50 ? 'yellow' : 'red'
        );

        // Success score
        const avgSuccessScore = trialSummaries.reduce((sum, summary) => sum + summary.successScore, 0) / trialSummaries.length;
        const highSuccessTrials = trialSummaries.filter(summary => summary.successScore >= 70).length;
        const highSuccessRate = ((highSuccessTrials / trialSummaries.length) * 100).toFixed(1);
        addConclusion(
            `Average success score: ${avgSuccessScore.toFixed(1)}. ${highSuccessTrials} trials (${highSuccessRate}%) showed high success (score ≥ 70).`,
            '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />',
            avgSuccessScore >= 70 ? 'green' : avgSuccessScore >= 50 ? 'yellow' : 'gray'
        );

        // Effect size
        if (trialSummaries.avgEffectSize !== null) {
            const effectDescription = getEffectSizeDescription(trialSummaries.avgEffectSize);
            const effectColor = trialSummaries.avgEffectSize >= 0.8 ? 'green' : trialSummaries.avgEffectSize >= 0.5 ? 'blue' : 'yellow';
            addConclusion(
                `Average effect size (Cohen's d): ${trialSummaries.avgEffectSize.toFixed(2)} (${effectDescription}).`,
                '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />',
                effectColor
            );
        } else {
            addConclusion(
                'No effect size data available across trials.',
                '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />',
                'gray'
            );
        }

        // Response rate
        if (trialSummaries.avgResponseDiff !== null) {
            const responseColor = trialSummaries.avgResponseDiff >= 15 ? 'green' : trialSummaries.avgResponseDiff >= 5 ? 'blue' : 'yellow';
            addConclusion(
                `Average response rate improvement: ${trialSummaries.avgResponseDiff > 0 ? '+' : ''}${trialSummaries.avgResponseDiff.toFixed(1)}% vs. control.`,
                '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />',
                responseColor
            );
        }

        // Remission rate
        if (trialSummaries.avgRemissionDiff !== null) {
            const remissionColor = trialSummaries.avgRemissionDiff >= 15 ? 'green' : trialSummaries.avgRemissionDiff >= 5 ? 'blue' : 'yellow';
            addConclusion(
                `Average remission rate improvement: ${trialSummaries.avgRemissionDiff > 0 ? '+' : ''}${trialSummaries.avgRemissionDiff.toFixed(1)}% vs. control.`,
                '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />',
                remissionColor
            );
        }

        // Disclaimer
        const disclaimer = document.createElement('li');
        disclaimer.className = 'flex items-start mt-4';
        disclaimer.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 mr-2 mt-0.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span class="text-sm text-gray-500 italic">Note: Success scores are estimates and should be reviewed by clinical experts. All analyses are based on available data and may not reflect the complete clinical picture.</span>
        `;
        conclusionsList.appendChild(disclaimer);
    }

    function createOrUpdateChart(canvasId, type, config) {
        const canvas = document.getElementById(canvasId);
        if (!canvas) {
            console.error(`Canvas with ID "${canvasId}" not found`);
            return null;
        }
        if (chartInstances[canvasId]) {
            chartInstances[canvasId].destroy();
        }
        chartInstances[canvasId] = new Chart(canvas, config);
        return chartInstances[canvasId];
    }

    return {
        init: init,
        loadData: loadData
    };
})(); 


















// Usage with your full dataset
document.addEventListener('DOMContentLoaded', function() {
    TrialDashboard.init('trial-dashboard');

    // Your dataset with added mock outcomes for demonstration
    // const trialData = [
    //     {
    //         nctId: "NCT02196259",
    //         outcomes: [
    //             {
    //                 category: "",
    //                 controlSampleSize: 0,
    //                 controlValue: null,
    //                 effectSize: null,
    //                 experimentalSampleSize: 0,
    //                 experimentalValue: null,
    //                 measurements: [
    //                     { dispersion: null, dispersionType: null, groupId: "OG000", groupTitle: "Initial MRI", isControlGroup: false, sampleSize: 0, standardError: null, value: 0.3114 },
    //                     { dispersion: null, dispersionType: null, groupId: "OG001", groupTitle: "Depression", isControlGroup: false, sampleSize: 0, standardError: null, value: 0.3459 }
    //                 ],
    //                 timeFrame: "8 minutes scans, acquired between 1 day and 3 days (see above)",
    //                 title: "Functional Connectivity",
    //                 type: "primary"
    //             }
    //         ],
    //         phase: "NA",
    //         sponsor: "University of Michigan",
    //         status: "TERMINATED",
    //         title: "Anesthesia and Functional Connectivity: An Analysis of fMRI Changes"
    //     },
    //     {
    //         nctId: "NCT01179009",
    //         title: "Treatment Resistant Depression (Pilot)",
    //         phase: "NA",
    //         sponsor: "Washington University School of Medicine",
    //         status: "COMPLETED",
    //         outcomes: [] // No outcomes
    //     },
    //     {
    //         nctId: "NCT01627782",
    //         title: "A Study of Ketamine in Patients With Treatment-resistant Depression",
    //         phase: "PHASE2",
    //         sponsor: "Janssen Research & Development, LLC",
    //         status: "COMPLETED",
    //         outcomes: [
    //             {
    //                 title: "MADRS Score Reduction",
    //                 type: "primary",
    //                 timeFrame: "4 weeks",
    //                 measurements: [
    //                     { groupId: "OG000", groupTitle: "Ketamine", isControlGroup: false, sampleSize: 0, value: 15.2 },
    //                     { groupId: "OG001", groupTitle: "Placebo", isControlGroup: true, sampleSize: 0, value: 5.0 }
    //                 ]
    //             },
    //             {
    //                 title: "Response Rate (>= 50% Improvement)",
    //                 type: "secondary",
    //                 timeFrame: "4 weeks",
    //                 measurements: [
    //                     { groupId: "OG000", groupTitle: "Ketamine", isControlGroup: false, sampleSize: 0, value: 45 },
    //                     { groupId: "OG001", groupTitle: "Placebo", isControlGroup: true, sampleSize: 0, value: 20 }
    //                 ]
    //             },
    //             {
    //                 title: "Remission Rate (MADRS <= 10)",
    //                 type: "secondary",
    //                 timeFrame: "4 weeks",
    //                 measurements: [
    //                     { groupId: "OG000", groupTitle: "Ketamine", isControlGroup: false, sampleSize: 0, value: 30 },
    //                     { groupId: "OG001", groupTitle: "Placebo", isControlGroup: true, sampleSize: 0, value: 10 }
    //                 ]
    //             }
    //         ]
    //     },
    //     {
    //         nctId: "NCT05414422",
    //         title: "A Randomized, Placebo-Controlled, Double-Blind Study to Assess Safety and Efficacy of PCN-101 in TRD",
    //         phase: "PHASE2",
    //         sponsor: "Perception Neuroscience",
    //         status: "COMPLETED",
    //         outcomes: [
    //             {
    //                 title: "MADRS Score Reduction",
    //                 type: "primary",
    //                 timeFrame: "24 hours",
    //                 measurements: [
    //                     { groupId: "OG000", groupTitle: "PCN-101", isControlGroup: false, sampleSize: 0, value: 12.5 },
    //                     { groupId: "OG001", groupTitle: "Placebo", isControlGroup: true, sampleSize: 0, value: 4.0 }
    //                 ]
    //             }
    //         ]
    //     },
    //     // Add mock outcomes for a few more trials for demonstration
    //     {
    //         nctId: "NCT00768430",
    //         title: "Optimization of IV Ketamine for Treatment Resistant Depression",
    //         phase: "PHASE2",
    //         sponsor: "Baylor College of Medicine",
    //         status: "COMPLETED",
    //         outcomes: [
    //             {
    //                 title: "MADRS Score Reduction",
    //                 type: "primary",
    //                 timeFrame: "1 week",
    //                 measurements: [
    //                     { groupId: "OG000", groupTitle: "Ketamine", isControlGroup: false, sampleSize: 0, value: 18.0 },
    //                     { groupId: "OG001", groupTitle: "Placebo", isControlGroup: true, sampleSize: 0, value: 6.0 }
    //                 ]
    //             },
    //             {
    //                 title: "Response Rate (>= 50% Improvement)",
    //                 type: "secondary",
    //                 timeFrame: "1 week",
    //                 measurements: [
    //                     { groupId: "OG000", groupTitle: "Ketamine", isControlGroup: false, sampleSize: 0, value: 50 },
    //                     { groupId: "OG001", groupTitle: "Placebo", isControlGroup: true, sampleSize: 0, value: 15 }
    //                 ]
    //             }
    //         ]
    //     },
    //     // Remaining trials without outcomes
    //     {
    //         nctId: "NCT02360280",
    //         title: "Efficacy of Repeated Ketamine Infusions for Treatment-resistant Depression",
    //         phase: "PHASE2",
    //         sponsor: "VA Office of Research and Development",
    //         status: "COMPLETED",
    //         outcomes: []
    //     },
    //     {
    //         nctId: "NCT03756129",
    //         title: "Proof of Concept Study Evaluating the Efficacy and…1 in Patients With Treatment-resistant Depression",
    //         phase: "PHASE2",
    //         sponsor: "Novartis",
    //         status: "COMPLETED",
    //         outcomes: []
    //     },
    //     {
    //         nctId: "NCT01998958",
    //         title: "A Study to Evaluate the Safety and Efficacy of Int…asal Esketamine in Treatment-resistant Depression",
    //         phase: "PHASE2",
    //         sponsor: "Janssen Research & Development, LLC",
    //         status: "COMPLETED",
    //         outcomes: []
    //     },
    //     {
    //         nctId: "NCT03113968",
    //         title: "ELEKT-D: Electroconvulsive Therapy (ECT) vs. Ketam…atients With Treatment Resistant Depression (TRD)",
    //         phase: "PHASE2",
    //         sponsor: "The Cleveland Clinic",
    //         status: "COMPLETED",
    //         outcomes: []
    //     },
    //     {
    //         nctId: "NCT02935595",
    //         title: "Low Dose Intravenous Ketamine in Treatment Resistant Depression Patients",
    //         phase: "PHASE2",
    //         sponsor: "The University of Texas Health Science Center, Houston",
    //         status: "COMPLETED",
    //         outcomes: []
    //     },
    //     {
    //         nctId: "NCT02078817",
    //         title: "Ketamine in Adolescents With Treatment-Resistant Depression",
    //         phase: "PHASE2",
    //         sponsor: "University of Minnesota",
    //         status: "COMPLETED",
    //         outcomes: []
    //     },
    //     {
    //         nctId: "NCT02918318",
    //         title: "A Study to Evaluate the Efficacy, Safety and Toler… Participants With Treatment Resistant Depression",
    //         phase: "PHASE2",
    //         sponsor: "Janssen Pharmaceutical K.K.",
    //         status: "COMPLETED",
    //         outcomes: []
    //     },
    //     {
    //         nctId: "NCT01920555",
    //         title: "Double-Blind, Placebo-Controlled Trial of Ketamine Therapy in Treatment-Resistant Depression (TRD)",
    //         phase: "PHASE2",
    //         sponsor: "Massachusetts General Hospital",
    //         status: "COMPLETED",
    //         outcomes: []
    //     },
    //     {
    //         nctId: "NCT02422186",
    //         title: "A Study to Evaluate the Efficacy, Safety, and Tole… Participants With Treatment-resistant Depression",
    //         phase: "PHASE3",
    //         sponsor: "Janssen Research & Development, LLC",
    //         status: "COMPLETED",
    //         outcomes: []
    //     },
    //     {
    //         nctId: "NCT02493868",
    //         title: "A Study of Intranasal Esketamine Plus an Oral Anti… Participants With Treatment-resistant Depression",
    //         phase: "PHASE3",
    //         sponsor: "Janssen Research & Development, LLC",
    //         status: "COMPLETED",
    //         outcomes: []
    //     },
    //     {
    //         nctId: "NCT02782104",
    //         title: "A Long-term Safety Study of Esketamine Nasal Spray in Treatment-resistant Depression",
    //         phase: "PHASE3",
    //         sponsor: "Janssen Research & Development, LLC",
    //         status: "COMPLETED",
    //         outcomes: []
    //     },
    //     {
    //         nctId: "NCT03434041",
    //         title: "A Study to Evaluate the Efficacy, Pharmacokinetics… Participants With Treatment-resistant Depression",
    //         phase: "PHASE3",
    //         sponsor: "Janssen Research & Development, LLC",
    //         status: "COMPLETED",
    //         outcomes: []
    //     },
    //     {
    //         nctId: "NCT02556606",
    //         title: "Ketamine for Treatment Resistant Late-Life Depression",
    //         phase: "PHASE3",
    //         sponsor: "VA Office of Research and Development",
    //         status: "COMPLETED",
    //         outcomes: []
    //     },
    //     {
    //         nctId: "NCT04338321",
    //         title: "A Long-term Comparison of Esketamine Nasal Spray V…ith Treatment Resistant Major Depressive Disorder",
    //         phase: "PHASE3",
    //         sponsor: "Janssen-Cilag International NV",
    //         status: "COMPLETED",
    //         outcomes: []
    //     },
    //     {
    //         nctId: "NCT02417064",
    //         title: "A Study to Evaluate the Efficacy, Safety, and Tole… Participants With Treatment-resistant Depression",
    //         phase: "PHASE3",
    //         sponsor: "Janssen Research & Development, LLC",
    //         status: "COMPLETED",
    //         outcomes: []
    //     },
    //     {
    //         nctId: "NCT02418585",
    //         title: "A Study to Evaluate the Efficacy, Safety, and Tole… Participants With Treatment-resistant Depression",
    //         phase: "PHASE3",
    //         sponsor: "Janssen Research & Development, LLC",
    //         status: "COMPLETED",
    //         outcomes: []
    //     },
    //     {
    //         nctId: "NCT03149991",
    //         title: "A Study of Brexpiprazole Plus Ketamine in Treatment-Resistant Depression (TRD)",
    //         phase: "PHASE4",
    //         sponsor: "Massachusetts General Hospital",
    //         status: "COMPLETED",
    //         outcomes: []
    //     },
    //     {
    //         nctId: "NCT04599855",
    //         title: "A Study of Esketamine Nasal Spray, Administered as… Participants With Treatment-resistant Depression",
    //         phase: "PHASE4",
    //         sponsor: "Janssen Research & Development, LLC",
    //         status: "COMPLETED",
    //         outcomes: []
    //     }
    // ];

    // TrialDashboard.loadData(trialData);
});

  document.addEventListener('DOMContentLoaded', () => {
    const trialSelect = document.getElementById('trial-selection');
    const visualizeBtn = document.getElementById('visualize-btn');
    const loadingIndicator = document.getElementById('loading-indicator');
    const visualizationContainer = document.getElementById('visualization-container');
    

    
    // Event listener for visualize button
    visualizeBtn.addEventListener('click', async () => {

      // Show loading indicator
      loadingIndicator.style.display = 'block';
      visualizationContainer.innerHTML = '';
      
      try {
        // Call backend to fetch trial data and generate visualization
        const result = await generateTrialVisualization();
        console.log(result)
        
        // Insert the generated HTML into the container
        let htmlContent = result.html;
    
    // Remove the outer quotes if they exist
    if (htmlContent.startsWith('"') && htmlContent.endsWith('"')) {
      htmlContent = htmlContent.slice(1, -1);
    }
    
    // Replace escaped newlines and quotes
    htmlContent = htmlContent.replace(/\\n/g, '\n').replace(/\\"/g, '"');
    
    // Extract script content
    const scriptTagMatch = htmlContent.match(/<script>([\s\S]*?)<\/script>/);
    let scriptContent = '';
    
    if (scriptTagMatch && scriptTagMatch[1]) {
      scriptContent = scriptTagMatch[1];
      // Remove the script tag from the HTML so we can add it properly
      htmlContent = htmlContent.replace(/<script>[\s\S]*?<\/script>/, '');
    }
    
    // Insert the HTML
    visualizationContainer.innerHTML = htmlContent;
    
    // Create and execute the script
    if (scriptContent) {
      const script = document.createElement('script');
      script.textContent = scriptContent;
      document.body.appendChild(script);
    }
    
    // If there's separate JavaScript returned as well, execute it too
    if (result.javascript) {
      const script = document.createElement('script');
      script.textContent = result.javascript;
      document.body.appendChild(script);
    }
    
  } catch (error) {
    console.error('Error generating visualization:', error);
    visualizationContainer.innerHTML = `
      <div class="p-4 bg-red-100 text-red-700 rounded">
        Error generating visualization: ${error.message}
      </div>
    `;
  } finally {
    // Hide loading indicator
    loadingIndicator.style.display = 'none';
  }
})
})

  // Function to call the backend
  async function generateTrialVisualization() {
    console.log( appState.allTrialOutcomes)
    a =  appState.allTrialOutcomes
    
    const response = await fetch('https://sunday-fsfq.onrender.com/api/generate-visualization', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({  
        trialData: a 
    })
    });
    
    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.message || 'Failed to generate visualization');
    }
    
    return await response.json();
  }

// EMA Data Module
const EmaDataModule = (function() {
  // DOM elements
  const elements = {
  section: document.getElementById('emaDataSection'),
  lastUpdated: document.getElementById('emaDataLastUpdated'),
  refreshBtn: document.getElementById('refreshEmaDataBtn'),
  approvalCount: document.getElementById('emaApprovalCount'),
  orphanCount: document.getElementById('emaOrphanCount'),
  safetyCount: document.getElementById('emaSafetyCount'),
  psusaCount: document.getElementById('emaPsusaCount'),
  shortagesCount: document.getElementById('emaShortagesCount'),
  referralsCount: document.getElementById('emaReferralsCount'),
  approvalData: document.getElementById('emaApprovalData'),
  orphanData: document.getElementById('emaOrphanData'),
  safetyData: document.getElementById('emaSafetyData'),
  psusaData: document.getElementById('emaPsusaData'),
  shortagesData: document.getElementById('emaShortagesData'),
  referralsData: document.getElementById('emaReferralsData'),
  uploadStatus: document.getElementById('uploadStatus'),
  // Form elements
  dhpcUploadForm: document.getElementById('dhpcUploadForm'),
  psusaUploadForm: document.getElementById('psusaUploadForm'),
  shortagesUploadForm: document.getElementById('shortagesUploadForm'),
  medicinesUploadForm: document.getElementById('medicinesUploadForm'),
  referralsUploadForm: document.getElementById('referralsUploadForm'),
  // File inputs
  dhpcFileInput: document.getElementById('dhpcFileInput'),
  psusaFileInput: document.getElementById('psusaFileInput'),
  shortagesFileInput: document.getElementById('shortagesFileInput'),
  medicinesFileInput: document.getElementById('medicinesFileInput'),
  referralsFileInput: document.getElementById('referralsFileInput'),
  dataAdmin: document.getElementById('emaDataAdmin')
};

  // Initialize the module
  function init() {
    // Initialize tab navigation
    initTabNavigation();
    
    // Initialize file upload forms
    initFileUploadForms();
    
    // Add refresh button event listener
    if (elements.refreshBtn) {
      elements.refreshBtn.addEventListener('click', refreshEmaData);
    }
    
    // Check data status on initialization
    checkEmaDataStatus();
    
    // Hide admin section by default (can be shown based on user role)
    toggleAdminSection(false);
    
    console.log('EMA Data Module initialized');
  }

  // Initialize tab navigation
  function initTabNavigation() {
    const tabButtons = document.querySelectorAll('.ema-tab-button');
    
    tabButtons.forEach(button => {
      button.addEventListener('click', function() {
        const tabId = this.getAttribute('data-tab');
        
        // Hide all tab panes
        document.querySelectorAll('.ema-tab-pane').forEach(pane => {
          pane.classList.add('hidden');
          pane.classList.remove('active');
        });
        
        // Deactivate all tab buttons
        tabButtons.forEach(btn => {
          btn.classList.remove('border-blue-500', 'text-blue-600');
          btn.classList.add('border-transparent', 'hover:text-gray-600', 'hover:border-gray-300');
          btn.setAttribute('aria-selected', 'false');
        });
        
        // Activate the clicked tab
        document.getElementById(tabId).classList.remove('hidden');
        document.getElementById(tabId).classList.add('active');
        
        // Activate the clicked tab button
        this.classList.remove('border-transparent', 'hover:text-gray-600', 'hover:border-gray-300');
        this.classList.add('border-blue-500', 'text-blue-600');
        this.setAttribute('aria-selected', 'true');
      });
    });
  }

  // Initialize file upload forms
  function initFileUploadForms() {
  // DHPC Upload Form
  if (elements.dhpcUploadForm) {
    elements.dhpcUploadForm.addEventListener('submit', function(e) {
      e.preventDefault();
      uploadFile('dhpc', elements.dhpcFileInput.files[0]);
    });
  }
  
  // PSUSA Upload Form
  if (elements.psusaUploadForm) {
    elements.psusaUploadForm.addEventListener('submit', function(e) {
      e.preventDefault();
      uploadFile('psusa', elements.psusaFileInput.files[0]);
    });
  }
  
  // Shortages Upload Form
  if (elements.shortagesUploadForm) {
    elements.shortagesUploadForm.addEventListener('submit', function(e) {
      e.preventDefault();
      uploadFile('shortages', elements.shortagesFileInput.files[0]);
    });
  }
  
  // Medicines Upload Form
  if (elements.medicinesUploadForm) {
    elements.medicinesUploadForm.addEventListener('submit', function(e) {
      e.preventDefault();
      uploadFile('medicines', elements.medicinesFileInput.files[0]);
    });
  }
  
  // Referrals Upload Form
  if (elements.referralsUploadForm) {
    elements.referralsUploadForm.addEventListener('submit', function(e) {
      e.preventDefault();
      uploadFile('referrals', elements.referralsFileInput.files[0]);
    });
  }
}

  // Show the EMA data section
  function showSection(show = true) {
    if (elements.section) {
      elements.section.classList.toggle('hidden', !show);
    }
  }

  // Toggle admin section visibility
  function toggleAdminSection(show = false) {
    if (elements.dataAdmin) {
      elements.dataAdmin.classList.toggle('hidden', !show);
    }
  }

  // Check EMA data status
  async function checkEmaDataStatus() {
    try {
      showLoadingState(elements.lastUpdated, true);
      
      const response = await fetch('/api/ema/status');
      const data = await response.json();
      
      if (response.ok) {
        updateLastUpdated(data.status);
      } else {
        showError('Error checking EMA data status');
        console.error('Error checking EMA data status:', data.error);
      }
      
      showLoadingState(elements.lastUpdated, false);
    } catch (error) {
      showError('Error connecting to server');
      console.error('Error checking EMA data status:', error);
      showLoadingState(elements.lastUpdated, false);
    }
  }

  // Update last updated timestamp
  function updateLastUpdated(statusData) {
    if (!elements.lastUpdated) return;
    
    let lastUpdateDate = null;
    
    // Find the most recent update across all data types
    for (const dataType in statusData) {
      if (statusData[dataType].available && statusData[dataType].lastUpdated) {
        const updateDate = new Date(statusData[dataType].lastUpdated);
        if (!lastUpdateDate || updateDate > lastUpdateDate) {
          lastUpdateDate = updateDate;
        }
      }
    }
    
    if (lastUpdateDate) {
      elements.lastUpdated.textContent = `Last updated: ${formatDate(lastUpdateDate)}`;
    } else {
      elements.lastUpdated.textContent = 'Data not yet available';
    }
  }

  // Refresh EMA data
  async function refreshEmaData() {
    try {
      if (!elements.refreshBtn) return;
      
      // Disable refresh button and show loading state
      elements.refreshBtn.disabled = true;
      elements.refreshBtn.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" class="animate-spin h-4 w-4 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
        </svg>
        Refreshing...
      `;
      
      const response = await fetch('/api/ema/refresh', { method: 'POST' });
      const data = await response.json();
      
      if (response.ok) {
        updateLastUpdated(data.status);
        showToast('EMA data refreshed successfully', 'success');
      } else {
        showError('Error refreshing EMA data');
        console.error('Error refreshing EMA data:', data.error);
      }
      
      // Re-enable refresh button
      elements.refreshBtn.disabled = false;
      elements.refreshBtn.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
        </svg>
        Refresh
      `;
    } catch (error) {
      showError('Error connecting to server');
      console.error('Error refreshing EMA data:', error);
      
      // Re-enable refresh button
      if (elements.refreshBtn) {
        elements.refreshBtn.disabled = false;
        elements.refreshBtn.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
          </svg>
          Refresh
        `;
      }
    }
  }

  // Search EMA data for a specific drug
  async function searchDrug(drugName) {
    if (!drugName) return;
    
    try {
      // Show loading state for all data containers
      showLoadingState(elements.approvalData);
      showLoadingState(elements.orphanData);
      showLoadingState(elements.safetyData);
      showLoadingState(elements.psusaData);
      showLoadingState(elements.shortagesData);
      
      // Show the EMA section
      showSection(true);

      console.log("fetching ema data")
      const response = await fetch(`/api/ema/drug/${encodeURIComponent(drugName)}`);
      const data = await response.json();
      
      if (response.ok) {
        console.log(data)
        displayEmaData(data);
      } else {
        showError(`No EMA data found for ${drugName}`);
        console.error('Error searching EMA data:', data.error);
        
        // Show empty state for all data containers
        showEmptyState(elements.approvalData, 'No EMA approval data found for this drug.');
        showEmptyState(elements.orphanData, 'No orphan designation data found for this drug.');
        showEmptyState(elements.safetyData, 'No safety communication data found for this drug.');
        showEmptyState(elements.psusaData, 'No PSUSA data found for this drug.');
        showEmptyState(elements.shortagesData, 'No shortage data found for this drug.');
      }
    } catch (error) {
      showError('Error connecting to server');
      console.error('Error searching EMA data:', error);
      
      // Show empty state for all data containers
      showEmptyState(elements.approvalData, 'Error loading EMA approval data.');
      showEmptyState(elements.orphanData, 'Error loading orphan designation data.');
      showEmptyState(elements.safetyData, 'Error loading safety communication data.');
      showEmptyState(elements.psusaData, 'Error loading PSUSA data.');
      showEmptyState(elements.shortagesData, 'Error loading shortages data.');
    }
  }

  // Display EMA data in the UI
// Update the display functions in the EMA Data Module to handle the raw CSV data structure

// Display approval data
function displayApprovalData(data) {
  if (!elements.approvalData) return;
  
  // Filter out veterinary products
  const filteredData = data.filter(item => {
    return !item._0 || item._0.toLowerCase() !== 'veterinary';
  });
  
  if (filteredData.length === 0) {
    showEmptyState(elements.approvalData, 'No human medicine approval data found for this drug.');
    return;
  }
  
  let html = `
    <div class="overflow-x-auto">
      <table class="ema-data-table">
        <thead>
          <tr>
            <th>Medicine Name</th>
            <th>Status</th>
            <th>Active Substance</th>
            <th>Therapeutic Area</th>
            <th>Authorization Date</th>
            <th>Details</th>
          </tr>
        </thead>
        <tbody>
  `;
  
  filteredData.forEach(item => {
    // Extract relevant fields based on the raw data structure
    const medicineName = item._1 || 'Unknown';
    const status = item._3 || 'Unknown';
    const substance = item._6 || item._7 || 'Not specified';
    const therapeuticArea = item._8 || item._13 || 'Not specified';
    const authDate = item._29 || item._31 || item._36 || 'Unknown';
    const indication = item._15 || '';
    const emaLink = item._38 || '';
    
    // Determine status badge class
    let statusClass = 'bg-gray-100 text-gray-800';
    if (status.toLowerCase().includes('authorised') || status.toLowerCase().includes('authorized')) {
      statusClass = 'bg-green-100 text-green-800';
    } else if (status.toLowerCase().includes('refused')) {
      statusClass = 'bg-red-100 text-red-800';
    } else if (status.toLowerCase().includes('withdrawn')) {
      statusClass = 'bg-gray-100 text-gray-800';
    } else if (status.toLowerCase().includes('pending')) {
      statusClass = 'bg-yellow-100 text-yellow-800';
    }
    
    html += `
      <tr>
        <td>
          <div class="font-medium">${medicineName}</div>
          ${item._2 ? `<div class="text-xs text-gray-500">Procedure: ${item._2}</div>` : ''}
        </td>
        <td>
          <span class="px-2 py-1 rounded-full text-xs font-medium ${statusClass}">
            ${status}
          </span>
        </td>
        <td>${substance}</td>
        <td>${formatTherapeuticArea(therapeuticArea)}</td>
        <td>${formatDate(authDate)}</td>
        <td>
          ${emaLink ? `<a href="${emaLink}" target="_blank" class="text-blue-600 hover:underline">EMA Page</a>` : 'N/A'}
          ${indication ? `<div class="text-xs text-gray-600 mt-1">Indication: ${indication}</div>` : ''}
        </td>
      </tr>
    `;
  });
  
  html += `
        </tbody>
      </table>
    </div>
  `;
  
  elements.approvalData.innerHTML = html;
}

// Display orphan designation data
function displayOrphanData(data) {
  if (!elements.orphanData) return;
  
  // Filter out veterinary products
  const filteredData = data.filter(item => {
    return !item._0 || item._0.toLowerCase() !== 'veterinary';
  });
  
  if (filteredData.length === 0) {
    showEmptyState(elements.orphanData, 'No orphan designation data found for this drug.');
    return;
  }
  
  let html = `
    <div class="overflow-x-auto">
      <table class="ema-data-table">
        <thead>
          <tr>
            <th>Medicine Name</th>
            <th>Condition</th>
            <th>Status</th>
            <th>Decision Date</th>
            <th>Details</th>
          </tr>
        </thead>
        <tbody>
  `;
  
  filteredData.forEach(item => {
    // Find fields based on your CSV structure
    const medicineName = item['Orphan designation'] || item._1 || 'Unknown';
    const condition = findFieldInItem(item, ['condition', '_2', '_3']) || 'Not specified';
    const status = findFieldInItem(item, ['status', '_4', '_5']) || 'Unknown';
    const decisionDate = findFieldInItem(item, ['date', '_6', '_7']) || 'Unknown';
    const sponsor = findFieldInItem(item, ['sponsor', '_8', '_9']) || '';
    const emaLink = findFieldInItem(item, ['_20', '_21', '_22']) || '';
    
    // Determine status badge class
    let statusClass = 'bg-gray-100 text-gray-800';
    if (status.toLowerCase().includes('positive')) {
      statusClass = 'bg-green-100 text-green-800';
    } else if (status.toLowerCase().includes('negative')) {
      statusClass = 'bg-red-100 text-red-800';
    } else if (status.toLowerCase().includes('withdrawn')) {
      statusClass = 'bg-gray-100 text-gray-800';
    }
    
    html += `
      <tr>
        <td>
          <div class="font-medium">${medicineName}</div>
          ${sponsor ? `<div class="text-xs text-gray-500">Sponsor: ${sponsor}</div>` : ''}
        </td>
        <td>${condition}</td>
        <td>
          <span class="px-2 py-1 rounded-full text-xs font-medium ${statusClass}">
            ${status}
          </span>
        </td>
        <td>${formatDate(decisionDate)}</td>
        <td>
          ${emaLink ? `<a href="${emaLink}" target="_blank" class="text-blue-600 hover:underline">EMA Page</a>` : 'N/A'}
        </td>
      </tr>
    `;
  });
  
  html += `
        </tbody>
      </table>
    </div>
  `;
  
  elements.orphanData.innerHTML = html;
}

// Display safety communication data
function displaySafetyData(data) {
  if (!elements.safetyData) return;
  
  // Filter out veterinary products
  const filteredData = data.filter(item => {
    return !item._0 || item._0.toLowerCase() !== 'veterinary';
  });
  
  if (filteredData.length === 0) {
    showEmptyState(elements.safetyData, 'No safety communication data found for this drug.');
    return;
  }
  
  let html = `
    <div class="overflow-x-auto">
      <table class="ema-data-table">
        <thead>
          <tr>
            <th>Title</th>
            <th>Medicine</th>
            <th>Date</th>
            <th>Details</th>
          </tr>
        </thead>
        <tbody>
  `;
  
  filteredData.forEach(item => {
    // Find fields based on your CSV structure
    const title = item['Direct healthcare professional communication (DHPC)'] || 
                  findFieldInItem(item, ['_1', '_2']) || 'Unknown';
    const medicine = findFieldInItem(item, ['medicine', '_3', '_4']) || 'Not specified';
    const date = findFieldInItem(item, ['date', '_5', '_6']) || 'Unknown';
    const reason = findFieldInItem(item, ['reason', '_7', '_8']) || '';
    const emaLink = findFieldInItem(item, ['_15', '_16', '_17']) || '';
    
    html += `
      <tr>
        <td>
          <div class="font-medium">${title}</div>
        </td>
        <td>${medicine}</td>
        <td>${formatDate(date)}</td>
        <td>
          ${reason ? `<div class="text-xs text-gray-600 mb-1">Reason: ${reason}</div>` : ''}
          ${emaLink ? `<a href="${emaLink}" target="_blank" class="text-blue-600 hover:underline">EMA Page</a>` : 'N/A'}
        </td>
      </tr>
    `;
  });
  
  html += `
        </tbody>
      </table>
    </div>
  `;
  
  elements.safetyData.innerHTML = html;
}

// Display PSUSA data
function displayPsusaData(data) {
  if (!elements.psusaData) return;
  
  // Filter out veterinary products
  const filteredData = data.filter(item => {
    return !item._0 || item._0.toLowerCase() !== 'veterinary';
  });
  
  if (filteredData.length === 0) {
    showEmptyState(elements.psusaData, 'No PSUSA data found for this drug.');
    return;
  }
  
  let html = `
    <div class="overflow-x-auto">
      <table class="ema-data-table">
        <thead>
          <tr>
            <th>Substance</th>
            <th>Procedure</th>
            <th>Outcome</th>
            <th>Date</th>
            <th>Details</th>
          </tr>
        </thead>
        <tbody>
  `;
  
  filteredData.forEach(item => {
    // Find fields based on your CSV structure
    const substance = item['Periodic safety update report single assessments (PSUSA)'] || 
                     item._1 || 
                     item._2 || 'Unknown';
    const procedure = item._4 || 'Not specified';
    const outcome = item._5 || 'Unknown';
    const date = item._6 || 'Unknown';
    const emaLink = item._8 || '';
    
    // Determine outcome badge class
    let outcomeClass = 'bg-gray-100 text-gray-800';
    if (outcome.toLowerCase().includes('variation')) {
      outcomeClass = 'bg-yellow-100 text-yellow-800';
    } else if (outcome.toLowerCase().includes('maintenance')) {
      outcomeClass = 'bg-green-100 text-green-800';
    }
    
    html += `
      <tr>
        <td>
          <div class="font-medium">${substance}</div>
        </td>
        <td>${procedure}</td>
        <td>
          <span class="px-2 py-1 rounded-full text-xs font-medium ${outcomeClass}">
            ${outcome}
          </span>
        </td>
        <td>${formatDate(date)}</td>
        <td>
          ${emaLink ? `<a href="${emaLink}" target="_blank" class="text-blue-600 hover:underline">EMA Page</a>` : 'N/A'}
        </td>
      </tr>
    `;
  });
  
  html += `
        </tbody>
      </table>
    </div>
  `;
  
  elements.psusaData.innerHTML = html;
}

// Display Referrals data
function displayReferralsData(data) {
  if (!elements.referralsData) return;
  
  // Filter out veterinary products
  const filteredData = data.filter(item => {
    return !item._0 || item._0.toLowerCase() !== 'veterinary';
  });
  
  if (filteredData.length === 0) {
    showEmptyState(elements.referralsData, 'No referral data found for this drug.');
    return;
  }
  
  let html = `
    <div class="overflow-x-auto">
      <table class="ema-data-table">
        <thead>
          <tr>
            <th>Medicine</th>
            <th>Substance</th>
            <th>Status</th>
            <th>Date</th>
            <th>Details</th>
          </tr>
        </thead>
        <tbody>
  `;
  
  filteredData.forEach(item => {
    // Find fields based on your CSV structure
    const medicine = item._1 || 'Unknown';
    const substance = item._2 || 'Not specified';
    const status = item._3 || 'Unknown';
    const procedure = item._9 || '';
    const date = findFieldInItem(item, ['_17', '_18', '_19']) || 'Unknown';
    const emaLink = item._21 || '';
    
    // Determine status badge class
    let statusClass = 'bg-gray-100 text-gray-800';
    if (status.toLowerCase().includes('final') || status.toLowerCase().includes('concluded')) {
      statusClass = 'bg-green-100 text-green-800';
    } else if (status.toLowerCase().includes('ongoing')) {
      statusClass = 'bg-yellow-100 text-yellow-800';
    }
    
    html += `
      <tr>
        <td>
          <div class="font-medium">${medicine}</div>
        </td>
        <td>${substance}</td>
        <td>
          <span class="px-2 py-1 rounded-full text-xs font-medium ${statusClass}">
            ${status}
          </span>
        </td>
        <td>${formatDate(date)}</td>
        <td>
          ${procedure ? `<div class="text-xs text-gray-600 mb-1">Procedure: ${procedure}</div>` : ''}
          ${emaLink ? `<a href="${emaLink}" target="_blank" class="text-blue-600 hover:underline">EMA Page</a>` : 'N/A'}
        </td>
      </tr>
    `;
  });
  
  html += `
        </tbody>
      </table>
    </div>
  `;
  
  elements.referralsData.innerHTML = html;
}

// Display Shortages data
function displayShortagesData(data) {
  if (!elements.shortagesData) return;
  
  // Filter out veterinary products
  const filteredData = data.filter(item => {
    return !item._0 || item._0.toLowerCase() !== 'veterinary';
  });
  
  if (filteredData.length === 0) {
    showEmptyState(elements.shortagesData, 'No shortage data found for this drug.');
    return;
  }
  
  let html = `
    <div class="overflow-x-auto">
      <table class="ema-data-table">
        <thead>
          <tr>
            <th>Medicine</th>
            <th>Reason</th>
            <th>Status</th>
            <th>Date</th>
            <th>Details</th>
          </tr>
        </thead>
        <tbody>
  `;
  
  filteredData.forEach(item => {
    // Find fields based on your CSV structure
    const medicine = item.Shortage || item._1 || 'Unknown';
    const reason = findFieldInItem(item, ['reason', '_4', '_5']) || 'Not specified';
    const status = findFieldInItem(item, ['status', '_6', '_7']) || 'Unknown';
    const date = findFieldInItem(item, ['date', '_8', '_9']) || 'Unknown';
    const emaLink = findFieldInItem(item, ['_13', '_14', '_15']) || '';
    
    // Determine status badge class
    let statusClass = 'bg-gray-100 text-gray-800';
    if (status.toLowerCase().includes('ongoing')) {
      statusClass = 'bg-red-100 text-red-800';
    } else if (status.toLowerCase().includes('resolved')) {
      statusClass = 'bg-green-100 text-green-800';
    } else if (status.toLowerCase().includes('expected')) {
      statusClass = 'bg-yellow-100 text-yellow-800';
    }
    
    html += `
      <tr>
        <td>
          <div class="font-medium">${medicine}</div>
        </td>
        <td>${reason}</td>
        <td>
          <span class="px-2 py-1 rounded-full text-xs font-medium ${statusClass}">
            ${status}
          </span>
        </td>
        <td>${formatDate(date)}</td>
        <td>
          ${emaLink ? `<a href="${emaLink}" target="_blank" class="text-blue-600 hover:underline">EMA Page</a>` : 'N/A'}
        </td>
      </tr>
    `;
  });
  
  html += `
        </tbody>
      </table>
    </div>
  `;
  
  elements.shortagesData.innerHTML = html;
}

// Helper function to find field in an item with numeric keys (_0, _1, etc.)
function findFieldInItem(item, possibleKeys) {
  // First try the exact keys
  for (const key of possibleKeys) {
    if (item[key] !== undefined && item[key] !== null && item[key] !== '') {
      return item[key];
    }
  }
  
  // If not found, try all numeric keys
  for (let i = 0; i < 40; i++) {
    const key = `_${i}`;
    if (item[key] !== undefined && item[key] !== null && item[key] !== '') {
      // Try to determine if this is the field we're looking for
      // This is a simplistic approach and might need refinement
      const value = item[key].toString().toLowerCase();
      
      // Check if this might be a date
      if (possibleKeys.includes('date') && (value.includes('/') || value.match(/\d{2}\.\d{2}\.\d{4}/))) {
        return item[key];
      }
      
      // Check if this might be a status
      if (possibleKeys.includes('status') && 
          (value.includes('authorised') || value.includes('withdrawn') || 
           value.includes('ongoing') || value.includes('resolved'))) {
        return item[key];
      }
      
      // Check if this might be a reason
      if (possibleKeys.includes('reason') && 
          value.length > 10 && (value.includes('due to') || value.includes('because'))) {
        return item[key];
      }
    }
  }
  
  return null;
}

// Update display EMA data to include referrals
function displayEmaData(data) {
  const { results, total } = data;
  
  // Filter out veterinary products
  Object.keys(results).forEach(key => {
    if (Array.isArray(results[key])) {
      results[key] = results[key].filter(item => !item._0 || item._0.toLowerCase() !== 'veterinary');
      // Update totals after filtering
      total[key] = results[key].length;
    }
  });
  
  // Update counters
  updateCounter(elements.approvalCount, total.medicines, 'approval', 'approvals');
  updateCounter(elements.orphanCount, total.orphans, 'designation', 'designations');
  updateCounter(elements.safetyCount, total.dhpc, 'communication', 'communications');
  updateCounter(elements.psusaCount, total.psusa, 'report', 'reports');
  updateCounter(elements.shortagesCount, total.shortages, 'shortage', 'shortages');
  updateCounter(elements.referralsCount, total.referrals, 'referral', 'referrals');
  
  // Display approval data
  if (results.medicines && results.medicines.length > 0) {
    displayApprovalData(results.medicines);
  } else {
    showEmptyState(elements.approvalData, 'No EMA approval data found for this drug.');
  }
  
  // Display orphan designation data
  if (results.orphans && results.orphans.length > 0) {
    displayOrphanData(results.orphans);
  } else {
    showEmptyState(elements.orphanData, 'No orphan designation data found for this drug.');
  }
  
  // Display safety communication data
  if (results.dhpc && results.dhpc.length > 0) {
    displaySafetyData(results.dhpc);
  } else {
    showEmptyState(elements.safetyData, 'No safety communication data found for this drug.');
  }
  
  // Display PSUSA data
  if (results.psusa && results.psusa.length > 0) {
    displayPsusaData(results.psusa);
  } else {
    showEmptyState(elements.psusaData, 'No PSUSA data found for this drug.');
  }
  
  // Display Referrals data
  if (results.referrals && results.referrals.length > 0) {
    displayReferralsData(results.referrals);
  } else {
    showEmptyState(elements.referralsData, 'No referral data found for this drug.');
  }
  
  // Display Shortages data
  if (results.shortages && results.shortages.length > 0) {
    displayShortagesData(results.shortages);
  } else {
    showEmptyState(elements.shortagesData, 'No shortage data found for this drug.');
  }
}
  // Display approval data
  function displayApprovalData(data) {
  if (!elements.approvalData) return;
  
  // Filter out veterinary products
  const filteredData = data.filter(item => {
    return !item._0 || item._0.toLowerCase() !== 'veterinary';
  });
  
  if (filteredData.length === 0) {
    showEmptyState(elements.approvalData, 'No human medicine approval data found for this drug.');
    return;
  }
  
  let html = `
    <div class="overflow-x-auto">
      <table class="ema-data-table">
        <thead>
          <tr>
            <th>Medicine Name</th>
            <th>Status</th>
            <th>Active Substance</th>
            <th>Therapeutic Area</th>
            <th>Authorization Date</th>
            <th>Details</th>
          </tr>
        </thead>
        <tbody>
  `;
  
  filteredData.forEach(item => {
    // Extract relevant fields based on the raw data structure
    const medicineName = item._1 || 'Unknown';
    const status = item._3 || 'Unknown';
    const substance = item._6 || item._7 || 'Not specified';
    const therapeuticArea = item._8 || item._13 || 'Not specified';
    const authDate = item._29 || item._31 || item._36 || 'Unknown';
    const indication = item._15 || '';
    const emaLink = item._38 || '';
    
    // Determine status badge class
    let statusClass = 'bg-gray-100 text-gray-800';
    if (status.toLowerCase().includes('authorised') || status.toLowerCase().includes('authorized')) {
      statusClass = 'bg-green-100 text-green-800';
    } else if (status.toLowerCase().includes('refused')) {
      statusClass = 'bg-red-100 text-red-800';
    } else if (status.toLowerCase().includes('withdrawn')) {
      statusClass = 'bg-gray-100 text-gray-800';
    } else if (status.toLowerCase().includes('pending')) {
      statusClass = 'bg-yellow-100 text-yellow-800';
    }
    
    html += `
      <tr>
        <td>
          <div class="font-medium">${medicineName}</div>
          ${item._2 ? `<div class="text-xs text-gray-500">Procedure: ${item._2}</div>` : ''}
        </td>
        <td>
          <span class="px-2 py-1 rounded-full text-xs font-medium ${statusClass}">
            ${status}
          </span>
        </td>
        <td>${substance}</td>
        <td>${formatTherapeuticArea(therapeuticArea)}</td>
        <td>${formatDate(authDate)}</td>
        <td>
          ${emaLink ? `<a href="${emaLink}" target="_blank" class="text-blue-600 hover:underline">EMA Page</a>` : 'N/A'}
          ${indication ? `<div class="text-xs text-gray-600 mt-1">Indication: ${indication}</div>` : ''}
        </td>
      </tr>
    `;
  });
  
  html += `
        </tbody>
      </table>
    </div>
  `;
  
  elements.approvalData.innerHTML = html;
}

function displayOrphanData(data) {
  if (!elements.orphanData) return;
  
  // Filter out veterinary products
  const filteredData = data.filter(item => {
    return !item._0 || item._0.toLowerCase() !== 'veterinary';
  });
  
  if (filteredData.length === 0) {
    showEmptyState(elements.orphanData, 'No orphan designation data found for this drug.');
    return;
  }
  
  let html = `
    <div class="overflow-x-auto">
      <table class="ema-data-table">
        <thead>
          <tr>
            <th>Medicine Name</th>
            <th>Condition</th>
            <th>Status</th>
            <th>Decision Date</th>
            <th>Details</th>
          </tr>
        </thead>
        <tbody>
  `;
  
  filteredData.forEach(item => {
    // Find fields based on your CSV structure
    const medicineName = item['Orphan designation'] || item._1 || 'Unknown';
    const condition = findFieldInItem(item, ['condition', '_2', '_3']) || 'Not specified';
    const status = findFieldInItem(item, ['status', '_4', '_5']) || 'Unknown';
    const decisionDate = findFieldInItem(item, ['date', '_6', '_7']) || 'Unknown';
    const sponsor = findFieldInItem(item, ['sponsor', '_8', '_9']) || '';
    const emaLink = findFieldInItem(item, ['_20', '_21', '_22']) || '';
    
    // Determine status badge class
    let statusClass = 'bg-gray-100 text-gray-800';
    if (status.toLowerCase().includes('positive')) {
      statusClass = 'bg-green-100 text-green-800';
    } else if (status.toLowerCase().includes('negative')) {
      statusClass = 'bg-red-100 text-red-800';
    } else if (status.toLowerCase().includes('withdrawn')) {
      statusClass = 'bg-gray-100 text-gray-800';
    }
    
    html += `
      <tr>
        <td>
          <div class="font-medium">${medicineName}</div>
          ${sponsor ? `<div class="text-xs text-gray-500">Sponsor: ${sponsor}</div>` : ''}
        </td>
        <td>${condition}</td>
        <td>
          <span class="px-2 py-1 rounded-full text-xs font-medium ${statusClass}">
            ${status}
          </span>
        </td>
        <td>${formatDate(decisionDate)}</td>
        <td>
          ${emaLink ? `<a href="${emaLink}" target="_blank" class="text-blue-600 hover:underline">EMA Page</a>` : 'N/A'}
        </td>
      </tr>
    `;
  });
  
  html += `
        </tbody>
      </table>
    </div>
  `;
  
  elements.orphanData.innerHTML = html;
}
  
function displaySafetyData(data) {
  if (!elements.safetyData) return;
  
  // Filter out veterinary products
  const filteredData = data.filter(item => {
    return !item._0 || item._0.toLowerCase() !== 'veterinary';
  });
  
  if (filteredData.length === 0) {
    showEmptyState(elements.safetyData, 'No safety communication data found for this drug.');
    return;
  }
  
  let html = `
    <div class="overflow-x-auto">
      <table class="ema-data-table">
        <thead>
          <tr>
            <th>Title</th>
            <th>Medicine</th>
            <th>Date</th>
            <th>Details</th>
          </tr>
        </thead>
        <tbody>
  `;
  
  filteredData.forEach(item => {
    // Find fields based on your CSV structure
    const title = item['Direct healthcare professional communication (DHPC)'] || 
                  findFieldInItem(item, ['_1', '_2']) || 'Unknown';
    const medicine = findFieldInItem(item, ['medicine', '_3', '_4']) || 'Not specified';
    const date = findFieldInItem(item, ['date', '_5', '_6']) || 'Unknown';
    const reason = findFieldInItem(item, ['reason', '_7', '_8']) || '';
    const emaLink = findFieldInItem(item, ['_15', '_16', '_17']) || '';
    
    html += `
      <tr>
        <td>
          <div class="font-medium">${title}</div>
        </td>
        <td>${medicine}</td>
        <td>${formatDate(date)}</td>
        <td>
          ${reason ? `<div class="text-xs text-gray-600 mb-1">Reason: ${reason}</div>` : ''}
          ${emaLink ? `<a href="${emaLink}" target="_blank" class="text-blue-600 hover:underline">EMA Page</a>` : 'N/A'}
        </td>
      </tr>
    `;
  });
  
  html += `
        </tbody>
      </table>
    </div>
  `;
  
  elements.safetyData.innerHTML = html;
}

// Display PSUSA data
function displayPsusaData(data) {
  if (!elements.psusaData) return;
  
  // Filter out veterinary products
  const filteredData = data.filter(item => {
    return !item._0 || item._0.toLowerCase() !== 'veterinary';
  });
  
  if (filteredData.length === 0) {
    showEmptyState(elements.psusaData, 'No PSUSA data found for this drug.');
    return;
  }
  
  let html = `
    <div class="overflow-x-auto">
      <table class="ema-data-table">
        <thead>
          <tr>
            <th>Substance</th>
            <th>Procedure</th>
            <th>Outcome</th>
            <th>Date</th>
            <th>Details</th>
          </tr>
        </thead>
        <tbody>
  `;
  
  filteredData.forEach(item => {
    // Find fields based on your CSV structure
    const substance = item['Periodic safety update report single assessments (PSUSA)'] || 
                     item._1 || 
                     item._2 || 'Unknown';
    const procedure = item._4 || 'Not specified';
    const outcome = item._5 || 'Unknown';
    const date = item._6 || 'Unknown';
    const emaLink = item._8 || '';
    
    // Determine outcome badge class
    let outcomeClass = 'bg-gray-100 text-gray-800';
    if (outcome.toLowerCase().includes('variation')) {
      outcomeClass = 'bg-yellow-100 text-yellow-800';
    } else if (outcome.toLowerCase().includes('maintenance')) {
      outcomeClass = 'bg-green-100 text-green-800';
    }
    
    html += `
      <tr>
        <td>
          <div class="font-medium">${substance}</div>
        </td>
        <td>${procedure}</td>
        <td>
          <span class="px-2 py-1 rounded-full text-xs font-medium ${outcomeClass}">
            ${outcome}
          </span>
        </td>
        <td>${formatDate(date)}</td>
        <td>
          ${emaLink ? `<a href="${emaLink}" target="_blank" class="text-blue-600 hover:underline">EMA Page</a>` : 'N/A'}
        </td>
      </tr>
    `;
  });
  
  html += `
        </tbody>
      </table>
    </div>
  `;
  
  elements.psusaData.innerHTML = html;
}

// Display Referrals data
function displayReferralsData(data) {
  if (!elements.referralsData) return;
  
  // Filter out veterinary products
  const filteredData = data.filter(item => {
    return !item._0 || item._0.toLowerCase() !== 'veterinary';
  });
  
  if (filteredData.length === 0) {
    showEmptyState(elements.referralsData, 'No referral data found for this drug.');
    return;
  }
  
  let html = `
    <div class="overflow-x-auto">
      <table class="ema-data-table">
        <thead>
          <tr>
            <th>Medicine</th>
            <th>Substance</th>
            <th>Status</th>
            <th>Date</th>
            <th>Details</th>
          </tr>
        </thead>
        <tbody>
  `;
  
  filteredData.forEach(item => {
    // Find fields based on your CSV structure
    const medicine = item._1 || 'Unknown';
    const substance = item._2 || 'Not specified';
    const status = item._3 || 'Unknown';
    const procedure = item._9 || '';
    const date = findFieldInItem(item, ['_17', '_18', '_19']) || 'Unknown';
    const emaLink = item._21 || '';
    
    // Determine status badge class
    let statusClass = 'bg-gray-100 text-gray-800';
    if (status.toLowerCase().includes('final') || status.toLowerCase().includes('concluded')) {
      statusClass = 'bg-green-100 text-green-800';
    } else if (status.toLowerCase().includes('ongoing')) {
      statusClass = 'bg-yellow-100 text-yellow-800';
    }
    
    html += `
      <tr>
        <td>
          <div class="font-medium">${medicine}</div>
        </td>
        <td>${substance}</td>
        <td>
          <span class="px-2 py-1 rounded-full text-xs font-medium ${statusClass}">
            ${status}
          </span>
        </td>
        <td>${formatDate(date)}</td>
        <td>
          ${procedure ? `<div class="text-xs text-gray-600 mb-1">Procedure: ${procedure}</div>` : ''}
          ${emaLink ? `<a href="${emaLink}" target="_blank" class="text-blue-600 hover:underline">EMA Page</a>` : 'N/A'}
        </td>
      </tr>
    `;
  });
  
  html += `
        </tbody>
      </table>
    </div>
  `;
  
  elements.referralsData.innerHTML = html;
}

// Display Shortages data
function displayShortagesData(data) {
  if (!elements.shortagesData) return;
  
  // Filter out veterinary products
  const filteredData = data.filter(item => {
    return !item._0 || item._0.toLowerCase() !== 'veterinary';
  });
  
  if (filteredData.length === 0) {
    showEmptyState(elements.shortagesData, 'No shortage data found for this drug.');
    return;
  }
  
  let html = `
    <div class="overflow-x-auto">
      <table class="ema-data-table">
        <thead>
          <tr>
            <th>Medicine</th>
            <th>Reason</th>
            <th>Status</th>
            <th>Date</th>
            <th>Details</th>
          </tr>
        </thead>
        <tbody>
  `;
  
  filteredData.forEach(item => {
    // Find fields based on your CSV structure
    const medicine = item.Shortage || item._1 || 'Unknown';
    const reason = findFieldInItem(item, ['reason', '_4', '_5']) || 'Not specified';
    const status = findFieldInItem(item, ['status', '_6', '_7']) || 'Unknown';
    const date = findFieldInItem(item, ['date', '_8', '_9']) || 'Unknown';
    const emaLink = findFieldInItem(item, ['_13', '_14', '_15']) || '';
    
    // Determine status badge class
    let statusClass = 'bg-gray-100 text-gray-800';
    if (status.toLowerCase().includes('ongoing')) {
      statusClass = 'bg-red-100 text-red-800';
    } else if (status.toLowerCase().includes('resolved')) {
      statusClass = 'bg-green-100 text-green-800';
    } else if (status.toLowerCase().includes('expected')) {
      statusClass = 'bg-yellow-100 text-yellow-800';
    }
    
    html += `
      <tr>
        <td>
          <div class="font-medium">${medicine}</div>
        </td>
        <td>${reason}</td>
        <td>
          <span class="px-2 py-1 rounded-full text-xs font-medium ${statusClass}">
            ${status}
          </span>
        </td>
        <td>${formatDate(date)}</td>
        <td>
          ${emaLink ? `<a href="${emaLink}" target="_blank" class="text-blue-600 hover:underline">EMA Page</a>` : 'N/A'}
        </td>
      </tr>
    `;
  });
  
  html += `
        </tbody>
      </table>
    </div>
  `;
  
  elements.shortagesData.innerHTML = html;
}

// Helper function to find field in an item with numeric keys (_0, _1, etc.)
function findFieldInItem(item, possibleKeys) {
  // First try the exact keys
  for (const key of possibleKeys) {
    if (item[key] !== undefined && item[key] !== null && item[key] !== '') {
      return item[key];
    }
  }
  
  // If not found, try all numeric keys
  for (let i = 0; i < 40; i++) {
    const key = `_${i}`;
    if (item[key] !== undefined && item[key] !== null && item[key] !== '') {
      // Try to determine if this is the field we're looking for
      // This is a simplistic approach and might need refinement
      const value = item[key].toString().toLowerCase();
      
      // Check if this might be a date
      if (possibleKeys.includes('date') && (value.includes('/') || value.match(/\d{2}\.\d{2}\.\d{4}/))) {
        return item[key];
      }
      
      // Check if this might be a status
      if (possibleKeys.includes('status') && 
          (value.includes('authorised') || value.includes('withdrawn') || 
           value.includes('ongoing') || value.includes('resolved'))) {
        return item[key];
      }
      
      // Check if this might be a reason
      if (possibleKeys.includes('reason') && 
          value.length > 10 && (value.includes('due to') || value.includes('because'))) {
        return item[key];
      }
    }
  }
  
  return null;
}

// Helper function to find a field value in an object using various possible keys
  function findField(obj, possibleKeys) {
    for (const key of possibleKeys) {
      if (obj[key] !== undefined && obj[key] !== null && obj[key] !== '') {
        return obj[key];
      }
    }
    
    // Try matching keys by pattern
    for (const objKey in obj) {
      for (const possibleKey of possibleKeys) {
        if (objKey.toLowerCase().includes(possibleKey.toLowerCase()) && 
            obj[objKey] !== undefined && obj[objKey] !== null && obj[objKey] !== '') {
          return obj[objKey];
        }
      }
    }
    
    return null;
  }

  // Upload a file to the server
  async function uploadFile(fileType, file) {
    if (!file) {
      showUploadStatus('Please select a file', 'error');
      return;
    }
    
    try {
      // Create form data
      const formData = new FormData();
      formData.append('file', file);
      
      // Show loading state
      showUploadStatus('Uploading file...', 'loading');
      
      // Send request
      const response = await fetch(`/api/ema/upload/${fileType}`, {
        method: 'POST',
        body: formData
      });
      
      const data = await response.json();
      
      if (response.ok) {
        showUploadStatus(`File uploaded successfully. Processed ${data.records} records.`, 'success');
        
        // Clear file input
        if (fileType === 'dhpc' && elements.dhpcFileInput) {
          elements.dhpcFileInput.value = '';
        } else if (fileType === 'psusa' && elements.psusaFileInput) {
          elements.psusaFileInput.value = '';
        } else if (fileType === 'shortages' && elements.shortagesFileInput) {
          elements.shortagesFileInput.value = '';
        }
        
        // Refresh EMA data status
        checkEmaDataStatus();
      } else {
        showUploadStatus(`Error: ${data.error}`, 'error');
        console.error('Error uploading file:', data.error);
      }
    } catch (error) {
      showUploadStatus('Error connecting to server', 'error');
      console.error('Error uploading file:', error);
    }
  }

  // Show upload status message
  function showUploadStatus(message, type = 'info') {
    if (!elements.uploadStatus) return;
    
    let bgColor = 'bg-blue-50';
    let textColor = 'text-blue-800';
    let icon = `
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
    `;
    
    if (type === 'success') {
      bgColor = 'bg-green-50';
      textColor = 'text-green-800';
      icon = `
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
        </svg>
      `;
    } else if (type === 'error') {
      bgColor = 'bg-red-50';
      textColor = 'text-red-800';
      icon = `
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
      `;
    } else if (type === 'loading') {
      bgColor = 'bg-blue-50';
      textColor = 'text-blue-800';
      icon = `
        <svg xmlns="http://www.w3.org/2000/svg" class="animate-spin h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
        </svg>
      `;
    }
    
    elements.uploadStatus.innerHTML = `
      <div class="flex items-center p-4 ${bgColor} ${textColor} rounded-lg">
        ${icon}
        <span>${message}</span>
      </div>
    `;
    
    elements.uploadStatus.classList.remove('hidden');
    
    // Hide the status message after 5 seconds if it's a success message
    if (type === 'success') {
      setTimeout(() => {
        elements.uploadStatus.classList.add('hidden');
      }, 5000);
    }
  }

  // Update counter
  function updateCounter(element, count, singular, plural) {
    if (!element) return;
    
    element.textContent = `${count} ${count === 1 ? singular : plural}`;
  }

  // Show loading state
  function showLoadingState(element, isText = false) {
    if (!element) return;
    
    if (isText) {
      element.innerHTML = `
        <span class="animate-pulse">Loading...</span>
      `;
    } else {
      element.innerHTML = `
        <div class="ema-loading-state">
          <svg xmlns="http://www.w3.org/2000/svg" class="animate-spin h-8 w-8 text-blue-500 mx-auto mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
          </svg>
          <p class="text-center text-gray-500">Loading data...</p>
        </div>
      `;
    }
  }

  // Show empty state
  function showEmptyState(element, message) {
    if (!element) return;
    
    element.innerHTML = `
      <div class="ema-empty-state">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gray-400 mx-auto mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
        </svg>
        <p class="text-center text-gray-500">${message}</p>
      </div>
    `;
  }

  // Format date
  function formatDate(dateString) {
    if (!dateString) return 'Unknown';
    
    try {
      const date = new Date(dateString);
      if (isNaN(date.getTime())) {
        return dateString; // Return the original string if it's not a valid date
      }
      
      return date.toLocaleDateString('en-GB', {
        day: '2-digit',
        month: 'short',
        year: 'numeric'
      });
    } catch (error) {
      return dateString;
    }
  }

  // Format therapeutic area
  function formatTherapeuticArea(area) {
    if (!area) return 'Not specified';
    
    // Split by commas and create badges
    const areas = area.split(',').map(a => a.trim()).filter(a => a);
    
    if (areas.length === 0) return 'Not specified';
    
    return areas.map(a => `
      <span class="inline-block px-2 py-1 text-xs font-medium bg-blue-50 text-blue-700 rounded-full mb-1 mr-1">
        ${a}
      </span>
    `).join('');
  }

  // Show error toast
  function showError(message) {
    showToast(message, 'error');
  }

  // Show toast message
  function showToast(message, type = 'info') {
    // Check if toast container exists, if not create it
    let toastContainer = document.getElementById('toast-container');
    
    if (!toastContainer) {
      toastContainer = document.createElement('div');
      toastContainer.id = 'toast-container';
      toastContainer.className = 'fixed bottom-4 right-4 z-50 flex flex-col space-y-2';
      document.body.appendChild(toastContainer);
    }
    
    // Create toast element
    const toast = document.createElement('div');
    
    let bgColor = 'bg-blue-500';
    let icon = `
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
    `;
    
    if (type === 'success') {
      bgColor = 'bg-green-500';
      icon = `
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
        </svg>
      `;
    } else if (type === 'error') {
      bgColor = 'bg-red-500';
      icon = `
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
      `;
    } else if (type === 'warning') {
      bgColor = 'bg-yellow-500';
      icon = `
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
        </svg>
      `;
    }
    
    toast.className = `flex items-center p-3 rounded-lg text-white ${bgColor} shadow-lg transition-opacity duration-500`;
    toast.innerHTML = `
      ${icon}
      <span>${message}</span>
      <button class="ml-4 text-white focus:outline-none hover:text-gray-200">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    `;
    
    // Add click event to close button
    const closeButton = toast.querySelector('button');
    closeButton.addEventListener('click', () => {
      toast.style.opacity = '0';
      setTimeout(() => {
        toastContainer.removeChild(toast);
      }, 500);
    });
    
    // Add toast to container
    toastContainer.appendChild(toast);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
      if (toast.parentNode === toastContainer) {
        toast.style.opacity = '0';
        setTimeout(() => {
          if (toast.parentNode === toastContainer) {
            toastContainer.removeChild(toast);
          }
        }, 500);
      }
    }, 5000);
  }

  // Set user role (admin or regular user)
  function setUserRole(role) {
    const isAdmin = role === 'admin';
    toggleAdminSection(isAdmin);
  }

  // Check if user is authenticated and has the correct role
  async function checkUserPermissions() {
    try {
      const response = await fetch('/api/auth/user');
      const data = await response.json();
      
      if (response.ok && data.authenticated) {
        // Check if user has admin role for EMA data
        const hasEmaAdminRole = data.roles && data.roles.includes('ema_admin');
        setUserRole(hasEmaAdminRole ? 'admin' : 'user');
        
        return hasEmaAdminRole;
      } else {
        setUserRole('user');
        return false;
      }
    } catch (error) {
      console.error('Error checking user permissions:', error);
      setUserRole('user');
      return false;
    }
  }

  // Add CSS styles for EMA data tables
  function addTableStyles() {
    const styleId = 'ema-data-table-styles';
    
    // Check if styles already exist
    if (document.getElementById(styleId)) {
      return;
    }
    
    const styleElement = document.createElement('style');
    styleElement.id = styleId;
    styleElement.textContent = `
      .ema-data-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
      }
      
      .ema-data-table th {
        background-color: #f8fafc;
        padding: 0.75rem;
        text-align: left;
        font-weight: 600;
        font-size: 0.875rem;
        color: #4b5563;
        border-bottom: 1px solid #e5e7eb;
      }
      
      .ema-data-table td {
        padding: 0.75rem;
        border-bottom: 1px solid #e5e7eb;
      }
      
      .ema-data-table tbody tr:hover {
        background-color: #f9fafb;
      }
      
      .ema-empty-state, .ema-loading-state {
        padding: 2rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 200px;
      }
    `;
    
    document.head.appendChild(styleElement);
  }

  // Export functions for external use
  return {
    init,
    searchDrug,
    showSection,
    toggleAdminSection,
    refreshEmaData,
    checkEmaDataStatus,
    checkUserPermissions
  };
})();



const EmaClinicalDataModule = (function() {
  // DOM elements (unchanged from original)
  const elements = {
    section: document.getElementById('emaDataSection'),
    lastUpdated: document.getElementById('emaDataLastUpdated'),
    refreshBtn: document.getElementById('refreshEmaDataBtn'),
    approvalCount: document.getElementById('emaApprovalCount'),
    orphanCount: document.getElementById('emaOrphanCount'),
    safetyCount: document.getElementById('emaSafetyCount'),
    psusaCount: document.getElementById('emaPsusaCount'),
    shortagesCount: document.getElementById('emaShortagesCount'),
    referralsCount: document.getElementById('emaReferralsCount'),
    approvalData: document.getElementById('emaApprovalData'),
    orphanData: document.getElementById('emaOrphanData'),
    safetyData: document.getElementById('emaSafetyData'),
    psusaData: document.getElementById('emaPsusaData'),
    shortagesData: document.getElementById('emaShortagesData'),
    referralsData: document.getElementById('emaReferralsData'),
    uploadStatus: document.getElementById('uploadStatus'),
    dhpcUploadForm: document.getElementById('dhpcUploadForm'),
    psusaUploadForm: document.getElementById('psusaUploadForm'),
    shortagesUploadForm: document.getElementById('shortagesUploadForm'),
    medicinesUploadForm: document.getElementById('medicinesUploadForm'),
    referralsUploadForm: document.getElementById('referralsUploadForm'),
    dhpcFileInput: document.getElementById('dhpcFileInput'),
    psusaFileInput: document.getElementById('psusaFileInput'),
    shortagesFileInput: document.getElementById('shortagesFileInput'),
    medicinesFileInput: document.getElementById('medicinesFileInput'),
    referralsFileInput: document.getElementById('referralsFileInput'),
    dataAdmin: document.getElementById('emaDataAdmin')
  };

  // Initialize the module
  function init() {
    initTabNavigation();
    initFileUploadForms();
    if (elements.refreshBtn) {
      elements.refreshBtn.addEventListener('click', refreshEmaData);
    }
    checkEmaDataStatus();
    toggleAdminSection(false);
    addTableStyles();
    console.log('EMA Clinical Data Module initialized');
  }

  // Tab navigation and file upload forms remain unchanged
  function initTabNavigation() {
    const tabButtons = document.querySelectorAll('.ema-tab-button');
    tabButtons.forEach(button => {
      button.addEventListener('click', function() {
        const tabId = this.getAttribute('data-tab');
        document.querySelectorAll('.ema-tab-pane').forEach(pane => {
          pane.classList.add('hidden');
          pane.classList.remove('active');
        });
        tabButtons.forEach(btn => {
          btn.classList.remove('border-blue-500', 'text-blue-600');
          btn.classList.add('border-transparent', 'hover:text-gray-600', 'hover:border-gray-300');
          btn.setAttribute('aria-selected', 'false');
        });
        document.getElementById(tabId).classList.remove('hidden');
        document.getElementById(tabId).classList.add('active');
        this.classList.remove('border-transparent', 'hover:text-gray-600', 'hover:border-gray-300');
        this.classList.add('border-blue-500', 'text-blue-600');
        this.setAttribute('aria-selected', 'true');
      });
    });
  }

  function initFileUploadForms() {
    if (elements.dhpcUploadForm) {
      elements.dhpcUploadForm.addEventListener('submit', function(e) {
        e.preventDefault();
        uploadFile('dhpc', elements.dhpcFileInput.files[0]);
      });
    }
    if (elements.psusaUploadForm) {
      elements.psusaUploadForm.addEventListener('submit', function(e) {
        e.preventDefault();
        uploadFile('psusa', elements.psusaFileInput.files[0]);
      });
    }
    if (elements.shortagesUploadForm) {
      elements.shortagesUploadForm.addEventListener('submit', function(e) {
        e.preventDefault();
        uploadFile('shortages', elements.shortagesFileInput.files[0]);
      });
    }
    if (elements.medicinesUploadForm) {
      elements.medicinesUploadForm.addEventListener('submit', function(e) {
        e.preventDefault();
        uploadFile('medicines', elements.medicinesFileInput.files[0]);
      });
    }
    if (elements.referralsUploadForm) {
      elements.referralsUploadForm.addEventListener('submit', function(e) {
        e.preventDefault();
        uploadFile('referrals', elements.referralsFileInput.files[0]);
      });
    }
  }

  // New function to search by condition
  async function searchCondition(condition) {
    if (!condition) {
      showError('Please provide a clinical condition to search.');
      return;
    }

    try {
      showLoadingState(elements.approvalData);
      showLoadingState(elements.orphanData);
      showLoadingState(elements.safetyData);
      showLoadingState(elements.psusaData);
      showLoadingState(elements.shortagesData);
      showLoadingState(elements.referralsData);
      showSection(true);

      console.log(`Fetching EMA data for condition: ${condition}`);
      const response = await fetch(`/api/ema/condition/${encodeURIComponent(condition)}`);
      const data = await response.json();

      if (response.ok) {
        console.log(data);
        displayEmaClinicalData(data, condition);
      } else {
        showError(`No EMA data found for ${condition}`);
        console.error('Error searching EMA data:', data.error);
        showEmptyState(elements.approvalData, `No EMA approval data found for ${condition}.`);
        showEmptyState(elements.orphanData, `No orphan designation data found for ${condition}.`);
        showEmptyState(elements.safetyData, `No safety communication data found for ${condition}.`);
        showEmptyState(elements.psusaData, `No PSUSA data found for ${condition}.`);
        showEmptyState(elements.shortagesData, `No shortage data found for ${condition}.`);
        showEmptyState(elements.referralsData, `No referral data found for ${condition}.`);
      }
    } catch (error) {
      showError('Error connecting to server');
      console.error(`Error searching EMA data for ${condition}:`, error);
      showEmptyState(elements.approvalData, 'Error loading EMA approval data.');
      showEmptyState(elements.orphanData, 'Error loading orphan designation data.');
      showEmptyState(elements.safetyData, 'Error loading safety communication data.');
      showEmptyState(elements.psusaData, 'Error loading PSUSA data.');
      showEmptyState(elements.shortagesData, 'Error loading shortages data.');
      showEmptyState(elements.referralsData, 'Error loading referrals data.');
    }
  }

  // Updated display function for condition-based data
  function displayEmaClinicalData(data, condition) {
    const { results, total } = data;

    // Filter out veterinary products
    Object.keys(results).forEach(key => {
      if (Array.isArray(results[key])) {
        results[key] = results[key].filter(item => !item._0 || item._0.toLowerCase() !== 'veterinary');
        total[key] = results[key].length;
      }
    });

    // Update counters with total number of records
    updateCounter(elements.approvalCount, total.medicines, 'approval', 'approvals');
    updateCounter(elements.orphanCount, total.orphans, 'designation', 'designations');
    updateCounter(elements.safetyCount, total.dhpc, 'communication', 'communications');
    updateCounter(elements.psusaCount, total.psusa, 'report', 'reports');
    updateCounter(elements.shortagesCount, total.shortages, 'shortage', 'shortages');
    updateCounter(elements.referralsCount, total.referrals, 'referral', 'referrals');

    // Display data for each category
    displayClinicalApprovalData(results.medicines, condition);
    displayClinicalOrphanData(results.orphans, condition);
    displayClinicalSafetyData(results.dhpc, condition);
    displayClinicalPsusaData(results.psusa, condition);
    displayClinicalShortagesData(results.shortages, condition);
    displayClinicalReferralsData(results.referrals, condition);
  }

  // Clinical display functions
  function displayClinicalApprovalData(data, condition) {
    if (!elements.approvalData || !data || data.length === 0) {
      showEmptyState(elements.approvalData, `No EMA approval data found for ${condition}.`);
      return;
    }

    let html = `
      <div class="overflow-x-auto">
        <h2 class="text-lg font-semibold mb-2">Approved Medicines for ${condition}</h2>
        <table class="ema-data-table">
          <thead>
            <tr>
              <th>Medicine Name</th>
              <th>Status</th>
              <th>Active Substance</th>
              <th>Therapeutic Area</th>
              <th>Authorization Date</th>
              <th>Details</th>
            </tr>
          </thead>
          <tbody>
    `;

    data.forEach(item => {
      const medicineName = item._1 || 'Unknown';
      const status = item._3 || 'Unknown';
      const substance = item._6 || item._7 || 'Not specified';
      const therapeuticArea = item._8 || item._13 || 'Not specified';
      const authDate = item._29 || item._31 || item._36 || 'Unknown';
      const indication = item._15 || '';
      const emaLink = item._38 || '';

      let statusClass = 'bg-gray-100 text-gray-800';
      if (status.toLowerCase().includes('authorised') || status.toLowerCase().includes('authorized')) {
        statusClass = 'bg-green-100 text-green-800';
      } else if (status.toLowerCase().includes('refused')) {
        statusClass = 'bg-red-100 text-red-800';
      } else if (status.toLowerCase().includes('withdrawn')) {
        statusClass = 'bg-gray-100 text-gray-800';
      } else if (status.toLowerCase().includes('pending')) {
        statusClass = 'bg-yellow-100 text-yellow-800';
      }

      html += `
        <tr>
          <td>
            <div class="font-medium">${medicineName}</div>
            ${item._2 ? `<div class="text-xs text-gray-500">Procedure: ${item._2}</div>` : ''}
          </td>
          <td>
            <span class="px-2 py-1 rounded-full text-xs font-medium ${statusClass}">
              ${status}
            </span>
          </td>
          <td>${substance}</td>
          <td>${formatTherapeuticArea(therapeuticArea)}</td>
          <td>${formatDate(authDate)}</td>
          <td>
            ${emaLink ? `<a href="${emaLink}" target="_blank" class="text-blue-600 hover:underline">EMA Page</a>` : 'N/A'}
            ${indication ? `<div class="text-xs text-gray-600 mt-1">Indication: ${indication}</div>` : ''}
          </td>
        </tr>
      `;
    });

    html += `
          </tbody>
        </table>
      </div>
    `;
    elements.approvalData.innerHTML = html;
  }

  function displayClinicalOrphanData(data, condition) {
    if (!elements.orphanData || !data || data.length === 0) {
      showEmptyState(elements.orphanData, `No orphan designation data found for ${condition}.`);
      return;
    }

    let html = `
      <div class="overflow-x-auto">
        <h2 class="text-lg font-semibold mb-2">Orphan Designations for ${condition}</h2>
        <table class="ema-data-table">
          <thead>
            <tr>
              <th>Medicine Name</th>
              <th>Condition</th>
              <th>Status</th>
              <th>Decision Date</th>
              <th>Details</th>
            </tr>
          </thead>
          <tbody>
    `;

    data.forEach(item => {
      const medicineName = item['Orphan designation'] || item._1 || 'Unknown';
      const orphanCondition = findFieldInItem(item, ['condition', '_2', '_3']) || 'Not specified';
      const status = findFieldInItem(item, ['status', '_4', '_5']) || 'Unknown';
      const decisionDate = findFieldInItem(item, ['date', '_6', '_7']) || 'Unknown';
      const sponsor = findFieldInItem(item, ['sponsor', '_8', '_9']) || '';
      const emaLink = findFieldInItem(item, ['_20', '_21', '_22']) || '';

      let statusClass = 'bg-gray-100 text-gray-800';
      if (status.toLowerCase().includes('positive')) {
        statusClass = 'bg-green-100 text-green-800';
      } else if (status.toLowerCase().includes('negative')) {
        statusClass = 'bg-red-100 text-red-800';
      } else if (status.toLowerCase().includes('withdrawn')) {
        statusClass = 'bg-gray-100 text-gray-800';
      }

      html += `
        <tr>
          <td>
            <div class="font-medium">${medicineName}</div>
            ${sponsor ? `<div class="text-xs text-gray-500">Sponsor: ${sponsor}</div>` : ''}
          </td>
          <td>${orphanCondition}</td>
          <td>
            <span class="px-2 py-1 rounded-full text-xs font-medium ${statusClass}">
              ${status}
            </span>
          </td>
          <td>${formatDate(decisionDate)}</td>
          <td>
            ${emaLink ? `<a href="${emaLink}" target="_blank" class="text-blue-600 hover:underline">EMA Page</a>` : 'N/A'}
          </td>
        </tr>
      `;
    });

    html += `
          </tbody>
        </table>
      </div>
    `;
    elements.orphanData.innerHTML = html;
  }

  function displayClinicalSafetyData(data, condition) {
    if (!elements.safetyData || !data || data.length === 0) {
      showEmptyState(elements.safetyData, `No safety communication data found for ${condition}.`);
      return;
    }

    let html = `
      <div class="overflow-x-auto">
        <h2 class="text-lg font-semibold mb-2">Safety Communications for ${condition}</h2>
        <table class="ema-data-table">
          <thead>
            <tr>
              <th>Title</th>
              <th>Medicine</th>
              <th>Date</th>
              <th>Details</th>
            </tr>
          </thead>
          <tbody>
    `;

    data.forEach(item => {
      const title = item['Direct healthcare professional communication (DHPC)'] || findFieldInItem(item, ['_1', '_2']) || 'Unknown';
      const medicine = findFieldInItem(item, ['medicine', '_3', '_4']) || 'Not specified';
      const date = findFieldInItem(item, ['date', '_5', '_6']) || 'Unknown';
      const reason = findFieldInItem(item, ['reason', '_7', '_8']) || '';
      const emaLink = findFieldInItem(item, ['_15', '_16', '_17']) || '';

      html += `
        <tr>
          <td>
            <div class="font-medium">${title}</div>
          </td>
          <td>${medicine}</td>
          <td>${formatDate(date)}</td>
          <td>
            ${reason ? `<div class="text-xs text-gray-600 mb-1">Reason: ${reason}</div>` : ''}
            ${emaLink ? `<a href="${emaLink}" target="_blank" class="text-blue-600 hover:underline">EMA Page</a>` : 'N/A'}
          </td>
        </tr>
      `;
    });

    html += `
          </tbody>
        </table>
      </div>
    `;
    elements.safetyData.innerHTML = html;
  }

  function displayClinicalPsusaData(data, condition) {
    if (!elements.psusaData || !data || data.length === 0) {
      showEmptyState(elements.psusaData, `No PSUSA data found for ${condition}.`);
      return;
    }

    let html = `
      <div class="overflow-x-auto">
        <h2 class="text-lg font-semibold mb-2">PSUSA Reports for ${condition}</h2>
        <table class="ema-data-table">
          <thead>
            <tr>
              <th>Substance</th>
              <th>Procedure</th>
              <th>Outcome</th>
              <th>Date</th>
              <th>Details</th>
            </tr>
          </thead>
          <tbody>
    `;

    data.forEach(item => {
      const substance = item['Periodic safety update report single assessments (PSUSA)'] || item._1 || item._2 || 'Unknown';
      const procedure = item._4 || 'Not specified';
      const outcome = item._5 || 'Unknown';
      const date = item._6 || 'Unknown';
      const emaLink = item._8 || '';

      let outcomeClass = 'bg-gray-100 text-gray-800';
      if (outcome.toLowerCase().includes('variation')) {
        outcomeClass = 'bg-yellow-100 text-yellow-800';
      } else if (outcome.toLowerCase().includes('maintenance')) {
        outcomeClass = 'bg-green-100 text-green-800';
      }

      html += `
        <tr>
          <td>
            <div class="font-medium">${substance}</div>
          </td>
          <td>${procedure}</td>
          <td>
            <span class="px-2 py-1 rounded-full text-xs font-medium ${outcomeClass}">
              ${outcome}
            </span>
          </td>
          <td>${formatDate(date)}</td>
          <td>
            ${emaLink ? `<a href="${emaLink}" target="_blank" class="text-blue-600 hover:underline">EMA Page</a>` : 'N/A'}
          </td>
        </tr>
      `;
    });

    html += `
          </tbody>
        </table>
      </div>
    `;
    elements.psusaData.innerHTML = html;
  }

  function displayClinicalShortagesData(data, condition) {
    if (!elements.shortagesData || !data || data.length === 0) {
      showEmptyState(elements.shortagesData, `No shortage data found for ${condition}.`);
      return;
    }

    let html = `
      <div class="overflow-x-auto">
        <h2 class="text-lg font-semibold mb-2">Shortages for ${condition}</h2>
        <table class="ema-data-table">
          <thead>
            <tr>
              <th>Medicine</th>
              <th>Reason</th>
              <th>Status</th>
              <th>Date</th>
              <th>Details</th>
            </tr>
          </thead>
          <tbody>
    `;

    data.forEach(item => {
      const medicine = item.Shortage || item._1 || 'Unknown';
      const reason = findFieldInItem(item, ['reason', '_4', '_5']) || 'Not specified';
      const status = findFieldInItem(item, ['status', '_6', '_7']) || 'Unknown';
      const date = findFieldInItem(item, ['date', '_8', '_9']) || 'Unknown';
      const emaLink = findFieldInItem(item, ['_13', '_14', '_15']) || '';

      let statusClass = 'bg-gray-100 text-gray-800';
      if (status.toLowerCase().includes('ongoing')) {
        statusClass = 'bg-red-100 text-red-800';
      } else if (status.toLowerCase().includes('resolved')) {
        statusClass = 'bg-green-100 text-green-800';
      } else if (status.toLowerCase().includes('expected')) {
        statusClass = 'bg-yellow-100 text-yellow-800';
      }

      html += `
        <tr>
          <td>
            <div class="font-medium">${medicine}</div>
          </td>
          <td>${reason}</td>
          <td>
            <span class="px-2 py-1 rounded-full text-xs font-medium ${statusClass}">
              ${status}
            </span>
          </td>
          <td>${formatDate(date)}</td>
          <td>
            ${emaLink ? `<a href="${emaLink}" target="_blank" class="text-blue-600 hover:underline">EMA Page</a>` : 'N/A'}
          </td>
        </tr>
      `;
    });

    html += `
          </tbody>
        </table>
      </div>
    `;
    elements.shortagesData.innerHTML = html;
  }

  function displayClinicalReferralsData(data, condition) {
    if (!elements.referralsData || !data || data.length === 0) {
      showEmptyState(elements.referralsData, `No referral data found for ${condition}.`);
      return;
    }

    let html = `
      <div class="overflow-x-auto">
        <h2 class="text-lg font-semibold mb-2">Referrals for ${condition}</h2>
        <table class="ema-data-table">
          <thead>
            <tr>
              <th>Medicine</th>
              <th>Substance</th>
              <th>Status</th>
              <th>Date</th>
              <th>Details</th>
            </tr>
          </thead>
          <tbody>
    `;

    data.forEach(item => {
      const medicine = item._1 || 'Unknown';
      const substance = item._2 || 'Not specified';
      const status = item._3 || 'Unknown';
      const procedure = item._9 || '';
      const date = findFieldInItem(item, ['_17', '_18', '_19']) || 'Unknown';
      const emaLink = item._21 || '';

      let statusClass = 'bg-gray-100 text-gray-800';
      if (status.toLowerCase().includes('final') || status.toLowerCase().includes('concluded')) {
        statusClass = 'bg-green-100 text-green-800';
      } else if (status.toLowerCase().includes('ongoing')) {
        statusClass = 'bg-yellow-100 text-yellow-800';
      }

      html += `
        <tr>
          <td>
            <div class="font-medium">${medicine}</div>
          </td>
          <td>${substance}</td>
          <td>
            <span class="px-2 py-1 rounded-full text-xs font-medium ${statusClass}">
              ${status}
            </span>
          </td>
          <td>${formatDate(date)}</td>
          <td>
            ${procedure ? `<div class="text-xs text-gray-600 mb-1">Procedure: ${procedure}</div>` : ''}
            ${emaLink ? `<a href="${emaLink}" target="_blank" class="text-blue-600 hover:underline">EMA Page</a>` : 'N/A'}
          </td>
        </tr>
      `;
    });

    html += `
          </tbody>
        </table>
      </div>
    `;
    elements.referralsData.innerHTML = html;
  }

  // Helper functions (mostly unchanged)
  function showSection(show = true) {
    if (elements.section) {
      elements.section.classList.toggle('hidden', !show);
    }
  }

  function toggleAdminSection(show = false) {
    if (elements.dataAdmin) {
      elements.dataAdmin.classList.toggle('hidden', !show);
    }
  }

  async function checkEmaDataStatus() {
    try {
      showLoadingState(elements.lastUpdated, true);
      const response = await fetch('/api/ema/status');
      const data = await response.json();
      if (response.ok) {
        updateLastUpdated(data.status);
      } else {
        showError('Error checking EMA data status');
        console.error('Error checking EMA data status:', data.error);
      }
      showLoadingState(elements.lastUpdated, false);
    } catch (error) {
      showError('Error connecting to server');
      console.error('Error checking EMA data status:', error);
      showLoadingState(elements.lastUpdated, false);
    }
  }

  function updateLastUpdated(statusData) {
    if (!elements.lastUpdated) return;
    let lastUpdateDate = null;
    for (const dataType in statusData) {
      if (statusData[dataType].available && statusData[dataType].lastUpdated) {
        const updateDate = new Date(statusData[dataType].lastUpdated);
        if (!lastUpdateDate || updateDate > lastUpdateDate) {
          lastUpdateDate = updateDate;
        }
      }
    }
    elements.lastUpdated.textContent = lastUpdateDate 
      ? `Last updated: ${formatDate(lastUpdateDate)}` 
      : 'Data not yet available';
  }

  async function refreshEmaData() {
    try {
      if (!elements.refreshBtn) return;
      elements.refreshBtn.disabled = true;
      elements.refreshBtn.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" class="animate-spin h-4 w-4 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
        </svg>
        Refreshing...
      `;
      const response = await fetch('/api/ema/refresh', { method: 'POST' });
      const data = await response.json();
      if (response.ok) {
        updateLastUpdated(data.status);
        showToast('EMA data refreshed successfully', 'success');
      } else {
        showError('Error refreshing EMA data');
        console.error('Error refreshing EMA data:', data.error);
      }
      elements.refreshBtn.disabled = false;
      elements.refreshBtn.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
        </svg>
        Refresh
      `;
    } catch (error) {
      showError('Error connecting to server');
      console.error('Error refreshing EMA data:', error);
      if (elements.refreshBtn) {
        elements.refreshBtn.disabled = false;
        elements.refreshBtn.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
          </svg>
          Refresh
        `;
      }
    }
  }

  async function uploadFile(fileType, file) {
    if (!file) {
      showUploadStatus('Please select a file', 'error');
      return;
    }
    try {
      const formData = new FormData();
      formData.append('file', file);
      showUploadStatus('Uploading file...', 'loading');
      const response = await fetch(`/api/ema/upload/${fileType}`, {
        method: 'POST',
        body: formData
      });
      const data = await response.json();
      if (response.ok) {
        showUploadStatus(`File uploaded successfully. Processed ${data.records} records.`, 'success');
        if (fileType === 'dhpc' && elements.dhpcFileInput) elements.dhpcFileInput.value = '';
        else if (fileType === 'psusa' && elements.psusaFileInput) elements.psusaFileInput.value = '';
        else if (fileType === 'shortages' && elements.shortagesFileInput) elements.shortagesFileInput.value = '';
        else if (fileType === 'medicines' && elements.medicinesFileInput) elements.medicinesFileInput.value = '';
        else if (fileType === 'referrals' && elements.referralsFileInput) elements.referralsFileInput.value = '';
        checkEmaDataStatus();
      } else {
        showUploadStatus(`Error: ${data.error}`, 'error');
        console.error('Error uploading file:', data.error);
      }
    } catch (error) {
      showUploadStatus('Error connecting to server', 'error');
      console.error('Error uploading file:', error);
    }
  }

  function showUploadStatus(message, type = 'info') {
    if (!elements.uploadStatus) return;
    let bgColor = 'bg-blue-50', textColor = 'text-blue-800', icon = `
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
    `;
    if (type === 'success') {
      bgColor = 'bg-green-50'; textColor = 'text-green-800'; icon = `
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
        </svg>
      `;
    } else if (type === 'error') {
      bgColor = 'bg-red-50'; textColor = 'text-red-800'; icon = `
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
      `;
    } else if (type === 'loading') {
      bgColor = 'bg-blue-50'; textColor = 'text-blue-800'; icon = `
        <svg xmlns="http://www.w3.org/2000/svg" class="animate-spin h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
        </svg>
      `;
    }
    elements.uploadStatus.innerHTML = `
      <div class="flex items-center p-4 ${bgColor} ${textColor} rounded-lg">
        ${icon}
        <span>${message}</span>
      </div>
    `;
    elements.uploadStatus.classList.remove('hidden');
    if (type === 'success') setTimeout(() => elements.uploadStatus.classList.add('hidden'), 5000);
  }

  function updateCounter(element, count, singular, plural) {
    if (!element) return;
    element.textContent = `${count} ${count === 1 ? singular : plural}`;
  }

  function showLoadingState(element, isText = false) {
    if (!element) return;
    if (isText) {
      element.innerHTML = `<span class="animate-pulse">Loading...</span>`;
    } else {
      element.innerHTML = `
        <div class="ema-loading-state">
          <svg xmlns="http://www.w3.org/2000/svg" class="animate-spin h-8 w-8 text-blue-500 mx-auto mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
          </svg>
          <p class="text-center text-gray-500">Loading data...</p>
        </div>
      `;
    }
  }

  function showEmptyState(element, message) {
    if (!element) return;
    element.innerHTML = `
      <div class="ema-empty-state">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gray-400 mx-auto mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
        </svg>
        <p class="text-center text-gray-500">${message}</p>
      </div>
    `;
  }

  function formatDate(dateString) {
    if (!dateString) return 'Unknown';
    try {
      const date = new Date(dateString);
      if (isNaN(date.getTime())) return dateString;
      return date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
    } catch (error) {
      return dateString;
    }
  }

  function formatTherapeuticArea(area) {
    if (!area) return 'Not specified';
    const areas = area.split(',').map(a => a.trim()).filter(a => a);
    if (areas.length === 0) return 'Not specified';
    return areas.map(a => `
      <span class="inline-block px-2 py-1 text-xs font-medium bg-blue-50 text-blue-700 rounded-full mb-1 mr-1">
        ${a}
      </span>
    `).join('');
  }

  function findFieldInItem(item, possibleKeys) {
    for (const key of possibleKeys) {
      if (item[key] !== undefined && item[key] !== null && item[key] !== '') {
        return item[key];
      }
    }
    for (let i = 0; i < 40; i++) {
      const key = `_${i}`;
      if (item[key] !== undefined && item[key] !== null && item[key] !== '') {
        const value = item[key].toString().toLowerCase();
        if (possibleKeys.includes('date') && (value.includes('/') || value.match(/\d{2}\.\d{2}\.\d{4}/))) {
          return item[key];
        }
        if (possibleKeys.includes('status') && 
            (value.includes('authorised') || value.includes('withdrawn') || 
             value.includes('ongoing') || value.includes('resolved'))) {
          return item[key];
        }
        if (possibleKeys.includes('reason') && 
            value.length > 10 && (value.includes('due to') || value.includes('because'))) {
          return item[key];
        }
      }
    }
    return null;
  }

  function showError(message) {
    showToast(message, 'error');
  }

  function showToast(message, type = 'info') {
    let toastContainer = document.getElementById('toast-container');
    if (!toastContainer) {
      toastContainer = document.createElement('div');
      toastContainer.id = 'toast-container';
      toastContainer.className = 'fixed bottom-4 right-4 z-50 flex flex-col space-y-2';
      document.body.appendChild(toastContainer);
    }
    const toast = document.createElement('div');
    let bgColor = 'bg-blue-500', icon = `
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
    `;
    if (type === 'success') {
      bgColor = 'bg-green-500'; icon = `
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
        </svg>
      `;
    } else if (type === 'error') {
      bgColor = 'bg-red-500'; icon = `
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
      `;
    }
    toast.className = `flex items-center p-3 rounded-lg text-white ${bgColor} shadow-lg transition-opacity duration-500`;
    toast.innerHTML = `
      ${icon}
      <span>${message}</span>
      <button class="ml-4 text-white focus:outline-none hover:text-gray-200">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    `;
    const closeButton = toast.querySelector('button');
    closeButton.addEventListener('click', () => {
      toast.style.opacity = '0';
      setTimeout(() => toastContainer.removeChild(toast), 500);
    });
    toastContainer.appendChild(toast);
    setTimeout(() => {
      if (toast.parentNode === toastContainer) {
        toast.style.opacity = '0';
        setTimeout(() => {
          if (toast.parentNode === toastContainer) toastContainer.removeChild(toast);
        }, 500);
      }
    }, 5000);
  }

  function addTableStyles() {
    const styleId = 'ema-data-table-styles';
    if (document.getElementById(styleId)) return;
    const styleElement = document.createElement('style');
    styleElement.id = styleId;
    styleElement.textContent = `
      .ema-data-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
      }
      .ema-data-table th {
        background-color: #f8fafc;
        padding: 0.75rem;
        text-align: left;
        font-weight: 600;
        font-size: 0.875rem;
        color: #4b5563;
        border-bottom: 1px solid #e5e7eb;
      }
      .ema-data-table td {
        padding: 0.75rem;
        border-bottom: 1px solid #e5e7eb;
      }
      .ema-data-table tbody tr:hover {
        background-color: #f9fafb;
      }
      .ema-empty-state, .ema-loading-state {
        padding: 2rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 200px;
      }
    `;
    document.head.appendChild(styleElement);
  }

  // Export functions
  return {
    init,
    searchCondition, // New function for condition-based search
    showSection,
    toggleAdminSection,
    refreshEmaData,
    checkEmaDataStatus
    // Note: Removed searchDrug since this is now condition-focused
  };
})();

// Example usage




function addExtendedTableStyles() {
  const styleId = 'ema-extended-table-styles';
  
  // Check if styles already exist
  if (document.getElementById(styleId)) {
    return;
  }
  
  const styleElement = document.createElement('style');
  styleElement.id = styleId;
  styleElement.textContent = `
    .ema-data-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
    }
    
    .ema-data-table th {
      background-color: #f8fafc;
      padding: 0.75rem;
      text-align: left;
      font-weight: 600;
      font-size: 0.875rem;
      color: #4b5563;
      border-bottom: 1px solid #e5e7eb;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    .ema-data-table td {
      padding: 0.75rem;
      border-bottom: 1px solid #e5e7eb;
      vertical-align: top;
    }
    
    .ema-data-table tbody tr:hover {
      background-color: #f9fafb;
    }
    
    .ema-empty-state, .ema-loading-state {
      padding: 2rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 200px;
    }
    
    .ema-data-container {
      max-height: 500px;
      overflow-y: auto;
      border: 1px solid #e5e7eb;
      border-radius: 0.375rem;
    }
    
    /* Adjust the detail sections */
    .text-xs.text-gray-600 {
      max-width: 300px;
      white-space: normal;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
    }
    
    /* Make the headers sticky */
    .ema-data-container {
      position: relative;
    }
  `;
  
  document.head.appendChild(styleElement);
}
// Initialize the module when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
  // Add table styles
 
  EmaDataModule.addTableStyles = function() {
    const styleId = 'ema-data-table-styles';
    
    // Check if styles already exist
    if (document.getElementById(styleId)) {
      return;
    }
    
    const styleElement = document.createElement('style');
    styleElement.id = styleId;
    styleElement.textContent = `
      .ema-data-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
      }
      
      .ema-data-table th {
        background-color: #f8fafc;
        padding: 0.75rem;
        text-align: left;
        font-weight: 600;
        font-size: 0.875rem;
        color: #4b5563;
        border-bottom: 1px solid #e5e7eb;
      }
      
      .ema-data-table td {
        padding: 0.75rem;
        border-bottom: 1px solid #e5e7eb;
      }
      
      .ema-data-table tbody tr:hover {
        background-color: #f9fafb;
      }
      
      .ema-empty-state, .ema-loading-state {
        padding: 2rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 200px;
      }
    `;
    
    document.head.appendChild(styleElement);
  };
  
  // Add table styles
  EmaDataModule.addTableStyles();
  addExtendedTableStyles()
  // Initialize the module

  
  // Show admin panel for development (remove in production)
  EmaDataModule.toggleAdminSection(false);
  
});



const PubMedModule = (function() {
 const elements = {
    // Main containers
    pubmedSection: safeGetElement('pubmedSection'),
    pubmedLoading: safeGetElement('pubmedLoading'),
    pubmedError: safeGetElement('pubmedError'),
    pubmedErrorMessage: safeGetElement('pubmedErrorMessage'),
    pubmedEmpty: safeGetElement('pubmedEmpty'),
    
    // Search related elements
    pubmedSearchBox: safeGetElement('pubmedSearchBox'),
    pubmedLocalSearchBox: safeGetElement('pubmedLocalSearchBox'),
    pubmedLocalSearchButton: safeGetElement('pubmedLocalSearchButton'),
    pubmedSearchByCondition: safeGetElement('pubmedSearchByCondition'),
    pubmedSearchByDrug: safeGetElement('pubmedSearchByDrug'),
    pubmedAdvancedToggle: safeGetElement('pubmedAdvancedToggle'),
    pubmedAdvancedOptions: safeGetElement('pubmedAdvancedOptions'),
    
    // Filter and sorting elements
    pubmedSort: safeGetElement('pubmedSort'),
    pubmedFullTextOnly: safeGetElement('pubmedFullTextOnly'),
    pubmedYearFilter: safeGetElement('pubmedYearFilter'),
    pubmedYearRange: safeGetElement('pubmedYearRange'),
    pubmedJournalFilter: safeGetElement('pubmedJournalFilter'),
    
    // Results elements
    pubmedArticles: safeGetElement('pubmedArticles'),
    pubmedArticlesList: safeGetElement('pubmedArticlesList'),
    pubmedResultCount: safeGetElement('pubmedResultCount'),
    pubmedLoadMore: safeGetElement('pubmedLoadMore'),
    pubmedPagination: safeGetElement('pubmedPagination'),
    
    // Treatment results (replaces summary)
    pubmedTreatments: safeGetElement('pubmedTreatments'),
    pubmedTreatmentsLoading: safeGetElement('pubmedTreatmentsLoading'),
    pubmedTreatmentsContent: safeGetElement('pubmedTreatmentsContent'),
    
    // Drug information results
    pubmedDrugInfo: safeGetElement('pubmedDrugInfo'),
    pubmedDrugInfoLoading: safeGetElement('pubmedDrugInfoLoading'),
    pubmedDrugInfoContent: safeGetElement('pubmedDrugInfoContent'),
    
    // Rare condition input
    pubmedRareConditionInput: safeGetElement('pubmedRareConditionInput'),
    pubmedAddRareCondition: safeGetElement('pubmedAddRareCondition')
  };

  // State management for the module
  let state = {
    term: '',
    searchType: 'general', // 'general', 'condition', or 'drug'
    articles: [],         // All articles from API
    displayedArticles: [], // Articles currently shown in the UI
    filteredArticles: [], // Articles filtered by local search
    currentPage: 1,
    pageSize: 5,          // Number of articles to show per page
    totalResults: 0,
    isLoading: false,  
    sortBy: 'relevance',
    fullTextOnly: false,
    yearFilter: '',
    yearRange: 5,         // Default to last 5 years
    journalFilter: '',
    localSearchTerm: '',  // For searching within retrieved articles
    medicalDatabase: {
      conditions: [],
      drugs: [],
      conditionDrugMap: {},
      drugConditionMap: {},
      drugClasses: {},
      articleEvidence: {},
      recentUpdated: null
    }
  };

  // Common drug classes for classification
  const drugClasses = {
    "Antibiotics": ["penicillin", "amoxicillin", "azithromycin", "ciprofloxacin", "doxycycline", "vancomycin"],
    "Antidepressants": ["fluoxetine", "sertraline", "escitalopram", "bupropion", "venlafaxine", "trazodone"],
    "Antihypertensives": ["lisinopril", "losartan", "amlodipine", "hydrochlorothiazide", "metoprolol", "valsartan"],
    "Anti-inflammatories": ["ibuprofen", "naproxen", "celecoxib", "prednisone", "dexamethasone", "methylprednisolone"],
    "Antidiabetics": ["metformin", "insulin", "glipizide", "sitagliptin", "empagliflozin", "liraglutide"],
    "Anticoagulants": ["warfarin", "apixaban", "rivaroxaban", "dabigatran", "heparin", "enoxaparin"],
    "Antipsychotics": ["risperidone", "olanzapine", "quetiapine", "aripiprazole", "haloperidol", "clozapine"],
    "Anticonvulsants": ["levetiracetam", "lamotrigine", "valproic acid", "carbamazepine", "phenytoin", "gabapentin"],
    "Biologics": ["adalimumab", "etanercept", "infliximab", "ustekinumab", "secukinumab", "rituximab"],
    "Statins": ["atorvastatin", "simvastatin", "rosuvastatin", "pravastatin", "lovastatin", "fluvastatin"],
    "Bronchodilators": ["albuterol", "salmeterol", "formoterol", "tiotropium", "ipratropium", "theophylline"],
    "Antihistamines": ["loratadine", "cetirizine", "fexofenadine", "diphenhydramine", "hydroxyzine", "desloratadine"],
    "Proton Pump Inhibitors": ["omeprazole", "esomeprazole", "pantoprazole", "lansoprazole", "rabeprazole", "dexlansoprazole"],
    "Opioid Analgesics": ["morphine", "oxycodone", "hydrocodone", "tramadol", "fentanyl", "codeine"],
    "Immunosuppressants": ["cyclosporine", "tacrolimus", "mycophenolate", "azathioprine", "sirolimus", "methotrexate"],
    "Chemotherapy": ["cisplatin", "carboplatin", "doxorubicin", "paclitaxel", "fluorouracil", "gemcitabine"],
    "Psychedelics": ["psilocybin", "ketamine", "esketamine", "MDMA", "LSD", "DMT", "ayahuasca"]
  };

  // Known medical conditions to improve detection accuracy and prioritize meaningful conditions
  const knownMedicalConditions = [
    "Diabetes", "Hypertension", "Asthma", "COPD", "Alzheimer's", "Parkinson's", 
    "Multiple Sclerosis", "HIV/AIDS", "Rheumatoid Arthritis", "Osteoarthritis",
    "Depression", "Major Depressive Disorder", "Treatment-Resistant Depression",
    "Anxiety", "Bipolar Disorder", "Schizophrenia", "Cancer", 
    "Leukemia", "Lymphoma", "Heart Disease", "Stroke", "Epilepsy", "Migraine",
    "Psoriasis", "Eczema", "Crohn's Disease", "Ulcerative Colitis", "Celiac Disease",
    "Hypothyroidism", "Hyperthyroidism", "Lupus", "Fibromyalgia", "Chronic Fatigue Syndrome",
    "Irritable Bowel Syndrome", "Osteoporosis", "Gout", "Hepatitis", "Cirrhosis",
    "Kidney Disease", "Anemia", "Glaucoma", "Macular Degeneration", "Influenza",
    "Pneumonia", "Tuberculosis", "Malaria", "COVID-19"
  ];

  // Common medications with standardized naming to avoid variants
  const knownMedications = [
    "Psilocybin", "Ketamine", "Esketamine", "MDMA", "LSD", "DMT", "Ayahuasca",
    "Fluoxetine", "Sertraline", "Escitalopram", "Venlafaxine", "Bupropion",
    "Lithium", "Lamotrigine", "Valproate", "Carbamazepine", "Aripiprazole",
    "Olanzapine", "Quetiapine", "Risperidone", "Metformin", "Insulin",
    "Aspirin", "Ibuprofen", "Naproxen", "Acetaminophen", "Prednisone",
    "Lisinopril", "Losartan", "Amlodipine", "Hydrochlorothiazide", "Metoprolol",
    "Atorvastatin", "Simvastatin", "Rosuvastatin", "Levothyroxine",
    "Albuterol", "Fluticasone", "Montelukast", "Omeprazole", "Pantoprazole",
    "Warfarin", "Apixaban", "Rivaroxaban", "Clopidogrel", "Methotrexate",
    "Adalimumab", "Infliximab", "Rituximab", "Trastuzumab", "Pembrolizumab"
  ];

  // Words that should be excluded from treatment detection (common false positives)
  const treatmentExclusionWords = [
    "the", "and", "with", "for", "treatment", "therapy", "patient", "patients",
    "study", "studies", "clinical", "trials", "trial", "participants", "group",
    "groups", "analysis", "results", "baseline", "outcome", "outcomes", "data",
    "weeks", "days", "months", "years", "following", "after", "before", "during",
    "approach", "approaches", "intervention", "interventions", "method", "methods",
    "significant", "significantly", "effective", "effectiveness", "efficacy",
    "response", "responses", "compared", "comparison", "versus", "vs", "control",
    "placebo", "improvement", "improvements", "reduction", "increase", "decrease",
    "assessment", "assessments", "measure", "measures", "score", "scores",
    "symptom", "symptoms", "disorder", "disorders", "disease", "diseases",
    "syndrome", "syndromes", "subsequent", "subsequent", "protocol", "protocols",
    "moderate", "severe", "mild", "acute", "chronic", "food", "drug", "active",
    "sham", "determine", "worldwide", "standard", "based", "health", "medicine",
    "care", "medical", "those", "these", "they", "were", "have", "has", "had",
    "this", "that", "which", "what", "when", "where", "who", "whom", "whose",
    "how", "why", "because", "since", "although", "though", "despite", "however",
    "therefore", "hence", "thus", "consequently", "accordingly", "so", "then",
    "research", "review", "meta-analysis", "report", "article", "paper", "evidence"
  ];

  // Utility function to show/hide components
  function showComponent(component, isVisible) {
    if (!component) return;
    
    if (isVisible) {
      component.classList.remove('hidden');
    } else {
      component.classList.add('hidden');
    }
  }
  
  // Utility function to format date
  function formatDate(dateString) {
    if (!dateString) return 'N/A';
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
  }

  // Improved function to detect conditions from text using medical terminology
  function extractConditions(article) {
    const text = (article.title + ' ' + article.abstract).toLowerCase();
    let extractedConditions = [];
    
    // First check for known medical conditions
    knownMedicalConditions.forEach(condition => {
      const conditionLower = condition.toLowerCase();
      if (text.includes(conditionLower)) {
        if (!extractedConditions.includes(condition)) {
          extractedConditions.push(condition);
        }
      }
    });
    
    // MeSH terms (if present) are very reliable for conditions
    if (article.meshTerms && Array.isArray(article.meshTerms)) {
      article.meshTerms.forEach(term => {
        if (
          term.includes('Disease') || 
          term.includes('Syndrome') || 
          term.includes('Disorder') || 
          term.includes('Condition') ||
          term.includes('Infection')
        ) {
          if (!extractedConditions.includes(term)) {
            extractedConditions.push(term);
          }
        }
      });
    }
    
    // Keywords are often a good source of conditions
    if (article.keywords && Array.isArray(article.keywords)) {
      article.keywords.forEach(keyword => {
        const keywordLower = keyword.toLowerCase();
        
        // Keywords with these terms are likely conditions
        if (
          keywordLower.includes('disease') || 
          keywordLower.includes('syndrome') || 
          keywordLower.includes('disorder') || 
          keywordLower.includes('condition') ||
          keywordLower.includes('deficiency') ||
          keywordLower.includes('cancer') ||
          keywordLower.includes('infection')
        ) {
          // Don't add if it's just a single word (like "syndrome" or "disease" alone)
          if (keyword.split(' ').length > 1 && !extractedConditions.includes(keyword)) {
            const formattedKeyword = keyword.replace(/\b\w/g, c => c.toUpperCase());
            extractedConditions.push(formattedKeyword);
          }
        }
      });
    }
    
    // Filter out conditions that are too short or contain treatment exclusion words
    extractedConditions = extractedConditions.filter(condition => {
      // Must be at least 4 characters 
      if (condition.length < 4) return false;
      
      // Check for exclusion words (if the condition is ONLY an exclusion word)
      const conditionLower = condition.toLowerCase();
      if (treatmentExclusionWords.includes(conditionLower)) return false;
      
      return true;
    });
    
    return [...new Set(extractedConditions)]; // Remove duplicates
  }

  // Improved function to extract drugs/treatments from text
  function extractDrugs(article) {
    const text = (article.title + ' ' + article.abstract).toLowerCase();
    let extractedDrugs = [];
    
    // First check for known medications
    knownMedications.forEach(medication => {
      const medicationLower = medication.toLowerCase();
      // Use word boundary to avoid partial matches
      const regex = new RegExp(`\\b${medicationLower}\\b`, 'i');
      if (regex.test(text)) {
        if (!extractedDrugs.includes(medication)) {
          extractedDrugs.push(medication);
        }
      }
    });
    
    // Check for specific drug class mentions
    Object.entries(drugClasses).forEach(([className, drugs]) => {
      // Check for the class name itself (only if it's a proper class name)
      if (/^[A-Z]/.test(className) && text.includes(className.toLowerCase())) {
        if (!extractedDrugs.includes(className)) {
          extractedDrugs.push(className);
        }
      }
      
      // Check for specific drugs in this class
      drugs.forEach(drug => {
        if (new RegExp(`\\b${drug}\\b`, 'i').test(text)) {
          // Format: capitalize first letter
          const formattedDrug = drug.charAt(0).toUpperCase() + drug.slice(1);
          if (!extractedDrugs.includes(formattedDrug)) {
            extractedDrugs.push(formattedDrug);
          }
        }
      });
    });
    
    // Check keywords for drug mentions
    if (article.keywords && Array.isArray(article.keywords)) {
      article.keywords.forEach(keyword => {
        const keywordLower = keyword.toLowerCase();
        
        // Keywords with these terms are likely treatments
        if (
          keywordLower.includes('therapy') || 
          keywordLower.includes('treatment') || 
          keywordLower.includes('medication') || 
          keywordLower.includes('drug') ||
          keywordLower.includes('inhibitor') ||
          keywordLower.includes('antagonist')
        ) {
          // Don't add if it's just a single word that's in the exclusion list
          if (
            keyword.split(' ').length > 1 &&
            !treatmentExclusionWords.includes(keywordLower) &&
            !extractedDrugs.includes(keyword)
          ) {
            const formattedKeyword = keyword.replace(/\b\w/g, c => c.toUpperCase());
            extractedDrugs.push(formattedKeyword);
          }
        }
      });
    }
    
    // Filter out drugs that are too short or contain treatment exclusion words
    extractedDrugs = extractedDrugs.filter(drug => {
      // Must be at least 3 characters 
      if (drug.length < 3) return false;
      
      // Check for exclusion words (if the drug is ONLY an exclusion word)
      const drugLower = drug.toLowerCase();
      if (treatmentExclusionWords.includes(drugLower)) return false;
      
      return true;
    });
    
    return [...new Set(extractedDrugs)]; // Remove duplicates
  }

  // Improved function to map conditions to drugs based on proximity and context
  function mapConditionsToDrugs(article, conditions, drugs) {
    const text = (article.title + ' ' + article.abstract).toLowerCase();
    const conditionDrugMap = {};
    const drugConditionMap = {};
    
    // Initialize maps
    conditions.forEach(condition => conditionDrugMap[condition] = []);
    drugs.forEach(drug => drugConditionMap[drug] = []);
    
    // Look for explicit mentions of treatments for conditions
    conditions.forEach(condition => {
      const conditionLower = condition.toLowerCase();
      
      // Skip condition if it's in the treatment exclusion words
      if (treatmentExclusionWords.includes(conditionLower)) return;
      
      // Check for phrases like "X for treatment of Y" or "X in patients with Y"
      drugs.forEach(drug => {
        const drugLower = drug.toLowerCase();
        
        // Skip drug if it's in the treatment exclusion words
        if (treatmentExclusionWords.includes(drugLower)) return;
        
        // Check various patterns of drug-condition relationships
        const patterns = [
          new RegExp(`${drugLower}\\s+(?:for|in|to treat|in (?:the )?treatment of|used for)\\s+(?:patients with )?${conditionLower}`, 'i'),
          new RegExp(`${conditionLower}\\s+(?:treated with|receiving|using|responded to)\\s+${drugLower}`, 'i'),
          new RegExp(`(?:efficacy|effectiveness|use|administration) of\\s+${drugLower}\\s+(?:in|for)\\s+${conditionLower}`, 'i')
        ];
        
        // Check if any patterns match
        const hasDirectRelation = patterns.some(pattern => pattern.test(text));
        
        if (hasDirectRelation) {
          // Strong evidence of relationship - add to maps
          if (!conditionDrugMap[condition].includes(drug)) {
            conditionDrugMap[condition].push(drug);
          }
          if (!drugConditionMap[drug].includes(condition)) {
            drugConditionMap[drug].push(condition);
          }
        } else {
          // Check for proximity as a fallback
          const conditionIndex = text.indexOf(conditionLower);
          const drugIndex = text.indexOf(drugLower);
          
          if (conditionIndex !== -1 && drugIndex !== -1) {
            // If drug and condition are "close" to each other (within 100 chars)
            if (Math.abs(drugIndex - conditionIndex) < 100) {
              // Add to maps if not already present
              if (!conditionDrugMap[condition].includes(drug)) {
                conditionDrugMap[condition].push(drug);
              }
              if (!drugConditionMap[drug].includes(condition)) {
                drugConditionMap[drug].push(condition);
              }
            }
          }
        }
      });
    });
    
    // For each condition-drug pair, collect evidence
    Object.entries(conditionDrugMap).forEach(([condition, mappedDrugs]) => {
      mappedDrugs.forEach(drug => {
        const evidenceKey = `${condition}|||${drug}`;
        if (!state.medicalDatabase.articleEvidence[evidenceKey]) {
          state.medicalDatabase.articleEvidence[evidenceKey] = [];
        }
        
        // Add this article as evidence if not already present
        const alreadyAdded = state.medicalDatabase.articleEvidence[evidenceKey].some(
          evidence => evidence.pmid === article.pmid
        );
        
        if (!alreadyAdded) {
          state.medicalDatabase.articleEvidence[evidenceKey].push({
            pmid: article.pmid,
            title: article.title,
            date: article.pubDate,
            journal: article.journal,
            excerpt: findRelevantExcerpt(text, condition, drug)
          });
        }
      });
    });
    
    return { conditionDrugMap, drugConditionMap };
  }
  
  // Find relevant text excerpt that mentions both condition and drug
  function findRelevantExcerpt(text, condition, drug) {
    const conditionLower = condition.toLowerCase();
    const drugLower = drug.toLowerCase();
    
    // Find positions
    const conditionIndex = text.indexOf(conditionLower);
    const drugIndex = text.indexOf(drugLower);
    
    if (conditionIndex === -1 || drugIndex === -1) return ""; // Not found
    
    // Find the sentence that contains both terms if possible
    const sentences = text.match(/[^.!?]+[.!?]+/g) || [];
    
    for (const sentence of sentences) {
      if (sentence.toLowerCase().includes(conditionLower) && 
          sentence.toLowerCase().includes(drugLower)) {
        return sentence.trim();
      }
    }
    
    // If no sentence contains both, extract a snippet around the mentions
    const start = Math.min(conditionIndex, drugIndex);
    const end = Math.max(conditionIndex + conditionLower.length, drugIndex + drugLower.length);
    
    // Include more context
    const excerptStart = Math.max(0, start - 50);
    const excerptEnd = Math.min(text.length, end + 50);
    
    return text.substring(excerptStart, excerptEnd).trim() + "...";
  }

  // Process articles to extract medical knowledge
  function processMedicalKnowledge(articles) {
    let updatedDatabase = {
      conditions: [...state.medicalDatabase.conditions],
      drugs: [...state.medicalDatabase.drugs],
      conditionDrugMap: {...state.medicalDatabase.conditionDrugMap},
      drugConditionMap: {...state.medicalDatabase.drugConditionMap},
      drugClasses: {...state.medicalDatabase.drugClasses},
      articleEvidence: {...state.medicalDatabase.articleEvidence},
      recentUpdated: new Date().toISOString()
    };
    
    articles.forEach(article => {
      // Extract conditions and drugs
      const conditions = extractConditions(article);
      const drugs = extractDrugs(article);
      
      // Skip if no conditions or drugs found
      if (conditions.length === 0 || drugs.length === 0) return;
      
      // Map conditions to drugs and vice versa
      const { conditionDrugMap, drugConditionMap } = mapConditionsToDrugs(article, conditions, drugs);
      
      // Update database with new conditions
      conditions.forEach(condition => {
        if (!updatedDatabase.conditions.includes(condition)) {
          updatedDatabase.conditions.push(condition);
        }
        
        // Initialize or merge condition-drug mapping
        if (!updatedDatabase.conditionDrugMap[condition]) {
          updatedDatabase.conditionDrugMap[condition] = [];
        }
        
        // Add drugs for this condition
        if (conditionDrugMap[condition]) {
          conditionDrugMap[condition].forEach(drug => {
            if (!updatedDatabase.conditionDrugMap[condition].includes(drug)) {
              updatedDatabase.conditionDrugMap[condition].push(drug);
            }
          });
        }
      });
      
      // Update database with new drugs
      drugs.forEach(drug => {
        if (!updatedDatabase.drugs.includes(drug)) {
          updatedDatabase.drugs.push(drug);
        }
        
        // Initialize or merge drug-condition mapping
        if (!updatedDatabase.drugConditionMap[drug]) {
          updatedDatabase.drugConditionMap[drug] = [];
        }
        
        // Add conditions for this drug
        if (drugConditionMap[drug]) {
          drugConditionMap[drug].forEach(condition => {
            if (!updatedDatabase.drugConditionMap[drug].includes(condition)) {
              updatedDatabase.drugConditionMap[drug].push(condition);
            }
          });
        }
        
        // Categorize drug into drug classes
        Object.entries(drugClasses).forEach(([className, classDrugs]) => {
          if (classDrugs.some(classDrug => drug.toLowerCase().includes(classDrug))) {
            if (!updatedDatabase.drugClasses[drug]) {
              updatedDatabase.drugClasses[drug] = [];
            }
            if (!updatedDatabase.drugClasses[drug].includes(className)) {
              updatedDatabase.drugClasses[drug].push(className);
            }
          }
        });
      });
    });
    
    return updatedDatabase;
  }

  // Create article element for display
  function createArticleElement(article) {
    const articleElement = document.createElement('div');
    articleElement.className = 'bg-white rounded-lg p-4 shadow-sm hover:shadow-md transition-shadow duration-200 mb-4 border border-gray-100';
    
    const hasDOI = article.doi && article.doi.trim() !== '';
    const hasFullText = article.fullTextUrl && article.fullTextUrl.trim() !== '';
    
    // Extract medical information
    const conditions = extractConditions(article);
    const drugs = extractDrugs(article);
    
    // Only show relevant medical findings based on search type
    let medicalFindings = '';
    if (conditions.length > 0 || drugs.length > 0) {
      medicalFindings = `
        <div class="border-t border-gray-100 mt-3 pt-3">
          ${conditions.length > 0 ? 
            `<div class="mb-2">
              <span class="text-xs font-medium text-gray-700">Conditions: </span>
              <div class="flex flex-wrap gap-1 mt-1">
                ${conditions.slice(0, 6).map(condition => 
                  `<span class="bg-blue-50 text-blue-700 text-xs px-2 py-1 rounded-full">${condition}</span>`
                ).join('')}
                ${conditions.length > 6 ? `<span class="text-xs text-gray-500">+${conditions.length - 6} more</span>` : ''}
              </div>
            </div>` : ''
          }
          ${drugs.length > 0 ? 
            `<div>
              <span class="text-xs font-medium text-gray-700">Treatments: </span>
              <div class="flex flex-wrap gap-1 mt-1">
                ${drugs.slice(0, 6).map(drug => 
                  `<span class="bg-green-50 text-green-700 text-xs px-2 py-1 rounded-full">${drug}</span>`
                ).join('')}
                ${drugs.length > 6 ? `<span class="text-xs text-gray-500">+${drugs.length - 6} more</span>` : ''}
              </div>
            </div>` : ''
          }
        </div>
      `;
    }
    
    articleElement.innerHTML = `
      <div class="flex justify-between">
        <h3 class="text-lg font-semibold text-gray-800 mb-2">${article.title}</h3>
      </div>
      <div class="text-sm text-gray-600 mb-2">
        ${article.authors.slice(0, 3).join(', ')}${article.authors.length > 3 ? ', et al.' : ''}
      </div>
      <div class="text-sm text-gray-500 mb-3 flex flex-wrap items-center gap-2">
        <span class="font-medium">${article.journal || 'Journal not specified'}</span>
        <span class="inline-block w-1 h-1 rounded-full bg-gray-300"></span>
        <span>${formatDate(article.pubDate)}</span>
        <span class="inline-block w-1 h-1 rounded-full bg-gray-300"></span>
        <span>PMID: ${article.pmid}</span>
      </div>
      <p class="text-gray-700 text-sm mb-3">${article.abstract.substring(0, 200)}${article.abstract.length > 200 ? '...' : ''}</p>
      ${article.keywords && article.keywords.length > 0 ? 
        `<div class="flex flex-wrap gap-1 mb-3">
          ${article.keywords.slice(0, 5).map(keyword => 
            `<span class="bg-gray-100 text-gray-700 text-xs px-2 py-1 rounded-full">${keyword}</span>`
          ).join('')}
          ${article.keywords.length > 5 ? `<span class="text-xs text-gray-500">+${article.keywords.length - 5} more</span>` : ''}
        </div>` : ''
      }
      ${medicalFindings}
      <div class="flex flex-wrap gap-2 mt-3">
        <a href="https://pubmed.ncbi.nlm.nih.gov/${article.pmid}" target="_blank" 
           class="text-primary hover:text-primary-dark text-sm flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
          </svg>
          View on PubMed
        </a>
        ${hasDOI ? 
          `<a href="https://doi.org/${article.doi}" target="_blank" 
              class="text-primary hover:text-primary-dark text-sm flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 015.656 0l4 4a4 4 0 01-5.656 5.656l-1.102-1.101" />
            </svg>
            DOI
          </a>` : ''
        }
        ${hasFullText ? 
          `<a href="${article.fullTextUrl}" target="_blank" 
              class="text-primary hover:text-primary-dark text-sm flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            Full Text
          </a>` : ''
        }
      </div>
    `;
    
    return articleElement;
  }

  // Filter articles by local search term
  function filterArticlesByLocalSearch(term) {
    if (!term || term.trim() === '') {
      state.filteredArticles = [...state.articles];
      return;
    }
    
    const searchTerm = term.toLowerCase().trim();
    
    state.filteredArticles = state.articles.filter(article => {
      // Search in title, abstract, and keywords
      const title = article.title ? article.title.toLowerCase() : '';
      const abstract = article.abstract ? article.abstract.toLowerCase() : '';
      const keywords = article.keywords ? article.keywords.join(' ').toLowerCase() : '';
      const authors = article.authors ? article.authors.join(' ').toLowerCase() : '';
      
      return (
        title.includes(searchTerm) || 
        abstract.includes(searchTerm) || 
        keywords.includes(searchTerm) ||
        authors.includes(searchTerm)
      );
    });
    
    // Update displayed articles with first batch of filtered articles
    state.displayedArticles = state.filteredArticles.slice(0, state.pageSize);
    
    // Render the filtered articles
    renderArticles();
  }

//   // Render articles in the list with pagination
//   function renderArticles() {
//     if (!elements.pubmedArticlesList) return;
    
//     elements.pubmedArticlesList.innerHTML = '';
    
//     // Calculate pagination
//     const startIndex = 0;
//     const endIndex = state.displayedArticles.length;
    
//     // Render only the articles for the current page
//     state.displayedArticles.slice(startIndex, endIndex).forEach(article => {
//       const articleElement = createArticleElement(article);
//       elements.pubmedArticlesList.appendChild(articleElement);
//     });
    
//     if (elements.pubmedResultCount) {
//       if (state.localSearchTerm && state.localSearchTerm.trim() !== '') {
//         elements.pubmedResultCount.textContent = `${state.totalResults} articles found (showing ${state.displayedArticles.length} of ${state.filteredArticles.length} matching "${state.localSearchTerm}")`;
//       } else {
//         elements.pubmedResultCount.textContent = `${state.totalResults} articles found (showing ${state.displayedArticles.length})`;
//       }
//     }
    
//     // Show/hide load more button based on whether there are more results
//     const hasMoreResults = state.filteredArticles.length > state.displayedArticles.length || 
//                           state.displayedArticles.length < state.totalResults;
    
//     showComponent(elements.pubmedPagination, hasMoreResults);
    
//     if (elements.pubmedLoadMore) {
//       const remainingCount = Math.min(
//         state.filteredArticles.length - state.displayedArticles.length,
//         state.totalResults - state.displayedArticles.length
//       );
//       elements.pubmedLoadMore.textContent = `Load More (${remainingCount} remaining)`;
//     }
//   }

// Modify renderArticles function to handle pagination
function renderArticles() {
  if (!elements.pubmedArticlesList) return;
  
  elements.pubmedArticlesList.innerHTML = '';
  
  // Calculate start and end indices for the current page
  const startIndex = 0;
  const endIndex = state.displayedArticles.length;
  
  // Render only the articles for the current page
  state.displayedArticles.slice(startIndex, endIndex).forEach(article => {
    const articleElement = createArticleElement(article);
    elements.pubmedArticlesList.appendChild(articleElement);
  });
  
  if (elements.pubmedResultCount) {
    if (state.localSearchTerm && state.localSearchTerm.trim() !== '') {
      elements.pubmedResultCount.textContent = `${state.totalResults} articles found (showing ${state.displayedArticles.length} of ${state.filteredArticles.length} matching "${state.localSearchTerm}")`;
    } else {
      elements.pubmedResultCount.textContent = `${state.totalResults} articles found (showing page ${state.currentPage} of ${Math.ceil(state.totalResults / state.pageSize)})`;
    }
  }
  
  // Only show pagination if we have more than one page
  const totalPages = Math.ceil(state.totalResults / state.pageSize);
  const showPagination = totalPages > 1;
  
  showComponent(elements.pubmedPagination, showPagination);
  
  // If pagination is visible, update the pagination controls
  if (showPagination && elements.pubmedPagination) {
    renderPagination(totalPages);
  }
}

// Add a new function to render pagination controls
function renderPagination(totalPages) {
  if (!elements.pubmedPagination) return;
  
  // Create pagination HTML
  let paginationHTML = '<div class="flex flex-wrap justify-center items-center gap-2">';
  
  // Previous button
  paginationHTML += `
    <button class="page-btn previous-btn px-3 py-1 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-lg transition-colors flex items-center ${state.currentPage === 1 ? 'opacity-50 cursor-not-allowed' : ''}"
            ${state.currentPage === 1 ? 'disabled' : 'data-page="' + (state.currentPage - 1) + '"'}>
      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
      </svg>
      Previous
    </button>
  `;
  
  // Determine which page buttons to show
  let startPage = Math.max(1, state.currentPage - Math.floor(state.maxPageButtons / 2));
  let endPage = Math.min(totalPages, startPage + state.maxPageButtons - 1);
  
  // Adjust if we're near the end
  if (endPage === totalPages) {
    startPage = Math.max(1, endPage - state.maxPageButtons + 1);
  }
  
  // First page button (if not in the current range)
  if (startPage > 1) {
    paginationHTML += `
      <button class="page-btn px-3 py-1 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-lg transition-colors"
              data-page="1">1</button>
    `;
    
    if (startPage > 2) {
      paginationHTML += `
        <span class="px-2 text-gray-500">...</span>
      `;
    }
  }
  
  // Page buttons
  for (let i = startPage; i <= endPage; i++) {
    const isCurrentPage = i === state.currentPage;
    paginationHTML += `
      <button class="page-btn px-3 py-1 ${isCurrentPage ? 'bg-primary text-white' : 'bg-gray-200 hover:bg-gray-300 text-gray-800'} rounded-lg transition-colors"
              ${isCurrentPage ? 'disabled' : 'data-page="' + i + '"'}>
        ${i}
      </button>
    `;
  }
  
  // Last page button (if not in the current range)
  if (endPage < totalPages) {
    if (endPage < totalPages - 1) {
      paginationHTML += `
        <span class="px-2 text-gray-500">...</span>
      `;
    }
    
    paginationHTML += `
      <button class="page-btn px-3 py-1 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-lg transition-colors"
              data-page="${totalPages}">${totalPages}</button>
    `;
  }
  
  // Next button
  paginationHTML += `
    <button class="page-btn next-btn px-3 py-1 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-lg transition-colors flex items-center ${state.currentPage === totalPages ? 'opacity-50 cursor-not-allowed' : ''}"
            ${state.currentPage === totalPages ? 'disabled' : 'data-page="' + (state.currentPage + 1) + '"'}>
      Next
      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
      </svg>
    </button>
  `;
  
  paginationHTML += '</div>';
  
  // Update the pagination element
  elements.pubmedPagination.innerHTML = paginationHTML;
  
  // Add event listeners to page buttons
  document.querySelectorAll('.page-btn').forEach(button => {
    if (!button.disabled && button.dataset.page) {
      button.addEventListener('click', () => {
        goToPage(parseInt(button.dataset.page, 10));
      });
    }
  });
}

  // Render treatments for a condition
  function renderTreatmentsForCondition(condition) {
    if (!elements.pubmedTreatments) return;
    
    // Only show treatments for condition searches
    if (state.searchType !== 'condition') {
      showComponent(elements.pubmedTreatments, false);
      return;
    }
    
    showComponent(elements.pubmedTreatments, true);
    showComponent(elements.pubmedTreatmentsLoading, true);
    showComponent(elements.pubmedTreatmentsContent, false);
    
    setTimeout(() => {
      try {
        // Get treatments for this condition
        const treatments = state.medicalDatabase.conditionDrugMap[condition] || [];
        
        // Filter out treatment exclusion words and empty strings
        const validTreatments = treatments.filter(treatment => 
          treatment && 
          treatment.trim() !== '' && 
          !treatmentExclusionWords.includes(treatment.toLowerCase())
        );
        
        // Don't show the treatment section if no valid treatments were found
        if (validTreatments.length === 0) {
          showComponent(elements.pubmedTreatments, false);
          showComponent(elements.pubmedTreatmentsLoading, false);
          return;
        }
        
        // Group treatments by drug class if possible
        const treatmentsByClass = {};
        const unclassifiedTreatments = [];
        
        validTreatments.forEach(treatment => {
          const classes = state.medicalDatabase.drugClasses[treatment] || [];
          
          if (classes.length > 0) {
            classes.forEach(className => {
              if (!treatmentsByClass[className]) {
                treatmentsByClass[className] = [];
              }
              if (!treatmentsByClass[className].includes(treatment)) {
                treatmentsByClass[className].push(treatment);
              }
            });
          } else {
            unclassifiedTreatments.push(treatment);
          }
        });
        
        let html = `
          <div class="bg-blue-50 p-4 rounded-lg border border-blue-100 mb-6">
            <h3 class="text-blue-800 font-medium flex items-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
              </svg>
              Treatments for ${condition}
            </h3>
            <p class="text-blue-700 text-sm mt-1">
              Found ${validTreatments.length} potential treatments across ${Object.keys(state.medicalDatabase.articleEvidence).filter(key => key.startsWith(condition)).length} articles.
            </p>
          </div>
          
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
        `;
        
        // Add classified treatments
        Object.entries(treatmentsByClass).forEach(([className, drugs]) => {
          html += `
            <div class="bg-white rounded-lg p-4 shadow-sm border border-gray-100">
              <h4 class="font-medium text-gray-800 mb-2">${className}</h4>
              <div class="flex flex-wrap gap-2">
                ${drugs.map(drug => {
                  // Get evidence count
                  const evidenceKey = `${condition}|||${drug}`;
                  const evidenceCount = state.medicalDatabase.articleEvidence[evidenceKey]?.length || 0;
                  
                  return `
                    <button class="treatment-pill bg-green-50 hover:bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm flex items-center transition-colors duration-200"
                            data-condition="${condition}" 
                            data-treatment="${drug}" 
                            data-evidence="${evidenceCount}">
                      ${drug}
                      <span class="ml-1 bg-green-700 text-white text-xs rounded-full w-5 h-5 inline-flex items-center justify-center">${evidenceCount}</span>
                    </button>
                  `;
                }).join('')}
              </div>
            </div>
          `;
        });
        
        // Add unclassified treatments if any
        if (unclassifiedTreatments.length > 0) {
          html += `
            <div class="bg-white rounded-lg p-4 shadow-sm border border-gray-100">
              <h4 class="font-medium text-gray-800 mb-2">Other Treatments</h4>
              <div class="flex flex-wrap gap-2">
                ${unclassifiedTreatments.map(drug => {
                  // Get evidence count
                  const evidenceKey = `${condition}|||${drug}`;
                  const evidenceCount = state.medicalDatabase.articleEvidence[evidenceKey]?.length || 0;
                  
                  return `
                    <button class="treatment-pill bg-green-50 hover:bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm flex items-center transition-colors duration-200"
                            data-condition="${condition}" 
                            data-treatment="${drug}" 
                            data-evidence="${evidenceCount}">
                      ${drug}
                      <span class="ml-1 bg-green-700 text-white text-xs rounded-full w-5 h-5 inline-flex items-center justify-center">${evidenceCount}</span>
                    </button>
                  `;
                }).join('')}
              </div>
            </div>
          `;
        }
        
        // Add treatment evidence section (initially hidden, will be shown when a treatment is clicked)
        html += `
          </div>
          
          <div id="pubmedTreatmentEvidence" class="mt-6 hidden">
            <h3 class="text-lg font-medium text-gray-800 mb-2">Evidence for <span id="evidenceTreatmentName"></span></h3>
            <div id="pubmedTreatmentEvidenceList" class="space-y-3"></div>
          </div>
        `;
        
        elements.pubmedTreatmentsContent.innerHTML = html;
        
        // Add event listeners for treatment pills
        document.querySelectorAll('.treatment-pill').forEach(pill => {
          pill.addEventListener('click', function() {
            const condition = this.dataset.condition;
            const treatment = this.dataset.treatment;
            showTreatmentEvidence(condition, treatment);
          });
        });
        
        // Hide loading, show content
        showComponent(elements.pubmedTreatmentsLoading, false);
        showComponent(elements.pubmedTreatmentsContent, true);
        
      } catch (error) {
        console.error('Error rendering treatments:', error);
        showComponent(elements.pubmedTreatments, false);
        showComponent(elements.pubmedTreatmentsLoading, false);
      }
    }, 100);
  }

  // Show evidence for a specific treatment
  function showTreatmentEvidence(condition, treatment) {
    const evidenceKey = `${condition}|||${treatment}`;
    const evidence = state.medicalDatabase.articleEvidence[evidenceKey] || [];
    
    const evidenceDiv = document.getElementById('pubmedTreatmentEvidence');
    const evidenceName = document.getElementById('evidenceTreatmentName');
    const evidenceList = document.getElementById('pubmedTreatmentEvidenceList');
    
    if (!evidenceDiv || !evidenceName || !evidenceList) return;
    
    evidenceName.textContent = `${treatment} for ${condition}`;
    evidenceList.innerHTML = '';
    
    if (evidence.length === 0) {
      evidenceList.innerHTML = `
        <p class="text-gray-500">No specific evidence found linking this treatment to the condition.</p>
      `;
    } else {
      evidence.forEach(item => {
        const evidenceItem = document.createElement('div');
        evidenceItem.className = 'bg-white rounded-lg p-3 shadow-sm border border-gray-100';
        
        evidenceItem.innerHTML = `
          <div class="flex justify-between">
            <h4 class="font-medium text-gray-800">${item.title}</h4>
            <span class="text-gray-500 text-sm">${formatDate(item.date)}</span>
          </div>
          <p class="text-gray-600 text-sm mt-1">${item.journal || 'Journal not specified'}</p>
          ${item.excerpt ? `
            <div class="mt-2 text-sm text-gray-700 bg-gray-50 p-2 rounded">
              <p>…${item.excerpt}…</p>
            </div>
          ` : ''}
          <div class="mt-2">
            <a href="https://pubmed.ncbi.nlm.nih.gov/${item.pmid}" target="_blank" 
               class="text-primary hover:text-primary-dark text-sm flex items-center inline-block">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
              </svg>
              View on PubMed
            </a>
          </div>
        `;
        
        evidenceList.appendChild(evidenceItem);
      });
    }
    
    // Show evidence section
    evidenceDiv.classList.remove('hidden');
    
    // Scroll to evidence
    evidenceDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }

  // Render drug information 
  function renderDrugInformation(drug) {
    if (!elements.pubmedDrugInfo) return;
    
    // Only show drug info for drug searches
    if (state.searchType !== 'drug') {
      showComponent(elements.pubmedDrugInfo, false);
      return;
    }
    
    showComponent(elements.pubmedDrugInfo, true);
    showComponent(elements.pubmedDrugInfoLoading, true);
    showComponent(elements.pubmedDrugInfoContent, false);
    
    setTimeout(() => {
      try {
        // Get conditions treated by this drug
        let conditions = state.medicalDatabase.drugConditionMap[drug] || [];
        
        // Filter out treatment exclusion words and empty strings
        conditions = conditions.filter(condition => 
          condition && 
          condition.trim() !== '' && 
          !treatmentExclusionWords.includes(condition.toLowerCase())
        );
        
        // Don't show drug info if no valid conditions were found
        if (conditions.length === 0) {
          showComponent(elements.pubmedDrugInfo, false);
          showComponent(elements.pubmedDrugInfoLoading, false);
          return;
        }
        
        // Get drug class information
        const drugClasses = state.medicalDatabase.drugClasses[drug] || [];
        const totalArticles = conditions.reduce((count, condition) => {
          const evidenceKey = `${condition}|||${drug}`;
          return count + (state.medicalDatabase.articleEvidence[evidenceKey]?.length || 0);
        }, 0);
        
        // Create HTML for drug information
        let html = `
          <div class="bg-green-50 p-4 rounded-lg border border-green-100 mb-6">
            <h3 class="text-green-800 font-medium flex items-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
              </svg>
              ${drug} Information
            </h3>
            <div class="text-green-700 text-sm mt-1">
              <p>Used to treat ${conditions.length} condition${conditions.length !== 1 ? 's' : ''}.</p>
              ${drugClasses.length > 0 ? 
                `<p class="mt-1">Classification: ${drugClasses.join(', ')}.</p>` : 
                ''
              }
              
            </div>
          </div>
          
          <h3 class="text-lg font-medium text-gray-800 mb-3">Conditions Treated</h3>
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
        `;
        
        // Add conditions
        conditions.forEach(condition => {
          const evidenceKey = `${condition}|||${drug}`;
          const evidenceCount = state.medicalDatabase.articleEvidence[evidenceKey]?.length || 0;
          
          html += `
            <div class="bg-white rounded-lg p-4 shadow-sm border border-gray-100">
              <h4 class="font-medium text-gray-800 mb-2">${condition}</h4>

              <button class="condition-pill bg-blue-50 hover:bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-sm transition-colors duration-200"
                      data-condition="${condition}" 
                      data-drug="${drug}">
                View Evidence
              </button>
            </div>
          `;
        });
        
        // Add drug evidence section
        html += `
          </div>
          
          <div id="pubmedDrugEvidence" class="mt-6 hidden">
            <h3 class="text-lg font-medium text-gray-800 mb-2">Evidence for <span id="evidenceDrugCondition"></span></h3>
            <div id="pubmedDrugEvidenceList" class="space-y-3"></div>
          </div>
        `;
        
        elements.pubmedDrugInfoContent.innerHTML = html;
        
        // Add event listeners for condition pills
        document.querySelectorAll('.condition-pill').forEach(pill => {
          pill.addEventListener('click', function() {
            const condition = this.dataset.condition;
            const drug = this.dataset.drug;
            showDrugEvidence(condition, drug);
          });
        });
        
        // Hide loading, show content
        showComponent(elements.pubmedDrugInfoLoading, false);
        showComponent(elements.pubmedDrugInfoContent, true);
        
      } catch (error) {
        console.error('Error rendering drug information:', error);
        showComponent(elements.pubmedDrugInfo, false);
        showComponent(elements.pubmedDrugInfoLoading, false);
      }
    }, 100);
  }

  // Show evidence for a specific drug treating a condition
  function showDrugEvidence(condition, drug) {
    const evidenceKey = `${condition}|||${drug}`;
    const evidence = state.medicalDatabase.articleEvidence[evidenceKey] || [];
    
    const evidenceDiv = document.getElementById('pubmedDrugEvidence');
    const evidenceCondition = document.getElementById('evidenceDrugCondition');
    const evidenceList = document.getElementById('pubmedDrugEvidenceList');
    
    if (!evidenceDiv || !evidenceCondition || !evidenceList) return;
    
    evidenceCondition.textContent = `${drug} for ${condition}`;
    evidenceList.innerHTML = '';
    
    if (evidence.length === 0) {
      evidenceList.innerHTML = `
        <p class="text-gray-500">No specific evidence found linking this drug to the condition.</p>
      `;
    } else {
      evidence.forEach(item => {
        const evidenceItem = document.createElement('div');
        evidenceItem.className = 'bg-white rounded-lg p-3 shadow-sm border border-gray-100';
        
        evidenceItem.innerHTML = `
          <div class="flex justify-between">
            <h4 class="font-medium text-gray-800">${item.title}</h4>
            <span class="text-gray-500 text-sm">${formatDate(item.date)}</span>
          </div>
          <p class="text-gray-600 text-sm mt-1">${item.journal || 'Journal not specified'}</p>
          ${item.excerpt ? `
            <div class="mt-2 text-sm text-gray-700 bg-gray-50 p-2 rounded">
              <p>…${item.excerpt}…</p>
            </div>
          ` : ''}
          <div class="mt-2">
            <a href="https://pubmed.ncbi.nlm.nih.gov/${item.pmid}" target="_blank" 
               class="text-primary hover:text-primary-dark text-sm flex items-center inline-block">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
              </svg>
              View on PubMed
            </a>
          </div>
        `;
        
        evidenceList.appendChild(evidenceItem);
      });
    }
    
    // Show evidence section
    evidenceDiv.classList.remove('hidden');
    
    // Scroll to evidence
    evidenceDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }

//   // Load more articles function
//   function loadMoreArticles() {
//     // Add the next batch of articles to display
//     const currentLength = state.displayedArticles.length;
//     const nextBatch = state.filteredArticles.slice(currentLength, currentLength + state.pageSize);
    
//     if (nextBatch.length > 0) {
//       state.displayedArticles = [...state.displayedArticles, ...nextBatch];
//       renderArticles();
//     } else if (currentLength < state.totalResults) {
//       // Need to fetch more from the API
//       const options = {
//         page: state.currentPage + 1,
//         sortBy: elements.pubmedSort ? elements.pubmedSort.value : 'relevance',
//         fullTextOnly: elements.pubmedFullTextOnly ? elements.pubmedFullTextOnly.checked : false,
//         yearFilter: elements.pubmedYearFilter ? elements.pubmedYearFilter.value : '',
//         journalFilter: elements.pubmedJournalFilter ? elements.pubmedJournalFilter.value : '',
//         yearRange: elements.pubmedYearRange ? elements.pubmedYearRange.value : state.yearRange
//       };
      
//       if (state.searchType === 'condition') {
//         searchPubMedByCondition(state.term, options);
//       } else if (state.searchType === 'drug') {
//         searchPubMedByDrug(state.term, options);
//       } else {
//         searchPubMed(state.term, options);
//       }
//     }
//   }
  
  
  function goToPage(pageNumber) {
  if (state.isLoading || pageNumber === state.currentPage) return;
  
  // Calculate start and end indices for the requested page
  const startIndex = (pageNumber - 1) * state.pageSize;
  
  // Check if we already have the articles for this page in filteredArticles
  if (startIndex < state.filteredArticles.length) {
    // We have the articles for this page, just update the display
    state.currentPage = pageNumber;
    state.displayedArticles = state.filteredArticles.slice(startIndex, startIndex + state.pageSize);
    renderArticles();
  } else {
    // We need to fetch more articles from the API
    const options = {
      page: pageNumber,
      sortBy: elements.pubmedSort ? elements.pubmedSort.value : 'relevance',
      fullTextOnly: elements.pubmedFullTextOnly ? elements.pubmedFullTextOnly.checked : false,
      yearFilter: elements.pubmedYearFilter ? elements.pubmedYearFilter.value : '',
      journalFilter: elements.pubmedJournalFilter ? elements.pubmedJournalFilter.value : '',
      yearRange: elements.pubmedYearRange ? elements.pubmedYearRange.value : state.yearRange
    };
    
    if (state.searchType === 'condition') {
      searchPubMedByCondition(state.term, options);
    } else if (state.searchType === 'drug') {
      searchPubMedByDrug(state.term, options);
    } else {
      searchPubMed(state.term, options);
    }
  }
}



  // Build year filter string based on year range
  function buildYearFilterString(yearRange) {
    if (!yearRange || yearRange === '') return '';
    
    const currentYear = new Date().getFullYear();
    const startYear = currentYear - parseInt(yearRange, 10);
    
    return `${startYear}:${currentYear}[pdat]`;
  }

  // Function to search PubMed by general term (original function)
  async function searchPubMed(term, options = {}) {
    state.isLoading = true;
    state.term = term;
    state.currentPage = options.page || 1;
    state.sortBy = options.sortBy || state.sortBy;
    state.fullTextOnly = options.fullTextOnly !== undefined ? options.fullTextOnly : state.fullTextOnly;
    state.yearFilter = options.yearFilter || state.yearFilter;
    state.yearRange = options.yearRange || state.yearRange;
    state.journalFilter = options.journalFilter || state.journalFilter;
    state.searchType = 'general';
    state.localSearchTerm = '';  // Reset local search
    
    // Show the pubmed section and loading state
    showComponent(elements.pubmedSection, true);
    showComponent(elements.pubmedLoading, true);
    showComponent(elements.pubmedError, false);
    showComponent(elements.pubmedEmpty, false);
    showComponent(elements.pubmedArticles, false);
    showComponent(elements.pubmedTreatments, false);
    showComponent(elements.pubmedDrugInfo, false);
    
    try {
      // Apply year filter based on year range if provided
      let yearFilterParam = '';
      if (state.yearRange && state.yearRange !== '') {
        yearFilterParam = buildYearFilterString(state.yearRange);
      } else if (state.yearFilter && state.yearFilter !== '') {
        yearFilterParam = state.yearFilter;
      }
      
      const params = new URLSearchParams({
        term: term,
        page: state.currentPage,
        sortBy: state.sortBy,
        fullTextOnly: state.fullTextOnly,
        yearFilter: yearFilterParam,
        journalFilter: state.journalFilter
      });
      
      const response = await fetch(`/api/pubmed?${params}`);
      console.log(`PubMed API Request: /api/pubmed?${params}`);

      if (!response.ok) {
        throw new Error(`Server responded with status ${response.status}`);
      }
      
      const data = await response.json();
      console.log('PubMed API Response:', data);
      
      // Update state with fetched data
      if (state.currentPage === 1) {
        state.articles = data.articles;
        state.filteredArticles = [...data.articles];  // Initialize filtered articles
        // Initialize displayed articles with first batch
        state.displayedArticles = data.articles.slice(0, state.pageSize);
      } else {
        state.articles = [...state.articles, ...data.articles];
        state.filteredArticles = [...state.filteredArticles, ...data.articles];  // Update filtered articles
        // Add new batch to displayed articles
        const currentLength = state.displayedArticles.length;
        const nextBatch = data.articles.slice(0, state.pageSize);
        state.displayedArticles = [...state.displayedArticles, ...nextBatch];
      }
      
      state.totalResults = data.totalResults;
      
      // Process articles for medical knowledge if this is a new search
      if (state.currentPage === 1) {
        // Reset database for a new search
        state.medicalDatabase = {
          conditions: [],
          drugs: [],
          conditionDrugMap: {},
          drugConditionMap: {},
          drugClasses: {},
          articleEvidence: {},
          recentUpdated: null
        };
      }
      
      // Process the medical knowledge
      state.medicalDatabase = processMedicalKnowledge(state.articles);
      
      // Hide loading state
      showComponent(elements.pubmedLoading, false);
      
      if (state.articles.length === 0) {
        showComponent(elements.pubmedEmpty, true);
      } else {
        showComponent(elements.pubmedArticles, true);
        renderArticles();
      }
      
    } catch (error) {
      console.error('Error fetching PubMed data:', error);
      showComponent(elements.pubmedLoading, false);
      showComponent(elements.pubmedError, true);
      if (elements.pubmedErrorMessage) {
        elements.pubmedErrorMessage.textContent = error.message || 'Failed to fetch articles. Please try again later.';
      }
    }
    
    state.isLoading = false;
  }

  // Function to search PubMed by condition and show treatments
  async function searchPubMedByCondition(condition, options = {}) {
    state.isLoading = true;
    state.term = condition;
    state.currentPage = options.page || 1;
    state.sortBy = options.sortBy || state.sortBy;
    state.fullTextOnly = options.fullTextOnly !== undefined ? options.fullTextOnly : state.fullTextOnly;
    state.yearFilter = options.yearFilter || state.yearFilter;
    state.yearRange = options.yearRange || state.yearRange;
    state.journalFilter = options.journalFilter || state.journalFilter;
    state.searchType = 'condition';
    state.localSearchTerm = '';  // Reset local search
    
    // Show the pubmed section and loading state
    showComponent(elements.pubmedSection, true);
    showComponent(elements.pubmedLoading, true);
    showComponent(elements.pubmedError, false);
    showComponent(elements.pubmedEmpty, false);
    showComponent(elements.pubmedArticles, false);
    showComponent(elements.pubmedTreatments, false);
    showComponent(elements.pubmedDrugInfo, false);
    
    try {
      // Construct search term to focus on the condition
      const searchTerm = `"${condition}"[Title/Abstract] OR "${condition}"[MeSH Terms]`;
      
      // Apply year filter based on year range if provided
      let yearFilterParam = '';
      if (state.yearRange && state.yearRange !== '') {
        yearFilterParam = buildYearFilterString(state.yearRange);
      } else if (state.yearFilter && state.yearFilter !== '') {
        yearFilterParam = state.yearFilter;
      }
      
      const params = new URLSearchParams({
        term: searchTerm,
        page: state.currentPage,
        sortBy: state.sortBy,
        fullTextOnly: state.fullTextOnly,
        yearFilter: yearFilterParam,
        journalFilter: state.journalFilter
      });
      
      const response = await fetch(`/api/pubmed?${params}`);
      console.log(`PubMed API Request: /api/pubmed?${params}`);
      if (!response.ok) {
        throw new Error(`Server responded with status ${response.status}`);
      }
      
      const data = await response.json();
      console.log('PubMed API Response:', data);
      
      // Update state with fetched data
      if (state.currentPage === 1) {
        state.articles = data.articles;
        state.filteredArticles = [...data.articles];  // Initialize filtered articles
        // Initialize displayed articles with first batch
        state.displayedArticles = data.articles.slice(0, state.pageSize);
      } else {
        state.articles = [...state.articles, ...data.articles];
        state.filteredArticles = [...state.filteredArticles, ...data.articles];  // Update filtered articles
        // Add new batch to displayed articles
        const currentLength = state.displayedArticles.length;
        const nextBatch = data.articles.slice(0, state.pageSize);
        state.displayedArticles = [...state.displayedArticles, ...nextBatch];
      }
      
      state.totalResults = data.totalResults;
      
      // Process articles for medical knowledge if this is a new search
      if (state.currentPage === 1) {
        // Reset database for a new search
        state.medicalDatabase = {
          conditions: [],
          drugs: [],
          conditionDrugMap: {},
          drugConditionMap: {},
          drugClasses: {},
          articleEvidence: {},
          recentUpdated: null
        };
      }
      
      // Process the medical knowledge
      state.medicalDatabase = processMedicalKnowledge(state.articles);
      
      // Hide loading state
      showComponent(elements.pubmedLoading, false);
      
      if (state.articles.length === 0) {
        showComponent(elements.pubmedEmpty, true);
      } else {
        // Show articles and treatments
        showComponent(elements.pubmedArticles, true);
        renderArticles();
        
        // Render treatments for this condition
        renderTreatmentsForCondition(condition);
      }
      
    } catch (error) {
      console.error('Error fetching PubMed data for condition:', error);
      showComponent(elements.pubmedLoading, false);
      showComponent(elements.pubmedError, true);
      if (elements.pubmedErrorMessage) {
        elements.pubmedErrorMessage.textContent = error.message || 'Failed to fetch articles. Please try again later.';
      }
    }
    
    state.isLoading = false;
  }

  // Function to search PubMed by drug and show its uses
  async function searchPubMedByDrug(drug, options = {}) {
    state.isLoading = true;
    state.term = drug;
    state.currentPage = options.page || 1;
    state.sortBy = options.sortBy || state.sortBy;
    state.fullTextOnly = options.fullTextOnly !== undefined ? options.fullTextOnly : state.fullTextOnly;
    state.yearFilter = options.yearFilter || state.yearFilter;
    state.yearRange = options.yearRange || state.yearRange;
    state.journalFilter = options.journalFilter || state.journalFilter;
    state.searchType = 'drug';
    state.localSearchTerm = '';  // Reset local search
    
    // Show the pubmed section and loading state
    showComponent(elements.pubmedSection, true);
    showComponent(elements.pubmedLoading, true);
    showComponent(elements.pubmedError, false);
    showComponent(elements.pubmedEmpty, false);
    showComponent(elements.pubmedArticles, false);
    showComponent(elements.pubmedTreatments, false);  // Never show treatments when searching by drug
    showComponent(elements.pubmedDrugInfo, false);
    
    try {
      // Construct search term to focus on the drug
      const searchTerm = `"${drug}"[Title/Abstract] OR "${drug}"[MeSH Terms] OR "${drug}"[Pharmacological Action]`;
      
      // Apply year filter based on year range if provided
      let yearFilterParam = '';
      if (state.yearRange && state.yearRange !== '') {
        yearFilterParam = buildYearFilterString(state.yearRange);
      } else if (state.yearFilter && state.yearFilter !== '') {
        yearFilterParam = state.yearFilter;
      }
      
      const params = new URLSearchParams({
        term: searchTerm,
        page: state.currentPage,
        sortBy: state.sortBy,
        fullTextOnly: state.fullTextOnly,
        yearFilter: yearFilterParam,
        journalFilter: state.journalFilter
      });
      
      const response = await fetch(`/api/pubmed?${params}`);
      console.log(`PubMed API Request: /api/pubmed?${params}`);
      if (!response.ok) {
        throw new Error(`Server responded with status ${response.status}`);
      }
      
      const data = await response.json();
      console.log('PubMed API Response:', data);

      // Update state with fetched data
      if (state.currentPage === 1) {
        state.articles = data.articles;
        state.filteredArticles = [...data.articles];  // Initialize filtered articles
        // Initialize displayed articles with first batch
        state.displayedArticles = data.articles.slice(0, state.pageSize);
      } else {
        state.articles = [...state.articles, ...data.articles];
        state.filteredArticles = [...state.filteredArticles, ...data.articles];  // Update filtered articles
        // Add new batch to displayed articles
        const currentLength = state.displayedArticles.length;
        const nextBatch = data.articles.slice(0, state.pageSize);
        state.displayedArticles = [...state.displayedArticles, ...nextBatch];
      }
      
      state.totalResults = data.totalResults;
      
      // Process articles for medical knowledge if this is a new search
      if (state.currentPage === 1) {
        // Reset database for a new search
        state.medicalDatabase = {
          conditions: [],
          drugs: [],
          conditionDrugMap: {},
          drugConditionMap: {},
          drugClasses: {},
          articleEvidence: {},
          recentUpdated: null
        };
      }
      
      // Process the medical knowledge
      state.medicalDatabase = processMedicalKnowledge(state.articles);
      
      // Hide loading state
      showComponent(elements.pubmedLoading, false);
      
      if (state.articles.length === 0) {
        showComponent(elements.pubmedEmpty, true);
      } else {
        // Show articles and drug information
        showComponent(elements.pubmedArticles, true);
        renderArticles();
        
        // Render drug information
        renderDrugInformation(drug);
      }
      
    } catch (error) {
      console.error('Error fetching PubMed data for drug:', error);
      showComponent(elements.pubmedLoading, false);
      showComponent(elements.pubmedError, true);
      if (elements.pubmedErrorMessage) {
        elements.pubmedErrorMessage.textContent = error.message || 'Failed to fetch articles. Please try again later.';
      }
    }
    
    state.isLoading = false;
  }

  // Initialize event listeners
  function initEventListeners() {
    // Local search functionality
    if (elements.pubmedLocalSearchBox) {
      elements.pubmedLocalSearchBox.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          const searchTerm = elements.pubmedLocalSearchBox.value.trim();
          state.localSearchTerm = searchTerm;
          filterArticlesByLocalSearch(searchTerm);
        }
      });
    }
    
    if (elements.pubmedLocalSearchButton) {
      elements.pubmedLocalSearchButton.addEventListener('click', () => {
        const searchTerm = elements.pubmedLocalSearchBox ? elements.pubmedLocalSearchBox.value.trim() : '';
        state.localSearchTerm = searchTerm;
        filterArticlesByLocalSearch(searchTerm);
      });
    }
    
    // Search by condition button
    if (elements.pubmedSearchByCondition) {
      elements.pubmedSearchByCondition.addEventListener('click', () => {
        const searchTerm = elements.pubmedSearchBox ? elements.pubmedSearchBox.value.trim() : '';
        if (searchTerm) {
          // Get year range from input if available
          const yearRange = elements.pubmedYearRange ? elements.pubmedYearRange.value : state.yearRange;
          
          searchPubMedByCondition(searchTerm, { yearRange });
        }
      });
    }
    
    // Search by drug button
    if (elements.pubmedSearchByDrug) {
      elements.pubmedSearchByDrug.addEventListener('click', () => {
        const searchTerm = elements.pubmedSearchBox ? elements.pubmedSearchBox.value.trim() : '';
        if (searchTerm) {
          // Get year range from input if available
          const yearRange = elements.pubmedYearRange ? elements.pubmedYearRange.value : state.yearRange;
          
          searchPubMedByDrug(searchTerm, { yearRange });
        }
      });
    }
    
    // General search on enter key
    if (elements.pubmedSearchBox) {
      elements.pubmedSearchBox.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          const searchTerm = elements.pubmedSearchBox.value.trim();
          if (searchTerm) {
            // Get year range from input if available
            const yearRange = elements.pubmedYearRange ? elements.pubmedYearRange.value : state.yearRange;
            
            searchPubMed(searchTerm, { yearRange });
          }
        }
      });
    }
    
    // Sort dropdown
    if (elements.pubmedSort) {
      elements.pubmedSort.addEventListener('change', () => {
        const options = {
          page: 1,
          sortBy: elements.pubmedSort.value,
          fullTextOnly: elements.pubmedFullTextOnly ? elements.pubmedFullTextOnly.checked : false,
          yearFilter: elements.pubmedYearFilter ? elements.pubmedYearFilter.value : '',
          yearRange: elements.pubmedYearRange ? elements.pubmedYearRange.value : state.yearRange,
          journalFilter: elements.pubmedJournalFilter ? elements.pubmedJournalFilter.value : ''
        };
        
        if (state.searchType === 'condition') {
          searchPubMedByCondition(state.term, options);
        } else if (state.searchType === 'drug') {
          searchPubMedByDrug(state.term, options);
        } else {
          searchPubMed(state.term, options);
        }
      });
    }
    
    // Full text only checkbox
    if (elements.pubmedFullTextOnly) {
      elements.pubmedFullTextOnly.addEventListener('change', () => {
        const options = {
          page: 1,
          sortBy: elements.pubmedSort ? elements.pubmedSort.value : 'relevance',
          fullTextOnly: elements.pubmedFullTextOnly.checked,
          yearFilter: elements.pubmedYearFilter ? elements.pubmedYearFilter.value : '',
          yearRange: elements.pubmedYearRange ? elements.pubmedYearRange.value : state.yearRange,
          journalFilter: elements.pubmedJournalFilter ? elements.pubmedJournalFilter.value : ''
        };
        
        if (state.searchType === 'condition') {
          searchPubMedByCondition(state.term, options);
        } else if (state.searchType === 'drug') {
          searchPubMedByDrug(state.term, options);
        } else {
          searchPubMed(state.term, options);
        }
      });
    }
    
    // Year range dropdown
    if (elements.pubmedYearRange) {
      elements.pubmedYearRange.addEventListener('change', () => {
        const options = {
          page: 1,
          sortBy: elements.pubmedSort ? elements.pubmedSort.value : 'relevance',
          fullTextOnly: elements.pubmedFullTextOnly ? elements.pubmedFullTextOnly.checked : false,
          yearRange: elements.pubmedYearRange.value,
          journalFilter: elements.pubmedJournalFilter ? elements.pubmedJournalFilter.value : ''
        };
        
        if (state.searchType === 'condition') {
          searchPubMedByCondition(state.term, options);
        } else if (state.searchType === 'drug') {
          searchPubMedByDrug(state.term, options);
        } else {
          searchPubMed(state.term, options);
        }
      });
    }
    
    // Journal filter
    if (elements.pubmedJournalFilter) {
      elements.pubmedJournalFilter.addEventListener('change', () => {
        const options = {
          page: 1,
          sortBy: elements.pubmedSort ? elements.pubmedSort.value : 'relevance',
          fullTextOnly: elements.pubmedFullTextOnly ? elements.pubmedFullTextOnly.checked : false,
          yearFilter: elements.pubmedYearFilter ? elements.pubmedYearFilter.value : '',
          yearRange: elements.pubmedYearRange ? elements.pubmedYearRange.value : state.yearRange,
          journalFilter: elements.pubmedJournalFilter.value
        };
        
        if (state.searchType === 'condition') {
          searchPubMedByCondition(state.term, options);
        } else if (state.searchType === 'drug') {
          searchPubMedByDrug(state.term, options);
        } else {
          searchPubMed(state.term, options);
        }
      });
    }
    
    // Load more button
    // if (elements.pubmedLoadMore) {
    //   elements.pubmedLoadMore.addEventListener('click', () => {
    //     if (state.isLoading) return;
    //     loadMoreArticles();
    //   });
    // }
    
    // Advanced toggle
    if (elements.pubmedAdvancedToggle && elements.pubmedAdvancedOptions) {
      elements.pubmedAdvancedToggle.addEventListener('click', () => {
        elements.pubmedAdvancedOptions.classList.toggle('hidden');
        
        // Update text/icon
        if (elements.pubmedAdvancedOptions.classList.contains('hidden')) {
          elements.pubmedAdvancedToggle.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
            Advanced Options
          `;
        } else {
          elements.pubmedAdvancedToggle.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
            </svg>
            Hide Advanced Options
          `;
        }
      });
    }
    
    // Rare condition input
    if (elements.pubmedRareConditionInput && elements.pubmedAddRareCondition) {
      elements.pubmedAddRareCondition.addEventListener('click', () => {
        const conditionInput = elements.pubmedRareConditionInput.value.trim();
        if (conditionInput) {
          // Get year range from input if available
          const yearRange = elements.pubmedYearRange ? elements.pubmedYearRange.value : state.yearRange;
          
          searchPubMedByCondition(conditionInput, { yearRange });
          elements.pubmedRareConditionInput.value = '';
        }
      });
      
      elements.pubmedRareConditionInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          const conditionInput = elements.pubmedRareConditionInput.value.trim();
          if (conditionInput) {
            // Get year range from input if available
            const yearRange = elements.pubmedYearRange ? elements.pubmedYearRange.value : state.yearRange;
            
            searchPubMedByCondition(conditionInput, { yearRange });
            elements.pubmedRareConditionInput.value = '';
          }
        }
      });
    }
  }

  // Function to populate filter options based on data
  function populateFilters() {
    // Populate year range filter
    if (elements.pubmedYearRange) {
      let yearRangeOptions = `
        <option value="3">Last 3 years</option>
        <option value="5" selected>Last 5 years</option>
        <option value="10">Last 10 years</option>
        <option value="15">Last 15 years</option>
        <option value="20">Last 20 years</option>
        <option value="">All Years</option>
      `;
      
      elements.pubmedYearRange.innerHTML = yearRangeOptions;
    }
    
    // For journal filter, we can only populate once we have data
    // This is handled in the renderArticles function
  }

  // Update journal filter based on fetched articles
  function updateJournalFilter() {
    if (!elements.pubmedJournalFilter) return;
    
    // Extract unique journals from articles
    const journals = new Set();
    state.articles.forEach(article => {
      if (article.journal && article.journal.trim() !== '') {
        journals.add(article.journal);
      }
    });
    
    // Convert to array and sort alphabetically
    const sortedJournals = [...journals].sort();
    
    // Create options HTML
    let journalOptions = '<option value="">All Journals</option>';
    sortedJournals.forEach(journal => {
      journalOptions += `<option value="${journal}">${journal}</option>`;
    });
    
    // Set the options
    elements.pubmedJournalFilter.innerHTML = journalOptions;
    
    // If there was a previous selection, try to restore it
    if (state.journalFilter) {
      elements.pubmedJournalFilter.value = state.journalFilter;
    }
  }

  // Helper function to safely get DOM elements
  function safeGetElement(id) {
    const element = document.getElementById(id);
    if (!element) {
      console.warn(`PubMed Module: Element with ID "${id}" not found`);
    }
    return element;
  }

  // Create essential elements if they don't exist
  function ensureRequiredElements() {
    // Create main container if needed

    if (!document.getElementById('pubmedPagination') && elements.pubmedArticles) {
    console.log(`PubMed Module: Creating pagination elements`);
    
    const pagination = document.createElement('div');
    pagination.id = 'pubmedPagination';
    pagination.className = 'mt-6 hidden';
    pagination.innerHTML = ''; // Will be populated by renderPagination
    
    elements.pubmedArticles.appendChild(pagination);
    
    // Update element references 
    elements.pubmedPagination = document.getElementById('pubmedPagination');
  }


    if (!document.getElementById('pubmedSection')) {
      console.log("PubMed Module: Creating missing pubmedSection element");
      const section = document.createElement('div');
      section.id = 'pubmedSection';
      section.className = 'hidden';
      
      // Try to find a suitable parent element
      const parent = document.querySelector('.main-content') || 
                    document.querySelector('main') || 
                    document.querySelector('body');
      if (parent) {
        parent.appendChild(section);
        // Update the elements reference
        elements.pubmedSection = section;
      } else {
        console.error("PubMed Module: Could not find parent element to append pubmedSection");
      }
    }
    
    // Create other essential elements
    const requiredElements = [
      { id: 'pubmedLoading', parent: 'pubmedSection', className: 'flex justify-center items-center py-12 hidden' },
      { id: 'pubmedError', parent: 'pubmedSection', className: 'bg-red-50 p-6 rounded-lg text-center hidden' },
      { id: 'pubmedEmpty', parent: 'pubmedSection', className: 'bg-gray-50 p-8 rounded-lg text-center hidden' },
      { id: 'pubmedArticles', parent: 'pubmedSection', className: 'hidden' },
      { id: 'pubmedArticlesList', parent: 'pubmedArticles', className: 'space-y-4' },
      { id: 'pubmedTreatments', parent: 'pubmedSection', className: 'mb-8 hidden' },
      { id: 'pubmedTreatmentsContent', parent: 'pubmedTreatments', className: 'hidden' },
      { id: 'pubmedDrugInfo', parent: 'pubmedSection', className: 'mb-8 hidden' },
      { id: 'pubmedDrugInfoContent', parent: 'pubmedDrugInfo', className: 'hidden' }
    ];
    
    requiredElements.forEach(elem => {
      if (!document.getElementById(elem.id) && document.getElementById(elem.parent)) {
        console.log(`PubMed Module: Creating missing ${elem.id} element`);
        const newElement = document.createElement('div');
        newElement.id = elem.id;
        newElement.className = elem.className;
        document.getElementById(elem.parent).appendChild(newElement);
        
        // Update the elements reference
        elements[elem.id] = newElement;
      }
    });
    
    // Create search interface if needed
    if (!document.getElementById('pubmedSearchInterface') && elements.pubmedSection) {
      console.log(`PubMed Module: Creating search interface`);
      
      const searchInterface = document.createElement('div');
      searchInterface.id = 'pubmedSearchInterface';
      searchInterface.className = 'mb-6';
      searchInterface.innerHTML = `
        <div class="flex flex-col md:flex-row gap-2 mb-4" style="display: none">
          <div class="flex-grow">
            <input type="text" id="pubmedSearchBox" placeholder="Search PubMed..." 
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
          </div>
          <div class="flex gap-2">
            <button id="pubmedSearchByCondition" 
                    class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
              Search by Condition
            </button>
            <button id="pubmedSearchByDrug" 
                    class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
              Search by Drug
            </button>
          </div>
        </div>
        
        <div class="flex items-center">
          <button id="pubmedAdvancedToggle" class="text-sm text-gray-600 flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
            Advanced Options
          </button>
        </div>
        
        <div id="pubmedAdvancedOptions" class="mt-4 p-4 bg-gray-50 rounded-lg hidden">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <label for="pubmedSort" class="block text-sm font-medium text-gray-700 mb-1">Sort By</label>
              <select id="pubmedSort" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-primary">
                <option value="relevance">Relevance</option>
                <option value="date">Most Recent</option>
                <option value="citations">Most Cited</option>
              </select>
            </div>
            
            <div>
              <label for="pubmedYearRange" class="block text-sm font-medium text-gray-700 mb-1">Time Period</label>
              <select id="pubmedYearRange" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-primary">
                <option value="5" selected>Last 5 years</option>
              </select>
            </div>
            
            <div>
              <label for="pubmedJournalFilter" class="block text-sm font-medium text-gray-700 mb-1">Journal</label>
              <select id="pubmedJournalFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-primary">
                <option value="">All Journals</option>
              </select>
            </div>
          </div>
          
          <div class="mt-4">
            <label class="flex items-center">
              <input type="checkbox" id="pubmedFullTextOnly" class="rounded text-primary focus:ring-primary h-4 w-4">
              <span class="ml-2 text-sm text-gray-700">Full Text Available Only</span>
            </label>
          </div>
          
          <div class="mt-4">
            <h4 class="text-sm font-medium text-gray-700 mb-2">Looking for a rare condition?</h4>
            <div class="flex gap-2">
              <input type="text" id="pubmedRareConditionInput" placeholder="Enter condition name..." 
                     class="flex-grow px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-primary">
              <button id="pubmedAddRareCondition" 
                      class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                Search
              </button>
            </div>
          </div>
        </div>
      `;
      searchInterface.style.display = 'none';
      elements.pubmedSection.insertBefore(searchInterface, elements.pubmedSection.firstChild);
      
      // Update element references
      elements.pubmedSearchBox = document.getElementById('pubmedSearchBox');
      elements.pubmedSearchByCondition = document.getElementById('pubmedSearchByCondition');
      elements.pubmedSearchByDrug = document.getElementById('pubmedSearchByDrug');
      elements.pubmedAdvancedToggle = document.getElementById('pubmedAdvancedToggle');
      elements.pubmedAdvancedOptions = document.getElementById('pubmedAdvancedOptions');
      elements.pubmedSort = document.getElementById('pubmedSort');
      elements.pubmedFullTextOnly = document.getElementById('pubmedFullTextOnly');
      elements.pubmedYearRange = document.getElementById('pubmedYearRange');
      elements.pubmedJournalFilter = document.getElementById('pubmedJournalFilter');
      elements.pubmedRareConditionInput = document.getElementById('pubmedRareConditionInput');
      elements.pubmedAddRareCondition = document.getElementById('pubmedAddRareCondition');
    }
    
    // Create local search functionality if needed
    if (!document.getElementById('pubmedLocalSearch') && elements.pubmedArticles) {
      console.log(`PubMed Module: Creating local search elements`);
      
      const localSearch = document.createElement('div');
      localSearch.id = 'pubmedLocalSearch';
      localSearch.className = 'mb-4 mt-2';
      localSearch.innerHTML = `
        <div class="flex gap-2">
          <input type="text" id="pubmedLocalSearchBox" placeholder="Search within results..." 
                 class="flex-grow px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-primary">
          <button id="pubmedLocalSearchButton" 
                  class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors">
            Search
          </button>
        </div>
      `;
      
      elements.pubmedArticles.insertBefore(localSearch, elements.pubmedArticles.firstChild);
      
      // Update element references
      elements.pubmedLocalSearchBox = document.getElementById('pubmedLocalSearchBox');
      elements.pubmedLocalSearchButton = document.getElementById('pubmedLocalSearchButton');
    }
    
    // Create pagination elements if needed
    if (!document.getElementById('pubmedPagination') && elements.pubmedArticles) {
      console.log(`PubMed Module: Creating pagination elements`);
      
      const pagination = document.createElement('div');
      pagination.id = 'pubmedPagination';
      pagination.className = 'mt-6 flex justify-center hidden';
      pagination.innerHTML = `
        <button id="pubmedLoadMore" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-lg transition-colors">
          Load More
        </button>
      `;
      
      elements.pubmedArticles.appendChild(pagination);
      
      // Update element references 
      elements.pubmedPagination = document.getElementById('pubmedPagination');
      elements.pubmedLoadMore = document.getElementById('pubmedLoadMore');
    }
    
    // Create result count element if needed
    if (!document.getElementById('pubmedResultCount') && elements.pubmedArticles) {
      console.log(`PubMed Module: Creating result count element`);
      
      const resultCount = document.createElement('div');
      resultCount.id = 'pubmedResultCount';
      resultCount.className = 'text-sm text-gray-600 mb-4';
      resultCount.textContent = '0 articles found';
      
      // Insert after local search if it exists, otherwise at the beginning
      const localSearch = document.getElementById('pubmedLocalSearch');
      if (localSearch) {
        localSearch.after(resultCount);
      } else {
        elements.pubmedArticles.insertBefore(resultCount, elements.pubmedArticles.firstChild);
      }
      
      // Update element references
      elements.pubmedResultCount = document.getElementById('pubmedResultCount');
    }
    
    // Create empty state content if needed
    if (elements.pubmedEmpty && elements.pubmedEmpty.innerHTML === '') {
      elements.pubmedEmpty.innerHTML = `
        <div class="text-center py-8">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <h3 class="text-lg font-medium text-gray-700 mb-2">No articles found</h3>
          <p class="text-gray-500">Try adjusting your search terms or filters.</p>
        </div>
      `;
    }
    
    // Create loading indicator if needed
    if (elements.pubmedLoading && elements.pubmedLoading.innerHTML === '') {
      elements.pubmedLoading.innerHTML = `
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-primary"></div>
      `;
    }
  }

  // Initialize the module
  function init() {
    console.log("PubMed Module: Initializing...");
    
    // First ensure all required elements exist
    ensureRequiredElements();
    
    // Re-check if we have the main container
    if (!elements.pubmedSection) {
      console.error('PubMed Module: Required elements could not be created');
      return;
    }
    
    // Initialize event listeners
    try {
      initEventListeners();
    } catch (error) {
      console.error('PubMed Module: Error initializing event listeners', error);
    }
    
    // Populate filter options
    try {
      populateFilters();
    } catch (error) {
      console.error('PubMed Module: Error populating filters', error);
    }
    
    console.log("PubMed Module: Initialization complete");
  }
  
  // Return public methods
  return {
    init,
    searchPubMed,
    searchPubMedByCondition,
    searchPubMedByDrug
  };
})();

// // Initialize the module when DOM is ready
// document.addEventListener('DOMContentLoaded', function() {
//   PubMedModule.init();
// });

// // PubMed Module 2nd iteration
// const PubMedModule = (function() {
//   const elements = {
//     pubmedSection: document.getElementById('pubmedSection'),
//     pubmedLoading: document.getElementById('pubmedLoading'),
//     pubmedError: document.getElementById('pubmedError'),
//     pubmedErrorMessage: document.getElementById('pubmedErrorMessage'),
//     pubmedEmpty: document.getElementById('pubmedEmpty'),
//     pubmedArticles: document.getElementById('pubmedArticles'),
//     pubmedArticlesList: document.getElementById('pubmedArticlesList'),
//     pubmedResultCount: document.getElementById('pubmedResultCount'),
//     pubmedSort: document.getElementById('pubmedSort'),
//     pubmedFullTextOnly: document.getElementById('pubmedFullTextOnly'),
//     pubmedLoadMore: document.getElementById('pubmedLoadMore'),
//     pubmedPagination: document.getElementById('pubmedPagination'),
//     pubmedSummary: document.getElementById('pubmedSummary'),
//     pubmedSummaryLoading: document.getElementById('pubmedSummaryLoading'),
//     pubmedSummaryContent: document.getElementById('pubmedSummaryContent'),
//     pubmedKeyAreas: document.getElementById('pubmedKeyAreas'),
//     pubmedTimeline: document.getElementById('pubmedTimeline'),
//     pubmedTopics: document.getElementById('pubmedTopics'),
//     pubmedTopicsCloud: document.getElementById('pubmedTopicsCloud'),
//     pubmedJournals: document.getElementById('pubmedJournals'),
//     pubmedTreatments: document.getElementById('pubmedTreatments'),
//     pubmedTreatmentsLoading: document.getElementById('pubmedTreatmentsLoading'),
//     pubmedTreatmentsContent: document.getElementById('pubmedTreatmentsContent'),
//     pubmedToggleSummary: document.getElementById('pubmedToggleSummary'),
//     pubmedFilterBar: document.getElementById('pubmedFilterBar')
//   };

//   let state = {
//     term: '',
//     articles: [],
//     currentPage: 1,
//     totalResults: 0,
//     isLoading: false,
//     sortBy: 'relevance',
//     fullTextOnly: false,
//     showSummary: true,
//     conditions: [],
//     treatments: {}
//   };
  
//   function showComponent(component, isVisible) {
//     if (!component) return;
    
//     if (isVisible) {
//       component.classList.remove('hidden');
//     } else {
//       component.classList.add('hidden');
//     }
//   }
  
//   function formatDate(dateString) {
//     if (!dateString) return 'N/A';
//     const date = new Date(dateString);
//     return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
//   }
  
//   function createArticleElement(article) {
//     const articleElement = document.createElement('div');
//     articleElement.className = 'bg-gray-50 rounded-lg p-4 hover:bg-gray-100 transition duration-150 ease-in-out mb-4';
    
//     const hasDOI = article.doi && article.doi.trim() !== '';
//     const hasFullText = article.fullTextUrl && article.fullTextUrl.trim() !== '';
    
//     // Extract potential condition and treatment information
//     const conditions = extractConditions(article);
//     const treatments = extractTreatments(article);
    
//     let conditionsTreatmentsHTML = '';
//     if (conditions.length > 0 || treatments.length > 0) {
//       conditionsTreatmentsHTML = `
//         <div class="border-t border-gray-200 mt-3 pt-3">
//           ${conditions.length > 0 ? 
//             `<div class="mb-2">
//               <span class="text-xs font-medium text-gray-700">Conditions: </span>
//               <span class="text-xs text-gray-600">${conditions.join(', ')}</span>
//             </div>` : ''
//           }
//           ${treatments.length > 0 ? 
//             `<div>
//               <span class="text-xs font-medium text-gray-700">Treatments: </span>
//               <span class="text-xs text-gray-600">${treatments.join(', ')}</span>
//             </div>` : ''
//           }
//         </div>
//       `;
//     }
    
//     articleElement.innerHTML = `
//       <h3 class="text-lg font-semibold text-gray-800 mb-2">${article.title}</h3>
//       <div class="text-sm text-gray-600 mb-2">
//         ${article.authors.slice(0, 3).join(', ')}${article.authors.length > 3 ? ', et al.' : ''}
//       </div>
//       <div class="text-sm text-gray-500 mb-3">
//         <span class="font-medium">${article.journal || 'Journal not specified'}</span> • 
//         ${formatDate(article.pubDate)} • 
//         PMID: ${article.pmid}
//       </div>
//       <p class="text-gray-700 text-sm mb-3">${article.abstract.substring(0, 200)}${article.abstract.length > 200 ? '...' : ''}</p>
//       <div class="flex flex-wrap gap-2 mb-3">
//         ${article.keywords.map(keyword => 
//           `<span class="bg-gray-200 text-gray-700 text-xs px-2 py-1 rounded-full">${keyword}</span>`
//         ).join('')}
//       </div>
//       ${conditionsTreatmentsHTML}
//       <div class="flex flex-wrap gap-2 mt-2">
//         <a href="https://pubmed.ncbi.nlm.nih.gov/${article.pmid}" target="_blank" class="text-primary hover:text-primary-dark text-sm underline">View on PubMed</a>
//         ${hasDOI ? 
//           `<a href="https://doi.org/${article.doi}" target="_blank" class="text-primary hover:text-primary-dark text-sm underline">DOI</a>` : ''}
//         ${hasFullText ? 
//           `<a href="${article.fullTextUrl}" target="_blank" class="text-primary hover:text-primary-dark text-sm underline">Full Text</a>` : ''}
//       </div>
//     `;
    
//     return articleElement;
//   }
  
//   function renderArticles() {
//     elements.pubmedArticlesList.innerHTML = '';
    
//     state.articles.forEach(article => {
//       const articleElement = createArticleElement(article);
//       elements.pubmedArticlesList.appendChild(articleElement);
//     });
    
//     elements.pubmedResultCount.textContent = `${state.totalResults} articles found`;
    
//     // Show/hide load more button based on whether there are more results
//     const hasMoreResults = state.articles.length < state.totalResults;
//     showComponent(elements.pubmedPagination, hasMoreResults);
//   }
  
//   function extractConditions(article) {
//     const conditions = [];
//     const commonConditions = [
//       'diabetes', 'hypertension', 'cancer', 'asthma', 'arthritis', 
//       'alzheimer', 'parkinson', 'obesity', 'depression', 'anxiety',
//       'copd', 'hepatitis', 'hiv', 'stroke', 'heart disease', 'heart failure',
//       'multiple sclerosis', 'fibromyalgia', 'leukemia', 'epilepsy'
//     ];
    
//     // Check title, abstract, and keywords
//     const textToCheck = (article.title + ' ' + article.abstract + ' ' + article.keywords.join(' ')).toLowerCase();
    
//     commonConditions.forEach(condition => {
//       if (textToCheck.includes(condition)) {
//         // Capitalize first letter of each word
//         const formattedCondition = condition.replace(/\b\w/g, l => l.toUpperCase());
//         conditions.push(formattedCondition);
        
//         // Add to global state for treatment mapping
//         if (!state.conditions.includes(formattedCondition)) {
//           state.conditions.push(formattedCondition);
//         }
//       }
//     });
    
//     return conditions;
//   }
  
//   function extractTreatments(article) {
//     const treatments = [];
//     const commonTreatments = [
//       'metformin', 'insulin', 'statins', 'aspirin', 'ibuprofen',
//       'prednisone', 'albuterol', 'fluoxetine', 'amoxicillin',
//       'lisinopril', 'losartan', 'warfarin', 'heparin', 'atorvastatin',
//       'levothyroxine', 'omeprazole', 'gabapentin', 'amlodipine', 'metoprolol'
//     ];
    
//     // Check abstract and title
//     const textToCheck = (article.title + ' ' + article.abstract).toLowerCase();
    
//     commonTreatments.forEach(treatment => {
//       if (textToCheck.includes(treatment)) {
//         // Capitalize first letter
//         const formattedTreatment = treatment.charAt(0).toUpperCase() + treatment.slice(1);
//         treatments.push(formattedTreatment);
        
//         // Build treatment-condition relationships
//         extractConditions(article).forEach(condition => {
//           if (!state.treatments[condition]) {
//             state.treatments[condition] = [];
//           }
//           if (!state.treatments[condition].includes(formattedTreatment)) {
//             state.treatments[condition].push(formattedTreatment);
//           }
//         });
//       }
//     });
    
//     return treatments;
//   }

//   function generateAccurateSummary(articles) {
//     // Show loading state
//     showComponent(elements.pubmedSummary, true);
//     showComponent(elements.pubmedSummaryLoading, true);
//     showComponent(elements.pubmedSummaryContent, false);
    
//     // Process in setTimeout to not block UI
//     setTimeout(() => {
//       try {
//         // Extract publication years with accurate counting
//         const years = {};
//         articles.forEach(article => {
//           if (!article.pubDate) return;
          
//           const date = new Date(article.pubDate);
//           const year = date.getFullYear();
//           if (!isNaN(year)) {
//             years[year] = (years[year] || 0) + 1;
//           }
//         });
        
//         // Sort years chronologically
//         const sortedYears = Object.entries(years)
//           .sort(([yearA], [yearB]) => parseInt(yearA) - parseInt(yearB));
        
//         // Generate accurate timeline visualization
//         let timelineHtml = '';
//         if (sortedYears.length > 0) {
//           // Find max count for accurate scaling
//           const maxCount = Math.max(...sortedYears.map(([, count]) => count));
          
//           timelineHtml = `
//             <div class="overflow-x-auto">
//               <table class="w-full min-w-full">
//                 <tbody>
//                   ${sortedYears.map(([year, count]) => {
//                     // Calculate width percentage (minimum 5%, maximum 95%)
//                     const widthPercent = Math.max(5, Math.min(95, (count / maxCount) * 100));
                    
//                     return `
//                       <tr class="border-b border-gray-100">
//                         <td class="py-1 pr-2 text-right font-medium text-sm w-16">${year}</td>
//                         <td class="py-1 w-full">
//                           <div class="flex items-center">
//                             <div class="bg-primary h-5 rounded-sm" style="width: ${widthPercent}%"></div>
//                             <span class="ml-2 text-sm">${count}</span>
//                           </div>
//                         </td>
//                       </tr>
//                     `;
//                   }).join('')}
//                 </tbody>
//               </table>
//             </div>
//             <p class="text-xs text-gray-500 mt-2">Publications by year (based on all ${articles.length} articles)</p>
//           `;
//         } else {
//           timelineHtml = '<p class="text-sm text-gray-500">Timeline data not available for these articles</p>';
//         }
        
//         // Extract journals with accurate counting
//         const journals = {};
//         let journalsWithArticles = 0;
        
//         articles.forEach(article => {
//           if (article.journal && article.journal.trim() !== '') {
//             journals[article.journal] = (journals[article.journal] || 0) + 1;
//             journalsWithArticles++;
//           }
//         });
        
//         // Get top journals, sorted by frequency
//         const topJournals = Object.entries(journals)
//           .sort(([,countA], [,countB]) => countB - countA)
//           .slice(0, 5);
        
//         let journalsHtml = '';
//         if (topJournals.length > 0) {
//           journalsHtml = `
//             <ul class="list-disc list-inside">
//               ${topJournals.map(([journal, count]) => 
//                 `<li class="mb-1">${journal} 
//                   <span class="text-gray-500 text-sm">(${count} article${count !== 1 ? 's' : ''}, 
//                   ${Math.round((count / journalsWithArticles) * 100)}% of those with journal data)</span>
//                 </li>`
//               ).join('')}
//             </ul>
//             <p class="text-xs text-gray-500 mt-2">Top journals from ${Object.keys(journals).length} unique sources</p>
//           `;
//         } else {
//           journalsHtml = '<p class="text-sm text-gray-500">Journal data not available for these articles</p>';
//         }
        
//         // Extract keywords/topics with accurate counting
//         const topics = {};
//         let topicsMentioned = 0;
        
//         articles.forEach(article => {
//           // Process both keywords and extract meaningful terms from title/abstract
//           const processKeywords = keyword => {
//             if (keyword && keyword.trim().length > 3) {
//               // Normalize keyword (lowercase, trim)
//               const normalizedKeyword = keyword.trim().toLowerCase();
//               if (normalizedKeyword) {
//                 topics[normalizedKeyword] = (topics[normalizedKeyword] || 0) + 1;
//                 topicsMentioned++;
//               }
//             }
//           };
          
//           // Process explicit keywords
//           article.keywords.forEach(processKeywords);
          
//           // Extract potential topics from title that aren't in keywords
//           const titleWords = article.title.split(/\s+/).filter(word => word.length > 5);
//           titleWords.forEach(processKeywords);
//         });
        
//         // Get top topics, accurately sorted by frequency
//         const topTopics = Object.entries(topics)
//           .sort(([,countA], [,countB]) => countB - countA)
//           .slice(0, 20);
        
//         let topicsHtml = '';
//         if (topTopics.length > 0) {
//           // More accurate font scaling based on frequency
//           const maxTopicCount = Math.max(...topTopics.map(([, count]) => count));
          
//           topicsHtml = `<div class="flex flex-wrap gap-2">`;
//           topicsHtml += topTopics.map(([topic, count]) => {
//             // Scale font size: 0.8rem (min) to 1.3rem (max)
//             const fontSize = 0.8 + (count / maxTopicCount) * 0.5;
//             // Calculate relative percentage
//             const percentage = Math.round((count / topicsMentioned) * 100);
            
//             return `<span class="bg-gray-200 text-gray-700 px-2 py-1 rounded-full cursor-help" 
//                         style="font-size: ${fontSize}rem" 
//                         title="${count} occurrences (${percentage}% of topic mentions)">${topic}</span>`;
//           }).join(' ');
//           topicsHtml += `</div>`;
//           topicsHtml += `<p class="text-xs text-gray-500 mt-2">Based on keywords and title analysis across all articles</p>`;
//         } else {
//           topicsHtml = '<p class="text-sm text-gray-500">No common topics identified in these articles</p>';
//         }
        
//         // Update the DOM with accurate data
//         elements.pubmedTimeline.innerHTML = timelineHtml;
//         elements.pubmedJournals.innerHTML = journalsHtml;
//         elements.pubmedTopicsCloud.innerHTML = topicsHtml;
        
//         // Generate accurate research areas
//         generateAccurateResearchAreas(articles);
        
//         // Hide loading, show content
//         showComponent(elements.pubmedSummaryLoading, false);
//         showComponent(elements.pubmedSummaryContent, true);
        
//       } catch (error) {
//         console.error('Error generating summary:', error);
//         elements.pubmedSummary.innerHTML = `
//           <p class="text-sm text-gray-500">Could not generate research summary: ${error.message}</p>
//         `;
//       }
//     }, 100);
//   }
  
//   function generateAccurateResearchAreas(articles) {
//     // Create a more accurate approach to finding key research areas
//     // Count frequencies of meaningful research-related terms
//     const researchTerms = {};
    
//     const commonPhrases = [
//       'clinical trial', 'meta-analysis', 'systematic review', 'randomized controlled trial',
//       'cohort study', 'case-control', 'double-blind', 'placebo-controlled', 'prospective study',
//       'retrospective study', 'cross-sectional', 'longitudinal study', 'observational study',
//       'efficacy', 'safety', 'mechanism', 'pathophysiology', 'etiology', 'diagnosis',
//       'prevention', 'treatment outcome', 'prognosis', 'epidemiology', 'genetics',
//       'biomarkers', 'pharmacology', 'therapeutic use', 'adverse effects', 
//       'drug therapy', 'comparative study', 'drug resistance', 'pathology'
//     ];
    
//     // More accurate analysis using context
//     articles.forEach(article => {
//       const text = (article.title + ' ' + article.abstract).toLowerCase();
      
//       commonPhrases.forEach(phrase => {
//         // Look for whole phrases, not partial matches
//         const regex = new RegExp(`\\b${phrase}\\b`, 'gi');
//         const matches = text.match(regex);
        
//         if (matches && matches.length > 0) {
//           researchTerms[phrase] = (researchTerms[phrase] || 0) + matches.length;
//         }
//       });
//     });
    
//     // Sort by frequency and take top areas
//     const topResearchAreas = Object.entries(researchTerms)
//       .sort(([,countA], [,countB]) => countB - countA)
//       .slice(0, 8);
    
//     let areasHtml = '';
//     if (topResearchAreas.length > 0) {
//       areasHtml = `
//         <ul class="list-disc list-inside">
//           ${topResearchAreas.map(([area, count]) => 
//             `<li class="capitalize mb-1">
//               ${area}
//               <span class="text-gray-500 text-sm">(${count} mention${count !== 1 ? 's' : ''})</span>
//             </li>`
//           ).join('')}
//         </ul>
//         <p class="text-xs text-gray-500 mt-2">Based on methodology and focus analysis of all articles</p>
//       `;
//     } else {
//       areasHtml = '<p class="text-sm text-gray-500">Research focus areas could not be determined for these articles</p>';
//     }
    
//     elements.pubmedKeyAreas.innerHTML = areasHtml;
//   }
  
//   function generateTreatmentsDisplay() {
//     if (!elements.pubmedTreatments) return;
    
//     showComponent(elements.pubmedTreatments, true);
//     showComponent(elements.pubmedTreatmentsLoading, true);
//     showComponent(elements.pubmedTreatmentsContent, false);
    
//     setTimeout(() => {
//       try {
//         // Generate HTML for conditions and treatments
//         let treatmentsHtml = '';
        
//         if (Object.keys(state.treatments).length > 0) {
//           treatmentsHtml = `
//             <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
//               ${Object.entries(state.treatments)
//                 .sort(([condA], [condB]) => condA.localeCompare(condB))
//                 .map(([condition, treatments]) => `
//                   <div class="bg-gray-50 p-4 rounded-lg">
//                     <h3 class="font-semibold text-gray-800 mb-2">${condition}</h3>
//                     <div class="flex flex-wrap gap-2">
//                       ${treatments
//                         .sort((a, b) => a.localeCompare(b))
//                         .map(treatment => 
//                           `<span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">
//                             ${treatment}
//                           </span>`
//                         ).join('')}
//                     </div>
//                   </div>
//                 `).join('')}
//             </div>
//           `;
//         } else {
//           treatmentsHtml = `
//             <div class="text-center p-6">
//               <p class="text-gray-500">No treatment information was identified in the current articles.</p>
//               <p class="text-sm text-gray-400 mt-2">Try searching for a specific condition to find related treatments.</p>
//             </div>
//           `;
//         }
        
//         elements.pubmedTreatmentsContent.innerHTML = treatmentsHtml;
        
//         showComponent(elements.pubmedTreatmentsLoading, false);
//         showComponent(elements.pubmedTreatmentsContent, true);
        
//       } catch (error) {
//         console.error('Error generating treatments display:', error);
//         elements.pubmedTreatmentsContent.innerHTML = `
//           <p class="text-sm text-gray-500">Could not generate treatments information: ${error.message}</p>
//         `;
//         showComponent(elements.pubmedTreatmentsLoading, false);
//         showComponent(elements.pubmedTreatmentsContent, true);
//       }
//     }, 100);
//   }

//   async function searchPubMed(term, options = {}) {
//     state.isLoading = true;
//     state.term = term;
//     state.currentPage = options.page || 1;
//     state.sortBy = options.sortBy || state.sortBy;
//     state.fullTextOnly = options.fullTextOnly !== undefined ? options.fullTextOnly : state.fullTextOnly;
    
//     // Reset treatments data if this is a new search
//     if (state.currentPage === 1) {
//       state.conditions = [];
//       state.treatments = {};
//     }
    
//     // Show the pubmed section and loading state
//     showComponent(elements.pubmedSection, true);
//     showComponent(elements.pubmedLoading, true);
//     showComponent(elements.pubmedError, false);
//     showComponent(elements.pubmedEmpty, false);
//     showComponent(elements.pubmedArticles, false);
//     showComponent(elements.pubmedSummary, false);
//     showComponent(elements.pubmedTreatments, false);
    
//     try {
//       const params = new URLSearchParams({
//         term: term,
//         page: state.currentPage,
//         sortBy: state.sortBy,
//         fullTextOnly: state.fullTextOnly
//       });
      
//       const response = await fetch(`/api/pubmed?${params}`);
      
//       if (!response.ok) {
//         throw new Error(`Server responded with status ${response.status}`);
//       }
      
//       const data = await response.json();
      
//       // Update state with fetched data
//       if (state.currentPage === 1) {
//         state.articles = data.articles;
//       } else {
//         state.articles = [...state.articles, ...data.articles];
//       }
      
//       state.totalResults = data.totalResults;
      
//       // Hide loading state
//       showComponent(elements.pubmedLoading, false);
      
//       if (state.articles.length === 0) {
//         showComponent(elements.pubmedEmpty, true);
//       } else {
//         showComponent(elements.pubmedArticles, true);
//         renderArticles();
        
//         // Generate treatments display
//         generateTreatmentsDisplay();
        
//         // Show or hide summary based on user preference
//         if (state.showSummary && state.currentPage === 1) {
//           generateAccurateSummary(state.articles);
//         }
//       }
      
//     } catch (error) {
//       console.error('Error fetching PubMed data:', error);
//       showComponent(elements.pubmedLoading, false);
//       showComponent(elements.pubmedError, true);
//       elements.pubmedErrorMessage.textContent = error.message || 'Failed to fetch articles. Please try again later.';
//     }
    
//     state.isLoading = false;
//   }
  
//   function initEventListeners() {
//     // Existing event listeners
//     if (elements.pubmedSort) {
//       elements.pubmedSort.addEventListener('change', () => {
//         searchPubMed(state.term, { 
//           page: 1, 
//           sortBy: elements.pubmedSort.value,
//           fullTextOnly: elements.pubmedFullTextOnly.checked 
//         });
//       });
//     }
    
//     if (elements.pubmedFullTextOnly) {
//       elements.pubmedFullTextOnly.addEventListener('change', () => {
//         searchPubMed(state.term, { 
//           page: 1, 
//           sortBy: elements.pubmedSort.value,
//           fullTextOnly: elements.pubmedFullTextOnly.checked 
//         });
//       });
//     }
    
//     if (elements.pubmedLoadMore) {
//       elements.pubmedLoadMore.addEventListener('click', () => {
//         if (!state.isLoading) {
//           searchPubMed(state.term, { 
//             page: state.currentPage + 1,
//             sortBy: elements.pubmedSort.value,
//             fullTextOnly: elements.pubmedFullTextOnly.checked
//           });
//         }
//       });
//     }
    
//     // New event listener for toggling summary
//     if (elements.pubmedToggleSummary) {
//       elements.pubmedToggleSummary.addEventListener('click', () => {
//         state.showSummary = !state.showSummary;
        
//         // Update button text
//         if (elements.pubmedToggleSummary.textContent) {
//           elements.pubmedToggleSummary.textContent = state.showSummary ? 'Hide Summary' : 'Show Summary';
//         }
        
//         // Show/hide summary section
//         showComponent(elements.pubmedSummary, state.showSummary);
        
//         // Generate summary if it's being shown and wasn't before
//         if (state.showSummary && state.articles.length > 0) {
//           generateAccurateSummary(state.articles);
//         }
//       });
//     }
    
//     // Add filter for specific conditions
//     if (elements.pubmedFilterBar) {
//       elements.pubmedFilterBar.addEventListener('click', (e) => {
//         if (e.target.classList.contains('condition-filter')) {
//           const condition = e.target.dataset.condition;
//           if (condition) {
//             // Add condition to search term
//             const newTerm = state.term.includes(condition) ? 
//               state.term : `${state.term} ${condition}`;
            
//             searchPubMed(newTerm, { page: 1 });
//           }
//         }
//       });
//     }
//   }
  
//   function init() {
//     initEventListeners();
//   }
  
//   return {
//     init,
//     searchPubMed,
//     toggleSummary: function(show) {
//       state.showSummary = show;
//       showComponent(elements.pubmedSummary, show);
//     }
//   };
// })();

// // Advanced PubMed Module with Specialized Condition & Drug Search iteration 3
// const PubMedModule = (function() {
//   const elements = {
//     // Main containers
//     // pubmedSection: document.getElementById('pubmedSection'),
//     // pubmedLoading: document.getElementById('pubmedLoading'),
//     // pubmedError: document.getElementById('pubmedError'),
//     pubmedSection: safeGetElement('pubmedSection'),
//   pubmedLoading: safeGetElement('pubmedLoading'),
//   pubmedError: safeGetElement('pubmedError'),

//     pubmedErrorMessage: document.getElementById('pubmedErrorMessage'),
//     pubmedEmpty: document.getElementById('pubmedEmpty'),
    
//     // Search related elements
//     pubmedSearchBox: document.getElementById('pubmedSearchBox'),
//     pubmedSearchByCondition: document.getElementById('pubmedSearchByCondition'),
//     pubmedSearchByDrug: document.getElementById('pubmedSearchByDrug'),
//     pubmedAdvancedToggle: document.getElementById('pubmedAdvancedToggle'),
//     pubmedAdvancedOptions: document.getElementById('pubmedAdvancedOptions'),
    
//     // Filter and sorting elements
//     pubmedSort: document.getElementById('pubmedSort'),
//     pubmedFullTextOnly: document.getElementById('pubmedFullTextOnly'),
//     pubmedYearFilter: document.getElementById('pubmedYearFilter'),
//     pubmedJournalFilter: document.getElementById('pubmedJournalFilter'),
    
//     // Results elements
//     pubmedArticles: document.getElementById('pubmedArticles'),
//     pubmedArticlesList: document.getElementById('pubmedArticlesList'),
//     pubmedResultCount: document.getElementById('pubmedResultCount'),
//     pubmedLoadMore: document.getElementById('pubmedLoadMore'),
//     pubmedPagination: document.getElementById('pubmedPagination'),
    
//     // Treatment results (replaces summary)
//     pubmedTreatments: document.getElementById('pubmedTreatments'),
//     pubmedTreatmentsLoading: document.getElementById('pubmedTreatmentsLoading'),
//     pubmedTreatmentsContent: document.getElementById('pubmedTreatmentsContent'),
    
//     // Drug information results
//     pubmedDrugInfo: document.getElementById('pubmedDrugInfo'),
//     pubmedDrugInfoLoading: document.getElementById('pubmedDrugInfoLoading'),
//     pubmedDrugInfoContent: document.getElementById('pubmedDrugInfoContent'),
    
//     // Rare condition input
//     pubmedRareConditionInput: document.getElementById('pubmedRareConditionInput'),
//     pubmedAddRareCondition: document.getElementById('pubmedAddRareCondition')
//   };

//   // State management for the module
//   let state = {
//     term: '',
//     searchType: 'general', // 'general', 'condition', or 'drug'
//     articles: [],
//     currentPage: 1,
//     totalResults: 0,
//     isLoading: false,
//     sortBy: 'relevance',
//     fullTextOnly: false,
//     yearFilter: '',
//     journalFilter: '',
//     medicalDatabase: {
//       conditions: [],
//       drugs: [],
//       conditionDrugMap: {},
//       drugConditionMap: {},
//       drugClasses: {},
//       articleEvidence: {},
//       recentUpdated: null
//     }
//   };

//   // Common drug classes for classification
//   const drugClasses = {
//     "Antibiotics": ["penicillin", "amoxicillin", "azithromycin", "ciprofloxacin", "doxycycline", "vancomycin"],
//     "Antidepressants": ["fluoxetine", "sertraline", "escitalopram", "bupropion", "venlafaxine", "trazodone"],
//     "Antihypertensives": ["lisinopril", "losartan", "amlodipine", "hydrochlorothiazide", "metoprolol", "valsartan"],
//     "Anti-inflammatories": ["ibuprofen", "naproxen", "celecoxib", "prednisone", "dexamethasone", "methylprednisolone"],
//     "Antidiabetics": ["metformin", "insulin", "glipizide", "sitagliptin", "empagliflozin", "liraglutide"],
//     "Anticoagulants": ["warfarin", "apixaban", "rivaroxaban", "dabigatran", "heparin", "enoxaparin"],
//     "Antipsychotics": ["risperidone", "olanzapine", "quetiapine", "aripiprazole", "haloperidol", "clozapine"],
//     "Anticonvulsants": ["levetiracetam", "lamotrigine", "valproic acid", "carbamazepine", "phenytoin", "gabapentin"],
//     "Biologics": ["adalimumab", "etanercept", "infliximab", "ustekinumab", "secukinumab", "rituximab"],
//     "Statins": ["atorvastatin", "simvastatin", "rosuvastatin", "pravastatin", "lovastatin", "fluvastatin"],
//     "Bronchodilators": ["albuterol", "salmeterol", "formoterol", "tiotropium", "ipratropium", "theophylline"],
//     "Antihistamines": ["loratadine", "cetirizine", "fexofenadine", "diphenhydramine", "hydroxyzine", "desloratadine"],
//     "Proton Pump Inhibitors": ["omeprazole", "esomeprazole", "pantoprazole", "lansoprazole", "rabeprazole", "dexlansoprazole"],
//     "Opioid Analgesics": ["morphine", "oxycodone", "hydrocodone", "tramadol", "fentanyl", "codeine"],
//     "Immunosuppressants": ["cyclosporine", "tacrolimus", "mycophenolate", "azathioprine", "sirolimus", "methotrexate"],
//     "Chemotherapy": ["cisplatin", "carboplatin", "doxorubicin", "paclitaxel", "fluorouracil", "gemcitabine"]
//   };

//   // Utility function to show/hide components
//   function showComponent(component, isVisible) {
//     if (!component) return;
    
//     if (isVisible) {
//       component.classList.remove('hidden');
//     } else {
//       component.classList.add('hidden');
//     }
//   }
  
//   // Utility function to format date
//   function formatDate(dateString) {
//     if (!dateString) return 'N/A';
//     const date = new Date(dateString);
//     return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
//   }

//   // Advanced function to detect conditions from text using NLP-like techniques
//   function extractConditions(article) {
//     const text = (article.title + ' ' + article.abstract).toLowerCase();
//     const extractedConditions = [];
    
//     // Common condition patterns
//     const conditionPatterns = [
//       // "Patients with X", "diagnosed with X", etc.
//       /(?:patients? with|diagnosed with|cases? of|subjects? with|suffering from|presented with)\s+([a-z0-9\-\s]+)(?:,|\.|;|\s+and|\s+or|\s+were|\s+was|\s+had|\s+have)/gi,
      
//       // "Treatment of X", "Management of X", etc.
//       /(?:treatment of|management of|therapy for|intervention for)\s+([a-z0-9\-\s]+)(?:,|\.|;|\s+was|\s+is|\s+has|\s+have)/gi,
      
//       // Common disease/disorder patterns
//       /([a-z0-9\-\s]{3,50})\s+(?:syndrome|disease|disorder|cancer|infection|deficiency)/gi,
      
//       // Match conditions with suffixes
//       /([a-z0-9\-\s]{3,40})(?:itis|emia|pathy|plasia|oma|trophy|toxicity|lysis)/gi
//     ];
    
//     // Extract using patterns
//     conditionPatterns.forEach(pattern => {
//       let match;
//       while ((match = pattern.exec(text)) !== null) {
//         const condition = match[1].trim();
        
//         // Filter out non-conditions
//         if (
//           condition.length > 3 && 
//           !/^(the|this|that|these|those|some|any|our|their|other|many|various|different|several|each|every|all|both|either|neither|few|one|two|three|four|five|ten)$/i.test(condition) &&
//           !extractedConditions.includes(condition)
//         ) {
//           // Format: capitalize first letter of each word
//           const formattedCondition = condition.replace(/\b\w/g, c => c.toUpperCase());
//           extractedConditions.push(formattedCondition);
//         }
//       }
//     });
    
//     // Keywords are often a good source of conditions
//     if (article.keywords && Array.isArray(article.keywords)) {
//       article.keywords.forEach(keyword => {
//         const keywordLower = keyword.toLowerCase();
        
//         // Keywords with these terms are likely conditions
//         if (
//           keywordLower.includes('disease') || 
//           keywordLower.includes('syndrome') || 
//           keywordLower.includes('disorder') || 
//           keywordLower.includes('deficiency') ||
//           keywordLower.includes('cancer') ||
//           keywordLower.includes('infection') ||
//           (keywordLower.length > 5 && !extractedConditions.includes(keyword))
//         ) {
//           const formattedKeyword = keyword.replace(/\b\w/g, c => c.toUpperCase());
//           extractedConditions.push(formattedKeyword);
//         }
//       });
//     }
    
//     // MeSH terms (if present) are very reliable for conditions
//     if (article.meshTerms && Array.isArray(article.meshTerms)) {
//       article.meshTerms.forEach(term => {
//         if (
//           term.includes('Disease') || 
//           term.includes('Syndrome') || 
//           term.includes('Disorder') || 
//           term.includes('Infection')
//         ) {
//           if (!extractedConditions.includes(term)) {
//             extractedConditions.push(term);
//           }
//         }
//       });
//     }
    
//     return [...new Set(extractedConditions)]; // Remove duplicates
//   }

//   // Advanced function to extract drugs/treatments from text
//   function extractDrugs(article) {
//     const text = (article.title + ' ' + article.abstract).toLowerCase();
//     const extractedDrugs = [];
    
//     // Common drug/treatment patterns
//     const drugPatterns = [
//       // "Treated with X", "administered X", etc.
//       /(?:treated with|treatment with|administered|given|received|therapy with|medication with)\s+([a-z0-9\-\s]+)(?:,|\.|;|\s+and|\s+or|\s+were|\s+was|\s+had|\s+have)/gi,
      
//       // Dosage patterns
//       /(?:dose of|doses of|dosage of|mg of|mcg of|g of)\s+([a-z0-9\-\s]+)(?:,|\.|;|\s+was|\s+were|\s+is|\s+are)/gi,
      
//       // "X therapy", "X treatment", etc.
//       /([a-z0-9\-\s]{3,40})\s+(?:therapy|treatment|administration|infusion|injection|medication)/gi
//     ];
    
//     // Extract using patterns
//     drugPatterns.forEach(pattern => {
//       let match;
//       while ((match = pattern.exec(text)) !== null) {
//         const drug = match[1].trim();
        
//         // Filter out non-drugs
//         if (
//           drug.length > 3 && 
//           !/^(the|this|that|these|those|some|any|our|their|other|many|various|different|several|each|every|all|both|either|neither|few|one|two|three|four|five|ten|standard|conventional|usual|current|intensive|maintenance)$/i.test(drug) &&
//           !extractedDrugs.includes(drug)
//         ) {
//           // Format: capitalize first letter of each word
//           const formattedDrug = drug.replace(/\b\w/g, c => c.toUpperCase());
//           extractedDrugs.push(formattedDrug);
//         }
//       }
//     });
    
//     // Check for drug class mentions
//     Object.entries(drugClasses).forEach(([className, drugs]) => {
//       // Check for the class name itself
//       if (text.includes(className.toLowerCase())) {
//         extractedDrugs.push(className);
//       }
      
//       // Check for specific drugs in this class
//       drugs.forEach(drug => {
//         if (new RegExp(`\\b${drug}\\b`, 'i').test(text)) {
//           // Format: capitalize first letter
//           const formattedDrug = drug.charAt(0).toUpperCase() + drug.slice(1);
//           if (!extractedDrugs.includes(formattedDrug)) {
//             extractedDrugs.push(formattedDrug);
//           }
//         }
//       });
//     });
    
//     // Keywords can also indicate drugs/treatments
//     if (article.keywords && Array.isArray(article.keywords)) {
//       article.keywords.forEach(keyword => {
//         const keywordLower = keyword.toLowerCase();
        
//         // Keywords with these terms are likely treatments
//         if (
//           keywordLower.includes('therapy') || 
//           keywordLower.includes('treatment') || 
//           keywordLower.includes('medication') || 
//           keywordLower.includes('drug') ||
//           keywordLower.includes('inhibitor') ||
//           keywordLower.includes('antagonist')
//         ) {
//           const formattedKeyword = keyword.replace(/\b\w/g, c => c.toUpperCase());
//           if (!extractedDrugs.includes(formattedKeyword)) {
//             extractedDrugs.push(formattedKeyword);
//           }
//         }
//       });
//     }
    
//     return [...new Set(extractedDrugs)]; // Remove duplicates
//   }

//   // Function to map conditions to drugs based on proximity and context
//   function mapConditionsToDrugs(article, conditions, drugs) {
//     const text = (article.title + ' ' + article.abstract).toLowerCase();
//     const conditionDrugMap = {};
//     const drugConditionMap = {};
    
//     // Initialize maps
//     conditions.forEach(condition => conditionDrugMap[condition] = []);
//     drugs.forEach(drug => drugConditionMap[drug] = []);
    
//     // For each condition, check proximity to drugs in the text
//     conditions.forEach(condition => {
//       const conditionLower = condition.toLowerCase();
      
//       // Find position of this condition in text
//       const conditionIndex = text.indexOf(conditionLower);
//       if (conditionIndex === -1) return; // Skip if not found
      
//       // Check each drug
//       drugs.forEach(drug => {
//         const drugLower = drug.toLowerCase();
//         const drugIndex = text.indexOf(drugLower);
//         if (drugIndex === -1) return; // Skip if not found
        
//         // If drug and condition are "close" to each other (within 150 chars)
//         // This is a simplistic proximity heuristic
//         if (Math.abs(drugIndex - conditionIndex) < 150) {
//           // Add to maps if not already present
//           if (!conditionDrugMap[condition].includes(drug)) {
//             conditionDrugMap[condition].push(drug);
//           }
//           if (!drugConditionMap[drug].includes(condition)) {
//             drugConditionMap[drug].push(condition);
//           }
//         }
//       });
//     });
    
//     // For each condition-drug pair, collect evidence
//     Object.entries(conditionDrugMap).forEach(([condition, mappedDrugs]) => {
//       mappedDrugs.forEach(drug => {
//         const evidenceKey = `${condition}|||${drug}`;
//         if (!state.medicalDatabase.articleEvidence[evidenceKey]) {
//           state.medicalDatabase.articleEvidence[evidenceKey] = [];
//         }
        
//         // Add this article as evidence if not already present
//         const alreadyAdded = state.medicalDatabase.articleEvidence[evidenceKey].some(
//           evidence => evidence.pmid === article.pmid
//         );
        
//         if (!alreadyAdded) {
//           state.medicalDatabase.articleEvidence[evidenceKey].push({
//             pmid: article.pmid,
//             title: article.title,
//             date: article.pubDate,
//             journal: article.journal,
//             excerpt: findRelevantExcerpt(text, condition, drug)
//           });
//         }
//       });
//     });
    
//     return { conditionDrugMap, drugConditionMap };
//   }
  
//   // Find relevant text excerpt that mentions both condition and drug
//   function findRelevantExcerpt(text, condition, drug) {
//     const conditionLower = condition.toLowerCase();
//     const drugLower = drug.toLowerCase();
    
//     // Find positions
//     const conditionIndex = text.indexOf(conditionLower);
//     const drugIndex = text.indexOf(drugLower);
    
//     if (conditionIndex === -1 || drugIndex === -1) return ""; // Not found
    
//     // Find the middle point between condition and drug mentions
//     const midPoint = (conditionIndex + drugIndex) / 2;
    
//     // Extract a snippet around the mentions (up to 150 chars)
//     const start = Math.max(0, midPoint - 75);
//     const end = Math.min(text.length, midPoint + 75);
    
//     return text.substring(start, end).trim() + "...";
//   }

//   // Process articles to extract medical knowledge
//   function processMedicalKnowledge(articles) {
//     let updatedDatabase = {
//       conditions: [...state.medicalDatabase.conditions],
//       drugs: [...state.medicalDatabase.drugs],
//       conditionDrugMap: {...state.medicalDatabase.conditionDrugMap},
//       drugConditionMap: {...state.medicalDatabase.drugConditionMap},
//       drugClasses: {...state.medicalDatabase.drugClasses},
//       articleEvidence: {...state.medicalDatabase.articleEvidence},
//       recentUpdated: new Date().toISOString()
//     };
    
//     articles.forEach(article => {
//       // Extract conditions and drugs
//       const conditions = extractConditions(article);
//       const drugs = extractDrugs(article);
      
//       // Skip if no conditions or drugs found
//       if (conditions.length === 0 || drugs.length === 0) return;
      
//       // Map conditions to drugs and vice versa
//       const { conditionDrugMap, drugConditionMap } = mapConditionsToDrugs(article, conditions, drugs);
      
//       // Update database with new conditions
//       conditions.forEach(condition => {
//         if (!updatedDatabase.conditions.includes(condition)) {
//           updatedDatabase.conditions.push(condition);
//         }
        
//         // Initialize or merge condition-drug mapping
//         if (!updatedDatabase.conditionDrugMap[condition]) {
//           updatedDatabase.conditionDrugMap[condition] = [];
//         }
        
//         // Add drugs for this condition
//         if (conditionDrugMap[condition]) {
//           conditionDrugMap[condition].forEach(drug => {
//             if (!updatedDatabase.conditionDrugMap[condition].includes(drug)) {
//               updatedDatabase.conditionDrugMap[condition].push(drug);
//             }
//           });
//         }
//       });
      
//       // Update database with new drugs
//       drugs.forEach(drug => {
//         if (!updatedDatabase.drugs.includes(drug)) {
//           updatedDatabase.drugs.push(drug);
//         }
        
//         // Initialize or merge drug-condition mapping
//         if (!updatedDatabase.drugConditionMap[drug]) {
//           updatedDatabase.drugConditionMap[drug] = [];
//         }
        
//         // Add conditions for this drug
//         if (drugConditionMap[drug]) {
//           drugConditionMap[drug].forEach(condition => {
//             if (!updatedDatabase.drugConditionMap[drug].includes(condition)) {
//               updatedDatabase.drugConditionMap[drug].push(condition);
//             }
//           });
//         }
        
//         // Categorize drug into drug classes
//         Object.entries(drugClasses).forEach(([className, classDrugs]) => {
//           if (classDrugs.some(classDrug => drug.toLowerCase().includes(classDrug))) {
//             if (!updatedDatabase.drugClasses[drug]) {
//               updatedDatabase.drugClasses[drug] = [];
//             }
//             if (!updatedDatabase.drugClasses[drug].includes(className)) {
//               updatedDatabase.drugClasses[drug].push(className);
//             }
//           }
//         });
//       });
//     });
    
//     return updatedDatabase;
//   }

//   // Create article element for display
//   function createArticleElement(article) {
//     const articleElement = document.createElement('div');
//     articleElement.className = 'bg-white rounded-lg p-4 shadow-sm hover:shadow-md transition-shadow duration-200 mb-4 border border-gray-100';
    
//     const hasDOI = article.doi && article.doi.trim() !== '';
//     const hasFullText = article.fullTextUrl && article.fullTextUrl.trim() !== '';
    
//     // Extract medical information
//     const conditions = extractConditions(article);
//     const drugs = extractDrugs(article);
    
//     // Determine if this contains rare conditions (not in our predefined lists)
//     const isRareCondition = conditions.some(condition => 
//       !Object.keys(drugClasses).includes(condition)
//     );
    
//     // Create HTML for medical findings section
//     let medicalFindings = '';
//     if (conditions.length > 0 || drugs.length > 0) {
//       medicalFindings = `
//         <div class="border-t border-gray-100 mt-3 pt-3">
//           ${conditions.length > 0 ? 
//             `<div class="mb-2">
//               <span class="text-xs font-medium text-gray-700">Conditions: </span>
//               <div class="flex flex-wrap gap-1 mt-1">
//                 ${conditions.map(condition => 
//                   `<span class="bg-blue-50 text-blue-700 text-xs px-2 py-1 rounded-full">${condition}</span>`
//                 ).join('')}
//               </div>
//             </div>` : ''
//           }
//           ${drugs.length > 0 ? 
//             `<div>
//               <span class="text-xs font-medium text-gray-700">Treatments: </span>
//               <div class="flex flex-wrap gap-1 mt-1">
//                 ${drugs.map(drug => 
//                   `<span class="bg-green-50 text-green-700 text-xs px-2 py-1 rounded-full">${drug}</span>`
//                 ).join('')}
//               </div>
//             </div>` : ''
//           }
//         </div>
//       `;
//     }
    
//     articleElement.innerHTML = `
//       <div class="flex justify-between">
//         <h3 class="text-lg font-semibold text-gray-800 mb-2">${article.title}</h3>
//         ${isRareCondition ? 
//           `<span class="bg-purple-100 text-purple-800 text-xs px-2 py-1 h-6 rounded-full">Rare Condition</span>` : 
//           ''
//         }
//       </div>
//       <div class="text-sm text-gray-600 mb-2">
//         ${article.authors.slice(0, 3).join(', ')}${article.authors.length > 3 ? ', et al.' : ''}
//       </div>
//       <div class="text-sm text-gray-500 mb-3 flex flex-wrap items-center gap-2">
//         <span class="font-medium">${article.journal || 'Journal not specified'}</span>
//         <span class="inline-block w-1 h-1 rounded-full bg-gray-300"></span>
//         <span>${formatDate(article.pubDate)}</span>
//         <span class="inline-block w-1 h-1 rounded-full bg-gray-300"></span>
//         <span>PMID: ${article.pmid}</span>
//       </div>
//       <p class="text-gray-700 text-sm mb-3">${article.abstract.substring(0, 200)}${article.abstract.length > 200 ? '...' : ''}</p>
//       ${article.keywords && article.keywords.length > 0 ? 
//         `<div class="flex flex-wrap gap-1 mb-3">
//           ${article.keywords.map(keyword => 
//             `<span class="bg-gray-100 text-gray-700 text-xs px-2 py-1 rounded-full">${keyword}</span>`
//           ).join('')}
//         </div>` : ''
//       }
//       ${medicalFindings}
//       <div class="flex flex-wrap gap-2 mt-3">
//         <a href="https://pubmed.ncbi.nlm.nih.gov/${article.pmid}" target="_blank" 
//            class="text-primary hover:text-primary-dark text-sm flex items-center">
//           <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
//           </svg>
//           View on PubMed
//         </a>
//         ${hasDOI ? 
//           `<a href="https://doi.org/${article.doi}" target="_blank" 
//               class="text-primary hover:text-primary-dark text-sm flex items-center">
//             <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//               <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101" />
//               <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 015.656 0l4 4a4 4 0 01-5.656 5.656l-1.102-1.101" />
//             </svg>
//             DOI
//           </a>` : ''
//         }
//         ${hasFullText ? 
//           `<a href="${article.fullTextUrl}" target="_blank" 
//               class="text-primary hover:text-primary-dark text-sm flex items-center">
//             <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//               <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
//             </svg>
//             Full Text
//           </a>` : ''
//         }
//       </div>
//     `;
    
//     return articleElement;
//   }

//   // Render articles in the list
//   function renderArticles() {
//     if (!elements.pubmedArticlesList) return;
    
//     elements.pubmedArticlesList.innerHTML = '';
    
//     state.articles.forEach(article => {
//       const articleElement = createArticleElement(article);
//       elements.pubmedArticlesList.appendChild(articleElement);
//     });
    
//     if (elements.pubmedResultCount) {
//       elements.pubmedResultCount.textContent = `${state.totalResults} articles found`;
//     }
    
//     // Show/hide load more button based on whether there are more results
//     const hasMoreResults = state.articles.length < state.totalResults;
//     showComponent(elements.pubmedPagination, hasMoreResults);
//   }

//   // Render treatments for a condition
//   function renderTreatmentsForCondition(condition) {
//     if (!elements.pubmedTreatments) return;
    
//     showComponent(elements.pubmedTreatments, true);
//     showComponent(elements.pubmedTreatmentsLoading, true);
//     showComponent(elements.pubmedTreatmentsContent, false);
    
//     setTimeout(() => {
//       try {
//         // Get treatments for this condition
//         const treatments = state.medicalDatabase.conditionDrugMap[condition] || [];
        
//         if (treatments.length === 0) {
//           elements.pubmedTreatmentsContent.innerHTML = `
//             <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-100">
//               <h3 class="text-yellow-800 font-medium mb-2">No treatments found for ${condition}</h3>
//               <p class="text-yellow-700 text-sm">
//                 We couldn't identify specific treatments for this condition in the current articles.
//                 Try searching for more specific terms or expand your search.
//               </p>
//             </div>
//           `;
//         } else {
//           // Group treatments by drug class if possible
//           const treatmentsByClass = {};
//           const unclassifiedTreatments = [];
          
//           treatments.forEach(treatment => {
//             const classes = state.medicalDatabase.drugClasses[treatment] || [];
            
//             if (classes.length > 0) {
//               classes.forEach(className => {
//                 if (!treatmentsByClass[className]) {
//                   treatmentsByClass[className] = [];
//                 }
//                 if (!treatmentsByClass[className].includes(treatment)) {
//                   treatmentsByClass[className].push(treatment);
//                 }
//               });
//             } else {
//               unclassifiedTreatments.push(treatment);
//             }
//           });
          
// // Continue from previous code block...

// let html = `
//             <div class="bg-blue-50 p-4 rounded-lg border border-blue-100 mb-6">
//               <h3 class="text-blue-800 font-medium flex items-center">
//                 <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                   <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
//                 </svg>
//                 Treatments for ${condition}
//               </h3>
//               <p class="text-blue-700 text-sm mt-1">
//                 Found ${treatments.length} potential treatments across ${Object.keys(state.medicalDatabase.articleEvidence).filter(key => key.startsWith(condition)).length} articles.
//               </p>
//             </div>
            
//             <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
//           `;
          
//           // Add classified treatments
//           Object.entries(treatmentsByClass).forEach(([className, drugs]) => {
//             html += `
//               <div class="bg-white rounded-lg p-4 shadow-sm border border-gray-100">
//                 <h4 class="font-medium text-gray-800 mb-2">${className}</h4>
//                 <div class="flex flex-wrap gap-2">
//                   ${drugs.map(drug => {
//                     // Get evidence count
//                     const evidenceKey = `${condition}|||${drug}`;
//                     const evidenceCount = state.medicalDatabase.articleEvidence[evidenceKey]?.length || 0;
                    
//                     return `
//                       <button class="treatment-pill bg-green-50 hover:bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm flex items-center transition-colors duration-200"
//                               data-condition="${condition}" 
//                               data-treatment="${drug}" 
//                               data-evidence="${evidenceCount}">
//                         ${drug}
//                         <span class="ml-1 bg-green-700 text-white text-xs rounded-full w-5 h-5 inline-flex items-center justify-center">${evidenceCount}</span>
//                       </button>
//                     `;
//                   }).join('')}
//                 </div>
//               </div>
//             `;
//           });
          
//           // Add unclassified treatments if any
//           if (unclassifiedTreatments.length > 0) {
//             html += `
//               <div class="bg-white rounded-lg p-4 shadow-sm border border-gray-100">
//                 <h4 class="font-medium text-gray-800 mb-2">Other Treatments</h4>
//                 <div class="flex flex-wrap gap-2">
//                   ${unclassifiedTreatments.map(drug => {
//                     // Get evidence count
//                     const evidenceKey = `${condition}|||${drug}`;
//                     const evidenceCount = state.medicalDatabase.articleEvidence[evidenceKey]?.length || 0;
                    
//                     return `
//                       <button class="treatment-pill bg-green-50 hover:bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm flex items-center transition-colors duration-200"
//                               data-condition="${condition}" 
//                               data-treatment="${drug}" 
//                               data-evidence="${evidenceCount}">
//                         ${drug}
//                         <span class="ml-1 bg-green-700 text-white text-xs rounded-full w-5 h-5 inline-flex items-center justify-center">${evidenceCount}</span>
//                       </button>
//                     `;
//                   }).join('')}
//                 </div>
//               </div>
//             `;
//           }
          
//           // Add treatment evidence section (initially hidden, will be shown when a treatment is clicked)
//           html += `
//             </div>
            
//             <div id="pubmedTreatmentEvidence" class="mt-6 hidden">
//               <h3 class="text-lg font-medium text-gray-800 mb-2">Evidence for <span id="evidenceTreatmentName"></span></h3>
//               <div id="pubmedTreatmentEvidenceList" class="space-y-3"></div>
//             </div>
//           `;
          
//           elements.pubmedTreatmentsContent.innerHTML = html;
          
//           // Add event listeners for treatment pills
//           document.querySelectorAll('.treatment-pill').forEach(pill => {
//             pill.addEventListener('click', function() {
//               const condition = this.dataset.condition;
//               const treatment = this.dataset.treatment;
//               showTreatmentEvidence(condition, treatment);
//             });
//           });
//         }
        
//         // Hide loading, show content
//         showComponent(elements.pubmedTreatmentsLoading, false);
//         showComponent(elements.pubmedTreatmentsContent, true);
        
//       } catch (error) {
//         console.error('Error rendering treatments:', error);
//         elements.pubmedTreatmentsContent.innerHTML = `
//           <div class="bg-red-50 p-4 rounded-lg border border-red-100">
//             <h3 class="text-red-800 font-medium">Error</h3>
//             <p class="text-red-700 text-sm mt-1">
//               Could not generate treatments information: ${error.message}
//             </p>
//           </div>
//         `;
        
//         showComponent(elements.pubmedTreatmentsLoading, false);
//         showComponent(elements.pubmedTreatmentsContent, true);
//       }
//     }, 100);
//   }

//   // Show evidence for a specific treatment
//   function showTreatmentEvidence(condition, treatment) {
//     const evidenceKey = `${condition}|||${treatment}`;
//     const evidence = state.medicalDatabase.articleEvidence[evidenceKey] || [];
    
//     const evidenceDiv = document.getElementById('pubmedTreatmentEvidence');
//     const evidenceName = document.getElementById('evidenceTreatmentName');
//     const evidenceList = document.getElementById('pubmedTreatmentEvidenceList');
    
//     if (!evidenceDiv || !evidenceName || !evidenceList) return;
    
//     evidenceName.textContent = `${treatment} for ${condition}`;
//     evidenceList.innerHTML = '';
    
//     if (evidence.length === 0) {
//       evidenceList.innerHTML = `
//         <p class="text-gray-500">No specific evidence found linking this treatment to the condition.</p>
//       `;
//     } else {
//       evidence.forEach(item => {
//         const evidenceItem = document.createElement('div');
//         evidenceItem.className = 'bg-white rounded-lg p-3 shadow-sm border border-gray-100';
        
//         evidenceItem.innerHTML = `
//           <div class="flex justify-between">
//             <h4 class="font-medium text-gray-800">${item.title}</h4>
//             <span class="text-gray-500 text-sm">${formatDate(item.date)}</span>
//           </div>
//           <p class="text-gray-600 text-sm mt-1">${item.journal || 'Journal not specified'}</p>
//           ${item.excerpt ? `
//             <div class="mt-2 text-sm text-gray-700 bg-gray-50 p-2 rounded">
//               <p>…${item.excerpt}…</p>
//             </div>
//           ` : ''}
//           <div class="mt-2">
//             <a href="https://pubmed.ncbi.nlm.nih.gov/${item.pmid}" target="_blank" 
//                class="text-primary hover:text-primary-dark text-sm flex items-center inline-block">
//               <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
//               </svg>
//               View on PubMed
//             </a>
//           </div>
//         `;
        
//         evidenceList.appendChild(evidenceItem);
//       });
//     }
    
//     // Show evidence section
//     evidenceDiv.classList.remove('hidden');
    
//     // Scroll to evidence
//     evidenceDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
//   }

//   // Render drug information 
//   function renderDrugInformation(drug) {
//     if (!elements.pubmedDrugInfo) return;
    
//     showComponent(elements.pubmedDrugInfo, true);
//     showComponent(elements.pubmedDrugInfoLoading, true);
//     showComponent(elements.pubmedDrugInfoContent, false);
    
//     setTimeout(() => {
//       try {
//         // Get conditions treated by this drug
//         const conditions = state.medicalDatabase.drugConditionMap[drug] || [];
        
//         if (conditions.length === 0) {
//           elements.pubmedDrugInfoContent.innerHTML = `
//             <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-100">
//               <h3 class="text-yellow-800 font-medium mb-2">No conditions found for ${drug}</h3>
//               <p class="text-yellow-700 text-sm">
//                 We couldn't identify specific conditions treated by this drug in the current articles.
//                 Try searching for more specific terms or expand your search.
//               </p>
//             </div>
//           `;
//         } else {
//           // Get drug class information
//           const drugClasses = state.medicalDatabase.drugClasses[drug] || [];
//           const totalArticles = conditions.reduce((count, condition) => {
//             const evidenceKey = `${condition}|||${drug}`;
//             return count + (state.medicalDatabase.articleEvidence[evidenceKey]?.length || 0);
//           }, 0);
          
//           // Create HTML for drug information
//           let html = `
//             <div class="bg-green-50 p-4 rounded-lg border border-green-100 mb-6">
//               <h3 class="text-green-800 font-medium flex items-center">
//                 <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                   <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
//                 </svg>
//                 ${drug} Information
//               </h3>
//               <div class="text-green-700 text-sm mt-1">
//                 <p>Used to treat ${conditions.length} condition${conditions.length !== 1 ? 's' : ''}.</p>
//                 ${drugClasses.length > 0 ? 
//                   `<p class="mt-1">Classification: ${drugClasses.join(', ')}.</p>` : 
//                   ''
//                 }
//                 <p class="mt-1">Mentioned in ${totalArticles} article${totalArticles !== 1 ? 's' : ''}.</p>
//               </div>
//             </div>
            
//             <h3 class="text-lg font-medium text-gray-800 mb-3">Conditions Treated</h3>
//             <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
//           `;
          
//           // Add conditions
//           conditions.forEach(condition => {
//             const evidenceKey = `${condition}|||${drug}`;
//             const evidenceCount = state.medicalDatabase.articleEvidence[evidenceKey]?.length || 0;
            
//             html += `
//               <div class="bg-white rounded-lg p-4 shadow-sm border border-gray-100">
//                 <h4 class="font-medium text-gray-800 mb-2">${condition}</h4>
//                 <div class="text-sm text-gray-600 mb-2">
//                   Found in ${evidenceCount} article${evidenceCount !== 1 ? 's' : ''}
//                 </div>
//                 <button class="condition-pill bg-blue-50 hover:bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-sm transition-colors duration-200"
//                         data-condition="${condition}" 
//                         data-drug="${drug}">
//                   View Evidence
//                 </button>
//               </div>
//             `;
//           });
          
//           // Add drug evidence section
//           html += `
//             </div>
            
//             <div id="pubmedDrugEvidence" class="mt-6 hidden">
//               <h3 class="text-lg font-medium text-gray-800 mb-2">Evidence for <span id="evidenceDrugCondition"></span></h3>
//               <div id="pubmedDrugEvidenceList" class="space-y-3"></div>
//             </div>
//           `;
          
//           elements.pubmedDrugInfoContent.innerHTML = html;
          
//           // Add event listeners for condition pills
//           document.querySelectorAll('.condition-pill').forEach(pill => {
//             pill.addEventListener('click', function() {
//               const condition = this.dataset.condition;
//               const drug = this.dataset.drug;
//               showDrugEvidence(condition, drug);
//             });
//           });
//         }
        
//         // Hide loading, show content
//         showComponent(elements.pubmedDrugInfoLoading, false);
//         showComponent(elements.pubmedDrugInfoContent, true);
        
//       } catch (error) {
//         console.error('Error rendering drug information:', error);
//         elements.pubmedDrugInfoContent.innerHTML = `
//           <div class="bg-red-50 p-4 rounded-lg border border-red-100">
//             <h3 class="text-red-800 font-medium">Error</h3>
//             <p class="text-red-700 text-sm mt-1">
//               Could not generate drug information: ${error.message}
//             </p>
//           </div>
//         `;
        
//         showComponent(elements.pubmedDrugInfoLoading, false);
//         showComponent(elements.pubmedDrugInfoContent, true);
//       }
//     }, 100);
//   }

//   // Show evidence for a specific drug treating a condition
//   function showDrugEvidence(condition, drug) {
//     const evidenceKey = `${condition}|||${drug}`;
//     const evidence = state.medicalDatabase.articleEvidence[evidenceKey] || [];
    
//     const evidenceDiv = document.getElementById('pubmedDrugEvidence');
//     const evidenceCondition = document.getElementById('evidenceDrugCondition');
//     const evidenceList = document.getElementById('pubmedDrugEvidenceList');
    
//     if (!evidenceDiv || !evidenceCondition || !evidenceList) return;
    
//     evidenceCondition.textContent = `${drug} for ${condition}`;
//     evidenceList.innerHTML = '';
    
//     if (evidence.length === 0) {
//       evidenceList.innerHTML = `
//         <p class="text-gray-500">No specific evidence found linking this drug to the condition.</p>
//       `;
//     } else {
//       evidence.forEach(item => {
//         const evidenceItem = document.createElement('div');
//         evidenceItem.className = 'bg-white rounded-lg p-3 shadow-sm border border-gray-100';
        
//         evidenceItem.innerHTML = `
//           <div class="flex justify-between">
//             <h4 class="font-medium text-gray-800">${item.title}</h4>
//             <span class="text-gray-500 text-sm">${formatDate(item.date)}</span>
//           </div>
//           <p class="text-gray-600 text-sm mt-1">${item.journal || 'Journal not specified'}</p>
//           ${item.excerpt ? `
//             <div class="mt-2 text-sm text-gray-700 bg-gray-50 p-2 rounded">
//               <p>…${item.excerpt}…</p>
//             </div>
//           ` : ''}
//           <div class="mt-2">
//             <a href="https://pubmed.ncbi.nlm.nih.gov/${item.pmid}" target="_blank" 
//                class="text-primary hover:text-primary-dark text-sm flex items-center inline-block">
//               <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
//               </svg>
//               View on PubMed
//             </a>
//           </div>
//         `;
        
//         evidenceList.appendChild(evidenceItem);
//       });
//     }
    
//     // Show evidence section
//     evidenceDiv.classList.remove('hidden');
    
//     // Scroll to evidence
//     evidenceDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
//   }

//   // Function to search PubMed by general term (original function)
//   async function searchPubMed(term, options = {}) {
//     state.isLoading = true;
//     state.term = term;
//     state.currentPage = options.page || 1;
//     state.sortBy = options.sortBy || state.sortBy;
//     state.fullTextOnly = options.fullTextOnly !== undefined ? options.fullTextOnly : state.fullTextOnly;
//     state.yearFilter = options.yearFilter || state.yearFilter;
//     state.journalFilter = options.journalFilter || state.journalFilter;
//     state.searchType = 'general';
    
//     // Show the pubmed section and loading state
//     showComponent(elements.pubmedSection, true);
//     showComponent(elements.pubmedLoading, true);
//     showComponent(elements.pubmedError, false);
//     showComponent(elements.pubmedEmpty, false);
//     showComponent(elements.pubmedArticles, false);
//     showComponent(elements.pubmedTreatments, false);
//     showComponent(elements.pubmedDrugInfo, false);
    
//     try {
//       const params = new URLSearchParams({
//         term: term,
//         page: state.currentPage,
//         sortBy: state.sortBy,
//         fullTextOnly: state.fullTextOnly,
//         yearFilter: state.yearFilter,
//         journalFilter: state.journalFilter
//       });
      
//       const response = await fetch(`/api/pubmed?${params}`);
//       console.log(`PubMed API Request: /api/pubmed?${params}`);


//       if (!response.ok) {
//         throw new Error(`Server responded with status ${response.status}`);
//       }
      
//       const data = await response.json();
//       // After receiving response
//       console.log('PubMed API Response:', data);
//       // Update state with fetched data
//       if (state.currentPage === 1) {
//         state.articles = data.articles;
//       } else {
//         state.articles = [...state.articles, ...data.articles];
//       }
      
//       state.totalResults = data.totalResults;
      
//       // Process articles for medical knowledge if this is a new search
//       if (state.currentPage === 1) {
//         // Reset database for a new search
//         state.medicalDatabase = {
//           conditions: [],
//           drugs: [],
//           conditionDrugMap: {},
//           drugConditionMap: {},
//           drugClasses: {},
//           articleEvidence: {},
//           recentUpdated: null
//         };
//       }
      
//       // Process the medical knowledge
//       state.medicalDatabase = processMedicalKnowledge(state.articles);
      
//       // Hide loading state
//       showComponent(elements.pubmedLoading, false);
      
//       if (state.articles.length === 0) {
//         showComponent(elements.pubmedEmpty, true);
//       } else {
//         showComponent(elements.pubmedArticles, true);
//         renderArticles();
//       }
      
//     } catch (error) {
//       console.error('Error fetching PubMed data:', error);
//       showComponent(elements.pubmedLoading, false);
//       showComponent(elements.pubmedError, true);
//       if (elements.pubmedErrorMessage) {
//         elements.pubmedErrorMessage.textContent = error.message || 'Failed to fetch articles. Please try again later.';
//       }
//     }
    
//     state.isLoading = false;
//   }

//   // Function to search PubMed by condition and show treatments
//   async function searchPubMedByCondition(condition, options = {}) {
//     state.isLoading = true;
//     state.term = condition;
//     state.currentPage = options.page || 1;
//     state.sortBy = options.sortBy || state.sortBy;
//     state.fullTextOnly = options.fullTextOnly !== undefined ? options.fullTextOnly : state.fullTextOnly;
//     state.yearFilter = options.yearFilter || state.yearFilter;
//     state.journalFilter = options.journalFilter || state.journalFilter;
//     state.searchType = 'condition';
    
//     // Show the pubmed section and loading state
//     showComponent(elements.pubmedSection, true);
//     showComponent(elements.pubmedLoading, true);
//     showComponent(elements.pubmedError, false);
//     showComponent(elements.pubmedEmpty, false);
//     showComponent(elements.pubmedArticles, false);
//     showComponent(elements.pubmedTreatments, false);
//     showComponent(elements.pubmedDrugInfo, false);
    
//     try {
//       // Construct search term to focus on the condition
//       const searchTerm = `"${condition}"[Title/Abstract] OR "${condition}"[MeSH Terms]`;
      
//       const params = new URLSearchParams({
//         term: searchTerm,
//         page: state.currentPage,
//         sortBy: state.sortBy,
//         fullTextOnly: state.fullTextOnly,
//         yearFilter: state.yearFilter,
//         journalFilter: state.journalFilter
//       });
      
//       const response = await fetch(`/api/pubmed?${params}`);
//       console.log(`PubMed API Request: /api/pubmed?${params}`);
//       if (!response.ok) {
//         throw new Error(`Server responded with status ${response.status}`);
//       }
      
//       const data = await response.json();
//       console.log('PubMed API Response:', data);
//       // Update state with fetched data
//       if (state.currentPage === 1) {
//         state.articles = data.articles;
//       } else {
//         state.articles = [...state.articles, ...data.articles];
//       }
      
//       state.totalResults = data.totalResults;
      
//       // Process articles for medical knowledge if this is a new search
//       if (state.currentPage === 1) {
//         // Reset database for a new search
//         state.medicalDatabase = {
//           conditions: [],
//           drugs: [],
//           conditionDrugMap: {},
//           drugConditionMap: {},
//           drugClasses: {},
//           articleEvidence: {},
//           recentUpdated: null
//         };
//       }
      
//       // Process the medical knowledge
//       state.medicalDatabase = processMedicalKnowledge(state.articles);
      
//       // Hide loading state
//       showComponent(elements.pubmedLoading, false);
      
//       if (state.articles.length === 0) {
//         showComponent(elements.pubmedEmpty, true);
//       } else {
//         // Show articles and treatments
//         showComponent(elements.pubmedArticles, true);
//         renderArticles();
        
//         // Render treatments for this condition
//         renderTreatmentsForCondition(condition);
//       }
      
//     } catch (error) {
//       console.error('Error fetching PubMed data for condition:', error);
//       showComponent(elements.pubmedLoading, false);
//       showComponent(elements.pubmedError, true);
//       if (elements.pubmedErrorMessage) {
//         elements.pubmedErrorMessage.textContent = error.message || 'Failed to fetch articles. Please try again later.';
//       }
//     }
    
//     state.isLoading = false;
//   }

//   // Function to search PubMed by drug and show its uses
//   async function searchPubMedByDrug(drug, options = {}) {
//     state.isLoading = true;
//     state.term = drug;
//     state.currentPage = options.page || 1;
//     state.sortBy = options.sortBy || state.sortBy;
//     state.fullTextOnly = options.fullTextOnly !== undefined ? options.fullTextOnly : state.fullTextOnly;
//     state.yearFilter = options.yearFilter || state.yearFilter;
//     state.journalFilter = options.journalFilter || state.journalFilter;
//     state.searchType = 'drug';
    
//     // Show the pubmed section and loading state
//     showComponent(elements.pubmedSection, true);
//     showComponent(elements.pubmedLoading, true);
//     showComponent(elements.pubmedError, false);
//     showComponent(elements.pubmedEmpty, false);
//     showComponent(elements.pubmedArticles, false);
//     showComponent(elements.pubmedTreatments, false);
//     showComponent(elements.pubmedDrugInfo, false);
    
//     try {
//       // Construct search term to focus on the drug
//       const searchTerm = `"${drug}"[Title/Abstract] OR "${drug}"[MeSH Terms] OR "${drug}"[Pharmacological Action]`;
      
//       const params = new URLSearchParams({
//         term: searchTerm,
//         page: state.currentPage,
//         sortBy: state.sortBy,
//         fullTextOnly: state.fullTextOnly,
//         yearFilter: state.yearFilter,
//         journalFilter: state.journalFilter
//       });
      
//       const response = await fetch(`/api/pubmed?${params}`);
//       console.log(`PubMed API Request: /api/pubmed?${params}`);
//       if (!response.ok) {
//         throw new Error(`Server responded with status ${response.status}`);
//       }
      
//       const data = await response.json();
//       console.log('PubMed API Response:', data);

//       // Update state with fetched data
//       if (state.currentPage === 1) {
//         state.articles = data.articles;
//       } else {
//         state.articles = [...state.articles, ...data.articles];
//       }
      
//       state.totalResults = data.totalResults;
      
//       // Process articles for medical knowledge if this is a new search
//       if (state.currentPage === 1) {
//         // Reset database for a new search
//         state.medicalDatabase = {
//           conditions: [],
//           drugs: [],
//           conditionDrugMap: {},
//           drugConditionMap: {},
//           drugClasses: {},
//           articleEvidence: {},
//           recentUpdated: null
//         };
//       }
      
//       // Process the medical knowledge
//       state.medicalDatabase = processMedicalKnowledge(state.articles);
      
//       // Hide loading state
//       showComponent(elements.pubmedLoading, false);
      
//       if (state.articles.length === 0) {
//         showComponent(elements.pubmedEmpty, true);
//       } else {
//         // Show articles and drug information
//         showComponent(elements.pubmedArticles, true);
//         renderArticles();
        
//         // Render treatments for this condition
//         renderDrugInformation(drug);
//       }
      
//     } catch (error) {
//       console.error('Error fetching PubMed data for drug:', error);
//       showComponent(elements.pubmedLoading, false);
//       showComponent(elements.pubmedError, true);
//       if (elements.pubmedErrorMessage) {
//         elements.pubmedErrorMessage.textContent = error.message || 'Failed to fetch articles. Please try again later.';
//       }
//     }
    
//     state.isLoading = false;
//   }

//   // Initialize event listeners
//   function initEventListeners() {
//     // Search by condition button
//     if (elements.pubmedSearchByCondition) {
//       elements.pubmedSearchByCondition.addEventListener('click', () => {
//         const searchTerm = elements.pubmedSearchBox ? elements.pubmedSearchBox.value.trim() : '';
//         if (searchTerm) {
//           searchPubMedByCondition(searchTerm);
//         }
//       });
//     }
    
//     // Search by drug button
//     if (elements.pubmedSearchByDrug) {
//       elements.pubmedSearchByDrug.addEventListener('click', () => {
//         const searchTerm = elements.pubmedSearchBox ? elements.pubmedSearchBox.value.trim() : '';
//         if (searchTerm) {
//           searchPubMedByDrug(searchTerm);
//         }
//       });
//     }
    
//     // General search on enter key
//     if (elements.pubmedSearchBox) {
//       elements.pubmedSearchBox.addEventListener('keypress', (e) => {
//         if (e.key === 'Enter') {
//           const searchTerm = elements.pubmedSearchBox.value.trim();
//           if (searchTerm) {
//             searchPubMed(searchTerm);
//           }
//         }
//       });
//     }
    
//     // Sort dropdown
//     if (elements.pubmedSort) {
//       elements.pubmedSort.addEventListener('change', () => {
//         const options = {
//           page: 1,
//           sortBy: elements.pubmedSort.value,
//           fullTextOnly: elements.pubmedFullTextOnly ? elements.pubmedFullTextOnly.checked : false,
//           yearFilter: elements.pubmedYearFilter ? elements.pubmedYearFilter.value : '',
//           journalFilter: elements.pubmedJournalFilter ? elements.pubmedJournalFilter.value : ''
//         };
        
//         if (state.searchType === 'condition') {
//           searchPubMedByCondition(state.term, options);
//         } else if (state.searchType === 'drug') {
//           searchPubMedByDrug(state.term, options);
//         } else {
//           searchPubMed(state.term, options);
//         }
//       });
//     }
    
//     // Full text only checkbox
//     if (elements.pubmedFullTextOnly) {
//       elements.pubmedFullTextOnly.addEventListener('change', () => {
//         const options = {
//           page: 1,
//           sortBy: elements.pubmedSort ? elements.pubmedSort.value : 'relevance',
//           fullTextOnly: elements.pubmedFullTextOnly.checked,
//           yearFilter: elements.pubmedYearFilter ? elements.pubmedYearFilter.value : '',
//           journalFilter: elements.pubmedJournalFilter ? elements.pubmedJournalFilter.value : ''
//         };
        
// // Continue from previous code block...

// if (state.searchType === 'condition') {
//           searchPubMedByCondition(state.term, options);
//         } else if (state.searchType === 'drug') {
//           searchPubMedByDrug(state.term, options);
//         } else {
//           searchPubMed(state.term, options);
//         }
//       });
//     }
    
//     // Year filter
//     if (elements.pubmedYearFilter) {
//       elements.pubmedYearFilter.addEventListener('change', () => {
//         const options = {
//           page: 1,
//           sortBy: elements.pubmedSort ? elements.pubmedSort.value : 'relevance',
//           fullTextOnly: elements.pubmedFullTextOnly ? elements.pubmedFullTextOnly.checked : false,
//           yearFilter: elements.pubmedYearFilter.value,
//           journalFilter: elements.pubmedJournalFilter ? elements.pubmedJournalFilter.value : ''
//         };
        
//         if (state.searchType === 'condition') {
//           searchPubMedByCondition(state.term, options);
//         } else if (state.searchType === 'drug') {
//           searchPubMedByDrug(state.term, options);
//         } else {
//           searchPubMed(state.term, options);
//         }
//       });
//     }
    
//     // Journal filter
//     if (elements.pubmedJournalFilter) {
//       elements.pubmedJournalFilter.addEventListener('change', () => {
//         const options = {
//           page: 1,
//           sortBy: elements.pubmedSort ? elements.pubmedSort.value : 'relevance',
//           fullTextOnly: elements.pubmedFullTextOnly ? elements.pubmedFullTextOnly.checked : false,
//           yearFilter: elements.pubmedYearFilter ? elements.pubmedYearFilter.value : '',
//           journalFilter: elements.pubmedJournalFilter.value
//         };
        
//         if (state.searchType === 'condition') {
//           searchPubMedByCondition(state.term, options);
//         } else if (state.searchType === 'drug') {
//           searchPubMedByDrug(state.term, options);
//         } else {
//           searchPubMed(state.term, options);
//         }
//       });
//     }
    
//     // Load more button
//     if (elements.pubmedLoadMore) {
//       elements.pubmedLoadMore.addEventListener('click', () => {
//         if (state.isLoading) return;
        
//         const options = {
//           page: state.currentPage + 1,
//           sortBy: elements.pubmedSort ? elements.pubmedSort.value : 'relevance',
//           fullTextOnly: elements.pubmedFullTextOnly ? elements.pubmedFullTextOnly.checked : false,
//           yearFilter: elements.pubmedYearFilter ? elements.pubmedYearFilter.value : '',
//           journalFilter: elements.pubmedJournalFilter ? elements.pubmedJournalFilter.value : ''
//         };
        
//         if (state.searchType === 'condition') {
//           searchPubMedByCondition(state.term, options);
//         } else if (state.searchType === 'drug') {
//           searchPubMedByDrug(state.term, options);
//         } else {
//           searchPubMed(state.term, options);
//         }
//       });
//     }
    
//     // Advanced toggle
//     if (elements.pubmedAdvancedToggle && elements.pubmedAdvancedOptions) {
//       elements.pubmedAdvancedToggle.addEventListener('click', () => {
//         elements.pubmedAdvancedOptions.classList.toggle('hidden');
        
//         // Update text/icon
//         if (elements.pubmedAdvancedOptions.classList.contains('hidden')) {
//           elements.pubmedAdvancedToggle.innerHTML = `
//             <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//               <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
//             </svg>
//             Advanced Options
//           `;
//         } else {
//           elements.pubmedAdvancedToggle.innerHTML = `
//             <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//               <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
//             </svg>
//             Hide Advanced Options
//           `;
//         }
//       });
//     }
    
//     // Rare condition input
//     if (elements.pubmedRareConditionInput && elements.pubmedAddRareCondition) {
//       elements.pubmedAddRareCondition.addEventListener('click', () => {
//         const conditionInput = elements.pubmedRareConditionInput.value.trim();
//         if (conditionInput) {
//           searchPubMedByCondition(conditionInput);
//           elements.pubmedRareConditionInput.value = '';
//         }
//       });
      
//       elements.pubmedRareConditionInput.addEventListener('keypress', (e) => {
//         if (e.key === 'Enter') {
//           const conditionInput = elements.pubmedRareConditionInput.value.trim();
//           if (conditionInput) {
//             searchPubMedByCondition(conditionInput);
//             elements.pubmedRareConditionInput.value = '';
//           }
//         }
//       });
//     }
//   }

//   // Function to populate filter options based on data
//   function populateFilters() {
//     // Populate year filter
//     if (elements.pubmedYearFilter) {
//       const currentYear = new Date().getFullYear();
//       let yearOptions = '<option value="">All Years</option>';
      
//       for (let year = currentYear; year >= currentYear - 20; year--) {
//         yearOptions += `<option value="${year}">${year}</option>`;
//       }
      
//       elements.pubmedYearFilter.innerHTML = yearOptions;
//     }
    
//     // For journal filter, we can only populate once we have data
//     // This is handled in the renderArticles function
//   }

//   // Update journal filter based on fetched articles
//   function updateJournalFilter() {
//     if (!elements.pubmedJournalFilter) return;
    
//     // Extract unique journals from articles
//     const journals = new Set();
//     state.articles.forEach(article => {
//       if (article.journal && article.journal.trim() !== '') {
//         journals.add(article.journal);
//       }
//     });
    
//     // Convert to array and sort alphabetically
//     const sortedJournals = [...journals].sort();
    
//     // Create options HTML
//     let journalOptions = '<option value="">All Journals</option>';
//     sortedJournals.forEach(journal => {
//       journalOptions += `<option value="${journal}">${journal}</option>`;
//     });
    
//     // Set the options
//     elements.pubmedJournalFilter.innerHTML = journalOptions;
    
//     // If there was a previous selection, try to restore it
//     if (state.journalFilter) {
//       elements.pubmedJournalFilter.value = state.journalFilter;
//     }
//   }

//   // Initialize the module
// // Helper function to safely get DOM elements (add at the top of your module)
// function safeGetElement(id) {
//   const element = document.getElementById(id);
//   if (!element) {
//     console.warn(`PubMed Module: Element with ID "${id}" not found`);
//   }
//   return element;
// }

// // Modified showComponent function
// function showComponent(component, isVisible) {
//   if (!component) return; // Skip if element doesn't exist
  
//   if (isVisible) {
//     component.classList.remove('hidden');
//   } else {
//     component.classList.add('hidden');
//   }
// }

// // Create essential elements if they don't exist
// function ensureRequiredElements() {
//   // Create main container if needed
//   if (!document.getElementById('pubmedSection')) {
//     console.log("PubMed Module: Creating missing pubmedSection element");
//     const section = document.createElement('div');
//     section.id = 'pubmedSection';
//     section.className = 'hidden';
    
//     // Try to find a suitable parent element
//     const parent = document.querySelector('.main-content') || 
//                   document.querySelector('main') || 
//                   document.querySelector('body');
//     if (parent) {
//       parent.appendChild(section);
//       // Update the elements reference
//       elements.pubmedSection = section;
//     } else {
//       console.error("PubMed Module: Could not find parent element to append pubmedSection");
//     }
//   }
  
//   // Create other essential elements
//   const requiredElements = [
//     { id: 'pubmedLoading', parent: 'pubmedSection', className: 'flex justify-center items-center py-12 hidden' },
//     { id: 'pubmedError', parent: 'pubmedSection', className: 'bg-red-50 p-6 rounded-lg text-center hidden' },
//     { id: 'pubmedEmpty', parent: 'pubmedSection', className: 'bg-gray-50 p-8 rounded-lg text-center hidden' },
//     { id: 'pubmedArticles', parent: 'pubmedSection', className: 'hidden' },
//     { id: 'pubmedArticlesList', parent: 'pubmedArticles', className: 'space-y-4' },
//     { id: 'pubmedTreatments', parent: 'pubmedSection', className: 'mb-8 hidden' },
//     { id: 'pubmedTreatmentsContent', parent: 'pubmedTreatments', className: 'hidden' },
//     { id: 'pubmedDrugInfo', parent: 'pubmedSection', className: 'mb-8 hidden' },
//     { id: 'pubmedDrugInfoContent', parent: 'pubmedDrugInfo', className: 'hidden' }
//   ];
  
//   requiredElements.forEach(elem => {
//     if (!document.getElementById(elem.id) && document.getElementById(elem.parent)) {
//       console.log(`PubMed Module: Creating missing ${elem.id} element`);
//       const newElement = document.createElement('div');
//       newElement.id = elem.id;
//       newElement.className = elem.className;
//       document.getElementById(elem.parent).appendChild(newElement);
      
//       // Update the elements reference
//       elements[elem.id] = newElement;
//     }
//   });
// }

// // Update your init function
// function init() {
//   console.log("PubMed Module: Initializing...");
  
//   // First ensure all required elements exist
//   ensureRequiredElements();
  
//   // Re-check if we have the main container
//   if (!elements.pubmedSection) {
//     console.error('PubMed Module: Required elements could not be created');
//     return;
//   }
  
//   // Initialize event listeners
//   try {
//     initEventListeners();
//   } catch (error) {
//     console.error('PubMed Module: Error initializing event listeners', error);
//   }
  
//   // Populate filter options
//   try {
//     populateFilters();
//   } catch (error) {
//     console.error('PubMed Module: Error populating filters', error);
//   }
  
//   console.log("PubMed Module: Initialization complete");
// }
  
//   // Return public methods
//   return {
//     init,
//     searchPubMed,
//     searchPubMedByCondition,
//     searchPubMedByDrug
//   };
// })();

// // Advanced PubMed Module with Specialized Condition & Drug Search
// const PubMedModule = (function() {
//   const elements = {
//     // Main containers
//     pubmedSection: safeGetElement('pubmedSection'),
//     pubmedLoading: safeGetElement('pubmedLoading'),
//     pubmedError: safeGetElement('pubmedError'),
//     pubmedErrorMessage: safeGetElement('pubmedErrorMessage'),
//     pubmedEmpty: safeGetElement('pubmedEmpty'),
    
//     // Search related elements
//     pubmedSearchBox: safeGetElement('pubmedSearchBox'),
//     pubmedSearchByCondition: safeGetElement('pubmedSearchByCondition'),
//     pubmedSearchByDrug: safeGetElement('pubmedSearchByDrug'),
//     pubmedAdvancedToggle: safeGetElement('pubmedAdvancedToggle'),
//     pubmedAdvancedOptions: safeGetElement('pubmedAdvancedOptions'),
    
//     // Filter and sorting elements
//     pubmedSort: safeGetElement('pubmedSort'),
//     pubmedFullTextOnly: safeGetElement('pubmedFullTextOnly'),
//     pubmedYearFilter: safeGetElement('pubmedYearFilter'),
//     pubmedJournalFilter: safeGetElement('pubmedJournalFilter'),
    
//     // Results elements
//     pubmedArticles: safeGetElement('pubmedArticles'),
//     pubmedArticlesList: safeGetElement('pubmedArticlesList'),
//     pubmedResultCount: safeGetElement('pubmedResultCount'),
//     pubmedLoadMore: safeGetElement('pubmedLoadMore'),
//     pubmedPagination: safeGetElement('pubmedPagination'),
    
//     // Treatment results (replaces summary)
//     pubmedTreatments: safeGetElement('pubmedTreatments'),
//     pubmedTreatmentsLoading: safeGetElement('pubmedTreatmentsLoading'),
//     pubmedTreatmentsContent: safeGetElement('pubmedTreatmentsContent'),
    
//     // Drug information results
//     pubmedDrugInfo: safeGetElement('pubmedDrugInfo'),
//     pubmedDrugInfoLoading: safeGetElement('pubmedDrugInfoLoading'),
//     pubmedDrugInfoContent: safeGetElement('pubmedDrugInfoContent'),
    
//     // Rare condition input
//     pubmedRareConditionInput: safeGetElement('pubmedRareConditionInput'),
//     pubmedAddRareCondition: safeGetElement('pubmedAddRareCondition')
//   };

//   // State management for the module
//   let state = {
//     term: '',
//     searchType: 'general', // 'general', 'condition', or 'drug'
//     articles: [],
//     displayedArticles: [], // Articles currently shown in the UI
//     currentPage: 1,
//     pageSize: 5, // Number of articles to show per page
//     totalResults: 0,
//     isLoading: false,
//     sortBy: 'relevance',
//     fullTextOnly: false,
//     yearFilter: '',
//     journalFilter: '',
//     medicalDatabase: {
//       conditions: [],
//       drugs: [],
//       conditionDrugMap: {},
//       drugConditionMap: {},
//       drugClasses: {},
//       articleEvidence: {},
//       recentUpdated: null
//     }
//   };

//   // Common drug classes for classification
//   const drugClasses = {
//     "Antibiotics": ["penicillin", "amoxicillin", "azithromycin", "ciprofloxacin", "doxycycline", "vancomycin"],
//     "Antidepressants": ["fluoxetine", "sertraline", "escitalopram", "bupropion", "venlafaxine", "trazodone"],
//     "Antihypertensives": ["lisinopril", "losartan", "amlodipine", "hydrochlorothiazide", "metoprolol", "valsartan"],
//     "Anti-inflammatories": ["ibuprofen", "naproxen", "celecoxib", "prednisone", "dexamethasone", "methylprednisolone"],
//     "Antidiabetics": ["metformin", "insulin", "glipizide", "sitagliptin", "empagliflozin", "liraglutide"],
//     "Anticoagulants": ["warfarin", "apixaban", "rivaroxaban", "dabigatran", "heparin", "enoxaparin"],
//     "Antipsychotics": ["risperidone", "olanzapine", "quetiapine", "aripiprazole", "haloperidol", "clozapine"],
//     "Anticonvulsants": ["levetiracetam", "lamotrigine", "valproic acid", "carbamazepine", "phenytoin", "gabapentin"],
//     "Biologics": ["adalimumab", "etanercept", "infliximab", "ustekinumab", "secukinumab", "rituximab"],
//     "Statins": ["atorvastatin", "simvastatin", "rosuvastatin", "pravastatin", "lovastatin", "fluvastatin"],
//     "Bronchodilators": ["albuterol", "salmeterol", "formoterol", "tiotropium", "ipratropium", "theophylline"],
//     "Antihistamines": ["loratadine", "cetirizine", "fexofenadine", "diphenhydramine", "hydroxyzine", "desloratadine"],
//     "Proton Pump Inhibitors": ["omeprazole", "esomeprazole", "pantoprazole", "lansoprazole", "rabeprazole", "dexlansoprazole"],
//     "Opioid Analgesics": ["morphine", "oxycodone", "hydrocodone", "tramadol", "fentanyl", "codeine"],
//     "Immunosuppressants": ["cyclosporine", "tacrolimus", "mycophenolate", "azathioprine", "sirolimus", "methotrexate"],
//     "Chemotherapy": ["cisplatin", "carboplatin", "doxorubicin", "paclitaxel", "fluorouracil", "gemcitabine"]
//   };

//   // Known medical conditions to improve detection accuracy
//   const knownMedicalConditions = [
//     "Diabetes", "Hypertension", "Asthma", "COPD", "Alzheimer's", "Parkinson's", 
//     "Multiple Sclerosis", "HIV/AIDS", "Rheumatoid Arthritis", "Osteoarthritis",
//     "Depression", "Anxiety", "Bipolar Disorder", "Schizophrenia", "Cancer", 
//     "Leukemia", "Lymphoma", "Heart Disease", "Stroke", "Epilepsy", "Migraine",
//     "Psoriasis", "Eczema", "Crohn's Disease", "Ulcerative Colitis", "Celiac Disease",
//     "Hypothyroidism", "Hyperthyroidism", "Lupus", "Fibromyalgia", "Chronic Fatigue Syndrome",
//     "Irritable Bowel Syndrome", "Osteoporosis", "Gout", "Hepatitis", "Cirrhosis",
//     "Kidney Disease", "Anemia", "Glaucoma", "Macular Degeneration", "Influenza",
//     "Pneumonia", "Tuberculosis", "Malaria", "COVID-19", "Coronavirus"
//   ];

//   // Utility function to show/hide components
//   function showComponent(component, isVisible) {
//     if (!component) return;
    
//     if (isVisible) {
//       component.classList.remove('hidden');
//     } else {
//       component.classList.add('hidden');
//     }
//   }
  
//   // Utility function to format date
//   function formatDate(dateString) {
//     if (!dateString) return 'N/A';
//     const date = new Date(dateString);
//     return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
//   }

//   // Improved function to detect conditions from text using medical terminology
//   function extractConditions(article) {
//     const text = (article.title + ' ' + article.abstract).toLowerCase();
//     const extractedConditions = [];
    
//     // Check for known medical conditions first
//     knownMedicalConditions.forEach(condition => {
//       const conditionLower = condition.toLowerCase();
//       if (text.includes(conditionLower)) {
//         // Format: capitalize first letter of each word
//         if (!extractedConditions.includes(condition)) {
//           extractedConditions.push(condition);
//         }
//       }
//     });
    
//     // MeSH terms (if present) are very reliable for conditions
//     if (article.meshTerms && Array.isArray(article.meshTerms)) {
//       article.meshTerms.forEach(term => {
//         if (
//           term.includes('Disease') || 
//           term.includes('Syndrome') || 
//           term.includes('Disorder') || 
//           term.includes('Condition') ||
//           term.includes('Infection')
//         ) {
//           if (!extractedConditions.includes(term)) {
//             extractedConditions.push(term);
//           }
//         }
//       });
//     }
    
//     // Common condition patterns
//     const conditionPatterns = [
//       // "Patients with X", "diagnosed with X", etc.
//       /(?:patients? with|diagnosed with|cases? of|subjects? with|suffering from|presented with)\s+([a-z0-9\-\s]+?)(?:,|\.|;|\s+and|\s+or|\s+were|\s+was|\s+had|\s+have)/gi,
      
//       // "Treatment of X", "Management of X", etc.
//       /(?:treatment of|management of|therapy for|intervention for)\s+([a-z0-9\-\s]+?)(?:,|\.|;|\s+was|\s+is|\s+has|\s+have)/gi,
      
//       // Common disease/disorder patterns
//       /([a-z0-9\-\s]{3,40})\s+(?:syndrome|disease|disorder|cancer|infection|deficiency)/gi,
      
//       // Match conditions with suffixes
//       /([a-z0-9\-\s]{3,30})(?:itis|emia|pathy|plasia|oma|trophy|toxicity|lysis)/gi
//     ];
    
//     // Extract using patterns
//     conditionPatterns.forEach(pattern => {
//       let match;
//       while ((match = pattern.exec(text)) !== null) {
//         const condition = match[1].trim();
        
//         // Filter out non-conditions and short terms
//         if (
//           condition.length > 3 && 
//           condition.split(' ').length <= 4 && // Limit to 4 words max to avoid long phrases
//           !/^(the|this|that|these|those|some|any|our|their|other|many|various|different|several|each|every|all|both|either|neither|few|one|two|three|four|five|ten)$/i.test(condition) &&
//           !extractedConditions.includes(condition)
//         ) {
//           // Format: capitalize first letter of each word
//           const formattedCondition = condition.replace(/\b\w/g, c => c.toUpperCase());
          
//           // Only add if it has at least one medical term or is in a specific format
//           if (
//             formattedCondition.includes("Disease") || 
//             formattedCondition.includes("Syndrome") || 
//             formattedCondition.includes("Disorder") || 
//             formattedCondition.includes("Cancer") ||
//             formattedCondition.includes("itis") ||
//             formattedCondition.includes("emia") ||
//             formattedCondition.includes("oma") ||
//             /^[A-Z]/.test(formattedCondition) // Starts with capital letter
//           ) {
//             extractedConditions.push(formattedCondition);
//           }
//         }
//       }
//     });
    
//     // Keywords are often a good source of conditions
//     if (article.keywords && Array.isArray(article.keywords)) {
//       article.keywords.forEach(keyword => {
//         const keywordLower = keyword.toLowerCase();
        
//         // Keywords with these terms are likely conditions
//         if (
//           keywordLower.includes('disease') || 
//           keywordLower.includes('syndrome') || 
//           keywordLower.includes('disorder') || 
//           keywordLower.includes('deficiency') ||
//           keywordLower.includes('cancer') ||
//           keywordLower.includes('infection') ||
//           (keywordLower.length > 5 && !extractedConditions.includes(keyword))
//         ) {
//           const formattedKeyword = keyword.replace(/\b\w/g, c => c.toUpperCase());
//           extractedConditions.push(formattedKeyword);
//         }
//       });
//     }
    
//     return [...new Set(extractedConditions)]; // Remove duplicates
//   }

//   // Improved function to extract drugs/treatments from text
//   function extractDrugs(article) {
//     const text = (article.title + ' ' + article.abstract).toLowerCase();
//     const extractedDrugs = [];
    
//     // Check for specific drug mentions in drug classes
//     Object.entries(drugClasses).forEach(([className, drugs]) => {
//       // Check for the class name itself
//       if (text.includes(className.toLowerCase())) {
//         extractedDrugs.push(className);
//       }
      
//       // Check for specific drugs in this class
//       drugs.forEach(drug => {
//         if (new RegExp(`\\b${drug}\\b`, 'i').test(text)) {
//           // Format: capitalize first letter
//           const formattedDrug = drug.charAt(0).toUpperCase() + drug.slice(1);
//           if (!extractedDrugs.includes(formattedDrug)) {
//             extractedDrugs.push(formattedDrug);
//           }
//         }
//       });
//     });
    
//     // Common drug/treatment patterns
//     const drugPatterns = [
//       // "Treated with X", "administered X", etc.
//       /(?:treated with|treatment with|administered|given|received|therapy with|medication with)\s+([a-z0-9\-\s]+?)(?:,|\.|;|\s+and|\s+or|\s+were|\s+was|\s+had|\s+have)/gi,
      
//       // Dosage patterns
//       /(?:dose of|doses of|dosage of|mg of|mcg of|g of)\s+([a-z0-9\-\s]+?)(?:,|\.|;|\s+was|\s+were|\s+is|\s+are)/gi,
      
//       // "X therapy", "X treatment", etc.
//       /([a-z0-9\-\s]{3,30})\s+(?:therapy|treatment|administration|infusion|injection|medication)/gi
//     ];
    
//     // Extract using patterns
//     drugPatterns.forEach(pattern => {
//       let match;
//       while ((match = pattern.exec(text)) !== null) {
//         const drug = match[1].trim();
        
//         // Filter out non-drugs and common words
//         if (
//           drug.length > 3 && 
//           drug.split(' ').length <= 3 && // Limit to 3 words max to avoid phrases
//           !/^(the|this|that|these|those|some|any|our|their|other|many|various|different|several|each|every|all|both|either|neither|few|one|two|three|four|five|ten|standard|conventional|usual|current|intensive|maintenance)$/i.test(drug) &&
//           !extractedDrugs.includes(drug)
//         ) {
//           // Format: capitalize first letter of each word
//           const formattedDrug = drug.replace(/\b\w/g, c => c.toUpperCase());
          
//           // Exclude if it contains these terms (likely not a drug)
//           if (
//             !formattedDrug.includes("Patient") &&
//             !formattedDrug.includes("Disease") &&
//             !formattedDrug.includes("Condition") &&
//             !formattedDrug.includes("Group") &&
//             !formattedDrug.includes("Study")
//           ) {
//             extractedDrugs.push(formattedDrug);
//           }
//         }
//       }
//     });
    
//     // Keywords can also indicate drugs/treatments
//     if (article.keywords && Array.isArray(article.keywords)) {
//       article.keywords.forEach(keyword => {
//         const keywordLower = keyword.toLowerCase();
        
//         // Keywords with these terms are likely treatments
//         if (
//           keywordLower.includes('therapy') || 
//           keywordLower.includes('treatment') || 
//           keywordLower.includes('medication') || 
//           keywordLower.includes('drug') ||
//           keywordLower.includes('inhibitor') ||
//           keywordLower.includes('antagonist')
//         ) {
//           const formattedKeyword = keyword.replace(/\b\w/g, c => c.toUpperCase());
//           if (!extractedDrugs.includes(formattedKeyword)) {
//             extractedDrugs.push(formattedKeyword);
//           }
//         }
//       });
//     }
    
//     // Common single word drugs are often in article titles and abstracts
//     let singleWordMatchRegex = /\b([A-Za-z]{5,}(?:in|ol|ide|ine|one|ate|ium|zole|mycin|cillin|oxacin|sartan|pril|statin|mab))\b/gi;
//     let match;
//     while ((match = singleWordMatchRegex.exec(text)) !== null) {
//       const possibleDrug = match[1].trim();
//       const formattedDrug = possibleDrug.charAt(0).toUpperCase() + possibleDrug.slice(1).toLowerCase();
//       if (!extractedDrugs.includes(formattedDrug)) {
//         extractedDrugs.push(formattedDrug);
//       }
//     }
    
//     return [...new Set(extractedDrugs)]; // Remove duplicates
//   }

//   // Improved function to map conditions to drugs based on proximity and context
//   function mapConditionsToDrugs(article, conditions, drugs) {
//     const text = (article.title + ' ' + article.abstract).toLowerCase();
//     const conditionDrugMap = {};
//     const drugConditionMap = {};
    
//     // Initialize maps
//     conditions.forEach(condition => conditionDrugMap[condition] = []);
//     drugs.forEach(drug => drugConditionMap[drug] = []);
    
//     // Look for explicit mentions of treatments for conditions
//     conditions.forEach(condition => {
//       const conditionLower = condition.toLowerCase();
      
//       // Check for phrases like "X for treatment of Y" or "X in patients with Y"
//       drugs.forEach(drug => {
//         const drugLower = drug.toLowerCase();
        
//         // Check various patterns of drug-condition relationships
//         const patterns = [
//           new RegExp(`${drugLower}\\s+(?:for|in|to treat|in (?:the )?treatment of|used for)\\s+(?:patients with )?${conditionLower}`, 'i'),
//           new RegExp(`${conditionLower}\\s+(?:treated with|receiving|using|responded to)\\s+${drugLower}`, 'i'),
//           new RegExp(`(?:efficacy|effectiveness|use|administration) of\\s+${drugLower}\\s+(?:in|for)\\s+${conditionLower}`, 'i')
//         ];
        
//         // Check if any patterns match
//         const hasDirectRelation = patterns.some(pattern => pattern.test(text));
        
//         if (hasDirectRelation) {
//           // Strong evidence of relationship - add to maps
//           if (!conditionDrugMap[condition].includes(drug)) {
//             conditionDrugMap[condition].push(drug);
//           }
//           if (!drugConditionMap[drug].includes(condition)) {
//             drugConditionMap[drug].push(condition);
//           }
//         } else {
//           // Check for proximity as a fallback
//           const conditionIndex = text.indexOf(conditionLower);
//           const drugIndex = text.indexOf(drugLower);
          
//           if (conditionIndex !== -1 && drugIndex !== -1) {
//             // If drug and condition are "close" to each other (within 100 chars)
//             if (Math.abs(drugIndex - conditionIndex) < 100) {
//               // Add to maps if not already present
//               if (!conditionDrugMap[condition].includes(drug)) {
//                 conditionDrugMap[condition].push(drug);
//               }
//               if (!drugConditionMap[drug].includes(condition)) {
//                 drugConditionMap[drug].push(condition);
//               }
//             }
//           }
//         }
//       });
//     });
    
//     // For each condition-drug pair, collect evidence
//     Object.entries(conditionDrugMap).forEach(([condition, mappedDrugs]) => {
//       mappedDrugs.forEach(drug => {
//         const evidenceKey = `${condition}|||${drug}`;
//         if (!state.medicalDatabase.articleEvidence[evidenceKey]) {
//           state.medicalDatabase.articleEvidence[evidenceKey] = [];
//         }
        
//         // Add this article as evidence if not already present
//         const alreadyAdded = state.medicalDatabase.articleEvidence[evidenceKey].some(
//           evidence => evidence.pmid === article.pmid
//         );
        
//         if (!alreadyAdded) {
//           state.medicalDatabase.articleEvidence[evidenceKey].push({
//             pmid: article.pmid,
//             title: article.title,
//             date: article.pubDate,
//             journal: article.journal,
//             excerpt: findRelevantExcerpt(text, condition, drug)
//           });
//         }
//       });
//     });
    
//     return { conditionDrugMap, drugConditionMap };
//   }
  
//   // Find relevant text excerpt that mentions both condition and drug
//   function findRelevantExcerpt(text, condition, drug) {
//     const conditionLower = condition.toLowerCase();
//     const drugLower = drug.toLowerCase();
    
//     // Find positions
//     const conditionIndex = text.indexOf(conditionLower);
//     const drugIndex = text.indexOf(drugLower);
    
//     if (conditionIndex === -1 || drugIndex === -1) return ""; // Not found
    
//     // Find the sentence that contains both terms if possible
//     const sentences = text.match(/[^.!?]+[.!?]+/g) || [];
    
//     for (const sentence of sentences) {
//       if (sentence.toLowerCase().includes(conditionLower) && 
//           sentence.toLowerCase().includes(drugLower)) {
//         return sentence.trim();
//       }
//     }
    
//     // If no sentence contains both, extract a snippet around the mentions
//     const start = Math.min(conditionIndex, drugIndex);
//     const end = Math.max(conditionIndex + conditionLower.length, drugIndex + drugLower.length);
    
//     // Include more context
//     const excerptStart = Math.max(0, start - 50);
//     const excerptEnd = Math.min(text.length, end + 50);
    
//     return text.substring(excerptStart, excerptEnd).trim() + "...";
//   }

//   // Process articles to extract medical knowledge
//   function processMedicalKnowledge(articles) {
//     let updatedDatabase = {
//       conditions: [...state.medicalDatabase.conditions],
//       drugs: [...state.medicalDatabase.drugs],
//       conditionDrugMap: {...state.medicalDatabase.conditionDrugMap},
//       drugConditionMap: {...state.medicalDatabase.drugConditionMap},
//       drugClasses: {...state.medicalDatabase.drugClasses},
//       articleEvidence: {...state.medicalDatabase.articleEvidence},
//       recentUpdated: new Date().toISOString()
//     };
    
//     articles.forEach(article => {
//       // Extract conditions and drugs
//       const conditions = extractConditions(article);
//       const drugs = extractDrugs(article);
      
//       // Skip if no conditions or drugs found
//       if (conditions.length === 0 || drugs.length === 0) return;
      
//       // Map conditions to drugs and vice versa
//       const { conditionDrugMap, drugConditionMap } = mapConditionsToDrugs(article, conditions, drugs);
      
//       // Update database with new conditions
//       conditions.forEach(condition => {
//         if (!updatedDatabase.conditions.includes(condition)) {
//           updatedDatabase.conditions.push(condition);
//         }
        
//         // Initialize or merge condition-drug mapping
//         if (!updatedDatabase.conditionDrugMap[condition]) {
//           updatedDatabase.conditionDrugMap[condition] = [];
//         }
        
//         // Add drugs for this condition
//         if (conditionDrugMap[condition]) {
//           conditionDrugMap[condition].forEach(drug => {
//             if (!updatedDatabase.conditionDrugMap[condition].includes(drug)) {
//               updatedDatabase.conditionDrugMap[condition].push(drug);
//             }
//           });
//         }
//       });
      
//       // Update database with new drugs
//       drugs.forEach(drug => {
//         if (!updatedDatabase.drugs.includes(drug)) {
//           updatedDatabase.drugs.push(drug);
//         }
        
//         // Initialize or merge drug-condition mapping
//         if (!updatedDatabase.drugConditionMap[drug]) {
//           updatedDatabase.drugConditionMap[drug] = [];
//         }
        
//         // Add conditions for this drug
//         if (drugConditionMap[drug]) {
//           drugConditionMap[drug].forEach(condition => {
//             if (!updatedDatabase.drugConditionMap[drug].includes(condition)) {
//               updatedDatabase.drugConditionMap[drug].push(condition);
//             }
//           });
//         }
        
//         // Categorize drug into drug classes
//         Object.entries(drugClasses).forEach(([className, classDrugs]) => {
//           if (classDrugs.some(classDrug => drug.toLowerCase().includes(classDrug))) {
//             if (!updatedDatabase.drugClasses[drug]) {
//               updatedDatabase.drugClasses[drug] = [];
//             }
//             if (!updatedDatabase.drugClasses[drug].includes(className)) {
//               updatedDatabase.drugClasses[drug].push(className);
//             }
//           }
//         });
//       });
//     });
    
//     return updatedDatabase;
//   }

//   // Create article element for display
//   function createArticleElement(article) {
//     const articleElement = document.createElement('div');
//     articleElement.className = 'bg-white rounded-lg p-4 shadow-sm hover:shadow-md transition-shadow duration-200 mb-4 border border-gray-100';
    
//     const hasDOI = article.doi && article.doi.trim() !== '';
//     const hasFullText = article.fullTextUrl && article.fullTextUrl.trim() !== '';
    
//     // Extract medical information
//     const conditions = extractConditions(article);
//     const drugs = extractDrugs(article);
    
//     // Only show relevant medical findings based on search type
//     let medicalFindings = '';
//     if (conditions.length > 0 || drugs.length > 0) {
//       medicalFindings = `
//         <div class="border-t border-gray-100 mt-3 pt-3">
//           ${conditions.length > 0 ? 
//             `<div class="mb-2">
//               <span class="text-xs font-medium text-gray-700">Conditions: </span>
//               <div class="flex flex-wrap gap-1 mt-1">
//                 ${conditions.map(condition => 
//                   `<span class="bg-blue-50 text-blue-700 text-xs px-2 py-1 rounded-full">${condition}</span>`
//                 ).join('')}
//               </div>
//             </div>` : ''
//           }
//           ${drugs.length > 0 ? 
//             `<div>
//               <span class="text-xs font-medium text-gray-700">Treatments: </span>
//               <div class="flex flex-wrap gap-1 mt-1">
//                 ${drugs.map(drug => 
//                   `<span class="bg-green-50 text-green-700 text-xs px-2 py-1 rounded-full">${drug}</span>`
//                 ).join('')}
//               </div>
//             </div>` : ''
//           }
//         </div>
//       `;
//     }
    
//     articleElement.innerHTML = `
//       <div class="flex justify-between">
//         <h3 class="text-lg font-semibold text-gray-800 mb-2">${article.title}</h3>
//       </div>
//       <div class="text-sm text-gray-600 mb-2">
//         ${article.authors.slice(0, 3).join(', ')}${article.authors.length > 3 ? ', et al.' : ''}
//       </div>
//       <div class="text-sm text-gray-500 mb-3 flex flex-wrap items-center gap-2">
//         <span class="font-medium">${article.journal || 'Journal not specified'}</span>
//         <span class="inline-block w-1 h-1 rounded-full bg-gray-300"></span>
//         <span>${formatDate(article.pubDate)}</span>
//         <span class="inline-block w-1 h-1 rounded-full bg-gray-300"></span>
//         <span>PMID: ${article.pmid}</span>
//       </div>
//       <p class="text-gray-700 text-sm mb-3">${article.abstract.substring(0, 200)}${article.abstract.length > 200 ? '...' : ''}</p>
//       ${article.keywords && article.keywords.length > 0 ? 
//         `<div class="flex flex-wrap gap-1 mb-3">
//           ${article.keywords.map(keyword => 
//             `<span class="bg-gray-100 text-gray-700 text-xs px-2 py-1 rounded-full">${keyword}</span>`
//           ).join('')}
//         </div>` : ''
//       }
//       ${medicalFindings}
//       <div class="flex flex-wrap gap-2 mt-3">
//         <a href="https://pubmed.ncbi.nlm.nih.gov/${article.pmid}" target="_blank" 
//            class="text-primary hover:text-primary-dark text-sm flex items-center">
//           <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
//           </svg>
//           View on PubMed
//         </a>
//         ${hasDOI ? 
//           `<a href="https://doi.org/${article.doi}" target="_blank" 
//               class="text-primary hover:text-primary-dark text-sm flex items-center">
//             <svg xmlns="http://www.svg.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//               <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101" />
//               <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 015.656 0l4 4a4 4 0 01-5.656 5.656l-1.102-1.101" />
//             </svg>
//             DOI
//           </a>` : ''
//         }
//         ${hasFullText ? 
//           `<a href="${article.fullTextUrl}" target="_blank" 
//               class="text-primary hover:text-primary-dark text-sm flex items-center">
//             <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//               <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
//             </svg>
//             Full Text
//           </a>` : ''
//         }
//       </div>
//     `;
    
//     return articleElement;
//   }

//   // Render articles in the list with pagination
//   function renderArticles() {
//     if (!elements.pubmedArticlesList) return;
    
//     elements.pubmedArticlesList.innerHTML = '';
    
//     // Calculate pagination
//     const startIndex = 0;
//     const endIndex = state.displayedArticles.length;
    
//     // Render only the articles for the current page
//     state.displayedArticles.slice(startIndex, endIndex).forEach(article => {
//       const articleElement = createArticleElement(article);
//       elements.pubmedArticlesList.appendChild(articleElement);
//     });
    
//     if (elements.pubmedResultCount) {
//       elements.pubmedResultCount.textContent = `${state.totalResults} articles found (showing ${state.displayedArticles.length})`;
//     }
    
//     // Show/hide load more button based on whether there are more results
//     const hasMoreResults = state.articles.length > state.displayedArticles.length || 
//                            state.displayedArticles.length < state.totalResults;
    
//     showComponent(elements.pubmedPagination, hasMoreResults);
    
//     if (elements.pubmedLoadMore) {
//       elements.pubmedLoadMore.textContent = `Load More (${state.totalResults - state.displayedArticles.length} remaining)`;
//     }
//   }

//   // Render treatments for a condition
//   function renderTreatmentsForCondition(condition) {
//     if (!elements.pubmedTreatments) return;
    
//     // Only show treatments for condition searches
//     if (state.searchType !== 'condition') {
//       showComponent(elements.pubmedTreatments, false);
//       return;
//     }
    
//     showComponent(elements.pubmedTreatments, true);
//     showComponent(elements.pubmedTreatmentsLoading, true);
//     showComponent(elements.pubmedTreatmentsContent, false);
    
//     setTimeout(() => {
//       try {
//         // Get treatments for this condition
//         const treatments = state.medicalDatabase.conditionDrugMap[condition] || [];
        
//         // Don't show the treatment section if no treatments were found
//         if (treatments.length === 0) {
//           showComponent(elements.pubmedTreatments, false);
//           showComponent(elements.pubmedTreatmentsLoading, false);
//           return;
//         }
        
//         // Group treatments by drug class if possible
//         const treatmentsByClass = {};
//         const unclassifiedTreatments = [];
        
//         treatments.forEach(treatment => {
//           const classes = state.medicalDatabase.drugClasses[treatment] || [];
          
//           if (classes.length > 0) {
//             classes.forEach(className => {
//               if (!treatmentsByClass[className]) {
//                 treatmentsByClass[className] = [];
//               }
//               if (!treatmentsByClass[className].includes(treatment)) {
//                 treatmentsByClass[className].push(treatment);
//               }
//             });
//           } else {
//             unclassifiedTreatments.push(treatment);
//           }
//         });
        
//         let html = `
//           <div class="bg-blue-50 p-4 rounded-lg border border-blue-100 mb-6">
//             <h3 class="text-blue-800 font-medium flex items-center">
//               <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
//               </svg>
//               Treatments for ${condition}
//             </h3>
//             <p class="text-blue-700 text-sm mt-1">
//               Found ${treatments.length} potential treatments across ${Object.keys(state.medicalDatabase.articleEvidence).filter(key => key.startsWith(condition)).length} articles.
//             </p>
//           </div>
          
//           <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
//         `;
        
//         // Add classified treatments
//         Object.entries(treatmentsByClass).forEach(([className, drugs]) => {
//           html += `
//             <div class="bg-white rounded-lg p-4 shadow-sm border border-gray-100">
//               <h4 class="font-medium text-gray-800 mb-2">${className}</h4>
//               <div class="flex flex-wrap gap-2">
//                 ${drugs.map(drug => {
//                   // Get evidence count
//                   const evidenceKey = `${condition}|||${drug}`;
//                   const evidenceCount = state.medicalDatabase.articleEvidence[evidenceKey]?.length || 0;
                  
//                   return `
//                     <button class="treatment-pill bg-green-50 hover:bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm flex items-center transition-colors duration-200"
//                             data-condition="${condition}" 
//                             data-treatment="${drug}" 
//                             data-evidence="${evidenceCount}">
//                       ${drug}
//                       <span class="ml-1 bg-green-700 text-white text-xs rounded-full w-5 h-5 inline-flex items-center justify-center">${evidenceCount}</span>
//                     </button>
//                   `;
//                 }).join('')}
//               </div>
//             </div>
//           `;
//         });
        
//         // Add unclassified treatments if any
//         if (unclassifiedTreatments.length > 0) {
//           html += `
//             <div class="bg-white rounded-lg p-4 shadow-sm border border-gray-100">
//               <h4 class="font-medium text-gray-800 mb-2">Other Treatments</h4>
//               <div class="flex flex-wrap gap-2">
//                 ${unclassifiedTreatments.map(drug => {
//                   // Get evidence count
//                   const evidenceKey = `${condition}|||${drug}`;
//                   const evidenceCount = state.medicalDatabase.articleEvidence[evidenceKey]?.length || 0;
                  
//                   return `
//                     <button class="treatment-pill bg-green-50 hover:bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm flex items-center transition-colors duration-200"
//                             data-condition="${condition}" 
//                             data-treatment="${drug}" 
//                             data-evidence="${evidenceCount}">
//                       ${drug}
//                       <span class="ml-1 bg-green-700 text-white text-xs rounded-full w-5 h-5 inline-flex items-center justify-center">${evidenceCount}</span>
//                     </button>
//                   `;
//                 }).join('')}
//               </div>
//             </div>
//           `;
//         }
        
//         // Add treatment evidence section (initially hidden, will be shown when a treatment is clicked)
//         html += `
//           </div>
          
//           <div id="pubmedTreatmentEvidence" class="mt-6 hidden">
//             <h3 class="text-lg font-medium text-gray-800 mb-2">Evidence for <span id="evidenceTreatmentName"></span></h3>
//             <div id="pubmedTreatmentEvidenceList" class="space-y-3"></div>
//           </div>
//         `;
        
//         elements.pubmedTreatmentsContent.innerHTML = html;
        
//         // Add event listeners for treatment pills
//         document.querySelectorAll('.treatment-pill').forEach(pill => {
//           pill.addEventListener('click', function() {
//             const condition = this.dataset.condition;
//             const treatment = this.dataset.treatment;
//             showTreatmentEvidence(condition, treatment);
//           });
//         });
        
//         // Hide loading, show content
//         showComponent(elements.pubmedTreatmentsLoading, false);
//         showComponent(elements.pubmedTreatmentsContent, true);
        
//       } catch (error) {
//         console.error('Error rendering treatments:', error);
//         showComponent(elements.pubmedTreatments, false);
//         showComponent(elements.pubmedTreatmentsLoading, false);
//       }
//     }, 100);
//   }

//   // Show evidence for a specific treatment
//   function showTreatmentEvidence(condition, treatment) {
//     const evidenceKey = `${condition}|||${treatment}`;
//     const evidence = state.medicalDatabase.articleEvidence[evidenceKey] || [];
    
//     const evidenceDiv = document.getElementById('pubmedTreatmentEvidence');
//     const evidenceName = document.getElementById('evidenceTreatmentName');
//     const evidenceList = document.getElementById('pubmedTreatmentEvidenceList');
    
//     if (!evidenceDiv || !evidenceName || !evidenceList) return;
    
//     evidenceName.textContent = `${treatment} for ${condition}`;
//     evidenceList.innerHTML = '';
    
//     if (evidence.length === 0) {
//       evidenceList.innerHTML = `
//         <p class="text-gray-500">No specific evidence found linking this treatment to the condition.</p>
//       `;
//     } else {
//       evidence.forEach(item => {
//         const evidenceItem = document.createElement('div');
//         evidenceItem.className = 'bg-white rounded-lg p-3 shadow-sm border border-gray-100';
        
//         evidenceItem.innerHTML = `
//           <div class="flex justify-between">
//             <h4 class="font-medium text-gray-800">${item.title}</h4>
//             <span class="text-gray-500 text-sm">${formatDate(item.date)}</span>
//           </div>
//           <p class="text-gray-600 text-sm mt-1">${item.journal || 'Journal not specified'}</p>
//           ${item.excerpt ? `
//             <div class="mt-2 text-sm text-gray-700 bg-gray-50 p-2 rounded">
//               <p>…${item.excerpt}…</p>
//             </div>
//           ` : ''}
//           <div class="mt-2">
//             <a href="https://pubmed.ncbi.nlm.nih.gov/${item.pmid}" target="_blank" 
//                class="text-primary hover:text-primary-dark text-sm flex items-center inline-block">
//               <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
//               </svg>
//               View on PubMed
//             </a>
//           </div>
//         `;
        
//         evidenceList.appendChild(evidenceItem);
//       });
//     }
    
//     // Show evidence section
//     evidenceDiv.classList.remove('hidden');
    
//     // Scroll to evidence
//     evidenceDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
//   }

//   // Render drug information 
//   function renderDrugInformation(drug) {
//     if (!elements.pubmedDrugInfo) return;
    
//     // Only show drug info for drug searches
//     if (state.searchType !== 'drug') {
//       showComponent(elements.pubmedDrugInfo, false);
//       return;
//     }
    
//     showComponent(elements.pubmedDrugInfo, true);
//     showComponent(elements.pubmedDrugInfoLoading, true);
//     showComponent(elements.pubmedDrugInfoContent, false);
    
//     setTimeout(() => {
//       try {
//         // Get conditions treated by this drug
//         const conditions = state.medicalDatabase.drugConditionMap[drug] || [];
        
//         // Don't show drug info if no conditions were found
//         if (conditions.length === 0) {
//           showComponent(elements.pubmedDrugInfo, false);
//           showComponent(elements.pubmedDrugInfoLoading, false);
//           return;
//         }
        
//         // Get drug class information
//         const drugClasses = state.medicalDatabase.drugClasses[drug] || [];
//         const totalArticles = conditions.reduce((count, condition) => {
//           const evidenceKey = `${condition}|||${drug}`;
//           return count + (state.medicalDatabase.articleEvidence[evidenceKey]?.length || 0);
//         }, 0);
        
//         // Create HTML for drug information
//         let html = `
//           <div class="bg-green-50 p-4 rounded-lg border border-green-100 mb-6">
//             <h3 class="text-green-800 font-medium flex items-center">
//               <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
//               </svg>
//               ${drug} Information
//             </h3>
//             <div class="text-green-700 text-sm mt-1">
//               <p>Used to treat ${conditions.length} condition${conditions.length !== 1 ? 's' : ''}.</p>
//               ${drugClasses.length > 0 ? 
//                 `<p class="mt-1">Classification: ${drugClasses.join(', ')}.</p>` : 
//                 ''
//               }
//               <p class="mt-1">Mentioned in ${totalArticles} article${totalArticles !== 1 ? 's' : ''}.</p>
//             </div>
//           </div>
          
//           <h3 class="text-lg font-medium text-gray-800 mb-3">Conditions Treated</h3>
//           <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
//         `;
        
//         // Add conditions
//         conditions.forEach(condition => {
//           const evidenceKey = `${condition}|||${drug}`;
//           const evidenceCount = state.medicalDatabase.articleEvidence[evidenceKey]?.length || 0;
          
//           html += `
//             <div class="bg-white rounded-lg p-4 shadow-sm border border-gray-100">
//               <h4 class="font-medium text-gray-800 mb-2">${condition}</h4>
//               <div class="text-sm text-gray-600 mb-2">
//                 Found in ${evidenceCount} article${evidenceCount !== 1 ? 's' : ''}
//               </div>
//               <button class="condition-pill bg-blue-50 hover:bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-sm transition-colors duration-200"
//                       data-condition="${condition}" 
//                       data-drug="${drug}">
//                 View Evidence
//               </button>
//             </div>
//           `;
//         });
        
//         // Add drug evidence section
//         html += `
//           </div>
          
//           <div id="pubmedDrugEvidence" class="mt-6 hidden">
//             <h3 class="text-lg font-medium text-gray-800 mb-2">Evidence for <span id="evidenceDrugCondition"></span></h3>
//             <div id="pubmedDrugEvidenceList" class="space-y-3"></div>
//           </div>
//         `;
        
//         elements.pubmedDrugInfoContent.innerHTML = html;
        
//         // Add event listeners for condition pills
//         document.querySelectorAll('.condition-pill').forEach(pill => {
//           pill.addEventListener('click', function() {
//             const condition = this.dataset.condition;
//             const drug = this.dataset.drug;
//             showDrugEvidence(condition, drug);
//           });
//         });
        
//         // Hide loading, show content
//         showComponent(elements.pubmedDrugInfoLoading, false);
//         showComponent(elements.pubmedDrugInfoContent, true);
        
//       } catch (error) {
//         console.error('Error rendering drug information:', error);
//         showComponent(elements.pubmedDrugInfo, false);
//         showComponent(elements.pubmedDrugInfoLoading, false);
//       }
//     }, 100);
//   }

//   // Show evidence for a specific drug treating a condition
//   function showDrugEvidence(condition, drug) {
//     const evidenceKey = `${condition}|||${drug}`;
//     const evidence = state.medicalDatabase.articleEvidence[evidenceKey] || [];
    
//     const evidenceDiv = document.getElementById('pubmedDrugEvidence');
//     const evidenceCondition = document.getElementById('evidenceDrugCondition');
//     const evidenceList = document.getElementById('pubmedDrugEvidenceList');
    
//     if (!evidenceDiv || !evidenceCondition || !evidenceList) return;
    
//     evidenceCondition.textContent = `${drug} for ${condition}`;
//     evidenceList.innerHTML = '';
    
//     if (evidence.length === 0) {
//       evidenceList.innerHTML = `
//         <p class="text-gray-500">No specific evidence found linking this drug to the condition.</p>
//       `;
//     } else {
//       evidence.forEach(item => {
//         const evidenceItem = document.createElement('div');
//         evidenceItem.className = 'bg-white rounded-lg p-3 shadow-sm border border-gray-100';
        
//         evidenceItem.innerHTML = `
//           <div class="flex justify-between">
//             <h4 class="font-medium text-gray-800">${item.title}</h4>
//             <span class="text-gray-500 text-sm">${formatDate(item.date)}</span>
//           </div>
//           <p class="text-gray-600 text-sm mt-1">${item.journal || 'Journal not specified'}</p>
//           ${item.excerpt ? `
//             <div class="mt-2 text-sm text-gray-700 bg-gray-50 p-2 rounded">
//               <p>…${item.excerpt}…</p>
//             </div>
//           ` : ''}
//           <div class="mt-2">
//             <a href="https://pubmed.ncbi.nlm.nih.gov/${item.pmid}" target="_blank" 
//                class="text-primary hover:text-primary-dark text-sm flex items-center inline-block">
//               <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
//               </svg>
//               View on PubMed
//             </a>
//           </div>
//         `;
        
//         evidenceList.appendChild(evidenceItem);
//       });
//     }
    
//     // Show evidence section
//     evidenceDiv.classList.remove('hidden');
    
//     // Scroll to evidence
//     evidenceDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
//   }

//   // Load more articles function
//   function loadMoreArticles() {
//     // Add the next batch of articles to display
//     const currentLength = state.displayedArticles.length;
//     const nextBatch = state.articles.slice(currentLength, currentLength + state.pageSize);
    
//     if (nextBatch.length > 0) {
//       state.displayedArticles = [...state.displayedArticles, ...nextBatch];
//       renderArticles();
//     } else if (currentLength < state.totalResults) {
//       // Need to fetch more from the API
//       const options = {
//         page: state.currentPage + 1,
//         sortBy: elements.pubmedSort ? elements.pubmedSort.value : 'relevance',
//         fullTextOnly: elements.pubmedFullTextOnly ? elements.pubmedFullTextOnly.checked : false,
//         yearFilter: elements.pubmedYearFilter ? elements.pubmedYearFilter.value : '',
//         journalFilter: elements.pubmedJournalFilter ? elements.pubmedJournalFilter.value : ''
//       };
      
//       if (state.searchType === 'condition') {
//         searchPubMedByCondition(state.term, options);
//       } else if (state.searchType === 'drug') {
//         searchPubMedByDrug(state.term, options);
//       } else {
//         searchPubMed(state.term, options);
//       }
//     }
//   }

//   // Function to search PubMed by general term (original function)
//   async function searchPubMed(term, options = {}) {
//     state.isLoading = true;
//     state.term = term;
//     state.currentPage = options.page || 1;
//     state.sortBy = options.sortBy || state.sortBy;
//     state.fullTextOnly = options.fullTextOnly !== undefined ? options.fullTextOnly : state.fullTextOnly;
//     state.yearFilter = options.yearFilter || state.yearFilter;
//     state.journalFilter = options.journalFilter || state.journalFilter;
//     state.searchType = 'general';
    
//     // Show the pubmed section and loading state
//     showComponent(elements.pubmedSection, true);
//     showComponent(elements.pubmedLoading, true);
//     showComponent(elements.pubmedError, false);
//     showComponent(elements.pubmedEmpty, false);
//     showComponent(elements.pubmedArticles, false);
//     showComponent(elements.pubmedTreatments, false);
//     showComponent(elements.pubmedDrugInfo, false);
    
//     try {
//       const params = new URLSearchParams({
//         term: term,
//         page: state.currentPage,
//         sortBy: state.sortBy,
//         fullTextOnly: state.fullTextOnly,
//         yearFilter: state.yearFilter,
//         journalFilter: state.journalFilter
//       });
      
//       const response = await fetch(`/api/pubmed?${params}`);
//       console.log(`PubMed API Request: /api/pubmed?${params}`);

//       if (!response.ok) {
//         throw new Error(`Server responded with status ${response.status}`);
//       }
      
//       const data = await response.json();
//       console.log('PubMed API Response:', data);
      
//       // Update state with fetched data
//       if (state.currentPage === 1) {
//         state.articles = data.articles;
//         // Initialize displayed articles with first batch
//         state.displayedArticles = data.articles.slice(0, state.pageSize);
//       } else {
//         state.articles = [...state.articles, ...data.articles];
//         // Add new batch to displayed articles
//         const currentLength = state.displayedArticles.length;
//         const nextBatch = data.articles.slice(0, state.pageSize);
//         state.displayedArticles = [...state.displayedArticles, ...nextBatch];
//       }
      
//       state.totalResults = data.totalResults;
      
//       // Process articles for medical knowledge if this is a new search
//       if (state.currentPage === 1) {
//         // Reset database for a new search
//         state.medicalDatabase = {
//           conditions: [],
//           drugs: [],
//           conditionDrugMap: {},
//           drugConditionMap: {},
//           drugClasses: {},
//           articleEvidence: {},
//           recentUpdated: null
//         };
//       }
      
//       // Process the medical knowledge
//       state.medicalDatabase = processMedicalKnowledge(state.articles);
      
//       // Hide loading state
//       showComponent(elements.pubmedLoading, false);
      
//       if (state.articles.length === 0) {
//         showComponent(elements.pubmedEmpty, true);
//       } else {
//         showComponent(elements.pubmedArticles, true);
//         renderArticles();
//       }
      
//     } catch (error) {
//       console.error('Error fetching PubMed data:', error);
//       showComponent(elements.pubmedLoading, false);
//       showComponent(elements.pubmedError, true);
//       if (elements.pubmedErrorMessage) {
//         elements.pubmedErrorMessage.textContent = error.message || 'Failed to fetch articles. Please try again later.';
//       }
//     }
    
//     state.isLoading = false;
//   }

//   // Function to search PubMed by condition and show treatments
//   async function searchPubMedByCondition(condition, options = {}) {
//     state.isLoading = true;
//     state.term = condition;
//     state.currentPage = options.page || 1;
//     state.sortBy = options.sortBy || state.sortBy;
//     state.fullTextOnly = options.fullTextOnly !== undefined ? options.fullTextOnly : state.fullTextOnly;
//     state.yearFilter = options.yearFilter || state.yearFilter;
//     state.journalFilter = options.journalFilter || state.journalFilter;
//     state.searchType = 'condition';
    
//     // Show the pubmed section and loading state
//     showComponent(elements.pubmedSection, true);
//     showComponent(elements.pubmedLoading, true);
//     showComponent(elements.pubmedError, false);
//     showComponent(elements.pubmedEmpty, false);
//     showComponent(elements.pubmedArticles, false);
//     showComponent(elements.pubmedTreatments, false);
//     showComponent(elements.pubmedDrugInfo, false);
    
//     try {
//       // Construct search term to focus on the condition
//       const searchTerm = `"${condition}"[Title/Abstract] OR "${condition}"[MeSH Terms]`;
      
//       const params = new URLSearchParams({
//         term: searchTerm,
//         page: state.currentPage,
//         sortBy: state.sortBy,
//         fullTextOnly: state.fullTextOnly,
//         yearFilter: state.yearFilter,
//         journalFilter: state.journalFilter
//       });
      
//       const response = await fetch(`/api/pubmed?${params}`);
//       console.log(`PubMed API Request: /api/pubmed?${params}`);
//       if (!response.ok) {
//         throw new Error(`Server responded with status ${response.status}`);
//       }
      
//       const data = await response.json();
//       console.log('PubMed API Response:', data);
      
//       // Update state with fetched data
//       if (state.currentPage === 1) {
//         state.articles = data.articles;
//         // Initialize displayed articles with first batch
//         state.displayedArticles = data.articles.slice(0, state.pageSize);
//       } else {
//         state.articles = [...state.articles, ...data.articles];
//         // Add new batch to displayed articles
//         const currentLength = state.displayedArticles.length;
//         const nextBatch = data.articles.slice(0, state.pageSize);
//         state.displayedArticles = [...state.displayedArticles, ...nextBatch];
//       }
      
//       state.totalResults = data.totalResults;
      
//       // Process articles for medical knowledge if this is a new search
//       if (state.currentPage === 1) {
//         // Reset database for a new search
//         state.medicalDatabase = {
//           conditions: [],
//           drugs: [],
//           conditionDrugMap: {},
//           drugConditionMap: {},
//           drugClasses: {},
//           articleEvidence: {},
//           recentUpdated: null
//         };
//       }
      
//       // Process the medical knowledge
//       state.medicalDatabase = processMedicalKnowledge(state.articles);
      
//       // Hide loading state
//       showComponent(elements.pubmedLoading, false);
      
//       if (state.articles.length === 0) {
//         showComponent(elements.pubmedEmpty, true);
//       } else {
//         // Show articles and treatments
//         showComponent(elements.pubmedArticles, true);
//         renderArticles();
        
//         // Render treatments for this condition
//         renderTreatmentsForCondition(condition);
//       }
      
//     } catch (error) {
//       console.error('Error fetching PubMed data for condition:', error);
//       showComponent(elements.pubmedLoading, false);
//       showComponent(elements.pubmedError, true);
//       if (elements.pubmedErrorMessage) {
//         elements.pubmedErrorMessage.textContent = error.message || 'Failed to fetch articles. Please try again later.';
//       }
//     }
    
//     state.isLoading = false;
//   }

//   // Function to search PubMed by drug and show its uses
//   async function searchPubMedByDrug(drug, options = {}) {
//     state.isLoading = true;
//     state.term = drug;
//     state.currentPage = options.page || 1;
//     state.sortBy = options.sortBy || state.sortBy;
//     state.fullTextOnly = options.fullTextOnly !== undefined ? options.fullTextOnly : state.fullTextOnly;
//     state.yearFilter = options.yearFilter || state.yearFilter;
//     state.journalFilter = options.journalFilter || state.journalFilter;
//     state.searchType = 'drug';
    
//     // Show the pubmed section and loading state
//     showComponent(elements.pubmedSection, true);
//     showComponent(elements.pubmedLoading, true);
//     showComponent(elements.pubmedError, false);
//     showComponent(elements.pubmedEmpty, false);
//     showComponent(elements.pubmedArticles, false);
//     showComponent(elements.pubmedTreatments, false);  // Never show treatments when searching by drug
//     showComponent(elements.pubmedDrugInfo, false);
    
//     try {
//       // Construct search term to focus on the drug
//       const searchTerm = `"${drug}"[Title/Abstract] OR "${drug}"[MeSH Terms] OR "${drug}"[Pharmacological Action]`;
      
//       const params = new URLSearchParams({
//         term: searchTerm,
//         page: state.currentPage,
//         sortBy: state.sortBy,
//         fullTextOnly: state.fullTextOnly,
//         yearFilter: state.yearFilter,
//         journalFilter: state.journalFilter
//       });
      
//       const response = await fetch(`/api/pubmed?${params}`);
//       console.log(`PubMed API Request: /api/pubmed?${params}`);
//       if (!response.ok) {
//         throw new Error(`Server responded with status ${response.status}`);
//       }
      
//       const data = await response.json();
//       console.log('PubMed API Response:', data);

//       // Update state with fetched data
//       if (state.currentPage === 1) {
//         state.articles = data.articles;
//         // Initialize displayed articles with first batch
//         state.displayedArticles = data.articles.slice(0, state.pageSize);
//       } else {
//         state.articles = [...state.articles, ...data.articles];
//         // Add new batch to displayed articles
//         const currentLength = state.displayedArticles.length;
//         const nextBatch = data.articles.slice(0, state.pageSize);
//         state.displayedArticles = [...state.displayedArticles, ...nextBatch];
//       }
      
//       state.totalResults = data.totalResults;
      
//       // Process articles for medical knowledge if this is a new search
//       if (state.currentPage === 1) {
//         // Reset database for a new search
//         state.medicalDatabase = {
//           conditions: [],
//           drugs: [],
//           conditionDrugMap: {},
//           drugConditionMap: {},
//           drugClasses: {},
//           articleEvidence: {},
//           recentUpdated: null
//         };
//       }
      
//       // Process the medical knowledge
//       state.medicalDatabase = processMedicalKnowledge(state.articles);
      
//       // Hide loading state
//       showComponent(elements.pubmedLoading, false);
      
//       if (state.articles.length === 0) {
//         showComponent(elements.pubmedEmpty, true);
//       } else {
//         // Show articles and drug information
//         showComponent(elements.pubmedArticles, true);
//         renderArticles();
        
//         // Render drug information
//         renderDrugInformation(drug);
//       }
      
//     } catch (error) {
//       console.error('Error fetching PubMed data for drug:', error);
//       showComponent(elements.pubmedLoading, false);
//       showComponent(elements.pubmedError, true);
//       if (elements.pubmedErrorMessage) {
//         elements.pubmedErrorMessage.textContent = error.message || 'Failed to fetch articles. Please try again later.';
//       }
//     }
    
//     state.isLoading = false;
//   }

//   // Initialize event listeners
//   function initEventListeners() {
//     // Search by condition button
//     if (elements.pubmedSearchByCondition) {
//       elements.pubmedSearchByCondition.addEventListener('click', () => {
//         const searchTerm = elements.pubmedSearchBox ? elements.pubmedSearchBox.value.trim() : '';
//         if (searchTerm) {
//           searchPubMedByCondition(searchTerm);
//         }
//       });
//     }
    
//     // Search by drug button
//     if (elements.pubmedSearchByDrug) {
//       elements.pubmedSearchByDrug.addEventListener('click', () => {
//         const searchTerm = elements.pubmedSearchBox ? elements.pubmedSearchBox.value.trim() : '';
//         if (searchTerm) {
//           searchPubMedByDrug(searchTerm);
//         }
//       });
//     }
    
//     // General search on enter key
//     if (elements.pubmedSearchBox) {
//       elements.pubmedSearchBox.addEventListener('keypress', (e) => {
//         if (e.key === 'Enter') {
//           const searchTerm = elements.pubmedSearchBox.value.trim();
//           if (searchTerm) {
//             searchPubMed(searchTerm);
//           }
//         }
//       });
//     }
    
//     // Sort dropdown
//     if (elements.pubmedSort) {
//       elements.pubmedSort.addEventListener('change', () => {
//         const options = {
//           page: 1,
//           sortBy: elements.pubmedSort.value,
//           fullTextOnly: elements.pubmedFullTextOnly ? elements.pubmedFullTextOnly.checked : false,
//           yearFilter: elements.pubmedYearFilter ? elements.pubmedYearFilter.value : '',
//           journalFilter: elements.pubmedJournalFilter ? elements.pubmedJournalFilter.value : ''
//         };
        
//         if (state.searchType === 'condition') {
//           searchPubMedByCondition(state.term, options);
//         } else if (state.searchType === 'drug') {
//           searchPubMedByDrug(state.term, options);
//         } else {
//           searchPubMed(state.term, options);
//         }
//       });
//     }
    
//     // Full text only checkbox
//     if (elements.pubmedFullTextOnly) {
//       elements.pubmedFullTextOnly.addEventListener('change', () => {
//         const options = {
//           page: 1,
//           sortBy: elements.pubmedSort ? elements.pubmedSort.value : 'relevance',
//           fullTextOnly: elements.pubmedFullTextOnly.checked,
//           yearFilter: elements.pubmedYearFilter ? elements.pubmedYearFilter.value : '',
//           journalFilter: elements.pubmedJournalFilter ? elements.pubmedJournalFilter.value : ''
//         };
        
//         if (state.searchType === 'condition') {
//           searchPubMedByCondition(state.term, options);
//         } else if (state.searchType === 'drug') {
//           searchPubMedByDrug(state.term, options);
//         } else {
//           searchPubMed(state.term, options);
//         }
//       });
//     }
    
//     // Year filter
//     if (elements.pubmedYearFilter) {
//       elements.pubmedYearFilter.addEventListener('change', () => {
//         const options = {
//           page: 1,
//           sortBy: elements.pubmedSort ? elements.pubmedSort.value : 'relevance',
//           fullTextOnly: elements.pubmedFullTextOnly ? elements.pubmedFullTextOnly.checked : false,
//           yearFilter: elements.pubmedYearFilter.value,
//           journalFilter: elements.pubmedJournalFilter ? elements.pubmedJournalFilter.value : ''
//         };
        
//         if (state.searchType === 'condition') {
//           searchPubMedByCondition(state.term, options);
//         } else if (state.searchType === 'drug') {
//           searchPubMedByDrug(state.term, options);
//         } else {
//           searchPubMed(state.term, options);
//         }
//       });
//     }
    
//     // Journal filter
//     if (elements.pubmedJournalFilter) {
//       elements.pubmedJournalFilter.addEventListener('change', () => {
//         const options = {
//           page: 1,
//           sortBy: elements.pubmedSort ? elements.pubmedSort.value : 'relevance',
//           fullTextOnly: elements.pubmedFullTextOnly ? elements.pubmedFullTextOnly.checked : false,
//           yearFilter: elements.pubmedYearFilter ? elements.pubmedYearFilter.value : '',
//           journalFilter: elements.pubmedJournalFilter.value
//         };
        
//         if (state.searchType === 'condition') {
//           searchPubMedByCondition(state.term, options);
//         } else if (state.searchType === 'drug') {
//           searchPubMedByDrug(state.term, options);
//         } else {
//           searchPubMed(state.term, options);
//         }
//       });
//     }
    
//     // Load more button
//     if (elements.pubmedLoadMore) {
//       elements.pubmedLoadMore.addEventListener('click', () => {
//         if (state.isLoading) return;
//         loadMoreArticles();
//       });
//     }
    
//     // Advanced toggle
//     if (elements.pubmedAdvancedToggle && elements.pubmedAdvancedOptions) {
//       elements.pubmedAdvancedToggle.addEventListener('click', () => {
//         elements.pubmedAdvancedOptions.classList.toggle('hidden');
        
//         // Update text/icon
//         if (elements.pubmedAdvancedOptions.classList.contains('hidden')) {
//           elements.pubmedAdvancedToggle.innerHTML = `
//             <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//               <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
//             </svg>
//             Advanced Options
//           `;
//         } else {
//           elements.pubmedAdvancedToggle.innerHTML = `
//             <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//               <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
//             </svg>
//             Hide Advanced Options
//           `;
//         }
//       });
//     }
    
//     // Rare condition input
//     if (elements.pubmedRareConditionInput && elements.pubmedAddRareCondition) {
//       elements.pubmedAddRareCondition.addEventListener('click', () => {
//         const conditionInput = elements.pubmedRareConditionInput.value.trim();
//         if (conditionInput) {
//           searchPubMedByCondition(conditionInput);
//           elements.pubmedRareConditionInput.value = '';
//         }
//       });
      
//       elements.pubmedRareConditionInput.addEventListener('keypress', (e) => {
//         if (e.key === 'Enter') {
//           const conditionInput = elements.pubmedRareConditionInput.value.trim();
//           if (conditionInput) {
//             searchPubMedByCondition(conditionInput);
//             elements.pubmedRareConditionInput.value = '';
//           }
//         }
//       });
//     }
//   }

//   // Function to populate filter options based on data
//   function populateFilters() {
//     // Populate year filter
//     if (elements.pubmedYearFilter) {
//       const currentYear = new Date().getFullYear();
//       let yearOptions = '<option value="">All Years</option>';
      
//       for (let year = currentYear; year >= currentYear - 20; year--) {
//         yearOptions += `<option value="${year}">${year}</option>`;
//       }
      
//       elements.pubmedYearFilter.innerHTML = yearOptions;
//     }
    
//     // For journal filter, we can only populate once we have data
//     // This is handled in the renderArticles function
//   }

//   // Update journal filter based on fetched articles
//   function updateJournalFilter() {
//     if (!elements.pubmedJournalFilter) return;
    
//     // Extract unique journals from articles
//     const journals = new Set();
//     state.articles.forEach(article => {
//       if (article.journal && article.journal.trim() !== '') {
//         journals.add(article.journal);
//       }
//     });
    
//     // Convert to array and sort alphabetically
//     const sortedJournals = [...journals].sort();
    
//     // Create options HTML
//     let journalOptions = '<option value="">All Journals</option>';
//     sortedJournals.forEach(journal => {
//       journalOptions += `<option value="${journal}">${journal}</option>`;
//     });
    
//     // Set the options
//     elements.pubmedJournalFilter.innerHTML = journalOptions;
    
//     // If there was a previous selection, try to restore it
//     if (state.journalFilter) {
//       elements.pubmedJournalFilter.value = state.journalFilter;
//     }
//   }

//   // Helper function to safely get DOM elements
//   function safeGetElement(id) {
//     const element = document.getElementById(id);
//     if (!element) {
//       console.warn(`PubMed Module: Element with ID "${id}" not found`);
//     }
//     return element;
//   }

//   // Create essential elements if they don't exist
//   function ensureRequiredElements() {
//     // Create main container if needed
//     if (!document.getElementById('pubmedSection')) {
//       console.log("PubMed Module: Creating missing pubmedSection element");
//       const section = document.createElement('div');
//       section.id = 'pubmedSection';
//       section.className = 'hidden';
      
//       // Try to find a suitable parent element
//       const parent = document.querySelector('.main-content') || 
//                     document.querySelector('main') || 
//                     document.querySelector('body');
//       if (parent) {
//         parent.appendChild(section);
//         // Update the elements reference
//         elements.pubmedSection = section;
//       } else {
//         console.error("PubMed Module: Could not find parent element to append pubmedSection");
//       }
//     }
    
//     // Create other essential elements
//     const requiredElements = [
//       { id: 'pubmedLoading', parent: 'pubmedSection', className: 'flex justify-center items-center py-12 hidden' },
//       { id: 'pubmedError', parent: 'pubmedSection', className: 'bg-red-50 p-6 rounded-lg text-center hidden' },
//       { id: 'pubmedEmpty', parent: 'pubmedSection', className: 'bg-gray-50 p-8 rounded-lg text-center hidden' },
//       { id: 'pubmedArticles', parent: 'pubmedSection', className: 'hidden' },
//       { id: 'pubmedArticlesList', parent: 'pubmedArticles', className: 'space-y-4' },
//       { id: 'pubmedTreatments', parent: 'pubmedSection', className: 'mb-8 hidden' },
//       { id: 'pubmedTreatmentsContent', parent: 'pubmedTreatments', className: 'hidden' },
//       { id: 'pubmedDrugInfo', parent: 'pubmedSection', className: 'mb-8 hidden' },
//       { id: 'pubmedDrugInfoContent', parent: 'pubmedDrugInfo', className: 'hidden' }
//     ];
    
//     requiredElements.forEach(elem => {
//       if (!document.getElementById(elem.id) && document.getElementById(elem.parent)) {
//         console.log(`PubMed Module: Creating missing ${elem.id} element`);
//         const newElement = document.createElement('div');
//         newElement.id = elem.id;
//         newElement.className = elem.className;
//         document.getElementById(elem.parent).appendChild(newElement);
        
//         // Update the elements reference
//         elements[elem.id] = newElement;
//       }
//     });
    
//     // Create search interface if needed
//     if (!document.getElementById('pubmedSearchInterface') && elements.pubmedSection) {
//       console.log(`PubMed Module: Creating search interface`);
      
//       const searchInterface = document.createElement('div');
//       searchInterface.id = 'pubmedSearchInterface';
//       searchInterface.className = 'mb-6';
//       searchInterface.innerHTML = `
//         <div class="flex flex-col md:flex-row gap-2 mb-4">
//           <div class="flex-grow">
//             <input type="text" id="pubmedSearchBox" placeholder="Search PubMed..." 
//                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
//           </div>
//           <div class="flex gap-2">
//             <button id="pubmedSearchByCondition" 
//                     class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
//               Search by Condition
//             </button>
//             <button id="pubmedSearchByDrug" 
//                     class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
//               Search by Drug
//             </button>
//           </div>
//         </div>
        
//         <div class="flex items-center">
//           <button id="pubmedAdvancedToggle" class="text-sm text-gray-600 flex items-center">
//             <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//               <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
//             </svg>
//             Advanced Options
//           </button>
//         </div>
        
//         <div id="pubmedAdvancedOptions" class="mt-4 p-4 bg-gray-50 rounded-lg hidden">
//           <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
//             <div>
//               <label for="pubmedSort" class="block text-sm font-medium text-gray-700 mb-1">Sort By</label>
//               <select id="pubmedSort" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-primary">
//                 <option value="relevance">Relevance</option>
//                 <option value="date">Most Recent</option>
//                 <option value="citations">Most Cited</option>
//               </select>
//             </div>
            
//             <div>
//               <label for="pubmedYearFilter" class="block text-sm font-medium text-gray-700 mb-1">Year</label>
//               <select id="pubmedYearFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-primary">
//                 <option value="">All Years</option>
//               </select>
//             </div>
            
//             <div>
//               <label for="pubmedJournalFilter" class="block text-sm font-medium text-gray-700 mb-1">Journal</label>
//               <select id="pubmedJournalFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-primary">
//                 <option value="">All Journals</option>
//               </select>
//             </div>
//           </div>
          
//           <div class="mt-4">
//             <label class="flex items-center">
//               <input type="checkbox" id="pubmedFullTextOnly" class="rounded text-primary focus:ring-primary h-4 w-4">
//               <span class="ml-2 text-sm text-gray-700">Full Text Available Only</span>
//             </label>
//           </div>
          
//           <div class="mt-4">
//             <h4 class="text-sm font-medium text-gray-700 mb-2">Looking for a rare condition?</h4>
//             <div class="flex gap-2">
//               <input type="text" id="pubmedRareConditionInput" placeholder="Enter condition name..." 
//                      class="flex-grow px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-primary">
//               <button id="pubmedAddRareCondition" 
//                       class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
//                 Search
//               </button>
//             </div>
//           </div>
//         </div>
//       `;
      
//       elements.pubmedSection.insertBefore(searchInterface, elements.pubmedSection.firstChild);
      
//       // Update element references
//       elements.pubmedSearchBox = document.getElementById('pubmedSearchBox');
//       elements.pubmedSearchByCondition = document.getElementById('pubmedSearchByCondition');
//       elements.pubmedSearchByDrug = document.getElementById('pubmedSearchByDrug');
//       elements.pubmedAdvancedToggle = document.getElementById('pubmedAdvancedToggle');
//       elements.pubmedAdvancedOptions = document.getElementById('pubmedAdvancedOptions');
//       elements.pubmedSort = document.getElementById('pubmedSort');
//       elements.pubmedFullTextOnly = document.getElementById('pubmedFullTextOnly');
//       elements.pubmedYearFilter = document.getElementById('pubmedYearFilter');
//       elements.pubmedJournalFilter = document.getElementById('pubmedJournalFilter');
//       elements.pubmedRareConditionInput = document.getElementById('pubmedRareConditionInput');
//       elements.pubmedAddRareCondition = document.getElementById('pubmedAddRareCondition');
//     }
    
//     // Create pagination elements if needed
//     if (!document.getElementById('pubmedPagination') && elements.pubmedArticles) {
//       console.log(`PubMed Module: Creating pagination elements`);
      
//       const pagination = document.createElement('div');
//       pagination.id = 'pubmedPagination';
//       pagination.className = 'mt-6 flex justify-center hidden';
//       pagination.innerHTML = `
//         <button id="pubmedLoadMore" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-lg transition-colors">
//           Load More
//         </button>
//       `;
      
//       elements.pubmedArticles.appendChild(pagination);
      
//       // Update element references
//       elements.pubmedPagination = document.getElementById('pubmedPagination');
//       elements.pubmedLoadMore = document.getElementById('pubmedLoadMore');
//     }
    
//     // Create result count element if needed
//     if (!document.getElementById('pubmedResultCount') && elements.pubmedArticles) {
//       console.log(`PubMed Module: Creating result count element`);
      
//       const resultCount = document.createElement('div');
//       resultCount.id = 'pubmedResultCount';
//       resultCount.className = 'text-sm text-gray-600 mb-4';
//       resultCount.textContent = '0 articles found';
      
//       elements.pubmedArticles.insertBefore(resultCount, elements.pubmedArticles.firstChild);
      
//       // Update element references
//       elements.pubmedResultCount = document.getElementById('pubmedResultCount');
//     }
//   }

//   // Initialize the module
//   function init() {
//     console.log("PubMed Module: Initializing...");
    
//     // First ensure all required elements exist
//     ensureRequiredElements();
    
//     // Re-check if we have the main container
//     if (!elements.pubmedSection) {
//       console.error('PubMed Module: Required elements could not be created');
//       return;
//     }
    
//     // Initialize event listeners
//     try {
//       initEventListeners();
//     } catch (error) {
//       console.error('PubMed Module: Error initializing event listeners', error);
//     }
    
//     // Populate filter options
//     try {
//       populateFilters();
//     } catch (error) {
//       console.error('PubMed Module: Error populating filters', error);
//     }
    
//     console.log("PubMed Module: Initialization complete");
//   }
  
//   // Return public methods
//   return {
//     init,
//     searchPubMed,
//     searchPubMedByCondition,
//     searchPubMedByDrug
//   };
// })();



// // Initialize the module when DOM is ready
// document.addEventListener('DOMContentLoaded', function() {
//   PubMedModule.init();
// });

// Add this at the top of your script file to ensure the module is initialized once




document.addEventListener('DOMContentLoaded', () => {
  // Check if module exists first
  if (typeof PubMedModule !== 'undefined' && PubMedModule.init) {
    console.log("Initializing PubMed Module...");
    PubMedModule.init();
  } else {
    console.error("PubMed Module not found or init method not available");
  }
});


// class LoginSystem {
//             constructor() {
//                 this.loginOverlay = document.getElementById('loginOverlay');
//                 this.existingPageContent = document.getElementById('existingPageContent');
//                 this.userInfo = document.getElementById('userInfo');
//                 this.usernameDisplay = document.getElementById('username');
//                 this.notificationUsername = document.getElementById('notificationUsername');
//                 this.notification = document.getElementById('notification');
//                 this.loginForm = document.getElementById('loginForm');
//                 this.loginError = document.getElementById('loginError');
//                 this.logoutBtn = document.getElementById('logoutBtn');
                
//                 this.init();
//                 this.setupEventListeners();
//             }
            
//             init() {
//                 // Check if user is logged in
//                 const storedUser = localStorage.getItem('currentUser');
                
//                 if (storedUser) {
//                     try {
//                         const user = JSON.parse(storedUser);
//                         this.showMainContent(user);
//                         this.showNotification(user.username);
//                     } catch (error) {
//                         console.error('Failed to parse stored user:', error);
//                         this.showLoginOverlay();
//                     }
//                 } else {
//                     this.showLoginOverlay();
//                 }
//             }
            
//             setupEventListeners() {
//                 // Login form submission
//                 this.loginForm.addEventListener('submit', (e) => {
//                     e.preventDefault();
//                     this.handleLogin();
//                 });
                
//                 // Logout button
//                 // this.logoutBtn.addEventListener('click', () => {
//                 //     this.handleLogout();
//                 // });
//             }
            
//             showLoginOverlay() {
//                 this.loginOverlay.classList.remove('hidden');
//                 document.body.style.overflow = 'hidden'; // Prevent scrolling while overlay is open
//             }
            
//             hideLoginOverlay() {
//                 this.loginOverlay.classList.add('hidden');
//                 document.body.style.overflow = ''; // Restore scrolling
//             }
            
//             showMainContent(user) {
//                 this.hideLoginOverlay();
//                 // this.userInfo.classList.remove('hidden');
//                 // this.usernameDisplay.textContent = user.username;
//                 init()
//             }
            
//             showNotification(username) {
//                 this.notificationUsername.textContent = username;
//                 this.notification.classList.add('show');
                
//                 // Hide notification after 5 seconds
//                 setTimeout(() => {
//                     this.notification.classList.remove('show');
//                 }, 5000);
//             }
            
//             async handleLogin() {
//                 const username = document.getElementById('loginUsername').value;
//                 const password = document.getElementById('loginPassword').value;
                
                
//                 try {
//                     // // Call the login API endpoint
//                     // const response = await fetch('/api/login', {
//                     //     method: 'POST',
//                     //     headers: {
//                     //         'Content-Type': 'application/json'
//                     //     },
//                     //     body: JSON.stringify({ username, password })
//                     // });
                    
//                     // const data = await response.json();
                    
//                     // if (response.ok) {
//                         // Save user to localStorage
//                     if(this.testLogin(username,password)){
//                         localStorage.setItem('currentUser', JSON.stringify(data.user));
                        
//                         // Show main content and notification
//                         this.showMainContent(data.user);
//                         this.showNotification(data.user.username);
//                     } else {
//                         // Show error message
//                         this.loginError.textContent = data.message || 'Login failed. Please try again.';
//                         this.loginError.classList.remove('hidden');
//                     }
//                 } catch (error) {
//                     console.error('Login error:', error);
//                     this.loginError.textContent = 'An error occurred. Please try again later.';
//                     this.loginError.classList.remove('hidden');
//                 }
//             }
            
//             handleLogout() {
//                 // Clear localStorage
//                 localStorage.removeItem('currentUser');
                
//                 // Hide user info
//                 // this.userInfo.classList.add('hidden');
                
//                 // Show login overlay
//                 this.showLoginOverlay();
//             }
            
//             // Method for client-side testing without a backend
//             testLogin(username, password) {
//                 // Hardcoded test users
//                 const users = [
//                     { id: 1, username: 'testuser', password: 'password123', role: 'admin' },
//                     { id: 2, username: 'user', password: 'user123', role: 'user' }
//                 ];
                
//                 const user = users.find(u => u.username === username && u.password === password);
                
//                 if (user) {
//                     const safeUser = {
//                         id: user.id,
//                         username: user.username,
//                         role: user.role
//                     };
                    
//                     localStorage.setItem('currentUser', JSON.stringify(safeUser));
//                     this.showMainContent(safeUser);
//                     this.showNotification(safeUser.username);
//                     return true;
//                 } else {
//                     this.loginError.textContent = 'Invalid username or password';
//                     this.loginError.classList.remove('hidden');
//                     return false;
//                 }
//             }
//         }
        
      
        // Login system
        class LoginSystem {
            constructor() {
                this.loginOverlay = document.getElementById('loginOverlay');
                this.signupOverlay = document.getElementById('signupOverlay');
                // this.existingPageContent = document.getElementById('existingPageContent');
                this.userInfo = document.getElementById('userInfo');
                this.usernameDisplay = document.getElementById('username');
                this.notificationUsername = document.getElementById('notificationUsername');
                this.notification = document.getElementById('notification');
                this.loginForm = document.getElementById('loginForm');
                this.signupForm = document.getElementById('signupForm');
                this.loginError = document.getElementById('loginError');
                this.signupError = document.getElementById('signupError');
                this.logoutBtn = document.getElementById('logoutBtn');
                this.userProfileButton = document.getElementById('userProfileButton');
                this.userInitials = document.getElementById('userInitials');
                this.welcomeText = document.getElementById('welcomeText');
                this.profilePopup = document.getElementById('profilePopup');
                this.closePopup = document.getElementById('closePopup');
                this.popupLogoutBtn = document.getElementById('popupLogoutBtn');
                this.popupUsername = document.getElementById('popupUsername');
                this.popupEmail = document.getElementById('popupEmail');
                this.popupUserInitials = document.getElementById('popupUserInitials');
                this.popupRole = document.getElementById('popupRole');
                this.usageBar = document.getElementById('usageBar');
                this.usagePercent = document.getElementById('usagePercent');
                this.billingPeriod = document.getElementById('billingPeriod');
                this.subscriptionStatus = document.getElementById('subscriptionStatus');
                this.darkModeToggle = document.getElementById('darkModeToggle');
                this.switchToSignup = document.getElementById('switchToSignup');
                this.switchToLogin = document.getElementById('switchToLogin');
                this.loginButtonText = document.getElementById('loginButtonText');
                this.loginSpinner = document.getElementById('loginSpinner');
                this.signupButtonText = document.getElementById('signupButtonText');
                this.signupSpinner = document.getElementById('signupSpinner');

                this.init();
                this.setupEventListeners();
            }

            init() {
                const storedUser = localStorage.getItem('currentUser');
                if (storedUser) {
                    try {
                        const user = JSON.parse(storedUser);
                        this.showMainContent(user);
                        this.showNotification(user.username);
                    } catch (error) {
                        console.error('Failed to parse stored user:', error);
                        this.showLoginOverlay();
                    }
                } else {
                    this.showLoginOverlay();
                }
            }

            setupEventListeners() {
                this.loginForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleLogin();
                });

                this.signupForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleSignup();
                });

                this.logoutBtn?.addEventListener('click', () => {
                    this.handleLogout();
                });

                this.popupLogoutBtn.addEventListener('click', () => {
                    this.handleLogout();
                });

                this.userProfileButton.addEventListener('click', () => {
                    this.toggleProfilePopup();
                });

                this.closePopup.addEventListener('click', () => {
                    this.hideProfilePopup();
                });

                this.switchToSignup.addEventListener('click', () => {
                    this.hideLoginOverlay();
                    this.showSignupOverlay();
                });

                this.switchToLogin.addEventListener('click', () => {
                    this.hideSignupOverlay();
                    this.showLoginOverlay();
                });

                document.addEventListener('click', (e) => {
                    if (!this.profilePopup.contains(e.target) && 
                        !this.userProfileButton.contains(e.target) && 
                        this.isProfilePopupVisible()) {
                        this.hideProfilePopup();
                    }
                });

                this.darkModeToggle.addEventListener('change', () => {
                    this.toggleDarkMode();
                });
            }

            isProfilePopupVisible() {
                return !this.profilePopup.classList.contains('scale-0');
            }

            showLoginOverlay() {
                this.loginOverlay.classList.remove('hidden');
                this.signupOverlay.classList.add('hidden');
                // this.existingPageContent.classList.add('hidden');
                document.body.style.overflow = 'hidden';
            }

            hideLoginOverlay() {
                this.loginOverlay.classList.add('hidden');
                document.body.style.overflow = '';
            }

            showSignupOverlay() {
                this.signupOverlay.classList.remove('hidden');
                this.loginOverlay.classList.add('hidden');
                // this.existingPageContent.classList.add('hidden');
                document.body.style.overflow = 'hidden';
            }

            hideSignupOverlay() {
                this.signupOverlay.classList.add('hidden');
                document.body.style.overflow = '';
            }

            showMainContent(user) {
                this.hideLoginOverlay();
                this.hideSignupOverlay();
                // this.existingPageContent.classList.remove('hidden');
                this.userInfo?.classList.remove('hidden');
                this.usernameDisplay.textContent = user.username;
                this.userProfileButton.classList.remove('hidden');
                const initials = user.username.charAt(0).toUpperCase();
                this.userInitials.textContent = initials;
                this.popupUserInitials.textContent = initials;
                this.welcomeText.textContent = `Welcome, ${user.username}`;
                this.updateProfilePopup(user);
            }

            updateProfilePopup(user) {
                this.popupUsername.textContent = user.username;
                this.popupEmail.textContent = user.email || 'No email provided';
                this.popupRole.textContent = this.capitalizeFirstLetter(user.role);
                this.usageBar.style.width = `${user.usage}%`;
                this.usagePercent.textContent = user.usage;
                this.billingPeriod.textContent = user.billingPeriod || 'No active billing period';
                this.updateSubscriptionStatus(user.subscriptionStatus);
                this.darkModeToggle.checked = user.darkModeEnabled || false;
                if (user.darkModeEnabled) {
                    this.applyDarkMode();
                }
            }

            updateSubscriptionStatus(status) {
                let text, bgColor;
                switch (status) {
                    case 'free-trial':
                        text = 'Free Trial';
                        bgColor = 'bg-green-100 text-green-800';
                        break;
                    case 'active':
                        text = 'Active';
                        bgColor = 'bg-blue-100 text-blue-800';
                        break;
                    case 'expired':
                        text = 'Expired';
                        bgColor = 'bg-red-100 text-red-800';
                        break;
                    default:
                        text = 'Unknown';
                        bgColor = 'bg-gray-100 text-gray-800';
                }
                this.subscriptionStatus.textContent = text;
                this.subscriptionStatus.className = `inline-block px-2 py-0.5 rounded text-xs font-medium ${bgColor}`;
            }

            capitalizeFirstLetter(string) {
                return string.charAt(0).toUpperCase() + string.slice(1);
            }

            showNotification(username) {
                this.notificationUsername.textContent = username;
                this.notification.classList.add('show');
                setTimeout(() => {
                    this.notification.classList.remove('show');
                }, 5000);
            }

            async handleLogin() {
                this.loginButtonText.textContent = 'Signing In...';
                this.loginSpinner.style.display = 'block';
                this.loginError.classList.add('hidden');

                const username = document.getElementById('loginUsername').value;
                const password = document.getElementById('loginPassword').value;
console.log(username, password)
                try {
                    const response = await fetch(`${API_BASE_URL}/login`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ username, password })
                    });
                    const data = await response.json();
                    if (response.ok) {
                        localStorage.setItem('currentUser', JSON.stringify(data.user));
                        this.showMainContent(data.user);
                        this.showNotification(data.user.username);
                    } else {
                        this.loginError.textContent = data.message || 'Login failed. Please try again.';
                        this.loginError.classList.remove('hidden');
                    }
                } catch (error) {
                    console.error('Login error:', error);
                    this.loginError.textContent = 'An error occurred. Please try again later.';
                    this.loginError.classList.remove('hidden');
                } finally {
                    this.loginButtonText.textContent = 'Sign In';
                    this.loginSpinner.style.display = 'none';
                }
            }

            async handleSignup() {
                this.signupButtonText.textContent = 'Creating Account...';
                this.signupSpinner.style.display = 'block';
                this.signupError.classList.add('hidden');

                const username = document.getElementById('signupUsername').value;
                const email = document.getElementById('signupEmail').value;
                const password = document.getElementById('signupPassword').value;
                console.log(username, password, email)
                try {
                    const response = await fetch(`${API_BASE_URL}/signup`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ username, email, password })
                    });
                    const data = await response.json();
                    if (response.ok) {
                        localStorage.setItem('currentUser', JSON.stringify(data.user));
                        this.showMainContent(data.user);
                        this.showNotification(data.user.username);
                    } else {
                        this.signupError.textContent = data.message || 'Signup failed. Please try again.';
                        this.signupError.classList.remove('hidden');
                    }
                } catch (error) {
                    console.error('Signup error:', error);
                    this.signupError.textContent = 'An error occurred. Please try again later.';
                    this.signupError.classList.remove('hidden');
                } finally {
                    this.signupButtonText.textContent = 'Start 30-Day Trial';
                    this.signupSpinner.style.display = 'none';
                }
            }

            handleLogout() {
                localStorage.removeItem('currentUser');
                this.userInfo?.classList.add('hidden');
                this.userProfileButton.classList.add('hidden');
                this.hideProfilePopup();
                this.showLoginOverlay();
            }

            toggleProfilePopup() {
                if (this.isProfilePopupVisible()) {
                    this.hideProfilePopup();
                } else {
                    this.showProfilePopup();
                }
            }

            showProfilePopup() {
                this.profilePopup.classList.remove('hidden', 'scale-0');
                setTimeout(() => {
                    this.profilePopup.classList.add('scale-100');
                }, 10);
            }

            hideProfilePopup() {
                this.profilePopup.classList.remove('scale-100');
                this.profilePopup.classList.add('scale-0');
                setTimeout(() => {
                    this.profilePopup.classList.add('hidden');
                }, 300);
            }

            toggleDarkMode() {
                const isDarkMode = this.darkModeToggle.checked;
                const storedUser = JSON.parse(localStorage.getItem('currentUser'));
                if (storedUser) {
                    storedUser.darkModeEnabled = isDarkMode;
                    localStorage.setItem('currentUser', JSON.stringify(storedUser));
                }
                if (isDarkMode) {
                    this.applyDarkMode();
                } else {
                    this.removeDarkMode();
                }
            }

            applyDarkMode() {
                document.body.classList.add('dark-theme');
                document.querySelectorAll('.bg-white').forEach(el => el.classList.add('dark-theme'));
                document.querySelectorAll('.text-gray-800').forEach(el => el.classList.add('text-gray-100'));
                document.querySelectorAll('.text-gray-600').forEach(el => el.classList.add('text-gray-300'));
            }

            removeDarkMode() {
                document.body.classList.remove('dark-theme');
                document.querySelectorAll('.bg-white').forEach(el => el.classList.remove('dark-theme'));
                document.querySelectorAll('.text-gray-800').forEach(el => el.classList.remove('text-gray-100'));
                document.querySelectorAll('.text-gray-600').forEach(el => el.classList.remove('text-gray-300'));
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            window.loginSystem = new LoginSystem();
            init()
        });

        
// Don't call init again inside handleSearch
// Initialize the module when DOM is ready
// document.addEventListener('DOMContentLoaded', function() {
//   
// });

// Complete NLPProcessor implementation for handling any drug or condition


// Add the EMA data module to window for debugging
window.EmaDataModule = EmaDataModule;



    </script>
</body>
</html>